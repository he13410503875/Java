define("app/window/frame",["../main","jquery/jquery","jquery-localize-master/dist/jquery.localize","bootstrape/js/bootstrap","../document/File","exoskeleton-master/exoskeleton","../document/StringUtils","../editor/UndoManager","../document/Node","../editor/polyfill","./FileHelper","../editor/EditHelper","../editor/KeyMaster","./MenuHelper","./FileInfoPanel","./steno2","../editor/Editor","../document/MarkParser","../editor/Inline","../editor/Emoji","../document/Node2Mark","../document/Node2HTML","../editor/Diagram","codemirror/lib/codemirror","../document/NodeOperation","rangy/rangy-core","../editor/Fences","autoComplete","codemirror/addon/selection/mark-selection","codemirror/addon/edit/closebrackets","codemirror/addon/edit/closetag","codemirror/addon/mode/overlay","codemirror/addon/lint/lint","../editor/MathBlock","codemirror/addon/display/placeholder","codemirror/mode/stex/stex","../editor/MathInline","rangy/rangy-classapplier","../editor/Brush","../editor/Stylize","../editor/Selection","../editor/TableEdit","../editor/ImageEdit","../editor/UserOp","../editor/ConvertUtils","../editor/DeleteOp","../editor/PairOp","../editor/IndentOp","../editor/ClipboardOp","../editor/DocMenu","../editor/SearchPanel","../editor/Word","../document/Export","../document/Node2Native","../editor/SourceView","codemirror/addon/selection/active-line","codemirror/addon/edit/visiblespace","../editor/QuickOpenPanel","./ContextMenu","./Library","../editor/FileTree","../editor/FileList","../window/FileInfoPanel","../window/FileHelper","../window/ClientCommand","./PDFBridge","./PandocBridge","../window/ContextMenu","../window/PandocBridge","../window/MegaMenu","list.js-master/dist/list","list.js-master/dist/list.fuzzysearch.min","./ClientCommand"],function(e,t,n){"use strict";var i=e("../main"),s=(e("../editor/KeyMaster"),e("../document/File")),l=(e("../document/Node"),e("../window/FileInfoPanel")),c=(e("../editor/EditHelper"),e("../window/FileHelper")),d=e("../window/ClientCommand"),u=(e("../window/ContextMenu"),e("../window/PandocBridge")),r=e("../window/MegaMenu"),p=window.reqnode?reqnode("electron").remote:null;function o(){var n=p.getCurrentWindow(),e=p.app;document.querySelector("#w-traffic-lights");$("#w-min").on("click",function(){n.minimize()}),$("#w-close").on("click",function(){n.close()}),$("#w-restore").on("click",function(){n.unmaximize(),n.setFullScreen(!1)});var t,i=null;function r(){var e=n.getBounds();p.app.setting.put("lastWidth",e.width,!0),p.app.setting.put("lastHeight",e.height,!0),p.app.setting.put("lastX",1e3<e.x+24?200:e.x+10,!0),p.app.setting.put("lastY",800<e.y+24?200:e.y+10,!0),p.app.setting.save()}function o(){t&&(clearTimeout(t),t=null),t=setTimeout(r,500)}$("#w-max-group").on("mouseenter",".btn",function(){this.classList.add("hover")}).on("mouseleave",".btn",function(){this.classList.remove("hover")}),$("#w-max").on("mouseup",function(e){1===e.which&&($("#w-traffic-lights").addClass("on-win-fullsize"),i&&clearTimeout(i),$("#w-max-group").removeClass("w-show-more"),n.maximize())}).on("mousedown",function(){i=setTimeout(function(){$("#w-max-group").addClass("w-show-more")},300)}),$("#w-full").on("mouseup",function(e){1===e.which&&($("#w-traffic-lights").addClass("on-win-fullsize"),i&&clearTimeout(i),$("#w-max-group").removeClass("w-show-more"),n.setFullScreen(!0))}),$("#w-pin").on("mouseup",function(e){1===e.which&&d.pinWindow()}),$("#w-unpin").on("click",function(){d.unpinWindow()}),$("#top-titlebar").on("mouseleave",function(){i&&clearTimeout(i),$("#w-max-group").removeClass("w-show-more")}),n.on("maximize",function(){$("#w-traffic-lights").addClass("on-win-fullsize")}),n.on("enter-full-screen",function(){n.setMenuBarVisibility(!1),n.setMenuBarVisibility(!0),$("#w-traffic-lights").addClass("on-win-fullsize"),document.body.classList.add("typora-fullscreen")}),n.on("unmaximize",function(){$("#w-traffic-lights").removeClass("on-win-fullsize"),o()}),n.on("leave-full-screen",function(){n.setMenuBarVisibility(!e.setting.config.autoHideMenuBar),n.setAutoHideMenuBar(e.setting.config.autoHideMenuBar),$("#w-traffic-lights").removeClass("on-win-fullsize"),document.body.classList.remove("typora-fullscreen"),o()}),r(),n.on("resize",function(){s.suppressResize||r()}),n.on("move",function(){r()}),window.onbeforeunload=function(e){return s.backupVersionWorker(),s.backupWindow(),n.focus(),c.tryLeaveDocument(function(e){var t;e||(t=s.mountFolder_,s.backupDocumentSnap(),s.editor.library.end(),l.watchFileChange(null),u.slientQuit(),p.app.onCloseWin(n.id,t),releasePrintWin_(),releaseCaptureWin_(),s.fileHasModified=!1,s.updateChangeCount(s.ChangeType.NSChangeAutosaved),n.destroy())}),!1};var a=reqnode("electron").ipcRenderer;window.onerror=function(e,t,n,i,r){a.send("errorInWindow",r?r.stack:t+":"+n+"\n"+e)}}function a(){var e=p.app;!0===e.setting.get("framelessWindow")?(document.body.classList.remove("native-window"),document.body.classList.add("unibody-window")):(document.body.classList.add("native-window"),document.body.classList.remove("unibody-window")),!1!==e.setting.get("showStatusBar")&&document.body.classList.add("show-footer"),-1!=window.navigator.userAgent.indexOf("Windows NT")?(document.body.classList.add("os-windows"),-1!=window.navigator.userAgent.indexOf("Windows NT 6.1")?document.body.classList.add("os-windows-7"):-1!=window.navigator.userAgent.indexOf("Windows NT 6.2")?document.body.classList.add("os-windows-8"):-1!=window.navigator.userAgent.indexOf("Windows NT 6.3")?(document.body.classList.add("os-windows-8"),document.body.classList.add("os-windows-8.1")):-1!=window.navigator.userAgent.indexOf("Windows NT 10")&&document.body.classList.add("os-windows-10")):process&&"linux"==process.platform?document.body.classList.add("os-linux"):process&&"darwin"==process.platform&&document.body.classList.add("os-mac"),-1==window.navigator.userAgent.indexOf("Windows NT 6.2")&&-1==window.navigator.userAgent.indexOf("Windows NT 6.3")||document.body.classList.add("paint-border")}function h(){$("#outline-btn").click(function(){s.editor.library.toggleSidebar(),s.isNode&&d.refreshViewMenu()}),$("#toggle-sourceview-btn").click(function(){s.toggleSourceMode()}),$("#toggle-focus-mode-btn").click(function(){s.editor.toggleFocusMode()}),$("#toggle-typewriter-mode-btn").click(function(){s.editor.toggleTypeWriterMode()}),$("#footer-word-count").on("click",function(){if(document.body.classList.contains("show-word-count"))document.body.classList.remove("show-word-count"),document.body.classList.remove("show-word-count-in-selection");else{document.body.classList.add("show-word-count"),s.sync(),s.editor.brush.updateWordCount();var e=s.editor.getMarkdown(),t=Math.round(($("#footer-word-count-td").text()-0)/270);$("#footer-read-time-count-td").text(t||"≤ 1"),$("#footer-line-count-td").text((e.match(/\n/g)||[]).length+1),$("#footer-char-count-td").text(e.length);var n=s.editor.selection.getTextInSelection();n.length?($("#footer-char-count-td-sel").text(n.length),$("#footer-word-count-td-sel").text(s.editor.selection.getWordCountInSelection(n)),document.body.classList.add("show-word-count-in-selection")):document.body.classList.remove("show-word-count-in-selection")}}),$("#footer-word-count-info-close").on("click",function(){$("#footer-word-count").trigger("click")}),$("#footer-word-count").on("before-show-ty-hint",function(e){document.body.classList.contains("show-word-count")&&(e.cancel=!0)})}s.resetZoom=function(){reqnode("electron").webFrame.setZoomFactor(1),p.app.setting.put("zoomFactor",1),p.app.setting.put("zoomLevel",1)},$(document).ready(function(){reqnode?a():(document.body.classList.remove("native-window"),document.body.classList.add("show-footer")),i.init(),s.isNodeHtml&&(s.contextMenu=s.editor.contextMenu,s.megaMenu=new r(s.editor.sessionStr)),reqnode&&(o(),function(){if(s.isWin){var e=p.app,t=[{type:"recent"},{type:"tasks",items:[{type:"task",program:process.execPath,arguments:"",iconPath:process.execPath,iconIndex:0,title:"New Document",description:"Create a new window"}]}];e.setAppUserModelId("abnerworks.Typora"),e.setJumpList(t)}}(),function(){var e=reqnode("electron").ipcRenderer;function n(e){var t=p.getCurrentWindow(),n=p.app;e=reqnode("path").normalize(e),n.getDocumentController().getDocumentFromWindowId(t.id).rename(e),e?l.setFileTitle(e):(s.filePath=void 0,s.updateChangeCount(s.ChangeType.NSChangeReadOtherContents),l.watchFileChange(null)),s.editor.library.markCurrentFile()}window.doApplyRename=n;var t=s.isWin?"\\":"/";function i(e){return s.filePath&&(s.filePath==e||0==s.filePath.indexOf(e+t))}e.on("willRename",function(e,t){i(t.oldPath)&&l.watchFileChange(null)}),e.on("didRename",function(e,t){i(t.oldPath)&&(n(t.newPath+s.filePath.substr(t.oldPath.length)),t.oldPath==s.getMountFolder()&&s.editor.library.onRootChanged(t.newPath))}),e.on("willSave",function(e,t){try{s.editor.library.pauseOnChange()}catch(e){}}),e.on("didSave",function(e,t){try{var n=t.path,i=s.editor.library.fileList.findElemFromPath(n);n==s.filePath&&(s.lastModifiedDate=t.lastModifiedDate),i.length&&s.editor.library.fileList.appendItemToView({path:n,folderPath:i.attr("data-parent-path"),folderName:i.children(".file-list-item-parent-loc").text(),lastModified:new Date,name:i.find(".file-list-item-file-name").text(),summary:t.summary,oldPath:n},!0)}catch(e){console.warn(e)}try{s.editor.library.pauseOnChange(!0)}catch(e){}}),e.on("saveFromUntitled",function(e,t){s.filePath!=t&&n()})}()),$("html, body, #top-titlebar").click(function(){$("#main-menu").removeClass("open")}),l.prepareInfoPanel(),h()})}),define("app/main",["jquery/jquery","jquery-localize-master/dist/jquery.localize","bootstrape/js/bootstrap","app/document/File","exoskeleton-master/exoskeleton","app/document/StringUtils","app/editor/UndoManager","app/document/Node","app/editor/polyfill","app/window/FileHelper","app/editor/EditHelper","app/editor/KeyMaster","app/window/MenuHelper","app/window/FileInfoPanel","app/window/steno2","app/editor/Editor","app/document/MarkParser","app/editor/Inline","app/editor/Emoji","app/document/Node2Mark","app/document/Node2HTML","app/editor/Diagram","codemirror/lib/codemirror","app/document/NodeOperation","rangy/rangy-core","app/editor/Fences","autoComplete","codemirror/addon/selection/mark-selection","codemirror/addon/edit/closebrackets","codemirror/addon/edit/closetag","codemirror/addon/mode/overlay","codemirror/addon/lint/lint","app/editor/MathBlock","codemirror/addon/display/placeholder","codemirror/mode/stex/stex","app/editor/MathInline","rangy/rangy-classapplier","app/editor/Brush","app/editor/Stylize","app/editor/Selection","app/editor/TableEdit","app/editor/ImageEdit","app/editor/UserOp","app/editor/ConvertUtils","app/editor/DeleteOp","app/editor/PairOp","app/editor/IndentOp","app/editor/ClipboardOp","app/editor/DocMenu","app/editor/SearchPanel","app/editor/Word","app/document/Export","app/document/Node2Native","app/editor/SourceView","codemirror/addon/selection/active-line","codemirror/addon/edit/visiblespace","app/editor/QuickOpenPanel","app/window/ContextMenu","app/window/Library","app/editor/FileTree","app/editor/FileList"],function(e,t,n){if(!window.jQuery){window.$=e("jquery/jquery"),window.jQuery=window.$,e("jquery-localize-master/dist/jquery.localize.js");var i="Base";window.require?i=reqnode("electron").remote.app.setting.getUserLocale():window.app&&(i=app.app.getLocale());var r={language:i,pathPrefix:"locales"};if($("[data-lg='Front'], [data-after-content], [ty-hint]").localize("Front",r),window.require&&reqnode("electron").remote.app.setting.get("sidebar_tab")&&540<window.innerWidth){var o=document.querySelector("#typora-sidebar");o.classList.add("open"),o.style.transition="0s",document.body.classList.add("pin-outline")}$.fn.textExcludeSVG=function(e){var t=this.clone().find("svg, .MathJax_Preview").remove().end().find(".md-pants").text(function(){return this.innerText.replace(this.dataset.content,this.dataset.text)}).end();return e&&t.find(".md-inline-math script").html(function(){return this.innerHTML.replace(/\u200b/g,"")}).end().find(".md-emoji").html(function(){return(this.querySelector(".md-meta")||{}).textContent||""}),t.text()},$.fn.textWithoutNbps=function(){return this.text().replace(/\u00A0/g," ").replace()}}e("bootstrape/js/bootstrap.js");var a=e("app/document/File"),s=e("app/editor/Editor");(window.File=a).language=i,t.init=function(){var e,t=new s("#write",a);e=t,window.getMarkdown=function(){return e.getMarkdown()},window.editor=t,setTimeout(function(){document.querySelector("#typora-sidebar").style.transition="",$("[data-lg='Panel']").localize("Panel",r),a.isNode&&$("[data-lg='Menu']").localize("Menu",r)},20)}}),define("jquery/jquery",[],function(e,t,n){var i,r;i="undefined"!=typeof window?window:this,r=function(f,e){var t=[],d=t.slice,g=t.concat,s=t.push,r=t.indexOf,n={},i=n.toString,m=n.hasOwnProperty,v={},y=f.document,k=function(e,t){return new k.fn.init(e,t)},o=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,a=/^-ms-/,l=/-([\da-z])/gi,c=function(e,t){return t.toUpperCase()};function u(e){var t=e.length,n=k.type(e);return"function"!==n&&!k.isWindow(e)&&(!(1!==e.nodeType||!t)||("array"===n||0===t||"number"==typeof t&&0<t&&t-1 in e))}k.fn=k.prototype={jquery:"2.1.1",constructor:k,selector:"",length:0,toArray:function(){return d.call(this)},get:function(e){return null!=e?e<0?this[e+this.length]:this[e]:d.call(this)},pushStack:function(e){var t=k.merge(this.constructor(),e);return t.prevObject=this,t.context=this.context,t},each:function(e,t){return k.each(this,e,t)},map:function(n){return this.pushStack(k.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(d.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(0<=n&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:s,sort:t.sort,splice:t.splice},k.extend=k.fn.extend=function(){var e,t,n,i,r,o,a=arguments[0]||{},s=1,l=arguments.length,c=!1;for("boolean"==typeof a&&(c=a,a=arguments[s]||{},s++),"object"==typeof a||k.isFunction(a)||(a={}),s===l&&(a=this,s--);s<l;s++)if(null!=(e=arguments[s]))for(t in e)n=a[t],a!==(i=e[t])&&(c&&i&&(k.isPlainObject(i)||(r=k.isArray(i)))?(r?(r=!1,o=n&&k.isArray(n)?n:[]):o=n&&k.isPlainObject(n)?n:{},a[t]=k.extend(c,o,i)):void 0!==i&&(a[t]=i));return a},k.extend({expando:"jQuery"+("2.1.1"+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isFunction:function(e){return"function"===k.type(e)},isArray:Array.isArray,isWindow:function(e){return null!=e&&e===e.window},isNumeric:function(e){return!k.isArray(e)&&0<=e-parseFloat(e)},isPlainObject:function(e){return"object"===k.type(e)&&!e.nodeType&&!k.isWindow(e)&&!(e.constructor&&!m.call(e.constructor.prototype,"isPrototypeOf"))},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?n[i.call(e)]||"object":typeof e},globalEval:function(e){var t,n=eval;(e=k.trim(e))&&(1===e.indexOf("use strict")?((t=y.createElement("script")).text=e,y.head.appendChild(t).parentNode.removeChild(t)):n(e))},camelCase:function(e){return e.replace(a,"ms-").replace(l,c)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t,n){var i=0,r=e.length,o=u(e);if(n){if(o)for(;i<r&&!1!==t.apply(e[i],n);i++);else for(i in e)if(!1===t.apply(e[i],n))break}else if(o)for(;i<r&&!1!==t.call(e[i],i,e[i]);i++);else for(i in e)if(!1===t.call(e[i],i,e[i]))break;return e},trim:function(e){return null==e?"":(e+"").replace(o,"")},makeArray:function(e,t){var n=t||[];return null!=e&&(u(Object(e))?k.merge(n,"string"==typeof e?[e]:e):s.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:r.call(t,e,n)},merge:function(e,t){for(var n=+t.length,i=0,r=e.length;i<n;i++)e[r++]=t[i];return e.length=r,e},grep:function(e,t,n){for(var i=[],r=0,o=e.length,a=!n;r<o;r++)!t(e[r],r)!==a&&i.push(e[r]);return i},map:function(e,t,n){var i,r=0,o=e.length,a=[];if(u(e))for(;r<o;r++)null!=(i=t(e[r],r,n))&&a.push(i);else for(r in e)null!=(i=t(e[r],r,n))&&a.push(i);return g.apply([],a)},guid:1,proxy:function(e,t){var n,i,r;return"string"==typeof t&&(n=e[t],t=e,e=n),k.isFunction(e)?(i=d.call(arguments,2),(r=function(){return e.apply(t||this,i.concat(d.call(arguments)))}).guid=e.guid=e.guid||k.guid++,r):void 0},now:Date.now,support:v}),k.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){n["[object "+t+"]"]=t.toLowerCase()});var p=function(n){var e,f,w,o,i,g,u,m,x,c,d,v,C,r,y,b,a,s,k,S="sizzle"+-new Date,T=n.document,F=0,p=0,l=oe(),h=oe(),E=oe(),_=function(e,t){return e===t&&(d=!0),0},M="undefined",N=1<<31,A={}.hasOwnProperty,t=[],L=t.pop,I=t.push,R=t.push,P=t.slice,D=t.indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(this[t]===e)return t;return-1},O="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",B="[\\x20\\t\\r\\n\\f]",j="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",$=j.replace("w","w#"),H="\\["+B+"*("+j+")(?:"+B+"*([*^$|!~]?=)"+B+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+$+"))|)"+B+"*\\]",U=":("+j+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+H+")*)|.*)\\)|)",W=new RegExp("^"+B+"+|((?:^|[^\\\\])(?:\\\\.)*)"+B+"+$","g"),q=new RegExp("^"+B+"*,"+B+"*"),z=new RegExp("^"+B+"*([>+~]|"+B+")"+B+"*"),V=new RegExp("="+B+"*([^\\]'\"]*?)"+B+"*\\]","g"),K=new RegExp(U),Y=new RegExp("^"+$+"$"),J={ID:new RegExp("^#("+j+")"),CLASS:new RegExp("^\\.("+j+")"),TAG:new RegExp("^("+j.replace("w","w*")+")"),ATTR:new RegExp("^"+H),PSEUDO:new RegExp("^"+U),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+B+"*(even|odd|(([+-]|)(\\d*)n|)"+B+"*(?:([+-]|)"+B+"*(\\d+)|))"+B+"*\\)|)","i"),bool:new RegExp("^(?:"+O+")$","i"),needsContext:new RegExp("^"+B+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+B+"*((?:-\\d)?\\d*)"+B+"*\\)|)(?=[^-]|$)","i")},Q=/^(?:input|select|textarea|button)$/i,G=/^h\d$/i,X=/^[^{]+\{\s*\[native \w/,Z=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ee=/[+~]/,te=/'|\\/g,ne=new RegExp("\\\\([\\da-f]{1,6}"+B+"?|("+B+")|.)","ig"),ie=function(e,t,n){var i="0x"+t-65536;return i!=i||n?t:i<0?String.fromCharCode(i+65536):String.fromCharCode(i>>10|55296,1023&i|56320)};try{R.apply(t=P.call(T.childNodes),T.childNodes),t[T.childNodes.length].nodeType}catch(e){R={apply:t.length?function(e,t){I.apply(e,P.call(t))}:function(e,t){for(var n=e.length,i=0;e[n++]=t[i++];);e.length=n-1}}}function re(e,t,n,i){var r,o,a,s,l,c,d,u,p,h;if((t?t.ownerDocument||t:T)!==C&&v(t),n=n||[],!e||"string"!=typeof e)return n;if(1!==(s=(t=t||C).nodeType)&&9!==s)return[];if(y&&!i){if(r=Z.exec(e))if(a=r[1]){if(9===s){if(!(o=t.getElementById(a))||!o.parentNode)return n;if(o.id===a)return n.push(o),n}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(a))&&k(t,o)&&o.id===a)return n.push(o),n}else{if(r[2])return R.apply(n,t.getElementsByTagName(e)),n;if((a=r[3])&&f.getElementsByClassName&&t.getElementsByClassName)return R.apply(n,t.getElementsByClassName(a)),n}if(f.qsa&&(!b||!b.test(e))){if(u=d=S,p=t,h=9===s&&e,1===s&&"object"!==t.nodeName.toLowerCase()){for(c=g(e),(d=t.getAttribute("id"))?u=d.replace(te,"\\$&"):t.setAttribute("id",u),u="[id='"+u+"'] ",l=c.length;l--;)c[l]=u+ge(c[l]);p=ee.test(e)&&he(t.parentNode)||t,h=c.join(",")}if(h)try{return R.apply(n,p.querySelectorAll(h)),n}catch(e){}finally{d||t.removeAttribute("id")}}}return m(e.replace(W,"$1"),t,n,i)}function oe(){var i=[];return function e(t,n){return i.push(t+" ")>w.cacheLength&&delete e[i.shift()],e[t+" "]=n}}function ae(e){return e[S]=!0,e}function se(e){var t=C.createElement("div");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function le(e,t){for(var n=e.split("|"),i=e.length;i--;)w.attrHandle[n[i]]=t}function ce(e,t){var n=t&&e,i=n&&1===e.nodeType&&1===t.nodeType&&(~t.sourceIndex||N)-(~e.sourceIndex||N);if(i)return i;if(n)for(;n=n.nextSibling;)if(n===t)return-1;return e?1:-1}function de(t){return function(e){return"input"===e.nodeName.toLowerCase()&&e.type===t}}function ue(n){return function(e){var t=e.nodeName.toLowerCase();return("input"===t||"button"===t)&&e.type===n}}function pe(a){return ae(function(o){return o=+o,ae(function(e,t){for(var n,i=a([],e.length,o),r=i.length;r--;)e[n=i[r]]&&(e[n]=!(t[n]=e[n]))})})}function he(e){return e&&typeof e.getElementsByTagName!==M&&e}for(e in f=re.support={},i=re.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return!!t&&"HTML"!==t.nodeName},v=re.setDocument=function(e){var t,l=e?e.ownerDocument||e:T,n=l.defaultView;return l!==C&&9===l.nodeType&&l.documentElement?(r=(C=l).documentElement,y=!i(l),n&&n!==n.top&&(n.addEventListener?n.addEventListener("unload",function(){v()},!1):n.attachEvent&&n.attachEvent("onunload",function(){v()})),f.attributes=se(function(e){return e.className="i",!e.getAttribute("className")}),f.getElementsByTagName=se(function(e){return e.appendChild(l.createComment("")),!e.getElementsByTagName("*").length}),f.getElementsByClassName=X.test(l.getElementsByClassName)&&se(function(e){return e.innerHTML="<div class='a'></div><div class='a i'></div>",e.firstChild.className="i",2===e.getElementsByClassName("i").length}),f.getById=se(function(e){return r.appendChild(e).id=S,!l.getElementsByName||!l.getElementsByName(S).length}),f.getById?(w.find.ID=function(e,t){if(typeof t.getElementById!==M&&y){var n=t.getElementById(e);return n&&n.parentNode?[n]:[]}},w.filter.ID=function(e){var t=e.replace(ne,ie);return function(e){return e.getAttribute("id")===t}}):(delete w.find.ID,w.filter.ID=function(e){var n=e.replace(ne,ie);return function(e){var t=typeof e.getAttributeNode!==M&&e.getAttributeNode("id");return t&&t.value===n}}),w.find.TAG=f.getElementsByTagName?function(e,t){return typeof t.getElementsByTagName!==M?t.getElementsByTagName(e):void 0}:function(e,t){var n,i=[],r=0,o=t.getElementsByTagName(e);if("*"===e){for(;n=o[r++];)1===n.nodeType&&i.push(n);return i}return o},w.find.CLASS=f.getElementsByClassName&&function(e,t){return typeof t.getElementsByClassName!==M&&y?t.getElementsByClassName(e):void 0},a=[],b=[],(f.qsa=X.test(l.querySelectorAll))&&(se(function(e){e.innerHTML="<select msallowclip=''><option selected=''></option></select>",e.querySelectorAll("[msallowclip^='']").length&&b.push("[*^$]="+B+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||b.push("\\["+B+"*(?:value|"+O+")"),e.querySelectorAll(":checked").length||b.push(":checked")}),se(function(e){var t=l.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&b.push("name"+B+"*[*^$|!~]?="),e.querySelectorAll(":enabled").length||b.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),b.push(",.*:")})),(f.matchesSelector=X.test(s=r.matches||r.webkitMatchesSelector||r.mozMatchesSelector||r.oMatchesSelector||r.msMatchesSelector))&&se(function(e){f.disconnectedMatch=s.call(e,"div"),s.call(e,"[s!='']:x"),a.push("!=",U)}),b=b.length&&new RegExp(b.join("|")),a=a.length&&new RegExp(a.join("|")),t=X.test(r.compareDocumentPosition),k=t||X.test(r.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,i=t&&t.parentNode;return e===i||!(!i||1!==i.nodeType||!(n.contains?n.contains(i):e.compareDocumentPosition&&16&e.compareDocumentPosition(i)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},_=t?function(e,t){if(e===t)return d=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!f.sortDetached&&t.compareDocumentPosition(e)===n?e===l||e.ownerDocument===T&&k(T,e)?-1:t===l||t.ownerDocument===T&&k(T,t)?1:c?D.call(c,e)-D.call(c,t):0:4&n?-1:1)}:function(e,t){if(e===t)return d=!0,0;var n,i=0,r=e.parentNode,o=t.parentNode,a=[e],s=[t];if(!r||!o)return e===l?-1:t===l?1:r?-1:o?1:c?D.call(c,e)-D.call(c,t):0;if(r===o)return ce(e,t);for(n=e;n=n.parentNode;)a.unshift(n);for(n=t;n=n.parentNode;)s.unshift(n);for(;a[i]===s[i];)i++;return i?ce(a[i],s[i]):a[i]===T?-1:s[i]===T?1:0},l):C},re.matches=function(e,t){return re(e,null,null,t)},re.matchesSelector=function(e,t){if((e.ownerDocument||e)!==C&&v(e),t=t.replace(V,"='$1']"),!(!f.matchesSelector||!y||a&&a.test(t)||b&&b.test(t)))try{var n=s.call(e,t);if(n||f.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){}return 0<re(t,C,null,[e]).length},re.contains=function(e,t){return(e.ownerDocument||e)!==C&&v(e),k(e,t)},re.attr=function(e,t){(e.ownerDocument||e)!==C&&v(e);var n=w.attrHandle[t.toLowerCase()],i=n&&A.call(w.attrHandle,t.toLowerCase())?n(e,t,!y):void 0;return void 0!==i?i:f.attributes||!y?e.getAttribute(t):(i=e.getAttributeNode(t))&&i.specified?i.value:null},re.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},re.uniqueSort=function(e){var t,n=[],i=0,r=0;if(d=!f.detectDuplicates,c=!f.sortStable&&e.slice(0),e.sort(_),d){for(;t=e[r++];)t===e[r]&&(i=n.push(r));for(;i--;)e.splice(n[i],1)}return c=null,e},o=re.getText=function(e){var t,n="",i=0,r=e.nodeType;if(r){if(1===r||9===r||11===r){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=o(e)}else if(3===r||4===r)return e.nodeValue}else for(;t=e[i++];)n+=o(t);return n},(w=re.selectors={cacheLength:50,createPseudo:ae,match:J,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(ne,ie),e[3]=(e[3]||e[4]||e[5]||"").replace(ne,ie),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||re.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&re.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return J.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&K.test(n)&&(t=g(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(ne,ie).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=l[e+" "];return t||(t=new RegExp("(^|"+B+")"+e+"("+B+"|$)"))&&l(e,function(e){return t.test("string"==typeof e.className&&e.className||typeof e.getAttribute!==M&&e.getAttribute("class")||"")})},ATTR:function(n,i,r){return function(e){var t=re.attr(e,n);return null==t?"!="===i:!i||(t+="","="===i?t===r:"!="===i?t!==r:"^="===i?r&&0===t.indexOf(r):"*="===i?r&&-1<t.indexOf(r):"$="===i?r&&t.slice(-r.length)===r:"~="===i?-1<(" "+t+" ").indexOf(r):"|="===i&&(t===r||t.slice(0,r.length+1)===r+"-"))}},CHILD:function(h,e,t,f,g){var m="nth"!==h.slice(0,3),v="last"!==h.slice(-4),y="of-type"===e;return 1===f&&0===g?function(e){return!!e.parentNode}:function(e,t,n){var i,r,o,a,s,l,c=m!==v?"nextSibling":"previousSibling",d=e.parentNode,u=y&&e.nodeName.toLowerCase(),p=!n&&!y;if(d){if(m){for(;c;){for(o=e;o=o[c];)if(y?o.nodeName.toLowerCase()===u:1===o.nodeType)return!1;l=c="only"===h&&!l&&"nextSibling"}return!0}if(l=[v?d.firstChild:d.lastChild],v&&p){for(s=(i=(r=d[S]||(d[S]={}))[h]||[])[0]===F&&i[1],a=i[0]===F&&i[2],o=s&&d.childNodes[s];o=++s&&o&&o[c]||(a=s=0)||l.pop();)if(1===o.nodeType&&++a&&o===e){r[h]=[F,s,a];break}}else if(p&&(i=(e[S]||(e[S]={}))[h])&&i[0]===F)a=i[1];else for(;(o=++s&&o&&o[c]||(a=s=0)||l.pop())&&((y?o.nodeName.toLowerCase()!==u:1!==o.nodeType)||!++a||(p&&((o[S]||(o[S]={}))[h]=[F,a]),o!==e)););return(a-=g)===f||a%f==0&&0<=a/f}}},PSEUDO:function(e,o){var t,a=w.pseudos[e]||w.setFilters[e.toLowerCase()]||re.error("unsupported pseudo: "+e);return a[S]?a(o):1<a.length?(t=[e,e,"",o],w.setFilters.hasOwnProperty(e.toLowerCase())?ae(function(e,t){for(var n,i=a(e,o),r=i.length;r--;)e[n=D.call(e,i[r])]=!(t[n]=i[r])}):function(e){return a(e,0,t)}):a}},pseudos:{not:ae(function(e){var i=[],r=[],s=u(e.replace(W,"$1"));return s[S]?ae(function(e,t,n,i){for(var r,o=s(e,null,i,[]),a=e.length;a--;)(r=o[a])&&(e[a]=!(t[a]=r))}):function(e,t,n){return i[0]=e,s(i,null,n,r),!r.pop()}}),has:ae(function(t){return function(e){return 0<re(t,e).length}}),contains:ae(function(t){return function(e){return-1<(e.textContent||e.innerText||o(e)).indexOf(t)}}),lang:ae(function(n){return Y.test(n||"")||re.error("unsupported lang: "+n),n=n.replace(ne,ie).toLowerCase(),function(e){var t;do{if(t=y?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===n||0===t.indexOf(n+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=n.location&&n.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===r},focus:function(e){return e===C.activeElement&&(!C.hasFocus||C.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return!1===e.disabled},disabled:function(e){return!0===e.disabled},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!w.pseudos.empty(e)},header:function(e){return G.test(e.nodeName)},input:function(e){return Q.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:pe(function(){return[0]}),last:pe(function(e,t){return[t-1]}),eq:pe(function(e,t,n){return[n<0?n+t:n]}),even:pe(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:pe(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:pe(function(e,t,n){for(var i=n<0?n+t:n;0<=--i;)e.push(i);return e}),gt:pe(function(e,t,n){for(var i=n<0?n+t:n;++i<t;)e.push(i);return e})}}).pseudos.nth=w.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})w.pseudos[e]=de(e);for(e in{submit:!0,reset:!0})w.pseudos[e]=ue(e);function fe(){}function ge(e){for(var t=0,n=e.length,i="";t<n;t++)i+=e[t].value;return i}function me(a,e,t){var s=e.dir,l=t&&"parentNode"===s,c=p++;return e.first?function(e,t,n){for(;e=e[s];)if(1===e.nodeType||l)return a(e,t,n)}:function(e,t,n){var i,r,o=[F,c];if(n){for(;e=e[s];)if((1===e.nodeType||l)&&a(e,t,n))return!0}else for(;e=e[s];)if(1===e.nodeType||l){if((i=(r=e[S]||(e[S]={}))[s])&&i[0]===F&&i[1]===c)return o[2]=i[2];if((r[s]=o)[2]=a(e,t,n))return!0}}}function ve(r){return 1<r.length?function(e,t,n){for(var i=r.length;i--;)if(!r[i](e,t,n))return!1;return!0}:r[0]}function ye(e,t,n,i,r){for(var o,a=[],s=0,l=e.length,c=null!=t;s<l;s++)(o=e[s])&&(!n||n(o,i,r))&&(a.push(o),c&&t.push(s));return a}function be(h,f,g,m,v,e){return m&&!m[S]&&(m=be(m)),v&&!v[S]&&(v=be(v,e)),ae(function(e,t,n,i){var r,o,a,s=[],l=[],c=t.length,d=e||function(e,t,n){for(var i=0,r=t.length;i<r;i++)re(e,t[i],n);return n}(f||"*",n.nodeType?[n]:n,[]),u=!h||!e&&f?d:ye(d,s,h,n,i),p=g?v||(e?h:c||m)?[]:t:u;if(g&&g(u,p,n,i),m)for(r=ye(p,l),m(r,[],n,i),o=r.length;o--;)(a=r[o])&&(p[l[o]]=!(u[l[o]]=a));if(e){if(v||h){if(v){for(r=[],o=p.length;o--;)(a=p[o])&&r.push(u[o]=a);v(null,p=[],r,i)}for(o=p.length;o--;)(a=p[o])&&-1<(r=v?D.call(e,a):s[o])&&(e[r]=!(t[r]=a))}}else p=ye(p===t?p.splice(c,p.length):p),v?v(null,t,p,i):R.apply(t,p)})}function we(e){for(var i,t,n,r=e.length,o=w.relative[e[0].type],a=o||w.relative[" "],s=o?1:0,l=me(function(e){return e===i},a,!0),c=me(function(e){return-1<D.call(i,e)},a,!0),d=[function(e,t,n){return!o&&(n||t!==x)||((i=t).nodeType?l(e,t,n):c(e,t,n))}];s<r;s++)if(t=w.relative[e[s].type])d=[me(ve(d),t)];else{if((t=w.filter[e[s].type].apply(null,e[s].matches))[S]){for(n=++s;n<r&&!w.relative[e[n].type];n++);return be(1<s&&ve(d),1<s&&ge(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(W,"$1"),t,s<n&&we(e.slice(s,n)),n<r&&we(e=e.slice(n)),n<r&&ge(e))}d.push(t)}return ve(d)}return fe.prototype=w.filters=w.pseudos,w.setFilters=new fe,g=re.tokenize=function(e,t){var n,i,r,o,a,s,l,c=h[e+" "];if(c)return t?0:c.slice(0);for(a=e,s=[],l=w.preFilter;a;){for(o in(!n||(i=q.exec(a)))&&(i&&(a=a.slice(i[0].length)||a),s.push(r=[])),n=!1,(i=z.exec(a))&&(n=i.shift(),r.push({value:n,type:i[0].replace(W," ")}),a=a.slice(n.length)),w.filter)!(i=J[o].exec(a))||l[o]&&!(i=l[o](i))||(n=i.shift(),r.push({value:n,type:o,matches:i}),a=a.slice(n.length));if(!n)break}return t?a.length:a?re.error(e):h(e,s).slice(0)},u=re.compile=function(e,t){var n,m,v,y,b,i,r=[],o=[],a=E[e+" "];if(!a){for(t||(t=g(e)),n=t.length;n--;)(a=we(t[n]))[S]?r.push(a):o.push(a);(a=E(e,(m=o,y=0<(v=r).length,b=0<m.length,i=function(e,t,n,i,r){var o,a,s,l=0,c="0",d=e&&[],u=[],p=x,h=e||b&&w.find.TAG("*",r),f=F+=null==p?1:Math.random()||.1,g=h.length;for(r&&(x=t!==C&&t);c!==g&&null!=(o=h[c]);c++){if(b&&o){for(a=0;s=m[a++];)if(s(o,t,n)){i.push(o);break}r&&(F=f)}y&&((o=!s&&o)&&l--,e&&d.push(o))}if(l+=c,y&&c!==l){for(a=0;s=v[a++];)s(d,u,t,n);if(e){if(0<l)for(;c--;)d[c]||u[c]||(u[c]=L.call(i));u=ye(u)}R.apply(i,u),r&&!e&&0<u.length&&1<l+v.length&&re.uniqueSort(i)}return r&&(F=f,x=p),d},y?ae(i):i))).selector=e}return a},m=re.select=function(e,t,n,i){var r,o,a,s,l,c="function"==typeof e&&e,d=!i&&g(e=c.selector||e);if(n=n||[],1===d.length){if(2<(o=d[0]=d[0].slice(0)).length&&"ID"===(a=o[0]).type&&f.getById&&9===t.nodeType&&y&&w.relative[o[1].type]){if(!(t=(w.find.ID(a.matches[0].replace(ne,ie),t)||[])[0]))return n;c&&(t=t.parentNode),e=e.slice(o.shift().value.length)}for(r=J.needsContext.test(e)?0:o.length;r--&&(a=o[r],!w.relative[s=a.type]);)if((l=w.find[s])&&(i=l(a.matches[0].replace(ne,ie),ee.test(o[0].type)&&he(t.parentNode)||t))){if(o.splice(r,1),!(e=i.length&&ge(o)))return R.apply(n,i),n;break}}return(c||u(e,d))(i,t,!y,n,ee.test(e)&&he(t.parentNode)||t),n},f.sortStable=S.split("").sort(_).join("")===S,f.detectDuplicates=!!d,v(),f.sortDetached=se(function(e){return 1&e.compareDocumentPosition(C.createElement("div"))}),se(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||le("type|href|height|width",function(e,t,n){return n?void 0:e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),f.attributes&&se(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||le("value",function(e,t,n){return n||"input"!==e.nodeName.toLowerCase()?void 0:e.defaultValue}),se(function(e){return null==e.getAttribute("disabled")})||le(O,function(e,t,n){var i;return n?void 0:!0===e[t]?t.toLowerCase():(i=e.getAttributeNode(t))&&i.specified?i.value:null}),re}(f);k.find=p,k.expr=p.selectors,k.expr[":"]=k.expr.pseudos,k.unique=p.uniqueSort,k.text=p.getText,k.isXMLDoc=p.isXML,k.contains=p.contains;var h=k.expr.match.needsContext,b=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,w=/^.[^:#\[\.,]*$/;function x(e,n,i){if(k.isFunction(n))return k.grep(e,function(e,t){return!!n.call(e,t,e)!==i});if(n.nodeType)return k.grep(e,function(e){return e===n!==i});if("string"==typeof n){if(w.test(n))return k.filter(n,e,i);n=k.filter(n,e)}return k.grep(e,function(e){return 0<=r.call(n,e)!==i})}k.filter=function(e,t,n){var i=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===i.nodeType?k.find.matchesSelector(i,e)?[i]:[]:k.find.matches(e,k.grep(t,function(e){return 1===e.nodeType}))},k.fn.extend({find:function(e){var t,n=this.length,i=[],r=this;if("string"!=typeof e)return this.pushStack(k(e).filter(function(){for(t=0;t<n;t++)if(k.contains(r[t],this))return!0}));for(t=0;t<n;t++)k.find(e,r[t],i);return(i=this.pushStack(1<n?k.unique(i):i)).selector=this.selector?this.selector+" "+e:e,i},filter:function(e){return this.pushStack(x(this,e||[],!1))},not:function(e){return this.pushStack(x(this,e||[],!0))},is:function(e){return!!x(this,"string"==typeof e&&h.test(e)?k(e):e||[],!1).length}});var C,S=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/;(k.fn.init=function(e,t){var n,i;if(!e)return this;if("string"==typeof e){if(!(n="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:S.exec(e))||!n[1]&&t)return!t||t.jquery?(t||C).find(e):this.constructor(t).find(e);if(n[1]){if(t=t instanceof k?t[0]:t,k.merge(this,k.parseHTML(n[1],t&&t.nodeType?t.ownerDocument||t:y,!0)),b.test(n[1])&&k.isPlainObject(t))for(n in t)k.isFunction(this[n])?this[n](t[n]):this.attr(n,t[n]);return this}return(i=y.getElementById(n[2]))&&i.parentNode&&(this.length=1,this[0]=i),this.context=y,this.selector=e,this}return e.nodeType?(this.context=this[0]=e,this.length=1,this):k.isFunction(e)?void 0!==C.ready?C.ready(e):e(k):(void 0!==e.selector&&(this.selector=e.selector,this.context=e.context),k.makeArray(e,this))}).prototype=k.fn,C=k(y);var T=/^(?:parents|prev(?:Until|All))/,F={children:!0,contents:!0,next:!0,prev:!0};function E(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}k.extend({dir:function(e,t,n){for(var i=[],r=void 0!==n;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(r&&k(e).is(n))break;i.push(e)}return i},sibling:function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n}}),k.fn.extend({has:function(e){var t=k(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(k.contains(this,t[e]))return!0})},closest:function(e,t){for(var n,i=0,r=this.length,o=[],a=h.test(e)||"string"!=typeof e?k(e,t||this.context):0;i<r;i++)for(n=this[i];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?-1<a.index(n):1===n.nodeType&&k.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(1<o.length?k.unique(o):o)},index:function(e){return e?"string"==typeof e?r.call(k(e),this[0]):r.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(k.unique(k.merge(this.get(),k(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),k.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return k.dir(e,"parentNode")},parentsUntil:function(e,t,n){return k.dir(e,"parentNode",n)},next:function(e){return E(e,"nextSibling")},prev:function(e){return E(e,"previousSibling")},nextAll:function(e){return k.dir(e,"nextSibling")},prevAll:function(e){return k.dir(e,"previousSibling")},nextUntil:function(e,t,n){return k.dir(e,"nextSibling",n)},prevUntil:function(e,t,n){return k.dir(e,"previousSibling",n)},siblings:function(e){return k.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return k.sibling(e.firstChild)},contents:function(e){return e.contentDocument||k.merge([],e.childNodes)}},function(i,r){k.fn[i]=function(e,t){var n=k.map(this,r,e);return"Until"!==i.slice(-5)&&(t=e),t&&"string"==typeof t&&(n=k.filter(t,n)),1<this.length&&(F[i]||k.unique(n),T.test(i)&&n.reverse()),this.pushStack(n)}});var _,M=/\S+/g,N={};function A(){y.removeEventListener("DOMContentLoaded",A,!1),f.removeEventListener("load",A,!1),k.ready()}k.Callbacks=function(r){var e,n;r="string"==typeof r?N[r]||(n=N[e=r]={},k.each(e.match(M)||[],function(e,t){n[t]=!0}),n):k.extend({},r);var t,i,o,a,s,l,c=[],d=!r.once&&[],u=function(e){for(t=r.memory&&e,i=!0,l=a||0,a=0,s=c.length,o=!0;c&&l<s;l++)if(!1===c[l].apply(e[0],e[1])&&r.stopOnFalse){t=!1;break}o=!1,c&&(d?d.length&&u(d.shift()):t?c=[]:p.disable())},p={add:function(){if(c){var e=c.length;!function i(e){k.each(e,function(e,t){var n=k.type(t);"function"===n?r.unique&&p.has(t)||c.push(t):t&&t.length&&"string"!==n&&i(t)})}(arguments),o?s=c.length:t&&(a=e,u(t))}return this},remove:function(){return c&&k.each(arguments,function(e,t){for(var n;-1<(n=k.inArray(t,c,n));)c.splice(n,1),o&&(n<=s&&s--,n<=l&&l--)}),this},has:function(e){return e?-1<k.inArray(e,c):!(!c||!c.length)},empty:function(){return c=[],s=0,this},disable:function(){return c=d=t=void 0,this},disabled:function(){return!c},lock:function(){return d=void 0,t||p.disable(),this},locked:function(){return!d},fireWith:function(e,t){return!c||i&&!d||(t=[e,(t=t||[]).slice?t.slice():t],o?d.push(t):u(t)),this},fire:function(){return p.fireWith(this,arguments),this},fired:function(){return!!i}};return p},k.extend({Deferred:function(e){var o=[["resolve","done",k.Callbacks("once memory"),"resolved"],["reject","fail",k.Callbacks("once memory"),"rejected"],["notify","progress",k.Callbacks("memory")]],r="pending",a={state:function(){return r},always:function(){return s.done(arguments).fail(arguments),this},then:function(){var r=arguments;return k.Deferred(function(i){k.each(o,function(e,t){var n=k.isFunction(r[e])&&r[e];s[t[1]](function(){var e=n&&n.apply(this,arguments);e&&k.isFunction(e.promise)?e.promise().done(i.resolve).fail(i.reject).progress(i.notify):i[t[0]+"With"](this===a?i.promise():this,n?[e]:arguments)})}),r=null}).promise()},promise:function(e){return null!=e?k.extend(e,a):a}},s={};return a.pipe=a.then,k.each(o,function(e,t){var n=t[2],i=t[3];a[t[1]]=n.add,i&&n.add(function(){r=i},o[1^e][2].disable,o[2][2].lock),s[t[0]]=function(){return s[t[0]+"With"](this===s?a:this,arguments),this},s[t[0]+"With"]=n.fireWith}),a.promise(s),e&&e.call(s,s),s},when:function(e){var r,t,n,i=0,o=d.call(arguments),a=o.length,s=1!==a||e&&k.isFunction(e.promise)?a:0,l=1===s?e:k.Deferred(),c=function(t,n,i){return function(e){n[t]=this,i[t]=1<arguments.length?d.call(arguments):e,i===r?l.notifyWith(n,i):--s||l.resolveWith(n,i)}};if(1<a)for(r=new Array(a),t=new Array(a),n=new Array(a);i<a;i++)o[i]&&k.isFunction(o[i].promise)?o[i].promise().done(c(i,n,o)).fail(l.reject).progress(c(i,t,r)):--s;return s||l.resolveWith(n,o),l.promise()}}),k.fn.ready=function(e){return k.ready.promise().done(e),this},k.extend({isReady:!1,readyWait:1,holdReady:function(e){e?k.readyWait++:k.ready(!0)},ready:function(e){(!0===e?--k.readyWait:k.isReady)||((k.isReady=!0)!==e&&0<--k.readyWait||(_.resolveWith(y,[k]),k.fn.triggerHandler&&(k(y).triggerHandler("ready"),k(y).off("ready"))))}}),k.ready.promise=function(e){return _||(_=k.Deferred(),"complete"===y.readyState?setTimeout(k.ready):(y.addEventListener("DOMContentLoaded",A,!1),f.addEventListener("load",A,!1))),_.promise(e)},k.ready.promise();var L=k.access=function(e,t,n,i,r,o,a){var s=0,l=e.length,c=null==n;if("object"===k.type(n))for(s in r=!0,n)k.access(e,t,s,n[s],!0,o,a);else if(void 0!==i&&(r=!0,k.isFunction(i)||(a=!0),c&&(a?(t.call(e,i),t=null):(c=t,t=function(e,t,n){return c.call(k(e),n)})),t))for(;s<l;s++)t(e[s],n,a?i:i.call(e[s],s,t(e[s],n)));return r?e:c?t.call(e):l?t(e[0],n):o};function I(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=k.expando+Math.random()}k.acceptData=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType},I.uid=1,I.accepts=k.acceptData,I.prototype={key:function(t){if(!I.accepts(t))return 0;var n={},i=t[this.expando];if(!i){i=I.uid++;try{n[this.expando]={value:i},Object.defineProperties(t,n)}catch(e){n[this.expando]=i,k.extend(t,n)}}return this.cache[i]||(this.cache[i]={}),i},set:function(e,t,n){var i,r=this.key(e),o=this.cache[r];if("string"==typeof t)o[t]=n;else if(k.isEmptyObject(o))k.extend(this.cache[r],t);else for(i in t)o[i]=t[i];return o},get:function(e,t){var n=this.cache[this.key(e)];return void 0===t?n:n[t]},access:function(e,t,n){var i;return void 0===t||t&&"string"==typeof t&&void 0===n?void 0!==(i=this.get(e,t))?i:this.get(e,k.camelCase(t)):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,i,r,o=this.key(e),a=this.cache[o];if(void 0===t)this.cache[o]={};else{k.isArray(t)?i=t.concat(t.map(k.camelCase)):(r=k.camelCase(t),t in a?i=[t,r]:i=(i=r)in a?[i]:i.match(M)||[]),n=i.length;for(;n--;)delete a[i[n]]}},hasData:function(e){return!k.isEmptyObject(this.cache[e[this.expando]]||{})},discard:function(e){e[this.expando]&&delete this.cache[e[this.expando]]}};var R=new I,P=new I,D=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,O=/([A-Z])/g;function B(e,t,n){var i;if(void 0===n&&1===e.nodeType)if(i="data-"+t.replace(O,"-$1").toLowerCase(),"string"==typeof(n=e.getAttribute(i))){try{n="true"===n||"false"!==n&&("null"===n?null:+n+""===n?+n:D.test(n)?k.parseJSON(n):n)}catch(e){}P.set(e,t,n)}else n=void 0;return n}k.extend({hasData:function(e){return P.hasData(e)||R.hasData(e)},data:function(e,t,n){return P.access(e,t,n)},removeData:function(e,t){P.remove(e,t)},_data:function(e,t,n){return R.access(e,t,n)},_removeData:function(e,t){R.remove(e,t)}}),k.fn.extend({data:function(i,e){var t,n,r,o=this[0],a=o&&o.attributes;if(void 0===i){if(this.length&&(r=P.get(o),1===o.nodeType&&!R.get(o,"hasDataAttrs"))){for(t=a.length;t--;)a[t]&&(0===(n=a[t].name).indexOf("data-")&&(n=k.camelCase(n.slice(5)),B(o,n,r[n])));R.set(o,"hasDataAttrs",!0)}return r}return"object"==typeof i?this.each(function(){P.set(this,i)}):L(this,function(t){var e,n=k.camelCase(i);if(o&&void 0===t){if(void 0!==(e=P.get(o,i)))return e;if(void 0!==(e=P.get(o,n)))return e;if(void 0!==(e=B(o,n,void 0)))return e}else this.each(function(){var e=P.get(this,n);P.set(this,n,t),-1!==i.indexOf("-")&&void 0!==e&&P.set(this,i,t)})},null,e,1<arguments.length,null,!0)},removeData:function(e){return this.each(function(){P.remove(this,e)})}}),k.extend({queue:function(e,t,n){var i;return e?(t=(t||"fx")+"queue",i=R.get(e,t),n&&(!i||k.isArray(n)?i=R.access(e,t,k.makeArray(n)):i.push(n)),i||[]):void 0},dequeue:function(e,t){t=t||"fx";var n=k.queue(e,t),i=n.length,r=n.shift(),o=k._queueHooks(e,t);"inprogress"===r&&(r=n.shift(),i--),r&&("fx"===t&&n.unshift("inprogress"),delete o.stop,r.call(e,function(){k.dequeue(e,t)},o)),!i&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return R.get(e,n)||R.access(e,n,{empty:k.Callbacks("once memory").add(function(){R.remove(e,[t+"queue",n])})})}}),k.fn.extend({queue:function(t,n){var e=2;return"string"!=typeof t&&(n=t,t="fx",e--),arguments.length<e?k.queue(this[0],t):void 0===n?this:this.each(function(){var e=k.queue(this,t,n);k._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&k.dequeue(this,t)})},dequeue:function(e){return this.each(function(){k.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,i=1,r=k.Deferred(),o=this,a=this.length,s=function(){--i||r.resolveWith(o,[o])};for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";a--;)(n=R.get(o[a],e+"queueHooks"))&&n.empty&&(i++,n.empty.add(s));return s(),r.promise(t)}});var j,$,H=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,U=["Top","Right","Bottom","Left"],W=function(e,t){return e=t||e,"none"===k.css(e,"display")||!k.contains(e.ownerDocument,e)},q=/^(?:checkbox|radio)$/i;j=y.createDocumentFragment().appendChild(y.createElement("div")),($=y.createElement("input")).setAttribute("type","radio"),$.setAttribute("checked","checked"),$.setAttribute("name","t"),j.appendChild($),v.checkClone=j.cloneNode(!0).cloneNode(!0).lastChild.checked,j.innerHTML="<textarea>x</textarea>",v.noCloneChecked=!!j.cloneNode(!0).lastChild.defaultValue;var z="undefined";v.focusinBubbles="onfocusin"in f;var V=/^key/,K=/^(?:mouse|pointer|contextmenu)|click/,Y=/^(?:focusinfocus|focusoutblur)$/,J=/^([^.]*)(?:\.(.+)|)$/;function Q(){return!0}function G(){return!1}function X(){try{return y.activeElement}catch(e){}}k.event={global:{},add:function(t,e,n,i,r){var o,a,s,l,c,d,u,p,h,f,g,m=R.get(t);if(m)for(n.handler&&(n=(o=n).handler,r=o.selector),n.guid||(n.guid=k.guid++),(l=m.events)||(l=m.events={}),(a=m.handle)||(a=m.handle=function(e){return typeof k!==z&&k.event.triggered!==e.type?k.event.dispatch.apply(t,arguments):void 0}),c=(e=(e||"").match(M)||[""]).length;c--;)h=g=(s=J.exec(e[c])||[])[1],f=(s[2]||"").split(".").sort(),h&&(u=k.event.special[h]||{},h=(r?u.delegateType:u.bindType)||h,u=k.event.special[h]||{},d=k.extend({type:h,origType:g,data:i,handler:n,guid:n.guid,selector:r,needsContext:r&&k.expr.match.needsContext.test(r),namespace:f.join(".")},o),(p=l[h])||((p=l[h]=[]).delegateCount=0,u.setup&&!1!==u.setup.call(t,i,f,a)||t.addEventListener&&t.addEventListener(h,a,!1)),u.add&&(u.add.call(t,d),d.handler.guid||(d.handler.guid=n.guid)),r?p.splice(p.delegateCount++,0,d):p.push(d),k.event.global[h]=!0)},remove:function(e,t,n,i,r){var o,a,s,l,c,d,u,p,h,f,g,m=R.hasData(e)&&R.get(e);if(m&&(l=m.events)){for(c=(t=(t||"").match(M)||[""]).length;c--;)if(h=g=(s=J.exec(t[c])||[])[1],f=(s[2]||"").split(".").sort(),h){for(u=k.event.special[h]||{},p=l[h=(i?u.delegateType:u.bindType)||h]||[],s=s[2]&&new RegExp("(^|\\.)"+f.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;o--;)d=p[o],!r&&g!==d.origType||n&&n.guid!==d.guid||s&&!s.test(d.namespace)||i&&i!==d.selector&&("**"!==i||!d.selector)||(p.splice(o,1),d.selector&&p.delegateCount--,u.remove&&u.remove.call(e,d));a&&!p.length&&(u.teardown&&!1!==u.teardown.call(e,f,m.handle)||k.removeEvent(e,h,m.handle),delete l[h])}else for(h in l)k.event.remove(e,h+t[c],n,i,!0);k.isEmptyObject(l)&&(delete m.handle,R.remove(e,"events"))}},trigger:function(e,t,n,i){var r,o,a,s,l,c,d,u=[n||y],p=m.call(e,"type")?e.type:e,h=m.call(e,"namespace")?e.namespace.split("."):[];if(o=a=n=n||y,3!==n.nodeType&&8!==n.nodeType&&!Y.test(p+k.event.triggered)&&(0<=p.indexOf(".")&&(p=(h=p.split(".")).shift(),h.sort()),l=p.indexOf(":")<0&&"on"+p,(e=e[k.expando]?e:new k.Event(p,"object"==typeof e&&e)).isTrigger=i?2:3,e.namespace=h.join("."),e.namespace_re=e.namespace?new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:k.makeArray(t,[e]),d=k.event.special[p]||{},i||!d.trigger||!1!==d.trigger.apply(n,t))){if(!i&&!d.noBubble&&!k.isWindow(n)){for(s=d.delegateType||p,Y.test(s+p)||(o=o.parentNode);o;o=o.parentNode)u.push(o),a=o;a===(n.ownerDocument||y)&&u.push(a.defaultView||a.parentWindow||f)}for(r=0;(o=u[r++])&&!e.isPropagationStopped();)e.type=1<r?s:d.bindType||p,(c=(R.get(o,"events")||{})[e.type]&&R.get(o,"handle"))&&c.apply(o,t),(c=l&&o[l])&&c.apply&&k.acceptData(o)&&(e.result=c.apply(o,t),!1===e.result&&e.preventDefault());return e.type=p,i||e.isDefaultPrevented()||d._default&&!1!==d._default.apply(u.pop(),t)||!k.acceptData(n)||l&&k.isFunction(n[p])&&!k.isWindow(n)&&((a=n[l])&&(n[l]=null),n[k.event.triggered=p](),k.event.triggered=void 0,a&&(n[l]=a)),e.result}},dispatch:function(e){e=k.event.fix(e);var t,n,i,r,o,a=[],s=d.call(arguments),l=(R.get(this,"events")||{})[e.type]||[],c=k.event.special[e.type]||{};if((s[0]=e).delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,e)){for(a=k.event.handlers.call(this,e,l),t=0;(r=a[t++])&&!e.isPropagationStopped();)for(e.currentTarget=r.elem,n=0;(o=r.handlers[n++])&&!e.isImmediatePropagationStopped();)(!e.namespace_re||e.namespace_re.test(o.namespace))&&(e.handleObj=o,e.data=o.data,void 0!==(i=((k.event.special[o.origType]||{}).handle||o.handler).apply(r.elem,s))&&!1===(e.result=i)&&(e.preventDefault(),e.stopPropagation()));return c.postDispatch&&c.postDispatch.call(this,e),e.result}},handlers:function(e,t){var n,i,r,o,a=[],s=t.delegateCount,l=e.target;if(s&&l.nodeType&&(!e.button||"click"!==e.type))for(;l!==this;l=l.parentNode||this)if(!0!==l.disabled||"click"!==e.type){for(i=[],n=0;n<s;n++)void 0===i[r=(o=t[n]).selector+" "]&&(i[r]=o.needsContext?0<=k(r,this).index(l):k.find(r,this,null,[l]).length),i[r]&&i.push(o);i.length&&a.push({elem:l,handlers:i})}return s<t.length&&a.push({elem:this,handlers:t.slice(s)}),a},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,t){var n,i,r,o=t.button;return null==e.pageX&&null!=t.clientX&&(i=(n=e.target.ownerDocument||y).documentElement,r=n.body,e.pageX=t.clientX+(i&&i.scrollLeft||r&&r.scrollLeft||0)-(i&&i.clientLeft||r&&r.clientLeft||0),e.pageY=t.clientY+(i&&i.scrollTop||r&&r.scrollTop||0)-(i&&i.clientTop||r&&r.clientTop||0)),e.which||void 0===o||(e.which=1&o?1:2&o?3:4&o?2:0),e}},fix:function(e){if(e[k.expando])return e;var t,n,i,r=e.type,o=e,a=this.fixHooks[r];for(a||(this.fixHooks[r]=a=K.test(r)?this.mouseHooks:V.test(r)?this.keyHooks:{}),i=a.props?this.props.concat(a.props):this.props,e=new k.Event(o),t=i.length;t--;)e[n=i[t]]=o[n];return e.target||(e.target=y),3===e.target.nodeType&&(e.target=e.target.parentNode),a.filter?a.filter(e,o):e},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==X()&&this.focus?(this.focus(),!1):void 0},delegateType:"focusin"},blur:{trigger:function(){return this===X()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&k.nodeName(this,"input")?(this.click(),!1):void 0},_default:function(e){return k.nodeName(e.target,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,n,i){var r=k.extend(new k.Event,n,{type:e,isSimulated:!0,originalEvent:{}});i?k.event.trigger(r,null,t):k.event.dispatch.call(t,r),r.isDefaultPrevented()&&n.preventDefault()}},k.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n,!1)},k.Event=function(e,t){return this instanceof k.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?Q:G):this.type=e,t&&k.extend(this,t),this.timeStamp=e&&e.timeStamp||k.now(),void(this[k.expando]=!0)):new k.Event(e,t)},k.Event.prototype={isDefaultPrevented:G,isPropagationStopped:G,isImmediatePropagationStopped:G,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=Q,e&&e.preventDefault&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=Q,e&&e.stopPropagation&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=Q,e&&e.stopImmediatePropagation&&e.stopImmediatePropagation(),this.stopPropagation()}},k.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,r){k.event.special[e]={delegateType:r,bindType:r,handle:function(e){var t,n=e.relatedTarget,i=e.handleObj;return(!n||n!==this&&!k.contains(this,n))&&(e.type=i.origType,t=i.handler.apply(this,arguments),e.type=r),t}}}),v.focusinBubbles||k.each({focus:"focusin",blur:"focusout"},function(n,i){var r=function(e){k.event.simulate(i,e.target,k.event.fix(e),!0)};k.event.special[i]={setup:function(){var e=this.ownerDocument||this,t=R.access(e,i);t||e.addEventListener(n,r,!0),R.access(e,i,(t||0)+1)},teardown:function(){var e=this.ownerDocument||this,t=R.access(e,i)-1;t?R.access(e,i,t):(e.removeEventListener(n,r,!0),R.remove(e,i))}}}),k.fn.extend({on:function(e,t,n,i,r){var o,a;if("object"==typeof e){for(a in"string"!=typeof t&&(n=n||t,t=void 0),e)this.on(a,t,n,e[a],r);return this}if(null==n&&null==i?(i=t,n=t=void 0):null==i&&("string"==typeof t?(i=n,n=void 0):(i=n,n=t,t=void 0)),!1===i)i=G;else if(!i)return this;return 1===r&&(o=i,(i=function(e){return k().off(e),o.apply(this,arguments)}).guid=o.guid||(o.guid=k.guid++)),this.each(function(){k.event.add(this,e,i,n,t)})},one:function(e,t,n,i){return this.on(e,t,n,i,1)},off:function(e,t,n){var i,r;if(e&&e.preventDefault&&e.handleObj)return i=e.handleObj,k(e.delegateTarget).off(i.namespace?i.origType+"."+i.namespace:i.origType,i.selector,i.handler),this;if("object"==typeof e){for(r in e)this.off(r,t,e[r]);return this}return(!1===t||"function"==typeof t)&&(n=t,t=void 0),!1===n&&(n=G),this.each(function(){k.event.remove(this,e,n,t)})},trigger:function(e,t){return this.each(function(){k.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];return n?k.event.trigger(e,t,n,!0):void 0}});var Z=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,ee=/<([\w:]+)/,te=/<|&#?\w+;/,ne=/<(?:script|style|link)/i,ie=/checked\s*(?:[^=]|=\s*.checked.)/i,re=/^$|\/(?:java|ecma)script/i,oe=/^true\/(.*)/,ae=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,se={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function le(e,t){return k.nodeName(e,"table")&&k.nodeName(11!==t.nodeType?t:t.firstChild,"tr")?e.getElementsByTagName("tbody")[0]||e.appendChild(e.ownerDocument.createElement("tbody")):e}function ce(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function de(e){var t=oe.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function ue(e,t){for(var n=0,i=e.length;n<i;n++)R.set(e[n],"globalEval",!t||R.get(t[n],"globalEval"))}function pe(e,t){var n,i,r,o,a,s,l,c;if(1===t.nodeType){if(R.hasData(e)&&(o=R.access(e),a=R.set(t,o),c=o.events))for(r in delete a.handle,a.events={},c)for(n=0,i=c[r].length;n<i;n++)k.event.add(t,r,c[r][n]);P.hasData(e)&&(s=P.access(e),l=k.extend({},s),P.set(t,l))}}function he(e,t){var n=e.getElementsByTagName?e.getElementsByTagName(t||"*"):e.querySelectorAll?e.querySelectorAll(t||"*"):[];return void 0===t||t&&k.nodeName(e,t)?k.merge([e],n):n}se.optgroup=se.option,se.tbody=se.tfoot=se.colgroup=se.caption=se.thead,se.th=se.td,k.extend({clone:function(e,t,n){var i,r,o,a,s,l,c,d=e.cloneNode(!0),u=k.contains(e.ownerDocument,e);if(!(v.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||k.isXMLDoc(e)))for(a=he(d),i=0,r=(o=he(e)).length;i<r;i++)s=o[i],l=a[i],void 0,"input"===(c=l.nodeName.toLowerCase())&&q.test(s.type)?l.checked=s.checked:("input"===c||"textarea"===c)&&(l.defaultValue=s.defaultValue);if(t)if(n)for(o=o||he(e),a=a||he(d),i=0,r=o.length;i<r;i++)pe(o[i],a[i]);else pe(e,d);return 0<(a=he(d,"script")).length&&ue(a,!u&&he(e,"script")),d},buildFragment:function(e,t,n,i){for(var r,o,a,s,l,c,d=t.createDocumentFragment(),u=[],p=0,h=e.length;p<h;p++)if((r=e[p])||0===r)if("object"===k.type(r))k.merge(u,r.nodeType?[r]:r);else if(te.test(r)){for(o=o||d.appendChild(t.createElement("div")),a=(ee.exec(r)||["",""])[1].toLowerCase(),s=se[a]||se._default,o.innerHTML=s[1]+r.replace(Z,"<$1></$2>")+s[2],c=s[0];c--;)o=o.lastChild;k.merge(u,o.childNodes),(o=d.firstChild).textContent=""}else u.push(t.createTextNode(r));for(d.textContent="",p=0;r=u[p++];)if((!i||-1===k.inArray(r,i))&&(l=k.contains(r.ownerDocument,r),o=he(d.appendChild(r),"script"),l&&ue(o),n))for(c=0;r=o[c++];)re.test(r.type||"")&&n.push(r);return d},cleanData:function(e){for(var t,n,i,r,o=k.event.special,a=0;void 0!==(n=e[a]);a++){if(k.acceptData(n)&&((r=n[R.expando])&&(t=R.cache[r]))){if(t.events)for(i in t.events)o[i]?k.event.remove(n,i):k.removeEvent(n,i,t.handle);R.cache[r]&&delete R.cache[r]}delete P.cache[n[P.expando]]}}}),k.fn.extend({text:function(e){return L(this,function(e){return void 0===e?k.text(this):this.empty().each(function(){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&(this.textContent=e)})},null,e,arguments.length)},append:function(){return this.domManip(arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||le(this,e).appendChild(e)})},prepend:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=le(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},remove:function(e,t){for(var n,i=e?k.filter(e,this):this,r=0;null!=(n=i[r]);r++)t||1!==n.nodeType||k.cleanData(he(n)),n.parentNode&&(t&&k.contains(n.ownerDocument,n)&&ue(he(n,"script")),n.parentNode.removeChild(n));return this},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(k.cleanData(he(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return k.clone(this,e,t)})},html:function(e){return L(this,function(e){var t=this[0]||{},n=0,i=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!ne.test(e)&&!se[(ee.exec(e)||["",""])[1].toLowerCase()]){e=e.replace(Z,"<$1></$2>");try{for(;n<i;n++)1===(t=this[n]||{}).nodeType&&(k.cleanData(he(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var t=arguments[0];return this.domManip(arguments,function(e){t=this.parentNode,k.cleanData(he(this)),t&&t.replaceChild(e,this)}),t&&(t.length||t.nodeType)?this:this.remove()},detach:function(e){return this.remove(e,!0)},domManip:function(n,i){n=g.apply([],n);var e,t,r,o,a,s,l=0,c=this.length,d=this,u=c-1,p=n[0],h=k.isFunction(p);if(h||1<c&&"string"==typeof p&&!v.checkClone&&ie.test(p))return this.each(function(e){var t=d.eq(e);h&&(n[0]=p.call(this,e,t.html())),t.domManip(n,i)});if(c&&(t=(e=k.buildFragment(n,this[0].ownerDocument,!1,this)).firstChild,1===e.childNodes.length&&(e=t),t)){for(o=(r=k.map(he(e,"script"),ce)).length;l<c;l++)a=e,l!==u&&(a=k.clone(a,!0,!0),o&&k.merge(r,he(a,"script"))),i.call(this[l],a,l);if(o)for(s=r[r.length-1].ownerDocument,k.map(r,de),l=0;l<o;l++)a=r[l],re.test(a.type||"")&&!R.access(a,"globalEval")&&k.contains(s,a)&&(a.src?k._evalUrl&&k._evalUrl(a.src):k.globalEval(a.textContent.replace(ae,"")))}return this}}),k.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){k.fn[e]=function(e){for(var t,n=[],i=k(e),r=i.length-1,o=0;o<=r;o++)t=o===r?this:this.clone(!0),k(i[o])[a](t),s.apply(n,t.get());return this.pushStack(n)}});var fe,ge={};function me(e,t){var n,i=k(t.createElement(e)).appendTo(t.body),r=f.getDefaultComputedStyle&&(n=f.getDefaultComputedStyle(i[0]))?n.display:k.css(i[0],"display");return i.detach(),r}function ve(e){var t=y,n=ge[e];return n||("none"!==(n=me(e,t))&&n||((t=(fe=(fe||k("<iframe frameborder='0' width='0' height='0'/>")).appendTo(t.documentElement))[0].contentDocument).write(),t.close(),n=me(e,t),fe.detach()),ge[e]=n),n}var ye=/^margin/,be=new RegExp("^("+H+")(?!px)[a-z%]+$","i"),we=function(e){return e.ownerDocument.defaultView.getComputedStyle(e,null)};function xe(e,t,n){var i,r,o,a,s=e.style;return(n=n||we(e))&&(a=n.getPropertyValue(t)||n[t]),n&&(""!==a||k.contains(e.ownerDocument,e)||(a=k.style(e,t)),be.test(a)&&ye.test(t)&&(i=s.width,r=s.minWidth,o=s.maxWidth,s.minWidth=s.maxWidth=s.width=a,a=n.width,s.width=i,s.minWidth=r,s.maxWidth=o)),void 0!==a?a+"":a}function Ce(e,t){return{get:function(){return e()?void delete this.get:(this.get=t).apply(this,arguments)}}}!function(){var t,n,i=y.documentElement,r=y.createElement("div"),o=y.createElement("div");if(o.style){function e(){o.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;display:block;margin-top:1%;top:1%;border:1px;padding:1px;width:4px;position:absolute",o.innerHTML="",i.appendChild(r);var e=f.getComputedStyle(o,null);t="1%"!==e.top,n="4px"===e.width,i.removeChild(r)}o.style.backgroundClip="content-box",o.cloneNode(!0).style.backgroundClip="",v.clearCloneStyle="content-box"===o.style.backgroundClip,r.style.cssText="border:0;width:0;height:0;top:0;left:-9999px;margin-top:1px;position:absolute",r.appendChild(o),f.getComputedStyle&&k.extend(v,{pixelPosition:function(){return e(),t},boxSizingReliable:function(){return null==n&&e(),n},reliableMarginRight:function(){var e,t=o.appendChild(y.createElement("div"));return t.style.cssText=o.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",t.style.marginRight=t.style.width="0",o.style.width="1px",i.appendChild(r),e=!parseFloat(f.getComputedStyle(t,null).marginRight),i.removeChild(r),e}})}}(),k.swap=function(e,t,n,i){var r,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];for(o in r=n.apply(e,i||[]),t)e.style[o]=a[o];return r};var ke=/^(none|table(?!-c[ea]).+)/,Se=new RegExp("^("+H+")(.*)$","i"),Te=new RegExp("^([+-])=("+H+")","i"),Fe={position:"absolute",visibility:"hidden",display:"block"},Ee={letterSpacing:"0",fontWeight:"400"},_e=["Webkit","O","Moz","ms"];function Me(e,t){if(t in e)return t;for(var n=t[0].toUpperCase()+t.slice(1),i=t,r=_e.length;r--;)if((t=_e[r]+n)in e)return t;return i}function Ne(e,t,n){var i=Se.exec(t);return i?Math.max(0,i[1]-(n||0))+(i[2]||"px"):t}function Ae(e,t,n,i,r){for(var o=n===(i?"border":"content")?4:"width"===t?1:0,a=0;o<4;o+=2)"margin"===n&&(a+=k.css(e,n+U[o],!0,r)),i?("content"===n&&(a-=k.css(e,"padding"+U[o],!0,r)),"margin"!==n&&(a-=k.css(e,"border"+U[o]+"Width",!0,r))):(a+=k.css(e,"padding"+U[o],!0,r),"padding"!==n&&(a+=k.css(e,"border"+U[o]+"Width",!0,r)));return a}function Le(e,t,n){var i=!0,r="width"===t?e.offsetWidth:e.offsetHeight,o=we(e),a="border-box"===k.css(e,"boxSizing",!1,o);if(r<=0||null==r){if(((r=xe(e,t,o))<0||null==r)&&(r=e.style[t]),be.test(r))return r;i=a&&(v.boxSizingReliable()||r===e.style[t]),r=parseFloat(r)||0}return r+Ae(e,t,n||(a?"border":"content"),i,o)+"px"}function Ie(e,t){for(var n,i,r,o=[],a=0,s=e.length;a<s;a++)(i=e[a]).style&&(o[a]=R.get(i,"olddisplay"),n=i.style.display,t?(o[a]||"none"!==n||(i.style.display=""),""===i.style.display&&W(i)&&(o[a]=R.access(i,"olddisplay",ve(i.nodeName)))):(r=W(i),"none"===n&&r||R.set(i,"olddisplay",r?n:k.css(i,"display"))));for(a=0;a<s;a++)(i=e[a]).style&&(t&&"none"!==i.style.display&&""!==i.style.display||(i.style.display=t?o[a]||"":"none"));return e}function Re(e,t,n,i,r){return new Re.prototype.init(e,t,n,i,r)}k.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=xe(e,"opacity");return""===n?"1":n}}}},cssNumber:{columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{float:"cssFloat"},style:function(e,t,n,i){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var r,o,a,s=k.camelCase(t),l=e.style;return t=k.cssProps[s]||(k.cssProps[s]=Me(l,s)),a=k.cssHooks[t]||k.cssHooks[s],void 0===n?a&&"get"in a&&void 0!==(r=a.get(e,!1,i))?r:l[t]:("string"===(o=typeof n)&&(r=Te.exec(n))&&(n=(r[1]+1)*r[2]+parseFloat(k.css(e,t)),o="number"),void(null!=n&&n==n&&("number"!==o||k.cssNumber[s]||(n+="px"),v.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,i))||(l[t]=n))))}},css:function(e,t,n,i){var r,o,a,s=k.camelCase(t);return t=k.cssProps[s]||(k.cssProps[s]=Me(e.style,s)),(a=k.cssHooks[t]||k.cssHooks[s])&&"get"in a&&(r=a.get(e,!0,n)),void 0===r&&(r=xe(e,t,i)),"normal"===r&&t in Ee&&(r=Ee[t]),""===n||n?(o=parseFloat(r),!0===n||k.isNumeric(o)?o||0:r):r}}),k.each(["height","width"],function(e,r){k.cssHooks[r]={get:function(e,t,n){return t?ke.test(k.css(e,"display"))&&0===e.offsetWidth?k.swap(e,Fe,function(){return Le(e,r,n)}):Le(e,r,n):void 0},set:function(e,t,n){var i=n&&we(e);return Ne(0,t,n?Ae(e,r,n,"border-box"===k.css(e,"boxSizing",!1,i),i):0)}}}),k.cssHooks.marginRight=Ce(v.reliableMarginRight,function(e,t){return t?k.swap(e,{display:"inline-block"},xe,[e,"marginRight"]):void 0}),k.each({margin:"",padding:"",border:"Width"},function(r,o){k.cssHooks[r+o]={expand:function(e){for(var t=0,n={},i="string"==typeof e?e.split(" "):[e];t<4;t++)n[r+U[t]+o]=i[t]||i[t-2]||i[0];return n}},ye.test(r)||(k.cssHooks[r+o].set=Ne)}),k.fn.extend({css:function(e,t){return L(this,function(e,t,n){var i,r,o={},a=0;if(k.isArray(t)){for(i=we(e),r=t.length;a<r;a++)o[t[a]]=k.css(e,t[a],!1,i);return o}return void 0!==n?k.style(e,t,n):k.css(e,t)},e,t,1<arguments.length)},show:function(){return Ie(this,!0)},hide:function(){return Ie(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){W(this)?k(this).show():k(this).hide()})}}),((k.Tween=Re).prototype={constructor:Re,init:function(e,t,n,i,r,o){this.elem=e,this.prop=n,this.easing=r||"swing",this.options=t,this.start=this.now=this.cur(),this.end=i,this.unit=o||(k.cssNumber[n]?"":"px")},cur:function(){var e=Re.propHooks[this.prop];return e&&e.get?e.get(this):Re.propHooks._default.get(this)},run:function(e){var t,n=Re.propHooks[this.prop];return this.pos=t=this.options.duration?k.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):Re.propHooks._default.set(this),this}}).init.prototype=Re.prototype,(Re.propHooks={_default:{get:function(e){var t;return null==e.elem[e.prop]||e.elem.style&&null!=e.elem.style[e.prop]?(t=k.css(e.elem,e.prop,""))&&"auto"!==t?t:0:e.elem[e.prop]},set:function(e){k.fx.step[e.prop]?k.fx.step[e.prop](e):e.elem.style&&(null!=e.elem.style[k.cssProps[e.prop]]||k.cssHooks[e.prop])?k.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}}).scrollTop=Re.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},k.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},k.fx=Re.prototype.init,k.fx.step={};var Pe,De,Oe,Be,je,$e=/^(?:toggle|show|hide)$/,He=new RegExp("^(?:([+-])=|)("+H+")([a-z%]*)$","i"),Ue=/queueHooks$/,We=[function(t,e,n){var i,r,o,a,s,l,c,d=this,u={},p=t.style,h=t.nodeType&&W(t),f=R.get(t,"fxshow");for(i in n.queue||(null==(s=k._queueHooks(t,"fx")).unqueued&&(s.unqueued=0,l=s.empty.fire,s.empty.fire=function(){s.unqueued||l()}),s.unqueued++,d.always(function(){d.always(function(){s.unqueued--,k.queue(t,"fx").length||s.empty.fire()})})),1===t.nodeType&&("height"in e||"width"in e)&&(n.overflow=[p.overflow,p.overflowX,p.overflowY],c=k.css(t,"display"),"inline"===("none"===c?R.get(t,"olddisplay")||ve(t.nodeName):c)&&"none"===k.css(t,"float")&&(p.display="inline-block")),n.overflow&&(p.overflow="hidden",d.always(function(){p.overflow=n.overflow[0],p.overflowX=n.overflow[1],p.overflowY=n.overflow[2]})),e)if(r=e[i],$e.exec(r)){if(delete e[i],o=o||"toggle"===r,r===(h?"hide":"show")){if("show"!==r||!f||void 0===f[i])continue;h=!0}u[i]=f&&f[i]||k.style(t,i)}else c=void 0;if(k.isEmptyObject(u))"inline"===("none"===c?ve(t.nodeName):c)&&(p.display=c);else for(i in f?"hidden"in f&&(h=f.hidden):f=R.access(t,"fxshow",{}),o&&(f.hidden=!h),h?k(t).show():d.done(function(){k(t).hide()}),d.done(function(){var e;for(e in R.remove(t,"fxshow"),u)k.style(t,e,u[e])}),u)a=Ke(h?f[i]:0,i,d),i in f||(f[i]=a.start,h&&(a.end=a.start,a.start="width"===i||"height"===i?1:0))}],qe={"*":[function(e,t){var n=this.createTween(e,t),i=n.cur(),r=He.exec(t),o=r&&r[3]||(k.cssNumber[e]?"":"px"),a=(k.cssNumber[e]||"px"!==o&&+i)&&He.exec(k.css(n.elem,e)),s=1,l=20;if(a&&a[3]!==o)for(o=o||a[3],r=r||[],a=+i||1;a/=s=s||".5",k.style(n.elem,e,a+o),s!==(s=n.cur()/i)&&1!==s&&--l;);return r&&(a=n.start=+a||+i||0,n.unit=o,n.end=r[1]?a+(r[1]+1)*r[2]:+r[2]),n}]};function ze(){return setTimeout(function(){Pe=void 0}),Pe=k.now()}function Ve(e,t){var n,i=0,r={height:e};for(t=t?1:0;i<4;i+=2-t)r["margin"+(n=U[i])]=r["padding"+n]=e;return t&&(r.opacity=r.width=e),r}function Ke(e,t,n){for(var i,r=(qe[t]||[]).concat(qe["*"]),o=0,a=r.length;o<a;o++)if(i=r[o].call(n,t,e))return i}function Ye(o,e,t){var n,a,i=0,r=We.length,s=k.Deferred().always(function(){delete l.elem}),l=function(){if(a)return!1;for(var e=Pe||ze(),t=Math.max(0,c.startTime+c.duration-e),n=1-(t/c.duration||0),i=0,r=c.tweens.length;i<r;i++)c.tweens[i].run(n);return s.notifyWith(o,[c,n,t]),n<1&&r?t:(s.resolveWith(o,[c]),!1)},c=s.promise({elem:o,props:k.extend({},e),opts:k.extend(!0,{specialEasing:{}},t),originalProperties:e,originalOptions:t,startTime:Pe||ze(),duration:t.duration,tweens:[],createTween:function(e,t){var n=k.Tween(o,c.opts,e,t,c.opts.specialEasing[e]||c.opts.easing);return c.tweens.push(n),n},stop:function(e){var t=0,n=e?c.tweens.length:0;if(a)return this;for(a=!0;t<n;t++)c.tweens[t].run(1);return e?s.resolveWith(o,[c,e]):s.rejectWith(o,[c,e]),this}}),d=c.props;for(function(e,t){var n,i,r,o,a;for(n in e)if(r=t[i=k.camelCase(n)],o=e[n],k.isArray(o)&&(r=o[1],o=e[n]=o[0]),n!==i&&(e[i]=o,delete e[n]),(a=k.cssHooks[i])&&"expand"in a)for(n in o=a.expand(o),delete e[i],o)n in e||(e[n]=o[n],t[n]=r);else t[i]=r}(d,c.opts.specialEasing);i<r;i++)if(n=We[i].call(c,o,d,c.opts))return n;return k.map(d,Ke,c),k.isFunction(c.opts.start)&&c.opts.start.call(o,c),k.fx.timer(k.extend(l,{elem:o,anim:c,queue:c.opts.queue})),c.progress(c.opts.progress).done(c.opts.done,c.opts.complete).fail(c.opts.fail).always(c.opts.always)}k.Animation=k.extend(Ye,{tweener:function(e,t){k.isFunction(e)?(t=e,e=["*"]):e=e.split(" ");for(var n,i=0,r=e.length;i<r;i++)n=e[i],qe[n]=qe[n]||[],qe[n].unshift(t)},prefilter:function(e,t){t?We.unshift(e):We.push(e)}}),k.speed=function(e,t,n){var i=e&&"object"==typeof e?k.extend({},e):{complete:n||!n&&t||k.isFunction(e)&&e,duration:e,easing:n&&t||t&&!k.isFunction(t)&&t};return i.duration=k.fx.off?0:"number"==typeof i.duration?i.duration:i.duration in k.fx.speeds?k.fx.speeds[i.duration]:k.fx.speeds._default,(null==i.queue||!0===i.queue)&&(i.queue="fx"),i.old=i.complete,i.complete=function(){k.isFunction(i.old)&&i.old.call(this),i.queue&&k.dequeue(this,i.queue)},i},k.fn.extend({fadeTo:function(e,t,n,i){return this.filter(W).css("opacity",0).show().end().animate({opacity:t},e,n,i)},animate:function(t,e,n,i){var r=k.isEmptyObject(t),o=k.speed(e,n,i),a=function(){var e=Ye(this,k.extend({},t),o);(r||R.get(this,"finish"))&&e.stop(!0)};return a.finish=a,r||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(r,e,o){var a=function(e){var t=e.stop;delete e.stop,t(o)};return"string"!=typeof r&&(o=e,e=r,r=void 0),e&&!1!==r&&this.queue(r||"fx",[]),this.each(function(){var e=!0,t=null!=r&&r+"queueHooks",n=k.timers,i=R.get(this);if(t)i[t]&&i[t].stop&&a(i[t]);else for(t in i)i[t]&&i[t].stop&&Ue.test(t)&&a(i[t]);for(t=n.length;t--;)n[t].elem!==this||null!=r&&n[t].queue!==r||(n[t].anim.stop(o),e=!1,n.splice(t,1));(e||!o)&&k.dequeue(this,r)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=R.get(this),n=t[a+"queue"],i=t[a+"queueHooks"],r=k.timers,o=n?n.length:0;for(t.finish=!0,k.queue(this,a,[]),i&&i.stop&&i.stop.call(this,!0),e=r.length;e--;)r[e].elem===this&&r[e].queue===a&&(r[e].anim.stop(!0),r.splice(e,1));for(e=0;e<o;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete t.finish})}}),k.each(["toggle","show","hide"],function(e,i){var r=k.fn[i];k.fn[i]=function(e,t,n){return null==e||"boolean"==typeof e?r.apply(this,arguments):this.animate(Ve(i,!0),e,t,n)}}),k.each({slideDown:Ve("show"),slideUp:Ve("hide"),slideToggle:Ve("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,i){k.fn[e]=function(e,t,n){return this.animate(i,e,t,n)}}),k.timers=[],k.fx.tick=function(){var e,t=0,n=k.timers;for(Pe=k.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||k.fx.stop(),Pe=void 0},k.fx.timer=function(e){k.timers.push(e),e()?k.fx.start():k.timers.pop()},k.fx.interval=13,k.fx.start=function(){De||(De=setInterval(k.fx.tick,k.fx.interval))},k.fx.stop=function(){clearInterval(De),De=null},k.fx.speeds={slow:600,fast:200,_default:400},k.fn.delay=function(i,e){return i=k.fx&&k.fx.speeds[i]||i,e=e||"fx",this.queue(e,function(e,t){var n=setTimeout(e,i);t.stop=function(){clearTimeout(n)}})},Oe=y.createElement("input"),Be=y.createElement("select"),je=Be.appendChild(y.createElement("option")),Oe.type="checkbox",v.checkOn=""!==Oe.value,v.optSelected=je.selected,Be.disabled=!0,v.optDisabled=!je.disabled,(Oe=y.createElement("input")).value="t",Oe.type="radio",v.radioValue="t"===Oe.value;var Je,Qe=k.expr.attrHandle;k.fn.extend({attr:function(e,t){return L(this,k.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){k.removeAttr(this,e)})}}),k.extend({attr:function(e,t,n){var i,r,o=e.nodeType;if(e&&3!==o&&8!==o&&2!==o)return typeof e.getAttribute===z?k.prop(e,t,n):(1===o&&k.isXMLDoc(e)||(t=t.toLowerCase(),i=k.attrHooks[t]||(k.expr.match.bool.test(t)?Je:void 0)),void 0===n?i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=k.find.attr(e,t))?void 0:r:null!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):void k.removeAttr(e,t))},removeAttr:function(e,t){var n,i,r=0,o=t&&t.match(M);if(o&&1===e.nodeType)for(;n=o[r++];)i=k.propFix[n]||n,k.expr.match.bool.test(n)&&(e[i]=!1),e.removeAttribute(n)},attrHooks:{type:{set:function(e,t){if(!v.radioValue&&"radio"===t&&k.nodeName(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}}}),Je={set:function(e,t,n){return!1===t?k.removeAttr(e,n):e.setAttribute(n,n),n}},k.each(k.expr.match.bool.source.match(/\w+/g),function(e,t){var o=Qe[t]||k.find.attr;Qe[t]=function(e,t,n){var i,r;return n||(r=Qe[t],Qe[t]=i,i=null!=o(e,t,n)?t.toLowerCase():null,Qe[t]=r),i}});var Ge=/^(?:input|select|textarea|button)$/i;k.fn.extend({prop:function(e,t){return L(this,k.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[k.propFix[e]||e]})}}),k.extend({propFix:{for:"htmlFor",class:"className"},prop:function(e,t,n){var i,r,o=e.nodeType;if(e&&3!==o&&8!==o&&2!==o)return(1!==o||!k.isXMLDoc(e))&&(t=k.propFix[t]||t,r=k.propHooks[t]),void 0!==n?r&&"set"in r&&void 0!==(i=r.set(e,n,t))?i:e[t]=n:r&&"get"in r&&null!==(i=r.get(e,t))?i:e[t]},propHooks:{tabIndex:{get:function(e){return e.hasAttribute("tabindex")||Ge.test(e.nodeName)||e.href?e.tabIndex:-1}}}}),v.optSelected||(k.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null}}),k.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){k.propFix[this.toLowerCase()]=this});var Xe=/[\t\r\n\f]/g;k.fn.extend({addClass:function(t){var e,n,i,r,o,a,s="string"==typeof t&&t,l=0,c=this.length;if(k.isFunction(t))return this.each(function(e){k(this).addClass(t.call(this,e,this.className))});if(s)for(e=(t||"").match(M)||[];l<c;l++)if(i=1===(n=this[l]).nodeType&&(n.className?(" "+n.className+" ").replace(Xe," "):" ")){for(o=0;r=e[o++];)i.indexOf(" "+r+" ")<0&&(i+=r+" ");a=k.trim(i),n.className!==a&&(n.className=a)}return this},removeClass:function(t){var e,n,i,r,o,a,s=0===arguments.length||"string"==typeof t&&t,l=0,c=this.length;if(k.isFunction(t))return this.each(function(e){k(this).removeClass(t.call(this,e,this.className))});if(s)for(e=(t||"").match(M)||[];l<c;l++)if(i=1===(n=this[l]).nodeType&&(n.className?(" "+n.className+" ").replace(Xe," "):"")){for(o=0;r=e[o++];)for(;0<=i.indexOf(" "+r+" ");)i=i.replace(" "+r+" "," ");a=t?k.trim(i):"",n.className!==a&&(n.className=a)}return this},toggleClass:function(r,t){var o=typeof r;return"boolean"==typeof t&&"string"===o?t?this.addClass(r):this.removeClass(r):this.each(k.isFunction(r)?function(e){k(this).toggleClass(r.call(this,e,this.className,t),t)}:function(){if("string"===o)for(var e,t=0,n=k(this),i=r.match(M)||[];e=i[t++];)n.hasClass(e)?n.removeClass(e):n.addClass(e);else(o===z||"boolean"===o)&&(this.className&&R.set(this,"__className__",this.className),this.className=this.className||!1===r?"":R.get(this,"__className__")||"")})},hasClass:function(e){for(var t=" "+e+" ",n=0,i=this.length;n<i;n++)if(1===this[n].nodeType&&0<=(" "+this[n].className+" ").replace(Xe," ").indexOf(t))return!0;return!1}});var Ze=/\r/g;k.fn.extend({val:function(n){var i,e,r,t=this[0];return arguments.length?(r=k.isFunction(n),this.each(function(e){var t;1===this.nodeType&&(null==(t=r?n.call(this,e,k(this).val()):n)?t="":"number"==typeof t?t+="":k.isArray(t)&&(t=k.map(t,function(e){return null==e?"":e+""})),(i=k.valHooks[this.type]||k.valHooks[this.nodeName.toLowerCase()])&&"set"in i&&void 0!==i.set(this,t,"value")||(this.value=t))})):t?(i=k.valHooks[t.type]||k.valHooks[t.nodeName.toLowerCase()])&&"get"in i&&void 0!==(e=i.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(Ze,""):null==e?"":e:void 0}}),k.extend({valHooks:{option:{get:function(e){var t=k.find.attr(e,"value");return null!=t?t:k.trim(k.text(e))}},select:{get:function(e){for(var t,n,i=e.options,r=e.selectedIndex,o="select-one"===e.type||r<0,a=o?null:[],s=o?r+1:i.length,l=r<0?s:o?r:0;l<s;l++)if(!(!(n=i[l]).selected&&l!==r||(v.optDisabled?n.disabled:null!==n.getAttribute("disabled"))||n.parentNode.disabled&&k.nodeName(n.parentNode,"optgroup"))){if(t=k(n).val(),o)return t;a.push(t)}return a},set:function(e,t){for(var n,i,r=e.options,o=k.makeArray(t),a=r.length;a--;)((i=r[a]).selected=0<=k.inArray(i.value,o))&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),k.each(["radio","checkbox"],function(){k.valHooks[this]={set:function(e,t){return k.isArray(t)?e.checked=0<=k.inArray(k(e).val(),t):void 0}},v.checkOn||(k.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})}),k.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,n){k.fn[n]=function(e,t){return 0<arguments.length?this.on(n,null,e,t):this.trigger(n)}}),k.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)},bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,i){return this.on(t,e,n,i)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)}});var et=k.now(),tt=/\?/;k.parseJSON=function(e){return JSON.parse(e+"")},k.parseXML=function(e){var t;if(!e||"string"!=typeof e)return null;try{t=(new DOMParser).parseFromString(e,"text/xml")}catch(e){t=void 0}return(!t||t.getElementsByTagName("parsererror").length)&&k.error("Invalid XML: "+e),t};var nt,it,rt=/#.*$/,ot=/([?&])_=[^&]*/,at=/^(.*?):[ \t]*([^\r\n]*)$/gm,st=/^(?:GET|HEAD)$/,lt=/^\/\//,ct=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,dt={},ut={},pt="*/".concat("*");try{it=location.href}catch(e){(it=y.createElement("a")).href="",it=it.href}function ht(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var n,i=0,r=e.toLowerCase().match(M)||[];if(k.isFunction(t))for(;n=r[i++];)"+"===n[0]?(n=n.slice(1)||"*",(o[n]=o[n]||[]).unshift(t)):(o[n]=o[n]||[]).push(t)}}function ft(t,r,o,a){var s={},l=t===ut;function c(e){var i;return s[e]=!0,k.each(t[e]||[],function(e,t){var n=t(r,o,a);return"string"!=typeof n||l||s[n]?l?!(i=n):void 0:(r.dataTypes.unshift(n),c(n),!1)}),i}return c(r.dataTypes[0])||!s["*"]&&c("*")}function gt(e,t){var n,i,r=k.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((r[n]?e:i||(i={}))[n]=t[n]);return i&&k.extend(!0,e,i),e}nt=ct.exec(it.toLowerCase())||[],k.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:it,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(nt[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":pt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":k.parseJSON,"text xml":k.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?gt(gt(e,k.ajaxSettings),t):gt(k.ajaxSettings,e)},ajaxPrefilter:ht(dt),ajaxTransport:ht(ut),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var d,u,p,n,h,i,f,r,g=k.ajaxSetup({},t),m=g.context||g,v=g.context&&(m.nodeType||m.jquery)?k(m):k.event,y=k.Deferred(),b=k.Callbacks("once memory"),w=g.statusCode||{},o={},a={},x=0,s="canceled",C={readyState:0,getResponseHeader:function(e){var t;if(2===x){if(!n)for(n={};t=at.exec(p);)n[t[1].toLowerCase()]=t[2];t=n[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===x?p:null},setRequestHeader:function(e,t){var n=e.toLowerCase();return x||(e=a[n]=a[n]||e,o[e]=t),this},overrideMimeType:function(e){return x||(g.mimeType=e),this},statusCode:function(e){var t;if(e)if(x<2)for(t in e)w[t]=[w[t],e[t]];else C.always(e[C.status]);return this},abort:function(e){var t=e||s;return d&&d.abort(t),l(0,t),this}};if(y.promise(C).complete=b.add,C.success=C.done,C.error=C.fail,g.url=((e||g.url||it)+"").replace(rt,"").replace(lt,nt[1]+"//"),g.type=t.method||t.type||g.method||g.type,g.dataTypes=k.trim(g.dataType||"*").toLowerCase().match(M)||[""],null==g.crossDomain&&(i=ct.exec(g.url.toLowerCase()),g.crossDomain=!(!i||i[1]===nt[1]&&i[2]===nt[2]&&(i[3]||("http:"===i[1]?"80":"443"))===(nt[3]||("http:"===nt[1]?"80":"443")))),g.data&&g.processData&&"string"!=typeof g.data&&(g.data=k.param(g.data,g.traditional)),ft(dt,g,t,C),2===x)return C;for(r in(f=g.global)&&0==k.active++&&k.event.trigger("ajaxStart"),g.type=g.type.toUpperCase(),g.hasContent=!st.test(g.type),u=g.url,g.hasContent||(g.data&&(u=g.url+=(tt.test(u)?"&":"?")+g.data,delete g.data),!1===g.cache&&(g.url=ot.test(u)?u.replace(ot,"$1_="+et++):u+(tt.test(u)?"&":"?")+"_="+et++)),g.ifModified&&(k.lastModified[u]&&C.setRequestHeader("If-Modified-Since",k.lastModified[u]),k.etag[u]&&C.setRequestHeader("If-None-Match",k.etag[u])),(g.data&&g.hasContent&&!1!==g.contentType||t.contentType)&&C.setRequestHeader("Content-Type",g.contentType),C.setRequestHeader("Accept",g.dataTypes[0]&&g.accepts[g.dataTypes[0]]?g.accepts[g.dataTypes[0]]+("*"!==g.dataTypes[0]?", "+pt+"; q=0.01":""):g.accepts["*"]),g.headers)C.setRequestHeader(r,g.headers[r]);if(g.beforeSend&&(!1===g.beforeSend.call(m,C,g)||2===x))return C.abort();for(r in s="abort",{success:1,error:1,complete:1})C[r](g[r]);if(d=ft(ut,g,t,C)){C.readyState=1,f&&v.trigger("ajaxSend",[C,g]),g.async&&0<g.timeout&&(h=setTimeout(function(){C.abort("timeout")},g.timeout));try{x=1,d.send(o,l)}catch(e){if(!(x<2))throw e;l(-1,e)}}else l(-1,"No Transport");function l(e,t,n,i){var r,o,a,s,l,c=t;2!==x&&(x=2,h&&clearTimeout(h),d=void 0,p=i||"",C.readyState=0<e?4:0,r=200<=e&&e<300||304===e,n&&(s=function(e,t,n){for(var i,r,o,a,s=e.contents,l=e.dataTypes;"*"===l[0];)l.shift(),void 0===i&&(i=e.mimeType||t.getResponseHeader("Content-Type"));if(i)for(r in s)if(s[r]&&s[r].test(i)){l.unshift(r);break}if(l[0]in n)o=l[0];else{for(r in n){if(!l[0]||e.converters[r+" "+l[0]]){o=r;break}a||(a=r)}o=o||a}return o?(o!==l[0]&&l.unshift(o),n[o]):void 0}(g,C,n)),s=function(e,t,n,i){var r,o,a,s,l,c={},d=e.dataTypes.slice();if(d[1])for(a in e.converters)c[a.toLowerCase()]=e.converters[a];for(o=d.shift();o;)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!l&&i&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),l=o,o=d.shift())if("*"===o)o=l;else if("*"!==l&&l!==o){if(!(a=c[l+" "+o]||c["* "+o]))for(r in c)if((s=r.split(" "))[1]===o&&(a=c[l+" "+s[0]]||c["* "+s[0]])){!0===a?a=c[r]:!0!==c[r]&&(o=s[0],d.unshift(s[1]));break}if(!0!==a)if(a&&e.throws)t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+l+" to "+o}}}return{state:"success",data:t}}(g,s,C,r),r?(g.ifModified&&((l=C.getResponseHeader("Last-Modified"))&&(k.lastModified[u]=l),(l=C.getResponseHeader("etag"))&&(k.etag[u]=l)),204===e||"HEAD"===g.type?c="nocontent":304===e?c="notmodified":(c=s.state,o=s.data,r=!(a=s.error))):(a=c,(e||!c)&&(c="error",e<0&&(e=0))),C.status=e,C.statusText=(t||c)+"",r?y.resolveWith(m,[o,c,C]):y.rejectWith(m,[C,c,a]),C.statusCode(w),w=void 0,f&&v.trigger(r?"ajaxSuccess":"ajaxError",[C,g,r?o:a]),b.fireWith(m,[C,c]),f&&(v.trigger("ajaxComplete",[C,g]),--k.active||k.event.trigger("ajaxStop")))}return C},getJSON:function(e,t,n){return k.get(e,t,n,"json")},getScript:function(e,t){return k.get(e,void 0,t,"script")}}),k.each(["get","post"],function(e,r){k[r]=function(e,t,n,i){return k.isFunction(t)&&(i=i||n,n=t,t=void 0),k.ajax({url:e,type:r,dataType:i,data:t,success:n})}}),k.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){k.fn[t]=function(e){return this.on(t,e)}}),k._evalUrl=function(e){return k.ajax({url:e,type:"GET",dataType:"script",async:!1,global:!1,throws:!0})},k.fn.extend({wrapAll:function(t){var e;return k.isFunction(t)?this.each(function(e){k(this).wrapAll(t.call(this,e))}):(this[0]&&(e=k(t,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&e.insertBefore(this[0]),e.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this)},wrapInner:function(n){return this.each(k.isFunction(n)?function(e){k(this).wrapInner(n.call(this,e))}:function(){var e=k(this),t=e.contents();t.length?t.wrapAll(n):e.append(n)})},wrap:function(t){var n=k.isFunction(t);return this.each(function(e){k(this).wrapAll(n?t.call(this,e):t)})},unwrap:function(){return this.parent().each(function(){k.nodeName(this,"body")||k(this).replaceWith(this.childNodes)}).end()}}),k.expr.filters.hidden=function(e){return e.offsetWidth<=0&&e.offsetHeight<=0},k.expr.filters.visible=function(e){return!k.expr.filters.hidden(e)};var mt=/%20/g,vt=/\[\]$/,yt=/\r?\n/g,bt=/^(?:submit|button|image|reset|file)$/i,wt=/^(?:input|select|textarea|keygen)/i;function xt(n,e,i,r){var t;if(k.isArray(e))k.each(e,function(e,t){i||vt.test(n)?r(n,t):xt(n+"["+("object"==typeof t?e:"")+"]",t,i,r)});else if(i||"object"!==k.type(e))r(n,e);else for(t in e)xt(n+"["+t+"]",e[t],i,r)}k.param=function(e,t){var n,i=[],r=function(e,t){t=k.isFunction(t)?t():null==t?"":t,i[i.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(void 0===t&&(t=k.ajaxSettings&&k.ajaxSettings.traditional),k.isArray(e)||e.jquery&&!k.isPlainObject(e))k.each(e,function(){r(this.name,this.value)});else for(n in e)xt(n,e[n],t,r);return i.join("&").replace(mt,"+")},k.fn.extend({serialize:function(){return k.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=k.prop(this,"elements");return e?k.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!k(this).is(":disabled")&&wt.test(this.nodeName)&&!bt.test(e)&&(this.checked||!q.test(e))}).map(function(e,t){var n=k(this).val();return null==n?null:k.isArray(n)?k.map(n,function(e){return{name:t.name,value:e.replace(yt,"\r\n")}}):{name:t.name,value:n.replace(yt,"\r\n")}}).get()}}),k.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(e){}};var Ct=0,kt={},St={0:200,1223:204},Tt=k.ajaxSettings.xhr();f.ActiveXObject&&k(f).on("unload",function(){for(var e in kt)kt[e]()}),v.cors=!!Tt&&"withCredentials"in Tt,v.ajax=Tt=!!Tt,k.ajaxTransport(function(o){var a;return v.cors||Tt&&!o.crossDomain?{send:function(e,t){var n,i=o.xhr(),r=++Ct;if(i.open(o.type,o.url,o.async,o.username,o.password),o.xhrFields)for(n in o.xhrFields)i[n]=o.xhrFields[n];for(n in o.mimeType&&i.overrideMimeType&&i.overrideMimeType(o.mimeType),o.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)i.setRequestHeader(n,e[n]);a=function(e){return function(){a&&(delete kt[r],a=i.onload=i.onerror=null,"abort"===e?i.abort():"error"===e?t(i.status,i.statusText):t(St[i.status]||i.status,i.statusText,"string"==typeof i.responseText?{text:i.responseText}:void 0,i.getAllResponseHeaders()))}},i.onload=a(),i.onerror=a("error"),a=kt[r]=a("abort");try{i.send(o.hasContent&&o.data||null)}catch(e){if(a)throw e}},abort:function(){a&&a()}}:void 0}),k.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(e){return k.globalEval(e),e}}}),k.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),k.ajaxTransport("script",function(n){var i,r;if(n.crossDomain)return{send:function(e,t){i=k("<script>").prop({async:!0,charset:n.scriptCharset,src:n.url}).on("load error",r=function(e){i.remove(),r=null,e&&t("error"===e.type?404:200,e.type)}),y.head.appendChild(i[0])},abort:function(){r&&r()}}});var Ft=[],Et=/(=)\?(?=&|$)|\?\?/;k.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Ft.pop()||k.expando+"_"+et++;return this[e]=!0,e}}),k.ajaxPrefilter("json jsonp",function(e,t,n){var i,r,o,a=!1!==e.jsonp&&(Et.test(e.url)?"url":"string"==typeof e.data&&!(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&Et.test(e.data)&&"data");return a||"jsonp"===e.dataTypes[0]?(i=e.jsonpCallback=k.isFunction(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(Et,"$1"+i):!1!==e.jsonp&&(e.url+=(tt.test(e.url)?"&":"?")+e.jsonp+"="+i),e.converters["script json"]=function(){return o||k.error(i+" was not called"),o[0]},e.dataTypes[0]="json",r=f[i],f[i]=function(){o=arguments},n.always(function(){f[i]=r,e[i]&&(e.jsonpCallback=t.jsonpCallback,Ft.push(i)),o&&k.isFunction(r)&&r(o[0]),o=r=void 0}),"script"):void 0}),k.parseHTML=function(e,t,n){if(!e||"string"!=typeof e)return null;"boolean"==typeof t&&(n=t,t=!1),t=t||y;var i=b.exec(e),r=!n&&[];return i?[t.createElement(i[1])]:(i=k.buildFragment([e],t,r),r&&r.length&&k(r).remove(),k.merge([],i.childNodes))};var _t=k.fn.load;k.fn.load=function(e,t,n){if("string"!=typeof e&&_t)return _t.apply(this,arguments);var i,r,o,a=this,s=e.indexOf(" ");return 0<=s&&(i=k.trim(e.slice(s)),e=e.slice(0,s)),k.isFunction(t)?(n=t,t=void 0):t&&"object"==typeof t&&(r="POST"),0<a.length&&k.ajax({url:e,type:r,dataType:"html",data:t}).done(function(e){o=arguments,a.html(i?k("<div>").append(k.parseHTML(e)).find(i):e)}).complete(n&&function(e,t){a.each(n,o||[e.responseText,t,e])}),this},k.expr.filters.animated=function(t){return k.grep(k.timers,function(e){return t===e.elem}).length};var Mt=f.document.documentElement;function Nt(e){return k.isWindow(e)?e:9===e.nodeType&&e.defaultView}k.offset={setOffset:function(e,t,n){var i,r,o,a,s,l,c=k.css(e,"position"),d=k(e),u={};"static"===c&&(e.style.position="relative"),s=d.offset(),o=k.css(e,"top"),l=k.css(e,"left"),("absolute"===c||"fixed"===c)&&-1<(o+l).indexOf("auto")?(a=(i=d.position()).top,r=i.left):(a=parseFloat(o)||0,r=parseFloat(l)||0),k.isFunction(t)&&(t=t.call(e,n,s)),null!=t.top&&(u.top=t.top-s.top+a),null!=t.left&&(u.left=t.left-s.left+r),"using"in t?t.using.call(e,u):d.css(u)}},k.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){k.offset.setOffset(this,t,e)});var e,n,i=this[0],r={top:0,left:0},o=i&&i.ownerDocument;return o?(e=o.documentElement,k.contains(e,i)?(typeof i.getBoundingClientRect!==z&&(r=i.getBoundingClientRect()),n=Nt(o),{top:r.top+n.pageYOffset-e.clientTop,left:r.left+n.pageXOffset-e.clientLeft}):r):void 0},position:function(){if(this[0]){var e,t,n=this[0],i={top:0,left:0};return"fixed"===k.css(n,"position")?t=n.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),k.nodeName(e[0],"html")||(i=e.offset()),i.top+=k.css(e[0],"borderTopWidth",!0),i.left+=k.css(e[0],"borderLeftWidth",!0)),{top:t.top-i.top-k.css(n,"marginTop",!0),left:t.left-i.left-k.css(n,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent||Mt;e&&!k.nodeName(e,"html")&&"static"===k.css(e,"position");)e=e.offsetParent;return e||Mt})}}),k.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,r){var o="pageYOffset"===r;k.fn[t]=function(e){return L(this,function(e,t,n){var i=Nt(e);return void 0===n?i?i[r]:e[t]:void(i?i.scrollTo(o?f.pageXOffset:n,o?n:f.pageYOffset):e[t]=n)},t,e,arguments.length,null)}}),k.each(["top","left"],function(e,n){k.cssHooks[n]=Ce(v.pixelPosition,function(e,t){return t?(t=xe(e,n),be.test(t)?k(e).position()[n]+"px":t):void 0})}),k.each({Height:"height",Width:"width"},function(o,a){k.each({padding:"inner"+o,content:a,"":"outer"+o},function(i,e){k.fn[e]=function(e,t){var n=arguments.length&&(i||"boolean"!=typeof e),r=i||(!0===e||!0===t?"margin":"border");return L(this,function(e,t,n){var i;return k.isWindow(e)?e.document.documentElement["client"+o]:9===e.nodeType?(i=e.documentElement,Math.max(e.body["scroll"+o],i["scroll"+o],e.body["offset"+o],i["offset"+o],i["client"+o])):void 0===n?k.css(e,t,r):k.style(e,t,n,r)},a,n?e:void 0,n,null)}})}),k.fn.size=function(){return this.length},k.fn.andSelf=k.fn.addBack,"function"==typeof define&&define.amd&&define("jquery/jquery",[],function(){return k});var At=f.jQuery,Lt=f.$;return k.noConflict=function(e){return f.$===k&&(f.$=Lt),e&&f.jQuery===k&&(f.jQuery=At),k},typeof e===z&&(f.jQuery=f.$=k),k},"object"==typeof n&&"object"==typeof n.exports?n.exports=i.document?r(i,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return r(e)}:r(i)}),define("jquery-localize-master/dist/jquery.localize.js",[],function(e,t,n){var w,x,i=e("jquery/jquery");x=function(e){return e},(w=i).defaultLanguage=x(navigator.languages&&0<navigator.languages.length?navigator.languages[0]:navigator.language||navigator.userLanguage),w.localize=function(e,s){var t,i,r,l,o,n,c,a,d,u,p,h,f,g,m,v,y,b;return null==s&&(s={}),b=this,l={},r=s.fileExtension||"json",i=w.Deferred(),c=function(e,t,n){switch(null==n&&(n=1),n){case 1:return l={},o(t+".lproj/"+e+"."+r,e,t,n);default:return i.resolve()}},o=function(e,t,n,i){var r,o,a;return null!=s.pathPrefix&&(e=s.pathPrefix+"/"+e),a=function(e){return w.extend(l,e),f(l),c(t,n,i+1)},o=function(){return 2===i&&-1<n.indexOf("-")?c(t,n,i+1):s.fallback&&s.fallback!==n?c(t,s.fallback):void 0},w.localize.data[t]?a(w.localize.data[t]):(r={url:e,dataType:"json",async:!0,timeout:null!=s.timeout?s.timeout:500,success:a,error:o},"file:"===window.location.protocol&&(r.error=function(e){return a(e.responseText?w.parseJSON(e.responseText):{})}),w.ajax(r))},f=function(e){return null!=s.callback?s.callback(e,t):t(e)},t=function(i){return w.localize.data[e]=i,b.each(function(){var e,t,n;if(t=((e=w(this)).data("localize")||e.data("afterContent")||e.attr("ty-hint")||"").replace(/\\n/g,"\n"),n=y(t,i))return a(e,t,n)})},a=function(e,t,n){if(e.is("input"))p(e,t,n);else if(e.is("textarea"))p(e,t,n);else if(e.is("img"))u(e,t,n);else if(e.is("optgroup"))h(e,t,n);else if(e[0].hasAttribute("data-after-content"))e.attr("data-after-content",n);else if(e[0].hasAttribute("ty-hint"))e.attr("ty-hint",n).attr("aria-label",n);else if(e[0].hasAttribute("data-lt"))e.html(n);else{if(w.isPlainObject(n))return d(e,n);e.text(n)}},p=function(e,t,n){var i;if(i=w.isPlainObject(n)?n.value:n,e.is("[placeholder]"))return e.attr("placeholder",i)},d=function(e,t){return m(e,"title",t),v(e,"text",t)},h=function(e,t,n){return e.attr("label",n)},u=function(e,t,n){return m(e,"alt",n),m(e,"src",n)},y=function(e,t){return t[e]||e},m=function(e,t,n){if(null!=(n=y(t,n)))return e.attr(t,n)},v=function(e,t,n){if(null!=(n=y(t,n)))return e.text(n)},g=function(i){var r;return"string"==typeof i?"^"+i+"$":null!=i.length?function(){var e,t,n;for(n=[],e=0,t=i.length;e<t;e++)r=i[e],n.push(g(r));return n}().join("|"):i},n=x(s.language?s.language:w.defaultLanguage),s.skipLanguage&&n.match(g(s.skipLanguage))?i.resolve():c(e,n,1),b.localizePromise=i,b},w.fn.localize=w.localize,w.localize.getString=function(e,t){return(w.localize.data[t||"Front"]||{})[e]||e},w.localize.data={}}),define("bootstrape/js/bootstrap",[],function(e,t,n){"use strict";if(window.jQuery||(window.$=e("$"),window.jQuery=window.$),"undefined"==typeof jQuery)throw new Error("Bootstrap's JavaScript requires jQuery");var i;!function(o){var t='[data-dismiss="alert"]',i=function(e){o(e).on("click",t,this.close)};i.VERSION="3.2.0",i.prototype.close=function(e){var t=o(this),n=t.attr("data-target");n||(n=(n=t.attr("href"))&&n.replace(/.*(?=#[^\s]*$)/,""));var i=o(n);function r(){i.detach().trigger("closed.bs.alert").remove()}e&&e.preventDefault(),i.length||(i=t.hasClass("alert")?t:t.parent()),i.trigger(e=o.Event("close.bs.alert")),e.isDefaultPrevented()||(i.removeClass("in"),o.support.transition&&i.hasClass("fade")?i.one("bsTransitionEnd",r).emulateTransitionEnd(150):r())};var e=o.fn.alert;o.fn.alert=function(n){return this.each(function(){var e=o(this),t=e.data("bs.alert");t||e.data("bs.alert",t=new i(this)),"string"==typeof n&&t[n].call(e)})},o.fn.alert.Constructor=i,o.fn.alert.noConflict=function(){return o.fn.alert=e,this},o(document).on("click.bs.alert.data-api",t,i.prototype.close)}(jQuery),function(o){var r=function(e,t){this.$element=o(e),this.options=o.extend({},r.DEFAULTS,t),this.isLoading=!1};function n(i){return this.each(function(){var e=o(this),t=e.data("bs.button"),n="object"==typeof i&&i;t||e.data("bs.button",t=new r(this,n)),"toggle"==i?t.toggle():i&&t.setState(i)})}r.VERSION="3.2.0",r.DEFAULTS={loadingText:"loading..."},r.prototype.setState=function(e){var t="disabled",n=this.$element,i=n.is("input")?"val":"html",r=n.data();e+="Text",null==r.resetText&&n.data("resetText",n[i]()),n[i](null==r[e]?this.options[e]:r[e]),setTimeout(o.proxy(function(){"loadingText"==e?(this.isLoading=!0,n.addClass(t).attr(t,t)):this.isLoading&&(this.isLoading=!1,n.removeClass(t).removeAttr(t))},this),0)},r.prototype.toggle=function(){var e=!0,t=this.$element.closest('[data-toggle="buttons"]');if(t.length){var n=this.$element.find("input");"radio"==n.prop("type")&&(n.prop("checked")&&this.$element.hasClass("active")?e=!1:t.find(".active").removeClass("active")),e&&n.prop("checked",!this.$element.hasClass("active")).trigger("change")}e&&this.$element.toggleClass("active")};var e=o.fn.button;o.fn.button=n,o.fn.button.Constructor=r,o.fn.button.noConflict=function(){return o.fn.button=e,this},o(document).on("click.bs.button.data-api",'[data-toggle^="button"]',function(e){var t=o(e.target);t.hasClass("btn")||(t=t.closest(".btn")),n.call(t,"toggle"),e.preventDefault()})}(jQuery),function(p){var o=function(e,t){this.$element=p(e).on("keydown.bs.carousel",p.proxy(this.keydown,this)),this.$indicators=this.$element.find(".carousel-indicators"),this.options=t,this.paused=this.sliding=this.interval=this.$active=this.$items=null,"hover"==this.options.pause&&this.$element.on("mouseenter.bs.carousel",p.proxy(this.pause,this)).on("mouseleave.bs.carousel",p.proxy(this.cycle,this))};function a(r){return this.each(function(){var e=p(this),t=e.data("bs.carousel"),n=p.extend({},o.DEFAULTS,e.data(),"object"==typeof r&&r),i="string"==typeof r?r:n.slide;t||e.data("bs.carousel",t=new o(this,n)),"number"==typeof r?t.to(r):i?t[i]():n.interval&&t.pause().cycle()})}o.VERSION="3.2.0",o.DEFAULTS={interval:5e3,pause:"hover",wrap:!0},o.prototype.keydown=function(e){switch(e.which){case 37:this.prev();break;case 39:this.next();break;default:return}e.preventDefault()},o.prototype.cycle=function(e){return e||(this.paused=!1),this.interval&&clearInterval(this.interval),this.options.interval&&!this.paused&&(this.interval=setInterval(p.proxy(this.next,this),this.options.interval)),this},o.prototype.getItemIndex=function(e){return this.$items=e.parent().children(".item"),this.$items.index(e||this.$active)},o.prototype.to=function(e){var t=this,n=this.getItemIndex(this.$active=this.$element.find(".item.active"));if(!(e>this.$items.length-1||e<0))return this.sliding?this.$element.one("slid.bs.carousel",function(){t.to(e)}):n==e?this.pause().cycle():this.slide(n<e?"next":"prev",p(this.$items[e]))},o.prototype.pause=function(e){return e||(this.paused=!0),this.$element.find(".next, .prev").length&&p.support.transition&&(this.$element.trigger(p.support.transition.end),this.cycle(!0)),this.interval=clearInterval(this.interval),this},o.prototype.next=function(){if(!this.sliding)return this.slide("next")},o.prototype.prev=function(){if(!this.sliding)return this.slide("prev")},o.prototype.slide=function(e,t){var n=this.$element.find(".item.active"),i=t||n[e](),r=this.interval,o="next"==e?"left":"right",a="next"==e?"first":"last",s=this;if(!i.length){if(!this.options.wrap)return;i=this.$element.find(".item")[a]()}if(i.hasClass("active"))return this.sliding=!1;var l=i[0],c=p.Event("slide.bs.carousel",{relatedTarget:l,direction:o});if(this.$element.trigger(c),!c.isDefaultPrevented()){if(this.sliding=!0,r&&this.pause(),this.$indicators.length){this.$indicators.find(".active").removeClass("active");var d=p(this.$indicators.children()[this.getItemIndex(i)]);d&&d.addClass("active")}var u=p.Event("slid.bs.carousel",{relatedTarget:l,direction:o});return p.support.transition&&this.$element.hasClass("slide")?(i.addClass(e),i[0].offsetWidth,n.addClass(o),i.addClass(o),n.one("bsTransitionEnd",function(){i.removeClass([e,o].join(" ")).addClass("active"),n.removeClass(["active",o].join(" ")),s.sliding=!1,setTimeout(function(){s.$element.trigger(u)},0)}).emulateTransitionEnd(1e3*n.css("transition-duration").slice(0,-1))):(n.removeClass("active"),i.addClass("active"),this.sliding=!1,this.$element.trigger(u)),r&&this.cycle(),this}};var e=p.fn.carousel;p.fn.carousel=a,p.fn.carousel.Constructor=o,p.fn.carousel.noConflict=function(){return p.fn.carousel=e,this},p(document).on("click.bs.carousel.data-api","[data-slide], [data-slide-to]",function(e){var t,n=p(this),i=p(n.attr("data-target")||(t=n.attr("href"))&&t.replace(/.*(?=#[^\s]+$)/,""));if(i.hasClass("carousel")){var r=p.extend({},i.data(),n.data()),o=n.attr("data-slide-to");o&&(r.interval=!1),a.call(i,r),o&&i.data("bs.carousel").to(o),e.preventDefault()}}),p(window).on("load",function(){p('[data-ride="carousel"]').each(function(){var e=p(this);a.call(e,e.data())})})}(jQuery),function(s){var e=".dropdown-backdrop",l='[data-toggle="dropdown"]',i=function(e){s(e).on("click.bs.dropdown",this.toggle)};function o(n){n&&3===n.which||(s(e).remove(),s(l).each(function(){var e=c(s(this)),t={relatedTarget:this};e.hasClass("open")&&(e.trigger(n=s.Event("hide.bs.dropdown",t)),n.isDefaultPrevented()||e.removeClass("open").trigger("hidden.bs.dropdown",t))}))}function c(e){var t=e.attr("data-target");t||(t=(t=e.attr("href"))&&/#[A-Za-z]/.test(t)&&t.replace(/.*(?=#[^\s]*$)/,""));var n=t&&s(t);return n&&n.length?n:e.parent()}i.VERSION="3.2.0",i.prototype.toggle=function(e){var t=s(this);if(!t.is(".disabled, :disabled")){var n=c(t),i=n.hasClass("open");if(o(),!i){"ontouchstart"in document.documentElement&&!n.closest(".navbar-nav").length&&s('<div class="dropdown-backdrop"/>').insertAfter(s(this)).on("click",o);var r={relatedTarget:this};if(n.trigger(e=s.Event("show.bs.dropdown",r)),e.isDefaultPrevented())return;t.trigger("focus"),n.toggleClass("open").trigger("shown.bs.dropdown",r)}return!1}},i.prototype.keydown=function(e){if(/(38|40|27)/.test(e.keyCode)){var t=s(this);if(e.preventDefault(),e.stopPropagation(),!t.is(".disabled, :disabled")){var n=c(t),i=n.hasClass("open");if(!i||i&&27==e.keyCode)return 27==e.which&&n.find(l).trigger("focus"),t.trigger("click");var r=" li:not(.divider):visible a",o=n.find('[role="menu"]'+r+', [role="listbox"]'+r);if(o.length){var a=o.index(o.filter(":focus"));38==e.keyCode&&0<a&&a--,40==e.keyCode&&a<o.length-1&&a++,~a||(a=0),o.eq(a).trigger("focus")}}}};var t=s.fn.dropdown;s.fn.dropdown=function(n){return this.each(function(){var e=s(this),t=e.data("bs.dropdown");t||e.data("bs.dropdown",t=new i(this)),"string"==typeof n&&t[n].call(e)})},s.fn.dropdown.Constructor=i,s.fn.dropdown.noConflict=function(){return s.fn.dropdown=t,this},s(document).on("click.bs.dropdown.data-api",o).on("click.bs.dropdown.data-api",".dropdown form",function(e){e.stopPropagation()}).on("click.bs.dropdown.data-api",l,i.prototype.toggle).on("keydown.bs.dropdown.data-api",l+', [role="menu"], [role="listbox"]',i.prototype.keydown)}(jQuery),function(o){var a=function(e,t){this.options=t,this.$body=o(document.body),this.$element=o(e),this.$backdrop=this.isShown=null,this.scrollbarWidth=0,this.options.remote&&this.$element.find(".modal-content").load(this.options.remote,o.proxy(function(){this.$element.trigger("loaded.bs.modal")},this))};function s(i,r){return this.each(function(){var e=o(this),t=e.data("bs.modal"),n=o.extend({},a.DEFAULTS,e.data(),"object"==typeof i&&i);t||e.data("bs.modal",t=new a(this,n)),"string"==typeof i?t[i](r):n.show&&t.show(r)})}a.VERSION="3.2.0",a.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},a.prototype.toggle=function(e){return this.isShown?this.hide():this.show(e)},a.prototype.show=function(n){var i=this,e=o.Event("show.bs.modal",{relatedTarget:n});this.$element.trigger(e),this.isShown||e.isDefaultPrevented()||(this.isShown=!0,this.checkScrollbar(),this.$body.addClass("modal-open"),this.setScrollbar(),this.escape(),this.$element.on("click.dismiss.bs.modal",'[data-dismiss="modal"]',o.proxy(this.hide,this)),this.backdrop(function(){var e=o.support.transition&&i.$element.hasClass("fade");i.$element.parent().length||i.$element.appendTo(i.$body),i.$element.show().scrollTop(0),e&&i.$element[0].offsetWidth,i.$element.addClass("in").attr("aria-hidden",!1),i.enforceFocus();var t=o.Event("shown.bs.modal",{relatedTarget:n});e?i.$element.find(".modal-dialog").one("bsTransitionEnd",function(){i.$element.trigger("focus").trigger(t)}).emulateTransitionEnd(300):i.$element.trigger("focus").trigger(t)}))},a.prototype.hide=function(e){e&&e.preventDefault(),e=o.Event("hide.bs.modal"),this.$element.trigger(e),this.isShown&&!e.isDefaultPrevented()&&(this.isShown=!1,this.resetScrollbar(),this.escape(),o(document).off("focusin.bs.modal"),this.$element.removeClass("in").attr("aria-hidden",!0).off("click.dismiss.bs.modal"),o.support.transition&&this.$element.hasClass("fade")?this.$element.one("bsTransitionEnd",o.proxy(this.hideModal,this)).emulateTransitionEnd(300):this.hideModal())},a.prototype.enforceFocus=function(){o(document).off("focusin.bs.modal").on("focusin.bs.modal",o.proxy(function(e){this.$element[0]===e.target||this.$element.has(e.target).length||this.$element.trigger("focus")},this))},a.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keyup.dismiss.bs.modal",o.proxy(function(e){27==e.which&&this.hide()},this)):this.isShown||this.$element.off("keyup.dismiss.bs.modal")},a.prototype.hideModal=function(){var e=this;this.$element.hide(),this.backdrop(function(){e.$element.trigger("hidden.bs.modal"),o("body").removeClass("modal-open")})},a.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},a.prototype.backdrop=function(e){var t=this,n=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var i=o.support.transition&&n;if(this.$backdrop=o('<div class="modal-backdrop '+n+'" />').appendTo(this.$body),this.$element.on("click.dismiss.bs.modal",o.proxy(function(e){e.target===e.currentTarget&&("static"==this.options.backdrop?this.$element[0].focus.call(this.$element[0]):this.hide.call(this))},this)),i&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!e)return;i?this.$backdrop.one("bsTransitionEnd",e).emulateTransitionEnd(150):e()}else if(!this.isShown&&this.$backdrop){this.$backdrop.removeClass("in");var r=function(){t.removeBackdrop(),e&&e()};o.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one("bsTransitionEnd",r).emulateTransitionEnd(150):r()}else e&&e()},a.prototype.checkScrollbar=function(){document.body.clientWidth>=window.innerWidth||(this.scrollbarWidth=this.scrollbarWidth||this.measureScrollbar())},a.prototype.setScrollbar=function(){var e=parseInt(this.$body.css("padding-right")||0,10);this.scrollbarWidth&&this.$body.css("padding-right",e+this.scrollbarWidth)},a.prototype.resetScrollbar=function(){this.$body.css("padding-right","")},a.prototype.measureScrollbar=function(){var e=document.createElement("div");e.className="modal-scrollbar-measure",this.$body.append(e);var t=e.offsetWidth-e.clientWidth;return this.$body[0].removeChild(e),t};var e=o.fn.modal;o.fn.modal=s,o.fn.modal.Constructor=a,o.fn.modal.noConflict=function(){return o.fn.modal=e,this},o(document).on("click.bs.modal.data-api",'[data-toggle="modal"]',function(e){var t=o(this),n=t.attr("href"),i=o(t.attr("data-target")||n&&n.replace(/.*(?=#[^\s]+$)/,"")),r=i.data("bs.modal")?"toggle":o.extend({remote:!/#/.test(n)&&n},i.data(),t.data());t.is("a")&&e.preventDefault(),i.one("show.bs.modal",function(e){e.isDefaultPrevented()||i.one("hidden.bs.modal",function(){t.is(":visible")&&t.trigger("focus")})}),s.call(i,r,this)})}(jQuery),function(m){var r=function(e,t){this.type=this.options=this.enabled=this.timeout=this.hoverState=this.$element=null,this.init("tooltip",e,t)};r.VERSION="3.2.0",r.DEFAULTS={animation:!0,placement:"top",selector:!1,template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',trigger:"hover focus",title:"",delay:0,html:!1,container:!1,viewport:{selector:"body",padding:0}},r.prototype.init=function(e,t,n){this.enabled=!0,this.type=e,this.$element=m(t),this.options=this.getOptions(n),this.$viewport=this.options.viewport&&m(this.options.viewport.selector||this.options.viewport);for(var i=this.options.trigger.split(" "),r=i.length;r--;){var o=i[r];if("click"==o)this.$element.on("click."+this.type,this.options.selector,m.proxy(this.toggle,this));else if("manual"!=o){var a="hover"==o?"mouseenter":"focusin",s="hover"==o?"mouseleave":"focusout";this.$element.on(a+"."+this.type,this.options.selector,m.proxy(this.enter,this)),this.$element.on(s+"."+this.type,this.options.selector,m.proxy(this.leave,this))}}this.options.selector?this._options=m.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},r.prototype.getDefaults=function(){return r.DEFAULTS},r.prototype.getOptions=function(e){return(e=m.extend({},this.getDefaults(),this.$element.data(),e)).delay&&"number"==typeof e.delay&&(e.delay={show:e.delay,hide:e.delay}),e},r.prototype.getDelegateOptions=function(){var n={},i=this.getDefaults();return this._options&&m.each(this._options,function(e,t){i[e]!=t&&(n[e]=t)}),n},r.prototype.enter=function(e){var t=e instanceof this.constructor?e:m(e.currentTarget).data("bs."+this.type);if(t||(t=new this.constructor(e.currentTarget,this.getDelegateOptions()),m(e.currentTarget).data("bs."+this.type,t)),clearTimeout(t.timeout),t.hoverState="in",!t.options.delay||!t.options.delay.show)return t.show();t.timeout=setTimeout(function(){"in"==t.hoverState&&t.show()},t.options.delay.show)},r.prototype.leave=function(e){var t=e instanceof this.constructor?e:m(e.currentTarget).data("bs."+this.type);if(t||(t=new this.constructor(e.currentTarget,this.getDelegateOptions()),m(e.currentTarget).data("bs."+this.type,t)),clearTimeout(t.timeout),t.hoverState="out",!t.options.delay||!t.options.delay.hide)return t.hide();t.timeout=setTimeout(function(){"out"==t.hoverState&&t.hide()},t.options.delay.hide)},r.prototype.show=function(){var e=m.Event("show.bs."+this.type);if(this.hasContent()&&this.enabled){this.$element.trigger(e);var t=m.contains(document.documentElement,this.$element[0]);if(e.isDefaultPrevented()||!t)return;var n=this,i=this.tip(),r=this.getUID(this.type);this.setContent(),i.attr("id",r),this.$element.attr("aria-describedby",r),this.options.animation&&i.addClass("fade");var o="function"==typeof this.options.placement?this.options.placement.call(this,i[0],this.$element[0]):this.options.placement,a=/\s?auto?\s?/i,s=a.test(o);s&&(o=o.replace(a,"")||"top"),i.detach().css({top:0,left:0,display:"block"}).addClass(o).data("bs."+this.type,this),this.options.container?i.appendTo(this.options.container):i.insertAfter(this.$element);var l=this.getPosition(),c=i[0].offsetWidth,d=i[0].offsetHeight;if(s){var u=o,p=this.$element.parent(),h=this.getPosition(p);o="bottom"==o&&l.top+l.height+d-h.scroll>h.height?"top":"top"==o&&l.top-h.scroll-d<0?"bottom":"right"==o&&l.right+c>h.width?"left":"left"==o&&l.left-c<h.left?"right":o,i.removeClass(u).addClass(o)}var f=this.getCalculatedOffset(o,l,c,d);this.applyPlacement(f,o);var g=function(){n.$element.trigger("shown.bs."+n.type),n.hoverState=null};m.support.transition&&this.$tip.hasClass("fade")?i.one("bsTransitionEnd",g).emulateTransitionEnd(150):g()}},r.prototype.applyPlacement=function(e,t){var n=this.tip(),i=n[0].offsetWidth,r=n[0].offsetHeight,o=parseInt(n.css("margin-top"),10),a=parseInt(n.css("margin-left"),10);isNaN(o)&&(o=0),isNaN(a)&&(a=0),e.top=e.top+o,e.left=e.left+a,m.offset.setOffset(n[0],m.extend({using:function(e){n.css({top:Math.round(e.top),left:Math.round(e.left)})}},e),0),n.addClass("in");var s=n[0].offsetWidth,l=n[0].offsetHeight;"top"==t&&l!=r&&(e.top=e.top+r-l);var c=this.getViewportAdjustedDelta(t,e,s,l);c.left?e.left+=c.left:e.top+=c.top;var d=c.left?2*c.left-i+s:2*c.top-r+l,u=c.left?"left":"top",p=c.left?"offsetWidth":"offsetHeight";n.offset(e),this.replaceArrow(d,n[0][p],u)},r.prototype.replaceArrow=function(e,t,n){this.arrow().css(n,e?50*(1-e/t)+"%":"")},r.prototype.setContent=function(){var e=this.tip(),t=this.getTitle();e.find(".tooltip-inner")[this.options.html?"html":"text"](t),e.removeClass("fade in top bottom left right")},r.prototype.hide=function(){var e=this,t=this.tip(),n=m.Event("hide.bs."+this.type);function i(){"in"!=e.hoverState&&t.detach(),e.$element.trigger("hidden.bs."+e.type)}if(this.$element.removeAttr("aria-describedby"),this.$element.trigger(n),!n.isDefaultPrevented())return t.removeClass("in"),m.support.transition&&this.$tip.hasClass("fade")?t.one("bsTransitionEnd",i).emulateTransitionEnd(150):i(),this.hoverState=null,this},r.prototype.fixTitle=function(){var e=this.$element;(e.attr("title")||"string"!=typeof e.attr("data-original-title"))&&e.attr("data-original-title",e.attr("title")||"").attr("title","")},r.prototype.hasContent=function(){return this.getTitle()},r.prototype.getPosition=function(e){var t=(e=e||this.$element)[0],n="BODY"==t.tagName;return m.extend({},"function"==typeof t.getBoundingClientRect?t.getBoundingClientRect():null,{scroll:n?document.documentElement.scrollTop||document.body.scrollTop:e.scrollTop(),width:n?m(window).width():e.outerWidth(),height:n?m(window).height():e.outerHeight()},n?{top:0,left:0}:e.offset())},r.prototype.getCalculatedOffset=function(e,t,n,i){return"bottom"==e?{top:t.top+t.height,left:t.left+t.width/2-n/2}:"top"==e?{top:t.top-i,left:t.left+t.width/2-n/2}:"left"==e?{top:t.top+t.height/2-i/2,left:t.left-n}:{top:t.top+t.height/2-i/2,left:t.left+t.width}},r.prototype.getViewportAdjustedDelta=function(e,t,n,i){var r={top:0,left:0};if(!this.$viewport)return r;var o=this.options.viewport&&this.options.viewport.padding||0,a=this.getPosition(this.$viewport);if(/right|left/.test(e)){var s=t.top-o-a.scroll,l=t.top+o-a.scroll+i;s<a.top?r.top=a.top-s:l>a.top+a.height&&(r.top=a.top+a.height-l)}else{var c=t.left-o,d=t.left+o+n;c<a.left?r.left=a.left-c:d>a.width&&(r.left=a.left+a.width-d)}return r},r.prototype.getTitle=function(){var e=this.$element,t=this.options;return e.attr("data-original-title")||("function"==typeof t.title?t.title.call(e[0]):t.title)},r.prototype.getUID=function(e){for(;e+=~~(1e6*Math.random()),document.getElementById(e););return e},r.prototype.tip=function(){return this.$tip=this.$tip||m(this.options.template)},r.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".tooltip-arrow")},r.prototype.validate=function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},r.prototype.enable=function(){this.enabled=!0},r.prototype.disable=function(){this.enabled=!1},r.prototype.toggleEnabled=function(){this.enabled=!this.enabled},r.prototype.toggle=function(e){var t=this;e&&((t=m(e.currentTarget).data("bs."+this.type))||(t=new this.constructor(e.currentTarget,this.getDelegateOptions()),m(e.currentTarget).data("bs."+this.type,t))),t.tip().hasClass("in")?t.leave(t):t.enter(t)},r.prototype.destroy=function(){clearTimeout(this.timeout),this.hide().$element.off("."+this.type).removeData("bs."+this.type)};var e=m.fn.tooltip;m.fn.tooltip=function(i){return this.each(function(){var e=m(this),t=e.data("bs.tooltip"),n="object"==typeof i&&i;(t||"destroy"!=i)&&(t||e.data("bs.tooltip",t=new r(this,n)),"string"==typeof i&&t[i]())})},m.fn.tooltip.Constructor=r,m.fn.tooltip.noConflict=function(){return m.fn.tooltip=e,this}}(jQuery),function(r){var o=function(e,t){this.init("popover",e,t)};if(!r.fn.tooltip)throw new Error("Popover requires tooltip.js");o.VERSION="3.2.0",o.DEFAULTS=r.extend({},r.fn.tooltip.Constructor.DEFAULTS,{placement:"right",trigger:"click",content:"",template:'<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'}),o.prototype=r.extend({},r.fn.tooltip.Constructor.prototype),(o.prototype.constructor=o).prototype.getDefaults=function(){return o.DEFAULTS},o.prototype.setContent=function(){var e=this.tip(),t=this.getTitle(),n=this.getContent();e.find(".popover-title")[this.options.html?"html":"text"](t),e.find(".popover-content").empty()[this.options.html?"string"==typeof n?"html":"append":"text"](n),e.removeClass("fade top bottom left right in"),e.find(".popover-title").html()||e.find(".popover-title").hide()},o.prototype.hasContent=function(){return this.getTitle()||this.getContent()},o.prototype.getContent=function(){var e=this.$element,t=this.options;return e.attr("data-content")||("function"==typeof t.content?t.content.call(e[0]):t.content)},o.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".arrow")},o.prototype.tip=function(){return this.$tip||(this.$tip=r(this.options.template)),this.$tip};var e=r.fn.popover;r.fn.popover=function(i){return this.each(function(){var e=r(this),t=e.data("bs.popover"),n="object"==typeof i&&i;(t||"destroy"!=i)&&(t||e.data("bs.popover",t=new o(this,n)),"string"==typeof i&&t[i]())})},r.fn.popover.Constructor=o,r.fn.popover.noConflict=function(){return r.fn.popover=e,this}}(jQuery),function(a){var i=function(e){this.element=a(e)};function t(n){return this.each(function(){var e=a(this),t=e.data("bs.tab");t||e.data("bs.tab",t=new i(this)),"string"==typeof n&&t[n]()})}i.VERSION="3.2.0",i.prototype.show=function(){var e=this.element,t=e.closest("ul:not(.dropdown-menu)"),n=e.data("target");if(n||(n=(n=e.attr("href"))&&n.replace(/.*(?=#[^\s]*$)/,"")),!e.parent("li").hasClass("active")){var i=t.find(".active:last a")[0],r=a.Event("show.bs.tab",{relatedTarget:i});if(e.trigger(r),!r.isDefaultPrevented()){var o=a(n);this.activate(e.closest("li"),t),this.activate(o,o.parent(),function(){e.trigger({type:"shown.bs.tab",relatedTarget:i})})}}},i.prototype.activate=function(e,t,n){var i=t.find("> .active"),r=n&&a.support.transition&&i.hasClass("fade");function o(){i.removeClass("active").find("> .dropdown-menu > .active").removeClass("active"),e.addClass("active"),r?(e[0].offsetWidth,e.addClass("in")):e.removeClass("fade"),e.parent(".dropdown-menu")&&e.closest("li.dropdown").addClass("active"),n&&n()}r?i.one("bsTransitionEnd",o).emulateTransitionEnd(150):o(),i.removeClass("in")};var e=a.fn.tab;a.fn.tab=t,a.fn.tab.Constructor=i,a.fn.tab.noConflict=function(){return a.fn.tab=e,this},a(document).on("click.bs.tab.data-api",'[data-toggle="tab"], [data-toggle="pill"]',function(e){e.preventDefault(),t.call(a(this),"show")})}(jQuery),function(c){var d=function(e,t){this.options=c.extend({},d.DEFAULTS,t),this.$target=c(this.options.target).on("scroll.bs.affix.data-api",c.proxy(this.checkPosition,this)).on("click.bs.affix.data-api",c.proxy(this.checkPositionWithEventLoop,this)),this.$element=c(e),this.affixed=this.unpin=this.pinnedOffset=null,this.checkPosition()};function n(i){return this.each(function(){var e=c(this),t=e.data("bs.affix"),n="object"==typeof i&&i;t||e.data("bs.affix",t=new d(this,n)),"string"==typeof i&&t[i]()})}d.VERSION="3.2.0",d.RESET="affix affix-top affix-bottom",d.DEFAULTS={offset:0,target:window},d.prototype.getPinnedOffset=function(){if(this.pinnedOffset)return this.pinnedOffset;this.$element.removeClass(d.RESET).addClass("affix");var e=this.$target.scrollTop(),t=this.$element.offset();return this.pinnedOffset=t.top-e},d.prototype.checkPositionWithEventLoop=function(){setTimeout(c.proxy(this.checkPosition,this),1)},d.prototype.checkPosition=function(){if(this.$element.is(":visible")){var e=c(document).height(),t=this.$target.scrollTop(),n=this.$element.offset(),i=this.options.offset,r=i.top,o=i.bottom;"object"!=typeof i&&(o=r=i),"function"==typeof r&&(r=i.top(this.$element)),"function"==typeof o&&(o=i.bottom(this.$element));var a=!(null!=this.unpin&&t+this.unpin<=n.top)&&(null!=o&&n.top+this.$element.height()>=e-o?"bottom":null!=r&&t<=r&&"top");if(this.affixed!==a){null!=this.unpin&&this.$element.css("top","");var s="affix"+(a?"-"+a:""),l=c.Event(s+".bs.affix");this.$element.trigger(l),l.isDefaultPrevented()||(this.affixed=a,this.unpin="bottom"==a?this.getPinnedOffset():null,this.$element.removeClass(d.RESET).addClass(s).trigger(c.Event(s.replace("affix","affixed"))),"bottom"==a&&this.$element.offset({top:e-this.$element.height()-o}))}}};var e=c.fn.affix;c.fn.affix=n,c.fn.affix.Constructor=d,c.fn.affix.noConflict=function(){return c.fn.affix=e,this},c(window).on("load",function(){c('[data-spy="affix"]').each(function(){var e=c(this),t=e.data();t.offset=t.offset||{},t.offsetBottom&&(t.offset.bottom=t.offsetBottom),t.offsetTop&&(t.offset.top=t.offsetTop),n.call(e,t)})})}(jQuery),function(c){var r=function(e,t){this.$element=c(e),this.options=c.extend({},r.DEFAULTS,t),this.transitioning=null,this.options.parent&&(this.$parent=c(this.options.parent)),this.options.toggle&&this.toggle()};function d(i){return this.each(function(){var e=c(this),t=e.data("bs.collapse"),n=c.extend({},r.DEFAULTS,e.data(),"object"==typeof i&&i);!t&&n.toggle&&"show"==i&&(i=!i),t||e.data("bs.collapse",t=new r(this,n)),"string"==typeof i&&t[i]()})}r.VERSION="3.2.0",r.DEFAULTS={toggle:!0},r.prototype.dimension=function(){return this.$element.hasClass("width")?"width":"height"},r.prototype.show=function(){if(!this.transitioning&&!this.$element.hasClass("in")){var e=c.Event("show.bs.collapse");if(this.$element.trigger(e),!e.isDefaultPrevented()){var t=this.$parent&&this.$parent.find("> .panel > .in");if(t&&t.length){var n=t.data("bs.collapse");if(n&&n.transitioning)return;d.call(t,"hide"),n||t.data("bs.collapse",null)}var i=this.dimension();this.$element.removeClass("collapse").addClass("collapsing")[i](0),this.transitioning=1;var r=function(){this.$element.removeClass("collapsing").addClass("collapse in")[i](""),this.transitioning=0,this.$element.trigger("shown.bs.collapse")};if(!c.support.transition)return r.call(this);var o=c.camelCase(["scroll",i].join("-"));this.$element.one("bsTransitionEnd",c.proxy(r,this)).emulateTransitionEnd(350)[i](this.$element[0][o])}}},r.prototype.hide=function(){if(!this.transitioning&&this.$element.hasClass("in")){var e=c.Event("hide.bs.collapse");if(this.$element.trigger(e),!e.isDefaultPrevented()){var t=this.dimension();this.$element[t](this.$element[t]())[0].offsetHeight,this.$element.addClass("collapsing").removeClass("collapse").removeClass("in"),this.transitioning=1;var n=function(){this.transitioning=0,this.$element.trigger("hidden.bs.collapse").removeClass("collapsing").addClass("collapse")};if(!c.support.transition)return n.call(this);this.$element[t](0).one("bsTransitionEnd",c.proxy(n,this)).emulateTransitionEnd(350)}}},r.prototype.toggle=function(){this[this.$element.hasClass("in")?"hide":"show"]()};var e=c.fn.collapse;c.fn.collapse=d,c.fn.collapse.Constructor=r,c.fn.collapse.noConflict=function(){return c.fn.collapse=e,this},c(document).on("click.bs.collapse.data-api",'[data-toggle="collapse"]',function(e){var t,n=c(this),i=n.attr("data-target")||e.preventDefault()||(t=n.attr("href"))&&t.replace(/.*(?=#[^\s]+$)/,""),r=c(i),o=r.data("bs.collapse"),a=o?"toggle":n.data(),s=n.attr("data-parent"),l=s&&c(s);o&&o.transitioning||(l&&l.find('[data-toggle="collapse"][data-parent="'+s+'"]').not(n).addClass("collapsed"),n[r.hasClass("in")?"addClass":"removeClass"]("collapsed")),d.call(r,a)})}(jQuery),function(o){function r(e,t){var n=o.proxy(this.process,this);this.$body=o("body"),this.$scrollElement=o(e).is("body")?o(window):o(e),this.options=o.extend({},r.DEFAULTS,t),this.selector=(this.options.target||"")+" .nav li > a",this.offsets=[],this.targets=[],this.activeTarget=null,this.scrollHeight=0,this.$scrollElement.on("scroll.bs.scrollspy",n),this.refresh(),this.process()}function t(i){return this.each(function(){var e=o(this),t=e.data("bs.scrollspy"),n="object"==typeof i&&i;t||e.data("bs.scrollspy",t=new r(this,n)),"string"==typeof i&&t[i]()})}r.VERSION="3.2.0",r.DEFAULTS={offset:10},r.prototype.getScrollHeight=function(){return this.$scrollElement[0].scrollHeight||Math.max(this.$body[0].scrollHeight,document.documentElement.scrollHeight)},r.prototype.refresh=function(){var i="offset",r=0;o.isWindow(this.$scrollElement[0])||(i="position",r=this.$scrollElement.scrollTop()),this.offsets=[],this.targets=[],this.scrollHeight=this.getScrollHeight();var e=this;this.$body.find(this.selector).map(function(){var e=o(this),t=e.data("target")||e.attr("href"),n=/^#./.test(t)&&o(t);return n&&n.length&&n.is(":visible")&&[[n[i]().top+r,t]]||null}).sort(function(e,t){return e[0]-t[0]}).each(function(){e.offsets.push(this[0]),e.targets.push(this[1])})},r.prototype.process=function(){var e,t=this.$scrollElement.scrollTop()+this.options.offset,n=this.getScrollHeight(),i=this.options.offset+n-this.$scrollElement.height(),r=this.offsets,o=this.targets,a=this.activeTarget;if(this.scrollHeight!=n&&this.refresh(),i<=t)return a!=(e=o[o.length-1])&&this.activate(e);if(a&&t<=r[0])return a!=(e=o[0])&&this.activate(e);for(e=r.length;e--;)a!=o[e]&&t>=r[e]&&(!r[e+1]||t<=r[e+1])&&this.activate(o[e])},r.prototype.activate=function(e){this.activeTarget=e,o(this.selector).parentsUntil(this.options.target,".active").removeClass("active");var t=this.selector+'[data-target="'+e+'"],'+this.selector+'[href="'+e+'"]',n=o(t).parents("li").addClass("active");n.parent(".dropdown-menu").length&&(n=n.closest("li.dropdown").addClass("active")),n.trigger("activate.bs.scrollspy")};var e=o.fn.scrollspy;o.fn.scrollspy=t,o.fn.scrollspy.Constructor=r,o.fn.scrollspy.noConflict=function(){return o.fn.scrollspy=e,this},o(window).on("load.bs.scrollspy.data-api",function(){o('[data-spy="scroll"]').each(function(){var e=o(this);t.call(e,e.data())})})}(jQuery),(i=$).fn.emulateTransitionEnd=function(e){var t=!1,n=this;return i(this).one("bsTransitionEnd",function(){t=!0}),setTimeout(function(){t||i(n).trigger(i.support.transition.end)},e),this},i(function(){i.support.transition=function(){var e=document.createElement("bootstrap"),t={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var n in t)if(void 0!==e.style[n])return{end:t[n]};return!1}(),i.support.transition&&(i.event.special.bsTransitionEnd={bindType:i.support.transition.end,delegateType:i.support.transition.end,handle:function(e){if(i(e.target).is(this))return e.handleObj.handler.apply(this,arguments)}})})}),define("app/document/File",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/editor/UndoManager","app/document/StringUtils","app/document/Node","app/document/Node","app/editor/polyfill","app/window/FileHelper","app/editor/EditHelper","app/editor/KeyMaster","app/window/MenuHelper","app/window/FileInfoPanel","app/window/steno2"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton");var p=e("jquery/jquery"),a=e("app/document/StringUtils"),f=e("app/editor/UndoManager"),g=e("app/document/Node"),s=g.Node,l=g.TYPE,h=(e("app/editor/polyfill"),e("app/window/FileHelper")),r=e("app/window/MenuHelper"),m=e("app/window/FileInfoPanel"),i=h.ChangeCounter,v=(h.ChangeType,e("app/window/steno2")),c=window.reqnode?reqnode("electron").remote:null,y=c?c.app:window.app;function o(e,t){return void 0===e?t:e}function d(){return b.isMac?y.menu.getItem("Edit").submenu().getItem("Whitespace and Line Breaks").submenu():b.isNode?c.Menu.getApplicationMenu().getItem("Edit").submenu.getItem("Whitespace and Line Breaks").submenu:void 0}var b={option:{indentByTab:!1,indentSize:2,codeIndentSize:4,autoToggleEmojiAutoComplete:!0,enableInlineMath:!0,autoNumberingForMath:!1,enableHighlight:!1,enableSubscript:!1,enableSuperscript:!1,enableDiagram:!1,copyMarkdownByDefault:!1,showLineNumbersForFence:!1,useRelativePathForImg:!1,noSpellCheck:!1,autoCorrectMisspell:!1,noPairingMatch:!1,autoPairExtendSymbol:!1,noPreWrap:!1,autoSave:!1,scrollWithCursor:!1,expandSimpleBlock:!1,allowImageMove:!0,allowImageUpload:!0,headingStyle:0,ulStyle:0,olStyle:0,strictMarkdown:!1,preferCRLF:!1,sortType:0,sidebarTab:"",useTreeStyle:!1,noLineWrapping:!1,prettyIndent:!1,defaultImageStorage:null,applyImageMoveForWeb:!1,applyImageMoveForLocal:!0,ignoreLineBreak:!1,preLinebreakOnExport:!1,hideBrAndLineBreak:!1,indentFirstLine:!1,monocolorEmoji:!1,useFsQueue:!0,smartDash:0,smartQuote:0},needSaveState:!1,readOption:function(){if(b.isMac||b.isNode){if(b.option.autoToggleEmojiAutoComplete=o(t("trigger_emoji_autocomplete"),!0),b.option.enableInlineMath=t("enable_inline_math"),b.option.enableHighlight=t("enable_highlight")||!1,b.option.enableSubscript=t("enable_subscript")||!1,b.option.enableSuperscript=t("enable_superscript")||!1,b.option.enableDiagram=o(t("enable_diagram"),!0),b.option.copyMarkdownByDefault=t("copy_markdown_by_default")||!1,b.option.showLineNumbersForFence=t("show_line_numbers_for_fence")||!1,b.option.noPairingMatch=t("no_pairing_match")||!1,b.option.autoPairExtendSymbol=t("match_pari_markdown")||!1,b.option.expandSimpleBlock=t("auto_expand_block")||!1,b.option.headingStyle=n("heading_style")||0,b.option.ulStyle=n("ul_style")||0,b.option.olStyle=n("ol_style")||0,b.option.scrollWithCursor=!t("no_mid_caret"),b.option.autoNumberingForMath=t("auto_numbering_for_math"),b.option.useRelativePathForImg=t("use_relative_path_for_img")||!1,b.option.allowImageUpload=t("allow_image_upload")||!1,b.option.defaultImageStorage=y.setting.get("image_save_location")||null,b.option.applyImageMoveForWeb=y.setting.get("apply_image_move_for_web")||!1,b.option.applyImageMoveForLocal=!y.setting.get("no_image_move_for_local"),b.option.preferCRLF=t("line_ending_crlf")||!1,b.option.sidebarTab=y.setting.get("sidebar_tab")||"",b.option.useTreeStyle=t("useTreeStyle")||!1,b.option.sortType=n("file_sort_type")||0,b.option.strictMarkdown=t("strict_mode")||!1,b.option.noLineWrapping=t("no_line_wrapping")||!1,b.option.prettyIndent=t("prettyIndent")||!1,b.isMac)b.option.indentSize=y.setting.getInteger("indentSize")||2,b.option.codeIndentSize=y.setting.getInteger("codeIndentSize")||4;else if(b.isNode){b.option.indentSize=y.setting.get("indentSize")||2,b.option.codeIndentSize=y.setting.get("codeIndentSize")||4,b.option.enableAutoSave=y.setting.get("enableAutoSave")||!1,b.option.saveFileOnSwitch=y.setting.get("save_file_on_switch")||!1,b.option.noSpellCheck=y.setting.get("no_spell_check")||!1,b.option.autoCorrectMisspell=y.setting.get("auto_correct_misspell")||!1;var e=y.setting.config||{};b.option.monocolorEmoji=e.monocolorEmoji,e.monocolorEmoji&&document.body.classList.add("monocolor-emoji")}y.setting.get("useCustomFontSize")&&(document.body.parentElement.style.fontSize=y.setting.get("customFontSize")+"px"),b.setIndentSize(b.option.indentSize),b.option.showLineNumbersForFence&&p("#write").addClass("show-fences-line-number"),window.innerWidth<540&&(b.option.sidebarTab=null),b.setCanCollapsePinnedOutline(t("can_collapse_outline_panel")),b.option.passiveEvents=b.isNodeHtml,3==b.option.headingStyle&&document.body.classList.add("use-varible-width-setex"),b.option.noLineWrapping&&p("#write").addClass("fences-no-line-wrapping"),b.option.preLinebreakOnExport=y.setting.get("preLinebreakOnExport"),b.option.preLinebreakOnExport=1==b.option.preLinebreakOnExport||"true"==b.option.preLinebreakOnExport,b.setIndentFirstLine(y.setting.get("indentFirstLine")||!1,!0),b.setHideBrAndLineBreak(y.setting.get("hideBrAndLineBreak")||!1,!0),b.isFocusMode=y.setting.get("isFocusMode"),b.isTypeWriterMode=y.setting.get("isTypeWriterMode"),b.setIgnoreLineBreak(y.setting.get("ignoreLineBreak")||!1)}else window._options&&(b.option=p.extend(b.option,window._options));function t(e){return b.isMac?y.setting.get(e):b.isNode?y.setting.get(e):void 0}function n(e){return b.isMac?y.setting.getInteger(e):b.isNode?y.setting.get(e):void 0}},setIndentFirstLine:function(e,t,n){b.option.indentFirstLine=e,b.option.indentFirstLine?document.body.classList.add("first-line-indent"):document.body.classList.remove("first-line-indent"),t&&(d().getItem("Indent first line of paragraphs").setState(b.option.indentFirstLine),r.forceRefreshMenu()),n&&y.setting.put("indentFirstLine",e)},setHideBrAndLineBreak:function(e,t,n){b.option.hideBrAndLineBreak=e,b.option.hideBrAndLineBreak?document.body.classList.add("hide-br-and-line-break"):document.body.classList.remove("hide-br-and-line-break"),t&&(d().getItem("Visible <br/> and markdown line break").setState(!b.option.hideBrAndLineBreak),r.forceRefreshMenu()),n&&y.setting.put("hideBrAndLineBreak",e)},setIgnoreLineBreak:function(e,t,n){var i=void 0!==b.option.ignoreLineBreak&&b.option.ignoreLineBreak!=e;b.option.ignoreLineBreak=e,b.option.ignoreLineBreak?(document.body.classList.add("ignore-line-break"),i&&p("#write p[cid]").each(function(e,t){this.innerHTML=p(this).children().map(function(){return this.outerHTML}).toArray().join("\n")})):(document.body.classList.remove("ignore-line-break"),i&&p("#write p[cid]").each(function(e,t){this.innerHTML=p(this).children().map(function(){return this.outerHTML.replace(/\u00A0/g," ")}).toArray().join("")})),t&&(d().getItem("Preserve sequential whitespace and single line break").setState(!b.option.ignoreLineBreak),r.forceRefreshMenu()),n&&y.setting.put("ignoreLineBreak",e)},setIndentSize:function(e){b.option.indentSize=(e||2)-0,b.option.indentSize<0?(b.option.indentSize=2,b.option.indentByTab=!0):b.option.indentByTab=!1},setEditor:function(e){b.isLocked=b.isMac&&y.document.isLocked(),b.editor=e,b.isMac||(b.changeCounter=new i)},onFileOpened:function(){b.isNode&&(reqnode("electron").ipcRenderer.send("addBackup",{path:b.filePath,mountFolder:b.mountFolder_,encode:b.encode,useCRLF:b.useCRLF}),b.needSaveState=!1)},getFilePathUseNode:function(){if(b.isNode){var e=c.getCurrentWindow(),t=c.app.getDocumentController().getDocumentFromWindowId(e.id).path;b.mountFolder_||(b.mountFolder_=e.initMountFolder,e.initMountFolder=void 0)}return t},setLineEnding:function(e,t,n){if(e!=b.useCRLF||n){var i;if(b.useCRLF=e,b.isMac)i=y.menu.getItem("Edit").submenu().getItem("Line Endings").submenu();else{if(!b.isNode)return;i=reqnode("electron").remote.Menu.getApplicationMenu().getItem("Edit").submenu.getItem("Line Endings").submenu}if(i.getItem("Windows Line Endings (CRLF)").setState(b.useCRLF),i.getItem("Unix Line Endings (LF)").setState(!b.useCRLF),i.getItem("Windows Line Endings (CRLF)").setEnabled(!b.isLocked),i.getItem("Unix Line Endings (LF)").setEnabled(!b.isLocked),t){b.sync();var r=b.editor.getMarkdown();r=(r.split(/\r?\n/g)||[r]).join(b.useCRLF?"\r\n":"\n"),b.reloadContent(r),b.isMac&&b.setLineEnding(e),b.backupWindow()}}},recoverFromBackup:function(){if(!b.isNode)return!1;var e=b.getCurrentDocByNode(),t=e&&e.popBackupState();if(!t||!t.content)return!1;if(b.setLineEnding(t.useCRLF),m.setFileTitle(t.path||"",t.encode),b.mountFolder_=t.mountFolder,b.editor.reset(t.content),b.updateChangeCount(h.ChangeType.NSChangeDone),t.path){var n=f.makeEmptyCommand();n.redo.push(f.buildAllDoc(b.editor.nodeMap)),b.fs.readFile(t.path,t.encode||"utf8",function(e,t){e||(n.undo.push({type:"initSrc",src:t}),b.changeCounter.doneStack.unshift(h.ChangeType.NSChangeCleared),b.editor.undo.register(n,!0,void 0,!0))})}return!0},getContent:function(e,t){var n;if(b.setLineEnding(b.option.preferCRLF),b.isMac)return n=y.document.content||"",b.setLineEnding(-1<n.indexOf("\r\n")&&!/[^\r]\n/.exec("a"+n)),n;if(b.isNode){var i=e;try{if(i=e||b.getFilePathUseNode()){var r=b.fs.readFileSync(i),o=t||h.detectEncodeByNode(r);return n=h.getContentFromBuffer(r,o),b.setLineEnding(-1<n.indexOf("\r\n")||!(-1<n.indexOf("\n"))&&b.option.preferCRLF),m.setFileTitle(i,o),n}m.setFileTitle()}catch(e){if(b.option.slientOpenFailure=b.option.slientOpenFailure||c.getCurrentWindow().slientOpenFailure,!b.option.slientOpenFailure){var a=e.message||"";debugMode||(a=a.splits&&a.splits(/\n/)[0]||a),c.dialog.showErrorBox(p.localize.getString("Failed to load file"),a)}if(b.option.slientOpenFailure=!1,m.setFileTitle(""),m.watchFileChange(null),i){var s=y.getDocumentController().getDocument(i);s&&s.switchToUntitled()}return""}}return""},setContent:function(e,t){b.isMac?y.document.content=e:t&&b.isNode&&b.getCurrentDocByNode().setContent(e),b.editor.tryEnterBusyMode(e)},getMountFolder:function(){return b.isMac?y.controller.cachedMountFolder():b.mountFolder_},setMountFolder:function(e){b.mountFolder_=e},sync:function(e,t){if(b.isActiveWindow())if(b.editor.sourceView.inSourceMode){var n=b.editor.sourceView.cm.getValue(b.useCRLF?"\r\n":"\n");b.setContent(n,t),b.isMac&&e&&y.document.isDocumentEdited()&&b.editor.sourceView.onSave()}else{b.editor.undo.completeSnap(!0),b.editor.store(null,!0);try{p(".md-focus").closest(".unholdable").length||b.editor.autoRemoveUnholdable()}catch(e){console.sendError(e.stack)}b.setContent(b.editor.getMarkdown(),t)}},isActiveWindow:function(){if(b.isMac)return y.controller.isActiveWindow();if(!b.isNode)return!0;var e=c.getCurrentWindow();if(e.id===(b.getCurrentDocByNode().activeWindow||{}).id)return!0;e.isFocused()&&(console.warn("error found on windows focus management"),window.onWindowFocus())},shouldTriggerSyncChange:function(){if(b.isMac)return y.controller.shouldTriggerSyncChange();if(b.isNode){var e=b.getCurrentDocByNode();return b.isActiveWindow()&&1<e.windows.size}},getCurrentDocByNode:function(){return y.getDocumentController().getDocumentFromWindowId(c.getCurrentWindow().id)},saveUseNode:function(r,e,t){if(b.isActiveWindow()){b.sync();var o,a=b.getFilePathUseNode(),n=b.fileEncode||"utf8",s=b.editor.getMarkdown(),l=!1;if(!a&&b.filePath&&!t){a=b.filePath;var i=reqnode("path").dirname(a);reqnode("fs").existsSync(i)||(a=void 0),l=!0}if((a||!t)&&b.isNode){var c=reqnode("iconv-lite");try{o=c.encode(s,n)}catch(e){d()}0==o.length&&""!=s&&d(),a&&!e?(b.inSavingProcess=b.inSavingProcess||!e,!l&&y.sendEvent("willSave",a),v.writeFile(a,o,function(e,t){if(e)u(e.stack);else{t&&m.watchFileChange(a);try{if(o.length&&0==b.fs.statSync(a).size)return void u("Failed to write file");var n=b.fs.statSync(a);b.lastModifiedDate=n.mtimeMs}catch(e){return void u(e.stack)}b.lastSaved=new Date;var i=b.getCurrentDocByNode();l&&i.rename(a),i.setLastSync(b.lastSaved-0),b.changeCounter.isDocumentEdited()&&b.updateChangeCount(b.ChangeType.NSChangeAutosaved),r&&r(e),l||y.sendEvent("didSave",{path:a,summary:s.substr(0,200),lastModifiedDate:b.lastModifiedDate}),b.inSavingProcess=!1,b.needSaveState=!0,b.backupWindow()}}),b.updateChangeCount(b.ChangeType.NSChangeAutosaved)):t||h.showSaveDialog(r||void 0)}}function d(e){console.log("swith to utf8 encode"),o=Buffer.from(s),b.fileEncode="utf8"}function u(e){t||alert(p.localize.getString("Save File Failed")+"\n"+e),console.sendError("fs write failed -- \n"+e),b.updateChangeCount(b.ChangeType.NodeSaveFailed),b.inSavingProcess=!1,b.backupWindow()}},updateChangeCount:function(e){if(b.editor.sourceView&&b.editor.sourceView.inSourceMode)b.isMac?e==b.ChangeType.NSChangeAutosaved?(b.editor.sourceView.cm.save(),y.document.updateChangeCount(e)):e==b.ChangeType.NSChangeCleared?y.document.updateChangeCount(e):y.document.isDocumentEdited()||y.document.updateChangeCount(b.ChangeType.NSChangeDone):b.changeCounter.updateChangeCount(e);else if(b.needsUpdateSnap(),b.isMac){y.document.updateChangeCount(e);var t=y.menu.getItem("Edit");t&&(t.submenu().getItem("Undo").setEnabled(b.editor.undo.hasUndo()),t.submenu().getItem("Redo").setEnabled(b.editor.undo.hasRedo()))}else if(b.changeCounter.updateChangeCount(e),e===b.ChangeType.NSChangeAutosaved?w=!1:(w=!0,b.needSaveState=!0),b.isNode){var n=c.Menu.getApplicationMenu().getItem("Edit").submenu;n.getItem("Undo").setEnabled(b.editor.undo.hasUndo()),n.getItem("Redo").setEnabled(b.editor.undo.hasRedo()),releasePrintWin_(),releaseCaptureWin_()}},onSwitchDocumentTarget:function(e,t){b.editor.brush.clearAndPause(),b.fileHasModified=!1,b.editor.focusCid=null;var n=b.editor.sourceView.inSourceMode;e&&e.nodeMap&&e.undoRedo?b.restoreEditStateFromData(e):(b.changeCounter&&b.changeCounter.reset(),b.editor.undo.reset(),b.editor.nodeMap.reset(!1,!0),b.editor.reset(n?"":b.getContent(t))),n&&b.editor.sourceView.setValue(b.getContent(t),!0);var i=null,r=0;if((!e||!e.nodeMap)&&b.editor.undo.reset(),window.getSelection().removeAllRanges(),b.editor.brush.restart(),b.isMac){b.editor.library.markCurrentFile();var o=y.window.getLastCursor()||[];i=JSON.parse(o[1]||"null"),r=o[2]||0}i&&setTimeout(function(){b.editor.undo.exeCommand(i)},500),p("content").scrollTop(r),b.freshMenu(),b.editor.brush.updateWordCount(),b.editor.refresh(),b.editor.imgEdit.preFileImageStorage=void 0,b.getMountFolder()||b.editor.library.onRootChanged(),b.backupWindow()},getDocumentSnap:function(){if(b.isMac)return y.document.snap;if(b.isNode){var e=b.getCurrentDocByNode();if(e)return e.snap}},restoreEditStateFromData:function(e,t,n){if(!e||!e.undoRedo||!e.nodeMap)return!0;if(e.timeStamp==(b.isMac?y.controller.contentSnapRestoredTime:b.contentSnapRestoredTime))return!0;b.fileHasModified=!0;var i=null,r=b.editor,o=r.sourceView&&r.sourceView.inSourceMode,a=!1;if(b._onInitParse=!0,b.editor.focusCid=null,b.editor.lastCursor=null,r.nodeMap.restoreFromJson(JSON.parse(e.nodeMap)),r.undo.restoreFromJson(JSON.parse(e.undoRedo)),b.setLineEnding(e.useCRLF),b._onInitParse=!1,b.isNode&&(a=!b.getCurrentDocByNode().isSnapValid(),e.content=e.srcContent=b.getCurrentDocByNode().getContent()),o)t&&(i=r.sourceView.cm.getScrollInfo().top),b.reloadContent(e.srcContent,!0,!1,!1,!0),e.srcHist&&(r.sourceView.cm.doc.clearHistory(),r.sourceView.cm.doc.setHistory(JSON.parse(e.srcHist))),e.fromSourceMode||b.reloadContent(e.content,!1,!1,!1,n||b.isMac&&!y.document.isDocumentEdited()),t&&r.sourceView.cm.scrollTo(0,i);else if(t&&(i=p("content").scrollTop()),e.fromSourceMode?b.reloadContent(e.srcContent,!1,!1,!1,!0,n):a||(p(r.sessionStr).html(g.NodeCollectionUtils.toHTML(r.nodeMap.blocks)),n||(r.focusCid=void 0,r.refresh())),t){if("object"==typeof t)try{r.undo.exeCommand(t)}catch(e){}p("content").scrollTop(i)}if(b.isMac&&(y.controller.contentSnapRestoredTime=e.timeStamp),b.isNode){if(b._needsUpdateSnap=!1,b.contentSnapRestoredTime=e.timeStamp,b.changeCounter.reset(e.changeCounter),a)return b.reloadContent(b.getContent(),!1,!1,!0,!1,n),b.updateChangeCount(b.ChangeType.NSChangeAutosaved),void(b.fileHasModified=!1);m.setFileTitle(b.filePath,e.fileEncode)}n||(b.freshMenu(),b.editor.brush.updateWordCount(),b.editor.refresh(!1,!0))},needsUpdateSnap:function(){b.isMac?y.document.needsUpdateSnap():b._needsUpdateSnap=!0},backupDocumentSnap:function(){b.isMac&&y.document.backupDocumentSnap(),b.isNode&&b.buildDocumentSnap()},backupLastCursor:function(){if(b.isMac){var e=b.editor.sourceView.inSourceMode;y.window.setLastCursor(JSON.stringify(b.editor.selection.buildUndo()||null),e?0:p("content").scrollTop())}},buildDocumentSnap:function(){function e(){var e=b.editor.sourceView.inSourceMode,t={nodeMap:JSON.stringify(b.editor.nodeMap.storeToJson()),undoRedo:JSON.stringify(b.editor.undo.storeToJson()),timeStamp:new Date-0,cursorPos:JSON.stringify(b.editor.selection.buildUndo()),scrollOffset:e?0:p("content").scrollTop(),useCRLF:b.useCRLF};return e&&(t.fromSourceMode=!0,t.srcHist=JSON.stringify(b.editor.sourceView.cm.doc.getHistory())),b.isNode&&(t.fileEncode=b.fileEncode,t.changeCounter=b.changeCounter.clone(),b.contentSnapRestoredTime=t.timeStamp),b.isMac&&(y.controller.contentSnapRestoredTime=t.timeStamp),t}if(b.sync(!1,!0),b.isMac&&y.document.buildDocumentSnap(e()),b.isNode){var t;if(!b._needsUpdateSnap)return;b._needsUpdateSnap=!1,(t=b.getCurrentDocByNode())&&t.shouldSaveSnap()&&t.addSnap(e())}},presentedItemChanged:function(e){if(b.isActiveWindow())if(console.log("presentedItemChanged"),e&&clientHanlderOnPresentationMoved(),b.isNode){if(b.filePath){if(b.inSavingProcess)return}else b.filePath=b.getFilePathUseNode(),b.fileName=h.getFileNameFromPath(b.filePath);b.filePath&&b.fs.stat(b.filePath,function(e,t){if(t&&!(b.lastModifiedDate>=t.mtimeMs)){b.lastModifiedDate=t.mtimeMs,console.log("presentedItemChanged did happen");var n=b.changeCounter.isDocumentEdited();if(function(e){var t,n=p("content").scrollTop();if(e){b.isMac?t=y.document.getDataFromFile(!0):b.isNode&&(t=b.getContent(b.filePath,b.fileEncode)),b.reloadContent(t,!1,!1,!0),b.updateChangeCount(b.ChangeType.NSChangeAutosaved);var i=b.editor.sourceView;if(i.inSourceMode){var r=i.cm.getScrollInfo().top,o=i.cm.listSelections();i.setValue(t),i.cm.setSelections(o),i.cm.scrollTo(0,r)}setTimeout(function(){b.setContent(t),p("content").scrollTop(n)},0)}else b.updateChangeCount(b.ChangeType.NSChangeReadOtherContents)}(!n||confirm(p.localize.getString("File content is changed by external applications. Reload content from disk ?"))),n)c.getCurrentWindow().focus()}})}else b.isMac&&(y.document.isDocumentEdited()&&!confirm(p.localize.getString("File content is changed by external applications. Reload content from disk ?"))||y.document.refreshContentFromDisk())},reloadWithEncoding:function(e){if(b.isNode&&b.filePath){var t=b.getContent(b.filePath,e);b.reloadContent(t),b.updateChangeCount(b.ChangeType.NSChangeCleared),b.backupWindow()}},reloadContent:function(e,t,n,i,r,o){var a,s,l,c=f.makeEmptyCommand(),d=b.editor.sourceView&&b.editor.sourceView.inSourceMode;if(b.isMac&&b.setLineEnding(b.useCRLF),d||o||(b.editor.store(),b.editor.undo.completeSnap(!0),c.undo.push(b.editor.selection.buildUndo())),b.editor.focusCid=null,b.editor.lastCursor=null,c.undo.push(f.buildAllDoc(b.editor.nodeMap,i)),d&&(l=b.editor.sourceView.cm.getScrollInfo().top,s=b.editor.sourceView.cm.getCursor(),b.editor.sourceView.setValue(e,!0,i||r?"fromDisk":"begin")),b.editor.tryEnterBusyMode(e),d&&i||(b.editor.nodeMap.reset(),(a=g.Node.parseFrom(e,b.editor.nodeMap,{skips:{old_code:!1}}))[1].map(function(e){e.set("attachTo",b.editor.nodeMap)}),c.redo.push(f.buildAllDoc(b.editor.nodeMap,i)),d?(b.editor.sourceView.renderedHTML=a[0],b.editor.undo.register(c,r)):b.editor.writingArea.innerHTML=a[0]),d){var u=b.editor.sourceView.cm.getInputField();return u.setSelectionRange&&u.setSelectionRange(0,0),b.editor.sourceView.cm.setCursor(s),void(i&&void 0!==l&&b.editor.sourceView.cm.scrollTo(0,l))}if(i){var p=b.editor.undo.lastRegisteredOperationCommand(),h=p&&p.undo.last();h&&"reload"==h.type&&h.reloadFromDisk&&(c.undo=[h],b.editor.undo.removeLastRegisteredOperationCommand())}t||b.editor.undo.register(c,r),o||(t?(b.editor.undo.reset(),b.updateChangeCount(b.ChangeType.NSChangeAutosaved)):window.getSelection().removeAllRanges(),setTimeout(function(){b.editor.refresh(),b.editor.selection.scrollAdjust()},n?500:0))},copy:function(){b.editor.UserOp.copyHandler(b.editor)},delete:function(){"TEXTAREA"!=document.activeElement.tagName&&"INPUT"!=document.activeElement.tagName&&b.editor.UserOp.backspaceHandler(b.editor,null,"Backspace")},deleteActive:function(){var e=b.editor.getMarkElem(),t=b.editor.findNodeByElem(e),n=b.editor.UserOp.backToParagraph(editor,t,!0);b.editor.undo.register(n)},cut:function(){if(b.isLocked)return!1;b.editor.refocus(void 0,!0),b.editor.snapSelection=editor.selection.buildUndo(),b.editor.UserOp.copyHandler(editor,null),b.editor.UserOp.backspaceHandler(editor,null,"delSelection")},pasteAsPlainText:function(){p(b.editor.sessionStr).trigger("pasteAsPlainText")},lock:function(){b.isLocked=!0,b.freshLock()},unlock:function(){b.isLocked=!1,b.freshLock()},toggleSourceMode:function(){b.editor.sourceView.inSourceMode?(b.editor.sourceView.hide(),b.editor.library.recoverSidebar()):(b.editor.library.tmpHideSidebar(),b.editor.sourceView.show()),b.freshMenu()},isFocusedOnWriteDiv:function(){return 0<p(document.activeElement).closest("#write").length},getExtraContext:function(o){if(!o)return"default";if(document.querySelector("#write").contains(o))return function(){try{if(s.isType(document.activeElement.tagName,"INPUT","TEXTAREA"))return"";var e=editor.selection.getRangy(),t=editor.getMarkElem(o),n=p(o).closest(".md-expand"),i=t.attr("mdtype");if(/^table/g.exec(i)&&!b.isLocked)return"table|seperator|insertParagraphBefore|insertParagraphAfter";if(s.isType(i,l.math_block))return"copyMathBlock|delete|seperator|insertParagraphBefore|insertParagraphAfter";if(s.isType(i,l.fences))return"delete-fences|insertParagraphBefore|insertParagraphAfter";if(t.attr("tabindex"))return"copy|delete|seperator|insertParagraphBefore|insertParagraphAfter";if(t.hasClass("md-def-link")){var r=p(e.commonAncestorContainer).closest(".md-def-url");return r.length?(b.editor.setCurLinkElem(r),"openLink"):""}if(p(o).closest(".md-emoji").length)return"copyEmoji-"+p(o).closest(".md-emoji").find("[data-emoji]").attr("data-emoji")+"|seperator";if(e&&p(e.commonAncestorContainer).closest(".md-inline-math").length)return"copyMathInline";if(s.isType(n.hasClass("md-img-loaded")&&n.attr("md-inline"),l.image,l.imgtag))return b.editor.imgEdit.contextMenuItems(n.find("img")[0]).join("|");if(s.isType(n.hasClass("md-img-loaded")&&n.attr("md-inline"),l.refimg)&&/^file:\/\//.exec(n.find("img").attr("src")||""))return"revealInFinder|seperator"}catch(e){}return""}();if(b.editor.sourceView.inSourceMode&&document.querySelector("#typora-source").contains(o))return"sourceMode";if(b.getMountFolder()){var e=b.editor.getJQueryElem(o).closest(".file-library-node");return b.editor.library.useTreeStyle?e.attr("data-path")==b.getMountFolder()?"folder-root":e.length?"true"==e.attr("data-is-directory")?"folder":"file":"default":e.length?"file-list":"default"}return""},getCurBlockType:function(){try{if(document.activeElement.hasAttribute&&document.activeElement.hasAttribute("tabindex"))return p(document.activeElement).closest("[mdtype]").attr("mdtype")||"";if(rangy.getSelection().rangeCount){var e=b.editor.selection.getRangy();return p(e.commonAncestorContainer).closest("[mdtype]").attr("mdtype")||""}}catch(e){}return""},freshLock:function(e){void 0!==e&&(b.isLocked=e),p("content input, selector").prop("readOnly",b.isLocked||!1),p(".CodeMirror").each(function(){this.CodeMirror&&(this.CodeMirror.options.readOnly=b.isLocked||!1)}),b.isLocked?(b.editor.tableEdit.unfocusAll(),p("[contenteditable=true]").attr("locked","true").attr("contenteditable","false"),p(b.editor.sessionStr).blur(),p(".md-expand").removeClass("md-expand")):p("[locked='true']").attr("locked","false").attr("contenteditable","true"),p("#md-searchpanel input").prop("readOnly",!1),b.freshMenu(),b.editor.sourceView.inSourceMode&&b.editor.sourceView.cm.focus(),setTimeout(function(){b.isMac&&y.touchBar&&y.touchBar.freshLock()},100)},setTheme:function(e){function t(){var e,t,n,i=window.getComputedStyle(document.body).backgroundColor.match(/[\d.]+/gi);function r(e){var t=Number(e).toString(16).toUpperCase();return 1==t.length?"0"+t:t}(i.length&&(b.isMac?y.window.setBackgroundColor(i[0],i[1],i[2],i[3]||256):y.setting.put("backgroundColor",(e=i[0],t=i[1],n=i[2],"#"+r(e)+r(t)+r(n))),b.colorBrightness=(299*i[0]+587*i[1]+114*i[2])/256e3),b.isMac)&&("true"!=(window.getComputedStyle(document.body).getPropertyValue("--typora-center-window-title")||"").trim()&&document.body.classList.contains("pin-outline")?y.window.setTitlebarTextMarginLeft(document.querySelector("#typora-sidebar").getBoundingClientRect().width):y.window.setTitlebarTextMarginLeft(void 0))}b.colorBrightness=1;var n=function(){setTimeout(t,100),b.editor.refresh(!0),b.isFocusMode&&b.editor.updateFocusMode(!1),b.isTypeWriterMode&&b.editor.setTypeWriterMode(!0,!0)};if(b.isMac){var i=document.getElementById("theme_css"),r=i.getAttribute("href"),o=y.setting.get("currentThemeFolder")||i.href.replace(/\/([a-z-]+)\.css$/i,"");if(e=(e=e||y.setting.get("theme")||"github").replace(/\s*([A-Z])/g,"-$1").replace(/^-/,"").toLowerCase(),y.setting.getBool("allow_custom_fontsize")){var a=(y.setting.getDouble("custom_fontsize")||16)+"";document.body.parentElement.style.fontSize=a+"px"}r!=e&&p.get(o+"/"+e+".css",function(){i.setAttribute("href",o+"/"+e+".css")}).then(function(){setTimeout(n,20)}),document.querySelector("#base_user_css").setAttribute("href",o+"/base.user.css"),document.querySelector("#theme_user_css").setAttribute("href",o+"/"+e+".user.css")}else if(b.isNode){var s=y.setting.getCurrentTheme(),l=y.getPath("userData"),c=b.isWin?"\\":"/";p("#theme_css").attr("href",[l,"themes",s].join(c)),setTimeout(n,20),document.querySelector("#base_user_css").setAttribute("href",[l,"themes","base.user.css"].join(c)),document.querySelector("#theme_user_css").setAttribute("href",[l,"themes",s.replace(/\.css$/,".user.css")].join(c)),b.isMacNode&&y.setting.refreshThemeMenu()}},getFileName:function(e){if(b.isMac){var t=y.document.currentFilePath(),n=y.document.currentFolderPath(),i=void 0;return t&&n&&(i=t.replace(n,"").replace(/^\//g,"")),i||(e?b.getSuggestedFileName():void 0)}return b.fileName||(e?b.getSuggestedFileName():void 0)},getSuggestedFileName:function(e){if(b.fileName)return b.fileName.replace(/\.[^.]+$/,"");if(e){var t=b.getFileName();if(t)return t.replace(/\.[^.]+$/,"")}b.editor.nodeMap.blocks;var n,i,r="",o="";try{(i=b.editor.docMenu.getMetaNode())&&(o=b.editor.docMenu.getValueInMeta("date",i)||"",o=(/\d+-\d+-\d+/g.exec(o)||/\d+\/\d+\/\d+/g.exec(o)||[""])[0],r=(r=b.editor.docMenu.getValueInMeta("title",i)||"").replace(/(^\s*("|'))|(("|')\s*)/gi,"").replace(/\s+(.)/gi,"-$1").toLocaleString(),r=o&&r?[o,r].join("-"):r),0!=r.trim().length&&"-"!=r||(n=p(p("#write h1, #write h2, #write h3")[0]),b.editor.sourceView.inSourceMode?60<(r=(r=b.editor.getMarkdown()).substr(0,r.indexOf("\n"))||r).length&&(r=r.substr(0,r.indexOf("."))||r):n.length?r=b.editor.UserOp.getDisplayText(n).replace(/\r?\n/gi,""):60<(r=(r=(n=p(p("[cid]:not(.md-meta-block)")[0])).length?b.editor.UserOp.getDisplayText(n):"").substr(0,r.indexOf("\n"))||r).length&&(r=r.substr(0,r.indexOf("."))||r)),120<r.length&&(r=r.substr(0,120))}catch(e){}return 0==r.trim().length&&(r=p.localize.getString("Untitled","Front")),a.removeInvalidPathCh(r.trim())||"Untitled"},setCanCollapsePinnedOutline:function(e){e?document.body.classList.remove("no-collapse-outline"):document.body.classList.add("no-collapse-outline")},refreshImageCopyStatus:function(e,t){e?(u&&clearTimeout(u),u=setTimeout(function(){r.doRefreshImageCopyStatus(t)},500)):r.doRefreshImageCopyStatus(t)},backupWindow:function(){if(b.isNode)if(b._onInitParse)b.needSaveState=!1;else try{if(!b.needSaveState||!b.editor.brush.timerID||!b.isActiveWindow())return;var e=b.fileHasModified&&b.changeCounter.isDocumentEdited();if(!e&&b.changeCounter.isDiscardableUntitled()&&!file.mountFolder_)return;e&&b.option.enableAutoSave&&b.saveUseNode(null,null,!0),e=b.fileHasModified&&b.changeCounter.isDocumentEdited();var t={path:b.filePath,encode:b.encode,hasUnsaved:e,scrollPos:p("content").scrollTop(),useCRLF:b.useCRLF,syncDate:new Date-0,mountFolder:b.mountFolder_,content:null};return e&&(b.editor.undo.completeSnap(!0),b.editor.store(null,!0),t.content=b.editor.getMarkdown()),reqnode("electron").ipcRenderer.send("addBackup",t),b.needSaveState=!1,t}catch(e){console.sendError(e.stack)}}},u=null,w=!1,x=function(){b.editor.brush.timerID&&b.isActiveWindow()&&w&&(w=!1,m.saveToRecover(b.editor.getMarkdown()))};b.ChangeType=h.ChangeType,b.isMac=void 0!==window.app,b.isNode=void 0!==window.reqnode,b.isMacNode=b.isNode&&"darwin"==process.platform,b.isMacOrMacNode=b.isMac||b.isMacNode,b.isNodeHtml=window.isOnWindowHtml,b.isWin=b.isNode&&"win32"==process.platform,b.isLinux=b.isNode&&"linux"==process.platform,b.isUnixNode=b.isLinux||b.isMacNode,b.FileInfoPanel=m,b.backupVersionWorker=x,b.freshMenu=r.freshMenu,b.bindMenu=r.bindMenu,b.MenuHelper=r,b.startAutoSaveAndBackupService=function(){if(b.isNode){c.getCurrentWindow().on("blur",b.backupWindow);var e=y.setting.config||{},t=Number.parseFloat(e.autoSaveTimer||3);t&&!Number.isNaN(t)||(t=3),setInterval(b.backupWindow,60*t*1e3),setInterval(x,6e5)}},b.isNode&&(b.fs=reqnode("fs"),b.startAutoSaveAndBackupService()),n.exports=b}),define("exoskeleton-master/exoskeleton",["jquery/jquery"],function(e,n){"use strict";var C,t=window,i=e("jquery/jquery"),r=t.Backbone,o=t.Exoskeleton,a=n.utils=C=C||{};n.$=i;var s=[],l=s.slice,u={}.toString;n.noConflict=function(){return t.Backbone=r,t.Exoskeleton=o,this},n.extend=function(e,t){var n,i=this;n=e&&C.has(e,"constructor")?e.constructor:function(){return i.apply(this,arguments)},C.extend(n,i,t);var r=function(){this.constructor=n};return r.prototype=i.prototype,n.prototype=new r,e&&C.extend(n.prototype,e),n.__super__=i.prototype,n};var c=function(t,n){var i=n.error;n.error=function(e){i&&i(t,e,n),t.trigger("error",t,e,n)}},d=function(e){return"function"==typeof C[e]};a.result=function(e,t){var n=e?e[t]:void 0;return"function"==typeof n?e[t]():n},a.defaults=function(n){return l.call(arguments,1).forEach(function(e){for(var t in e)void 0===n[t]&&(n[t]=e[t])}),n},a.extend=function(n){return l.call(arguments,1).forEach(function(e){for(var t in e)n[t]=e[t]}),n},a.clone=function(e){return!e instanceof Object?e:Array.isArray(e)?e.slice():a.extend({},e)};var p={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};a.escape=function(e){return null==e?"":String(e).replace(/[&<>"']/g,function(e){return p[e]})},a.sortBy=function(e,t,i){var r="function"==typeof t?t:function(e){return e[t]};return e.map(function(e,t,n){return{value:e,index:t,criteria:r.call(i,e,t,n)}}).sort(function(e,t){var n=e.criteria,i=t.criteria;if(n!==i){if(i<n||void 0===n)return 1;if(n<i||void 0===i)return-1}return e.index-t.index}).map(function(e){return e.value})};var h=0;a.uniqueId=function(e){var t=++h+"";return e?e+t:t},a.has=function(e,t){return Object.hasOwnProperty.call(e,t)};var f=function(e,t,n,i){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;var r=u.call(e);if(r!=u.call(t))return!1;switch(r){case"[object String]":return e==String(t);case"[object Number]":return e!==+e?t!==+t:0===e?1/e==1/t:e===+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var o=n.length;o--;)if(n[o]==e)return i[o]==t;var a=e.constructor,s=t.constructor;if(a!==s&&!("function"==typeof a&&a instanceof a&&"function"==typeof s&&s instanceof s))return!1;n.push(e),i.push(t);var l=0,c=!0;if("[object Array]"===r){if(c=(l=e.length)===t.length)for(;l--&&(c=f(e[l],t[l],n,i)););}else{for(var d in e)if(C.has(e,d)&&(l++,!(c=C.has(t,d)&&f(e[d],t[d],n,i))))break;if(c){for(d in t)if(C.has(t,d)&&!l--)break;c=!l}}return n.pop(),i.pop(),c};a.isEqual=function(e,t){return f(e,t,[],[])};var g=n.Events={on:function(e,t,n){return v(this,"on",e,[t,n])&&t&&(this._events||(this._events={}),(this._events[e]||(this._events[e]=[])).push({callback:t,context:n,ctx:n||this})),this},once:function(e,t,n){if(!v(this,"once",e,[t,n])||!t)return this;var i,r=this,o=function(){i||(i=!0,r.off(e,o),t.apply(this,arguments))};return o._callback=t,this.on(e,o,n)},off:function(e,t,n){var i,r,o,a,s,l,c,d;if(!this._events||!v(this,"off",e,[t,n]))return this;if(!e&&!t&&!n)return this._events=void 0,this;for(s=0,l=(a=e?[e]:Object.keys(this._events)).length;s<l;s++)if(e=a[s],o=this._events[e]){if(this._events[e]=i=[],t||n)for(c=0,d=o.length;c<d;c++)r=o[c],(t&&t!==r.callback&&t!==r.callback._callback||n&&n!==r.context)&&i.push(r);i.length||delete this._events[e]}return this},trigger:function(e){if(!this._events)return this;var t=l.call(arguments,1);if(!v(this,"trigger",e,t))return this;var n=this._events[e],i=this._events.all;return n&&y(n,t),i&&y(i,arguments),this},stopListening:function(e,t,n){var i=this._listeningTo;if(!i)return this;var r=!t&&!n;for(var o in n||"object"!=typeof t||(n=this),e&&((i={})[e._listenId]=e),i)(e=i[o]).off(t,n,this),!r&&Object.keys(e._events).length||delete this._listeningTo[o];return this}},m=/\s+/,v=function(e,t,n,i){if(!n)return!0;if("object"==typeof n){for(var r in n)e[t].apply(e,[r,n[r]].concat(i));return!1}if(m.test(n)){for(var o=n.split(m),a=0,s=o.length;a<s;a++)e[t].apply(e,[o[a]].concat(i));return!1}return!0},y=function(e,t){var n,i=-1,r=e.length,o=t[0],a=t[1],s=t[2];switch(t.length){case 0:for(;++i<r;)(n=e[i]).callback.call(n.ctx);return;case 1:for(;++i<r;)(n=e[i]).callback.call(n.ctx,o);return;case 2:for(;++i<r;)(n=e[i]).callback.call(n.ctx,o,a);return;case 3:for(;++i<r;)(n=e[i]).callback.call(n.ctx,o,a,s);return;default:for(;++i<r;)(n=e[i]).callback.apply(n.ctx,t);return}},b={listenTo:"on",listenToOnce:"once"};Object.keys(b).forEach(function(e){var i=b[e];g[e]=function(e,t,n){return n||"object"!=typeof t||(n=this),((this._listeningTo||(this._listeningTo={}))[e._listenId||(e._listenId=C.uniqueId("l"))]=e)[i](t,n,this),this}}),g.bind=g.on,g.unbind=g.off,C.extend(n,g);var k=n.Model=function(e,t){var n=e||{};t||(t={}),this.cid=C.uniqueId("c"),this.attributes=Object.create(null),t.collection&&(this.collection=t.collection),t.parse&&(n=this.parse(n,t)||{}),n=C.defaults({},n,C.result(this,"defaults")),this.set(n,t),this.changed=Object.create(null),this.initialize.apply(this,arguments)};if(C.extend(k.prototype,g,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(e){return C.extend({},this.attributes)},sync:function(){return n.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return C.escape(this.get(e))},has:function(e){return null!=this.get(e)},set:function(e,t,n){var i,r,o,a,s,l,c,d;if(null==e)return this;if("object"==typeof e?(r=e,n=t):(r={})[e]=t,n||(n={}),!this._validate(r,n))return!1;for(i in o=n.unset,s=n.broadcast,a=[],l=this._changing,this._changing=!0,l||(this._previousAttributes=C.extend(Object.create(null),this.attributes),this.changed={}),d=this.attributes,c=this._previousAttributes,this.idAttribute in r&&(this.id=r[this.idAttribute]),r)t=r[i],C.isEqual(d[i],t)||a.push(i),C.isEqual(c[i],t)?delete this.changed[i]:this.changed[i]=t,o?delete d[i]:d[i]=t;if(s){a.length&&(this._pending=n);for(var u=0,p=a.length;u<p;u++)this.trigger("change:"+a[u],this,d[a[u]],n)}if(l)return this;if(s)for(;this._pending;)n=this._pending,this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,C.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var n in this.attributes)t[n]=void 0;return this.set(t,C.extend({},e,{unset:!0}))},hasChanged:function(e){return null==e?!!Object.keys(this.changed).length:C.has(this.changed,e)},changedAttributes:function(e){if(!e)return!!this.hasChanged()&&C.extend(Object.create(null),this.changed);var t,n=!1,i=this._changing?this._previousAttributes:this.attributes;for(var r in e)C.isEqual(i[r],t=e[r])||((n||(n={}))[r]=t);return n},previous:function(e){return null!=e&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return C.extend(Object.create(null),this._previousAttributes)},fetch:function(t){void 0===(t=t?C.extend({},t):{}).parse&&(t.parse=!0);var n=this,i=t.success;return t.success=function(e){if(!n.set(n.parse(e,t),t))return!1;i&&i(n,e,t),n.trigger("sync",n,e,t)},c(this,t),this.sync("read",this,t)},save:function(e,t,n){var i,r,o,a=this.attributes;if(null==e||"object"==typeof e?(i=e,n=t):(i={})[e]=t,n=C.extend({validate:!0},n),i&&!n.wait){if(!this.set(i,n))return!1}else if(!this._validate(i,n))return!1;i&&n.wait&&(this.attributes=C.extend(Object.create(null),a,i)),void 0===n.parse&&(n.parse=!0);var s=this,l=n.success;return n.success=function(e){s.attributes=a;var t=s.parse(e,n);if(n.wait&&(t=C.extend(i||{},t)),t&&"object"==typeof t&&!s.set(t,n))return!1;l&&l(s,e,n),s.trigger("sync",s,e,n)},c(this,n),"patch"===(r=this.isNew()?"create":n.patch?"patch":"update")&&(n.attrs=i),o=this.sync(r,this,n),i&&n.wait&&(this.attributes=a),o},destroy:function(t){t=t?C.extend({},t):{};var n=this,i=t.success,r=function(){n.trigger("destroy",n,n.collection,t)};if(t.success=function(e){(t.wait||n.isNew())&&r(),i&&i(n,e,t),n.isNew()||n.trigger("sync",n,e,t)},this.isNew())return t.success(),!1;c(this,t);var e=this.sync("delete",this,t);return t.wait||r(),e},url:function(){var e=C.result(this,"urlRoot")||C.result(this.collection,"url")||function(){throw new Error('A "url" property or function must be specified')}();return this.isNew()?e:e.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(e){return this._validate({},C.extend(e||{},{validate:!0}))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=C.extend(Object.create(null),this.attributes,e);var n=this.validationError=this.validate(e,t)||null;return!n||(this.trigger("invalid",this,n,C.extend(t,{validationError:n})),!1)}}),C.keys){["keys","values","pairs","invert","pick","omit"].filter(d).forEach(function(t){k.prototype[t]=function(){var e=l.call(arguments);return e.unshift(this.attributes),C[t].apply(C,e)}})}var w=n.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),void 0!==t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,C.extend({broadcast:!0},t))},S={add:!0,remove:!0,merge:!0},x={add:!0,remove:!1};if(C.extend(w.prototype,g,{model:void 0===k?null:k,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return n.sync.apply(this,arguments)},add:function(e,t){return this.set(e,C.extend({merge:!1},t,x))},remove:function(e,t){var n,i,r,o,a=!Array.isArray(e);for(t||(t={}),n=0,i=(e=a?[e]:e.slice()).length;n<i;n++)(o=e[n]=this.get(e[n]))&&(delete this._byId[o.id],delete this._byId[o.cid],r=this.indexOf(o),this.models.splice(r,1),this.length--,t.broadcast&&(t.index=r,o.trigger("remove",o,this,t)),this._removeReference(o,t));return a?e[0]:e},set:function(e,t){(t=C.defaults({},t,S)).parse&&(e=this.parse(e,t));var n,i,r,o,a,s,l,c=!Array.isArray(e);e=c?e?[e]:[]:e.slice();var d=t.at,u=this.model,p=this.comparator&&null==d&&!1!==t.sort,h="string"==typeof this.comparator?this.comparator:null,f=[],g=[],m={},v=t.add,y=t.merge,b=t.remove,w=!(p||!v||!b)&&[];for(n=0,i=e.length;n<i;n++){if(r=(a=e[n]||{})instanceof k?o=a:a[u.prototype.idAttribute||"id"],s=this.get(r))b&&(m[s.cid]=!0),y&&(a=a===o?o.attributes:a,t.parse&&(a=s.parse(a,t)),s.set(a,t),p&&!l&&s.hasChanged(h)&&(l=!0)),e[n]=s;else if(v){if(!(o=e[n]=this._prepareModel(a,t)))continue;f.push(o),this._addReference(o,t)}o=s||o,!w||!o.isNew()&&m[o.id]||w.push(o),m[o.id]=!0}if(b){for(n=0,i=this.length;n<i;++n)m[(o=this.models[n]).cid]||g.push(o);g.length&&this.remove(g,t)}if(f.length||w&&w.length)if(p&&(l=!0),this.length+=f.length,null!=d)for(n=0,i=f.length;n<i;n++)this.models.splice(d+n,0,f[n]);else{w&&(this.models.length=0);var x=w||f;for(n=0,i=x.length;n<i;n++)this.models.push(x[n])}if(l&&this.sort({broadcast:!1}),t.broadcast){for(n=0,i=f.length;n<i;n++)(o=f[n]).trigger("add",o,this,t);(l||w&&w.length)&&this.trigger("sort",this,t)}return c?e[0]:e},reset:function(e,t){t||(t={});for(var n=0,i=this.models.length;n<i;n++)this._removeReference(this.models[n],t);return t.previousModels=this.models,this._reset(),e=this.add(e,C.extend({broadcast:!1},t)),t.broadcast&&this.trigger("reset",this,t),e},push:function(e,t){return this.add(e,C.extend({at:this.length},t))},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return this.add(e,C.extend({at:0},t))},shift:function(e){var t=this.at(0);return this.remove(t,e),t},slice:function(){return l.apply(this.models,arguments)},get:function(e){if(null!=e)return this._byId[e]||this._byId[e.id]||this._byId[e.cid]},at:function(e){return this.models[e]},where:function(n,e){return n&&Object.keys(n).length?this[e?"find":"filter"](function(e){for(var t in n)if(n[t]!==e.get(t))return!1;return!0}):e?void 0:[]},findWhere:function(e){return this.where(e,!0)},sort:function(e){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return e||(e={}),"string"==typeof this.comparator||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(this.comparator.bind(this)),e.broadcast&&this.trigger("sort",this,e),this},pluck:function(t){return this.models.map(function(e){return e.get(t)})},fetch:function(n){void 0===(n=n?C.extend({},n):{}).parse&&(n.parse=!0);var i=n.success,r=this;return n.success=function(e){var t=n.reset?"reset":"set";r[t](e,n),i&&i(r,e,n),r.trigger("sync",r,e,n)},c(this,n),this.sync("read",this,n)},create:function(e,n){if(n=n?C.extend({},n):{},!(e=this._prepareModel(e,n)))return!1;n.wait||this.add(e,n);var i=this,r=n.success;return n.success=function(e,t){n.wait&&i.add(e,n),r&&r(e,t,n)},e.save(null,n),e},parse:function(e,t){return e},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId=Object.create(null)},_prepareModel:function(e,t){if(e instanceof k)return e;var n=new(((t=C.extend({},t)).collection=this).model)(e,t);return n.validationError?(this.trigger("invalid",this,n.validationError,t),!1):n},_addReference:function(e,t){null!=(this._byId[e.cid]=e).id&&(this._byId[e.id]=e),e.collection||(e.collection=this),e.on("all",this._onModelEvent,this)},_removeReference:function(e,t){this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,i){("add"!==e&&"remove"!==e||n===this)&&("destroy"===e&&this.remove(t,i),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],null!=t.id&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments))},toArray:function(){return this.models||[]}}),d("each")){["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain"].filter(d).forEach(function(t){w.prototype[t]=function(){var e=l.call(arguments);return e.unshift(this.models),C[t].apply(C,e)}});["groupBy","countBy","sortBy"].filter(d).forEach(function(i){w.prototype[i]=function(t,e){var n="function"==typeof t?t:function(e){return e.get(t)};return C[i](this.models,n,e)}})}else["forEach","map","filter","some","every","reduce","reduceRight","indexOf","lastIndexOf"].forEach(function(n){w.prototype[n]=function(e,t){return this.models[n](e,t)}}),w.prototype.find=function(i,r){var o;return this.some(function(e,t,n){if(i.call(r,e,t,n))return o=e,!0}),o},["sortBy"].forEach(function(i){w.prototype[i]=function(t,e){var n="function"==typeof t?t:function(e){return e.get(t)};return C[i](this.models,n,e)}});return["Model","Collection","Router","View","History"].forEach(function(e){var t=n[e];t&&(t.extend=n.extend)}),C.extend(n,g),n}),define("app/document/StringUtils",[],function(e,t,n){"use strict";var i=/^[\s\u200b]+$/,r=function(e){return null==e||null==e||""===e||"​"===e},o=function(e,t,n){return null==e||null==e||""==e?"":("string"!=typeof e&&"number"!=typeof e||(e=(e+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),t&&(e=a(e))),e)},a=function(e){return e.replace(/[[\]~`*\\$<]/g,"\\$&").replace(/(\b_)|(_(?=\s))/g,"\\$&")},s=/^\s*(([\w-_]+:\/\/)|(www\.)|\w*\/)[\w-.\/?%&=:@]*/i,l=/^\s*(([\w-_]+:\/\/)|(www\.)|\w*\/)?[\w-.\/?%&=:@]+(\.jpe?g|png|gif|webm|svg|tiff)/i,c=function(e,t,n){return e.replace(new RegExp("\\b"+t+"\\b","gi"),n)},d=function(e,t){var n=e.getHours()+"",i=e.getMinutes()+"",r=e.getSeconds()+"";return(n.length<2?"0":"")+n+":"+(i.length<2?"0":"")+i+(t?(r.length<2?"0":"")+r:"")},u=function(e,t){if(!e)return t;t=t||"";var n=e.split("/"),i=t.split("/");n.pop();for(var r=0;r<i.length;r++)"."!=i[r]&&(".."==i[r]?n.pop():n.push(i[r]));return n.join("/")};String.prototype.replaceExact=function(e,t){return c(this,e,t)},String.prototype.repeat=function(e){return(!$.isNumeric(e)||e<0)&&(console.sendError("String.prototype.repeat only accepts non-nagitive number"),e=0),new Array(e-0+1).join(this)},String.prototype.startsWith=String.prototype.startsWith||function(e){return this.match("^"+e)===e},String.prototype.endsWith=String.prototype.endsWith||function(e){return this.match(e+"$")===e},String.prototype.format=function(){var t=arguments;return this.replace(/\{\d+\}/g,function(e){return t[e.match(/\d+/)]})},String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};for(var p=[{base:"A",letters:"AⒶＡÀÁÂẦẤẪẨÃĀĂẰẮẴẲȦǠÄǞẢÅǺǍȀȂẠẬẶḀĄȺⱯ"},{base:"AA",letters:"Ꜳ"},{base:"AE",letters:"ÆǼǢ"},{base:"AO",letters:"Ꜵ"},{base:"AU",letters:"Ꜷ"},{base:"AV",letters:"ꜸꜺ"},{base:"AY",letters:"Ꜽ"},{base:"B",letters:"BⒷＢḂḄḆɃƂƁ"},{base:"C",letters:"CⒸＣĆĈĊČÇḈƇȻꜾ"},{base:"D",letters:"DⒹＤḊĎḌḐḒḎĐƋƊƉꝹ"},{base:"DZ",letters:"ǱǄ"},{base:"Dz",letters:"ǲǅ"},{base:"E",letters:"EⒺＥÈÉÊỀẾỄỂẼĒḔḖĔĖËẺĚȄȆẸỆȨḜĘḘḚƐƎ"},{base:"F",letters:"FⒻＦḞƑꝻ"},{base:"G",letters:"GⒼＧǴĜḠĞĠǦĢǤƓꞠꝽꝾ"},{base:"H",letters:"HⒽＨĤḢḦȞḤḨḪĦⱧⱵꞍ"},{base:"I",letters:"IⒾＩÌÍÎĨĪĬİÏḮỈǏȈȊỊĮḬƗ"},{base:"J",letters:"JⒿＪĴɈ"},{base:"K",letters:"KⓀＫḰǨḲĶḴƘⱩꝀꝂꝄꞢ"},{base:"L",letters:"LⓁＬĿĹĽḶḸĻḼḺŁȽⱢⱠꝈꝆꞀ"},{base:"LJ",letters:"Ǉ"},{base:"Lj",letters:"ǈ"},{base:"M",letters:"MⓂＭḾṀṂⱮƜ"},{base:"N",letters:"NⓃＮǸŃÑṄŇṆŅṊṈȠƝꞐꞤ"},{base:"NJ",letters:"Ǌ"},{base:"Nj",letters:"ǋ"},{base:"O",letters:"OⓄＯÒÓÔỒỐỖỔÕṌȬṎŌṐṒŎȮȰÖȪỎŐǑȌȎƠỜỚỠỞỢỌỘǪǬØǾƆƟꝊꝌ"},{base:"OI",letters:"Ƣ"},{base:"OO",letters:"Ꝏ"},{base:"OU",letters:"Ȣ"},{base:"OE",letters:"Œ"},{base:"oe",letters:"œ"},{base:"P",letters:"PⓅＰṔṖƤⱣꝐꝒꝔ"},{base:"Q",letters:"QⓆＱꝖꝘɊ"},{base:"R",letters:"RⓇＲŔṘŘȐȒṚṜŖṞɌⱤꝚꞦꞂ"},{base:"S",letters:"SⓈＳẞŚṤŜṠŠṦṢṨȘŞⱾꞨꞄ"},{base:"T",letters:"TⓉＴṪŤṬȚŢṰṮŦƬƮȾꞆ"},{base:"TZ",letters:"Ꜩ"},{base:"U",letters:"UⓊＵÙÚÛŨṸŪṺŬÜǛǗǕǙỦŮŰǓȔȖƯỪỨỮỬỰỤṲŲṶṴɄ"},{base:"V",letters:"VⓋＶṼṾƲꝞɅ"},{base:"VY",letters:"Ꝡ"},{base:"W",letters:"WⓌＷẀẂŴẆẄẈⱲ"},{base:"X",letters:"XⓍＸẊẌ"},{base:"Y",letters:"YⓎＹỲÝŶỸȲẎŸỶỴƳɎỾ"},{base:"Z",letters:"ZⓏＺŹẐŻŽẒẔƵȤⱿⱫꝢ"},{base:"a",letters:"aⓐａẚàáâầấẫẩãāăằắẵẳȧǡäǟảåǻǎȁȃạậặḁąⱥɐ"},{base:"aa",letters:"ꜳ"},{base:"ae",letters:"æǽǣ"},{base:"ao",letters:"ꜵ"},{base:"au",letters:"ꜷ"},{base:"av",letters:"ꜹꜻ"},{base:"ay",letters:"ꜽ"},{base:"b",letters:"bⓑｂḃḅḇƀƃɓ"},{base:"c",letters:"cⓒｃćĉċčçḉƈȼꜿↄ"},{base:"d",letters:"dⓓｄḋďḍḑḓḏđƌɖɗꝺ"},{base:"dz",letters:"ǳǆ"},{base:"e",letters:"eⓔｅèéêềếễểẽēḕḗĕėëẻěȅȇẹệȩḝęḙḛɇɛǝ"},{base:"f",letters:"fⓕｆḟƒꝼ"},{base:"g",letters:"gⓖｇǵĝḡğġǧģǥɠꞡᵹꝿ"},{base:"h",letters:"hⓗｈĥḣḧȟḥḩḫẖħⱨⱶɥ"},{base:"hv",letters:"ƕ"},{base:"i",letters:"iⓘｉìíîĩīĭïḯỉǐȉȋịįḭɨı"},{base:"j",letters:"jⓙｊĵǰɉ"},{base:"k",letters:"kⓚｋḱǩḳķḵƙⱪꝁꝃꝅꞣ"},{base:"l",letters:"lⓛｌŀĺľḷḹļḽḻſłƚɫⱡꝉꞁꝇ"},{base:"lj",letters:"ǉ"},{base:"m",letters:"mⓜｍḿṁṃɱɯ"},{base:"n",letters:"nⓝｎǹńñṅňṇņṋṉƞɲŉꞑꞥ"},{base:"nj",letters:"ǌ"},{base:"o",letters:"oⓞｏòóôồốỗổõṍȭṏōṑṓŏȯȱöȫỏőǒȍȏơờớỡởợọộǫǭøǿɔꝋꝍɵ"},{base:"oi",letters:"ƣ"},{base:"ou",letters:"ȣ"},{base:"oo",letters:"ꝏ"},{base:"p",letters:"pⓟｐṕṗƥᵽꝑꝓꝕ"},{base:"q",letters:"qⓠｑɋꝗꝙ"},{base:"r",letters:"rⓡｒŕṙřȑȓṛṝŗṟɍɽꝛꞧꞃ"},{base:"s",letters:"sⓢｓßśṥŝṡšṧṣṩșşȿꞩꞅẛ"},{base:"t",letters:"tⓣｔṫẗťṭțţṱṯŧƭʈⱦꞇ"},{base:"tz",letters:"ꜩ"},{base:"u",letters:"uⓤｕùúûũṹūṻŭüǜǘǖǚủůűǔȕȗưừứữửựụṳųṷṵʉ"},{base:"v",letters:"vⓥｖṽṿʋꝟʌ"},{base:"vy",letters:"ꝡ"},{base:"w",letters:"wⓦｗẁẃŵẇẅẘẉⱳ"},{base:"x",letters:"xⓧｘẋẍ"},{base:"y",letters:"yⓨｙỳýŷỹȳẏÿỷẙỵƴɏỿ"},{base:"z",letters:"zⓩｚźẑżžẓẕƶȥɀⱬꝣ"}],h={},f=0;f<p.length;f++)for(var g=p[f].letters,m=0;m<g.length;m++)h[g[m]]=p[f].base;var v={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"'":"\\'","\\":"\\\\"},y={"&newline;":null,"&tab;":"\t","&copy;":"©","&amp;":"&","&gt":">","&lt":"<","&num;":"#"},b=document.createElement("textarea");function w(e,t){var n=/\.[^.\\\/]+$/,i=(n.exec(e)||[""])[0],r=(n.exec(e)||[""])[0];function o(e){for(var t,n,i=new Array,r=0,o=-1,a=0;t=(n=e.charAt(r++)).charCodeAt(0);){var s=46==t||48<=t&&t<=57;s!==a&&(i[++o]="",a=s),i[o]+=n}return i}i.length&&i==r&&(e=e.replace(n,""),t=t.replace(n,""));for(var a=o(e),s=o(t),l=0;a[l]&&s[l];l++)if(a[l]!==s[l]){var c=Number(a[l]),d=Number(s[l]);return c==a[l]&&d==s[l]?c-d:a[l].localeCompare(s[l])}return a.length-s.length}w.insensitive=!0;var x=[[768,879],[1155,1158],[1160,1161],[1425,1469],[1471,1471],[1473,1474],[1476,1477],[1479,1479],[1536,1539],[1552,1557],[1611,1630],[1648,1648],[1750,1764],[1767,1768],[1770,1773],[1807,1807],[1809,1809],[1840,1866],[1958,1968],[2027,2035],[2305,2306],[2364,2364],[2369,2376],[2381,2381],[2385,2388],[2402,2403],[2433,2433],[2492,2492],[2497,2500],[2509,2509],[2530,2531],[2561,2562],[2620,2620],[2625,2626],[2631,2632],[2635,2637],[2672,2673],[2689,2690],[2748,2748],[2753,2757],[2759,2760],[2765,2765],[2786,2787],[2817,2817],[2876,2876],[2879,2879],[2881,2883],[2893,2893],[2902,2902],[2946,2946],[3008,3008],[3021,3021],[3134,3136],[3142,3144],[3146,3149],[3157,3158],[3260,3260],[3263,3263],[3270,3270],[3276,3277],[3298,3299],[3393,3395],[3405,3405],[3530,3530],[3538,3540],[3542,3542],[3633,3633],[3636,3642],[3655,3662],[3761,3761],[3764,3769],[3771,3772],[3784,3789],[3864,3865],[3893,3893],[3895,3895],[3897,3897],[3953,3966],[3968,3972],[3974,3975],[3984,3991],[3993,4028],[4038,4038],[4141,4144],[4146,4146],[4150,4151],[4153,4153],[4184,4185],[4448,4607],[4959,4959],[5906,5908],[5938,5940],[5970,5971],[6002,6003],[6068,6069],[6071,6077],[6086,6086],[6089,6099],[6109,6109],[6155,6157],[6313,6313],[6432,6434],[6439,6440],[6450,6450],[6457,6459],[6679,6680],[6912,6915],[6964,6964],[6966,6970],[6972,6972],[6978,6978],[7019,7027],[7616,7626],[7678,7679],[8203,8207],[8234,8238],[8288,8291],[8298,8303],[8400,8431],[12330,12335],[12441,12442],[43014,43014],[43019,43019],[43045,43046],[64286,64286],[65024,65039],[65056,65059],[65279,65279],[65529,65531],[68097,68099],[68101,68102],[68108,68111],[68152,68154],[68159,68159],[119143,119145],[119155,119170],[119173,119179],[119210,119213],[119362,119364],[917505,917505],[917536,917631],[917760,917999]],C={nul:0,control:0,tabSize:4};var k=function(e,t){return 0===e?t.nul:9===e?t.tabSize:e<32||127<=e&&e<160?t.control:function(e){var t,n=0,i=x.length-1;if(e<x[0][0]||e>x[i][1])return!1;for(;n<=i;)if(t=Math.floor((n+i)/2),e>x[t][1])n=t+1;else{if(!(e<x[t][0]))return!0;i=t-1}return!1}(e)?0:1+(4352<=e&&(e<=4447||9001==e||9002==e||11904<=e&&e<=42191&&12351!=e||44032<=e&&e<=55203||63744<=e&&e<=64255||65040<=e&&e<=65049||65072<=e&&e<=65135||65280<=e&&e<=65376||65504<=e&&e<=65510||131072<=e&&e<=196605||196608<=e&&e<=262141))};t.decodeHtmlEntity=function(e){e=e.toLowerCase();var t=y[e];return t||(b.innerHTML=e,(t=b.value)!=e?y[e]=t:t=null),t},t.formateDateTime=function(e){return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()+"  "+d(e)},t.formateTimeOnly=d,t.formateDateOnly=function(e){return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()},t.insert=function(e,t,n){return t<(e=e||"").length?e.substring(0,t)+n+e.substring(t):e+n},t.escape=function(e,t,n){e=o(e,t);return File.option.noPreWrap&&(e=e.replace(/(^ )|( $)/g," ").replace(/  /g,"  ")),e},t.escapeForPreWrap=o,t.unescape=function(e){return null==e||null==e||""==e?"":(e+"").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'")},t.escapeHead=function(e){return e.replace(/(^ *)((#+)|(\+ +)|(\- +)|(\* +)|(\d+\. +)|(```|~~~)|(>)|(-+\s*$))/,"$1\\$2")},t.escapeMark=a,t.escapeSelector=function(e){if(window.CSS&&CSS.escape)return CSS.escape(e);for(var t,n=String(e),i=n.length,r=-1,o="",a=n.charCodeAt(0);++r<i;)0!=(t=n.charCodeAt(r))?o+=1<=t&&t<=31||127==t||0==r&&48<=t&&t<=57||1==r&&48<=t&&t<=57&&45==a?"\\"+t.toString(16)+" ":0==r&&1==i&&45==t||!(128<=t||45==t||95==t||48<=t&&t<=57||65<=t&&t<=90||97<=t&&t<=122)?"\\"+n.charAt(r):n.charAt(r):o+="�";return o},t.escapeRegExp=function(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},t.isNullOrEmpty=r,t.isNotNullOrEmpty=function(e){return!r(e)},t.isNullOrBlank=function(e){return null==e||null==e||""===e||i.exec(e)},t.replaceExact=c,t.splitExact=function(e,t){return e.split(new RegExp("\\b"+t+"\\b","gi"))},t.trimArr=function(e){if(e&&e.length){for(var t=0,n=e.length-1;0===e[t].trim().length&&t<n;)t++;for(;t<n&&0===e[n].trim().length;)n--;return e.slice(t,n+1)}return e},t.isURL=function(e){return!!s.exec(e)},t.isImg=function(e){return!!l.exec(e)},t.camelize=function(e){return e.replace(/(?:^|_|-)(\w)/g,function(e,t,n){return 0==n?t.toLowerCase():t.toUpperCase()})},t.getRelativePath=function(e,t,n){if(!e)return t;var i;if(File.isNode)return""==(i=reqnode("path").relative(e,t))&&(i="./"),i;e=e.replace(/\\\\/g,"/").replace(/^\.\//,"");var r,o=(t=t.replace(/\\\\/g,"/")).split(/\//g),a=e.split(/\//g),s=o.pop(),l="";for(""==a.last()&&a.pop(),""==a[0]&&a.shift(),""==o[0]&&o.shift(),r=o.join("/");0!==r.indexOf(a.join("/"));)a.pop(),l+="../";var c=o.slice(a.length);return c.length&&(l+=c.join("/")+"/"),i=l+s,n&&!i.match(/^\.\.\//)&&(i="./"+i),i},t.getAbsolutePath=u,t.getAbsoluteURL=function(e,t){if(!t)return"";var n=t.replace(/^[\\\/]{2}/,"http://");return e=e||"",n.match(/^[^:]+:\/\//)?n:n.match(/^[\\\/]/)?e.replace(/(^[^:]+:\/\/[^\/]+)\/.*/,"$1"+t):u(e,n)},t.useOrDefault=function(e,t){return e.trim().length?e:t},t.removeDiacritics=function(e){return(e||"").replace(/[^\u0000-\u007E]/g,function(e){return h[e]||e})},t.escapeInQuote=function(e){return e.replace(/["'\\\b\t\n\f\r]/g,function(e){return v[e]}).replace(/\u200b/g,"")},t.pathByDeleteLastComponent=function(e){return File.isMac?e.split("/").slice(0,-1).join("/"):reqnode("path").join(e,"..")},t.getFolder=function(e){return File.isMac?(e.replace(/[\/]+$/,"").split("/")||[]).last():reqnode("path").basename(e)},t.date2NatrualLang=function(e,t){var n,i,r,o,a,s=new Date,l=(s-e)/1e3;return l<30?n="just now":l<60?n="1 minutes ago":l<3600?n=Math.floor((l+30)/60).toString()+" minutes ago":l<18e3&&s.getDay()==e.getDay()?n=[(9<(i=e.getHours())?"":"0")+i,(9<(r=e.getMinutes())?"":"0")+r].join(":"):l<172800&&s.getDay()==(e.getDay()+1)%7?n=t?"Yesterday":"yesterday":l<518400?n=Math.floor(l/86400)+" days ago":s.getYear()==e.getYear()?(a=e.getDate(),n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()]+" "+(9<a?"":"0")+a):(o=e.getMonth()+1,a=e.getDate(),n=[e.getFullYear(),(9<o?"":"0")+o,(9<a?"":"0")+a].join("-")),n},t.abbreviatingWithTilde=function(e){return File.isMac?app.path.abbreviatingWithTilde(e):File.isUnixNode?reqnode("fs-plus").tildify(e):e},t.naturalSort=w,t.wcswidth=function(e){if(!e)return 0;var t,n,i,r=0;if("string"!=typeof e)return k(e,C);for(var o=0;o<e.length;o++){if(55296<=(t=e.charCodeAt(o))&&t<=56319&&(56320<=(n=e.charCodeAt(++o))&&n<=57343?t=1024*(t-55296)+(n-56320)+65536:o--),(i=k(t,C))<0)return-1;r+=i}return r},t.removeInvalidPathCh=function(e){return e.replace(/[\u200b\u0000~\u0019\u007f~\u009f\\\/<>:"|?*]/g,"").replace(/[\t\r\n]/g," ").replace(/([ .]+)$/,"")},t.isFullUrl=function(e){return/^([a-z][a-z0-9+\-.]+):([^\/\/]{2}|\/{2})/i.exec(e)},t.escapeURL=function(e){return e=e||"",encodeURI(e.replace(/\\/g,"/")).replace(/'/,"%27").replace('"',"%22").replace(/#/g,"%23")},t.WESTERN_WORD_SPLITER=/([\u3040-\uABFF\uD7A4-\uFAFF\s!-#%-\*,-\/:;\?@\[-\]\{\}\xA1\xA7\xAB\xB6\xB7\xBB\xBF\u037E\u0387\u055A-\u055F\u0589\u058A\u05BE\u05C0\u05C3\u05C6\u05F3\u05F4\u0609\u060A\u060C\u060D\u061B\u061E\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u09FD\u0AF0\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F3A-\u0F3D\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u1400\u166D\u166E\u169B\u169C\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u2010-\u2027\u2030-\u2043\u2045-\u2051\u2053-\u205E\u207D\u207E\u208D\u208E\u2308-\u230B\u2329\u232A\u2768-\u2775\u27C5\u27C6\u27E6-\u27EF\u2983-\u2998\u29D8-\u29DB\u29FC\u29FD\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00-\u2E2E\u2E30-\u2E49\u3001-\u3003\u3008-\u3011\u3014-\u301F\u3030\u303D\u30A0\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA8FC\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uABEB\uFD3E\uFD3F\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE61\uFE63\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0A\uFF0C-\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3B-\uFF3D\uFF3F\uFF5B\uFF5D\uFF5F-\uFF65])/,t.NOT_WORD=/[\s!-#%-\*,-\/:;\?@\[-\]\{\}\xA1\xA7\xAB\xB6\xB7\xBB\xBF\u037E\u0387\u055A-\u055F\u0589\u058A\u05BE\u05C0\u05C3\u05C6\u05F3\u05F4\u0609\u060A\u060C\u060D\u061B\u061E\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u09FD\u0AF0\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F3A-\u0F3D\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u1400\u166D\u166E\u169B\u169C\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u2010-\u2027\u2030-\u2043\u2045-\u2051\u2053-\u205E\u207D\u207E\u208D\u208E\u2308-\u230B\u2329\u232A\u2768-\u2775\u27C5\u27C6\u27E6-\u27EF\u2983-\u2998\u29D8-\u29DB\u29FC\u29FD\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00-\u2E2E\u2E30-\u2E49\u3001-\u3003\u3008-\u3011\u3014-\u301F\u3030\u303D\u30A0\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA8FC\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uABEB\uFD3E\uFD3F\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE61\uFE63\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0A\uFF0C-\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3B-\uFF3D\uFF3F\uFF5B\uFF5D\uFF5F-\uFF65]/}),define("app/editor/UndoManager",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node"],function(e,t,n){"use strict";var i=e("exoskeleton-master/exoskeleton"),w=(e("app/document/StringUtils"),e("app/document/Node")),x=w.Node,C=w.TYPE,o={ADD:1,REPLACE:2,DELETE:-1,DELETE_ACCROSS_BLOCK:-2,HAS_UNDO_TO_PREPEND:-9},r=i.Model.extend({commandStack:void 0,index:void 0,undoManagerContext:!1,stackSize:100,UndoManager:r,initialize:function(e){this.commandStack=[],this.stackSize=100,this.set({index:-1}),this.editor=e,this.UndoManager=r,this.clearSnap()},reset:function(){this.commandStack=[],this.stackSize=100,this.set({index:-1}),this.clearSnap()},restoreFromJson:function(e){this.set("index",e.index),this.commandStack=JSON.parse(e.commandStackJson)},storeToJson:function(){return{index:this.get("index"),commandStackJson:JSON.stringify(this.commandStack)}},callCommand:function(e,t){var n,i;try{if(t)for(var r=e.undo.length-1;-1<r;r--)i=this.exeCommand(e.undo[r],e.redo),n||(n=void 0===n?i:!!i);else for(r=0;r<e.redo.length;r++)i=this.exeCommand(e.redo[r],e.undo),n||(n=void 0===n?i:!!i)}catch(e){console.error(e.stack)}return n}});r.prototype.register=function(e,t,n,i){!this.undoManagerContext&&e&&("sync"!==n&&(this.commandStack.splice(this.get("index")+1,this.commandStack.length-this.get("index")),this.commandStack.length>this.stackSize&&this.commandStack.splice(0,this.commandStack.length-this.stackSize),i?this.commandStack.unshift(e):this.commandStack.push(e),this.set({index:this.commandStack.length-1})),t||"sync"!==n&&"restore"!==n&&File.updateChangeCount(File.ChangeType.NSChangeDone),"undo"!==n&&"input"!==n&&this.editor.syncChange(e.redo))},r.prototype.lastRegisteredOperationCommand=function(){return this.commandStack.length==this.get("index")+1?this.commandStack[this.get("index")]:null},r.prototype.removeLastRegisteredOperationCommand=function(){this.commandStack.length==this.get("index")+1&&(this.commandStack.pop(),this.set({index:this.get("index")-1}))},r.prototype.undoLastDiscardable=function(){if(!this.editor.sourceView.inSourceMode&&!File.isLocked){if(this.completeSnap(!0),"INPUT"==document.activeElement.tagName&&"checkbox"!=document.activeElement.getAttribute("type"))return!0;var e=this.commandStack[this.get("index")];e&&e.discardable&&this.undo()}},r.prototype.undo=function(e){if(this.editor.sourceView.inSourceMode)return this.editor.sourceView.cm.undo(),e&&e.preventDefault();if(this.completeSnap(!0),"INPUT"==document.activeElement.tagName&&e&&"checkbox"!=document.activeElement.getAttribute("type")){var t=document.activeElement,n=t.value,i=this;return setTimeout(function(){n==t.value&&i.undo()},50),!0}e&&e.preventDefault();var r=this.commandStack[this.get("index")];if(r){this.editor.brush.pause();var o=this.callCommand(r,!0);this.set({index:this.get("index")-1}),File.updateChangeCount(File.ChangeType.NSChangeUndone),o&&(this.editor.quickRefresh(),this.editor.selection.scrollAdjust()),this.editor.brush.resume(!0),void 0===o?this.undo():(this.editor.refocus(void 0,null,null,!0),this.editor.syncChange(r.undo.clone().reverse()))}},r.prototype.redo=function(e){if(this.editor.sourceView.inSourceMode)return this.editor.sourceView.cm.redo(),e&&e.preventDefault();if("INPUT"==document.activeElement.tagName&&e&&"checkbox"!=document.activeElement.getAttribute("type")){var t=document.activeElement,n=t.value,i=this;return setTimeout(function(){n==t.value&&i.redo()},50),!0}if(e&&e.preventDefault(),!this.snapFlag){var r=this.commandStack[this.get("index")+1];if(r){this.editor.brush.pause();var o=this.callCommand(r,!1);this.set({index:this.get("index")+1}),File.updateChangeCount(File.ChangeType.NSChangeRedone),o&&(this.editor.quickRefresh(),this.editor.selection.scrollAdjust()),this.editor.brush.resume(!0),void 0===o?this.redo():(this.editor.refocus(void 0,null,null,!0),this.editor.syncChange(r.redo))}}},r.prototype.hasUndo=function(){return!(!this.snapFlag&&-1===this.get("index"))},r.prototype.hasRedo=function(){return!(this.snapFlag||!(this.get("index")<this.commandStack.length-1))},r.prototype.exeCommand=function(i,r,e){var o,t,n,a=this.editor,s=!1,l=a.sourceView.inSourceMode;function c(t,n){n=n||[],t=t||a.nodeMap,i.json.map(function(e){n.push(x.readFromJson(e,t,!0))}),i.json.map(function(e){var t=a.getNode(e.id);t.set("before",a.getNode(e.relation.before_id)),t.set("after",a.getNode(e.relation.after_id)),t.set("parent",a.getNode(e.relation.parent_id))})}if(i){switch(i.type){case"initSrc":if(l)return;a.brush.queue=[],s=!1,File.reloadContent(i.src,!0,!0,!0,!0,!0);break;case"reload":if(l)return;a.nodeMap.reset(a),c(),a.brush.queue=[],s=!0,$(a.sessionStr).html(w.NodeCollectionUtils.toHTML(a.nodeMap.blocks)),a.focusCid=null,a.lastCursor=null,window.getSelection().removeAllRanges(),File.fileEncode=i.encode;break;case"replace":if(l)return;if(!(n=a.getNode(i.id)))return console.error(i.id+" not found in  replace");n.get("type")==n.TYPE.fences&&a.fences.beforeDeleteFences(n,r),n.get("type")==n.TYPE.math_block&&a.mathBlock.beforeDeleteFences(n,r),i.id!=i.json.id?(a.getNode(i.id).remove(),n=x.readFromJson(i.json,a.nodeMap)):n.readFromJson(i.json,a.nodeMap),a.findElemById(i.id).replaceWith(a.MarkParser.renderHtmlWithBlockMeta(n,a.brush)),File.inBusyMode||a.writingArea.setAttribute("contenteditable","true"),s=!0,a.brush.restart(),!e&&a.brush.addToQueue(n.id,!0);break;case"insert":if(l)return;var d=a.nodeMap,u=new Array,p=[];if(c(d,u),i.after&&(p=a.findElemById(i.after)).before(w.NodeCollectionUtils.toHTML(u)),!p.length&&i.before&&(p=a.findElemById(i.before)).after(w.NodeCollectionUtils.toHTML(u)),!p.length){var h=u[0].get("parent");h?a.findElemById(h.id).replaceWith(h.toHTML()):0===$(a.sessionStr).children().length&&($(a.sessionStr).html(w.NodeCollectionUtils.toHTML(u)),a.focusCid=null,a.lastCursor=null)}s=!0;break;case"remove":if(l)return;i.idArray.map(function(e){var t=a.getNode(e);x.isType(t,C.fences)&&a.fences.beforeDeleteFences(t,r),x.isType(t,C.math_block)&&a.mathBlock.beforeDeleteFences(t,r);var n=(o=a.findElemById(e)).parent("li");n.length&&n.css("margin","0.1px"),o.remove(),n.length&&n.css("margin",""),t&&t.remove()}),s=!0;break;case"text":if(l)return;o=a.findElemById(i.id),a.getNode(i.id).set("text",i.text),i.html&&o.html(i.html),s=!1,"def-footnote"!=o.attr("mdtype")&&"def-link"!=o.attr("mdtype")||(s=!0),!e&&a.brush.addToQueue(i.id,!0);break;case"cursor":if(e)return;if(l)return void(i.inSourceMode&&a.sourceView.cm.setCursor(i.pos));if(i.inSourceMode)return;try{if(null==i.end&&(i.end=i.start),null==i.startId&&null==i.id&&(i.id=i.cid),i.focus)return setTimeout(function(){a.findElemById(i.id).children("[tabindex]").andSelf("[tabindex]").focus()},100),a.findElemById(i.id).children("[tabindex]").andSelf("[tabindex]").focus(),!1;if(i.id||i.startId==i.endId){var f;if(i.id=i.id||i.startId,(o=a.findElemById(i.id)).attr("mdtype")==C.fences||o.attr("mdtype")==C.math_block)o.attr("mdtype")==C.fences?(a.fences.refreshEditor(),(f=a.fences.getCm(i.id)).focus()):f=a.mathBlock.startEditing(o,!0),i.selections&&i.selections.length?f.setSelection(i.selections[0].head,i.selections[0].anchor):i.pos?(f.setCursor(i.pos),i.selections&&f.setSelections(i.selections)):-1<i.start?(f.setCursor(f.posFromIndex(i.start)),-1<i.end&&f.setSelection(f.posFromIndex(i.start),f.posFromIndex(i.end))):a.selection.jumpIntoElemEnd(o);else if(o.length&&void 0!==i.end){var g=o.text().length;i.start>g&&(i.start=g),i.end>g&&(i.end=g),a.selection.restoreSelection(o[0],{start:i.start,end:i.end})}else window.getSelection().removeAllRanges();r||a.refocus(i.id)}else if(i.startId){File.inBusyMode&&!File.isLocked&&a.writingArea.setAttribute("contenteditable","true");try{var m=a.selection.restoreEdge(a.findElemById(i.startId),i.start);m=a.selection.restoreEdge(a.findElemById(i.endId),i.end,!0,m),a.selection.setRange(m),a.refocus()}catch(e){console.log(e.stack)}}File.isTypeWriterMode&&a.selection.scrollAdjust(),s=!1}catch(e){console.warn(e.stack)}break;case"fences":if(l)return;n=a.getNode(i.id),x.isType(n,n.TYPE.math_block)?(a.mathBlock.startEditing(i.id),t=a.mathBlock.currentCm):t=a.fences.getCm(i.id),t.focus(),"undo"==i.cmd&&t.undo(),"redo"==i.cmd&&t.redo(),s=!1;break;case"fences-pos":if(l||e)return;n=a.getNode(i.id),x.isType(n,n.TYPE.math_block)?(a.mathBlock.startEditing(i.id),t=a.mathBlock.currentCm):(a.fences.refreshEditor(),t=a.fences.getCm(i.id)),t.focus(),t.setCursor(i.pos),s=!1;break;case"attr":if(l)return;i.value=i.value||!1,(n=this.editor.getNode(i.id)).attr(i.key,i.value,this.editor,!0),!e&&a.brush.addToQueue(i.id,!0);break;case"wrap":if(l)return;var v={type:"insert"};v.json=[i.json],i.json.children.map(function(e,t){var n=a.getNode(e.id);0===t?v.before=n.get("before")?n.get("before").id:null:t===i.json.children.length-1&&(v.after=n.get("after")?n.get("after").id:null),n&&(n.get("type")==n.TYPE.fences&&(s=!0,a.fences.beforeDeleteFences(n,r)),n.get("type")==n.TYPE.math_block&&(s=!0,a.mathBlock.beforeDeleteFences(n,r)),n.remove(),a.findElemById(e.id).remove())}),this.exeCommand(v,r);break;case"unwrap":if(l)return;var y=(n=a.getNode(i.id)).unwrap();!i.skipHTML&&a.findElemById(i.id).replaceWith(w.NodeCollectionUtils.toHTML(y)),s=!0;break;case"scroll":if(l||e)return;a.selection.scrollAdjust(i.id?a.findElemById(i.id):void 0,i.marginTop);break;case"sync":if(!e)return;if(void 0!==i.html)a.findElemById(i.id).html(i.html).find(".md-expand, .md-focus, .md-focus-p").removeClass("md-expand md-focus md-focus-p");else if(void 0!==i.allHtml)a.nodeMap.reset(),c(),$("#write").html(i.allHtml);else if(void 0!==i.cmChanges)t=a.fences.getCm(i.id),i.cmChanges.forEach(function(e){t.replaceRange(e.text,e.from,e.to)});else{if(void 0!==i.tex)return(n=a.getNode(i.id)).set("text",i.tex),a.findElemById(i.id).replaceWith(n.toHTML()),!0;if(void 0!==i.srcChanges)l&&i.srcChanges.forEach(function(e){a.sourceView.cm.replaceRange(e.text,e.from,e.to)});else if(void 0!==i.content){if(l&&!i.fromSourceMode){var b=a.sourceView.cm.getScrollInfo().top;a.sourceView.cm.setValue(i.content,"sync"),a.sourceView.cm.scrollTo(0,b)}!l&&i.fromSourceMode&&(a.nodeMap.reset(),a.reset(i.content))}}default:return}return s}},r.prototype.clearSnap=function(){this.snapNode={},this.snapFlag=0,this.snapDate=0,this.snapSelection=null},r.prototype.completeSnap=function(e,t){if(e&&!this.snapFlag||!this.snapNode||!this.snapNode.id)return this.snapFlag=0;var n=null;return this.snapFlag==o.HAS_UNDO_TO_PREPEND?(n=a,t||this.register(n,!1),a=null,this.clearSnap(),n):(n=r.makeEmptyCommand(),x.isType(this.snapNode.content.type,C.fences,C.math_block)?void 0:(this.snapSelection&&n.undo.push(this.snapSelection),n.undo.push({type:"replace",id:this.snapNode.id,json:this.snapNode}),this.buildSnap(this.snapNode.id,0),n.redo.push({type:"replace",id:this.snapNode.id,json:this.snapNode}),this.snapSelection&&n.redo.push(this.snapSelection),t||this.register(n,!0,"input"),this.snapFlag=0,n))},r.prototype.buildSnap=function(e,t,n){this.snapSelection=this.editor.selection.buildUndo();var i=this.editor.getNode(e);if(!i)return this.clearSnap();null!=n?i.set("text",n):this.editor.store(e,!0),this.snapNode=i.storeToJson(),this.snapFlag=t||0,this.snapDate=(new Date).getTime()};var a,s=null;r.prototype.noStashedUndo=function(){return this.snapFlag!==o.HAS_UNDO_TO_PREPEND},r.prototype.stashUndo=function(e){a?r.append(a,e):a=e,this.snapFlag=o.HAS_UNDO_TO_PREPEND},r.prototype.clearEventTimer=function(){s&&clearTimeout(s),s=null},r.prototype.snap=function(e,t,n,i){var r=this;this.snapFlag==o.HAS_UNDO_TO_PREPEND&&(this.completeSnap(),File.updateChangeCount(File.ChangeType.NSChangeDone)),!e&&this.snapNode&&(e=this.snapNode.id),e?(this.snapFlag?(this.snapNode.id!=e?(this.completeSnap(),(t||n)&&this.buildSnap(e,t,n),File.updateChangeCount(File.ChangeType.NSChangeDone)):t!=this.snapFlag||this.snapFlag==o.REPLACE?(this.completeSnap(),File.updateChangeCount(File.ChangeType.NSChangeDone)):t&&this.snapDate&&1e3<(new Date).getTime()-this.snapDate&&(this.completeSnap(),File.updateChangeCount(File.ChangeType.NSChangeDone)),this.snapFlag=t):t&&(this.buildSnap(e,t,n),File.updateChangeCount(File.ChangeType.NSChangeDone)),t&&!i&&(this.clearEventTimer(),t==o.DELETE_ACCROSS_BLOCK?(this.editor.selection.scrollAdjust(),s=null):s=setTimeout(function(){r.editor.findElemById(e).trigger("inline-input"),s=null},50))):this.clearSnap()},r.prototype.buildReplaceUndo=function(e){return r.buildReplaceUndo(e)},r.buildReplaceUndo=function(e,t){if(!e)throw new Error("empty node");return{type:"replace",id:t||e.id,json:e.storeToJson()}},r.addUndoForInsert=function(e,t,n,i){t&&(e.redo.push({type:"insert",after:i?i.id:t.get("after")?t.get("after").id:null,before:n?n.id:t.get("before")?t.get("before").id:null,json:[t.storeToJson()]}),e.undo.push({type:"remove",idArray:[t.id]}))},r.addUndoForWrap=function(e,t,n){t&&(e.redo.push({type:"wrap",json:t.storeToJson(),skipHTML:n}),e.undo.push({type:"unwrap",id:t.id,skipHTML:n}))},r.addUndoForUnwrap=function(e,t){t&&(e.undo.push({type:"wrap",json:t.storeToJson()}),e.redo.push({type:"unwrap",id:t.id}))},r.buildAllDoc=function(e,t){var n=e.blocks.at(0),i=[];for(n=n.getLastBrother(!0);n;)i.push(n.storeToJson()),n=n.get("after");return{type:"reload",json:i,reloadFromDisk:t,encode:File.fileEncode}},r.addUndoForInsertArray=function(e,t,n,i){t&&0!=t.length&&(e.redo.push({type:"insert",after:i?i.id:t[t.length-1].get("after")?t[t.length-1].get("after").id:null,before:n?n.id:t[0].get("before")?t[0].get("before").id:null,json:t.reduce(function(e,t){return e.push(t.storeToJson()),e},[])}),e.undo.push({type:"remove",idArray:t.reduce(function(e,t){return e.push(t.id),e},[])}))},r.addUndoForRemoveArray=function(e,t,n,i){t&&0!=t.length&&(e.undo.push({type:"insert",after:i?i.id:t[t.length-1].get("after")?t[t.length-1].get("after").id:null,before:n?n.id:t[0].get("before")?t[0].get("before").id:null,json:t.reduce(function(e,t){return e.push(t.storeToJson()),e},[])}),e.redo.push({type:"remove",idArray:t.reduce(function(e,t){return e.push(t.id),e},[])}))},r.addUndoForRemove=function(e,t,n,i){e.undo.push({type:"insert",after:i?i.id:t.get("after")?t.get("after").id:null,before:n?n.id:t.get("before")?t.get("before").id:null,json:[t.storeToJson()]}),e.redo.push({type:"remove",idArray:[t.id]})},r.makeEmptyCommand=function(e){var t={undo:[],redo:[]};return e&&t.undo.push(e),t},r.isEmptyCommand=function(e){return!(e&&e.undo&&e.redo&&(e.undo.length||e.redo.length))},r.append=function(e,t){return t&&(e.undo=e.undo.concat(t.undo),e.redo=e.redo.concat(t.redo)),e},x.storeToJson=function(n){var i={content:{},relation:{}};return i.children=new Array,x.property.map(function(e){var t=n.get(e);null!=t&&(t instanceof Array?i.content[e]=$.merge([],t):typeof t==Object?i.content[e]=$.extend({},t):i.content[e]=t)}),i.relation.before_id=n.get("before")?n.get("before").id:null,i.relation.after_id=n.get("after")?n.get("after").id:null,i.relation.parent_id=n.get("parent")?n.get("parent").id:null,i.is_top=!!n.get("attachTo"),n.get("children").toArray().map(function(e){var t=x.storeToJson(e);i.children.push(t)}),i.id=n.id,i},x.readFromJson=function(e,n,t){var i,r,o=(i=e.id,(r=n.allNodes.get(i))&&!r.attributes&&(console.assert(null,"node deleted"),r.attributes={}),r||new x({id:e.id}));return o.set("in",n),e.is_top&&o.set("attachTo",n),x.property.map(function(e){o.attributes[e]=void 0}),o.set(e.content),o.clearChildren(!0),e.relation.parent_id||o.set("attachTo",n),e.children.map(function(e){x.readFromJson(e,n,!0)}),e.children.map(function(e){var t=n.allNodes.get(e.id);t.set("before",n.allNodes.get(e.relation.before_id)),t.set("after",n.allNodes.get(e.relation.after_id)),t.set("parent",o)}),t||(o.set("before",n.allNodes.get(e.relation.before_id)),o.set("after",n.allNodes.get(e.relation.after_id)),o.set("parent",n.allNodes.get(e.relation.parent_id))),o},x.prototype.storeToJson=function(){return x.storeToJson(this)},x.prototype.readFromJson=function(e,t){this.clearChildren();var n=x.readFromJson(e,t||this.get("in"));this.replaceWith(n)},r.SnapFlag=o,n.exports=r}),define("app/document/Node",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils"],function(e,t,n){"use strict";var i=e("exoskeleton-master/exoskeleton"),r=e("app/document/StringUtils"),o={paragraph:"paragraph",heading:"heading",blockquote:"blockquote",fences:"fences",hr:"hr",def_link:"def_link",def_footnote:"def_footnote",table:"table",raw_edit:"raw_edit",meta_block:"meta_block",math_block:"math_block",list:"list",toc:"toc",iframe:"iframe"},a={list_item:"list_item",table_row:"table_row",table_cell:"table_cell",line:"line"},c={};i.utils.extend(c,o,a,{plain:"plain",strong:"strong",em:"em",code:"code",underline:"underline",escape:"escape",autolink:"autolink",reflink:"reflink",refimg:"refimg",link:"link",url:"url",br:"br",tag:"tag",comment:"comment",atag:"atag",imgtag:"imgtag",del:"del",todo:"todo",image:"image",footnote:"footnote",attr:"attr",emoji:"emoji",inline_math:"inline_math",subscript:"subscript",superscript:"superscript",linebreak:"linebreak",highlight:"highlight",html_entity:"html_entity",pants:"pants"});var s=0,d=function(){return"n"+s++},u=i.Model.extend({initialize:function(){var e=this.get("id")||d();this.get("id")||this.set("id",e),u.pool[e]&&console.warn("Duplicate Model"),(u.pool[e]=this).TYPE=c,this.set("text",this.get("text")||""),this.set("broadcast",!1),this.set("children",new l)},isBlock:function(e){return u.isBlock(this.get("type"),e)},isTopBlock:function(){return this.get("attachTo")&&!this.get("parent")},isVirtualBlock:function(){return u.isVirtualBlock(this.get("type"))},getClosetBlock:function(e){return this.isBlock(e)?this:this.get("parent").getClosetBlock(e)},getTopBlock:function(){return this.isTopBlock()?this:this.get("parent").getTopBlock()},isInline:function(){return!this.isBlock(!0)},getLastChild:function(){try{return this.get("children").at(this.get("children").length-1).getLastBrother(!1)}catch(e){return null}},getFirstChild:function(){try{return this.get("children").at(0).getLastBrother(!0)}catch(e){return null}},escapedMark:function(e){return e.replace(/\*/g,"*").replace(/_/g,"_").replace(/`/g,"`")},isLoose:function(e){function t(e){for(var t=e.getFirstChild(),n=0,i=0;t;){if(u.isType(t,c.paragraph))n++;else{if(!u.isType(t,c.list))return!0;if(u.isType(t.get("after"),c.paragraph)||t.isLoose())return!0;i++}t=t.get("after")}return!(n<=1&&i<=1)}for(var n=this.getFirstChild(),i=n,r=!1;i;){if(t(i)){r=!0;break}i=i.get("after")}if(e)for(i=n;i;)i.set("tight",!r),i=i.get("after");return r},safeGetStrAttr:function(e,t){if("href-title"==e)return this.safeGetStrAttr("href")+" "+this.safeGetStrAttr("title");var n=this.get(e)?this.get(e):"";return t?r.escape(n):n},replaceWith:function(e){e.id!=this.id&&(e.get("after")&&e.get("after").set("before",e.get("before")),e.get("before")&&e.get("before").set("after",e.get("after")),e.set("parent",this.get("parent")),e.set("before",this.get("before")),e.set("after",this.get("after")),this.remove())},giveChildrenTo:function(e,t,n,i){if(0!=this.get("children").length){var r=t||this.getFirstChild();for(i&&(t=t||r,n=n||this.getLastChild(),t.get("before")&&t.get("before").set("after",n.get("after")),t.set("before",null),t.set("in",this.get("in")),n.set("after",null),n.set("in",this.get("in")));r;)r.set("parent",e),r=r.get("after")}},append:function(e,t){if(e)return e.detach(),this.get("children").length?t?this.getFirstChild().insert(e,!0):this.getLastChild().insert(e):(e.set("in",this.get("in")),e.set("parent",this)),e},appendTillEnd:function(e){if(e)for(var t=null,n=this.getLastChild();t=e.get("after"),e.detach(),n?n.insert(e):(e.set("parent",this),e.set("in",this.get("in"))),n=e,e=t;);},insertTillEnd:function(e){if(e)for(var t=null,n=this;t=e.get("after"),e.detach(),n.insert(e),n=e,e=t;);},insert:function(e,t){if(e){if(e instanceof Array)return console.warning("deprecate, use insertArray"),this.insertArray(e,t);var n=t?"before":"after";return this.get(n)!==e&&(e.detach(),e.set(n,this.get(n)),this.set(n,e)),e.set("in",this.get("in")),e.set("parent",this.get("parent")),e.set("attachTo",this.get("attachTo")),e}},insertArray:function(e,t,n){if(e&&e.length){var i=t?"before":"after",r=n?e[0]:e[0].getLastBrother(!0),o=n?e.last():e.last().getLastBrother(!1);"before"===i?(r.set("before",this.get("before")),o.set("after",this)):(o.set("after",this.get("after")),r.set("before",this));for(var a=0;a<e.length;a++)e[a].set("in",this.get("in")),e[a].set("parent",this.get("parent")),e[a].set("attachTo",this.get("attachTo")),n&&0<a&&e[a].set("before",e[a-1]);return r}},clearChildren:function(){this.get("in");this.get("children").forEach(function(e){e.delete()})},canContainBlock:function(e){return u.canContainBlock(this.get("type"),e)},canNotDirectEdit:function(){return u.isType(this,c.hr,c.math_block,c.list,c.list_item,c.toc)},getText:function(t,e){var n=[],i=this.get("children");return e=e||"",this.canContainBlock(!0)||i&&0<i.length?(i.forEach(function(e){n.push(e.getText(t))}),n=n.join(e),this.unset("text")):(n=this.get("text")||"",t&&u.isType(this,c.heading,c.paragraph,c.line)&&(n=r.escapeHead(n))),n},getNthChild:function(e){try{for(var t=this.get("children").at(0).getLastBrother(!0),n=0;t&&n<e;)n++,t=t.get("after");return t}catch(e){}return null},getChildIndex:function(){for(var e=this.get("before"),t=0;e;)e=e.get("before"),t++;return t},getVeryFirst:function(e,t){return 0==this.get("children").length||t&&u.isType(this,c.paragraph)?this:(e?this.getLastChild():this.getFirstChild()).getVeryFirst(e,t)},getLastBrother:function(e,t,n){var i=e?"before":"after",r=this.get("in").blocks;if(this.isTopBlock()){if(t)return null;if(!n&&r.length)return r.at(e?0:r.length-1).getLastBrother(e,!1,!0)}return this.get(i)?this.attributes[i].getLastBrother(e,t,!0):this},getVeryFirstBrotherIncludeTopBlock:function(e){return this.getVeryFirstBrother(e,!0)},getVeryFirstBrother:function(e,t){var n=e?"before":"after";return!t&&this.isTopBlock()?null:!this.get(n)&&this.get("parent")?this.get("parent").getVeryFirstBrother(e,t):this.get(n)?this.get(n).getVeryFirst(e):null},getClosetParagraphLevel:function(){return u.isType(this.get("parent"),c.paragraph)?this.get("parent"):this},contains:function(e){return!!e&&(this.id==e.id||this.contains(e.get("parent")))},closest:function(){for(var e=this.get("type"),t=0;t<arguments.length;t++)if(e==arguments[t])return this;var n=this.get("parent");return n?u.prototype.closest.apply(n,arguments):null},isStyled:function(){var e=this.get("type");return e==c.strong||e==c.em||e==c.code},isSeperated:function(){var e=this.get("type");return this.canNotDirectEdit()||e==c.code||e==c.escape},isDeleted:function(){return null==this.attributes},delete:function(e){this.attributes&&(this.set("parent",null),this.set("after",null),this.set("before",null),this.set("in",null),e?this.get("children").toArray().map(function(e){e.attributes.parent=null}):this.clearChildren()),u.pool[this.cid]=void 0,this.attributes=void 0},remove:function(e){var t=this.get("before"),n=this.get("after");this.delete(e),t&&t.set("after",n),n&&n.set("before",t)},detach:function(){var e=this.get("before"),t=this.get("after");e&&e.set("after",t),t&&t.set("before",e),this.set("parent",null),this.set("attachTo",null)},clearEmptyChar:function(){var e=this.attributes.text;e&&(e=e.replace(/\u200B/g,""),this.get("type")==c.line&&/\u200b +/.exec(this.attributes.text)&&(e="​"+e),this.attributes.text=e)},get:function(e){if(!this.attributes)return console.stackError("attributes for node has been deleted"),null;var t=this.attributes[e];switch(e){case"text":return t=t||"",u.isType(this,c.math_block)&&(t=t.replace(/^(\w*)\$\$(\w*)$/m,"$1\\$$$$$2")),t;default:return t}},set:function(n,i){var e,r,o=this,a=this.get("in"),t=function(e){e&&e.attributes&&(u.isType(e,c.blockquote,c.list_item)?e.unset("userIndent"):u.isType(e,c.list)&&!e.get("isFixed")&&s(e),t(e.get("parent")))},s=function(e){if(e&&e.attributes&&!e.get("type")!=c.list&&e.attributes.style)for(var t=e.getFirstChild();t;)t.unset("userIndent"),t=t.get("after")};if("string"==typeof n){switch(r=this.get(n),n){case"parent":r&&r.attributes&&(r.get("children").remove(this),t(r)),i&&i.get("children").add(this);break;case"before":r&&r.attributes&&(r.attributes.after=null),i&&(i&&i.attributes.after&&i.attributes.after.attributes&&(i.attributes.after.attributes.before=null),i.attributes.after=this);break;case"after":r&&r.attributes&&(r.attributes.before=null),i&&(i&&i.attributes.before&&i.attributes.before.attributes&&(i.attributes.before.attributes.after=null),i.attributes.before=this);break;case"attachTo":r&&r.blocks.remove(this),i&&i.blocks.add(this);break;case"in":var l=this.get("attachTo");r&&(r.foot_list.remove(this),r.link_list.remove(this),r.blocks.remove(this),r.allNodes.remove(this)),i&&(this.get("type")!=c.def_footnote||i.foot_list.get(this.id)?this.get("type")!=c.def_link||i.link_list.get(this.id)||i.link_list.push(this):i.foot_list.push(this),i.allNodes.add(this),l&&this.set("attachTo",l));break;case"id":i&&(this.id=i,this.cid=i);break;case"ref":i=i?i.replace(/\u200b/gi,"").replace(/\\?\]/gi,"\\]"):i;break;case"href":i=i&&this.get("type")===c.def_link?i.replace(/\[|\]|"]/gi,""):i;break;case"title":break;case"type":i!=r&&(p.forEach(function(e){this.attributes[e]=void 0},this),this.attributes.ahead=void 0,this.attributes.tail=void 0,this.attributes.mathLabel=void 0,this.attributes.mathEqLabel=void 0);break;case"text":(function(e){if(this.get("type")==c.table_cell&&void 0!==this.attributes.text){var t=(e||"").length-(this.attributes.text||"").length;if(t){u.tryResetTable(this.closest(c.table));var n=this.attributes.marginLeft,i=this.attributes.marginRight,r=0;n&&(i.length>n.length&&(r=Math.min(i.length-1,t),i=i.substring(0,i.length-r),t-=r),0<t&&n.length>i.length&&(r=Math.min(n.length-1,t),n=n.substring(0,n.length-r)),!i&&n.length&&(n=i=" "),this.attributes.marginLeft=n,this.attributes.marginRight=i)}}}).call(this,i);break;case"style":s(this)}this.attributes[n]=i,function(){var e=this.get("in")||a,t="type"===n&&r===c.heading||this.get("type")==c.heading&&u.isType(n,"depth","text","parent","before","after");e&&e.toc&&r!=i&&t&&("text"==n?setTimeout(function(){e.toc.updateHeaderText(o)},10):e.toc.refresh(!1)),this.get("type")===c.def_link&&r!=i&&("ref"===n?(File.editor.imgEdit.willUpdateImgRef(r),File.editor.imgEdit.willUpdateImgRef(i)):"text"===n&&File.editor.imgEdit.willUpdateImgRef(this.get("ref"))),e&&e.toc&&"type"==n&&i==c.toc&&setTimeout(function(){e.toc.refresh()},20)}.call(this),function(){var e=this.get("in")||a;"type"===n&&e&&(r===c.def_footnote&&e.foot_list.remove(this),r===c.def_link&&e.link_list.remove(this),i===c.def_footnote&&e.foot_list.push(this),i===c.def_link&&e.link_list.push(this)),u.isType(this.get("type"),c.def_link,c.def_link)&&File.editor.docMenu.resizeFooter()}.call(this),function(){this.get("in");(this.get("type")==c.meta_block&&"text"==n||"type"==n&&(r==c.meta_block||i==c.meta_block))&&File.isNode&&File.refreshImageCopyStatus(!0)}.call(this)}else{for(e in this.id||n.id||(n.id=d()),n.id&&this.set("id",n.id),n.in&&this.set("in",n.in),n.attachTo&&this.set("attachTo",n.attachTo),n.type&&this.set("type",n.type),n)-1==["id","in","attachTo","type","marginLeft","marginRight"].indexOf(e)&&u.prototype.set.call(this,e,n[e]);void 0!==n.marginLeft&&(this.set("marginLeft",n.marginLeft),this.set("marginRight",n.marginRight))}return this}}),p=["depth","lang","pattern","align","style","checked","history","alt","attr","prespace","subindent","markindent","marginLeft","marginRight","alignText","userText","userIndent","isFixed"];u.property=["text","type","ahead","tail","header","href","title","ref","start","width","height"].concat(p),u.isBlock=function(e,t){return o[e]||t&&a[e]},u.isVirtualBlock=function(e){return a[e]},u.canContainBlock=function(e,t){return e==c.blockquote||e==c.list||e==c.list_item||t&&(e==c.table_row||e==c.table)},u.noChangeLine=function(e){for(var t=e;t;){if(u.isType(e,c.table_cell,c.def_footnote,c.def_link))return!0;t=t.get("parent")}return!1},u.isType=function(e){if(null!=e&&!1!==e){var t="object"==typeof e&&e.attributes?e.attributes.type:e;if(arguments[1]instanceof Array)return u.isType.apply(null,[t].concat(arguments[1]));for(var n=1;n<arguments.length;n++)if(t==arguments[n])return!0;return!(1<arguments.length)&&void 0}};var l=function(){this.reset(),Object.defineProperty(this,"length",{get:function(){return this._set.length}})};l.prototype.get=function(e){return this._map.get(e)},l.prototype.add=function(e){e.cid&&this._map.set(e.cid,e),this._set.push(e)},l.prototype.remove=function(e){this._set.remove(e),e.cid&&this._map.delete(e.cid)},l.prototype.at=function(e){return this._set[e]},l.prototype.first=function(){return this._set[0]},l.prototype.sortedFirst=function(){for(var e=this.first();e&&e.get("before");)e=e.get("before");return e},l.prototype.toArray=function(){return this._set.clone()},l.prototype.reset=function(){this._set=[],this._map=new Map},l.prototype.forEach=function(e,t){this._set.clone().forEach(e,t)},l.prototype.map=function(e,t){return this._set.clone().map(e,t)},l.prototype.sortedForEach=function(e,t){for(var n=this.sortedFirst();n;)e.call(t,n),n=n.get("after")},l.prototype.update=function(e){e.cid&&this._map.set(e.cid,e)},u.pool={};var h={toHTML:function(e){var t=[],n="";if(e.length){var i=e instanceof Array,r=i?e[0]:e.at(0);if(!i)for(;r.get("before");)r=r.get("before");for(u.isType(r,c.line)&&File.option.ignoreLineBreak&&(n="\n");t.push(r.toHTML()),(r=r.get("after"))&&(!i||-1<e.indexOf(r)););}return t.join(n||"")}},f=function(){this.blocks=new l,this.allNodes=new l,this.foot_list=[],this.link_list=[]};f.prototype.storeToJson=function(){return{blocks:this.blocks.map(function(e){return e.storeToJson()}),nid:s}},f.prototype.restoreFromJson=function(n){this.reset(),n.blocks.map(function(e){return u.readFromJson(e,this,!0)},this).map(function(e,t){e.set("before",this.allNodes.get(n.blocks[t].relation.before_id)),e.set("after",this.allNodes.get(n.blocks[t].relation.after_id))},this),s=n.nid-0,this.toc&&this.toc.refresh(!0,!0)},f.prototype.get=function(e){switch(e){case"allNodes":return this.allNodes;case"blocks":return this.blocks}},f.prototype.reset=function(e,t){this.blocks.forEach(function(e){e.delete()}),this.blocks.reset(),!e&&this.allNodes.length&&console.warn("nodeMap not clean"),this.allNodes.reset(),this.foot_list instanceof Array?(this.foot_list=[],this.link_list=[]):(this.foot_list.reset(),this.link_list.reset()),u.pool={},t&&(s=0)},f.prototype.getFirst=function(){return this.blocks.sortedFirst()},f.prototype.getLast=function(){if(0<this.blocks.length){var e=this.blocks.at(this.blocks.length-1);return e=e.getLastBrother(!1)}return null},u.backToParagraphBeforeDelete=[c.heading,c.def_footnote,c.def_link,c.meta_block,c.fences],u.ListType={ol:"ol",ul:"ul",task:"tasklist"},t.Node=u,t.NodeMap=f,t.NodeCollection=l,t.NodeCollectionUtils=h,t.TYPE=c,u.TYPE=c}),define("app/editor/polyfill",["jquery/jquery"],function(e,t,n){"use strict";var i=e("jquery/jquery");if(window.app&&(window.open=function(e,t){app.window.openLink(e)}),"performance"in window==0&&(window.performance=window.performance||{offset:Date.now(),now:function(){return Date.now()-this.offset}}),Element.prototype.insertChildAtIndex=function(e,t){t||(t=0),t>=this.children.length?this.appendChild(e):this.insertBefore(e,this.children[t])},DocumentFragment.prototype.insertChildAtIndex=function(e,t){t||(t=0),t>=this.children.length?this.appendChild(e):this.insertBefore(e,this.children[t])},Number.isNaN||(Number.isNaN=window.isNaN),Number.parseInt||(Number.parseInt=window.parseInt),!window.Set){var r=function(){this.set=[]};r.prototype.add=function(e){-1==!this.has(e)&&this.set.push(e)},r.prototype.delete=function(e){this.has(e)&&this.set.splice(this.set.indexOf(e))},r.prototype.has=function(e){return-1<this.set.indexOf(e)},window.Set=r}if(!window.Map){var o=function(){this.map={}};o.prototype.get=function(e){return this.map[e]},o.prototype.delete=function(e){delete this.map[e]},o.prototype.set=function(e,t){this.map[e]=t},window.Map=o}[].fill||Object.defineProperty(Array.prototype,"fill",{value:function(e){for(var t=Object(this),n=parseInt(t.length),i=arguments[1],r=parseInt(i)||0,o=r<0?Math.max(n+r,0):Math.min(r,n),a=arguments[2],s=void 0===a?n:parseInt(a)||0,l=s<0?Math.max(n+s,0):Math.min(s,n);o<l;o++)t[o]=e;return t}}),[].find||Object.defineProperty(Array.prototype,"find",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var i=arguments[1],r=0;r<n;){var o=t[r];if(e.call(i,o,r,t))return o;r++}}}),Object.defineProperty(Array.prototype,"remove",{value:function(e){var t=this.indexOf(e);if(~t)return this.splice(t,1)}}),Object.defineProperty(Array.prototype,"removeFirstIf",{value:function(e){for(var t=this.length;t--;)if(e(this[t],t))return void this.splice(t,1)}}),Object.defineProperty(Array.prototype,"removeIf",{value:function(e){for(var t=this.length;t--;)e(this[t],t)&&this.splice(t,1)}}),Object.defineProperty(Array.prototype,"repeat",{value:function(e,t){for(;t;)this[--t]=e;return this}}),Object.defineProperty(Array.prototype,"last",{value:function(){return this.length?this[this.length-1]:void 0}}),Object.defineProperty(Array.prototype,"lastDef",{value:function(){for(var e=this.length-1;0<=e;e--)if(null!=this[e])return this[e]}}),Object.defineProperty(Array.prototype,"clone",{value:function(){return this.slice(0)}}),window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=function(e,t){t=t||window;for(var n=0;n<this.length;n++)e.call(t,this[n],n,this)}),i.fn.visibleText=function(){if(0===this.length)return"";if(1===this.length&&(3===this[0].nodeType||0===this[0].childElementCount))return this.text();var n="";return i.each(this.contents(),function(e,t){3===t.nodeType?n+=t.textContent:1===t.nodeType&&(t.offsetHeight||t.offsetWidth)&&(n+=i(t).visibleText())}),n},window.console&&function(){var n;console.stack=function(e){(new Error).stack},console.stackError=function(e){console.sendError(e);var t=(new Error).stack;console.sendError(t)},console.warn||(console.warn=function(e){console.log(e)}),File.isNode&&(n=reqnode("electron").ipcRenderer);var i=console.error;console.sendError=function(e){var t=e;e.stack?t=e.stack:e.message&&(t=e.message),i(t),File.isMac?app.window.log("[Error] "+t):File.isNode&&(n||(n=reqnode("electron").ipcRenderer),n&&n.send("sendError",t))};var t=console.log;if(console.sendLog=function(e){t(e),File.isMac?app.window.log("[Log] "+e):File.isNode&&(n||(n=reqnode("electron").ipcRenderer),n&&n.send("sendLog",e))},window.debugMode&&File.isMac){var r=console.debug;console.debug=function(e){r(e),File.isMac&&app.window.log("[Debug] "+e)}}}(),void 0===NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),void 0===HTMLCollection.prototype.forEach&&(HTMLCollection.prototype.forEach=Array.prototype.forEach),window.Promise||function(e){var t=setTimeout;function i(){}function o(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],c(e,this)}function r(n,i){for(;3===n._state;)n=n._value;0!==n._state?(n._handled=!0,o._immediateFn(function(){var e=1===n._state?i.onFulfilled:i.onRejected;if(null!==e){var t;try{t=e(n._value)}catch(e){return void s(i.promise,e)}a(i.promise,t)}else(1===n._state?a:s)(i.promise,n._value)})):n._deferreds.push(i)}function a(t,e){try{if(e===t)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var n=e.then;if(e instanceof o)return t._state=3,t._value=e,void l(t);if("function"==typeof n)return void c((i=n,r=e,function(){i.apply(r,arguments)}),t)}t._state=1,t._value=e,l(t)}catch(e){s(t,e)}var i,r}function s(e,t){e._state=2,e._value=t,l(e)}function l(e){2===e._state&&0===e._deferreds.length&&o._immediateFn(function(){e._handled||o._unhandledRejectionFn(e._value)});for(var t=0,n=e._deferreds.length;t<n;t++)r(e,e._deferreds[t]);e._deferreds=null}function c(e,t){var n=!1;try{e(function(e){n||(n=!0,a(t,e))},function(e){n||(n=!0,s(t,e))})}catch(e){if(n)return;n=!0,s(t,e)}}o.prototype.catch=function(e){return this.then(null,e)},o.prototype.then=function(e,t){var n=new this.constructor(i);return r(this,new function(e,t,n){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=n}(e,t,n)),n},o.all=function(e){var s=Array.prototype.slice.call(e);return new o(function(i,r){if(0===s.length)return i([]);var o=s.length;function a(t,e){try{if(e&&("object"==typeof e||"function"==typeof e)){var n=e.then;if("function"==typeof n)return void n.call(e,function(e){a(t,e)},r)}s[t]=e,0==--o&&i(s)}catch(e){r(e)}}for(var e=0;e<s.length;e++)a(e,s[e])})},o.resolve=function(t){return t&&"object"==typeof t&&t.constructor===o?t:new o(function(e){e(t)})},o.reject=function(n){return new o(function(e,t){t(n)})},o.race=function(r){return new o(function(e,t){for(var n=0,i=r.length;n<i;n++)r[n].then(e,t)})},o._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){t(e,0)},o._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)},o._setImmediateFn=function(e){o._immediateFn=e},o._setUnhandledRejectionFn=function(e){o._unhandledRejectionFn=e},window.Promise=o}(window)}),define("app/window/FileHelper",["app/document/StringUtils","app/editor/EditHelper","jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/editor/KeyMaster"],function(e,t,n){"use strict";var c=e("app/document/StringUtils"),d=e("app/editor/EditHelper"),u=window.reqnode?reqnode("electron").remote:null,a={NSChangeDone:0,NSChangeUndone:1,NSChangeCleared:2,NSChangeReadOtherContents:3,NSChangeAutosaved:4,NSChangeRedone:5,NodeSaveFailed:-1},i=function(){this.doneStack=[],this.undoneStack=[],this.curState=[a.NSChangeAutosaved,new Date-0],this.lastSaved=this.curState[1]};i.prototype.isDocumentEdited=function(){return!this.curState},i.prototype.clone=function(){return{doneStack:this.doneStack.clone(),undoneStack:this.undoneStack.clone(),curState:this.curState,lastSaved:this.lastSaved}},i.prototype.reset=function(e){this.doneStack=e?e.doneStack:[],this.undoneStack=e?e.undoneStack:[],this.curState=e?e.curState:[a.NSChangeAutosaved,new Date-0],this.lastSaved=e?e.lastSaved:this.curState[1]},i.prototype.isDiscardableUntitled=function(){return!(File.fileHasModified||File.changeCounter.isDocumentEdited()||File.filePath)},i.prototype.updateChangeCount=function(e){var t,n=this.curState;switch(File.fileHasModified=File.filePath||!0,e){case a.NSChangeDone:this.curState&&this.curState[0]===a.NSChangeAutosaved&&(this.doneStack.push(this.curState),this.curState=null),this.doneStack.push([e]),200<this.doneStack.length&&this.doneStack.splice(0,this.doneStack.length-200),this.undoneStack=[];break;case a.NSChangeUndone:for(this.curState&&this.curState[0]===a.NSChangeAutosaved&&(this.undoneStack.push(this.curState),this.curState=null),this.doneStack.pop(),this.undoneStack.push([e]);(t=this.doneStack.last())&&t&&t[0]===a.NSChangeAutosaved;)this.doneStack.pop(),this.lastSaved===t[1]&&(this.curState=t);break;case a.NSChangeRedone:for(this.curState&&this.curState[0]===a.NSChangeAutosaved&&(this.doneStack.push(this.curState),this.curState=null),this.undoneStack.pop(),this.doneStack.push([e]);(t=this.undoneStack.last())&&t&&t[0]===a.NSChangeAutosaved;)this.undoneStack.pop(),this.lastSaved===t[1]&&(this.curState=t);break;case a.NSChangeCleared:this.doneStack=[],this.undoneStack=[],this.curState=[a.NSChangeAutosaved,new Date-0],this.lastSaved=this.curState[1];break;case a.NodeSaveFailed:this.curState&&(this.lastSaved=null,this.curState=null);break;case a.NSChangeAutosaved:if(this.curState)return;this.curState=[a.NSChangeAutosaved,new Date-0],this.lastSaved=this.curState[1];break;case a.NSChangeReadOtherContents:for(var i=[],r=[],o=0;o<this.doneStack.length;o++)this.doneStack[o][0]!==a.NSChangeAutosaved&&i.push(this.doneStack[o]);for(o=0;o<this.undoneStack.length;o++)this.undoneStack[o][0]!==a.NSChangeAutosaved&&r.push(this.undoneStack[o]);this.doneStack=i,this.undoneStack=r,this.curState=null}n!==this.curState&&File.isNodeHtml&&s()};var s=function(){if(File.changeCounter)if(File.changeCounter.curState){if((File.filePath||File.fileName)&&File.isNode)(e=u.getCurrentWindow()).setTitle(e.getTitle().replace(/•? - Typora$/," - Typora"));document.querySelector("#title-text").classList.remove("title-modified"),document.querySelector("#m-saved").parentElement.classList.add("saved")}else{var e;if(document.querySelector("#title-text").classList.add("title-modified"),File.isNode)(e=u.getCurrentWindow()).setTitle(e.getTitle().replace(/•? - Typora$/,"• - Typora"));document.querySelector("#m-saved").parentElement.classList.remove("saved")}};t.showExportDialog=function(e,i,r,o,t){var n=u.getCurrentWindow(),a=(u.app,File.getSuggestedFileName()),s=u.dialog;a=a+"."+(e=e||"md");var l=$.isFunction(i)?i:function(t){var e=o||function(e){e&&(d.getDialog("Error",$.localize.getString("Failed to export file to <em>{0}</em>","Panel").format(c.escape(t)),!0,"error-dialog").modal({backdrop:"static"}),console.sendError(e))},n=i;t&&File.fs.writeFile(t,n,r,e)};s.showSaveDialog(n,{properties:["saveFile"],title:$.localize.getString("Save","Menu"),defaultPath:a,filters:t?[{name:e.toUpperCase(),extensions:[e]},{name:$.localize.getString("All Files","Panel"),extensions:[]}]:[]},l)},t.showSaveDialog=function(t,n){var i=u.getCurrentWindow(),r=u.app,e=File.getFilePathUseNode(),o=u.dialog;e||(e=(File.mountFolder_||r.getPath("documents"))+"/"+(l(e)||File.getSuggestedFileName())+".md"),o.showSaveDialog(i,{properties:["saveFile"],title:l(e)||File.getSuggestedFileName(),defaultPath:e,filters:[{name:$.localize.getString("Markdown File","Panel"),extensions:["md","markdown","mmd","mdown"]},{name:$.localize.getString("Plain Text File","Panel"),extensions:["txt","text",""]},{name:$.localize.getString("All Files","Panel"),extensions:[]}]},function(e){if(e){r.setPath("documents",reqnode("path").dirname(e));try{File.fs.writeFileSync(e,File.editor.getMarkdown(),"utf8")}catch(e){return console.sendError(e),void alert($.localize.getString("Save File Failed","Panel")+"\n"+e.stack)}r.getDocumentController().getDocument(e)||(r.getDocumentController().getDocumentFromWindowId(i.id).rename(e),File.FileInfoPanel.setFileTitle(e),File.updateChangeCount(File.ChangeType.NSChangeAutosaved)),t&&t()}else n&&n()})};var l=function(e){return(e=e&&e.replace(/\\/g,"/").replace(/\/$/,""))&&e.substring(e.lastIndexOf("/")+1)},r=null,o=function(e,t){if(File.inSavingProcess)setTimeout(function(){File.inSavingProcess&&(File.inSavingProcess=!1,File.updateChangeCount(File.ChangeType.NodeSaveFailed)),o(e)},500);else{var n=File.getCurrentDocByNode();if(File.fileHasModified&&File.changeCounter.isDocumentEdited()&&n.windows.size<=1){if(t&&(File.option.enableAutoSave||File.option.saveFileOnSwitch)&&File.filePath)return File.buildDocumentSnap(),void File.saveUseNode(e);File.backupWindow();var i=d.getDialog($.localize.getString("Save","Menu"),$.localize.getString("Do you want to save the changes made to this document ?<br> Your changes will be lost if you don't save them.","Panel"),!0,"three-way-dialog",$.localize.getString("Save","Menu"),$.localize.getString(File.path?"Discard Changes":"Discard","Panel"));i.modal({backdrop:!1,keyboard:!1}),i.off("click","#three-way-dialog-yes-btn").off("click","#three-way-dialog-yes-btn").on("click","#three-way-dialog-yes-btn",function(){i.modal("hide"),File.buildDocumentSnap(),File.saveUseNode(e)}).on("click","#three-way-dialog-no-btn",function(){i.modal("hide"),File.buildDocumentSnap(),n.setLastSync(-1),e()})}else e()}},p=["","md","markdown","mmd","text","txt","mdown"],h=function(e){return!(!e||"."==e[0])&&~p.indexOf(f(e).toLowerCase())},f=function(e){return(e.split(/[\/\\]/).last().match(/\.([^.]+)$/)||[])[1]||""};!function(){function e(){File.option.copyMarkdownByDefault=!0,window.ClientCommand.selectAll(),setTimeout(function(){window.ClientCommand.copy(),setTimeout(function(){File.editor.EditHelper.showNotification("Context copied to clipboard.")},500)},500)}$("#save-error-banner").on("click",".btn",e).on("click","#trigger-save-error-dialog",function(){$("#save-error-dialog").modal("show"),$("#save-error-banner").hide()}),$("#save-error-dialog").on("click",".btn-primary",e).on("hidden.bs.modal",function(){$("#save-error-banner").show()})}();t.getFileNameFromPath=l,t.normalizePath=function(e,t){return!t&&/^([a-z][a-z0-9+\-]+):\/\//gi.exec(e)?e:File.isNode?reqnode("path").normalize(e):app.path.normalize(e)},t.getFileFolderPath=function(e){return File.isNode?reqnode("path").dirname(e):(e=(e=(e||"").replace(/\\/g,"/"))&&e.substring(0,e.lastIndexOf("/")+1),File.isNode&&"win32"==process.platform?e.replace(/\//g,"\\"):e)},t.getCurrentFilePath=function(){return File.isMac?app.document.currentFilePath():File.isNode&&File.filePath||""},t.getCurrentFileFolderPath=function(){return File.isMac?app.document.currentFolderPath():File.isNode&&File.filePath?reqnode("path").dirname(File.filePath):""},t.getUnsavedDraftsPath=function(){return r||(r=reqnode("path").resolve(u.app.getPath("userData"),"draftsRecover"),reqnode("fs-extra").ensureDirSync(r)),r},t.ChangeType=a,t.ChangeCounter=i,t.tryLeaveDocument=o,t.refreshTitlebarText=s,t.allowedExtensions=p,t.isSupportedFile=h,t.detectEncodeByNode=function(e){var t=reqnode("jschardet"),n=reqnode("iconv-lite");t.Constants.MINIMUM_THRESHOLD=.3;var i=(reqnode("is-utf8")(e)?"utf8":t.detect(e).encoding)||"utf8";return"ascii"==i.toLowerCase()&&(i="utf8"),n.encodingExists(i)||(i=i.replace(/-/g,"_")),i=n.encodingExists(i)?i:"utf8"},t.getContentFromBuffer=function(e,t){var n=reqnode("iconv-lite");return"utf8"==t||"uft16le"==t?e.toString(t):n.decode(e,t)},t.statWrapper=function(e,n){var i={},r=reqnode("path").basename(e),o=e===File.getMountFolder();if(!o&&r&&"."==r[0])return i.shouldIgnore=!o,n(i);if(File.isWin)reqnode("fswin-aio").getAttributes(e,function(e){if(!e)return n(null);i.shouldIgnore=e.IS_HIDDEN||e.IS_SYSTEM||e.IS_TEMPORARY,i.isDir=e.IS_DIRECTORY,i.isFile=!i.isDir,i.mtime=e.LAST_WRITE_TIME,i.size=e.SIZE/1e3,i.shouldIgnore||(i.isDir?i.shouldIgnore="node_modules"==r:i.isFile&&!i.shouldIgnore&&(i.shouldIgnore=!h(r))),o&&(i.shouldIgnore=!1),n(i)});else{var a=reqnode("util");reqnode("fs").stat(e,function(e,t){if(e||!t)return n(null);i.isDir=t.isDirectory(),i.isFile=t.isFile(),i.mtime=new Date(a.inspect(t.mtime)),i.size=t.size/1e3,/\.asar[\/\\]*$/.exec(r)&&(i.isFile=!0,i.isDir=!1,i.shouldIgnore=!0),i.isDir?i.shouldIgnore="node_modules"==r:i.isFile&&(i.shouldIgnore=i.shouldIgnore||!h(r)||5e3<i.size),o&&(i.shouldIgnore=!1),n(i)})}},t.saveFileFailedOnNode=function(){$("#save-error-dialog").modal("show"),File.editor.library.hideSidebar(!0),File.lock(),File.isBroken=!0}}),define("app/editor/EditHelper",["jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/document/StringUtils","app/editor/KeyMaster"],function(e,t,n){"use strict";var u=e("jquery/jquery");e("app/document/Node").Node,e("app/document/StringUtils"),e("app/editor/KeyMaster").map,e("exoskeleton-master/exoskeleton");function c(e){for(var t=[],n=e.length,i=0;i<n;i++)t.push(e[i]);return t}function r(e,t,n){var i,r=e.cloneNode(!0),o=e.getBoundingClientRect(),a=window.getComputedStyle(e);if(e.querySelector("[*|href='#raphael-marker-block']")&&!e.querySelector("#raphael-marker-block")&&r.querySelector("defs").appendChild(document.querySelector("path#raphael-marker-block").cloneNode()),t&&function n(e,t){var i=window.getComputedStyle(e);["backgroundColor","color","fill","stroke","strokeWidth","opacity","stroke-dasharray","fontSize","fontFamily","textAnchor","textSize","padding","margin"].forEach(function(e){t.style[e]=i[e]});var r=c(t.children||[]);r.length&&c(e.children||[]).forEach(function(e,t){n(e,r[t])})}(e,r),r.setAttribute("height",o.bottom-o.top),r.style.color||(r.style.color=a.color),a.getPropertyValue&&(i=window.getComputedStyle(document.body).backgroundColor),!r.style.background&&(r.style.background=a.backgroundColor,"rgba(0, 0, 0, 0)"!==a.backgroundColor&&(i=r.style.background),i)){var s=i.match(/\d+/gi);if(s.length)(299*s[0]+587*s[1]+114*s[2])/256e3<.5?(r.style.background=i,u(r).find("[fill='var(--bg-color)']").attr("fill",i||"none")):u(r).find("[fill='var(--bg-color)']").attr("fill","white")}var l=d(r.outerHTML);return n?l:"data:image/svg+xml;charset=utf-8,"+l}function d(e){return e.replace(/xmlns:NS\d+/gi,"xmlns:xlink").replace(/NS\d+:href/gi,"xlink:href").replace(/NS\d+:space/gi,"xml:space").replace(/NS\d+:/gi,"")}var p=!1;var o,i,a=u("#ty-tooltip");u("body").on("mouseenter","[ty-hint]",function(){var e=u(this),t=u.Event("before-show-ty-hint",{cancel:!1});if(e.trigger(t),!t.cancel){a.text(this.getAttribute("ty-hint")).addClass("shown").attr("style","");var n=e.offset(),i=a[0].clientWidth,r=n.left+this.clientWidth/2;"right"==e.attr("ty-hint-pos")?n.left+=this.clientWidth+4:(n.top>window.innerHeight/2?n.top=n.top-a[0].clientHeight-6:n.top+=this.clientHeight,i/2+r>window.innerWidth?n.left=window.innerWidth-i-4:(n.left=r-i/2,n.left=Math.max(2,n.left))),a.offset(n),new Date-o<2e3?a.addClass("instant"):a.removeClass("instant")}}).on("mouseleave click","[ty-hint]",function(){o=new Date,a.removeClass("shown")}),i=document.querySelector("#write"),u(document.body).on("keydown","input",function(e){if(!i.contains(this)){var t=event.keyCode||event.which;if(File.isNode){if("Z"==String.fromCharCode(t)&&(File.isMacOrMacNode?e.metaKey:e.ctrlKey))return reqnode("electron").remote.getCurrentWindow().webContents.undo(),!1;if("Y"==String.fromCharCode(t)&&(File.isMacOrMacNode?e.metaKey:e.ctrlKey))return reqnode("electron").remote.getCurrentWindow().webContents.redo(),!1}if(File.isMac){if("Z"==String.fromCharCode(t)&&e.metaKey)return e.shiftKey?app.window.redo():app.window.undo(),!1;if("Y"==String.fromCharCode(t)&&e.metaKey&&!e.shiftKey)return app.window.redo(),!1}}}),t.getDialog=function(e,t,n,i,r,o){var a=u("#"+(i=i||"quick-dialog"));return a.find("#"+i+"-title").text(e),n?a.find("#"+i+"-message").html(t):a.find("#"+i+"-message").text(t),a.find(".btn-primary").text(r||"OK").off("click"),a.find("#three-way-dialog-no-btn").text(o||"No").off("click"),a},t.replaceTag=function(e,t){var n=e[0].outerHTML,i=new RegExp("<"+e[0].tagName,"i"),r=n.replace(i,"<"+t);i=new RegExp("</"+e[0].tagName+">$","i"),r=r.replace(i,"</"+t+">");var o=u(r);return e.replaceWith(o),o},t.getEditParent=function(e,t){return t.getClosetBlock(!0)},t.fixPopoverPosition=function(i,e,t){var n,r=i.offset(),o=u(editor.sessionStr).offset().left+10,a=u(editor.sessionStr).width(),s=i.find(".md-arrow");return(e=e||".code-tooltip.md-hover-tip").jquery?s=(n=e).find(".md-arrow"):n=i.find(e),i.length?(n.css("max-width",a-60),r.top+=i.height()*(t?1:1.5)+(t?0:4),r.left+=(i.width()-n.width())/2,r.left+n.width()>window.innerWidth-10?r.left=window.innerWidth-10-n.width():r.left<o&&(r.left=o),n.css("position","absolute").offset(r),!t&&s.offset(function(e,t){var n={};return n.left=i.offset().left+i.width()/2,n.top=t.top,n}),n):(console.sendError("cannot fixPopoverPosition on empty $parent"),n.hide())},t.showNotification=function(e,t){var n="<p>"+e+"<span class='btn close-btn btn-xs' aria-label='"+u.localize.getString("Close")+"'></span></p>";u("#md-notification").html(n).show().delay(8e3).fadeOut()},t.resetClick=function(e){var t=File.editor;if(p)return!(p=!1);if(e.target&&("CONTENT"==e.target.tagName||"HTML"==e.target.tagName)){var n=e.clientX,i=e.clientY,r=document.querySelector(t.sessionStr),o=u(r).offset(),a=document.createEvent("MouseEvents"),s=o.left,l=o.left+r.clientWidth,c=o.top,d=o.top+r.clientHeight;if(s<=n&&n<=l||c<=i&&i<=d)return;if(p=!0,n=n<o.left?o.left+1:o.left+r.clientWidth-1,i=i<o.top?o.top+1:o.top+r.clientHeight-1,e.stopPropagation(),a=document.createEvent("MouseEvents"),!(r=document.elementFromPoint(n,i)))return;a.initMouseEvent("click",!0,!0,r.ownerDocument.defaultView,1,e.screenX+(n-e.clientX),e.screenY+(i-e.clientY),n,i,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button),r.dispatchEvent(a)}},t.getWordCount=function(e){if(0===e.trim().length)return 0;var t=0,n=["d",e.replace(/[\u3040-\uABFF\uD7A4-\uFAFF]/gi,function(e){return t++," "}).replace(/(^|\s+)[(\u3000-\u303F)!-\/:-@\[-`{-~]+(\s+|$)/gm," "),"d"].join(" ").split(/[(\u3000-\u303F)\s!-,\.\\:-@\[-`{-~]+/g).length;return t+n-2},t.SVG2HtmlImg=function(e){if(!e)return"";var t=r(e,!0),n=document.createElement("img"),i=e.getBoundingClientRect();return n.width=i.width,n.height=i.height,n.setAttribute("src","data:image/svg+xml;base64,"+btoa(t)),n.outerHTML},t.svg2DataURL=r,t.processExportedSVG=d,t.findAnchorElem=function(e){if(e.match(/^#/)){var t=(e.substr(1)||"").toLowerCase().trim().replace(/-/g," ");return u("#write").find("h1, h2, h3, h4, h5, h6").filter(function(){var e=u(this).text().toLowerCase().trim().replace(/-/g," ");return e==t||e==decodeURI(t)})}}}),define("app/editor/KeyMaster",[],function(e,t,n){"use strict";var s,l={},c={16:!1,18:!1,17:!1,91:!1},i="all",d={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,command:91},r={backspace:8,tab:9,clear:12,enter:13,return:13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,delete:46,home:36,end:35,pageup:33,pagedown:34,",":188,".":190,"/":191,"`":192,"-":189,"=":187,";":186,"'":222,"[":219,"]":221,"\\":220},u=function(e){return r[e]||e.toUpperCase().charCodeAt(0)},p=[];for(s=1;s<20;s++)r["f"+s]=111+s;function h(e,t){for(var n=e.length;n--;)if(e[n]===t)return n;return-1}function f(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}var g={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey"};function o(e){var t,n,i,r,o,a;if(t=e.keyCode,-1==h(p,t)&&p.push(t),93!=t&&224!=t||(t=91),t in c)for(i in c[t]=!0,d)d[i]==t&&(m[i]=!0);else if(function(e){for(s in c)c[s]=e[g[s]]}(e),m.filter.call(this,e)&&t in l)for(a=v(),r=0;r<l[t].length;r++)if((n=l[t][r]).scope==a||"all"==n.scope){for(i in o=0<n.mods.length,c)(!c[i]&&-1<h(n.mods,+i)||c[i]&&-1==h(n.mods,+i))&&(o=!1);(0!=n.mods.length||c[16]||c[18]||c[17]||c[91])&&!o||!1===n.method(e,n)&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.cancelBubble&&(e.cancelBubble=!0))}}function m(e,t,n){var i,r;i=y(e),void 0===n&&(n=t,t="all");for(var o=0;o<i.length;o++)r=[],1<(e=i[o].split("+")).length&&(r=b(e),e=[e[e.length-1]]),e=e[0],(e=u(e))in l||(l[e]=[]),l[e].push({shortcut:i[o],scope:t,method:n,key:i[o],mods:r})}for(s in d)m[s]=!1;function v(){return i||"all"}function y(e){var t;return""==(t=(e=e.replace(/\s/g,"")).split(","))[t.length-1]&&(t[t.length-2]+=","),t}function b(e){for(var t=e.slice(0,e.length-1),n=0;n<t.length;n++)t[n]=d[t[n]];return t}function a(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,function(){n(window.event)})}a(document,"keydown",function(e){o(e)}),a(document,"keyup",function(e){var t,n=e.keyCode,i=h(p,n);if(0<=i&&p.splice(i,1),93!=n&&224!=n||(n=91),n in c)for(t in c[n]=!1,d)d[t]==n&&(m[t]=!1)}),a(window,"focus",function(){for(s in c)c[s]=!1;for(s in d)m[s]=!1});var w=m;(n.exports=w).setScope=function(e){i=e||"all"},w.getScope=v,w.deleteScope=function(e){var t,n,i;for(t in l)for(n=l[t],i=0;i<n.length;)n[i].scope===e?n.splice(i,1):i++},w.filter=function(e){return!("SELECT"==(e.target||e.srcElement).tagName)},w.isPressed=function(e){return"string"==typeof e&&(e=u(e)),-1!=h(p,e)},w.getPressedKeyCodes=function(){return p.slice(0)},w.unbind=function(e,t){var n,i,r,o,a,s=[];for(n=y(e),o=0;o<n.length;o++){if(1<(i=n[o].split("+")).length&&(s=b(i),e=i[i.length-1]),e=u(e),void 0===t&&(t=v()),!l[e])return;for(r in l[e])(a=l[e][r]).scope===t&&f(a.mods,s)&&(l[e][r]={})}},void 0!==n&&(n.exports=w);w.map={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",91:"Command",107:"=",109:"-",127:"Delete",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},w.functionKey=["Command","Ctrl","Shift","Alt","Home","End","PageUp","PageDown","CapsLock","Esc","PrintScrn","Insert","Pause"],w.handleCtrlDown=function(e){$(e.sessionStr+" a").attr("contenteditable",!0)},w.isCommand=function(e){return 0<String.fromCharCode(e.which).length&&(e.ctrlKey||e.metaKey)},w.handleCtrlUp=function(e){$(e.sessionStr+" a").attr("contenteditable",!1)}}),define("app/window/MenuHelper",["exoskeleton-master/exoskeleton","jquery/jquery","app/editor/UndoManager","app/document/StringUtils","app/document/Node","app/editor/polyfill"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton"),e("app/editor/UndoManager");var a,s=e("app/document/Node"),l=s.Node,c=s.TYPE,i=(e("app/editor/polyfill"),window.reqnode&&reqnode("electron")),p=window.reqnode?i.remote:null,h=p?p.app:window.app,r=null;function d(n,e){a=File.editor.styleBookmark.style,n=n||(File.isNode?p.Menu.getApplicationMenu().getItem("Format").submenu:h.menu.getItem("Format").submenu()),!e&&File.editor.stylize.putBookmark(null,File.editor.stylize.buildBookmark());var t,i=File.editor.styleBookmark.style,r=(File.editor.stylize.CONST.NormalBlockMap[i.block[0]],-1<File.editor.stylize.CONST.NoInline.indexOf(i.block[0]));i.block[0]==c.def_footnote&&(r=r||File.editor.stylize.isAtFootnoteDefSpan()),r=r||-1<i.inline.indexOf(c.inline_math),["Strong","Emphasis","Underline","Code","Strike","Hyperlink","Image","Clear Format","Inline Math","Highlight","Subscript","Superscript","Comment"].map(function(e){var t=n.getItem(e);t&&(t.setEnabled(!File.isLocked&&!r),t.setState(!1))}),(t=n.getItem("Inline Math"))&&t.setHidden(!File.option.enableInlineMath),(t=n.getItem("Highlight"))&&t.setHidden(!File.option.enableHighlight),(t=n.getItem("Subscript"))&&t.setHidden(!File.option.enableSubscript),(t=n.getItem("Superscript"))&&t.setHidden(!File.option.enableSuperscript);var o=["image","strong","em","link"];(File.editor.styleBookmark.style.inline||[]).map(function(e){var t=n.getItem(File.editor.stylize.CONST.StyleToNameMap[e]);t&&t.setState(!0),File.isMac&&h.touchBar&&(o.remove(e),h.touchBar.setStateForInline(!0,File.editor.stylize.CONST.StyleToNameMap[e]))}),File.isMac&&h.touchBar&&(h.touchBar.setInlineEnabled(!r),r||o.map(function(e){h.touchBar.setStateForInline(!1,File.editor.stylize.CONST.StyleToNameMap[e])}))}function o(e,t,n){if(!e)return!1;if(n&&(e.length||(e=n),t.length||(t=n)),e.length==t.length){for(var i=0;i<e.length;i++)if(e[i]!=t[i])return!1;return!0}return!1}var u=function(t){r&&clearTimeout(r);var e=300;a&&-1<a.inline.indexOf(c.inline_math)&&(e=50),r=setTimeout(function(){var e=(t||File.editor.stylize.putBookmark(null,File.editor.stylize.buildBookmark())).style;a&&o(e.block,a.block)?o(e.inline,a.inline,[c.plain])||(d(void 0,!0),m.forceRefreshMenu()):(f(void 0,!0),d(void 0,!0),m.forceRefreshMenu())},e)};function f(r,e){!e&&File.editor.stylize.putBookmark(null,File.editor.stylize.buildBookmark());var n=File.editor.styleBookmark.style,i=File.editor.stylize.CONST.NormalBlockMap[n.block[0]];r=r||(File.isMac?h.menu.getItem("Paragraph").submenu():p.Menu.getApplicationMenu().getItem("Paragraph").submenu),["Heading 1","Heading 2","Heading 3","Heading 4","Heading 5","Heading 6","Paragraph","Decrease Heading Level","Increase Heading Level","Link Reference","Footnotes","YAML Front Matter","Table","Horizontal Line","Code Fences","Math Block","Quote","Ordered List","Unordered List","Task List","Table of Contents"].map(function(e){var t=r.getItem(e);try{t&&(t.setEnabled(!File.isLocked&&0<n.block.length&&null!=i),t.setState(!1))}catch(e){console.sendError(e)}}),!function(){try{return File.editor.getMarkElem(window.getSelection().getRangeAt(0).startContainer).attr("mdtype")==s.TYPE.meta_block}catch(e){}return!1}()?["Paragraph","Quote","Ordered List","Unordered List","Task List","Code Fences","Math Block"].map(function(e){r.getItem(e).setEnabled(!0)}):r.getItem("Paragraph").setEnabled(!0);var t,o=null,a=!1;(File.editor.styleBookmark.style.block||[]).map(function(e){var t=r.getItem(File.editor.stylize.CONST.StyleToNameMap[e]);t&&t.setState(!0),!o&&l.isType(e,"ol","ul","tasklist")&&(o=e),e==c.blockquote&&(a=!0);var n=r.getItem("Task Status");if("tasklist"==e){n.setEnabled(!0);var i=File.isNode?n.submenu:n.submenu();"checked"==File.editor.styleBookmark.style.state?(i.getItem("Mark as Complete").setState(!0),i.getItem("Mark as Incomplete").setState(!1)):(i.getItem("Mark as Complete").setState(!1),i.getItem("Mark as Incomplete").setState(!0))}else n.setEnabled(!1)}),File.isMac&&h.touchBar&&($("#md-searchpanel").is(":visible")?h.touchBar.showFindReplaceTouchBar():document.body.classList.contains("modal-open")?$("#table-insert-dialog:visible").length?h.touchBar.showInsertTableTouchBar():h.touchBar.showDialogTouchBar():h.touchBar.setBlockStyle({blockStyle:File.editor.stylize.CONST.StyleToNameMap[(t=n.block,t[0]==c.line?c.paragraph:t[0]==c.table_cell?c.table:t[0])]||"",listType:o,underQuote:a,fallbackOnly:!i}))}function g(e){if(e){var t=File.editor.sourceView&&File.editor.sourceView.inSourceMode;if(e.getItem("Source Code Mode").setState(t),e.getItem("Source Code Mode").setEnabled(!File.isLocked),e.getItem("Always on Top").setState(File.isMac?h.window.isAlwaysOnTop():p.getCurrentWindow().isAlwaysOnTop()),e.getItem("Focus Mode").setState(File.isFocusMode),e.getItem("Focus Mode").setEnabled(!0),e.getItem("Typewriter Mode").setState(File.isTypeWriterMode),e.getItem("Typewriter Mode").setEnabled(!0),File.editor.library){var n=File.editor.library.isSidebarShown(),i=File.editor.library.getActiveTab();e.getItem("Outline").setState(n&&"outline"==i),e.getItem("Outline").setEnabled(!t),e.getItem("Articles").setState(n&&"file-list"==i),e.getItem("Articles").setEnabled(!t),e.getItem("File Tree").setState(n&&"file-tree"==i),e.getItem("File Tree").setEnabled(!t),e.getItem("Toggle Sidebar").setEnabled(!t)}}}var m={doRefreshImageCopyStatus:function(e){var t,n,i,r,o=File.editor,a=o.imgEdit&&o.imgEdit.getTagetImageStorageFolder();if(File.isNode)n=(t=p.Menu.getApplicationMenu().getItem("Edit").submenu.getItem("Image Tools")).submenu.getItem("Use Image Root Path"),(r=t.submenu.getItem("When Insert Local Image").submenu.getItem("Copy Image File to Folder…")).setState(!!a);else if(File.isMac){var s=(t=h.menu.getItem("Edit").submenu().getItem("Image Tools")).submenu().getItem("When Insert Local Image").submenu();n=t.submenu().getItem("Use Image Root Path"),i=s.getItem("Upload Image via iPic"),(r=s.getItem("Copy Image File to Folder…")).setState(!!a&&"ipic"!==a.toLowerCase()),i.setState(a&&"ipic"==a.toLowerCase())}n.setState(!!File.editor.docMenu.getLocalRootUrl()),void 0!==e&&(r.setEnabled(!e),n.setEnabled(!e),i&&i.setEnabled(!e))},refreshViewMenu:g,refreshBlockMenu:f,bindMenu:function(){if(File.isMac){var e=File.editor.sourceView.inSourceMode,t=h.menu.getItem("Edit").submenu();t.setMenuWillOpen(function(){t.getItem("Delete").setEnabled(!File.isLocked&&!e),t.getItem("Delete").setEnabled(!File.isLocked&&!e)}),t.getItem("Image Tools").submenu().setMenuWillOpen(function(){File.refreshImageCopyStatus(!1)});var n=h.menu.getItem("Paragraph").submenu();(o=(r=h.menu.getItem("Format").submenu()).getItem("Inline Math"))&&o.setHidden(!File.option.enableInlineMath),(o=r.getItem("Highlight"))&&o.setHidden(!File.option.enableHighlight),(o=r.getItem("Subscript"))&&o.setHidden(!File.option.enableSubscript),(o=r.getItem("Superscript"))&&o.setHidden(!File.option.enableSuperscript),n.setMenuWillOpen(function(){f(n);var e=n.getItem("Heading 6");e.setHidden(!e.getState())}),n.setMenuDidClose(function(){n.getItem("Heading 6").setHidden(!1)}),r.setMenuWillOpen(function(){d(r)}),f(n),d(r,!0),File.freshMenu(!0),$(File.editor.sessionStr).on("cursorChange",function(e,t){u(t)});var i=h.menu.getItem("View").submenu();i.setMenuWillOpen(function(){g(i),h.controller.adjustTabMenuItem()})}else if(File.isNode){var r,o,a=p.Menu.getApplicationMenu();n=a.getItem("Paragraph").submenu;(o=(r=a.getItem("Format").submenu).getItem("Inline Math"))&&o.setHidden(!File.option.enableInlineMath),(o=r.getItem("Highlight"))&&o.setHidden(!File.option.enableHighlight),(o=r.getItem("Subscript"))&&o.setHidden(!File.option.enableSubscript),(o=r.getItem("Superscript"))&&o.setHidden(!File.option.enableSuperscript),$(File.editor.sessionStr).on("cursorChange",function(e,t){u(t)})}},freshMenu:function(s){var l,c=null,d=null,u=File.editor.sourceView&&File.editor.sourceView.inSourceMode;if(File.isMac)l=h.menu,c=l.getItem("Edit").submenu(),d=l.getItem("View").submenu();else{if(!File.isNode)return;l=p.Menu.getApplicationMenu(),c=l.getItem("Edit").submenu,d=l.getItem("View").submenu}function e(){function e(e,t){if(l.getItem(e).setEnabled(t),File.isNode)try{l.getItem(e).submenu.items.forEach(function(e){e.setEnabled(t)})}catch(e){}}if(!File.isNode&&g(d),c&&(c.getItem("Copy as HTML Code").setEnabled(!u),File.isMac?(c.getItem("Image Tools").submenu().getItem("Insert Local Images…").setEnabled(!File.isLocked),c.getItem("Image Tools").submenu().getItem("Upload Local Images via iPic").setEnabled(!File.isLocked&&!u)):c.getItem("Image Tools").submenu.getItem("Insert Local Images…").setEnabled(!File.isLocked),c.getItem("Delete").setEnabled(!File.isLocked),c.getItem("Delete Range").setEnabled(!File.isLocked),c.getItem("Cut").setEnabled(!File.isLocked),File.refreshImageCopyStatus(!1,File.isLocked||u),c.getItem("Line Endings").setEnabled(!File.isLocked),File.setLineEnding(File.useCRLF,!1,!0)),e("Paragraph",!File.isLocked&&!u),e("Format",!File.isLocked&&!u),u){var t=File.editor.sourceView.cm.doc.historySize();c.getItem("Undo").setEnabled(!File.isLocked&&0<t.undo),c.getItem("Redo").setEnabled(!File.isLocked&&0<t.redo),c.getItem("Whitespace and Line Breaks").setEnabled(!1),File.isNode&&window.ClientCommand.refreshViewMenu()}else c.getItem("Undo").setEnabled(!File.isLocked&&File.editor.undo.hasUndo()),c.getItem("Redo").setEnabled(!File.isLocked&&File.editor.undo.hasRedo()),c.getItem("Whitespace and Line Breaks").setEnabled(!0),File.isNode?window.ClientCommand.refreshViewMenu():d.getItem("Always on Top").setEnabled(!0),!File.isLocked&&$(File.editor.sessionStr).trigger("cursorChange");if(s&&File.isNode){var n=p.Menu.getApplicationMenu().getItem("File").submenu,i=n.getItem("Open File Location"),r=n.getItem("Reopen with Encoding");i.visible=!!File.filePath,r.visible=!!File.filePath}if(s){var o,a=File.isMac?c.getItem("Whitespace and Line Breaks").submenu():c.getItem("Whitespace and Line Breaks").submenu;(o=a.getItem("Indent first line of paragraphs")).setState(File.option.indentFirstLine),File.isMac&&o.setEnabled(!0),(o=a.getItem("Visible <br/> and markdown line break")).setState(!File.option.hideBrAndLineBreak),File.isMac&&o.setEnabled(!0),(o=a.getItem("Preserve sequential whitespace and single line break")).setState(!File.option.ignoreLineBreak),File.isMac&&o.setEnabled(!0)}}if(File.isNode)try{e(),m.forceRefreshMenu()}catch(e){reqnode("electron").ipcRenderer.send("errorInWindow"," (caught) "+(e?e.stack:e.message))}else e()},forceRefreshMenu:function(){File.isLinux&&i.ipcRenderer.send("forceRefreshMenu")}};n.exports=m}),define("app/window/FileInfoPanel",["app/document/StringUtils","exoskeleton-master/exoskeleton","jquery/jquery","app/window/FileHelper","app/editor/EditHelper","app/document/Node","app/editor/KeyMaster"],function(e,t,n){"use strict";var c,i=e("app/document/StringUtils"),d=(e("exoskeleton-master/exoskeleton"),e("app/window/FileHelper")),u=(e("app/editor/EditHelper"),e("app/editor/KeyMaster").map,window.reqnode?reqnode("electron").remote:null),r=(i.date2NatrualLang,null),o=null,p=function(e){var t=new Date;return c=i.formateDateOnly(new Date)+" "+(e||"untitled").replace(/\.[^.]*$/,"")+" "+i.formateTimeOnly(t,!0).replace(/:/g,"")+".md"};function a(n){try{var i=reqnode("fs");o&&i.unwatchFile(o),i.watchFile(n,function(e,t){t&&t.mtime==e.mtime||(i.existsSync(n)?File.presentedItemChanged():s())})}catch(e){console.log(e)}}function h(n){if(reqnode){var i=reqnode("fs");reqnode("path"),u.getCurrentWindow();if(r&&(r.removeAllListeners(),r.close()),o&&i.unwatchFile(o),n)try{(r=i.watch(n,{persistent:!1})).on("change",function(e,t){File.inSavingProcess&&"rename"==e?h(n):"change"==e||i.existsSync(n)?(File.presentedItemChanged(),"rename"==e&&h(n)):(h(null),s())}),r.on("error",function(e){a(n),r.close()})}catch(e){a(n)}}}var s=function(){File.getCurrentDocByNode().switchToUntitled()};window.clientHanlderOnPresentationMoved=function(){File.isNode&&(File.updateChangeCount(File.ChangeType.NSChangeReadOtherContents),h(null)),File.editor.imgEdit.onFileMoved()};var l=function(e){window.debugMode&&console.warn(e)},f=function(n){if(c&&n){var i=reqnode("fs"),r=reqnode("path"),o=d.getUnsavedDraftsPath(),a=r.resolve(o,c);i.stat(a,function(e,t){!e&&i.rename(a,r.resolve(o,p(n)),l)})}},g=function(e,t,n){var i=$("#title-text"),r=u.app,o=u.getCurrentWindow(),a=(reqnode("path"),u.Menu.getApplicationMenu().getItem("File").submenu),s=a.getItem("Open File Location"),l=a.getItem("Reopen with Encoding");if(File.fileEncode=void 0,e){s.visible=!0,l.visible=!0;n=d.getFileNameFromPath(e);File.filePath=e,File.fileName=n,File.fileEncode=t,r.getDocumentController().hasDuplicateName(n)?(i.text(e),o.setTitle(e+" - Typora")):(i.text(n),o.setTitle(n+" - Typora")),h(e),f(n),File.editor.library&&File.editor.library.markCurrentFile()}else(n=n||File.fileName)?(File.fileName=n,i.text(n),o.setTitle(n+"• - Typora")):(i.text($.localize.getString("Untitled")),o.setTitle($.localize.getString("Untitled")+" - Typora")),File.filePath=void 0,c||p(),s.visible=!1,l.visible=!1;d.refreshTitlebarText()};t.watchFileChange=h,t.onPresentationMoved=s,t.setFileTitle=g,t.saveToRecover=function(e){e.trim().length&&-1==(File.filePath||"").indexOf(d.getUnsavedDraftsPath())&&reqnode("fs").writeFile(d.getUnsavedDraftsPath()+"/"+(c||p()),e,"utf8",function(e){e?l(e):f(File.fileName||File.getSuggestedFileName())})},t.prepareInfoPanel=function(){function e(e){$(".info-panel-tab.active").removeClass("active"),"file"==e?File.editor.library.switch("files",!0):File.editor.library.switch("outline")}document.querySelector("#file-library").style.display="",document.querySelector("#file-info-content").style.display="none",$("#info-panel-tab-file").click(function(){e("file")}),$("#info-panel-tab-outline").click(function(){e("outline")})}}),define("app/window/steno2",[],function(e,t,n){"use strict";if(window.reqnode){var l=reqnode("fs"),i=reqnode("path"),r={};o.prototype.write=function(r,n){var t=this;function o(e){for(;this.callbacks.length;)this.callbacks.shift()(e);n(e),i()}function i(){if(t.lock=!1,t.nextData){var e=t.nextData;t.callbacks=t.nextCallbacks,t.nextData=null,t.nextCallbacks=[],t.write(e,t.callbacks.pop())}}function a(e,t){for(;this.callbacks.length;)this.callbacks.shift()(e);n(null,t),i()}function s(){l.writeFile(this.file,r,function(e){e?o.call(this,e):a.call(this,null,!0)}.bind(this))}this.lock?(n&&this.nextCallbacks.push(n),this.nextData=r):(this.lock=!0,l.open(this.file,l.constants.O_RDWR,function(e,i){e?s.call(this):l.stat(this.file,function(e,t){if(!e&&t)if(t.size<=r.length)l.write(i,r,a.bind(this)),l.close(i);else{l.closeSync(i);var n=c(this.file);l.writeFile(n,r,function(e){l.writeFile(this.file,r,function(e){e?o.call(this,e):l.unlink(n,a.bind(this))}.bind(this))}.bind(this))}else s.call(this)}.bind(this))}.bind(this)))},t.writeFile=function(e,t,n){e=i.resolve(e),r[e]=r[e]||new o(e),r[e].write(t,n)},t.writeFileSync=function(e,t){l.writeFileSync(c(e),t),l.renameSync(c(e),e)}}function c(e){return i.join(i.dirname(e),".~"+i.basename(e))}function o(e){this.file=e,this.callbacks=[],this.nextData=null,this.nextCallbacks=[]}}),define("app/editor/Editor",["app/editor/polyfill","jquery/jquery","app/document/StringUtils","exoskeleton-master/exoskeleton","app/document/Node","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileHelper","app/editor/UndoManager","app/editor/Emoji","app/document/Node2Mark","app/document/Node2HTML","app/editor/Diagram","codemirror/lib/codemirror","app/document/NodeOperation","rangy/rangy-core","app/editor/Fences","autoComplete","codemirror/addon/selection/mark-selection","codemirror/addon/edit/closebrackets","codemirror/addon/edit/closetag","codemirror/addon/mode/overlay","codemirror/addon/lint/lint","app/editor/MathBlock","codemirror/addon/display/placeholder","codemirror/mode/stex/stex","app/editor/MathInline","rangy/rangy-classapplier","app/editor/Brush","app/editor/Stylize","app/window/MenuHelper","app/editor/polyfill","app/editor/Selection","app/editor/EditHelper","app/editor/TableEdit","app/editor/ImageEdit","app/editor/UserOp","app/editor/TableEdit","app/editor/ConvertUtils","app/editor/DeleteOp","app/editor/PairOp","app/editor/IndentOp","app/editor/ClipboardOp","app/editor/Selection","app/editor/UndoManager","app/editor/KeyMaster","app/editor/UserOp","app/window/FileInfoPanel","app/document/File","app/window/steno2","app/editor/DocMenu","app/editor/Stylize","app/editor/SearchPanel","app/editor/Emoji","app/editor/Word","app/document/Export","app/document/Node2Native","app/editor/SourceView","codemirror/addon/selection/active-line","codemirror/addon/edit/visiblespace","app/editor/QuickOpenPanel","app/window/ContextMenu","app/window/Library","app/editor/FileTree","app/editor/FileList"],function(e,t,n){"use strict";e("app/editor/polyfill");var i,y=e("jquery/jquery"),p=e("app/document/StringUtils"),r=e("exoskeleton-master/exoskeleton"),g=e("app/document/Node"),b=g.Node,m=g.TYPE,o=e("app/document/MarkParser"),a=(e("app/document/Node2Mark"),e("app/document/Node2HTML"),e("app/document/NodeOperation"),e("app/editor/Fences")),s=e("app/editor/MathBlock"),l=e("app/editor/MathInline"),c=e("app/editor/Brush"),d=e("app/editor/Selection"),h=d.rangy,f=e("app/editor/EditHelper"),u=e("app/editor/TableEdit"),v=e("app/editor/ImageEdit"),w=e("app/editor/UndoManager"),x=w.SnapFlag,C=e("app/editor/KeyMaster"),k=C.map,S=e("app/editor/UserOp"),T=e("app/window/FileInfoPanel"),F=e("app/document/File"),E=e("app/editor/DocMenu"),_=e("app/editor/Stylize"),M=e("app/editor/SearchPanel"),N=e("app/editor/Emoji"),A=e("app/editor/Word"),L=e("app/document/Export"),I=e("app/editor/SourceView"),R=e("app/window/FileHelper"),P=e("app/editor/QuickOpenPanel"),D=e("app/window/ContextMenu"),O=e("app/window/Library"),B=window.reqnode?reqnode("electron").remote:null;i=y.fn.replaceWith,y.fn.oldReplaceWith=i,y.fn.replaceWith=function(e){var t=this.parent();if(i.apply(this,arguments),this[0]&&"LI"==this[0].tagName){var n=t.closest("li");n.length&&(n.css("margin","0.1px"),n.css("margin",""))}};var j,$,H,U,W=180,q=0,z=null,V=r.Model.extend({constructor:function(e,t){this.sessionStr=e,this.EditHelper=f,this.MarkParser=o,t.setTheme(),t.setEditor(this),this.nodeMap=new g.NodeMap,this.writingArea=document.querySelector(this.sessionStr),t.readOption();var n=void 0,i=t.getDocumentSnap();this.imgEdit=new v(this),this.docMenu=new E(this),this.undo=new w(this),(i||{}).nodeMap?(t.isNode&&T.setFileTitle(t.getFilePathUseNode(),i.fileEncode),t.restoreEditStateFromData(i,!1,!0)):t.recoverFromBackup()||(n=t.getContent(),this.reset(n)),t.onFileOpened(),this.library=new O(this),this.library.init(),this._bindGlobal(),this._bindKeyEvents(),this._bindMouseEvents(),this.focusCid=null,this.selection=new d(this),this.keypressMsg="",this.mathInline=new l(this),this.brush=new c(this),this.tableEdit=new u(this),this.fences=new a(this),this.mathBlock=new s(this),this.stylize=new _(this);var r=this;setTimeout(function(){r.refresh(),r.selection.unlockScroll()},500),this.brush.run(),this.UserOp=S,this.searchPanel=new M(this),this.writingArea.focus(),this.sourceView=new I(this),null!=n&&n.trim().length?(this.selection.lockScroll(),this.selection.jumpIntoElemEnd(y("[cid]").last())):(y(this.sessionStr+">*:first-child").addClass("md-focus").closest("p").addClass("md-focus-p"),this.selection.jumpTop()),this.emoji=new N(this),this.word=new A(this),this.export=new L(this),(t.isMac||t.isNode)&&setTimeout(t.bindMenu,200),t.freshLock(),this.quickOpenPanel=new P(this),this.quickOpenPanel.init(),this.contextMenu=new D(this.sessionStr),this.dropTargetDom=null,this.strollingBySelect=!1,this.updateFocusMode(t.isFocusMode,!0),this.setTypeWriterMode(t.isTypeWriterMode,!1),setTimeout(function(){t.option.slientOpenFailure=!1},400)},tryEnterBusyMode:function(e){var t=this.writingArea;void 0!==e&&(F.inBusyMode=!1,F.isLocked||"false"!=t.getAttribute("contenteditable")||t.setAttribute("contenteditable","true"))},reset:function(e){F._onInitParse=!0;var t=new g.Node({type:g.TYPE.raw_edit,in:this.nodeMap,attachTo:this.nodeMap,text:e});this.tryEnterBusyMode(e),this.writingArea.setAttribute("contenteditable","false"),this.writingArea.innerHTML=t.parseFrom({skips:{old_code:!1}})[0],F.inBusyMode||F.isLocked||this.writingArea.setAttribute("contenteditable","true"),this.focusCid=null,this.lastCursor=null,F._needsUpdateSnap=!0,F._onInitParse=!1,this.refresh(!1)},quickRefresh:function(){this.refresh(!1,!0)},refreshUnder:function(e,t){this.mathBlock.renderAll(e),this.mathInline.renderAll(!1,e),this.fences.modeLoaded&&this.fences.refreshEditor(!1,t,e),this.diagrams.modeLoaded&&this.diagrams.refreshDiagram(t,e)},refresh:function(e,t){if(!F._onInitParse){var n=F.isActiveWindow();this.sourceView&&this.sourceView.inSourceMode?e&&this.sourceView.cm.refresh():this.brush&&(y(this.writingArea).find(".md-mathjax-panel").length||(this.mathBlock.currentCm=void 0),t||(this.nodeMap.toc.refresh(!0),this.docMenu.resizeFooter()),this.refreshUnder(void 0,e),n&&(this.brush&&this.stylize&&(this.brush.expand(void 0,!0),this.brush.updateWordCount(),F.isNode&&F.refreshImageCopyStatus(!0)),y("#typora-table-row-tracker, #typora-table-col-tracker").hide()))}},getJQueryElem:function(e){return e?e.nodeType==e.ELEMENT_NODE?y(e):y(e.parentNode):y()},getMarkElem:function(e){if(!e&&document.activeElement.nodeType==window.Node.ELEMENT_NODE&&(document.activeElement.hasAttribute("tabindex")||b.isType(document.activeElement.tagName,"TEXTAREA","INPUT")))return y(document.activeElement).closest("[cid]");if(!(e=e||window.getSelection().anchorNode||document.activeElement))return[];var t=e.nodeType==e.ELEMENT_NODE?y(e):y(e.parentNode);return!t.length||"TH"!==t[0].tagName&&"TD"!==t[0].tagName||(t=t.children(".td-span")),e.nodeType==e.TEXT_NODE&&"P"===t[0].tagName&&(t=y(e.nextElementSibling)),p.isNullOrEmpty(t.attr("cid"))&&(t=t.closest("[cid]")),t},autoRemoveUnholdable:function(e){var t=this.focusCid&&this.findElemById(this.focusCid).closest(".unholdable");if(t&&t.length)try{var n=this.findNodeByElem(t).getClosetParagraphLevel();e=e||w.makeEmptyCommand(this.selection.buildUndo());t.text().length||1<t.children(".md-line").length?t.removeClass("unholdable"):(this.undo.UndoManager.addUndoForRemove(e,n),e.redo.push(this.selection.buildUndo()),n.remove(),t.remove(),this.undo.register(e),this.focusCid=null)}catch(e){console.warn(e.stack)}},store:function(e,t){if((!this.sourceView||!this.sourceView.inSourceMode)&&(e=e||this.focusCid)){var n=e.id?e:this.nodeMap.get("allNodes").get(e);if(n){var i=this.findElemById(n.id);if(0<i.length){var r=i.textExcludeSVG(!0);return b.isType(n,n.TYPE.meta_block)?(r=r.replace(/\n$/,""),n.set("text",r)):b.isType(n,n.TYPE.math_block)?this.mathBlock.syncToNode(n):b.isType(n,n.TYPE.def_footnote,n.TYPE.def_link)?(b.reverseAttrFromElem(n,i),!t&&this.docMenu.resizeFooter()):n&&!i[0].querySelector("[cid]")?n.get("type")==n.TYPE.fences&&i.find(".CodeMirror-code").length?this.fences.syncToNode(n):(F.option.ignoreLineBreak&&(r=r.replace(/\u0a00/g," ")),n.set("text",r),n.clearChildren()):t&&n.get("children").map(function(e){i[0].querySelector("[cid='"+e.cid+"']")?this.store(e):e.remove()},this),b.isType(n,n.TYPE.meta_block)&&!t&&this.imgEdit.updateLocalRootUrl(),n}this.focusCid=null}}},cleanTooltip:function(){y(this.sessionStr).find(".md-tooltip-hide").hide(),G(),this.mathBlock.stopEditing()},refocus:function(e,t,n,i){if(this.isIME)return e;if(!this.sourceView||!this.sourceView.inSourceMode){var r,o,a=e?this.findElemById(e):this.getMarkElem(),s=this,l=this.nodeMap.allNodes.get(this.focusCid),c=s.findElemById(this.focusCid);if(s.docMenu.autoHideOutline(),e=void 0===e?a.attr("cid"):e,t&&e&&s.store(e),this.focusCid!=e||!a.hasClass("md-focus")){if(this.focusCid!=e&&(s.findElemById(s.focusCid).trigger("blur").trigger("losefocus").find(".md-tooltip-hide").hide(),G(),b.isType(l,b.TYPE.paragraph)&&l.unset("depth")),this.focusCid==e)return e;if(a.addClass("md-focus").trigger("refocus").closest("p").addClass("md-focus-p"),y(document.activeElement).trigger("focus"),this.undo.noStashedUndo()&&(o=this.undo.completeSnap(!0,!0),this.store(this.focusCid),this.lastCursor&&this.lastCursor.startId==this.lastCursor.endId&&(this.lastCursor.id=this.lastCursor.startId),o&&this.lastCursor&&this.focusCid==this.lastCursor.id&&(o.redo.push(this.lastCursor),s.undo.register(o,!0),o=null)),F.option.expandSimpleBlock&&(this.focusCid=S.simpleExpand(this,e))?("block"==document.querySelector("#md-searchpanel").style.display&&this.searchPanel.closePanel(),e=this.focusCid):this.focusCid=e,F.isLocked)return this.focusCid;this.focusCid&&l&&!(y.contains(c,a)||y.contains(a,c)||a.length&&a.is(c))&&(l.clearEmptyChar(),(r=this.simpleParse(l,i))&&(r[0].undo[0]=s.lastCursor,setTimeout(function(){r[0].redo.push(s.selection.buildUndo()),s.findElemById(r[2]).replaceWith(r[1]),o&&(w.append(o,r[0]),r[0]=o),s.undo.noStashedUndo()?s.undo.register(r[0],!0):s.undo.stashUndo(r[0]),s.quickRefresh(),s.selection.scrollAdjust(),s.undo.exeCommand(r[0].redo.last())},50))),!r&&o&&this.undo.register(o,!0),this.docMenu.highlightVisibleHeader(),this.focusCid&&this.brush.focusContainer(a)}return s.isIME=0,n||this.brush.expandOnDelay(),e}},focusAndRestorePos:function(){if(document.activeElement!=this.writingArea||!this.writingArea.contains(document.activeElement)){var e=y("content"),t=e.scrollTop();editor.writingArea.focus(),e.scrollTop(t)}},_bindGlobal:function(){var e,t,u=this;function n(){y(".ty-table-edit").length&&u.tableEdit.resizeTableEdit(y(".ty-table-edit").next()),y(".typora-table-tracker").hide(),u.setTypeWriterMode(F.isTypeWriterMode,!0),e=null}C("command+=",function(e){var t=u.getMarkElem(),n=t.attr("mdtype");b.isType(n,m.heading,m.line)&&u.stylize.changeHeadingLevel(u.findNodeByElem(t),!0),e.preventDefault(),e.stopPropagation()}),C("command+-",function(e){var t=u.getMarkElem(),n=t.attr("mdtype");b.isType(n,m.heading,m.line)&&u.stylize.changeHeadingLevel(u.findNodeByElem(t),!1),e.preventDefault(),e.stopPropagation()}),F.isNodeHtml?(C("ctrl+home",function(e){F.editor.selection.jumpTop()}),C("ctrl+end",function(e){F.editor.selection.jumpBottom()}),C("ctrl+z, command+z",function(e){if(u.writingArea.contains(e.target))return ClientCommand.undo(),!1}),C("ctrl+y, command+y, command+shift+z, ctrl+shift+z",function(e){if(u.writingArea.contains(e.target))return ClientCommand.redo(),!1}),C("ctrl+6",function(e){u.stylize.changeBlock("header6")}),t=F.isMac||F.isMacNode,C(t?"command+b":"ctrl+b",function(e){if(F.isLocked)return!1;e.preventDefault(),u.stylize.toggleStyle(g.TYPE.strong)}),C(t?"command+i":"ctrl+i",function(e){if(F.isLocked)return!1;e.preventDefault(),u.stylize.toggleStyle(g.TYPE.em)}),C(t?"command+u":"ctrl+u",function(e){if(F.isLocked)return!1;e.preventDefault(),u.stylize.toggleStyle(g.TYPE.underline)}),C(t?"command+a":"ctrl+a",function(e){e.preventDefault(),F.isNode&&ClientCommand.selectAll()}),F.isLinux&&C("ctrl+/",function(e){F.toggleSourceMode(),e.preventDefault()})):(C("ctrl+k",function(e){var t=u.selection.getRangy();if(t&&!b.isType(document.activeElement.tagName,"INPUT","TEXTAREA")){if(t.collapsed){var n=u.getMarkElem();t.setEnd(n[0],n[0].childNodes.length),u.selection.setRange(t,!0)}t.toString().length?S.backspaceHandler(u,e,"delSelection"):S.backspaceHandler(u,e,!0),e.preventDefault(),e.stopPropagation()}}),C("command+left, command+right, shift+command+left, shift+command+right",function(e){u.brush.expandOnDelay(!0)}),C("command+up, command+down",function(e){u.refocus()}),C("ctrl+h",function(e){u.selection.getRangy()&&!b.isType(document.activeElement.tagName,"INPUT","TEXTAREA")&&S.backspaceHandler(u,e,"Backspace")}),C("ctrl+d",function(e){u.selection.getRangy()&&!b.isType(document.activeElement.tagName,"INPUT","TEXTAREA")&&S.backspaceHandler(u,e,"Delete")}),C("ctrl+tab",function(e){F.isMac&&app.window.selectNextTab()}),C("ctrl+shift+tab",function(e){F.isMac&&app.window.selectPreviousTab()}),C("command+y",function(e){if(F.isLocked)return!1;u.undo.completeSnap(!0),F.editor.undo.redo(e),F.freshMenu()})),F.isMac||F.isNode||(F.isNodeHtml||(C("command+z, ctrl+z",function(e){if(F.isLocked)return!1;u.writingArea.contains(e.target)&&u.undo.undo(e)}),C("command+y, ctrl+y",function(e){if(F.isLocked)return!1;u.writingArea.contains(e.target)&&u.undo.redo(e)})),C("command+l, ctrl+l",function(e){e.preventDefault(),u.selection.selectLine()}),C("command+d, ctrl+d",function(e){e.preventDefault(),u.selection.selectWord()}),C("command+e, ctrl+e",function(e){e.preventDefault(),u.selection.selectPhrase()}),C("shift+command+d, shift+ctrl+d",function(e){if(F.isLocked)return!1;e.preventDefault(),u.selection.selectWord(),S.backspaceHandler(u,null,"delSelection")})),y(document).on("dragover",function(e){e.originalEvent.dataTransfer.dropEffect="none"}).on("dragstart",function(e){if(u.writingArea.contains(e.target))return!1}).on("drop",function(e){var t;if(F.isMac)return!0;t=e.originalEvent.dataTransfer.getData("text/html");var n,i=e.originalEvent.dataTransfer.files,r=e.originalEvent.dataTransfer.items;function o(e){if(ClientCommand.validatePandocInstall())if(!n&&F.changeCounter.isDiscardableUntitled())n=!0,window.getSelection().removeAllRanges(),ClientCommand.doImport(e);else{var t=B.app.openFile().activeWindow;t.webContents.once("did-finish-load",function(){t.webContents.executeJavaScript('setTimeout(function(){window.getSelection().removeAllRanges();ClientCommand.doImport("'+p.escapeInQuote(e)+'")}, 200)')})}}if(t){if(F.isLocked)return!1;S.pasteHandler(u,t)}else if(i&&i.length&&F.isNodeHtml)for(var a=0;a<r.length;a++){var s,l=r[a].webkitGetAsEntry(),c=i[a],d=B.getCurrentWindow();if(!l||l.isFile){if(s=c.path.match(/(?:^|\.)([^.]+)$/)){if(s=(s[1]||"").toLowerCase(),~["latex","ltx","tex","wiki","dokuwiki","docx","rst","rest","org","textile","opml"].indexOf(s)){o(c.path);continue}if(~R.allowedExtensions.indexOf(s)){B.app.openFile(c.path,{curWindow:d});continue}}}else l.isDirectory&&(F.filePath||F.getMountFolder()?B.app.openFolder(c.path):B.app.switchFolder(c.path,d));if(F.isLocked)return!1;0<a&&u.UserOp.insertParagraph(!1,u),te(c.path)}e.stopPropagation(),e.preventDefault()}).on("dragfile",function(e){e.originalEvent.data.resultFromFront="continue",H=e.originalEvent.data}).on("dragfileLeave",function(e){H=null}).on("paste",this.sessionStr,function(e){return!F.isLocked&&(u.sourceView.inSourceMode?void 0:S.pasteHandler(u,e.originalEvent,F._PasteContentFlag))}).on("pasteAsPlainText",this.sessionStr,function(e){return!F.isLocked&&(u.sourceView.inSourceMode?void(F.isMac&&app.window.pasteAsPlainText()):S.pasteHandler(u,e.originalEvent,!0))}).on("copy",this.sessionStr,function(e){b.isType(document.activeElement.tagName,"INPUT","TEXTAREA")||(u.refocus(void 0,!0),S.copyHandler(u,e.originalEvent))}).on("cut",this.sessionStr,function(e){return!F.isLocked&&(!!b.isType(document.activeElement.tagName,"INPUT","TEXTAREA")||(F.isNode?(F._CopyContentFlag="cut_before",B.getCurrentWindow().webContents.copy(),!1):(u.refocus(void 0,!0),u.snapSelection=u.selection.buildUndo(),S.copyHandler(u,e.originalEvent),void S.backspaceHandler(u,e,"delSelection"))))}).on("contextmenu",this.sessionStr,function(e){var t,n=y(e.target);if(!n.closest(".CodeMirror")[0]){if(b.isType(u.getMarkElem(e.target).attr("mdtype"),_.CONST.Selectable)||(t=u.selection.getRangy())&&""==t.toString()&&(t.collapse(!0),t.select(t.isBackward)),F.isNodeHtml&&F.editor.brush.expand(),"IMG"===e.target.tagName&&0==n.closest(".md-image.md-expand").length){y(".md-expand").removeClass("md-expand");var i=n.closest(".md-image").addClass("md-expand"),r=i.children(".md-meta")[0].length;(t=h.createRange()).moveToBookmark({containerNode:i.children(".md-meta")[0],start:r-1,end:r-1}),u.selection.setRange(t,!0),F.editor.brush.expand()}F.isNodeHtml&&F.contextMenu.show(e)}}).on("inline-input",function(e){u.selection.scrollAdjust()}).on("click","#md-notification .undo-btn",function(){u.undo.undo(),y("#md-notification").fadeOut()}).on("click","#md-notification .ok-btn",function(){y("#md-notification").fadeOut()}).on("focus","body",function(e){if(e.target==document.body)return!1}).on("click",f.resetClick),y(window).on("resize",function(){F.suppressResize||(e&&clearTimeout(e),e=setTimeout(n,300))}).on("mouseup",function(){u.stopScrolling(),u.brush.updateWordCountInSelection()}),F.isMac&&(y("#top-hotpot").on("mouseenter",function(e){1==e.which&&u.startScrolling(!0)}),y("#bottom-hotpot").on("mouseenter",function(e){1==e.which&&u.startScrolling(!1)}),y("#top-hotpot").on("mouseleave",function(e){u.stopScrolling()}),y("#bottom-hotpot").on("mouseleave",function(e){e.screenY+4>window.innerHeight||u.stopScrolling()}),app.window.isFullScreen()&&y("#top-hotpot, #bottom-hotpot").show()),y(u.sessionStr).on("change","[type='checkbox']",function(){var e=this.parentElement.getAttribute("cid"),t=this.checked;t?this.setAttribute("checked","checked"):this.removeAttribute("checked"),u.getNode(e).attr("checked",t,u,!1)}),document.addEventListener("selectionchange",function(e){var t;F.isNodeHtml&&(t=u.selection.getRangy(),y("svg.in-text-selection").attr("class",""),t&&t.getNodes([1],function(e){"svg"===e.tagName&&e.classList.add("in-text-selection")})),F.isFocusMode&&Z.call(u)},!1)},_bindKeyEvents:function(){var r,o,c,d=this,u=!1,i=!1,p=!1;function h(e){e?y("a, .md-def-url, .md-url").css("cursor","pointer"):y("a, .md-def-url, .md-url").css("cursor","")}d.isIME=0,y(document.body).on("keydown",function(e){if(d.docMenu.autoHideOutline(),document.body.classList.remove("show-word-count"),document.activeElement==document.body){var t=e.keyCode||e.which,n=y("content").scrollTop();y(d.sessionStr).focus(),"Delete"!=k[t]&&"Backspace"!=k[t]&&"Enter"!=k[t]||(e.originalEvent!=c&&(e.target=d.writingArea,c=e.originalEvent,y(d.sessionStr).trigger(e)),e.preventDefault()),y("content").scrollTop(n)}if(d.contextMenu.handleKeyEvent(e))return!1});var f=0,a=function(e){if("TEXTAREA"!=event.target.tagName&&"INPUT"!=event.target.tagName){e&&(f=-1,setTimeout(function(){f=0},0));var t=d.getMarkElem();d.focusCid=t.attr("cid"),$&&($.attr("contenteditable","true"),$=null),d.brush.addToQueue(d.focusCid),d.isIME=0,setTimeout(function(){d.isIME||(t.trigger("inline-input"),d.brush.brushQueue())},10)}},g=function(e){if(e&&(f=-1),"TEXTAREA"!=event.target.tagName&&"INPUT"!=event.target.tagName&&!d.isIME){if(d.isIME=1,F.isMac){var t=d.selection.getRangy(),n=d.getMarkElem(t.commonAncestorContainer);n.length&&!n.find("[cid]").length||t.collapsed||(S.backspaceHandler(d,null,"delSelection"),n=d.getMarkElem()),"false"==($=n.parent()).attr("contenteditable")?$=null:$.attr("contenteditable","false"),b.isType(n.attr("mdtype"),m.hr)&&n.attr("contenteditable","true")}d.selection.prepNode("",e,void 0,!0)}};y(d.sessionStr).on("keydown",function(e){c=e.originalEvent,d.keypressMsg=null;var t=e.keyCode||e.which,n="TEXTAREA"==e.target.tagName||"INPUT"==e.target.tagName;if(229!=t){if(d.contextMenu.handleKeyEvent(e))return!1;if(document.body.classList.contains("megamenu-opened"))"Esc"===k[t]&&F.megaMenu.hide();else{if(y(".dropdown-menu.open:not(#typora-sidebar), .dropdown-menu.show").removeClass("open").removeClass("show").find(".active").removeClass("active"),"Ctrl"!=k[t]&&"Command"!=k[t]||h(!0),b.isType(k[t],"Right","Left","Up","Down")){if(y(".context-menu:visible").length&&d.contextmenu.handleArrowKey(k[t]),"INPUT"==e.target.tagName&&e.target.classList.contains("mode")&&!e.ctrlKey&&!e.metaKey){if("Left"==k[t]&&0==e.target.selectionStart&&0==e.target.selectionEnd)return d.selection.moveUpOrDown(!0,e,!0),!1;if("Right"==k[t]&&e.target.selectionStart==e.target.selectionEnd&&e.target.selectionEnd==e.target.value.length)return d.selection.moveUpOrDown(!1,e,!0),!1}if(n&&b.isType(k[t],"Right","Left"))return;if(F.isLocked)return!0;if(F.inBusyMode&&e&&(e.shiftKey||e.metaKey||e.ctrlK)&&d.writingArea.setAttribute("contenteditable","true"),e.ctrlKey||e.metaKey){if(F.isMac&&e.metaKey&&("Up"==k[t]||"Down"==k[t]))return"Up"==k[t]?d.selection.jumpTop(e.shiftKey):d.selection.jumpBottom(e.shiftKey),!1;if(e.target.classList&&e.target.classList.contains("md-def-name")&&"Right"===k[t])return d.selection.jumpIntoElemEnd(y(e.target).closest("[mdtype]")),!1}if(F.isMac&&e.metaKey){var i={};y.extend(i,e),i.type="keyup",setTimeout(function(){y(e.target).trigger(i)},10)}e.shiftKey&&y(".md-focus .md-math-after-sym").text("​"),"Right"==k[t]||"Left"==k[t]?(d.lastCursor=d.selection.buildUndo(),d.brush.isAutoCompleteShown()&&d.brush.triggerAutoComplete(),!e.shiftKey&&d.selection.moveLeftOrRight("Left"==k[t],e)):"Up"!=k[t]&&"Down"!=k[t]||(d.lastCursor=d.selection.buildUndo(),d.brush.isAutoCompleteShown()?e.shiftKey?d.brush.hideAutoComplete():d.brush.changeAutoCompleteSelection("Up"==k[t],e):!e.shiftKey&&d.selection.moveUpOrDown("Up"==k[t],e))}if(!n){if("Esc"==k[t]){if(y("#table-insert-dialog:visible").modal("hide").length)return void y(F.editor.sessionStr).trigger("cursorChange");d.brush.triggerAutoComplete(!0),e.preventDefault()}else if("Tab"==k[t]){if(e.metaKey||e.ctrlKey||e.altKey)return;if(e.preventDefault(),!(e.shiftKey?S.lessIndent(d):S.moreIndent(d))){(s=d.getMarkElem()).hasClass("md-def-link");if(s.closest(".md-table").length)d.tableEdit.moveToNextCell(!0,e.shiftKey);else if(s.hasClass("md-def-link")||s.hasClass("md-def-footnote")){var r=d.getJQueryElem(window.getSelection().anchorNode).closest("span[contenteditable]");e.shiftKey?d.selection.selectAllElem(y(r.prevAll("span[contenteditable='true']")[0])):d.selection.selectAllElem(y(r.nextAll("span[contenteditable='true']")[0]))}else e.shiftKey||(d.selection.prepNode("\t",e),S.insertInlineText(d,null,"\t",d.selection.getOffset(s),null,!0),d.refocus(),d.brush.addToQueue(d.focusCid))}}else if("Backspace"==k[t]||"Delete"==k[t]){if(F.isNodeHtml){var o=!0;if(p)e.preventDefault();else if(p=!0,e.ctrlKey&&(d.selection.getRangy()||{}).collapsed?S.backspaceHandler(d,e,k[t]):o=S.backspaceHandler(d,e,k[t],!1,!0),null===o){p=!1;var a=d.focusCid||d.getMarkElem().attr("cid");d.undo.snap(a,x.DELETE),d.brush.addToQueue(d.focusCid)}else e.preventDefault(),setTimeout(function(){p=!1},20)}else{if(e.metaKey){var s;(s=d.getMarkElem(window.getSelection().commonAncestorContainer)).hasClass("md-expand");s.addClass("md-expand"),window.getSelection().modify("extend","backward","lineboundary")}S.backspaceHandler(d,e,k[t])}e.stopPropagation()}else if("Enter"==k[t]||F.isMac&&!e.shiftKey&&!e.metaKey&&e.ctrlKey&&"O"==String.fromCharCode(t)){if(y(".auto-suggest-container:visible .active").length)return d.brush.applyAutocompleteByKey(),void e.preventDefault();if(1==y(".ty-focusable-btn.selected").length){var l;if((l=d.selection.getRangy()).startContainer.classList&&l.startContainer.classList.contains("ty-focusable-btn"))return y(l.startContainer).trigger("btn-action"),void e.preventDefault();y(".ty-focusable-btn.selected").trigger("btn-action")}J.call(d,e.metaKey||e.ctrlKey,e.shiftKey),e.preventDefault(),e.stopPropagation()}u&&t==this.lastKey&&-1<[224,17,91,93].indexOf(t)&&this.lastKeyTime&&performance.now()-this.lastKeyTime<300?(e.preventDefault(),d.refocus(void 0,!0),this.lastKey=0):(this.lastKey=e.keyCode,this.lastKeyTime=performance.now()),u=!1}}}else F.isMac||n||d.isIME||f||(f=1,g())}).on("keypress",function(e){var t=e.keyCode||e.which;if(F.isLocked&&0<e.charCode)return e.ctrlKey||e.metaKey;if("TEXTAREA"!=e.target.tagName&&"INPUT"!=e.target.tagName&&!C.isCommand(e))if("Enter"==k[t])e.preventDefault();else if(0<e.charCode&&window.getSelection().rangeCount){d.lastKeyPressOn=new Date,d.selection.prepNode(String.fromCharCode(e.charCode),e);var n=d.getMarkElem().attr("cid");n!=d.focusCid&&d.refocus(n),d.brush.addToQueue(d.focusCid)}}).on("keyup",function(e){u=!0;var t,n=e.keyCode||e.which;("CTRL"!=k[n]&&"Command"!=k[n]||h(!1),"TEXTAREA"!=e.target.tagName&&"INPUT"!=e.target.tagName)&&("Right"==k[n]||"Left"==k[n]||"Up"==k[n]||"Down"==k[n]?!(i=e.shiftKey)&&!d.isIME&&!e.metaKey&&d.refocus():i&&"Shift"==k[n]?(i=!1,!d.isIME&&!e.metaKey&&d.refocus()):"Enter"==k[n]&&(2==(t=y("#write .md-focus")).length&&t.get(0).getAttribute("cid")===t.get(1).getAttribute("cid")?(y(t.get(1)).remove(),d.selection.jumpIntoElemEnd(y(t.get(0))),J.call(d,F.isMacOrMacNode?e.metaKey:e.ctrlKey,e.shiftKey)):t.next("div:not('[mdtype]')").remove().length&&J.call(d,F.isMacOrMacNode?e.metaKey:e.ctrlKey,e.shiftKey)))}).on("compositionend",a).on("compositionstart",g).on("compositionupdate",function(){f=-1}).on("input",function(e){if(!b.isType(e.target.tagName,"INPUT","TEXTAREA")){var s,t;if(0<f?(f=0,a()):d.brush.addToQueue(d.focusCid),F.option.ignoreLineBreak)if(s=d.selection.getRangy())"P"==s.startContainer.tagName?t=s.startContainer:s.startContainer.nodeType==document.TEXT_NODE&&"P"==s.startContainer.parentElement.tagName&&(t=s.startContainer.parentElement),t&&n(t),s.endContainer!==t&&s.endContainer.parentElement!==t&&(t="P"==s.endContainer.tagName?s.endContainer:"P"==s.endContainer.parentElement.tagName?ange.endContainer.parentElement:null)&&n(t);d.focusCid&&(r&&(clearTimeout(r),r=null),o&&d.focusCid!=o&&i(o),o=d.focusCid,r=setTimeout(function(){i(o),r=o=null},200))}function n(e){var t=d.selection.saveSelection(e,s);e.normalize();for(var n,i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];if(r.nodeType==document.TEXT_NODE){0;var o=r.textContent;" "!=o[0]&&"\n"!=o[0]||(o=o.substring(1));var a=e.childNodes[i+1];o.length&&a&&(a.insertBefore(document.createTextNode(o.replace(/[\u00a0\n]/g," ")),a.childNodes[0]),n=!0),r.textContent="\n"}else r.textContent.length}t&&n&&d.selection.restoreSelection(e,t)}function i(e){d.syncChange([{type:"sync",id:e,html:d.findElemById(e).html()}])}})},setCurLinkElem:function(e){j=e},tryOpenLink:function(e,t){if(t&&(e=j),e.length){var n=e.attr("href"),i=y.localize.getString("Need to define the reference link <b>[{0}]</b> with syntax <b>[{1}]: www.example.com</b>");if(this.undo.completeSnap(!0),e.hasClass("md-def-url"))this.tryOpenUrl_(e.text());else if(e[0].hasAttribute("data-ref")){var r=e.data("ref");if(void 0===(n=this.nodeMap.link_list.getHrefByRef(r,!0)))return f.showNotification(i.format(r,r),"warning"),!F.isLocked&&this.docMenu.addEmptyDef(r,g.TYPE.def_link),!1;if(""===n)return f.showNotification(i.format(r,r),"warning"),!1}n&&this.tryOpenUrl_(n,e.closest("[md-inline='autolink'], [md-inline='url']").length)}},tryOpenUrl_:function(e,t){function n(e){var t=reqnode("path").extname(e);-1<[".md",".markdown",".mmd",".text",".txt",".mdown"].indexOf(t)?B.app.openFileOrFolder(e,{forceCreateWindow:!0,mountFolder:F.getMountFolder()}):B.shell.openItem(a)}var i=e;if(e.match(/^#/)){var r=f.findAnchorElem(e);this.selection.jumpIntoElemBegin(r),this.selection.scrollAdjust(r,10)}else{if(!p.isFullUrl(e)){if(e=e.replace(/([#?][^.]+)$/,""),F.isMac&&window.app.path.openURL(decodeURI(e),(R.getCurrentFileFolderPath()||"")+"/"))return;if(F.isNode){var o=reqnode("fs-plus"),a=reqnode("path").resolve(R.getCurrentFileFolderPath()+"/",decodeURI(e));if(o.isFileSync(a))return void n(a);if(o.isFileSync(a+".md"))return void n(a+".md");if(o.isFileSync(a+".markdown"))return void n(a+".markdown")}if(!t)return f.showNotification(y.localize.getString("Cannot open location <code>$1</code>, do you mean <a href='https://$3'>https://$2</a> ? ").replace("$3",p.escapeForPreWrap(i)).replace("$2",p.escape(i)).replace("$1",p.escape(a))+"<a href='http://support.typora.io/Links#faq' class='default-btn'>"+y.localize.getString("Learn More…")+"</a>"),!1;e=/^[A-Za-z.+-]+:/.exec(i)?i:"http://"+i}F.isNode?reqnode("electron").shell.openExternal(e):window.open(e)}},_bindMouseEvents:function(){var u=this,p=!1;var h='.footnotes, [mdtype="table"], .md-task-list-item, .md-inline-math, .md-image';y(this.sessionStr).on("mouseover",h,function(e){1==e.which&&y(this).attr("contenteditable",!0).find(".md-math-after-sym").text("​")}).on("mousedown",".md-inline-math",function(e){1==e.which&&y(this).attr("contenteditable",!0)}).on("mouseenter",'[mdtype="heading"], [mdtype="paragraph"]',function(e){1==e.which&&y(this).find(".md-math-after-sym").text("​")}).on("mousedown",function(e){p=!1;var t=document.body.classList;if(t.remove("show-word-count"),F.isNode&&t.contains("typora-fullscreen")&&t.contains("native-window")&&B.getCurrentWindow().setMenuBarVisibility(!1),F.inBusyMode){var n=u.selection.getBlockFromMouseEvent(e);!e.shiftKey&&n.length?u.writingArea.setAttribute("contenteditable","false"):n.hasClass(".md-focus")||u.writingArea.setAttribute("contenteditable","true"),b.isType(n.attr("mdtype"),m.fences,m.hr,m.def_link,m.def_footnote,m.table,m.math_block)||n.addClass("md-focus").attr("contenteditable","true").closest("p").addClass("md-focus-p")}var i=y(e.target);if(y(".dropdown-menu.open:not(#typora-sidebar), .dropdown-menu.show").removeClass("open").removeClass("show").find(".active").removeClass("active"),i.closest("a").length&&!i.closest("img").length&&(F.isMacOrMacNode?e.metaKey:e.ctrlKey))return e.stopPropagation(),e.preventDefault(),!1;i.closest(".md-fences:not(.CodeMirror)").length||F.isMac||3!==e.which||y(e.target).closest("[md-inline]").addClass("md-expand"),u.lastCursor=u.selection.buildUndo(),u.isMousePressed=1===e.which}).on("click","[md-inline='link']>.md-content, .md-def-url",function(e){if(e.ctrlKey||e.metaKey)return u.tryOpenUrl_(y(this).text()),!1}).on("contextmenu",function(e){document.activeElement.hasAttribute&&document.activeElement.hasAttribute("tabindex")&&document.activeElement.hasAttribute("mdtype")&&window.getSelection().removeAllRanges(),j=y(e.target).closest("a")}).on("mousemove",function(e){p=!0,1==e.which&&F.inBusyMode&&u.selection.handleMouseSelection(e)}).on("click",function(e){(e.originalEvent||e).detail;var t=u.getMarkElem(e.target);if(u.docMenu.autoHideOutline(),u.brush.isAutoCompleteShown()&&u.brush.triggerAutoComplete(),u.searchPanel.isOpen()&&u.searchPanel.closePanel(!0),"INPUT"!==e.target.tagName||"checkbox"!==e.target.getAttribute("type")){if("TEXTAREA"===e.target.tagName||"INPUT"===e.target.tagName||e.target.classList&&e.target.classList.contains("code-tooltip"))return e.preventDefault(),void y(e.target).trigger("focus");if(t.hasClass("md-fences")&&u.fences.clickEventHandled.call(u.fences,e,t.attr("cid")))return!1;if(y(e.target).closest("a").length){if(e.stopPropagation(),e.preventDefault(),(F.isMacOrMacNode?e.metaKey:e.ctrlKey)||F.isLocked)return u.tryOpenLink(y(e.target).closest("a")),!1;var n=y(e.target).closest(".md-image"),i=n.closest('[md-inline="link"]');(i.length?i:n).addClass("md-expand")}var r=u.findNodeByElem(t);b.isType(r,g.TYPE.paragraph,g.TYPE.heading)&&y(".md-tooltip-remove").remove();var o=u.selection.getRangy();return o&&o.commonAncestorContainer==u.writingArea&&!o.collapsed?(e.stopPropagation(),!1):void 0}}).on("dblclick",function(e){if(function(e){var t=y(e.target).closest("[md-inline='image'],[md-inline='imgtag']");if(t.length){if("image"==t.attr("md-inline")){var n=u.selection.getRangy(),i=y(e.target);if(i.hasClass("md-image-src-span")||(i=i.closest(".md-image-src-span")),i.length){if(n){var r=(i.text().match(/\s['"]/)||{}).index;if(n.setStart(i[0],0),r){if(n.endOffset>r)return;n.setEnd(i[0].childNodes[0],r)}else n.setEnd(i[0],1);return u.selection.setRange(n)}}else i=y(e.target).closest(".md-content");if(i.length&&n){var o=i.text(),a=o.indexOf("]")+2;if(n.startOffset>a)return n.setStart(i[0].childNodes[0],a),n.setEnd(i[0].childNodes[0],o.length-1),n.select(n.isBackward);if(2<=n.startOffset&&n.endOffset>n.startOffset&&n.endOffset<a-1)return n.setStart(i[0].childNodes[0],2),n.setEnd(i[0].childNodes[0],a-2),n.select(n.isBackward)}return u.selection.selectAllElem(t)}if("IMG"==e.target.tagName)u.selection.selectAllElem(t)}}(e),F.isMac&&!/\S\s+\S/.exec(window.getSelection().toString()))return u.selection.selectWord(!1),!1}).on("mouseup",function(e){if(u.isMousePressed=!1,!b.isType(document.activeElement.tagName,"INPUT","TEXTAREA")&&!F.isLocked){y(h).filter(function(){return!(this==e.target||this.contains(e.target))}).attr("contenteditable",!1);var t=u.selection.getRangy();t&&!t.collapsed&&b.isType(t.commonAncestorContainer.tagName,"LI","UL","QUOTEBLOCK","ARTICLE")&&u.refocus(null);var n=t?t.commonAncestorContainer:e.target;if(n==u.writingArea||u.writingArea.contains(n)){var i=u.getMarkElem(e.target),r=i.length&&!i.find("[cid]").length?i.attr("cid"):void 0;if(i.closest(".md-fences:not(.CodeMirror)").length&&u.fences.focus(i.attr("cid")),!i.length&&e.target==document.querySelector(u.sessionStr)&&(!p||!t||t.collapsed))try{var o=u.nodeMap.getLast(),a=u.findElemById(o.cid);if(0<e.pageY-a.offset().top-a.height()){if(b.isType(o,m.paragraph,m.heading))u.selection.jumpIntoElemEnd(u.findElemById(o.getVeryFirst(!0).cid)),i=a;else{var s=w.makeEmptyCommand(u.selection.buildUndo()),l=u.selection.addUnholdable(o,s),c=u.findElemById(l.cid);u.undo.register(s),u.selection.jumpIntoElemBegin(c),i=c}u.refocus(),e.stopPropagation()}}catch(e){}try{clearTimeout(z),"BODY"==document.activeElement.tagName?q=0:window.getSelection().toString().length?(q=0,d()):1===q?(q=0,d()):0===q&&(z=setTimeout(function e(){u.isMousePressed?z=setTimeout(e,W):(q=0,d())},W),q++),function(){if(!(i=y(u.writingArea).find(".unholdable")).length||i.find("[cid='"+u.focusCid+"']").andSelf("[cid='"+u.focusCid+"']").length);else if(i.text().length||1<i.children(".md-line").length)i.removeClass("unholdable");else{var e=w.makeEmptyCommand(u.selection.buildUndo()),t=u.findNodeByElem(i).getClosetParagraphLevel();u.undo.UndoManager.addUndoForRemove(e,t),e.redo.push(u.selection.buildUndo()),t.remove(),i.remove(),u.undo.register(e)}}()}catch(e){console.warn(e.stack)}F.isLocked||F.inBusyMode||u.writingArea.setAttribute("contenteditable","true")}}function d(){F.isTypeWriterMode&&F.option.scrollWithCursor?u.selection.typeWriterScroll(null,null,function(){u.refocus(r)}):u.refocus(r)}}),y(document).on("mouseup",function(e){"INPUT"!=e.target.tagName&&(0==y(e.target).closest("#write").length&&(window.getSelection().toString().length&&(q=0,F.isTypeWriterMode&&F.option.scrollWithCursor?u.selection.typeWriterScroll(null,null,function(){u.refocus()}):u.refocus()),F.isLocked||F.inBusyMode||u.writingArea.setAttribute("contenteditable","true")),y(e.target).closest(".context-menu").length||u.contextMenu&&u.contextMenu.hide())});document.querySelector("content").addEventListener("wheel",function(e){Math.abs(e.deltaY)<4||F.isFocusMode&&F.isTypeWriterMode&&setTimeout(ee.bind(u),100)},!!F.option.passiveEvents&&{passive:!0}),y("content").on("scroll",function(e){if(F.preventScroll)return!1;1==e.buttons&&F.isFocusMode&&F.isTypeWriterMode&&setTimeout(ee.bind(u),100),y(".auto-suggest-container, .autoComplt-list").hide()}).on("click",function(i){function e(e,t){var n=document.createEvent("MouseEvents");n.initMouseEvent("mousedown",!0,!0,e.ownerDocument.defaultView,1,i.screenX,i.screenY+t,i.clientX,i.clientY+t,i.ctrlKey,i.altKey,i.shiftKey,i.metaKey,i.button),e.dispatchEvent(n)}function t(e,t){t?u.selection.jumpIntoElemEnd(e):u.selection.jumpIntoElemBegin(e),i.preventDefault(),i.stopPropagation()}if(i.target==this||i.target==u.writingArea){if(u.selection.getRangy())return;for(var n,r=window.innerHeight,o=document.querySelector("#write > *").getBoundingClientRect(),a=i.pageX>o.right-2,s=i.pageX<o.left+2,l=Math.min(o.right-2,Math.max(i.pageX,o.left+2)),c=i.pageY;c<r;c+=20)if(!(n=y(document.elementFromPoint(l,c))).find("[mdtype]").length&&n.closest("[mdtype]").andSelf("[mdtype]").length)return F.isNodeHtml?t(n,a):e(n[0],c-i.pageY),void u.refocus(n.attr("cid"));for(c=i.pageY;0<c;c-=20)if(!(n=y(document.elementFromPoint(l,c))).find("[mdtype]").length&&n.closest("[mdtype]").andSelf("[mdtype]").length)return F.isNodeHtml?t(n,!s):e(n[0],c-i.pageY),void u.refocus(n.attr("cid"))}})},simpleParse:function(e,t){var n=e.get("type")==m.line;if(e.get("type")==m.raw_edit||n&&/(^[`~>#|\-+*1-9=\[])|\n\s*\S/g.test(e.safeGetStrAttr("text"))){this.brush.pause();var i,r,o=this.undo.UndoManager.makeEmptyCommand(),a=e.getClosetParagraphLevel();return o.undo.push(this.selection.buildUndo()),o.undo.push(w.buildReplaceUndo(a)),i=e.parseFrom(t?{skips:{enableStartMatch:!0}}:void 0),(n=n&&1===i[1].length)&&b.isType(e,m.line)?(this.brush.restart(),null):(n?(i=e.separateBlockFromLine(),r="",o.redo.push(w.buildReplaceUndo(i[1])),i[0]&&(r+=i[0].toHTML(),w.addUndoForInsert(o,i[0])),r+=i[1].toHTML(),i[2]&&(r+=i[2].toHTML(),w.addUndoForInsert(o,i[2]))):(o.redo.push(this.undo.buildReplaceUndo(i[1][0])),w.addUndoForInsertArray(o,i[1].slice(1)),r=i[0]),this.brush.restart(),[o,r,a.cid])}},findElemById:function(e){return e?y("[cid='"+e+"']"):y()},findNodeByElem:function(e){return e.length?this.nodeMap.get("allNodes").get(e.attr("cid")):null},beforeInsertTextFromCandidate:function(e){var t=!1,n={preventDefault:function(){t=!0}};return this.selection.prepNode(e,n),!t},replaceText:function(e,t,n,i,r,o){if(this.sourceView.inSourceMode||b.isType(document.activeElement.tagName,"INPUT","TEXTAREA"))return!0;if(document.activeElement.contains(this.writingArea)&&!this.writingArea.contains(document.activeElement))return!1;var a,s,l,c,d,u,p,h,f=this.selection.rangy.createRange(),g=this.selection.getRangy(),m=0;if(f.setStart(t,n),f.setEnd(i,r),t&&t.hasAttribute&&t.hasAttribute("cid")&&!t.querySelector("cid")&&y(t).find("br").remove(),this.isIME)return this.selection.deRange(f,!0),!0;if(e.match(/\n/)||"WebViewInsertActionPasted"==o)return S.pasteHandler(this,e,!0),!1;if(!g.collapsed)return S.pasteHandler(this,e,!0),!1;if(c=(l=this.getJQueryElem(f.commonAncestorContainer)).closest("[cid]"),!(d=c.attr("cid")))return!1;if(u=g.getBookmark(c[0]),f.collapsed)return 1!=e.length||!(h=this.UserOp.hanldePair(this,e,this.getNode(d),u,void 0,f))||(this.undo.register(h),!1);if(l.closest("code, script").length)return!1;function v(){this.undo.snap(d,x.REPLACE,void 0,!0),p=e.length-f.toString().length,f.deleteContents(),f.insertNode(document.createTextNode(e)),u.start+=p,u.end+=p,g.moveToBookmark(u),this.selection.setRange(g),this.brush.addToQueue(d)}if(f.commonAncestorContainer==g.commonAncestorContainer&&0<=g.startOffset-f.endOffset&&g.startOffset-f.endOffset<=2||g.equals(f))return v.call(this),!1;return(s=this.selection.rangy.createRange()).setEnd(g.startContainer,g.startOffset),s.setStart(f.endContainer,f.endOffset),(a=s.toString()).length&&a.replace(/[*_\s\]]/g,"").length<2&&(function e(t){this.selection.deRange(t);var n=y(t.startContainer).closest(".md-meta"),i=y(t.endContainer).closest(".md-meta");t.collapsed||!n.length&&!i.length||3<m||n[0]!=i[0]&&(n.length&&t.setStartAfter(n[0]),i.length&&t.setEndBefore(i[0]),m++,e.call(this,t))}.call(this,f),v.call(this)),!1},getMarkdown:function(e){if(this.sourceView.inSourceMode)return this.sourceView.cm.getValue();var t=this.nodeMap.toMark();return e?t.replace(/\n+$/,""):t},getNode:function(e,t){return t&&!(e=e||this.focusCid)&&(e=this.refocus()),this.nodeMap.get("allNodes").get(e)},restoreLastCursor:function(e,t){if(e&&e.preventDefault(),this.lastCursor){if(document.activeElement!=this.writingArea){var n=y("content").scrollTop();this.writingArea.focus(),y("content").scrollTop(n)}this.undo.exeCommand(this.lastCursor,t?[]:void 0)}},toggleFocusMode:function(){F.isFocusMode=!F.isFocusMode,(B?B.app:window.app).setting.put("isFocusMode",F.isFocusMode),this.updateFocusMode(F.isFocusMode,!0)},updateFocusMode:function(e,t){e?Z.call(this):ee.call(this),t&&(F.isNode?window.ClientCommand.refreshViewMenu():F.isMac&&app.menu.getItem("View").submenu().getItem("Focus Mode").setState(F.isFocusMode))},setTypeWriterMode:function(e,t){if(F.isTypeWriterMode!=e||t){if(F.isTypeWriterMode=e){document.body.classList.add("on-typewriter-mode");var n=document.querySelector("content").clientHeight,i=(y("content"),(n-this.defaultTextHeight)/2);document.querySelector("#write-style").innerHTML="#write { \npadding-top: $1px;\npadding-bottom: 0;\n}\n#write:after {\nheight: $2px;\n}".replace(/\$1/g,i-this.defaultTextHeight).replace(/\$2/g,i+this.defaultTextHeight),F.editor.sourceView&&F.editor.sourceView.inSourceMode||this.selection.typeWriterScroll(null,null)}else t||(document.querySelector("#write-style").innerHTML=0,document.body.classList.remove("on-typewriter-mode"),this.selection.scrollAdjust());F.editor.sourceView.enableTypeWriterMode(e),t||(F.isNode?window.ClientCommand.refreshViewMenu():F.isMac&&app.menu.getItem("View").submenu().getItem("Typewriter Mode").setState(F.isTypeWriterMode))}},toggleTypeWriterMode:function(e){void 0===e&&(e=!F.isTypeWriterMode),this.setTypeWriterMode(e),(B?B.app:window.app).setting.put("isTypeWriterMode",e)},syncFullContent:function(){var e=F.editor.sourceView.inSourceMode;F.isMac?app.controller.syncFullContent(e):F.isNode&&F.isActiveWindow()&&F.getCurrentDocByNode().syncFullContent(e)},applyFullContent:function(e){if(!F.isActiveWindow()){var t=F.isMac?app.document.content:F.getCurrentDocByNode().getContent();if(void 0===t)return;this.undo.exeCommand({type:"sync",content:t,fromSourceMode:e},void 0,!0),this.refresh()}},syncChange:function(e){function t(e,t){return e.map(function(e){return e?"fences"==e.type?null:e:null},t)}if(F.isMac)app.controller.shouldTriggerSyncChange()&&(Y(),app.document.syncChange(JSON.stringify(t(e,this))));else if(F.isNode){var n=F.getCurrentDocByNode();F.shouldTriggerSyncChange()&&(Y(),n.syncChange(JSON.stringify(t(e,this))))}},applyChange:function(e){if(e&&!F.isActiveWindow()){var t=JSON.parse(e),n=!1;window.debugMode&&function(e){{if(!e)return;if("sync"!=e.type)return e.type;if(void 0!==e.html)return;if(void 0!==e.allHtml)return;if(void 0!==e.cmChanges)return;if(void 0!==e.tex)return;if(void 0!==e.srcChanges)return;if(void 0!==e.content);}}(t[0]),t.forEach(function(e){n=this.undo.exeCommand(e,void 0,!0)||n},this),n&&this.refresh()}},startScrolling:function(e){this.strollingBySelect=!0;var t=y("content"),n=t[0].scrollHeight-window.innerHeight,i=e?0:n;t.stop(!0).animate({scrollTop:i},Math.abs(i-t.scrollTop())/256*1e3,"linear")},stopScrolling:function(){this.strollingBySelect&&(y("content").stop(!0),this.strollingBySelect=!1)},onDropContent:function(e,t){if(!F.isMac||!F.isActiveWindow())return H=null,!1;if(t&&this.selection.setRange(t),H){var n,i=H.urls||[],r=H.folders||[];r.length?(r.map(function(e){app.controller.openFolder(e)}),F.getMountFolder()&&F.editor.library.showSidebar("files")):app.document.isLocked()||i.map(function(e,t){try{if((n=e.match(/(?:^|\.)([^.]+)$/))&&(n=n[1],~["txt","text","latex","ltx","tex","wiki","dokuwiki","docx","rst","rest","org","textile","opml","md","mmd","markdown","mdown","multimarkdown",""].indexOf(n)))return app.app.openInTypora(e),!1;0<t&&editor.UserOp.insertParagraph(!1,editor),te(e)}catch(e){console.warn(e)}})}else S.insertDom(e)}}),K=function(){editor.syncFullContent(),U=null},Y=function(){U&&clearTimeout(U),U=setTimeout(K,500)};V.prototype.scheduleFullContentSync=Y;var J=function(n,i){this.brush.pause(),this.brush.hideAutoComplete(),this.undo.completeSnap(!0);var r=this.getMarkElem();if(this.brush.brushNode(r.attr("cid")),r=this.getMarkElem(),b.isType(r.attr("mdtype"),g.TYPE.fences,g.TYPE.footnote))return!0;d=t=S.backspaceHandler(this,null,"delSelection",!0,!1);var e,t,o=(r=this.getMarkElem()).closest(".md-table").length,a=o,s=this,l=r.attr("cid"),c=this.store(l);if(F.isTypeWriterMode&&this.selection.lockScroll(),function(e){if(r.attr("mdtype")==g.TYPE.meta_block)try{var t=e.selection.getRangy();return!(!n&&!i&&t.collapsed&&t.endContainer.textContent.replace(/\n$/,"").length<=t.endOffset&&t.endContainer.textContent.match(/\n{2,}$/g))}catch(e){return!0}return!1}(this))(d=d||w.makeEmptyCommand()).undo.push(this.selection.buildUndo()),S.insertInlineText(this,null,"\n",this.selection.getOffset(r),d,!0),this.undo.register(d),this.brush.addToQueue(l);else if(function(e){var t=e.getNode(l);if(b.isType(t,m.def_link,m.def_footnote)&&b.isEmptyBlock(t))return!0}(this))d=this.UserOp.backToParagraph(s,this.getNode(l),!0,!1),t&&(d=w.append(t,d)),this.undo.register(d);else if(o)this.tableEdit.moveToNextCell(!0);else if(!a){var d;if(d=this.selection.prepNode("​",null,!0))t&&(d=w.append(t,d)),this.undo.register(d);else if(c&&(e=c.breakOn(n,this,i))){var u=this.findElemById(e.oldCid),p=u.parent("ol");s.findNodeByElem(p);if(u.replaceWith(e.newHtml),b.isType(this.getNode(e.nextFocus),g.TYPE.math_block))e.command.redo.push({type:"fences-pos",id:e.nextFocus,pos:{line:0,ch:0}}),setTimeout(function(){s.mathBlock.startEditing(e.nextFocus)},0);else{var h=this.findElemById(e.nextFocus).find("[cid].md-line");h.length&&(e.nextFocus=h.attr("cid")),this.selection.jumpIntoElemBegin(this.findElemById(e.nextFocus)),e.command.redo.push(this.selection.buildUndo())}this.focusCid=this.refocus(e.nextFocus,void 0,void 0,!0),this.findElemById(e.nextFocus).addClass("md-focus").closest("p").addClass("md-focus-p"),t&&(e.command=w.append(t,e.command)),this.undo.register(e.command);var f=this.findElemById(e.oldCid);f.length?f.find(".math-jax-postprocess, .mathjax-block").length||"math_block"==f.attr("mdtype")?(this.mathBlock.renderAll(),this.mathInline.renderAll(!1)):this.refreshUnder(f):this.quickRefresh()}}return(!e||!e.nextFocus)&&this.refocus(),this.brush.resume(),this.selection.scrollAdjust(),!0};V.prototype.pressReturn=J;var Q,G=function(){y(".md-tooltip-remove").remove(),y(".md-focus").removeClass("md-focus"),y(".md-focus-p").removeClass("md-focus-p"),y(".md-focus-container").removeClass("md-focus-container"),document.body.classList.remove("show-word-count")},X=!1,Z=function(){Q&&(clearTimeout(Q),Q=null),X||(X=!0,document.body.classList.add("on-focus-mode"))},ee=function(){X&&(X=!1,document.body.classList.remove("on-focus-mode"))};function te(e){if(window.app){if(app.document.isLocked())return}else if(F.isLocked)return!1;F.editor.sourceView.inSourceMode||(editor.focusAndRestorePos(),F.editor.imgEdit.doInsertFromURL(e,F.isMac))}n.exports=V}),define("app/document/MarkParser",["app/document/StringUtils","app/document/Node","exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/editor/Inline","app/document/Node","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileHelper","app/editor/UndoManager","app/editor/Emoji"],function(e,t,n){"use strict";var A=e("app/document/StringUtils"),l=e("app/document/Node"),E=l.Node,L=l.TYPE,i=e("app/editor/Inline"),_=e("app/editor/UndoManager"),I=e("app/editor/Emoji"),y={ul:/^(\s*)(([-+*])\s+)/,ol:/^(\s*)\d+\.\s+/,tasklist:/^(\s*)(([-+*])\s*)\[((x|X)| )\]\s+/},v=/^(\s*)([-+*>\[]|\d+\.)\s+/,b=/^(\s*)[^\s]/,w=null,p={ul:/^(\s*)([-+*])\s+/,ol:/^(\s*)(\d+\.)\s+/,tasklist:/^(\s*)([-+*]\s*\[((x|X)| )\])\s+/},h={ul:/^(\s{0,3})([-+*])\s+/,ol:/^(\s{0,3})(\d+\.)\s+/,tasklist:/^(\s{0,3})([-+*]\s*\[((x|X)| )\])\s+/},f=/\r\n|\r|\n|\u2424/,r=/^[ \u00A0]{0,3}$/,x=/^[\s\u00A0]*$/,C=/(^\s{0,3}>[ \t]*)(.*)$/,k=/(^\s*(#{1,6})\s*)([^\n]+?)(\s*#*\s*)$/,S=/(^\s*(#{1,6})\s+)([^\n]+?)(\s*#*\s*)$/,T=/^ *(=|-){2,}[\s\u00A0]*$/,F=/^\s*[-+*_<\[\{|#0-9`~=>$]/,M=/^( *(`{3,}|~{3,})[ \t\u00A0]*)([^\n`]+)? *$/,o=/^\s*(`{3,}|~{3,})\s*$/,N=/^\s*\${2}\s*$/,R=/^( {4}|\t)(\s*\S.*)$/,a=/^( {4}|\t)/,P=/^\s*([-+_*])\s*\1\s*\1(\s|\1)*$/,D=/^\s*\[toc\]\s*$/i,O=/^\s*\{:toc\}\s*$/i,B=/^\s?\{:\s*toc(\s*|(\s+.*))\}/,j=/^\s*\[([^\]]+)\]:(\s*<?)([^\s>]+)(>?)((\s+)["'(]([^\n]*)["')])?\s*$/,$=/^\s*\[\^([^\]]+)\]:\s*([^\n]*)$/,H=/^-{3}$/,U=/^ *\|([^\|]+\|.+)\|\s*$/,d=/^\s*\|(.+)\|\s*$/,W=/^ *\|(\s*[-:]+\s*\|[-| :]*)$/,q=/^ *([-:]+\s*\|[-| :]*)$/,z=/\|/,s={},V={},K={},g="  ",c=function(e){if(e.get("style")==E.ListType.ol){for(var t=function(e){if(e.get("style")==E.ListType.ol){for(var t=e.getFirstChild(),n=!1,i=t.get("after");i&&i._numText;){if(t._numText.trim()!=i._numText.trim())return!1;n=!0,i=(t=i).get("after")}return n}}(e),n=e.getFirstChild(),i=n._numText;n;)n._numText=void 0,n=n.get("after");t&&e.set("pattern",i),e.set("isFixed",t)}},Y=function(e){return(e||"").replace(/\t/g,g).length},u=0,m=1,J=2,Q=-1,G={paragraph:{shouldClose:function(e){return e.match(r)?(this.cur.set("tail",1),J):Q},onClose:function(e){1<this.cur._lines.length&&this.cur._lines[0].match(x)&&(this.cur.set("ahead",1),this.cur._lines.shift()),!this.cur._lines.length&&this.cur._lines.push(""),this.cur._lines.forEach(function(e){this.cur.append(new E({type:L.line,text:e}))},this),this.cur._lines=void 0,this.cur.set("text","")},onContinue:function(e){this.cur._lines.push(e)}},blockquote:{shouldClose:function(e){return e.trim().length?e.match(C)?u:e.match(/\t|( {2,})/)?u:Q:(this.cur.set("tail",1),J)},onClose:function(e){new Z(this.cur._lines,this.cur,null,null,this.skips),this.cur._lines=void 0,this.cur.unset("text"),(this.skips||{}).pass_format||this.cur.set("userIndent",this.cur._lineIndents),this.cur._lineIndents=void 0},onContinue:function(e){var t=this.cur._indent;s[t]||(s[t]=new RegExp("^(\\t|[> ](\\t| {0,"+(t||0)+"}))"));var n=(s[t].exec(e)||[""])[0];this.cur._lineIndents.push(n),this.cur._lines.push(e.substring(n.length))}},list:{shouldClose:function(e){var t,n=this.cur.getLastChild();return V[n._indent]||(V[n._indent]=new RegExp("^ {"+n._indent+",}|\\t")),e.match(V[n._indent])?(this.cur.unset("tail"),u):e.match(x)?(this.cur.set("tail",(this.cur.get("tail")||0)+1),1<this.cur.get("tail")?(this.cur.set("tail",1),m):u):(t=y[this.cur.get("style")].exec(e))?this.cur.get("style")!=E.ListType.ol?t[3]==this.cur._mark?0:1:u:this.lines[this.ln-1].match(x)?m:Q},onClose:function(){for(var e=this.cur.getLastChild(),t=this.cur.get("tail")||0;0<t&&!e._lines.last().trim().length;)e._lines.pop(),e._lineIndents.pop(),t--;new Z(e._lines,e,null,null,this.skips),e.unset("text"),(this.skips||{}).pass_format||e.set("userIndent",e._lineIndents),e._lines=void 0,e._indent=void 0,e._indentDecided=void 0,e._lineIndents=void 0,this.cur._mark=void 0,this.cur.unset("text"),(this.skips||{}).pass_format||c(this.cur)},onContinue:function(e,t,n){var i,r,o,a=this.cur.getLastChild(),s=Y(t),l=File.option.strictMarkdown?s-n:2,c=this.cur.get("style"),d=0;function u(e,t,n){n&&(e._lines=[]),e._lines.push(t)}if(n=n||(a?a.get("prespace"):0)||0,e.match(x)||this.cur.unset("tail"),!a)return c==E.ListType.ol&&(d=/^\s*(\d+)\.\s+/.exec(e)[1].length-1),a=new E({type:L.list_item,prespace:n,markindent:s-d-n}),this.cur.append(a),a._indent=l+n,c==E.ListType.ol&&(a._numText=(/^\s*(\d+\.\s+)/.exec(e)||[])[1],a._numLength=d),(o=y[E.ListType.task].exec(e))?(a.set("checked",!!o[5]),a.set("style",E.ListType.task),r=o[0],File.option.strictMarkdown||(a._indent+=6-l)):r=y[c].exec(e)[0],a._lineIndents=[r],void u(a,e.substring(r.length),!0);a._numLength=a._numLength||0,V[a._indent]||(V[a._indent]=new RegExp("^ {"+a._indent+",}|\\t"));var p,h,f=e.match(V[a._indent]);if(K[a._indent]||(K[a._indent]=new RegExp("^ {2,"+a._indent+"}|\\t")),p=(e.match(K[a._indent])||[""])[0].length,r=(K[a._indent].exec(e)||[""])[0],e=f?e.substring(r.length):e,!f&&(i=w[c].exec(e)))return n=(i[1]||"").length,t=i[0],s=Y(t),l=File.option.strictMarkdown?s-n:2,1<a._lines.length&&a._lines.last().match(x)?(a._lines.pop(),a.set("tail",1)):a.set("tail",0),this.cur.unset("tail"),new Z(a._lines,a,null,null,this.skips),(this.skips||{}).pass_format||a.set("userIndent",a._lineIndents),a.unset("text"),a._lines=void 0,a._lineIndents=void 0,a._indent=void 0,c==E.ListType.ol&&(d=/^\s*(\d+)\.\s+/.exec(e)[1].length-1),(a=new E({type:L.list_item,prespace:n,markindent:s-d-n}))._numLength=d,a._numText=(/^\s*(\d+\.\s+)/.exec(e)||[])[1],r=i[0],(o=y[E.ListType.task].exec(e))&&(a.set("checked",!!o[5]),a.set("style",E.ListType.task),r=o[0]),this.cur.append(a),a._indent=l+n,a._lineIndents=[r],void u(a,e.substring(r.length),!0);if(!a._indentDecided){if((i=b.exec(e))&&a._indent&&a._indent-n<4)if(i[1].length){var g=i[1].length,m=g+a._indent;m>n+a.get("markindent")&&(h=a._lines,v.exec(function(e){if(!e||0==e.length)return"";for(var t=e.length-1;0<=t;t--)if(0<e[t].trim().length)return e[t];return""}(h)))?g=a.get("markindent")-a._indent:m>=n+a.get("markindent")+4&&(g=g+a._indent-4-a.get("markindent")),a._indent+=g,this.cur.set("subindent",a._indent-a._numLength),a.set("subindent",a._indent-a._numLength),r+=e.substring(0,g),e=e.substring(g)}else a.set("subindent",Math.max(2,p-a._numLength));a._indentDecided=!!i}return a._lineIndents.push(r),void u(a,e,!1)}},fences:{shouldClose:function(e){var t;return(t=o.exec(e))&&this.cur._mark==t[1]?J:u},onContinue:function(e){this.cur._lines.push(e)},onClose:function(){this.cur.set("text",this.cur._lines.join("\n")),this.cur._mark=void 0,this.cur._lines=void 0;var e=this.lines[this.ln+1];void 0!==e&&e.match(x)&&(this.cur.set("tail",1),this.ln++)}},code:{shouldClose:function(e){return e.match(R)?u:e.trim().length?m:1<this.cur._lines.length&&!this.cur._lines.last().trim().length?m:u},onClose:function(){var e=this.lines[this.ln];e&&!e.trim().length&&this.cur._lines.push(e.replace(a,"")),1<this.cur._lines.length&&(this.cur._lines.last().match(x)?(this.cur.set("tail",1),this.cur._lines.pop(),1<this.cur._lines.length&&this.cur._lines.last().match(x)&&(this.cur._lines.pop(),this.ln--)):this.cur.set("tail",0)),this.cur.set("text",this.cur._lines.join("\n")),this.cur.attributes.type=L.fences,this.cur._lines=void 0},onContinue:function(e){this.cur._lines.push(e.replace(a,""))}}};function X(e,t,n){var i,r,o="",a="",s=[],l=0;if(!t){if(!(r=d.exec(e)))return null;e=r[1]}if(e=e.replace(/(^|[^\\])((`+)([\s\S]*?[^`])\3(?!`))/g,function(e,t,n){return s.push(n),[t,o,++l-1,a].join("")}),File.option.enableInlineMath&&(e=e.replace(/(^|[^\\])((\$+)([\s\S]*?[^$])\3(?!\$))/g,function(e,t,n){return s.push(n),[t,o,++l-1,a].join("")})),i=(e=e.replace(/\\\\/g,re.ESCAPE_ESCAPE).replace(/\\\|/g,re.ESCAPE_VLINE).replace(/\\\ /g,re.ESCAPE_SPACE)).split(z),t&&i.length<=1)return null;if(i.length<n&&File.option.enableInlineMath){var c=(e=e.replace(/\uE07A(\d+)\uE07B/g,function(e,t){return s[t-0]})).split(z);c.length==n&&(i=c)}return i.map(function(e){return(t=e.replace(/\uE022/g,"\\ ").replace(/\uE07A(\d+)\uE07B/g,function(e,t){return s[t-0]}))?t.replace(new RegExp(re.ESCAPE_ESCAPE,"g"),"\\\\").replace(new RegExp(re.ESCAPE_VLINE,"g"),"\\|"):t;var t})}var Z=function(e,t,n,i,r){w=File.option.strictMarkdown?h:p;var o=e;"string"==typeof e&&(o=e.split(f),"\n"===e.charCodeAt(e.length-1)&&(u-=1));var a,s,l,c,d,u=o.length;for(this.lines=o,s=t,l=n,c=i,d=r,(a=this).parent=s,a.cur=null,a.skips=d,a.ln=0,a.blocks=[],a.oldNode=c,a.nodeMap=s||c,a.nodeMap=a.nodeMap?a.nodeMap.get("in"):l,g=" ".repeat(File.option.indentSize),this.skips.enableMetaBlock=this.skips.enableMetaBlock&&!t;this.ln<=u;this.ln++)ee.call(this,o[this.ln],this.ln==u);return this};function ee(l,e){function h(e){if(E.isType(this.cur,L.paragraph)&&1==this.cur._lines.length&&this.cur._lines[0].match(x))return function(e){this.blocks.remove(e),e.remove()}.call(this,this.cur),this.cur=null,e.set("ahead",1),!0}function f(e){var t=this.lines[this.ln+1];if(void 0!==t&&t.match(x))return this.ln++,e.set("tail",1),!0;void 0!==t&&e.set("tail",0)}function g(e,t){var n,i=e=e||this.cur;this.oldNode&&!this.blocks.length?(E.isType(e,L.paragraph)&&E.isType(this.oldNode,L.line)?(e.set("type",L.line),e.set("text",e.getText())):(n=e.get("userIndent"),e.giveChildrenTo(this.oldNode)),this.oldNode.copyContentFrom(e),this.oldNode.set("userIndent",n),e._lines&&(this.oldNode._lines=e._lines),e.remove(),this.blocks.push(E.isType(this.oldNode,L.line)?this.oldNode.get("parent"):this.oldNode),i=this.oldNode):(this.parent?this.parent.append(e):this.blocks.length?this.blocks.last().insert(e):(console.sendError("parse error: "+e.getText()),e.set("parent",this.parent),e.set("in",this.nodeMap),e.set("attachTo",this.nodeMap)),this.blocks.push(e)),this.cur=t?i:null}var t,n,i;function m(e,t){this.cur&&(!E.isType(this.cur,L.paragraph)||this.cur._lines.length?(i.onClose&&i.onClose.call(this,t),t||null!=this.cur.get("tail")||this.cur.set("tail",0),g.call(this,this.cur,e)):this.cur=null)}function r(e,t,n){var i=new E({type:L.list,style:e,in:this.nodeMap,pattern:t});e==E.ListType.ol?i.set("start",n):i._mark=n,h.call(this,i),m.call(this),this.cur=i}function o(e){var t=e?q:W;if(n=X(l,e)){var n,i,r=this.ln+1,o=this.lines.length,a=this.lines[r],s=[];if(r<o&&this.lines[r].match(t))for(r++;r<o&&(null,i=X(this.lines[r],e,n.length));r++)s.push(i);if(s.length)return a=e?a.split(z):a.replace(/^ *\||\| *$/g,"").split(z),c.call(this,n,a,s,r-1,e),!0}return!1}function a(e){n=new E({type:L.toc,in:this.nodeMap,pattern:e}),h.call(this,n),f.call(this,n),m.call(this,!0),g.call(this,n)}function c(e,t,n,i,r){var a,o=(this.skips||{}).pass_format,s=new E({type:L.table,in:this.nodeMap,style:!o&&t&&r?"npTable":void 0}),l=e.length,c=o||function(e,t,n){if(!t||!n)return!0;for(var i=0;i<e.length;i++){var r=(e[i]||"").length;if(!(40<r)){var o=A.wcswidth(e[i]);if(r!=(t[i]||"").length&&o!=A.wcswidth(t[i]))return!1;for(var a=0;a<n.length;a++){var s=(n[a]||[])[i]||"";if(!(40<s.length)&&r!==s.length&&o!=A.wcswidth(s))return!1}}}return!0}(e,t,n);function d(e,t){var n,i=new E({type:L.table_row,parent:e,in:e.get("in"),header:!a,before:a});for(p=0;p<l;p++){var r=(t[p]||"").match(/^\s*/)[0];t[p]=(t[p]||"").substring(r.length);var o=(t[p]||"").match(/\s*$/)[0];n=new E({type:L.table_cell,parent:i,in:i.get("in"),before:n,text:(t[p]||"").trim(),marginLeft:c?void 0:r,marginRight:c?void 0:o})}return i}if(n=n||[[]],t=t||new Array(e.length),s.set("alignText",c?void 0:t.slice(0)),!o&&t&&n){var u=[e.join("|"),t.join("|")].concat(n.map(function(e){return e.join("|")}));r||(u=u.map(function(e){return"|"+e+"|"})),s.set("userText",u)}for(var p=0;p<l;p++)t[p]=t[p]||"",t[p].match(/^ *-+: *$/)?t[p]="right":t[p].match(/^ *:-+: *$/)?t[p]="center":t[p].match(/^ *:-+ *$/)?t[p]="left":t[p]=null;s.set("align",t),a=d.call(this,s,e),n.forEach(function(e){a=d.call(this,s,e)},this),h.call(this,s),m.call(this),i&&(this.ln=i),f.call(this,s),g.call(this,s),this.cur=null}if(this.cur){i=G[this.cur.get("type")];var s=!e&&i.shouldClose.call(this,l);if(0<s||e){if(m.call(this,!1,e),2==s)return}else if(!s)return void(i.onContinue&&i.onContinue.call(this,l))}if(!e)if(this.skips.old_code||!(t=R.exec(l))){if((t=T.exec(l))&&E.isType(this.cur,L.paragraph)&&!A.isNullOrBlank(this.cur._lines.last()))return n=new E({type:L.heading,depth:"="==t[1]?1:2,text:this.cur._lines.pop(),pattern:"{0}\n"+l,in:this.nodeMap}),h.call(this,n),m.call(this),f.call(this,n),void g.call(this,n);if(l.match(F)){if(t=C.exec(l))return n=new E({type:L.blockquote,in:this.nodeMap,pattern:t[1]}),h.call(this,n),n._lines=[t[2]],n._indent=t[1].replace(/[ \u00A0]*>/,"").length,n._lineIndents=[t[1]],m.call(this),void(this.cur=n);if(t=(File.option.strictMarkdown?S:k).exec(l))return n=new E({type:L.heading,depth:t[2].length,text:t[3],pattern:(this.skips.enableStartMatch?t[1].replace(/#$/,"# "):t[1])+"{0}"+t[4],in:this.nodeMap}),h.call(this,n),f.call(this,n),m.call(this),void g.call(this,n);if(this.skips.enableMetaBlock&&0==this.ln&&l.match(H)){var d=this.ln+1,u=this.lines.length;if(!(p=this.skips.enableStartMatch||!1))for(;d<u;d++)if(this.lines[d].match(H)){p=d>this.ln+1;break}if(p)return n=new E({type:L.meta_block,in:this.nodeMap,text:this.lines.slice(this.ln+1,d).join("\n")}),h.call(this,n),this.ln=d,f.call(this,n),m.call(this,!0),void g.call(this,n)}if(t=P.exec(l))return n=new E({type:L.hr,pattern:l.trim(),in:this.nodeMap}),h.call(this,n),f.call(this,n),m.call(this,!0),void g.call(this,n);if(t=y.ul.exec(l))return B.exec(this.lines[this.ln+1]||"")?(a.call(this,l+"\n"+this.lines[this.ln+1]),void this.ln++):(r.call(this,E.ListType.ul,t[2],t[3]),void(i=G[L.list]).onContinue.call(this,l,t[0],t[1].length));if(t=y.ol.exec(l))return r.call(this,E.ListType.ol,t[0].replace(/\d+/,"{0}"),t[0].match(/\d+/)[0].replace(/^1$/,"")),void(i=G[L.list]).onContinue.call(this,l,t[0],t[1].length);if((t=l.match(N))&&!this.skips.math_block){var p;d=this.ln+1,u=this.lines.length;if(!(p=this.skips.enableStartMatch||!1))for(;d<u;d++)if(this.lines[d].match(N)){p=!0;break}if(p)return n=new E({type:L.math_block,in:this.nodeMap,text:this.lines.slice(this.ln+1,d).join("\n")}),h.call(this,n),this.ln=d,f.call(this,n),m.call(this,!0),void g.call(this,n)}if(t=M.exec(l))return(n=new E({type:L.fences,lang:t[3],pattern:t[1]+"{0}",in:this.nodeMap}))._mark=t[2],n._lines=[],h.call(this,n),m.call(this),void(this.cur=n);if(l.match(D))return void a.call(this);if(l.match(O))return void a.call(this,l);if(o.call(this,!1))return;if(this.skips.enableStartMatch&&(t=U.exec(l))){var v=X(l,!1);if(v&&1<v.length)return void c.call(this,v)}if(t=$.exec(l))return n=new E({type:L.def_footnote,ref:t[1],text:t[2],in:this.nodeMap}),h.call(this,n),f.call(this,n),m.call(this,!0),void g.call(this,n);if(t=j.exec(l))return n=new E({type:L.def_link,ref:t[1],href:t[3],title:t[7],in:this.nodeMap,pattern:"[;]:"+t[2]+";"+t[4]+(t[5]?";"+t[6]:"")}),h.call(this,n),f.call(this,n),m.call(this,!0),void g.call(this,n)}else if(o.call(this,!0))return;this.cur||(this.cur=new E({type:L.paragraph,in:this.nodeMap}),this.cur._lines=[]),E.isType(this.cur,L.paragraph)?this.cur._lines.push(l):i&&i.onContinue&&i.onContinue.call(this,l)}else E.isType(this.cur,L.code)&&i?i.onContinue&&i.onContinue.call(this,l):E.isType(this.cur,L.paragraph)&&(this.cur._lines.last()||"").trim().length?this.cur._lines.push(l):(n=new E({type:L.code,pattern:t[1],in:this.nodeMap}),h.call(this,n),n._lines=[t[2]],m.call(this),this.cur=n)}E.parseFrom=function(e,t,n,i){return n=n||{},new E({type:L.raw_edit,in:t,attachTo:n.noTop?null:t,text:e}).parseFrom(n,void 0,i)},E.prototype.parseFrom=function(e,t,n){if(e=e||{},E.isType(this.get("parent"),L.table_row))return this.set("type",L.table_cell),this.set("text",this.safeGetStrAttr("text").replace(/\n|\r/gi,"").replace(/([^\\])\|/gi,"$1|")),!n&&this.toHTML();if(!E.isType(this,L.line,L.raw_edit,L.list_item))return[!n&&this.toHTML(),[this]];var i=function(e){if(E.isType(e,L.list_item)&&!e.get("children").length){var t=new E({type:L.paragraph,text:e.get("text"),parent:e,in:e.get("in")});return e.set("text",""),t}return null}(this)||this,r=e.skips||{};if(t=t||i.get("text"),File.option.ignoreLineBreak&&(t=t.replace(/\u0a00/g," ")),this.get("type")===L.line&&(t=t.replace(/\r?\n/,"")),r.enableMetaBlock=this.get("attachTo")&&!this.get("before"),r.old_code=!1!==r.old_code,this.isBlock(!0)){var o=this.get("before"),a=this.get("after"),s=new Z(t,null,i.get("in"),i,r).blocks;return s.length<=1?[!n&&this.toHTML(),[this]]:(s[0].set("before",o),s.last().set("after",a),[!n&&l.NodeCollectionUtils.toHTML(s),s])}};var te=function(e){var t=e.last();if(t)return t.text||""},ne={escape:/^\\([\\`*{}\[\]()#+\-.!_>$|<~])/,escape2:/^[\uE013\uE014\uE018\uE020]/,autolink:/^<\uE016?((([^ >]+(@|:)[^ >]+))|(\s*www\.[^ >]+))\uE017?>/,url:/^\uE016([^\uE017]+)\uE017/i,comment:/^<!--[\s\S]*?-->/,br:/^<br[\s\/]*>(\s*<\/br>)*/,tag:/^<\s*\/?\s*[\w-]+(\s+("[^"]*"|'[^']*'|[^'">])*)?\/?>/,underline:/^<u>([^\r]*?\S)<\/u>/,atag:/^(<a\s.+?>)(.*?)(<\/\s*a>)/,imgtag:/^<img(\s+.+)*?\s+src=("([^"]+)"|'([^']+)').*?(\/?\s*>.*?(<\/img>)?)/,link:/^\[((?:\[[^\]]*\]|[^\[\]])*)\]\(<?((?:\([^)]*\)|[^()])*?)>?[ \t]*((['"])(.*?)\4[ \t]*)?\)/,image:/(^\!\[((?:\[[^\]]*\]|[^\[\]])*)\]\()(<?((?:\([^)]*\)|[^()])*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?)(\)(?:{([^{}\(\)]*)})?)/,reflink:/^(!?)\[(inside)\]\s*\[([^\]]*)\]/,strong:/^(\*\*|__)(?=\S)([^\r]*?\S?[*_]?)\1/,strong_esp:/^\uE031([^\uE031]+)\uE031/,em1:/^(\_)(?=\S)([^\r]*?[^\s_])\1(?!\1)/,em2:/^(\*)(?=\S)([^\r]*?[^\s*])(\1{1}|\1{3})(?!\1)/,highlight:/^(\=\=)(?=\S)([^\r]*?\S)\1/,code:/^(`+)([\s\S]*?[^`])\1(?!`)/,del:/^~~(?=\S)([\s\S]*?\S)~~/,text:/(\s|\S)+?[^\u200B\uE010-\uE020\uE006\\<!\[_*`&{\$\:~\^\="'\-]*/,footnote:/^\[\^([^\]]+)\]/,attr:/^{( *([#.][-\w_\uE006]+ *|[-\w_\uE006]+=[-\w_"'\uE006]+ *)+)}/,html:/(comment|closed|closing)/,entity:/^&[a-z]+;/i,emoji:/^(\u200B*):([+\-\w\uE006]+):(\u200B*)/,inline_math:/^\$.*(?:[^\\])\$/,subscript:/^~(([^\s]|(\\\s))+?)~/,superscript:/^\^(([^\s]|(\\\s))+?)\^/,linebreak:/[ \u00A0]{2}$/};function ie(e,t,n){this.options=e||ue({},be.defaults),this.options.decorate=t||i.decorate,this.options.context=n||this,this.rules=ne.normal,this.options.gfm?this.options.breaks?this.rules=ne.breaks:this.rules=ne.gfm:this.options.pedantic&&(this.rules=ne.pedantic),File.option.enableHighlight&&(this.rules.escape2=/^[\uE013\uE014\uE015\uE018\uE020]/),File.option.enableSuperscript?File.option.enableHighlight?this.rules.escape=/^\\([\\`*{}\[\]()#+\-.!_>$|<~^=])/:this.rules.escape=/^\\([\\`*{}\[\]()#+\-.!_>$|<~^])/:File.option.enableHighlight&&(this.rules.escape=/^\\([\\`*{}\[\]()#+\-.!_>$|<~=])/)}ne._inside=/(?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*/,ne._href=/\s*<?([\s\S]*?)>?(?:\s+['"]([\s\S]*?)['"])?\s*/,ne._tag="(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:/|@)\\b",ne.html=ce(ne.html)("comment",/<!--[\s\S]*?-->/)("closed",/<(tag)[\s\S]+?<\/\1>/)("closing",/<tag(?:"[^"]*"|'[^']*'|[^'">])*?>/)(/tag/g,ne._tag)(),ne.link=ce(ne.link)("inside",ne._inside)("href",ne._href)(),ne.reflink=ce(ne.reflink)("inside",ne._inside)(),ne.normal=ue({},ne),ne.pedantic=ue({},ne.normal,{strong:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,em:/^_(?=\S)([\s\S]*?\S)_(?!_)|^\*(?=\S)([\s\S]*?\S)\*(?!\*)/}),ne.gfm=ne.normal,ne.breaks=ue({},ne.gfm,{text:ce(ne.gfm.text)("{2,}","*")()}),ie.rules=ne;var re={UNDER_CHAR:"",MATH_CHAR:"",DEF_FOOT_PERFIX_CHAR:"",ESCAPE_SATR:"",ESCAPE_UNDERLINE:"",ESCAPE_EQUAL:"",URL_START:"",URL_END:"",ESCAPE_END_SQUARE_BRACKET:"",NOT_USED:"",ESCAPE_ESCAPE:"",ESCAPE_VLINE:"",ESCAPE_SPACE:""},oe={"":"[^","":"*","":"_","":"=","":"]","":"\\"},ae={"":"_","":"","":""},se={"\\\\":re.ESCAPE_ESCAPE,"\\*":re.ESCAPE_SATR,"\\=":re.ESCAPE_EQUAL,"\\_":re.ESCAPE_UNDERLINE,"\\]":re.ESCAPE_END_SQUARE_BRACKET};function le(e){return e.replace(/[\uE006-\uE020]/g,function(e){return oe[e]?"\\"+oe[e]:ae[e]||""})}function ce(i,r){return i=i.source,r=r||"",function e(t,n){return t?(n=(n=n.source||n).replace(/(^|[^\[])\^/g,"$1"),i=i.replace(t,n),e):new RegExp(i,r)}}function de(){}function ue(e){for(var t,n,i=1;i<arguments.length;i++)for(n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}ie.skipLink={autolink:1,url:1,link:1,reflink:1},ie.prototype.output=function(e,t,n,i,r){t=t||this.options.decorate,(i=ue(i||{},this.options.skipOp)).attr=!1!==i.attr,File.option.enableInlineMath||(i.inline_math=!0),File.option.enableSubscript||(i.subscript=!0),File.option.enableSuperscript||(i.superscript=!0),File.option.enableHighlight||(i.highlight=!0);var o,a,s,l=(r=r||{cursorDiff:[],openQuote:null}).cursorDiff||[],c=0,d=[],u=this.options;function p(e,t){var n=e.last();n&&n.type===L.plain?n.text+=t:e.push({type:L.plain,text:t})}function h(e){return N="",e.map(function(e){N+=t(e,u)}),N}for(n||(e=function(e,t){for(var n,i=/([a-z0-9])_([a-z0-9])/gi;n=i.exec(e);)e=e.substring(0,n.index+1)+re.UNDER_CHAR+e.substring(n.index+2),i.lastIndex&&i.lastIndex--;return e=e.replace(/\\[\*_=\]\\]/gi,function(e){return se[e]||e}),t&&e.length<2e4&&(e=e.replace(/((?:(https?:\/\/(\w|([-+.,!\/~?%&=:#\uE006](?![\s.~*-,]|$)))+)|((mailto:\/{0,2})?[a-z0-9][a-z0-9\-_+\.\uE006]*(@)[a-z0-9][a-z0-9\-_\uE006]*\.(com|co|net|org|edu|io|tv|fm|me|info|cc|ca|de|cn|ru)(\.[a-z0-9][a-z0-9\-_\uE006]+)?)|(www\.[a-z0-9][a-z0-9\-_\uE006]*(\.[a-z0-9\-_\uE006]+)+\/?(\w|([-+.,!\/~?%&=:#\uE006](?![\s.~*-,]|$)))*)))/gi,re.URL_START+"$1"+re.URL_END)),e}(e,!i.url));e;)if(s=this.rules.escape2.exec(e))c+=s[0].length,e=e.substring(s[0].length),d.push({type:L.escape,text:oe[s[0]]});else if(s=this.rules.escape.exec(e))c+=s[0].length,e=e.substring(s[0].length),d.push({type:L.escape,text:s[1]});else if(i.autolink||!(s=this.rules.autolink.exec(e)))if(i.url||!(s=this.rules.url.exec(e)))if(s=this.rules.comment.exec(e))c+=s[0].length,e=e.substring(s[0].length),o=s[0],d.push({type:i.comment?L.tag:L.comment,text:o});else if(s=this.rules.br.exec(e))c+=s[0].length,e=e.substring(s[0].length),d.push({type:"br",text:s[0]});else if(s=this.rules.tag.exec(e)){var f;if(!i.underline&&(f=this.rules.underline.exec(e))){c+=f[0].length,e=e.substring(f[0].length),d.push({type:L.underline,inner:this.output(le(f[1]),t,!0,i),text:f[0]});continue}if(!i.atag&&(f=this.rules.atag.exec(e))&&f[2].trim().length){c+=f[0].length,e=e.substring(f[0].length),d.push({type:L.atag,inner:this.output(f[2],t,!0,i),left:f[1],right:f[3],href:le((f[1].match(/\s+href=['"]([^'"]+)/)||[])[1]||"")});continue}if(!i.imgtag&&(f=this.rules.imgtag.exec(e))&&(f[3]||f[4]).trim().length){c+=f[0].length,e=e.substring(f[0].length);var g=(/\sstyle=(['"])(.+?)\1/.exec(f[0])||[])[2]||"",m=(/(^|[^\w-])width\s*:\s*(.+?)(\s*;|$)/.exec(g)||[])[2],v=(/(^|[^\w-])height*:\s*(.+?)(\s*;|$)/.exec(g)||[])[2],y=(/(^|[^\w-])zoom*:\s*(.+?)(\s*;|$)/.exec(g)||[])[2];m||(m=(/\swidth=(['"])(.+?)\1/.exec(f[0])||[])[2],/\d\s*$/.exec(m||"")&&(m+="px;")),v||(v=(/\sheight=(['"])(.+?)\1/.exec(f[0])||[])[2],/\d\s*$/.exec(v||"")&&(m+="px;")),d.push({type:L.imgtag,text:f[0],href:le(f[3]||f[4]),width:m,height:v,zoom:y});continue}c+=s[0].length,e=e.substring(s[0].length),o=s[0],d.push({type:L.tag,text:le(o)})}else if(!(s=this.rules.link.exec(e))||i.link)if(!(s=this.rules.image.exec(e))||i.image)if(!i.footnote&&c&&(s=this.rules.footnote.exec(e))){c+=s[0].length,e=e.substring(s[0].length);var b=(s[2]||s[1]).replace(/\s+/g," ");d.push({type:L.footnote,inner:this.output(s[1],t,!0,ie.skipLink),text:le(s[1])})}else if(!(s=this.rules.reflink.exec(e))||i.reflink&&!s[1])if(i.attr||!(s=this.rules.attr.exec(e)))if(s=this.rules.strong.exec(e))c+=s[0].length,e=e.substring(s[0].length),d.push({type:L.strong,pattern:s[1],inner:this.output(s[2],t,!0,i,r),text:s[2]});else if(s=this.rules.em1.exec(e))c+=s[0].length,e=e.substring(s[0].length),d.push({type:L.em,pattern:s[1],inner:this.output(s[2],t,!0),text:s[2]});else if(s=this.rules.em2.exec(e)){var w=(s[2]+s[3].substring(1,3)).match(/\s\*(?!\*)/);if(w){c+=w.index+1,e=e.substring(w.index+1),p(d,s[0].substr(0,w.index+1));continue}if("***"===s[3]&&!s[2].match(/\*\*/)){c+=s[0].length-2,e=e.substring(s[0].length-2),d.push({type:L.em,pattern:s[1],inner:this.output(s[2],t,!0),text:s[2]});continue}c+=s[0].length,e=e.substring(s[0].length),d.push({type:L.em,pattern:s[1],inner:this.output(s[2]+s[3].substring(1,3),t,!0),text:s[2]+s[3].substring(1,3)})}else if(s=this.rules.code.exec(e))c+=s[0].length,e=e.substring(s[0].length),d.push({type:L.code,pattern:s[1],text:s[2]});else if(s=this.rules.del.exec(e))c+=s[0].length,e=e.substring(s[0].length),d.push({type:L.del,pattern:"~~",inner:this.output(s[1],t,!0),text:s[1]});else if((s=this.rules.emoji.exec(e))&&I.data[s[2]=s[2].replace(/\uE006/g,"_")])e=e.substring(s[0].length),d.push({type:L.emoji,text:s[2],inner:I.data[s[2]]}),!s[1].length&&(l[c]=1),c+=s[0].length,!s[3].length&&(l[c]=1);else{if(!i.subscript&&(s=this.rules.subscript.exec(e))){e=e.substring(s[0].length);var x=[];(s=s[1].split(/\\\s/g))[0]&&x.push({type:L.plain,text:s[0]});for(var C=1;C<s.length;C++)x.push({type:L.escape,text:" "}),s[C]&&x.push({type:L.plain,text:s[C]});d.push({type:L.subscript,inner:h(x),text:s[0]})}if(!i.superscript&&(s=this.rules.superscript.exec(e))){e=e.substring(s[0].length);x=[];(s=s[1].split(/\\\s/g))[0]&&x.push({type:L.plain,text:s[0]});for(C=1;C<s.length;C++)x.push({type:L.escape,text:" "}),s[C]&&x.push({type:L.plain,text:s[C]});d.push({type:L.superscript,inner:h(x),text:s[0]})}if(i.inline_math||!(s=this.rules.inline_math.exec(e)))if(i.highlight||!(s=this.rules.highlight.exec(e)))if(s=this.rules.entity.exec(e))c+=s[0].length,e=e.substring(s[0].length),A.decodeHtmlEntity(s[0])?d.push({type:L.html_entity,inner:s[0],text:s[0]}):p(d,s[0]||"");else{if(1==File.option.smartDash){if(s=/^(---)($|[^-])/.exec(e)){e=e.substring(s[1].length),d.push({type:L.pants,inner:"—",desc:"en_dash",text:s[1]});continue}if(s=/^--/.exec(e)){e=e.substring(s[0].length),d.push({type:L.pants,inner:"–",desc:"em_dash",text:s[0]});continue}}if(1==File.option.smartQuote){var k;if('"'==e[0]){if(null==(k=te(d))||/(^|[\(\s-\/\u2018])$/.exec(k)){e=e.substring(1),d.push({type:L.pants,inner:"“",desc:"open_double_quote",text:'"'});continue}if(s=/^"($|[\)\s\/.,;:?!\u2019])/.exec(e)){e=e.substring(1),d.push({type:L.pants,inner:"”",desc:"close_double_quote",text:'"'});continue}}if("'"==e[0]){if(r.openQuote&&(s=/^'($|[\)\s".,;:?!-])/.exec(e))){e=e.substring(1),d.push({type:L.pants,inner:"’",desc:"close_single",text:"'"}),r.openQuote.inner="‘",r.openQuote.desc="open_single",r.openQuote=null;continue}if(k=te(d)||"",e.length<=1&&/((^|[\s])$)/.exec(k)){p(d,e),e="";continue}e=e.substring(1),d.push({type:L.pants,inner:"’",desc:"close_single",text:"'"}),/(^|[\(\s"-])$/.exec(k)&&(r.openQuote=d.last());continue}}if(s=this.rules.text.exec(e))c+=s[0].length,!(e=e.substring(s[0].length))&&this.rules.linebreak.exec(s[0]||"")?(p(d,s[0].replace(this.rules.linebreak,"")),d.push({type:L.linebreak,text:"  "})):p(d,s[0]||"");else if(e)throw new Error("Infinite loop on byte: "+e.charCodeAt(0))}else c+=s[0].length,e=e.substring(s[0].length),d.push({type:L.highlight,inner:this.output(s[2],t,!0),text:s[2]});else{var S=null,T=0,F="",E=null,_=/\$/,M="$";for(/^\$\$/.exec(s[0])?(S=/{|}|\$\$/g,M="$$"):(S=/{|}|\$/g,M="$"),S.exec(s[0]);E=S.exec(s[0]);){if(_.exec(E[0])&&T<=0&&"\\"!=s[0].substring(E.index-1,E.index)){F=s[0].substring(0,E.index+E[0].length);break}"{"===E[0]?"\\"===E.input[E.index-1]&&"\\"!==!E.input[E.index-2]||T++:"}"===E[0]&&("\\"===E.input[E.index-1]&&"\\"!==!E.input[E.index-2]||T--)}if(0<F.length-2*M.length&&/[^\s$]/.exec(F)){c+=F.length,e=e.substring(F.length),d.push({type:"inline_math",text:le(F),pattern:M});continue}c+=s[0].length,e=e.substring(s[0].length),p(d,s[0]||"")}}else c+=s[0].length,e=e.substring(s[0].length),d.push({type:L.attr,text:s[0]});else{c+=s[0].length,e=e.substring(s[0].length);b=(s[3]||"").replace(/\s+/g," ");d.push({type:s[1]?"refimg":"reflink",ref:le(b),inner:this.output(s[2],t,!0,ie.skipLink),text:le(s[2]),markdown:s[0],onlychild:!e&&!d.length})}else c+=s[0].length,e=e.substring(s[0].length),d.push({type:"image",href:le(s[4]),title:s[5],markdown:s[0],components:[s[1],s[3],s[8]],alt:s[2],onlychild:!e&&!d.length});else c+=s[0].length,e=e.substring(s[0].length),d.push({type:"link",href:le(s[2]),title:s[5],markdown:s[0],text:s[1]||"",inner:s[1]?this.output(s[1],t,!0,ie.skipLink,r):"",meta:le(s[0].substring(s[1].length+2))});else e=e.substring(s[0].length),c+=s[1].length,o=s[1],null===/^\w+:\/\//.exec(a=o)&&/@/.exec(o)&&(a="mailto:"+a),d.push({type:L.url,href:le(a),text:o});else c+=s[0].length,e=e.substring(s[0].length),"",o=s[1],a="@"===s[4]?":"===s[1].charAt(6)?o:"mailto:"+s[1]:o,d.push({type:L.autolink,href:le(a),text:o});var N=h(d);return n||(N=le(N)),N},ie.prototype.mangle=function(e){for(var t,n="",i=e.length,r=0;r<i;r++)t=e.charCodeAt(r),.5<Math.random()&&(t="x"+t.toString(16)),n+="&#"+t+";";return n},de.exec=de;var pe=/^( *)[*+-][ \t\u00A0]+(\[(x|X)\]|\[ \]) +/,he=/^( *)[*+-][ \t\u00A0]+/,fe=/^( *)\d+\.[ \t\u00A0]+/;var ge=/^(\s*#{1,6}\s*)([^\n]+?\s*)(#*\s*)(\n{1,2}|$)/,me=/^(\s*#{1,6}\s+)([^\n]+?\s*)(#*\s*)(\n{1,2}|$)/;function ve(e,t,n,i,r,o){for(var a=[],s="",l={cursorDiff:r};e;){if(!n){if(a=/^ *>[^\n]+/.exec(e)){e=e.substring(a[0].length),s+=t.options.decorate({type:L.blockquote,pattern:a[0].match(/^( *> ?)+/gm)[0],inner:ve(a[0].replace(/^( *> ?)+/gm,""),t,!0,null,r)});continue}if(a=(File.option.strictMarkdown?me:ge).exec(e)){e=e.substring(a[0].length);var c=a[1].length;s+=t.options.decorate({type:L.heading,meta_before:a[0].substring(0,c),meta_after:a[3],inner:t.output(a[2],null,null,{attr:!1},l)}),o&&o.push("h"+a[0].match(/#/g).length);continue}if(a=M.exec(e)){e=e.substring(a[0].length),s+=t.options.decorate({type:L.fences,lang:a[3],pattern:a[1]});continue}if(a=$.exec(e)){e=e.substring(a[0].length),s+=t.options.decorate({type:L.def_footnote,ref:a[1],inner:t.output(a[2]||"",null,null,null,l)});continue}if(a=/^\s*\[([^\]]+)\]:\s+([^\n]*)/.exec(e)){e=e.substring(a[0].length),s+=t.options.decorate({type:L.def_link,ref:a[1],inner:t.output(a[2]||"",null,null,null,l)});continue}}if(a=/(^[^\n]+(\n){0,1})/g.exec(e))e=e.substring(a[0].length),s+=t.options.decorate({type:L.paragraph,inner:t.output(a[0],null,null,{attr:!E.isType(i,L.heading)},l)});else if(a=/^\s*\n\s*/.exec(e))e=e.substring(a[0].length),s+=a[0];else if(e.length)break}return s}var ye,be={};be.options=be.setOptions=function(e){return ue(be.defaults,e),be},be.defaults={gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!1,smartLists:!1,silent:!1,highlight:null,langPrefix:"lang-",smartypants:!1,headerPrefix:""},be.parseInline=function(e,t,n){return ye||(ye=new ie),ye.output(e,null,null,t,{cursorDiff:n})},be.InlineLexer=ie,be.quickParse=function d(u,p,h,e,t){var n,i,r,o,a,s,l,c,f,g,m,v,y=0,b=h,w=[];function x(e,t,n){return new E({type:n||L.paragraph,text:e,parent:t,in:t.get("in")})}function C(e,t,n){y+=e.length,u=u.substring(y),n.cid==p.editor.focusCid&&p.editor.store(),p.editor.undo.completeSnap(!0),t.undo.push(_.buildReplaceUndo(n.getClosetParagraphLevel()))}function k(e,t,n,i){var r,o="";return i=i||d(u,p,e,!1,t),E.isType(n,L.list,L.blockquote)&&E.isType(n.get("parent"),L.paragraph)?(n=(r=n.separateBlockFromLine())[1],t.redo.push(_.buildReplaceUndo(n)),r[0]&&_.addUndoForInsert(t,r[0]),r[2]&&_.addUndoForInsert(t,r[2]),o=(r[0]&&r[0].toHTML()||"")+n.toHTML(i.html)+(r[2]&&r[2].toHTML()||"")):(t.redo.push(_.buildReplaceUndo(n)),o=n.toHTML(i.html)),{html:o,offset:y+i.offset,focus:i.focus,blockChanged:!0,command:t,splits:r}}function S(e,t,n){var i,r,o,a=File.option.indentSize;if(C(e,t,h),h.set("type",L.list),h.set("text",""),h.set("style",n),(r=x("",h,L.list_item)).set("checked",null!=/x|X/g.exec(u)),b=x(u,r,L.paragraph),-1<e.indexOf("[")&&r.set("style",E.ListType.task),n==E.ListType.ul&&(File.option.prettyIndent?h.set("pattern",e.replace(/\[[xX\s]\]\s+/,"").trim()+" ".repeat(a-1)):h.set("pattern",e.replace(/\[[xX\s]\]\s+/,"").trim()+" ")),n==E.ListType.ol){var s=e.match(/\d+/)[0].replace(/^1$/,"");""!=s?h.set("start",s):h.unset("start")}File.option.autoPairExtendSymbol&&(u=u.replace(/^\*/,"")),(o=d(u,p,b,!1)).html=r.toHTML(o.html),i=k(null,t,h,o);var l=(h=i.splits&&i.splits[1]||h).get("before"),c=h.get("after");return i.splits&&!i.splits[0]&&E.isType(l,L.list)&&l.get("style")==h.get("style")&&(i.replaceCid=l.cid,i.toRemove=[h.cid],t.undo.push(_.buildReplaceUndo(l)),_.addUndoForRemove(t,h),l.appendTillEnd(h.getFirstChild()),l.getFirstChild().unset("tail"),l.getFirstChild().getLastChild().unset("tail"),h.remove(),E.isType(c,L.list)&&c.get("style")==c.get("style")&&(i.toRemove.push(c.cid),_.addUndoForRemove(t,c),l.appendTillEnd(c.getFirstChild()),l.getFirstChild().unset("tail"),l.getFirstChild().getLastChild().unset("tail"),c.remove()),t.redo.push(_.buildReplaceUndo(l)),i.html=l.toHTML(),i.splits[2]&&(i.html+=i.splits[2].toHTML())),i}if(t=t||!e&&_.makeEmptyCommand(),File.option.strictMarkdown&&(pe=/^( {0,3})[*+-][ \t\u00A0]+(\[(x|X)\]|\[ \]) +/,he=/^( {0,3})[*+-][ \t\u00A0]+/,fe=/^( {0,3})\d+\.[ \t\u00A0]+/),!e){if(/^ *>[^\n]+/.exec(u))return v=t,C(u.match(/^ *>[ \u00A0]?/)[0],v,h),h.set("type",L.blockquote),h.set("text",""),b=x(u,h),v.redo.push(_.buildReplaceUndo(h)),k(b,v,h);if(n=pe.exec(u))return S(n[0],t,E.ListType.ul);if(n=he.exec(u))return S(n[0],t,E.ListType.ul);if(n=fe.exec(u))return S(n[0],t,E.ListType.ol);if(f=u,g=(c=h).get("parent"),m=g&&g.get("parent"),n=E.isType(c,L.line)&&!c.get("before")&&g&&E.isType(g,L.paragraph)&&!g.get("before")&&m&&E.isType(m,L.list_item)&&m.get("style")!==E.ListType.task&&m.get("parent").get("style")==E.ListType.ul&&/(^ *\[(x|X)\]( |\t)+)|((^ *\[ \]) +)/g.exec(f))return r=n[0],o=t,l=h.get("parent").get("parent"),C(r,o,l),l.set("style",E.ListType.task),l.set("checked",null!=/x|X/g.exec(r)),h.set("text",u),(s=d(u,p,b=h,!0,o)).html=void 0,(a=k(null,o,l,s)).replaceCid=l.cid,a;if(E.isType(h,L.paragraph))return i=t,k(b=x(u,h,L.line),i,h)}var T=[],F={innerHtml:ve(u,p.inline,E.isType(h,L.heading),h,w,T),offset:0,focus:h.cid,blockChanged:!1,command:t,cursorDiff:w,mdlike:T[0]};return F.html=h&&h.toHTML(F.innerHtml,T[0]),F},be.reDefLink=j,be.reDefFootnote=$,be.renderHtmlWithBlockMeta=function e(t,n){if(E.isType(t,L.line)){var i=[],r=ve(t.safeGetStrAttr("text"),n.inline,!1,t,[],i);return t.toHTML(r,i[0])}if(t.get("children").length){for(var o=t.getFirstChild(),a=[];o;)a.push(e(o,n)),o=o.get("after");return t.toHTML(a.join(""))}return t.toHTML()},be.splitTableCell=X,be.recoverEscape=le,n.exports=be}),define("app/editor/Inline",["app/document/StringUtils","app/document/Node","exoskeleton-master/exoskeleton","jquery/jquery","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileHelper","app/editor/EditHelper"],function(e,t,n){"use strict";var S=e("app/document/StringUtils"),i=e("app/document/Node"),u=e("app/editor/EditHelper"),p=e("app/window/FileHelper"),T=(i.Node,i.TYPE);window.failImgCache=[],window.loadedImgCache=[],window.removeLastModifyQuery=function(e){return(e||"").replace(/\?lastModify=(.+)$/,"")};var F=function(e){return S.escapeForPreWrap(e)},E=function(t,e){if(/%[0-9a-f]{2}/i.exec(t))return t.replace(/'/,"%27").replace('"',"%22");var n;try{n=decodeURI(t)}catch(e){n=t}return n=encodeURI(n.replace(/\\/g,"/")).replace(/'/,"%27").replace('"',"%22"),e?n.replace(/#/g,"%23"):n};function r(e){var t=e.target;if(document.body.contains(t)){var n=window.removeLastModifyQuery(t.getAttribute("src"));imagePreLoadAfterMove[n]?setTimeout(function(){delete imagePreLoadAfterMove[n]},200):File.editor.imgEdit.afterUserInsertImage(t),File.editor.imgEdit.afterUserInsertImage(t)}}window.onImageLoadedFunc=function(e){var t=e.target;if(document.body.contains(t)){var n=window.removeLastModifyQuery(t.getAttribute("src"));n.trim()&&(-1==loadedImgCache.indexOf(n)&&n.trim().length&&loadedImgCache.push(n),t.onload=r,$(t).closest(".md-image").addClass("md-img-loaded").removeClass("md-img-error"),t.dataset.localRefresh||(t.getAttribute("aftermove")&&(t.style.background="",t.style.width="",t.style.height="",t.removeAttribute("aftermove")),imagePreLoadAfterMove[n]?setTimeout(function(){delete imagePreLoadAfterMove[n]},200):File.editor.imgEdit.afterUserInsertImage(t)))}},window.onImageErrorFunc=function(e){var t=e.target;if(document.body.contains(t)){var n=window.removeLastModifyQuery(t.getAttribute("src"));n.trim()&&(5e3<failImgCache.length&&(failImgCache=[]),-1==failImgCache.indexOf(n)&&n.trim().length&&failImgCache.push(n),loadedImgCache.remove(n),$(t).closest(".md-image").addClass("md-img-error").removeClass("md-img-loaded"),t.setAttribute("onerror",null))}},window.onLoadedFuncForQuickAction=r;var _='onerror="window.onImageErrorFunc(event)" onload ="window.onImageLoadedFunc(event)"';function o(e,t,n,i,r){var o,a,s,l,c,d=File.editor,u="",p="";if(r){r[1].trim().length;c="<span class='md-image-before-src ty-focusable'>"+S.escape(r[0])+"</span><span class='md-image-src-span ty-focusable'>"+(r[1].trim().length?r[1]:"<span class='md-image-btn ty-focusable-btn md-image-input-src-btn' content='"+$.localize.getString("input image URL","Front")+"'></span><span class='md-image-btn ty-focusable-btn md-image-pick-file-btn' ty-hint='"+$.localize.getString("Select image from local file","Front")+"'></span>")+"</span><span class='md-image-after-src'>"+S.escape(r[2])+"</span>"}else c=S.escape(t);var h=(i||{}).width,f=(i||{}).height,g=(i||{}).zoom;if(e==T.refimg){if(a=n,o=d.nodeMap.link_list.getHrefByRef(a)||"",u=" data-ref='"+F(a)+"' ",!o)return"<span md-inline='refimg' class='md-image md-no-ref' "+u+"><span class='md-meta md-before md-content' contenteditable='true' data-hint='"+$.localize.getString("Please define image reference by \n[{0}]: http://example.png").format(F(a))+"' >"+c+"</span></span>"}else o=n;h&&(p+="width:"+h.replace(/['";\\]/g,"")+";"),f&&(p+="height:"+f.replace(/['";\\]/g,"")+";"),g&&(p+="zoom:"+g.replace(/['";\\]/g,"")+";"),p&&(p=" style =' "+p+"' ");var m=" data-src='"+E(o,!0)+"' ",v=d.imgEdit.getRealSrc(o).replace(/^file:\/\//,""),y=d.imgEdit.getRealSrc(o),b=/^data:/.exec(y),w=/^file:\/\//i.exec(y||""),x=y,C=imagePreLoadAfterMove[y.replace(/\\/g,"/")];if(b?m=" ":x=x.replace(/\\/g,"/"),y=E(x,!0),w&&(y+="?lastModify="+imgLastModified),b||-1<loadedImgCache.indexOf(x)||-1<loadedImgCache.indexOf(E(x,!0)))s="<span md-inline='"+e+"'"+m+" contenteditable='false' class='md-image md-img-loaded' "+u+"><span class='md-meta md-before md-content' contenteditable='true'>"+c+"</span><img referrerPolicy='no-referrer' src='"+y+"' "+p+'onerror="onImageErrorFunc(event)" onload="onLoadedFuncForQuickAction(event)"></span>';else if(-1<failImgCache.indexOf(x))s="<span md-inline='"+e+"'"+m+" contenteditable='false' class='md-image md-img-error' "+u+"><span class='md-meta md-content md-before' contenteditable='true'>"+c+"</span><img referrerPolicy='no-referrer' src='' "+p+"></span>";else{var k="";!p.trim().length&&C&&(p=" style='"+C.size+"background-image:url("+E(C.src,!0)+");' aftermove='true' ",k=" md-img-loaded"),s="<span md-inline='"+e+"'"+m+" contenteditable='false' class='md-image"+k+"' data-src='"+y+"' "+u+"><span class='md-meta md-before md-content' contenteditable='true'>"+c+"</span><img referrerPolicy='no-referrer' src='"+y+"' "+_+" "+p+" /></span>"}return e==T.image&&-1==failImgCache.indexOf(y)&&(window.uploadImageQueue.has(v)?(M(l=$(s),v,!1),s=l[0].outerHTML):window.moveImageQueue.has(v)&&(M(l=$(s),v,!0),s=l[0].outerHTML)),s}function M(t,e,n,i){function r(){var e=n?"md-img-loaded md-on-moving":"md-img-loaded md-on-uploading";t.addClass(e),t.append($("#typora-uploading-image-templ").html().replace(/\s*\n\s*/g,""))}i?setTimeout(function(){(n?moveImageQueue:uploadImageQueue).has(e)&&document.body.contains(t[0])&&r()},1e3):r(),t.attr("data-origin-path",e)}t.applyUploadingStyle=M,t.decorateAsExport=function(e,r){var t,n,i,o,a,s;function l(e,t){if(t&&!S.isFullUrl(e))return"http://"+e;if(r.forPrint&&!S.isFullUrl(e)&&!e.match(/^#/)&&(e=e.replace(/([#?][^.]+)$/,""),File.isNode)){var n=reqnode("fs-plus"),i=reqnode("path").resolve(p.getCurrentFileFolderPath()+"/",e);return n.isFileSync(i)?"file://"+i:n.isFileSync(i+".md")?"file://"+i+".md":n.isFileSync(i+".markdown")?"file://"+i+".markdown":n.isFileSync(i+".pdf")?"file://"+i+".pdf":"http://"+e}return e}switch(e.type){case T.strong:return"<strong>"+e.inner+"</strong>";case T.em:return"<em>"+e.inner+"</em>";case T.plain:return S.escape(e.text);case T.code:return r.forPrint&&File.isNode?(r.defaultFont||(r.defaultFont=window.getComputedStyle(File.editor.writingArea).fontFamily||"initial"),t="<code>"+e.text.trim().split(/([\-;]+)/).map(function(e){return e?/\-|;/.exec(e)?"<span style='font-family:"+r.defaultFont.replace(/'/g,"\\'")+"'>"+e+"</span>":S.escape(e,!1,!0):""}).join("")+"</code>"):t="<code>"+S.escape(e.text.trim(),!1,!0)+"</code>",t;case T.del:return"<del>"+e.inner+"</del>";case T.autolink:case T.url:return"<a href='"+E(l(e.href,!0))+"' target='_blank' class='url'>"+e.text+"</a>";case T.tag:return/^<img/.test(e.text)&&r.forPrint&&(n=/(\ssrc=)(['"])([^"']*)(\2)/.exec(e.text))?(n=File.editor.imgEdit.getRealSrc(n[3]).replace(/^file:\/\/\/?/i,"file:///").replace(/\\/g,"/"),e.text.replace(/(\ssrc=)(['"])([^"']*)(\2)/,"$1$2"+n+"$4")):e.text;case T.br:case T.imgtag:return e.text;case T.link:return"#"==(e.href||"").trim()[0]&&(s=u.findAnchorElem(e.href)).length&&(e.href="#header-"+s.attr("cid")),"<a href='"+E(l(e.href))+"'"+(e.title?" title='"+F(e.title)+"'":"")+">"+e.inner+"</a>";case T.image:return n=r.forPrint?File.editor.imgEdit.getRealSrc(e.href):e.href,t=r.forPrint&&-1<failImgCache.indexOf(n)?"":"<img src='"+(n=r.forPrint?E(n,!0):F(n))+"' alt='"+F(e.alt)+"' referrerPolicy='no-referrer' />",!r.noStyle&&e.onlyChild&&(t="<span class='md-image'>"+t+"</span>"),t;case T.footnote:if(a=r.nodeMap.foot_list.getNodeByRef(e.text)){var c,d=r.footnoteList.indexOf(e.text)+1;return 0==d&&(r.footnoteList.push(e.text),d=r.footnoteList.length),t="<sup><a href='#dfref-footnote-"+(c=r.appendFootnote(a,d))+"' name='ref-footnote-"+c+"'>"+d+"</a></sup>"}return"[^"+S.escape(e.text)+"]";case T.escape:return S.escape(e.text);case T.refimg:return o=(i=r.nodeMap.link_list.getNodeByRef(e.ref||e.text))?F(i.get("title")):void 0,void 0!==(n=i?i.get("href"):void 0)?(n=r.forPrint?E(File.editor.imgEdit.getRealSrc(n),!0):F(n),t="<img alt='"+e.text+"' src='"+n+"'"+(o?" title='"+o+"'":"")+" referrerPolicy='no-referrer'></img>",r.noStyle||(t="<span class='md-image'>"+t+"</span>"),r.forPrint&&-1<failImgCache.indexOf(n)&&(t=""),t):"!["+e.inner+"]["+S.escape(e.ref)+"]";case T.reflink:return n=(i=r.nodeMap.link_list.getNodeByRef(e.ref||e.text))?F(l(i.get("href"))):void 0,o=i?F(i.get("title")):void 0,void 0!==n?"<a href='"+n+"' target='_blank'"+(o?" title='"+o+"'":"")+">"+e.inner+"</a>":"["+e.inner+"]["+S.escape(e.ref)+"]";case T.attr:return"";case T.emoji:return File.option.monocolorEmoji?"<span class='md-emoji'>"+e.inner+"</span>":e.inner;case T.inline_math:return r.noStyle?e.text:u.processExportedSVG(svgCache[e.text.replace(/\u200B/g,"")]||"<span class='math-in-toc'>"+S.escapeForPreWrap(e.text)+"</span>");case T.subscript:return"<sub>"+e.inner+"</sub>";case T.superscript:return"<sup>"+e.inner+"</sup>";case T.underline:return"<u>"+e.inner+"</u>";case T.linebreak:return"<br/>";case T.highlight:return"<mark>"+e.inner+"</mark>";default:return e.inner||""}},t.decorate=function(s,e){switch(s.type){case T.heading:return"<span class='md-blockmeta'>"+s.meta_before+"</span><span class='md-header-span'>"+s.inner+"</span><span class='md-blockmeta'>"+s.meta_after+"</span>";case T.paragraph:return s.inner;case T.blockquote:return"<span class='md-blockmeta'>"+s.pattern+"</span>"+s.inner;case T.fences:return"<span class='md-blockmeta'>"+s.pattern+"</span><span class='md-lang'>"+S.escape(s.lang)+"</span>";case T.def_footnote:return"<span class='md-blockmeta'>[^</span>"+s.ref+"<span class='md-blockmeta'>]: </span><span class='md-def-content'>"+s.inner+"</span>";case T.def_link:return"<span class='md-blockmeta'>[</span>"+s.ref+"<span class='md-blockmeta'>]: </span><span class='md-def-content'>"+s.inner+"</span>";case T.strong:return"<span md-inline='strong' class='"+(s.inner?"":"md-empty")+"'><span class='md-meta md-before'>"+s.pattern+"</span><strong>"+s.inner+"</strong><span class='md-meta md-after'>"+s.pattern+"</span></span>";case T.em:return"<span md-inline='em' class='"+(s.inner?"":"md-empty")+"'><span class='md-meta md-before'>"+s.pattern+"</span><em>"+s.inner+"</em><span class='md-meta md-after'>"+s.pattern+"</span></span>";case T.highlight:return"<span md-inline='highlight'><span class='md-meta md-before'>==</span><mark>"+s.inner+"</mark><span class='md-meta md-after'>==</span></span>";case T.plain:return"<span md-inline='plain'>"+S.escape(s.text.replace(/\r?\n/gi,""))+"</span>";case T.code:var t=s.text.match(/^\s+/)||"";s.text=s.text.replace(/^\s+/,"");var n=s.text.match(/\s+$/)||"";return"<span md-inline='code' spellcheck='false'><span class='md-meta md-before'>"+s.pattern+t+"</span><code>"+S.escapeForPreWrap(s.text.trim(),!1,!0)+"</code><span class='md-meta md-after'>"+n+s.pattern+"</span></span>";case T.del:return"<span md-inline='del'><span class='md-meta md-before'>"+s.pattern+"</span><del>"+s.inner+"</del><span class='md-meta md-after'>"+s.pattern+"</span></span>";case T.autolink:return"<span md-inline='autolink'><span class='md-meta md-before'>&lt;</span><a href='"+E(s.href)+"'>"+S.escape(s.text)+"</a><span class='md-meta md-after'>&gt;</span></span>";case T.url:return"<span md-inline='url' spellcheck='false'><a href='"+E(s.href)+"'>"+S.escape(s.text)+"</a></span>";case T.br:return"<span md-inline='br' class='md-br md-tag' spellcheck='false'><span class='md-br-content'>"+S.escapeForPreWrap(s.text,!1,!0)+"</span></span>";case T.comment:return"<span md-inline='comment' class='md-comment' spellcheck='false'>"+S.escapeForPreWrap(s.text,!1,!0)+"</span>";case T.tag:return"<span md-inline='tag' class='md-tag' spellcheck='false'>"+S.escapeForPreWrap(s.text,!1,!0)+"</span>";case T.atag:return"<span md-inline='atag' class='md-atag'><span class='md-meta md-before'>"+S.escapeForPreWrap(s.left,!1,!0)+"</span><a href='"+E(s.href)+"'>"+s.inner+"</a><span class='md-meta md-after'>"+S.escapeForPreWrap(s.right,!1,!0)+"</span></span>";case T.link:var i=s.meta.replace(/^\((<?(?:\([^)]*\)|[^()])*?>?)([ \t]*)((['"])(.*?)\4)?([ \t]*)\)/,function(e,t,n,i,r,o,a){return"(</span><span class='md-content md-url'>"+S.escape(s.href)+"</span><span class='md-meta'>"+S.escape(n)+"</span><span class='md-content md-link-title'>"+S.escape(i)+"</span><span class='md-meta md-after'>"+S.escape(a)+")</span>"});return"<span md-inline='link' class='"+(s.inner?"":"md-empty-link")+"'><span class='md-meta md-before'>[</span><a spellcheck='false' href='"+E(s.href)+"' >"+s.inner+"</a><span class='md-meta md-before'>]"+i+"</span>";case T.imgtag:return o(s.type,s.text,s.href,s);case T.refimg:return o(s.type,s.markdown,s.ref||s.text);case T.image:return o(s.type,s.markdown,s.href,void 0,s.components);case T.footnote:return"<sup md-inline='footnote' class='md-footnote'><span class='md-meta md-before'>[^</span><span class='md-text'>"+s.inner+"</span><span class='md-meta md-after'>]</span></sup>";case T.escape:return"<span md-inline='escape'><span class='md-meta md-before'>\\</span>"+S.escape(s.text)+"</span>";case T.reflink:return"<span md-inline='reflink'><span class='md-meta md-before'>[</span><a data-ref='"+S.escapeForPreWrap(s.ref||s.text)+"' href='#'>"+s.inner+"</a><span class='md-meta md-after'>]</span><span class='md-meta md-before'>[</span><span class='md-content'>"+s.ref+"</span><span class='md-meta md-after'>]</span></span>";case T.attr:return"<span md-inline='attr' class='md-attr'>"+S.escape(s.text)+"</span>";case T.emoji:return"<span md-inline='emoji' data-content='"+s.text+"' class='md-emoji' >​<span data-emoji='"+s.inner+"' class='md-emoji-span'></span><span class='md-meta'>:"+s.text+":</span>​</span>";case T.inline_math:return s.text=s.text.replace(/\u200B*/g,""),!/^\$+$/.exec(s.text)&&svgCache[s.text]?"<span class='md-inline-math' md-inline='inline_math' pattern='"+s.pattern+"'><span class='md-before md-meta'>"+s.pattern+"</span><span class='inline-math-svg math-jax-postprocess'>"+svgCache[s.text]+"</span><span class='md-math-after-sym'></span><span class='md-after md-meta'>"+s.pattern+"</span></span>":"<span class='md-inline-math' md-inline='inline_math' pattern='"+s.pattern+"'><span class='inline-math-svg math-jax-preprocess'>"+S.escape(s.text)+"</span></span>";case T.subscript:return"<sub md-inline='subscript'><span class='md-meta md-before'>~</span>"+s.inner+"<span class='md-meta md-after'>~</span></sub>";case T.superscript:return"<sup md-inline='superscript'><span class='md-meta md-before'>^</span>"+s.inner+"<span class='md-meta md-after'>^</span></sup>";case T.underline:return"<span md-inline='underline'><span class='md-meta md-before'>&lt;u&gt;</span><u>"+s.inner+"</u><span class='md-meta md-after'>&lt;/u&gt;</span></span>";case T.linebreak:return"<span md-inline='linebreak'>  </span><br/>";case T.html_entity:return"<span md-inline='html_entity' data-content='"+s.text+"' class='md-entity'><span class='md-meta'>"+S.escape(s.text)+"</span></span>";case T.pants:return"<span md-inline='pants' data-text='"+F(s.text)+"' data-content='"+s.inner+"' class='md-pants' data-desc='"+s.desc+"'>"+s.inner+"</span>";default:return console.sendError("unknow type "+s.type),s.text}}}),define("app/editor/Emoji",["jquery/jquery","exoskeleton-master/exoskeleton"],function(e,t,n){"use strict";var i=e("jquery/jquery"),a=e("exoskeleton-master/exoskeleton").Model.extend({initialize:function(e){this.editor=e,this.$container=i("#emoji-auto-suggest"),setTimeout(function(){i.getScript("./app/editor/EmojiSearchMap.js",function(){var e=window.EmojiSearchMap;for(var t in a.data)e[t]||(e[t]=[t])})},1e3)},search:function(t,e){if(!t)return[];var n,i=new RegExp("(^"+t+")|(_"+t+")|(-"+t+")","i"),r=Object.keys(a.data).filter(function(e){return i.exec(e)&&e!==t});if(r.sort(),a.data[t]&&r.unshift(t),n=(window.EmojiSearchMap||{})[t])for(var o=0;o<n.length;o++)-1==r.indexOf(n[o])&&r.push(n[o]);return e.type="emoji",e.token=t,e.match=r,e.found=r.length,e.pageNo=0,e.pageCnt=Math.floor((r.length-1)/5+1),r},showAutoSuggest:function(e,t){if(t.token===e)return!1;var n=this.search(e,t),i="";if(!t.found)return this.$container.hide(),!1;for(var r=0;r<n.length&&r<40;r++)r%5==0&&(i+=(0<r?"</ul>":"")+"<ul data-page='"+r/5+"' style='display:none'>"),i+="<li data-content=':"+n[r]+":' ><span>"+a.data[n[r]]+"</span> <span class='emoji-meta'>:"+n[r]+":</span></li>";return i+="</ul>",this.$container.html(i),this.$container}});a.data={100:"💯",1234:"🔢",grinning:"😀",smiley:"😃",smile:"😄",grin:"😁",laughing:"😆",satisfied:"😆",sweat_smile:"😅",joy:"😂",rofl:"🤣",relaxed:"☺️",blush:"😊",innocent:"😇",slightly_smiling_face:"🙂",upside_down_face:"🙃",wink:"😉",relieved:"😌",heart_eyes:"😍",kissing_heart:"😘",kissing:"😗",kissing_smiling_eyes:"😙",kissing_closed_eyes:"😚",yum:"😋",stuck_out_tongue_winking_eye:"😜",stuck_out_tongue_closed_eyes:"😝",stuck_out_tongue:"😛",money_mouth_face:"🤑",hugs:"🤗",nerd_face:"🤓",sunglasses:"😎",clown_face:"🤡",cowboy_hat_face:"🤠",smirk:"😏",unamused:"😒",disappointed:"😞",pensive:"😔",worried:"😟",confused:"😕",slightly_frowning_face:"🙁",frowning_face:"☹️",persevere:"😣",confounded:"😖",tired_face:"😫",weary:"😩",triumph:"😤",angry:"😠",rage:"😡",pout:"😡",no_mouth:"😶",neutral_face:"😐",expressionless:"😑",hushed:"😯",frowning:"😦",anguished:"😧",open_mouth:"😮",astonished:"😲",dizzy_face:"😵",flushed:"😳",scream:"😱",fearful:"😨",cold_sweat:"😰",cry:"😢",disappointed_relieved:"😥",drooling_face:"🤤",sob:"😭",sweat:"😓",sleepy:"😪",sleeping:"😴",roll_eyes:"🙄",thinking:"🤔",lying_face:"🤥",grimacing:"😬",zipper_mouth_face:"🤐",nauseated_face:"🤢",sneezing_face:"🤧",mask:"😷",face_with_thermometer:"🤒",face_with_head_bandage:"🤕",smiling_imp:"😈",imp:"👿",japanese_ogre:"👹",japanese_goblin:"👺",hankey:"💩",poop:"💩",shit:"💩",ghost:"👻",skull:"💀",skull_and_crossbones:"☠️",alien:"👽",space_invader:"👾",robot:"🤖",jack_o_lantern:"🎃",smiley_cat:"😺",smile_cat:"😸",joy_cat:"😹",heart_eyes_cat:"😻",smirk_cat:"😼",kissing_cat:"😽",scream_cat:"🙀",crying_cat_face:"😿",pouting_cat:"😾",open_hands:"👐",raised_hands:"🙌",clap:"👏",pray:"🙏",handshake:"🤝","+1":"👍",thumbsup:"👍","-1":"👎",thumbsdown:"👎",fist_oncoming:"👊",facepunch:"👊",punch:"👊",fist_raised:"✊",fist:"✊",fist_left:"🤛",fist_right:"🤜",crossed_fingers:"🤞",v:"✌️",metal:"🤘",ok_hand:"👌",point_left:"👈",point_right:"👉",point_up_2:"👆",point_down:"👇",point_up:"☝️",hand:"✋",raised_hand:"✋",raised_back_of_hand:"🤚",raised_hand_with_fingers_splayed:"🖐",vulcan_salute:"🖖",wave:"👋",call_me_hand:"🤙",muscle:"💪",middle_finger:"🖕",fu:"🖕",writing_hand:"✍️",selfie:"🤳",nail_care:"💅",ring:"💍",lipstick:"💄",kiss:"💋",lips:"👄",tongue:"👅",ear:"👂",nose:"👃",footprints:"👣",eye:"👁",eyes:"👀",speaking_head:"🗣",bust_in_silhouette:"👤",busts_in_silhouette:"👥",baby:"👶",boy:"👦",girl:"👧",man:"👨",woman:"👩",blonde_woman:"👱‍♀",blonde_man:"👱",person_with_blond_hair:"👱",older_man:"👴",older_woman:"👵",man_with_gua_pi_mao:"👲",woman_with_turban:"👳‍♀",man_with_turban:"👳",policewoman:"👮‍♀",policeman:"👮",cop:"👮",construction_worker_woman:"👷‍♀",construction_worker_man:"👷",construction_worker:"👷",guardswoman:"💂‍♀",guardsman:"💂",female_detective:"🕵️‍♀️",male_detective:"🕵",detective:"🕵",woman_health_worker:"👩‍⚕",man_health_worker:"👨‍⚕",woman_farmer:"👩‍🌾",man_farmer:"👨‍🌾",woman_cook:"👩‍🍳",man_cook:"👨‍🍳",woman_student:"👩‍🎓",man_student:"👨‍🎓",woman_singer:"👩‍🎤",man_singer:"👨‍🎤",woman_teacher:"👩‍🏫",man_teacher:"👨‍🏫",woman_factory_worker:"👩‍🏭",man_factory_worker:"👨‍🏭",woman_technologist:"👩‍💻",man_technologist:"👨‍💻",woman_office_worker:"👩‍💼",man_office_worker:"👨‍💼",woman_mechanic:"👩‍🔧",man_mechanic:"👨‍🔧",woman_scientist:"👩‍🔬",man_scientist:"👨‍🔬",woman_artist:"👩‍🎨",man_artist:"👨‍🎨",woman_firefighter:"👩‍🚒",man_firefighter:"👨‍🚒",woman_pilot:"👩‍✈",man_pilot:"👨‍✈",woman_astronaut:"👩‍🚀",man_astronaut:"👨‍🚀",woman_judge:"👩‍⚖",man_judge:"👨‍⚖",mrs_claus:"🤶",santa:"🎅",princess:"👸",prince:"🤴",bride_with_veil:"👰",man_in_tuxedo:"🤵",angel:"👼",pregnant_woman:"🤰",bowing_woman:"🙇‍♀",bowing_man:"🙇",bow:"🙇",tipping_hand_woman:"💁",information_desk_person:"💁",sassy_woman:"💁",tipping_hand_man:"💁‍♂",sassy_man:"💁‍♂",no_good_woman:"🙅",no_good:"🙅",ng_woman:"🙅",no_good_man:"🙅‍♂",ng_man:"🙅‍♂",ok_woman:"🙆",ok_man:"🙆‍♂",raising_hand_woman:"🙋",raising_hand:"🙋",raising_hand_man:"🙋‍♂",woman_facepalming:"🤦‍♀",man_facepalming:"🤦‍♂",woman_shrugging:"🤷‍♀",man_shrugging:"🤷‍♂",pouting_woman:"🙎",person_with_pouting_face:"🙎",pouting_man:"🙎‍♂",frowning_woman:"🙍",person_frowning:"🙍",frowning_man:"🙍‍♂",haircut_woman:"💇",haircut:"💇",haircut_man:"💇‍♂",massage_woman:"💆",massage:"💆",massage_man:"💆‍♂",business_suit_levitating:"🕴",dancer:"💃",man_dancing:"🕺",dancing_women:"👯",dancers:"👯",dancing_men:"👯‍♂",walking_woman:"🚶‍♀",walking_man:"🚶",walking:"🚶",running_woman:"🏃‍♀",running_man:"🏃",runner:"🏃",running:"🏃",couple:"👫",two_women_holding_hands:"👭",two_men_holding_hands:"👬",couple_with_heart_woman_man:"💑",couple_with_heart:"💑",couple_with_heart_woman_woman:"👩‍❤️‍👩",couple_with_heart_man_man:"👨‍❤️‍👨",couplekiss_man_woman:"💏",couplekiss_woman_woman:"👩‍❤️‍💋‍👩",couplekiss_man_man:"👨‍❤️‍💋‍👨",family_man_woman_boy:"👪",family:"👪",family_man_woman_girl:"👨‍👩‍👧",family_man_woman_girl_boy:"👨‍👩‍👧‍👦",family_man_woman_boy_boy:"👨‍👩‍👦‍👦",family_man_woman_girl_girl:"👨‍👩‍👧‍👧",family_woman_woman_boy:"👩‍👩‍👦",family_woman_woman_girl:"👩‍👩‍👧",family_woman_woman_girl_boy:"👩‍👩‍👧‍👦",family_woman_woman_boy_boy:"👩‍👩‍👦‍👦",family_woman_woman_girl_girl:"👩‍👩‍👧‍👧",family_man_man_boy:"👨‍👨‍👦",family_man_man_girl:"👨‍👨‍👧",family_man_man_girl_boy:"👨‍👨‍👧‍👦",family_man_man_boy_boy:"👨‍👨‍👦‍👦",family_man_man_girl_girl:"👨‍👨‍👧‍👧",family_woman_boy:"👩‍👦",family_woman_girl:"👩‍👧",family_woman_girl_boy:"👩‍👧‍👦",family_woman_boy_boy:"👩‍👦‍👦",family_woman_girl_girl:"👩‍👧‍👧",family_man_boy:"👨‍👦",family_man_girl:"👨‍👧",family_man_girl_boy:"👨‍👧‍👦",family_man_boy_boy:"👨‍👦‍👦",family_man_girl_girl:"👨‍👧‍👧",womans_clothes:"👚",shirt:"👕",tshirt:"👕",jeans:"👖",necktie:"👔",dress:"👗",bikini:"👙",kimono:"👘",high_heel:"👠",sandal:"👡",boot:"👢",mans_shoe:"👞",shoe:"👞",athletic_shoe:"👟",womans_hat:"👒",tophat:"🎩",mortar_board:"🎓",crown:"👑",rescue_worker_helmet:"⛑",school_satchel:"🎒",pouch:"👝",purse:"👛",handbag:"👜",briefcase:"💼",eyeglasses:"👓",dark_sunglasses:"🕶",closed_umbrella:"🌂",open_umbrella:"☂️",dog:"🐶",cat:"🐱",mouse:"🐭",hamster:"🐹",rabbit:"🐰",fox_face:"🦊",bear:"🐻",panda_face:"🐼",koala:"🐨",tiger:"🐯",lion:"🦁",cow:"🐮",pig:"🐷",pig_nose:"🐽",frog:"🐸",monkey_face:"🐵",see_no_evil:"🙈",hear_no_evil:"🙉",speak_no_evil:"🙊",monkey:"🐒",chicken:"🐔",penguin:"🐧",bird:"🐦",baby_chick:"🐤",hatching_chick:"🐣",hatched_chick:"🐥",duck:"🦆",eagle:"🦅",owl:"🦉",bat:"🦇",wolf:"🐺",boar:"🐗",horse:"🐴",unicorn:"🦄",bee:"🐝",honeybee:"🐝",bug:"🐛",butterfly:"🦋",snail:"🐌",shell:"🐚",beetle:"🐞",ant:"🐜",spider:"🕷",spider_web:"🕸",turtle:"🐢",snake:"🐍",lizard:"🦎",scorpion:"🦂",crab:"🦀",squid:"🦑",octopus:"🐙",shrimp:"🦐",tropical_fish:"🐠",fish:"🐟",blowfish:"🐡",dolphin:"🐬",flipper:"🐬",shark:"🦈",whale:"🐳",whale2:"🐋",crocodile:"🐊",leopard:"🐆",tiger2:"🐅",water_buffalo:"🐃",ox:"🐂",cow2:"🐄",deer:"🦌",dromedary_camel:"🐪",camel:"🐫",elephant:"🐘",rhinoceros:"🦏",gorilla:"🦍",racehorse:"🐎",pig2:"🐖",goat:"🐐",ram:"🐏",sheep:"🐑",dog2:"🐕",poodle:"🐩",cat2:"🐈",rooster:"🐓",turkey:"🦃",dove:"🕊",rabbit2:"🐇",mouse2:"🐁",rat:"🐀",chipmunk:"🐿",feet:"🐾",paw_prints:"🐾",dragon:"🐉",dragon_face:"🐲",cactus:"🌵",christmas_tree:"🎄",evergreen_tree:"🌲",deciduous_tree:"🌳",palm_tree:"🌴",seedling:"🌱",herb:"🌿",shamrock:"☘️",four_leaf_clover:"🍀",bamboo:"🎍",tanabata_tree:"🎋",leaves:"🍃",fallen_leaf:"🍂",maple_leaf:"🍁",mushroom:"🍄",ear_of_rice:"🌾",bouquet:"💐",tulip:"🌷",rose:"🌹",wilted_flower:"🥀",sunflower:"🌻",blossom:"🌼",cherry_blossom:"🌸",hibiscus:"🌺",earth_americas:"🌎",earth_africa:"🌍",earth_asia:"🌏",full_moon:"🌕",waning_gibbous_moon:"🌖",last_quarter_moon:"🌗",waning_crescent_moon:"🌘",new_moon:"🌑",waxing_crescent_moon:"🌒",first_quarter_moon:"🌓",moon:"🌔",waxing_gibbous_moon:"🌔",new_moon_with_face:"🌚",full_moon_with_face:"🌝",sun_with_face:"🌞",first_quarter_moon_with_face:"🌛",last_quarter_moon_with_face:"🌜",crescent_moon:"🌙",dizzy:"💫",star:"⭐️",star2:"🌟",sparkles:"✨",zap:"⚡️",fire:"🔥",boom:"💥",collision:"💥",comet:"☄",sunny:"☀️",sun_behind_small_cloud:"🌤",partly_sunny:"⛅️",sun_behind_large_cloud:"🌥",sun_behind_rain_cloud:"🌦",rainbow:"🌈",cloud:"☁️",cloud_with_rain:"🌧",cloud_with_lightning_and_rain:"⛈",cloud_with_lightning:"🌩",cloud_with_snow:"🌨",snowman_with_snow:"☃️",snowman:"⛄️",snowflake:"❄️",wind_face:"🌬",dash:"💨",tornado:"🌪",fog:"🌫",ocean:"🌊",droplet:"💧",sweat_drops:"💦",umbrella:"☔️",green_apple:"🍏",apple:"🍎",pear:"🍐",tangerine:"🍊",orange:"🍊",mandarin:"🍊",lemon:"🍋",banana:"🍌",watermelon:"🍉",grapes:"🍇",strawberry:"🍓",melon:"🍈",cherries:"🍒",peach:"🍑",pineapple:"🍍",kiwi_fruit:"🥝",avocado:"🥑",tomato:"🍅",eggplant:"🍆",cucumber:"🥒",carrot:"🥕",corn:"🌽",hot_pepper:"🌶",potato:"🥔",sweet_potato:"🍠",chestnut:"🌰",peanuts:"🥜",honey_pot:"🍯",croissant:"🥐",bread:"🍞",baguette_bread:"🥖",cheese:"🧀",egg:"🥚",fried_egg:"🍳",bacon:"🥓",pancakes:"🥞",fried_shrimp:"🍤",poultry_leg:"🍗",meat_on_bone:"🍖",pizza:"🍕",hotdog:"🌭",hamburger:"🍔",fries:"🍟",stuffed_flatbread:"🥙",taco:"🌮",burrito:"🌯",green_salad:"🥗",shallow_pan_of_food:"🥘",spaghetti:"🍝",ramen:"🍜",stew:"🍲",fish_cake:"🍥",sushi:"🍣",bento:"🍱",curry:"🍛",rice:"🍚",rice_ball:"🍙",rice_cracker:"🍘",oden:"🍢",dango:"🍡",shaved_ice:"🍧",ice_cream:"🍨",icecream:"🍦",cake:"🍰",birthday:"🎂",custard:"🍮",lollipop:"🍭",candy:"🍬",chocolate_bar:"🍫",popcorn:"🍿",doughnut:"🍩",cookie:"🍪",milk_glass:"🥛",baby_bottle:"🍼",coffee:"☕️",tea:"🍵",sake:"🍶",beer:"🍺",beers:"🍻",clinking_glasses:"🥂",wine_glass:"🍷",tumbler_glass:"🥃",cocktail:"🍸",tropical_drink:"🍹",champagne:"🍾",spoon:"🥄",fork_and_knife:"🍴",plate_with_cutlery:"🍽",soccer:"⚽️",basketball:"🏀",football:"🏈",baseball:"⚾️",tennis:"🎾",volleyball:"🏐",rugby_football:"🏉","8ball":"🎱",ping_pong:"🏓",badminton:"🏸",goal_net:"🥅",ice_hockey:"🏒",field_hockey:"🏑",cricket:"🏏",golf:"⛳️",bow_and_arrow:"🏹",fishing_pole_and_fish:"🎣",boxing_glove:"🥊",martial_arts_uniform:"🥋",ice_skate:"⛸",ski:"🎿",skier:"⛷",snowboarder:"🏂",weight_lifting_woman:"🏋️‍♀️",weight_lifting_man:"🏋",person_fencing:"🤺",women_wrestling:"🤼‍♀",men_wrestling:"🤼‍♂",woman_cartwheeling:"🤸‍♀",man_cartwheeling:"🤸‍♂",basketball_woman:"⛹️‍♀️",basketball_man:"⛹",woman_playing_handball:"🤾‍♀",man_playing_handball:"🤾‍♂",golfing_woman:"🏌️‍♀️",golfing_man:"🏌",surfing_woman:"🏄‍♀",surfing_man:"🏄",surfer:"🏄",swimming_woman:"🏊‍♀",swimming_man:"🏊",swimmer:"🏊",woman_playing_water_polo:"🤽‍♀",man_playing_water_polo:"🤽‍♂",rowing_woman:"🚣‍♀",rowing_man:"🚣",rowboat:"🚣",horse_racing:"🏇",biking_woman:"🚴‍♀",biking_man:"🚴",bicyclist:"🚴",mountain_biking_woman:"🚵‍♀",mountain_biking_man:"🚵",mountain_bicyclist:"🚵",running_shirt_with_sash:"🎽",medal_sports:"🏅",medal_military:"🎖","1st_place_medal":"🥇","2nd_place_medal":"🥈","3rd_place_medal":"🥉",trophy:"🏆",rosette:"🏵",reminder_ribbon:"🎗",ticket:"🎫",tickets:"🎟",circus_tent:"🎪",woman_juggling:"🤹‍♀",man_juggling:"🤹‍♂",performing_arts:"🎭",art:"🎨",clapper:"🎬",microphone:"🎤",headphones:"🎧",musical_score:"🎼",musical_keyboard:"🎹",drum:"🥁",saxophone:"🎷",trumpet:"🎺",guitar:"🎸",violin:"🎻",game_die:"🎲",dart:"🎯",bowling:"🎳",video_game:"🎮",slot_machine:"🎰",car:"🚗",red_car:"🚗",taxi:"🚕",blue_car:"🚙",bus:"🚌",trolleybus:"🚎",racing_car:"🏎",police_car:"🚓",ambulance:"🚑",fire_engine:"🚒",minibus:"🚐",truck:"🚚",articulated_lorry:"🚛",tractor:"🚜",kick_scooter:"🛴",bike:"🚲",motor_scooter:"🛵",motorcycle:"🏍",rotating_light:"🚨",oncoming_police_car:"🚔",oncoming_bus:"🚍",oncoming_automobile:"🚘",oncoming_taxi:"🚖",aerial_tramway:"🚡",mountain_cableway:"🚠",suspension_railway:"🚟",railway_car:"🚃",train:"🚋",mountain_railway:"🚞",monorail:"🚝",bullettrain_side:"🚄",bullettrain_front:"🚅",light_rail:"🚈",steam_locomotive:"🚂",train2:"🚆",metro:"🚇",tram:"🚊",station:"🚉",helicopter:"🚁",small_airplane:"🛩",airplane:"✈️",flight_departure:"🛫",flight_arrival:"🛬",rocket:"🚀",artificial_satellite:"🛰",seat:"💺",canoe:"🛶",boat:"⛵️",sailboat:"⛵️",motor_boat:"🛥",speedboat:"🚤",passenger_ship:"🛳",ferry:"⛴",ship:"🚢",anchor:"⚓️",construction:"🚧",fuelpump:"⛽️",busstop:"🚏",vertical_traffic_light:"🚦",traffic_light:"🚥",world_map:"🗺",moyai:"🗿",statue_of_liberty:"🗽",fountain:"⛲️",tokyo_tower:"🗼",european_castle:"🏰",japanese_castle:"🏯",stadium:"🏟",ferris_wheel:"🎡",roller_coaster:"🎢",carousel_horse:"🎠",parasol_on_ground:"⛱",beach_umbrella:"🏖",desert_island:"🏝",mountain:"⛰",mountain_snow:"🏔",mount_fuji:"🗻",volcano:"🌋",desert:"🏜",camping:"🏕",tent:"⛺️",railway_track:"🛤",motorway:"🛣",building_construction:"🏗",factory:"🏭",house:"🏠",house_with_garden:"🏡",houses:"🏘",derelict_house:"🏚",office:"🏢",department_store:"🏬",post_office:"🏣",european_post_office:"🏤",hospital:"🏥",bank:"🏦",hotel:"🏨",convenience_store:"🏪",school:"🏫",love_hotel:"🏩",wedding:"💒",classical_building:"🏛",church:"⛪️",mosque:"🕌",synagogue:"🕍",kaaba:"🕋",shinto_shrine:"⛩",japan:"🗾",rice_scene:"🎑",national_park:"🏞",sunrise:"🌅",sunrise_over_mountains:"🌄",stars:"🌠",sparkler:"🎇",fireworks:"🎆",city_sunrise:"🌇",city_sunset:"🌆",cityscape:"🏙",night_with_stars:"🌃",milky_way:"🌌",bridge_at_night:"🌉",foggy:"🌁",watch:"⌚️",iphone:"📱",calling:"📲",computer:"💻",keyboard:"⌨️",desktop_computer:"🖥",printer:"🖨",computer_mouse:"🖱",trackball:"🖲",joystick:"🕹",clamp:"🗜",minidisc:"💽",floppy_disk:"💾",cd:"💿",dvd:"📀",vhs:"📼",camera:"📷",camera_flash:"📸",video_camera:"📹",movie_camera:"🎥",film_projector:"📽",film_strip:"🎞",telephone_receiver:"📞",phone:"☎️",telephone:"☎️",pager:"📟",fax:"📠",tv:"📺",radio:"📻",studio_microphone:"🎙",level_slider:"🎚",control_knobs:"🎛",stopwatch:"⏱",timer_clock:"⏲",alarm_clock:"⏰",mantelpiece_clock:"🕰",hourglass:"⌛️",hourglass_flowing_sand:"⏳",satellite:"📡",battery:"🔋",electric_plug:"🔌",bulb:"💡",flashlight:"🔦",candle:"🕯",wastebasket:"🗑",oil_drum:"🛢",money_with_wings:"💸",dollar:"💵",yen:"💴",euro:"💶",pound:"💷",moneybag:"💰",credit_card:"💳",gem:"💎",balance_scale:"⚖️",wrench:"🔧",hammer:"🔨",hammer_and_pick:"⚒",hammer_and_wrench:"🛠",pick:"⛏",nut_and_bolt:"🔩",gear:"⚙️",chains:"⛓",gun:"🔫",bomb:"💣",hocho:"🔪",knife:"🔪",dagger:"🗡",crossed_swords:"⚔️",shield:"🛡",smoking:"🚬",coffin:"⚰️",funeral_urn:"⚱️",amphora:"🏺",crystal_ball:"🔮",prayer_beads:"📿",barber:"💈",alembic:"⚗️",telescope:"🔭",microscope:"🔬",hole:"🕳",pill:"💊",syringe:"💉",thermometer:"🌡",toilet:"🚽",potable_water:"🚰",shower:"🚿",bathtub:"🛁",bath:"🛀",bellhop_bell:"🛎",key:"🔑",old_key:"🗝",door:"🚪",couch_and_lamp:"🛋",bed:"🛏",sleeping_bed:"🛌",framed_picture:"🖼",shopping:"🛍",shopping_cart:"🛒",gift:"🎁",balloon:"🎈",flags:"🎏",ribbon:"🎀",confetti_ball:"🎊",tada:"🎉",dolls:"🎎",izakaya_lantern:"🏮",lantern:"🏮",wind_chime:"🎐",email:"✉️",envelope:"✉️",envelope_with_arrow:"📩",incoming_envelope:"📨","e-mail":"📧",love_letter:"💌",inbox_tray:"📥",outbox_tray:"📤",package:"📦",label:"🏷",mailbox_closed:"📪",mailbox:"📫",mailbox_with_mail:"📬",mailbox_with_no_mail:"📭",postbox:"📮",postal_horn:"📯",scroll:"📜",page_with_curl:"📃",page_facing_up:"📄",bookmark_tabs:"📑",bar_chart:"📊",chart_with_upwards_trend:"📈",chart_with_downwards_trend:"📉",spiral_notepad:"🗒",spiral_calendar:"🗓",calendar:"📆",date:"📅",card_index:"📇",card_file_box:"🗃",ballot_box:"🗳",file_cabinet:"🗄",clipboard:"📋",file_folder:"📁",open_file_folder:"📂",card_index_dividers:"🗂",newspaper_roll:"🗞",newspaper:"📰",notebook:"📓",notebook_with_decorative_cover:"📔",ledger:"📒",closed_book:"📕",green_book:"📗",blue_book:"📘",orange_book:"📙",books:"📚",book:"📖",open_book:"📖",bookmark:"🔖",link:"🔗",paperclip:"📎",paperclips:"🖇",triangular_ruler:"📐",straight_ruler:"📏",pushpin:"📌",round_pushpin:"📍",scissors:"✂️",pen:"🖊",fountain_pen:"🖋",black_nib:"✒️",paintbrush:"🖌",crayon:"🖍",memo:"📝",pencil:"📝",pencil2:"✏️",mag:"🔍",mag_right:"🔎",lock_with_ink_pen:"🔏",closed_lock_with_key:"🔐",lock:"🔒",unlock:"🔓",heart:"❤️",yellow_heart:"💛",green_heart:"💚",blue_heart:"💙",purple_heart:"💜",black_heart:"🖤",broken_heart:"💔",heavy_heart_exclamation:"❣️",two_hearts:"💕",revolving_hearts:"💞",heartbeat:"💓",heartpulse:"💗",sparkling_heart:"💖",cupid:"💘",gift_heart:"💝",heart_decoration:"💟",peace_symbol:"☮️",latin_cross:"✝️",star_and_crescent:"☪️",om:"🕉",wheel_of_dharma:"☸️",star_of_david:"✡️",six_pointed_star:"🔯",menorah:"🕎",yin_yang:"☯️",orthodox_cross:"☦️",place_of_worship:"🛐",ophiuchus:"⛎",aries:"♈️",taurus:"♉️",gemini:"♊️",cancer:"♋️",leo:"♌️",virgo:"♍️",libra:"♎️",scorpius:"♏️",sagittarius:"♐️",capricorn:"♑️",aquarius:"♒️",pisces:"♓️",id:"🆔",atom_symbol:"⚛️",accept:"🉑",radioactive:"☢️",biohazard:"☣️",mobile_phone_off:"📴",vibration_mode:"📳",eight_pointed_black_star:"✴️",vs:"🆚",white_flower:"💮",ideograph_advantage:"🉐",secret:"㊙️",congratulations:"㊗️",u6e80:"🈵",a:"🅰️",b:"🅱️",ab:"🆎",cl:"🆑",o2:"🅾️",sos:"🆘",x:"❌",o:"⭕️",stop_sign:"🛑",no_entry:"⛔️",name_badge:"📛",no_entry_sign:"🚫",anger:"💢",hotsprings:"♨️",no_pedestrians:"🚷",do_not_litter:"🚯",no_bicycles:"🚳","non-potable_water":"🚱",underage:"🔞",no_mobile_phones:"📵",no_smoking:"🚭",exclamation:"❗️",heavy_exclamation_mark:"❗️",grey_exclamation:"❕",question:"❓",grey_question:"❔",bangbang:"‼️",interrobang:"⁉️",low_brightness:"🔅",high_brightness:"🔆",part_alternation_mark:"〽️",warning:"⚠️",children_crossing:"🚸",trident:"🔱",fleur_de_lis:"⚜️",beginner:"🔰",recycle:"♻️",white_check_mark:"✅",chart:"💹",sparkle:"❇️",eight_spoked_asterisk:"✳️",negative_squared_cross_mark:"❎",globe_with_meridians:"🌐",diamond_shape_with_a_dot_inside:"💠",m:"Ⓜ️",cyclone:"🌀",zzz:"💤",atm:"🏧",wc:"🚾",wheelchair:"♿️",parking:"🅿️",sa:"🈂️",passport_control:"🛂",customs:"🛃",baggage_claim:"🛄",left_luggage:"🛅",mens:"🚹",womens:"🚺",baby_symbol:"🚼",restroom:"🚻",put_litter_in_its_place:"🚮",cinema:"🎦",signal_strength:"📶",koko:"🈁",symbols:"🔣",information_source:"ℹ️",abc:"🔤",abcd:"🔡",capital_abcd:"🔠",ng:"🆖",ok:"🆗",up:"🆙",cool:"🆒",new:"🆕",free:"🆓",zero:"0️⃣",one:"1️⃣",two:"2️⃣",three:"3️⃣",four:"4️⃣",five:"5️⃣",six:"6️⃣",seven:"7️⃣",eight:"8️⃣",nine:"9️⃣",keycap_ten:"🔟",hash:"#️⃣",asterisk:"*️⃣",arrow_forward:"▶️",pause_button:"⏸",play_or_pause_button:"⏯",stop_button:"⏹",record_button:"⏺",next_track_button:"⏭",previous_track_button:"⏮",fast_forward:"⏩",rewind:"⏪",arrow_double_up:"⏫",arrow_double_down:"⏬",arrow_backward:"◀️",arrow_up_small:"🔼",arrow_down_small:"🔽",arrow_right:"➡️",arrow_left:"⬅️",arrow_up:"⬆️",arrow_down:"⬇️",arrow_upper_right:"↗️",arrow_lower_right:"↘️",arrow_lower_left:"↙️",arrow_upper_left:"↖️",arrow_up_down:"↕️",left_right_arrow:"↔️",arrow_right_hook:"↪️",leftwards_arrow_with_hook:"↩️",arrow_heading_up:"⤴️",arrow_heading_down:"⤵️",twisted_rightwards_arrows:"🔀",repeat:"🔁",repeat_one:"🔂",arrows_counterclockwise:"🔄",arrows_clockwise:"🔃",musical_note:"🎵",notes:"🎶",heavy_plus_sign:"➕",heavy_minus_sign:"➖",heavy_division_sign:"➗",heavy_multiplication_x:"✖️",heavy_dollar_sign:"💲",currency_exchange:"💱",tm:"™️",copyright:"©️",registered:"®️",wavy_dash:"〰️",curly_loop:"➰",loop:"➿",end:"🔚",back:"🔙",on:"🔛",top:"🔝",soon:"🔜",heavy_check_mark:"✔️",ballot_box_with_check:"☑️",radio_button:"🔘",white_circle:"⚪️",black_circle:"⚫️",red_circle:"🔴",large_blue_circle:"🔵",small_red_triangle:"🔺",small_red_triangle_down:"🔻",small_orange_diamond:"🔸",small_blue_diamond:"🔹",large_orange_diamond:"🔶",large_blue_diamond:"🔷",white_square_button:"🔳",black_square_button:"🔲",black_small_square:"▪️",white_small_square:"▫️",black_medium_small_square:"◾️",white_medium_small_square:"◽️",black_medium_square:"◼️",white_medium_square:"◻️",black_large_square:"⬛️",white_large_square:"⬜️",speaker:"🔈",mute:"🔇",sound:"🔉",loud_sound:"🔊",bell:"🔔",no_bell:"🔕",mega:"📣",loudspeaker:"📢",eye_speech_bubble:"👁‍🗨",speech_balloon:"💬",thought_balloon:"💭",right_anger_bubble:"🗯",spades:"♠️",clubs:"♣️",hearts:"♥️",diamonds:"♦️",black_joker:"🃏",flower_playing_cards:"🎴",mahjong:"🀄️",clock1:"🕐",clock2:"🕑",clock3:"🕒",clock4:"🕓",clock5:"🕔",clock6:"🕕",clock7:"🕖",clock8:"🕗",clock9:"🕘",clock10:"🕙",clock11:"🕚",clock12:"🕛",clock130:"🕜",clock230:"🕝",clock330:"🕞",clock430:"🕟",clock530:"🕠",clock630:"🕡",clock730:"🕢",clock830:"🕣",clock930:"🕤",clock1030:"🕥",clock1130:"🕦",clock1230:"🕧",white_flag:"🏳️",black_flag:"🏴",checkered_flag:"🏁",triangular_flag_on_post:"🚩",rainbow_flag:"🏳️‍🌈",afghanistan:"🇦🇫",aland_islands:"🇦🇽",albania:"🇦🇱",algeria:"🇩🇿",american_samoa:"🇦🇸",andorra:"🇦🇩",angola:"🇦🇴",anguilla:"🇦🇮",antarctica:"🇦🇶",antigua_barbuda:"🇦🇬",argentina:"🇦🇷",armenia:"🇦🇲",aruba:"🇦🇼",australia:"🇦🇺",austria:"🇦🇹",azerbaijan:"🇦🇿",bahamas:"🇧🇸",bahrain:"🇧🇭",bangladesh:"🇧🇩",barbados:"🇧🇧",belarus:"🇧🇾",belgium:"🇧🇪",belize:"🇧🇿",benin:"🇧🇯",bermuda:"🇧🇲",bhutan:"🇧🇹",bolivia:"🇧🇴",caribbean_netherlands:"🇧🇶",bosnia_herzegovina:"🇧🇦",botswana:"🇧🇼",brazil:"🇧🇷",british_indian_ocean_territory:"🇮🇴",british_virgin_islands:"🇻🇬",brunei:"🇧🇳",bulgaria:"🇧🇬",burkina_faso:"🇧🇫",burundi:"🇧🇮",cape_verde:"🇨🇻",cambodia:"🇰🇭",cameroon:"🇨🇲",canada:"🇨🇦",canary_islands:"🇮🇨",cayman_islands:"🇰🇾",central_african_republic:"🇨🇫",chad:"🇹🇩",chile:"🇨🇱",cn:"🇨🇳",christmas_island:"🇨🇽",cocos_islands:"🇨🇨",colombia:"🇨🇴",comoros:"🇰🇲",congo_brazzaville:"🇨🇬",congo_kinshasa:"🇨🇩",cook_islands:"🇨🇰",costa_rica:"🇨🇷",cote_divoire:"🇨🇮",croatia:"🇭🇷",cuba:"🇨🇺",curacao:"🇨🇼",cyprus:"🇨🇾",czech_republic:"🇨🇿",denmark:"🇩🇰",djibouti:"🇩🇯",dominica:"🇩🇲",dominican_republic:"🇩🇴",ecuador:"🇪🇨",egypt:"🇪🇬",el_salvador:"🇸🇻",equatorial_guinea:"🇬🇶",eritrea:"🇪🇷",estonia:"🇪🇪",ethiopia:"🇪🇹",eu:"🇪🇺",european_union:"🇪🇺",falkland_islands:"🇫🇰",faroe_islands:"🇫🇴",fiji:"🇫🇯",finland:"🇫🇮",fr:"🇫🇷",french_guiana:"🇬🇫",french_polynesia:"🇵🇫",french_southern_territories:"🇹🇫",gabon:"🇬🇦",gambia:"🇬🇲",georgia:"🇬🇪",de:"🇩🇪",ghana:"🇬🇭",gibraltar:"🇬🇮",greece:"🇬🇷",greenland:"🇬🇱",grenada:"🇬🇩",guadeloupe:"🇬🇵",guam:"🇬🇺",guatemala:"🇬🇹",guernsey:"🇬🇬",guinea:"🇬🇳",guinea_bissau:"🇬🇼",guyana:"🇬🇾",haiti:"🇭🇹",honduras:"🇭🇳",hong_kong:"🇭🇰",hungary:"🇭🇺",iceland:"🇮🇸",india:"🇮🇳",indonesia:"🇮🇩",iran:"🇮🇷",iraq:"🇮🇶",ireland:"🇮🇪",isle_of_man:"🇮🇲",israel:"🇮🇱",it:"🇮🇹",jamaica:"🇯🇲",jp:"🇯🇵",crossed_flags:"🎌",jersey:"🇯🇪",jordan:"🇯🇴",kazakhstan:"🇰🇿",kenya:"🇰🇪",kiribati:"🇰🇮",kosovo:"🇽🇰",kuwait:"🇰🇼",kyrgyzstan:"🇰🇬",laos:"🇱🇦",latvia:"🇱🇻",lebanon:"🇱🇧",lesotho:"🇱🇸",liberia:"🇱🇷",libya:"🇱🇾",liechtenstein:"🇱🇮",lithuania:"🇱🇹",luxembourg:"🇱🇺",macau:"🇲🇴",macedonia:"🇲🇰",madagascar:"🇲🇬",malawi:"🇲🇼",malaysia:"🇲🇾",maldives:"🇲🇻",mali:"🇲🇱",malta:"🇲🇹",marshall_islands:"🇲🇭",martinique:"🇲🇶",mauritania:"🇲🇷",mauritius:"🇲🇺",mayotte:"🇾🇹",mexico:"🇲🇽",micronesia:"🇫🇲",moldova:"🇲🇩",monaco:"🇲🇨",mongolia:"🇲🇳",montenegro:"🇲🇪",montserrat:"🇲🇸",morocco:"🇲🇦",mozambique:"🇲🇿",myanmar:"🇲🇲",namibia:"🇳🇦",nauru:"🇳🇷",nepal:"🇳🇵",netherlands:"🇳🇱",new_caledonia:"🇳🇨",new_zealand:"🇳🇿",nicaragua:"🇳🇮",niger:"🇳🇪",nigeria:"🇳🇬",niue:"🇳🇺",norfolk_island:"🇳🇫",northern_mariana_islands:"🇲🇵",north_korea:"🇰🇵",norway:"🇳🇴",oman:"🇴🇲",pakistan:"🇵🇰",palau:"🇵🇼",palestinian_territories:"🇵🇸",panama:"🇵🇦",papua_new_guinea:"🇵🇬",paraguay:"🇵🇾",peru:"🇵🇪",philippines:"🇵🇭",pitcairn_islands:"🇵🇳",poland:"🇵🇱",portugal:"🇵🇹",puerto_rico:"🇵🇷",qatar:"🇶🇦",reunion:"🇷🇪",romania:"🇷🇴",ru:"🇷🇺",rwanda:"🇷🇼",st_barthelemy:"🇧🇱",st_helena:"🇸🇭",st_kitts_nevis:"🇰🇳",st_lucia:"🇱🇨",st_pierre_miquelon:"🇵🇲",st_vincent_grenadines:"🇻🇨",samoa:"🇼🇸",san_marino:"🇸🇲",sao_tome_principe:"🇸🇹",saudi_arabia:"🇸🇦",senegal:"🇸🇳",serbia:"🇷🇸",seychelles:"🇸🇨",sierra_leone:"🇸🇱",singapore:"🇸🇬",sint_maarten:"🇸🇽",slovakia:"🇸🇰",slovenia:"🇸🇮",solomon_islands:"🇸🇧",somalia:"🇸🇴",south_africa:"🇿🇦",south_georgia_south_sandwich_islands:"🇬🇸",kr:"🇰🇷",south_sudan:"🇸🇸",es:"🇪🇸",sri_lanka:"🇱🇰",sudan:"🇸🇩",suriname:"🇸🇷",swaziland:"🇸🇿",sweden:"🇸🇪",switzerland:"🇨🇭",syria:"🇸🇾",taiwan:"🇹🇼",tajikistan:"🇹🇯",tanzania:"🇹🇿",thailand:"🇹🇭",timor_leste:"🇹🇱",togo:"🇹🇬",tokelau:"🇹🇰",tonga:"🇹🇴",trinidad_tobago:"🇹🇹",tunisia:"🇹🇳",tr:"🇹🇷",turkmenistan:"🇹🇲",turks_caicos_islands:"🇹🇨",tuvalu:"🇹🇻",uganda:"🇺🇬",ukraine:"🇺🇦",united_arab_emirates:"🇦🇪",gb:"🇬🇧",uk:"🇬🇧",us:"🇺🇸",us_virgin_islands:"🇻🇮",uruguay:"🇺🇾",uzbekistan:"🇺🇿",vanuatu:"🇻🇺",vatican_city:"🇻🇦",venezuela:"🇻🇪",vietnam:"🇻🇳",wallis_futuna:"🇼🇫",western_sahara:"🇪🇭",yemen:"🇾🇪",zambia:"🇿🇲",zimbabwe:"🇿🇼"},a.data.happy=a.data.smile,n.exports=a}),define("app/document/Node2Mark",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton");var i=e("app/document/Node"),q=i.Node,r=i.NodeMap,z=i.TYPE,V=e("app/document/StringUtils"),K=/\uE027/gi,o=["-","+","*"];q.UL_DEFAULT_START=o,q.prototype.toMark=function(){var e=J.call(this);return e instanceof Array?e.join(File.useCRLF?"\r\n":"\n").replace(K,""):e};var Y=function(e,t){return"right"==e?"-".repeat(t-1)+":":"center"==e?":"+"-".repeat(t-2)+":":"left"==e?":"+"-".repeat(t-1):"-".repeat(t)},J=function(){var e,n,i,r=[];function t(e){if(e.get("children").length)return Z(e.get("children"));var t=e.get("text")?e.get("text"):"";return t=t.replace(/(\u200B*):(\u200B*)/g,":").replace(/\u200B\$/,"$")}function o(e,t){s(e,t.get("ahead")||0)}function a(e,t,n){void 0===n&&(n=t.get("after")?1:0),s(e,null==t.get("tail")?n:t.get("tail"))}function s(e,t){for(var n=0;n<t;n++)e.push("")}function l(e){return q.isType(e.get("parent"),z.list_item)&&!1!==e.get("parent").get("tight")}function c(e,t){var n=-1,i="",r=this.get("alignText");for(R=0;R<e.length;R++)if(O=this.get("align")[R],r){var o=r[R];if(o)i+=o,n=R;else if(-1<n){var a=r[n],s=this.get("align")[n];" "!=a[0]||" "===a[a.length-1]||s&&"center"!=s||(r[n]=a+" ",i+=" "),i+=q.adjustAlignText(this,n,O)}else i+=((L=t.getNthChild(R)).get("marginLeft")||"")+Y(O,4)+(L.get("marginRight")||"");i+="|"}else i+=" "+Y(O,e[R])+" |";return i}try{switch(this.get("type")){case z.meta_block:return r.push("---"),(r=r.concat((this.get("text")||"").replace(/^---/gm,"​---").split(/\r*\n/))).push("---"),a(r,this),r;case z.heading:if(o(r,this),this.get("pattern"))r=r.concat(this.get("pattern").replace("{0}",t(this)).split(/\r*\n/));else if(!q.isType(this.get("parent"),z.list_item)&&(1==File.option.headingStyle||3==File.option.headingStyle)&&this.get("depth")<=2)r.push(t(this)),3==File.option.headingStyle?r.push((1==this.get("depth")?"=":"-").repeat(Math.max(1,V.wcswidth(this.get("text"))))):r.push(1==this.get("depth")?"===":"---");else{var d="#".repeat(this.get("depth"))+" "+t(this);2==File.option.headingStyle&&(d+=" "+"#".repeat(this.get("depth"))),r.push(d)}return a(r,this),r;case z.paragraph:return o(r,this),n=t(this),r=r.concat(n),void 0===(S=this.get("tail"))&&this.get("after")&&q.isType(this.get("parent"),z.list_item)&&(S=l(this)?0:void 0),q.isType(this.get("after"),z.paragraph)&&S<1&&this.unset("tail"),q.isType(this.get("after"),z.math_block)&&!this.get("tail")&&(S=0),void 0===S?a(r,this,S):s(r,S),r;case z.line:return n=(this.get("text")||"").replace(/\r*\n+/g,""),this.get("before")&&""!=(this.get("before").get("text")||"").trim()||(n=n.replace(/^( {4}|\t)/gm,"​$1")),r.push(n),r;case z.blockquote:return o(r,this),n=t(this),(x=this.get("userIndent"))&&x.length==n.length?n.map(function(e,t){n[t]=(x[t]||"")+e}):(this.unset("userIndent"),i=X(z.blockquote,0,this,this.get("pattern")),n.map(function(e,t){n[t]=e?i+e:i.replace(/\s+$/,"")})),a(r=r.concat(n),this),""!==r.last()&&q.isType(this.get("after"),z.blockquote)&&r.push(""),r;case z.list:o(r,this);var u=this.get("style"),p=this.isLoose(),h=this.get("children").length;if(h)for(var f=this.getFirstChild(),g=Number.isNaN(Number.parseInt(this.get("start")))?0:Number.parseInt(this.get("start"))-1,m=0;f;){f.set("tight",!p),n=J.call(f),e=this.get("pattern"),p&&e&&f.get("markindent")&&(e=G(u,e.trim(),f.get("markindent")));var v=f.get("prespace")||0,y=void 0===this.get("isFixed")&&File.option.olStyle||this.get("isFixed"),b=(i=" ".repeat(v)+X(u,(y?0:m)+g,f,e,(h+"").length)).length,w=u==q.ListType.ol?(m+g+"").length-1:0;f.get("subindent")?b=Math.min(i.replace(/\s+$/,"").length+4,f.get("subindent")+w):this.get("subindent")?b=Math.min(i.replace(/\s+$/,"").length+4,this.get("subindent")+w):File.option.indentByTab&&(b=0);var x,C=b?" ".repeat(b):"\t";if((x=f.get("userIndent"))&&x.length==n.length)f.get("style")==q.ListType.task&&(x[0].trim().length&&-1==x[0].indexOf("[")&&(x[0]=x[0]+"[ ] "),f.get("checked")?x[0]=x[0].replace("[ ]","[x]"):x[0]=x[0].replace(/\[x\]/i,"[ ]")),n.map(function(e,t){n[t]=x[t]+e,r.push(n[t].replace(K,""))});else{f.unset("userIndent");var k=i;f.get("style")==q.ListType.task&&(k=i+(f.get("checked")?"[x] ":"[ ] ")),n.map(function(e,t){n[t]=(t?e?C:"":k)+n[t],r.push(n[t].replace(K,""))})}m++,f=f.get("after")}return q.isType(this.get("after"),z.list)&&(!this.get("tail")||this.get("tail"))<1&&this.get("pattern")==this.get("after").get("pattern")&&this.get("style")==this.get("after").get("style")&&(this.unset("tail"),r.push(""),l(this)&&r.push("")),a(r,this,l(this)?0:void 0),r;case z.list_item:var S;for("string"==typeof(n=t(this))&&(n=[n]),r=r.concat(n),null==(S=this.get("tail"))&&!this.get("tight")&&this.get("after")&&(S=1),0<S&&r.push("");2<r.length&&""===r.last()&&""===r[r.length-2];)r.pop();return r;case z.fences:o(r,this);var T=this.getText();n=T.split(/\r*\n/),this.get("lang")?(this.get("pattern")||"").trim()?e=this.get("pattern"):(this.unset("pattern"),e=/^\s*```/gm.exec(this.get("text")||"")?"~~~{0}":"```{0}"):e=this.get("pattern")||"```{0}";var F,E=e.match(/^\s+$/),_=(e.match(/[`~]/)||[])[0];_&&(F=new RegExp("^("+_+"{3})"));for(m=0;m<n.length;m++)n[m]=(E?e:"")+(F?n[m].replace(F,"​$1"):n[m]),n[m]=n[m]||"";return!E&&r.push(e.replace(/\{0\}/,this.get("lang")||"")),r=r.concat(n),!E&&r.push(e.replace(/\s*\{0\}/,"")),a(r,this),r;case z.math_block:return o(r,this),r.push("$$"),(r=r.concat(this.get("text").replace(/(^\n)|(\n$)/g,"").split(/\r?\n/).map(function(e){return e||""}))).push("$$"),a(r,this,q.isType(this.get("after"),z.paragraph)&&q.isType(this.get("before"),z.paragraph)?0:1),r;case z.hr:return r.push(this.get("pattern")||"------"),a(r,this),r;case z.def_footnote:return o(r,this),r.push("[^"+this.get("ref")+"]: "+t(this)),a(r,this,!this.get("after")||q.isType(this.get("after"),q.TYPE.def_footnote)?0:1),r;case z.def_link:o(r,this);var M,N=this.safeGetStrAttr("title",!0).length;if(this.get("pattern")){var A=this.get("pattern").split(";");M=A[0]+this.get("ref")+A[1]+this.safeGetStrAttr("href",!0)+A[2],N&&(M+=(A[3]||"\t")+'"'+this.get("title")+'"')}else M="["+this.get("ref")+"]: "+this.safeGetStrAttr("href",!0)+(N?'\t"'+this.get("title")+'"':"");return r.push(M),a(r,this,!this.get("after")||q.isType(this.get("after"),q.TYPE.def_link)?0:1),r;case z.table:if(o(r,this),this.get("userText"))return a(r=r.concat(this.get("userText").clone()),this),r;for(var L,I,R,P,D,O,B,j=[],$=[],H=0,U=this.getFirstChild();U;){for(I=U.getFirstChild(),$[H]=[],R=0;I;)$[H][R]=I.toMark().trim(),I=I.get("after"),0===H&&(j[R]=4),j[R]=Math.max(V.wcswidth($[H][R]),j[R]),j[R]=Math.min(j[R],60),R++;U=U.get("after"),H++}var W="npTable"==this.get("style")&&1<j.length;for(U=this.getFirstChild(),H=0;H<$.length;H++){for(P="|",L=U.getFirstChild(),R=0;R<j.length;R++)void 0!==L.get("marginLeft")?(P+=L.get("marginLeft")+$[H][R]+L.get("marginRight"),P+="|"):(P+=" ",D=Math.max(j[R]-V.wcswidth($[H][R]),0),P+="right"==(O=this.get("align")[R])?" ".repeat(D)+$[H][R]:"center"==O?" ".repeat(B=~~(D/2))+$[H][R]+" ".repeat(D-B):$[H][R]+" ".repeat(D),P+=" |"),L=L.get("after");W?r.push(P.replace(/(^\s*\|)|(\|\s*$)/g,"")):r.push(P.replace(/\s$/,"")),0===H&&(P="|"+c.call(this,j,U),W?r.push(P.replace(/(^\s*\|)|(\|\s*$)/g,"")):r.push(P.replace(/\s$/,""))),U=U.get("after")}return a(r,this),r;case z.table_row:return console.sendError("cannot call toMark on table_row"),"";case z.table_cell:return Q(t(this));case z.toc:return o(r,this),r.push(this.get("pattern")||"[TOC]"),~(this.get("pattern")||"").indexOf("\n")&&this.get("after")?a(r,this,2):a(r,this),r;default:return t(this)}}catch(e){return console.error(e.stack),r}},Q=function(e){var t="",n="",i=[],r=0,o=0;return e=e.replace(/(^|[^\\])`[^`]*\|[^`]*`/g,function(e){return i.push(e),[t,++r-1,n].join("")}),File.option.enableInlineMath&&(e=e.replace(/(^|[^\\])\$[^$]*\|[^$]*\$/g,function(e){return i.push(e),[t,++r-1,n].join("")})),e.replace(/\|/g,"\\|").replace(/\\\\\|/g,"\\|").replace(/\uE07A[^\uE07B]+\uE07B/g,function(){return i[++o-1]})},G=function(e,t,n){var i=File.option.prettyIndent;return void 0!==n?n-=0:n=Math.max(File.option.indentSize-0,2),e==z.blockquote?">"+" ".repeat(Math.min(n-1,i?4:1)):e===q.ListType.ol?"{0}."+" ".repeat(Math.min(n-2,i?4:1)||1):e===q.ListType.ul?(t||o[File.option.ulStyle])+" ".repeat(Math.min(n-1,i?4:1)):o[File.option.ulStyle]+" "},X=function(e,t,n,i){var r=File.option.indentSize;return t++,i=i||G(e),(!$.isNumeric(r)||r<2)&&(r=2),e==z.blockquote?i:e===q.ListType.ol?i.replace("{0}",t):i};q.getIndentPrefix=X,q.getDefaultPrefixPattern=G,q.markFromArr=function(e){var t=Z(e);return t instanceof Array?t.join(File.useCRLF?"\r\n":"\n").replace(K,""):t};var Z=function(e){var n=[],i="";function t(e){var t=J.call(e);t instanceof Array?n=n.concat(t):i+=t}if(e.length)if(e instanceof Array)e.map(function(e){t(e)});else for(var r=e.sortedFirst();t(r),r=r.get("after"););return n.length?n:i};r.prototype.toMark=function(){if(0<this.blocks.length){var e=this.blocks.sortedFirst();e=e.getLastBrother(!0);var t=[],n="";do{var i=J.call(e);i instanceof Array?t=t.concat(i):n+=i,e=e.get("after")}while(e);return t.length?t.join(File.useCRLF?"\r\n":"\n").replace(K,""):n}return""},q.getIndentPrefix=X}),define("app/document/Node2HTML",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils","app/editor/Diagram","codemirror/lib/codemirror","app/editor/KeyMaster","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/window/FileHelper","app/editor/UndoManager","app/editor/Emoji"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton");var b=e("app/document/Node"),w=b.Node,x=(b.NodeMap,b.TYPE),C=(b.NodeCollectionUtils,e("app/document/StringUtils")),k=e("app/editor/Diagram"),S=e("app/document/MarkParser");window.resizeOnIframeLoad=function(e){e.width=Math.min(e.parentElement.offsetWidth,e.contentWindow.document.body.scrollWidth),e.height=e.contentWindow.document.body.scrollHeight},w.prototype.toHTML=function(s,r){var e,l=this,t=["h1","h2","h3","h4","h5","h6"];function c(e){try{return!w.isType(e,x.fences,x.hr,x.def_link,x.def_footnote,x.table,x.math_block)&&((!w.isType(e,x.list_item)||e.get("style")!=w.ListType.task)&&(File.inBusyMode?0==e.get("children").length||void 0:0==e.get("children").length||w.isType(e.get("parent"),x.list_item)||void 0))}catch(e){}}function n(e,t){var n,i=e.get("children");if(s){if(c(l)){var r=$.parseHTML(s);if(r.length&&r[0].getAttribute&&r[0].getAttribute("cid")){for(var o=[],a=0;a<r.length;a++)o.push($(r[a]).attr("contenteditable","true")[0].outerHTML||r[0].textContent);s=o.join("")}}return s}return i&&0<i.length?b.NodeCollectionUtils.toHTML(i,t):(n=e.safeGetStrAttr("text"),w.isType(e,x.paragraph)&&/^\u200b( {4}|\t)/g.exec(n)&&(n=n.replace(/^\u200b( {4}|\t)/g,"$1"),e.set("text",n)),e.cursorDiff=[],S.parseInline(e.safeGetStrAttr("text"),{attr:!w.isType(e,x.heading)},e.cursorDiff))}function i(e){var t=c(e),n=t?"contenteditable='true'":!1===t?"contenteditable='false'":"",i=r?"mdlike='"+r+"' ":" ";return" cid = '"+e.id+"' mdtype = '"+e.get("type")+"' "+n+i}switch(File.option.expandSimpleBlock&&w.isType(this,x.line)&&(-1<t.indexOf(r)?this.get("parent").set("depth",t.indexOf(r)+1):this.get("parent").unset("depth")),this.get("type")){case x.meta_block:var o=this.get("text")||"";return o.match(/^\n$/g)&&(o=o.replace(/^\n$/g,"\n\n")),"<pre "+i(this)+" class='md-meta-block md-end-block' >"+C.escape(o,!1,!0)+"\n</pre>";case x.paragraph:return"<p "+i(this)+">"+n(this,File.option.ignoreLineBreak?"\n":"")+"</p>";case x.line:return"<span class='md-line md-end-block' "+i(this)+">"+n(this)+"</span>";case x.raw_edit:return"<p class='rawedit' contenteditable ='true' "+i(this)+">"+this.safeGetStrAttr("text",!0)+"</p>";case x.heading:return"<h"+this.get("depth")+i(this)+"class='md-end-block md-heading' >"+n(this)+"</h"+this.get("depth")+">";case x.blockquote:return"<blockquote "+i(this)+" >"+n(this)+"</blockquote>";case x.list:var a=this.get("style"),d=((this.get("pattern")||w.UL_DEFAULT_START[File.option.ulStyle]||"-").match(/[*+-]/)||[])[0];if(d=" data-mark='"+d+"' ",a==w.ListType.ol){var u=""===this.get("start")?void 0:this.get("start")-0;return"<ol class='ol-list' "+(u=Number.isNaN(u)||1==u?"":"start='"+this.get("start")+"' ")+i(this)+" >"+n(this)+"</ol>"}return"<ul class='ul-list' "+i(this)+d+" >"+n(this)+"</ul>";case x.list_item:return this.get("parent")&&this.get("style")===w.ListType.task?"<li class='md-list-item task-list-item  md-task-list-item task-list-"+(this.get("checked")?"done":"not-done")+" ' "+i(this)+"><input type='checkbox' "+(this.get("checked")?"checked":"")+"></input>"+n(this)+"</li>":"<li class='md-list-item' "+i(this)+" >"+n(this)+"</li>";case x.fences:var p="<pre class='md-fences mock-cm md-end-block"+(File.option.showLineNumbersForFence?" md-fences-with-lineno":"")+"' lang='"+(this.get("lang")||"").replace(/'/g,"&#39;").toLowerCase()+"' contenteditable='false'"+i(this)+">"+(this.get("text")&&this.get("text").trim().length?C.escape(this.get("text"))+"\n":"<br/>")+"</pre>";if(k.isDiagramType(this.get("lang"))){var h=File.editor.findElemById(this.cid);if(h.find("textarea").val()==this.get("text"))p=$(p).append(h.find(".md-diagram-panel").clone())[0].outerHTML}return p;case x.hr:return"<div tabindex='-1' contenteditable='false' "+i(this)+" class='md-hr md-end-block' ><hr /></div>";case x.def_footnote:return"<div class='footnotes md-def-footnote md-end-block' contenteditable='false'"+i(this)+"><span class='md-def-name' contenteditable='true'>"+C.escape(this.get("ref")?this.get("ref"):"​")+"</span><span class='md-def-split md-def-f' contenteditable='false' >&nbsp;</span><span class='md-def-content' contenteditable='true'>"+n(this)+"</span></div>";case x.def_link:return"<div class='footnotes md-def-link md-end-block' contenteditable='false'"+i(this)+"><span class='md-def-name' contenteditable='true'>"+C.escape(this.get("ref")?this.get("ref"):"​")+"</span><span class='md-def-split md-def-f' contenteditable='false' >&nbsp;</span><span class='md-def-content md-def-url md-auto-disp' href='#' contenteditable='true'>"+C.escape(this.get("href"))+"</span><span class='md-def-split md-auto-hide' >&nbsp;</span><span class='md-def-title md-auto-disp md-auto-hide' contenteditable='true'>"+C.escape(this.get("title"))+"</span></div>";case x.table:this.get("align").length,p="<figure class='md-table-fig' contenteditable='false' "+i(this)+"><table class='md-table'>";for(var f=this.getFirstChild();f;)f.get("before")?p+=f.toHTML():p+="<thead>"+f.toHTML()+"</thead><tbody>",(f=f.get("after"))||(p+="</tbody>");return p+="</table></figure>";case x.table_row:p="<tr class='md-end-block' "+i(this)+">",f=this.getFirstChild();for(var g,m=this.get("parent").get("align"),v=0,y=this.get("before")?"td":"th";f;)p+="<"+y+(g=(g=m[v])?" style='text-align:"+g+";' ":"")+">"+f.toHTML()+"</"+y+">",f=f.get("after"),v++;return p+="</tr>";case x.table_cell:return"<span contenteditable='true' class='td-span' "+i(this)+">"+n(this)+"</span>";case x.math_block:return"<div contenteditable='false' class='mathjax-block md-end-block' id='mathjax-"+this.cid+"' "+i(this)+">$$\n"+C.escape(C.useOrDefault(this.get("text"),"<Empty \\space Math \\space Block>"))+"\n$$</div>";case x.toc:return e=this.get("in"),"<div contenteditable='false' tabindex='-1' class='md-toc md-end-block' "+i(this)+"><div class='md-tooltip-hide md-toc-tooltip'><span>"+$.localize.getString("Table of Contents")+"</span> <button type='button' class='btn md-delete-toc'><span class='glyphicon glyphicon-trash'></span></button></div><p class='md-toc-content'>"+(e.toc?e.toc.getTocInnerHTML():"")+"</p></div>";case x.iframe:return"<div contenteditable='false' tabindex='-1' class='md-iframe md-end-block' "+i(this)+"><div class='md-meta'>"+C.escape(this.get("text"))+"</div><iframe src='"+C.escape(this.get("href"))+"' width='"+C.escape(this.get("width")||"100%")+"' height='"+C.escape(this.get("height")||"")+"' allowfullscreen frameborder='0'></iframe></div>";default:return"<p "+i(this)+">unknow type: "+this.get("type")+"</p>"}}}),define("app/editor/Diagram",["codemirror/lib/codemirror","app/document/StringUtils","jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/editor/KeyMaster"],function(i,e,t){"use strict";var p,h=i("codemirror/lib/codemirror"),f=(i("app/document/StringUtils"),i("jquery/jquery")),n=i("exoskeleton-master/exoskeleton"),r=i("app/document/Node"),g=(i("app/editor/KeyMaster").map,r.TYPE,r.Node),m={},v={},y=0,o=n.Model.extend({initialize:function(e){this.editor=e},cancelDiagram:function(e){var t=this.editor.fences.getCm(e);this.editor.findElemById(e).find(".md-diagram-panel").remove().end()[0].style.marginBottom="",m[e]&&clearTimeout(m[e]),m[e]=void 0,v[e]=void 0,t.state.lint&&h.clearMarks(t),t.getWrapperElement().offsetHeight||t.refresh()},refreshDiagram:function(e,t){var n=this;t||(t=f("#write")),t.find(".md-fences").each(function(){(e||o.isDiagramType(this.getAttribute("lang"))&&!this.querySelector("svg"))&&(n.editor.fences.getCm(this.getAttribute("cid")),n.updateDiagram(this.getAttribute("cid"),!0))})},lazyload:function(){if(File.option.enableDiagram){var e=this,n=this.editor;window.debugMode?i.async(["diagram/mermaidAPI.js","diagram/raphael.js"],function(){i.async(["diagram/sequence-diagram.js","diagram/flowchart.js"],function(){t()})}):i.async(File.isMac||window.debugMode?"lib/diagram/diagram.min.js":"lib.asar/diagram/diagram.min.js",t)}function t(){e.modeLoaded=!0,mermaidAPI.initialize({theme:"none",startOnLoad:!1,flowchart:{useMaxWidth:!1},sequence:{useMaxWidth:!1,diagramMarginX:10,diagramMarginY:8,boxMargin:20},gantt:{leftPadding:0,rightPadding:0}}),mermaidAPI.parseError=function(e,t){throw t.message=e,p=t,new Error(t.message)},f(n.sessionStr).on("click",".md-diagram-panel",function(e){var t=f(e.target).closest("a");if(t.length)return n.tryOpenLink(t),!1;this.previousSibling.classList.contains("CodeMirror-focused")||(this.previousSibling.CodeMirror.refresh(),this.previousSibling.CodeMirror.focus())}).addClass("enable-diagrams"),e.refreshDiagram()}},startPreview:function(e){var t=this.editor.getNode(e).get("lang"),n=this.editor.fences.getCm(e);if(o.isDiagramType(t)){var i=this.editor.findElemById(e),r=i.find(".md-diagram-panel");r.length||(r=f("#componenet .md-diagram-panel").clone(),i.append(r),this.updateDiagram(e),n.setOption("lint",{getAnnotations:function(){return[]},lintOnChange:!1})),i[0].style.marginBottom=i[0].classList.contains("md-focus")?r.height()+50+"px":""}},updateDiagram:function(n,i,e){var r,o=this.editor,a=this.editor.findElemById(n),s=this.editor.fences.getCm(n),l=a.find(".md-diagram-panel");if(a[0].removeAttribute("mermaid-type"),!l.length)return o.diagrams.startPreview(n);function c(e){l.find(".md-diagram-panel-error")[0].innerHTML="",s.state.lint&&h.clearMarks(s),e&&(v[s.cid]=null)}function d(e,t){e.loc&&((v[n]=e).message="["+t+"]"+e.message,i?document.querySelector("[cid='"+n+"'] .md-diagram-panel-error").textContent=e.message:e.loc.first_line-1==(s.getCursor()||{}).line&&1<s.doc.lineCount()?c():o.diagrams.attachError(s,e))}var t="#fff";function u(){if(g.isType(s.options.mode,"sequence"))!function(){try{r=Diagram.parse(s.getValue()||"title: Empty Diagram"),v[n]=null}catch(e){return d(e,"Sequence")}c(!0),l.find(".md-diagram-panel-preview")[0].innerHTML="",r.drawSVG(l.find(".md-diagram-panel-preview")[0],{theme:"simple"});var e=l.find("svg")[0],t=l.width()/(e.getAttribute("width").replace("px","")-0);t<1&&(e.style.zoom=t)}();else if(g.isType(s.options.mode,"flow"))!function(){try{c(!0),r=flowchart.parse(s.getValue().replace(/\r/g,"")||"st=>start: Empty Diagram\ne=>end\nst->e"),l.find(".md-diagram-panel-preview")[0].innerHTML="",r.drawSVG(l.find(".md-diagram-panel-preview")[0],{y:0,"font-color":"currentColor","line-color":"currentColor","element-color":"currentColor",fill:t})}catch(e){return}}();else{if(!g.isType(s.options.mode,"mermaid"))return;!function(){c(!0);var n=0,i=l.find(".md-diagram-panel-preview")[0],e=s.getValue().replace(/^(\s*(%%.*)*\n)+/,function(e){return n+=e.match(/\n/g).length,""}).replace(/\t/g,"    "),t=(e.match(/\s*([^\s]+)/)||["",""])[1];a[0].setAttribute("mermaid-type",t);var r=function(e){if(i.innerHTML=e){var t=i.children[0];t.getAttribute("height")&&"100%"!=t.getAttribute("height")&&(t.style.height=t.getAttribute("viewBox").split(/\s/)[3]-0+40+"px")}};try{if(p=null,r(""),0==e.trim().length?r("<text>"+f.localize.getString("Empty Diagram")+"</text>"):mermaidAPI.render("mermaidChart"+y++,e.replace(/\r/g,""),r,i),p)throw p}catch(e){return e.loc?(e.loc.first_line+=n,e.loc.last_line+=n,e.message=e.message.replace(/^[^\n]*(\d)/,function(e,t){return"Parse error on line "+(t-0+n)})):e.loc={first_line:e.line+1,last_line:e.line+1},d(e,"Mermaid")}c(!0)}()}var e=l.closest("[cid]")[0];e.style.marginBottom=e.classList.contains("md-focus")?l.height()+40+"px":"",m[n]=null}window.CSS&&window.CSS.supports&&window.CSS.supports("(--foo: red)")&&(t="var(--bg-color)"),m[n]&&clearTimeout(m[n]),e?u():m[n]=setTimeout(u,200)},attachError:function(e,t){try{if(t=t||v[e.cid],e.state.lint&&h.clearMarks(e),!t||!t.loc)return;var n={from:h.Pos(t.loc.first_line-1,t.loc.first_column),to:h.Pos(t.loc.last_line-1,t.loc.last_column||e.doc.getLine(t.loc.last_line-1).length),message:t.message};document.querySelector("[cid='"+e.cid+"'] .md-diagram-panel-error").textContent=t.message,h.updateLinting(e,[n])}catch(t){}}});o.isDiagramType=function(e){return File.option.enableDiagram&&"string"==typeof e&&g.isType((e||"").toLowerCase(),"sequence","flow","mermaid")},o.MODES=["sequence","flow","mermaid"],t.exports=o}),define("codemirror/lib/codemirror",[],function(e,t,n){n.exports=function(){"use strict";var e=navigator.userAgent,t=navigator.platform,g=/gecko\/\d/i.test(e),n=/MSIE \d/.test(e),i=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(e),r=/Edge\/(\d+)/.exec(e),x=n||i||r,C=x&&(n?document.documentMode||6:+(r||i)[1]),b=!r&&/WebKit\//.test(e),o=b&&/Qt\/\d+\.\d+/.test(e),a=!r&&/Chrome\//.test(e),m=/Opera\//.test(e),d=/Apple Computer/.test(navigator.vendor),s=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(e),l=/PhantomJS/.test(e),c=!r&&/AppleWebKit/.test(e)&&/Mobile\/\w+/.test(e),u=/Android/.test(e),p=c||u||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(e),w=c||/Mac/.test(t),h=/\bCrOS\b/.test(e),f=/win/i.test(t),v=m&&e.match(/Version\/(\d*\.\d*)/);v&&(v=Number(v[1])),v&&15<=v&&(m=!1,b=!0);var y=w&&(o||m&&(null==v||v<12.11)),k=g||x&&9<=C;function S(e){return new RegExp("(^|\\s)"+e+"(?:$|\\s)\\s*")}var T,F=function(e,t){var n=e.className,i=S(t).exec(n);if(i){var r=n.slice(i.index+i[0].length);e.className=n.slice(0,i.index)+(r?i[1]+r:"")}};function E(e){for(var t=e.childNodes.length;0<t;--t)e.removeChild(e.firstChild);return e}function _(e,t){return E(e).appendChild(t)}function M(e,t,n,i){var r=document.createElement(e);if(n&&(r.className=n),i&&(r.style.cssText=i),"string"==typeof t)r.appendChild(document.createTextNode(t));else if(t)for(var o=0;o<t.length;++o)r.appendChild(t[o]);return r}function N(e,t,n,i){var r=M(e,t,n,i);return r.setAttribute("role","presentation"),r}function A(e,t){if(3==t.nodeType&&(t=t.parentNode),e.contains)return e.contains(t);do{if(11==t.nodeType&&(t=t.host),t==e)return!0}while(t=t.parentNode)}function L(){var t;try{t=document.activeElement}catch(e){t=document.body||null}for(;t&&t.shadowRoot&&t.shadowRoot.activeElement;)t=t.shadowRoot.activeElement;return t}function I(e,t){var n=e.className;S(t).test(n)||(e.className+=(n?" ":"")+t)}function R(e,t){for(var n=e.split(" "),i=0;i<n.length;i++)n[i]&&!S(n[i]).test(t)&&(t+=" "+n[i]);return t}T=document.createRange?function(e,t,n,i){var r=document.createRange();return r.setEnd(i||e,n),r.setStart(e,t),r}:function(e,t,n){var i=document.body.createTextRange();try{i.moveToElementText(e.parentNode)}catch(e){return i}return i.collapse(!0),i.moveEnd("character",n),i.moveStart("character",t),i};var P=function(e){e.select()};function D(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t)}}function O(e,t,n){for(var i in t||(t={}),e)!e.hasOwnProperty(i)||!1===n&&t.hasOwnProperty(i)||(t[i]=e[i]);return t}function B(e,t,n,i,r){null==t&&-1==(t=e.search(/[^\s\u00a0]/))&&(t=e.length);for(var o=i||0,a=r||0;;){var s=e.indexOf("\t",o);if(s<0||t<=s)return a+(t-o);a+=s-o,a+=n-a%n,o=s+1}}c?P=function(e){e.selectionStart=0,e.selectionEnd=e.value.length}:x&&(P=function(e){try{e.select()}catch(e){}});var j=function(){this.id=null};function $(e,t){for(var n=0;n<e.length;++n)if(e[n]==t)return n;return-1}j.prototype.set=function(e,t){clearTimeout(this.id),this.id=setTimeout(t,e)};var H=30,U={toString:function(){return"CodeMirror.Pass"}},W={scroll:!1},q={origin:"*mouse"},z={origin:"+move"};function V(e,t,n){for(var i=0,r=0;;){var o=e.indexOf("\t",i);-1==o&&(o=e.length);var a=o-i;if(o==e.length||t<=r+a)return i+Math.min(a,t-r);if(r+=o-i,i=o+1,t<=(r+=n-r%n))return i}}var K=[""];function Y(e){for(;K.length<=e;)K.push(J(K)+" ");return K[e]}function J(e){return e[e.length-1]}function Q(e,t){for(var n=[],i=0;i<e.length;i++)n[i]=t(e[i],i);return n}function G(){}function X(e,t){var n;return Object.create?n=Object.create(e):(G.prototype=e,n=new G),t&&O(t,n),n}var Z=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;function ee(e){return/\w/.test(e)||""<e&&(e.toUpperCase()!=e.toLowerCase()||Z.test(e))}function te(e,t){return t?!!(-1<t.source.indexOf("\\w")&&ee(e))||t.test(e):ee(e)}function ne(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!1;return!0}var ie=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;function re(e){return 768<=e.charCodeAt(0)&&ie.test(e)}function oe(e,t,n){for(;(n<0?0<t:t<e.length)&&re(e.charAt(t));)t+=n;return t}function ae(e,t,n){for(;;){if(Math.abs(t-n)<=1)return e(t)?t:n;var i=Math.floor((t+n)/2);e(i)?n=i:t=i}}function se(e,t){if((t-=e.first)<0||t>=e.size)throw new Error("There is no line "+(t+e.first)+" in the document.");for(var n=e;!n.lines;)for(var i=0;;++i){var r=n.children[i],o=r.chunkSize();if(t<o){n=r;break}t-=o}return n.lines[t]}function le(e,n,i){var r=[],o=n.line;return e.iter(n.line,i.line+1,function(e){var t=e.text;o==i.line&&(t=t.slice(0,i.ch)),o==n.line&&(t=t.slice(n.ch)),r.push(t),++o}),r}function ce(e,t,n){var i=[];return e.iter(t,n,function(e){i.push(e.text)}),i}function de(e,t){var n=t-e.height;if(n)for(var i=e;i;i=i.parent)i.height+=n}function ue(e){if(null==e.parent)return null;for(var t=e.parent,n=$(t.lines,e),i=t.parent;i;i=(t=i).parent)for(var r=0;i.children[r]!=t;++r)n+=i.children[r].chunkSize();return n+t.first}function pe(e,t){var n=e.first;e:do{for(var i=0;i<e.children.length;++i){var r=e.children[i],o=r.height;if(t<o){e=r;continue e}t-=o,n+=r.chunkSize()}return n}while(!e.lines);for(var a=0;a<e.lines.length;++a){var s=e.lines[a].height;if(t<s)break;t-=s}return n+a}function he(e,t){return t>=e.first&&t<e.first+e.size}function fe(e,t){return String(e.lineNumberFormatter(t+e.firstLineNumber))}function ge(e,t,n){if(void 0===n&&(n=null),!(this instanceof ge))return new ge(e,t,n);this.line=e,this.ch=t,this.sticky=n}function me(e,t){return e.line-t.line||e.ch-t.ch}function ve(e,t){return e.sticky==t.sticky&&0==me(e,t)}function ye(e){return ge(e.line,e.ch)}function be(e,t){return me(e,t)<0?t:e}function we(e,t){return me(e,t)<0?e:t}function xe(e,t){return Math.max(e.first,Math.min(t,e.first+e.size-1))}function Ce(e,t){if(t.line<e.first)return ge(e.first,0);var n,i,r,o=e.first+e.size-1;return t.line>o?ge(o,se(e,o).text.length):(i=se(e,(n=t).line).text.length,null==(r=n.ch)||i<r?ge(n.line,i):r<0?ge(n.line,0):n)}function ke(e,t){for(var n=[],i=0;i<t.length;i++)n[i]=Ce(e,t[i]);return n}var Se=!1,Te=!1;function Fe(e,t,n){this.marker=e,this.from=t,this.to=n}function Ee(e,t){if(e)for(var n=0;n<e.length;++n){var i=e[n];if(i.marker==t)return i}}function _e(e,t){for(var n,i=0;i<e.length;++i)e[i]!=t&&(n||(n=[])).push(e[i]);return n}function Me(e,t){if(t.full)return null;var n=he(e,t.from.line)&&se(e,t.from.line).markedSpans,i=he(e,t.to.line)&&se(e,t.to.line).markedSpans;if(!n&&!i)return null;var r=t.from.ch,o=t.to.ch,a=0==me(t.from,t.to),s=function(e,t,n){var i;if(e)for(var r=0;r<e.length;++r){var o=e[r],a=o.marker;if(null==o.from||(a.inclusiveLeft?o.from<=t:o.from<t)||o.from==t&&"bookmark"==a.type&&(!n||!o.marker.insertLeft)){var s=null==o.to||(a.inclusiveRight?o.to>=t:o.to>t);(i||(i=[])).push(new Fe(a,o.from,s?null:o.to))}}return i}(n,r,a),l=function(e,t,n){var i;if(e)for(var r=0;r<e.length;++r){var o=e[r],a=o.marker;if(null==o.to||(a.inclusiveRight?o.to>=t:o.to>t)||o.from==t&&"bookmark"==a.type&&(!n||o.marker.insertLeft)){var s=null==o.from||(a.inclusiveLeft?o.from<=t:o.from<t);(i||(i=[])).push(new Fe(a,s?null:o.from-t,null==o.to?null:o.to-t))}}return i}(i,o,a),c=1==t.text.length,d=J(t.text).length+(c?r:0);if(s)for(var u=0;u<s.length;++u){var p=s[u];if(null==p.to){var h=Ee(l,p.marker);h?c&&(p.to=null==h.to?null:h.to+d):p.to=r}}if(l)for(var f=0;f<l.length;++f){var g=l[f];if(null!=g.to&&(g.to+=d),null==g.from)Ee(s,g.marker)||(g.from=d,c&&(s||(s=[])).push(g));else g.from+=d,c&&(s||(s=[])).push(g)}s&&(s=Ne(s)),l&&l!=s&&(l=Ne(l));var m=[s];if(!c){var v,y=t.text.length-2;if(0<y&&s)for(var b=0;b<s.length;++b)null==s[b].to&&(v||(v=[])).push(new Fe(s[b].marker,null,null));for(var w=0;w<y;++w)m.push(v);m.push(l)}return m}function Ne(e){for(var t=0;t<e.length;++t){var n=e[t];null!=n.from&&n.from==n.to&&!1!==n.marker.clearWhenEmpty&&e.splice(t--,1)}return e.length?e:null}function Ae(e){var t=e.markedSpans;if(t){for(var n=0;n<t.length;++n)t[n].marker.detachLine(e);e.markedSpans=null}}function Le(e,t){if(t){for(var n=0;n<t.length;++n)t[n].marker.attachLine(e);e.markedSpans=t}}function Ie(e){return e.inclusiveLeft?-1:0}function Re(e){return e.inclusiveRight?1:0}function Pe(e,t){var n=e.lines.length-t.lines.length;if(0!=n)return n;var i=e.find(),r=t.find(),o=me(i.from,r.from)||Ie(e)-Ie(t);if(o)return-o;var a=me(i.to,r.to)||Re(e)-Re(t);return a||t.id-e.id}function De(e,t){var n,i=Te&&e.markedSpans;if(i)for(var r=void 0,o=0;o<i.length;++o)(r=i[o]).marker.collapsed&&null==(t?r.from:r.to)&&(!n||Pe(n,r.marker)<0)&&(n=r.marker);return n}function Oe(e){return De(e,!0)}function Be(e){return De(e,!1)}function je(e,t,n,i,r){var o=se(e,t),a=Te&&o.markedSpans;if(a)for(var s=0;s<a.length;++s){var l=a[s];if(l.marker.collapsed){var c=l.marker.find(0),d=me(c.from,n)||Ie(l.marker)-Ie(r),u=me(c.to,i)||Re(l.marker)-Re(r);if(!(0<=d&&u<=0||d<=0&&0<=u)&&(d<=0&&(l.marker.inclusiveRight&&r.inclusiveLeft?0<=me(c.to,n):0<me(c.to,n))||0<=d&&(l.marker.inclusiveRight&&r.inclusiveLeft?me(c.from,i)<=0:me(c.from,i)<0)))return!0}}}function $e(e){for(var t;t=Oe(e);)e=t.find(-1,!0).line;return e}function He(e,t){var n=se(e,t),i=$e(n);return n==i?t:ue(i)}function Ue(e,t){if(t>e.lastLine())return t;var n,i=se(e,t);if(!We(e,i))return t;for(;n=Be(i);)i=n.find(1,!0).line;return ue(i)+1}function We(e,t){var n=Te&&t.markedSpans;if(n)for(var i=void 0,r=0;r<n.length;++r)if((i=n[r]).marker.collapsed){if(null==i.from)return!0;if(!i.marker.widgetNode&&0==i.from&&i.marker.inclusiveLeft&&qe(e,t,i))return!0}}function qe(e,t,n){if(null==n.to){var i=n.marker.find(1,!0);return qe(e,i.line,Ee(i.line.markedSpans,n.marker))}if(n.marker.inclusiveRight&&n.to==t.text.length)return!0;for(var r=void 0,o=0;o<t.markedSpans.length;++o)if((r=t.markedSpans[o]).marker.collapsed&&!r.marker.widgetNode&&r.from==n.to&&(null==r.to||r.to!=n.from)&&(r.marker.inclusiveLeft||n.marker.inclusiveRight)&&qe(e,t,r))return!0}function ze(e){for(var t=0,n=(e=$e(e)).parent,i=0;i<n.lines.length;++i){var r=n.lines[i];if(r==e)break;t+=r.height}for(var o=n.parent;o;o=(n=o).parent)for(var a=0;a<o.children.length;++a){var s=o.children[a];if(s==n)break;t+=s.height}return t}function Ve(e){if(0==e.height)return 0;for(var t,n=e.text.length,i=e;t=Oe(i);){var r=t.find(0,!0);i=r.from.line,n+=r.from.ch-r.to.ch}for(i=e;t=Be(i);){var o=t.find(0,!0);n-=i.text.length-o.from.ch,n+=(i=o.to.line).text.length-o.to.ch}return n}function Ke(e){var n=e.display,t=e.doc;n.maxLine=se(t,t.first),n.maxLineLength=Ve(n.maxLine),n.maxLineChanged=!0,t.iter(function(e){var t=Ve(e);t>n.maxLineLength&&(n.maxLineLength=t,n.maxLine=e)})}var Ye=null;function Je(e,t,n){var i;Ye=null;for(var r=0;r<e.length;++r){var o=e[r];if(o.from<t&&o.to>t)return r;o.to==t&&(o.from!=o.to&&"before"==n?i=r:Ye=r),o.from==t&&(o.from!=o.to&&"before"!=n?i=r:Ye=r)}return null!=i?i:Ye}var Qe=function(){var O="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",B="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111";var j=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,$=/[stwN]/,H=/[LRr]/,U=/[Lb1n]/,W=/[1n]/;function q(e,t,n){this.level=e,this.from=t,this.to=n}return function(e,t){var n="ltr"==t?"L":"R";if(0==e.length||"ltr"==t&&!j.test(e))return!1;for(var i,r=e.length,o=[],a=0;a<r;++a)o.push((i=e.charCodeAt(a))<=247?O.charAt(i):1424<=i&&i<=1524?"R":1536<=i&&i<=1785?B.charAt(i-1536):1774<=i&&i<=2220?"r":8192<=i&&i<=8203?"w":8204==i?"b":"L");for(var s=0,l=n;s<r;++s){var c=o[s];"m"==c?o[s]=l:l=c}for(var d=0,u=n;d<r;++d){var p=o[d];"1"==p&&"r"==u?o[d]="n":H.test(p)&&"r"==(u=p)&&(o[d]="R")}for(var h=1,f=o[0];h<r-1;++h){var g=o[h];"+"==g&&"1"==f&&"1"==o[h+1]?o[h]="1":","!=g||f!=o[h+1]||"1"!=f&&"n"!=f||(o[h]=f),f=g}for(var m=0;m<r;++m){var v=o[m];if(","==v)o[m]="N";else if("%"==v){var y=void 0;for(y=m+1;y<r&&"%"==o[y];++y);for(var b=m&&"!"==o[m-1]||y<r&&"1"==o[y]?"1":"N",w=m;w<y;++w)o[w]=b;m=y-1}}for(var x=0,C=n;x<r;++x){var k=o[x];"L"==C&&"1"==k?o[x]="L":H.test(k)&&(C=k)}for(var S=0;S<r;++S)if($.test(o[S])){var T=void 0;for(T=S+1;T<r&&$.test(o[T]);++T);for(var F="L"==(S?o[S-1]:n),E=F==("L"==(T<r?o[T]:n))?F?"L":"R":n,_=S;_<T;++_)o[_]=E;S=T-1}for(var M,N=[],A=0;A<r;)if(U.test(o[A])){var L=A;for(++A;A<r&&U.test(o[A]);++A);N.push(new q(0,L,A))}else{var I=A,R=N.length;for(++A;A<r&&"L"!=o[A];++A);for(var P=I;P<A;)if(W.test(o[P])){I<P&&N.splice(R,0,new q(1,I,P));var D=P;for(++P;P<A&&W.test(o[P]);++P);N.splice(R,0,new q(2,D,P)),I=P}else++P;I<A&&N.splice(R,0,new q(1,I,A))}return 1==N[0].level&&(M=e.match(/^\s+/))&&(N[0].from=M[0].length,N.unshift(new q(0,0,M[0].length))),1==J(N).level&&(M=e.match(/\s+$/))&&(J(N).to-=M[0].length,N.push(new q(0,r-M[0].length,r))),"rtl"==t?N.reverse():N}}();function Ge(e,t){var n=e.order;return null==n&&(n=e.order=Qe(e.text,t)),n}function Xe(e,t,n){var i=oe(e.text,t+n,n);return i<0||i>e.text.length?null:i}function Ze(e,t,n){var i=Xe(e,t.ch,n);return null==i?null:new ge(t.line,i,n<0?"after":"before")}function et(e,t,n,i,r){if(e){var o=Ge(n,t.doc.direction);if(o){var a,s=r<0?J(o):o[0],l=r<0==(1==s.level)?"after":"before";if(0<s.level){var c=Nn(t,n);a=r<0?n.text.length-1:0;var d=An(t,c,a).top;a=ae(function(e){return An(t,c,e).top==d},r<0==(1==s.level)?s.from:s.to-1,a),"before"==l&&(a=Xe(n,a,1))}else a=r<0?s.to:s.from;return new ge(i,a,l)}}return new ge(i,r<0?n.text.length:0,r<0?"before":"after")}function tt(o,a,s,e){var l=Ge(a,o.doc.direction);if(!l)return Ze(a,s,e);s.ch>=a.text.length?(s.ch=a.text.length,s.sticky="before"):s.ch<=0&&(s.ch=0,s.sticky="after");var t=Je(l,s.ch,s.sticky),n=l[t];if("ltr"==o.doc.direction&&n.level%2==0&&(0<e?n.to>s.ch:n.from<s.ch))return Ze(a,s,e);var c,d=function(e,t){return Xe(a,e instanceof ge?e.ch:e,t)},i=function(e){return o.options.lineWrapping?(c=c||Nn(o,a),r=Hn(t=o,n=a,An(t,i=c,e),"line").top,Yn(t,n,i,r)):{begin:0,end:a.text.length};var t,n,i,r},r=i("before"==s.sticky?d(s,-1):s.ch);if("rtl"==o.doc.direction||1==n.level){var u=1==n.level==e<0,p=d(s,u?1:-1);if(null!=p&&(u?p<=n.to&&p<=r.end:p>=n.from&&p>=r.begin)){var h=u?"before":"after";return new ge(s.line,p,h)}}var f=function(e,t,n){for(var i=function(e,t){return t?new ge(s.line,d(e,1),"before"):new ge(s.line,e,"after")};0<=e&&e<l.length;e+=t){var r=l[e],o=0<t==(1!=r.level),a=o?n.begin:d(n.end,-1);if(r.from<=a&&a<r.to)return i(a,o);if(a=o?r.from:d(r.to,-1),n.begin<=a&&a<n.end)return i(a,o)}},g=f(t+e,e,r);if(g)return g;var m=0<e?r.end:d(r.begin,-1);return null==m||0<e&&m==a.text.length||!(g=f(0<e?0:l.length-1,e,i(m)))?null:g}var nt=[],it=function(e,t,n){if(e.addEventListener)e.addEventListener(t,n,!1,{passive:!0});else if(e.attachEvent)e.attachEvent("on"+t,n);else{var i=e._handlers||(e._handlers={});i[t]=(i[t]||nt).concat(n)}};function rt(e,t){return e._handlers&&e._handlers[t]||nt}function ot(e,t,n){if(e.removeEventListener)e.removeEventListener(t,n,!1);else if(e.detachEvent)e.detachEvent("on"+t,n);else{var i=e._handlers,r=i&&i[t];if(r){var o=$(r,n);-1<o&&(i[t]=r.slice(0,o).concat(r.slice(o+1)))}}}function at(e,t){var n=rt(e,t);if(n.length)for(var i=Array.prototype.slice.call(arguments,2),r=0;r<n.length;++r)n[r].apply(null,i)}function st(e,t,n){return"string"==typeof t&&(t={type:t,preventDefault:function(){this.defaultPrevented=!0}}),at(e,n||t.type,e,t),ht(t)||t.codemirrorIgnore}function lt(e){var t=e._handlers&&e._handlers.cursorActivity;if(t)for(var n=e.curOp.cursorActivityHandlers||(e.curOp.cursorActivityHandlers=[]),i=0;i<t.length;++i)-1==$(n,t[i])&&n.push(t[i])}function ct(e,t){return 0<rt(e,t).length}function dt(e){e.prototype.on=function(e,t){it(this,e,t)},e.prototype.off=function(e,t){ot(this,e,t)}}function ut(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function pt(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function ht(e){return null!=e.defaultPrevented?e.defaultPrevented:0==e.returnValue}function ft(e){ut(e),pt(e)}function gt(e){return e.target||e.srcElement}function mt(e){var t=e.which;return null==t&&(1&e.button?t=1:2&e.button?t=3:4&e.button&&(t=2)),w&&e.ctrlKey&&1==t&&(t=3),t}var vt,yt,bt=function(){if(x&&C<9)return!1;var e=M("div");return"draggable"in e||"dragDrop"in e}();function wt(e){if(null==vt){var t=M("span","​");_(e,M("span",[t,document.createTextNode("x")])),0!=e.firstChild.offsetHeight&&(vt=t.offsetWidth<=1&&2<t.offsetHeight&&!(x&&C<8))}var n=vt?M("span","​"):M("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return n.setAttribute("cm-text",""),n}function xt(e){if(null!=yt)return yt;var t=_(e,document.createTextNode("AخA")),n=T(t,0,1).getBoundingClientRect(),i=T(t,1,2).getBoundingClientRect();return E(e),!(!n||n.left==n.right)&&(yt=i.right-n.right<3)}var Ct,kt=3!="\n\nb".split(/\n/).length?function(e){for(var t=0,n=[],i=e.length;t<=i;){var r=e.indexOf("\n",t);-1==r&&(r=e.length);var o=e.slice(t,"\r"==e.charAt(r-1)?r-1:r),a=o.indexOf("\r");-1!=a?(n.push(o.slice(0,a)),t+=a+1):(n.push(o),t=r+1)}return n}:function(e){return e.split(/\r\n?|\n/)},St=window.getSelection?function(e){try{return e.selectionStart!=e.selectionEnd}catch(e){return!1}}:function(e){var t;try{t=e.ownerDocument.selection.createRange()}catch(e){}return!(!t||t.parentElement()!=e)&&0!=t.compareEndPoints("StartToEnd",t)},Tt="oncopy"in(Ct=M("div"))||(Ct.setAttribute("oncopy","return;"),"function"==typeof Ct.oncopy),Ft=null;var Et={},_t={};function Mt(e){if("string"==typeof e&&_t.hasOwnProperty(e))e=_t[e];else if(e&&"string"==typeof e.name&&_t.hasOwnProperty(e.name)){var t=_t[e.name];"string"==typeof t&&(t={name:t}),(e=X(t,e)).name=t.name}else{if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+xml$/.test(e))return Mt("application/xml");if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+json$/.test(e))return Mt("application/json")}return"string"==typeof e?{name:e}:e||{name:"null"}}function Nt(e,t){t=Mt(t);var n=Et[t.name];if(!n)return Nt(e,"text/plain");var i=n(e,t);if(At.hasOwnProperty(t.name)){var r=At[t.name];for(var o in r)r.hasOwnProperty(o)&&(i.hasOwnProperty(o)&&(i["_"+o]=i[o]),i[o]=r[o])}if(i.name=t.name,t.helperType&&(i.helperType=t.helperType),t.modeProps)for(var a in t.modeProps)i[a]=t.modeProps[a];return i}var At={};function Lt(e,t){O(t,At.hasOwnProperty(e)?At[e]:At[e]={})}function It(e,t){if(!0===t)return t;if(e.copyState)return e.copyState(t);var n={};for(var i in t){var r=t[i];r instanceof Array&&(r=r.concat([])),n[i]=r}return n}function Rt(e,t){for(var n;e.innerMode&&(n=e.innerMode(t))&&n.mode&&n.mode!=e;)t=n.state,e=n.mode;return n&&!n.mode&&(n=void 0),n||{mode:e,state:t}}function Pt(e,t,n){return!e.startState||e.startState(t,n)}var Dt=function(e,t){this.pos=this.start=0,this.string=e,this.tabSize=t||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0};function Ot(t,n,i,e){var l=[t.state.modeGen],r={},o=ue(n);"object"==typeof i&&(i.lineBefore=t.getLine(o-1),i.lineAfter=t.getLine(o+1)),zt(t,n.text,t.doc.mode,i,function(e,t){return l.push(e,t)},r,e);for(var a=function(e){var o=t.state.overlays[e],a=1,s=0;zt(t,n.text,o.mode,"visiblespace"!==o.mode.name||i,function(e,t){for(var n=a;s<e;){var i=l[a];e<i&&l.splice(a,1,e,l[a+1],i),a+=2,s=Math.min(e,i)}if(t)if(o.opaque)l.splice(n,a-n,e,"overlay "+t),a=n+2;else for(;n<a;n+=2){var r=l[n+1];l[n+1]=(r?r+" ":"")+"overlay "+t}},r)},s=0;s<t.state.overlays.length;++s)a(s);return{styles:l,classes:r.bgClass||r.textClass?r:null}}function Bt(e,t,n){if(!t.styles||t.styles[0]!=e.state.modeGen){var i=jt(e,ue(t)),r=Ot(e,t,t.text.length>e.options.maxHighlightLength?It(e.doc.mode,i):i);t.stateAfter=i,t.styles=r.styles,r.classes?t.styleClasses=r.classes:t.styleClasses&&(t.styleClasses=null),n===e.doc.frontier&&e.doc.frontier++}return t.styles}function jt(n,i,e){var r=n.doc,o=n.display;if(!r.mode.startState)return!0;var a=function(e,t,n){for(var i,r,o=e.doc,a=n?-1:t-(e.doc.mode.innerMode?1e3:100),s=t;a<s;--s){if(s<=o.first)return o.first;var l=se(o,s-1);if(l.stateAfter&&(!n||s<=o.frontier))return s;var c=B(l.text,null,e.options.tabSize);(null==r||c<i)&&(r=s-1,i=c)}return r}(n,i,e),s=a>r.first&&se(r,a-1).stateAfter;return s=s?It(r.mode,s):Pt(r.mode),r.iter(a,i,function(e){"object"==typeof s&&(s.lineBefore=n.getLine(i-1),s.lineAfter=n.getLine(i+1)),$t(n,e.text,s);var t=a==i-1||a%5==0||a>=o.viewFrom&&a<o.viewTo;e.stateAfter=t?It(r.mode,s):null,++a}),e&&(r.frontier=a),s}function $t(e,t,n,i){var r=e.doc.mode,o=new Dt(t,e.options.tabSize);for(o.start=o.pos=i||0,n.lineBefore=n.lineBefore||"",n.lineAfter=n.lineAfter||"",""==t&&Ht(r,n);!o.eol();)Ut(r,o,n),o.start=o.pos}function Ht(e,t){if(e.blankLine)return e.blankLine(t);if(e.innerMode){var n=Rt(e,t);return n.mode.blankLine?n.mode.blankLine(n.state):void 0}}function Ut(e,t,n,i){for(var r=0;r<10;r++){i&&(i[0]=Rt(e,n).mode);var o=e.token(t,n);if(t.pos>t.start)return o}if("gfm"==e.name)return t.pos=t.start+1,null;throw new Error("Mode "+e.name+" failed to advance stream.")}function Wt(e,t,n,i){var r,o=function(e){return{start:u.start,end:u.pos,string:u.current(),type:r||null,state:e?It(a.mode,d):d}},a=e.doc,s=a.mode;t=Ce(a,t);var l,c=se(a,t.line),d=jt(e,t.line,n),u=new Dt(c.text,e.options.tabSize);for(i&&(l=[]);(i||u.pos<t.ch)&&!u.eol();)u.start=u.pos,r=Ut(s,u,d),i&&l.push(o(!0));return i?l:o()}function qt(e,t){if(e)for(;;){var n=e.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!n)break;e=e.slice(0,n.index)+e.slice(n.index+n[0].length);var i=n[1]?"bgClass":"textClass";null==t[i]?t[i]=n[2]:new RegExp("(?:^|s)"+n[2]+"(?:$|s)").test(t[i])||(t[i]+=" "+n[2])}return e}function zt(e,t,n,i,r,o,a){var s=n.flattenSpans;null==s&&(s=e.options.flattenSpans);var l,c=0,d=null,u=new Dt(t,e.options.tabSize),p=e.options.addModeClass&&[null];for(""==t&&qt(Ht(n,i),o);!u.eol();){if(u.pos>e.options.maxHighlightLength?(s=!1,a&&$t(e,t,i,u.pos),u.pos=t.length,l=null):l=qt(Ut(n,u,i,p),o),p){var h=p[0].name;h&&(l="m-"+(l?h+" "+l:h))}if(!s||d!=l){for(;c<u.start;)r(c=Math.min(u.start,c+5e3),d);d=l}u.start=u.pos}for(;c<u.pos;){var f=Math.min(u.pos,c+5e3);r(f,d),c=f}}Dt.prototype.eol=function(){return this.pos>=this.string.length},Dt.prototype.sol=function(){return this.pos==this.lineStart},Dt.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},Dt.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},Dt.prototype.eat=function(e){var t=this.string.charAt(this.pos);if("string"==typeof e?t==e:t&&(e.test?e.test(t):e(t)))return++this.pos,t},Dt.prototype.eatWhile=function(e){for(var t=this.pos;this.eat(e););return this.pos>t},Dt.prototype.eatSpace=function(){for(var e=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>e},Dt.prototype.skipToEnd=function(){this.pos=this.string.length},Dt.prototype.skipTo=function(e){var t=this.string.indexOf(e,this.pos);if(-1<t)return this.pos=t,!0},Dt.prototype.backUp=function(e){this.pos-=e},Dt.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=B(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?B(this.string,this.lineStart,this.tabSize):0)},Dt.prototype.indentation=function(){return B(this.string,null,this.tabSize)-(this.lineStart?B(this.string,this.lineStart,this.tabSize):0)},Dt.prototype.match=function(e,t,n){if("string"!=typeof e){var i=this.string.slice(this.pos).match(e);return i&&0<i.index?null:(i&&!1!==t&&(this.pos+=i[0].length),i)}var r=function(e){return n?e.toLowerCase():e};if(r(this.string.substr(this.pos,e.length))==r(e))return!1!==t&&(this.pos+=e.length),!0},Dt.prototype.current=function(){return this.string.slice(this.start,this.pos)},Dt.prototype.hideFirstChars=function(e,t){this.lineStart+=e;try{return t()}finally{this.lineStart-=e}};var Vt=function(e,t,n){this.text=e,Le(this,t),this.height=n?n(this):1};Vt.prototype.lineNo=function(){return ue(this)},dt(Vt);var Kt={},Yt={};function Jt(e,t){if(!e||/^\s*$/.test(e))return null;var n=t.addModeClass?Yt:Kt;return n[e]||(n[e]=e.replace(/\S+/g,"cm-$&"))}function Qt(e,t){var n=N("span",null,null,b?"padding-right: .1px":null),i={pre:N("pre",[n],"CodeMirror-line"),content:n,col:0,pos:0,cm:e,trailingSpace:!1,splitSpaces:(x||b)&&e.getOption("lineWrapping")};t.measure={};for(var r=0;r<=(t.rest?t.rest.length:0);r++){var o=r?t.rest[r-1]:t.line,a=void 0;i.pos=0,i.addToken=Xt,xt(e.display.measure)&&(a=Ge(o,e.doc.direction))&&(i.addToken=Zt(i.addToken,a)),i.map=[],tn(o,i,Bt(e,o,t!=e.display.externalMeasured&&ue(o))),o.styleClasses&&(o.styleClasses.bgClass&&(i.bgClass=R(o.styleClasses.bgClass,i.bgClass||"")),o.styleClasses.textClass&&(i.textClass=R(o.styleClasses.textClass,i.textClass||""))),0==i.map.length&&i.map.push(0,0,i.content.appendChild(wt(e.display.measure))),0==r?(t.measure.map=i.map,t.measure.cache={}):((t.measure.maps||(t.measure.maps=[])).push(i.map),(t.measure.caches||(t.measure.caches=[])).push({}))}if(b){var s=i.content.lastChild;(/\bcm-tab\b/.test(s.className)||s.querySelector&&s.querySelector(".cm-tab"))&&(i.content.className="cm-tab-wrap-hack")}return at(e,"renderLine",e,t.line,i.pre),i.pre.className&&(i.textClass=R(i.pre.className,i.textClass||"")),i}function Gt(e){var t=M("span","•","cm-invalidchar");return t.title="\\u"+e.charCodeAt(0).toString(16),t.setAttribute("aria-label",t.title),t}function Xt(e,t,n,i,r,o,a){if(t){var s,l=e.splitSpaces?function(e,t){if(1<e.length&&!/  /.test(e))return e;for(var n=t,i="",r=0;r<e.length;r++){var o=e.charAt(r);" "!=o||!n||r!=e.length-1&&32!=e.charCodeAt(r+1)||(o=" "),i+=o,n=" "==o}return i}(t,e.trailingSpace):t,c=e.cm.state.specialChars,d=!1;if(c.test(t)){s=document.createDocumentFragment();for(var u=0;;){c.lastIndex=u;var p=c.exec(t),h=p?p.index-u:t.length-u;if(h){var f=document.createTextNode(l.slice(u,u+h));x&&C<9?s.appendChild(M("span",[f])):s.appendChild(f),e.map.push(e.pos,e.pos+h,f),e.col+=h,e.pos+=h}if(!p)break;u+=h+1;var g=void 0;if("\t"==p[0]){var m=e.cm.options.tabSize,v=m-e.col%m;(g=s.appendChild(M("span",Y(v),"cm-tab"))).setAttribute("role","presentation"),g.setAttribute("cm-text","\t"),e.col+=v}else"\r"==p[0]||"\n"==p[0]?(g=s.appendChild(M("span","\r"==p[0]?"␍":"␤","cm-invalidchar"))).setAttribute("cm-text",p[0]):((g=e.cm.options.specialCharPlaceholder(p[0])).setAttribute("cm-text",p[0]),x&&C<9?s.appendChild(M("span",[g])):s.appendChild(g)),e.col+=1;e.map.push(e.pos,e.pos+1,g),e.pos++}}else e.col+=t.length,s=document.createTextNode(l),e.map.push(e.pos,e.pos+t.length,s),x&&C<9&&(d=!0),e.pos+=t.length;if(e.trailingSpace=32==l.charCodeAt(t.length-1),n||i||r||d||a){var y=n||"";i&&(y+=i),r&&(y+=r);var b=M("span",[s],y,a);return o&&(b.title=o),e.content.appendChild(b)}e.content.appendChild(s)}}function Zt(u,p){return function(e,t,n,i,r,o,a){n=n?n+" cm-force-border":"cm-force-border";for(var s=e.pos,l=s+t.length;;){for(var c=void 0,d=0;d<p.length&&!((c=p[d]).to>s&&c.from<=s);d++);if(c.to>=l)return u(e,t,n,i,r,o,a);u(e,t.slice(0,c.to-s),n,i,null,o,a),i=null,t=t.slice(c.to-s),s=c.to}}}function en(e,t,n,i){var r=!i&&n.widgetNode;r&&e.map.push(e.pos,e.pos+t,r),!i&&e.cm.display.input.needsContentAttribute&&(r||(r=e.content.appendChild(document.createElement("span"))),r.setAttribute("cm-marker",n.id)),r&&(e.cm.display.input.setUneditable(r),e.content.appendChild(r)),e.pos+=t,e.trailingSpace=!1}function tn(e,t,n){var i=e.markedSpans,r=e.text,o=0;if(i)for(var a,s,l,c,d,u,p,h=r.length,f=0,g=1,m="",v=0;;){if(v==f){l=c=d=u=s="",p=null,v=1/0;for(var y=[],b=void 0,w=0;w<i.length;++w){var x=i[w],C=x.marker;"bookmark"==C.type&&x.from==f&&C.widgetNode?y.push(C):x.from<=f&&(null==x.to||x.to>f||C.collapsed&&x.to==f&&x.from==f)?(null!=x.to&&x.to!=f&&v>x.to&&(v=x.to,c=""),C.className&&(l+=" "+C.className),C.css&&(s=(s?s+";":"")+C.css),C.startStyle&&x.from==f&&(d+=" "+C.startStyle),C.endStyle&&x.to==v&&(b||(b=[])).push(C.endStyle,x.to),C.title&&!u&&(u=C.title),C.collapsed&&(!p||Pe(p.marker,C)<0)&&(p=x)):x.from>f&&v>x.from&&(v=x.from)}if(b)for(var k=0;k<b.length;k+=2)b[k+1]==v&&(c+=" "+b[k]);if(!p||p.from==f)for(var S=0;S<y.length;++S)en(t,0,y[S]);if(p&&(p.from||0)==f){if(en(t,(null==p.to?h+1:p.to)-f,p.marker,null==p.from),null==p.to)return;p.to==f&&(p=!1)}}if(h<=f)break;for(var T=Math.min(h,v);;){if(m){var F=f+m.length;if(!p){var E=T<F?m.slice(0,T-f):m;t.addToken(t,E,a?a+l:l,d,f+E.length==v?c:"",u,s)}if(T<=F){m=m.slice(T-f),f=T;break}f=F,d=""}m=r.slice(o,o=n[g++]),a=Jt(n[g++],t.cm.options)}}else for(var _=1;_<n.length;_+=2)t.addToken(t,r.slice(o,o=n[_]),Jt(n[_+1],t.cm.options))}function nn(e,t,n){this.line=t,this.rest=function(e){for(var t,n;t=Be(e);)e=t.find(1,!0).line,(n||(n=[])).push(e);return n}(t),this.size=this.rest?ue(J(this.rest))-n+1:1,this.node=this.text=null,this.hidden=We(e,t)}function rn(e,t,n){for(var i,r=[],o=t;o<n;o=i){var a=new nn(e.doc,se(e.doc,o),o);i=o+a.size,r.push(a)}return r}var on=null;var an=null;function sn(e,t){var n=rt(e,t);if(n.length){var i,r=Array.prototype.slice.call(arguments,2);on?i=on.delayedCallbacks:an?i=an:(i=an=[],setTimeout(ln,0));for(var o=function(e){i.push(function(){return n[e].apply(null,r)})},a=0;a<n.length;++a)o(a)}}function ln(){var e=an;an=null;for(var t=0;t<e.length;++t)e[t]()}function cn(e,t,n,i){for(var r=0;r<t.changes.length;r++){var o=t.changes[r];"text"==o?pn(e,t):"gutter"==o?fn(e,t,n,i):"class"==o?hn(e,t):"widget"==o&&gn(e,t,i)}t.changes=null}function dn(e){return e.node==e.text&&(e.node=M("div",null,null,"position: relative"),e.text.parentNode&&e.text.parentNode.replaceChild(e.node,e.text),e.node.appendChild(e.text),x&&C<8&&(e.node.style.zIndex=2)),e.node}function un(e,t){var n=e.display.externalMeasured;return n&&n.line==t.line?(e.display.externalMeasured=null,t.measure=n.measure,n.built):Qt(e,t)}function pn(e,t){var n=t.text.className,i=un(e,t);t.text==t.node&&(t.node=i.pre),t.text.parentNode.replaceChild(i.pre,t.text),t.text=i.pre,i.bgClass!=t.bgClass||i.textClass!=t.textClass?(t.bgClass=i.bgClass,t.textClass=i.textClass,hn(e,t)):n&&(t.text.className=n)}function hn(e,t){!function(e,t){var n=t.bgClass?t.bgClass+" "+(t.line.bgClass||""):t.line.bgClass;if(n&&(n+=" CodeMirror-linebackground"),t.background)n?t.background.className=n:(t.background.parentNode.removeChild(t.background),t.background=null);else if(n){var i=dn(t);t.background=i.insertBefore(M("div",null,n),i.firstChild),e.display.input.setUneditable(t.background)}}(e,t),t.line.wrapClass?dn(t).className=t.line.wrapClass:t.node!=t.text&&(t.node.className="");var n=t.textClass?t.textClass+" "+(t.line.textClass||""):t.line.textClass;t.text.className=n||""}function fn(e,t,n,i){if(t.gutter&&(t.node.removeChild(t.gutter),t.gutter=null),t.gutterBackground&&(t.node.removeChild(t.gutterBackground),t.gutterBackground=null),t.line.gutterClass){var r=dn(t);t.gutterBackground=M("div",null,"CodeMirror-gutter-background "+t.line.gutterClass,"left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px; width: "+i.gutterTotalWidth+"px"),e.display.input.setUneditable(t.gutterBackground),r.insertBefore(t.gutterBackground,t.text)}var o=t.line.gutterMarkers;if(e.options.lineNumbers||o){var a=0===n||n===e.lineCount()-1||(n+1)%10==0?" CodeMirror-linenumber-show":"",s=dn(t),l=t.gutter=M("div",null,"CodeMirror-gutter-wrapper","left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px");if(e.display.input.setUneditable(l),s.insertBefore(l,t.text),t.line.gutterClass&&(l.className+=" "+t.line.gutterClass),!e.options.lineNumbers||o&&o["CodeMirror-linenumbers"]||(t.lineNumber=l.appendChild(M("div",fe(e.options,n),"CodeMirror-linenumber CodeMirror-gutter-elt"+a,"left: "+i.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+e.display.lineNumInnerWidth+"px"))),o)for(var c=0;c<e.options.gutters.length;++c){var d=e.options.gutters[c],u=o.hasOwnProperty(d)&&o[d];u&&l.appendChild(M("div",[u],"CodeMirror-gutter-elt","left: "+i.gutterLeft[d]+"px; width: "+i.gutterWidth[d]+"px"))}}}function gn(e,t,n){t.alignable&&(t.alignable=null);for(var i=t.node.firstChild,r=void 0;i;i=r)r=i.nextSibling,"CodeMirror-linewidget"==i.className&&t.node.removeChild(i);mn(e,t,n)}function mn(e,t,n){if(vn(e,t.line,t,n,!0),t.rest)for(var i=0;i<t.rest.length;i++)vn(e,t.rest[i],t,n,!1)}function vn(e,t,n,i,r){if(t.widgets)for(var o=dn(n),a=0,s=t.widgets;a<s.length;++a){var l=s[a],c=M("div",[l.node],"CodeMirror-linewidget");l.handleMouseEvents||c.setAttribute("cm-ignore-events","true"),yn(l,c,n,i),e.display.input.setUneditable(c),r&&l.above?o.insertBefore(c,n.gutter||n.text):o.appendChild(c),sn(l,"redraw")}}function yn(e,t,n,i){if(e.noHScroll){(n.alignable||(n.alignable=[])).push(t);var r=i.wrapperWidth;t.style.left=i.fixedPos+"px",e.coverGutter||(r-=i.gutterTotalWidth,t.style.paddingLeft=i.gutterTotalWidth+"px"),t.style.width=r+"px"}e.coverGutter&&(t.style.zIndex=5,t.style.position="relative",e.noHScroll||(t.style.marginLeft=-i.gutterTotalWidth+"px"))}function bn(e){if(null!=e.height)return e.height;var t=e.doc.cm;if(!t)return 0;if(!A(document.body,e.node)){var n="position: relative;";e.coverGutter&&(n+="margin-left: -"+t.display.gutters.offsetWidth+"px;"),e.noHScroll&&(n+="width: "+t.display.wrapper.clientWidth+"px;"),_(t.display.measure,M("div",[e.node],null,n))}return e.height=e.node.parentNode.offsetHeight}function wn(e,t){for(var n=gt(t);n!=e.wrapper;n=n.parentNode)if(!n||1==n.nodeType&&"true"==n.getAttribute("cm-ignore-events")||n.parentNode==e.sizer&&n!=e.mover)return!0}function xn(e){return e.lineSpace.offsetTop}function Cn(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight}function kn(e){if(e.cachedPaddingH)return e.cachedPaddingH;var t=_(e.measure,M("pre","x")),n=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,i={left:parseInt(n.paddingLeft),right:parseInt(n.paddingRight)};return isNaN(i.left)||isNaN(i.right)||(e.cachedPaddingH=i),i}function Sn(e){return H-e.display.nativeBarWidth}function Tn(e){return e.display.scroller.clientWidth-Sn(e)-e.display.barWidth}function Fn(e){return e.display.scroller.clientHeight-Sn(e)-e.display.barHeight}function En(e,t,n){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};for(var i=0;i<e.rest.length;i++)if(e.rest[i]==t)return{map:e.measure.maps[i],cache:e.measure.caches[i]};for(var r=0;r<e.rest.length;r++)if(ue(e.rest[r])>n)return{map:e.measure.maps[r],cache:e.measure.caches[r],before:!0}}function _n(e,t,n,i){return An(e,Nn(e,t),n,i)}function Mn(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[ii(e,t)];var n=e.display.externalMeasured;return n&&t>=n.lineN&&t<n.lineN+n.size?n:void 0}function Nn(e,t){var n=ue(t),i=Mn(e,n);i&&!i.text?i=null:i&&i.changes&&(cn(e,i,n,Xn(e)),e.curOp.forceUpdate=!0),i||(i=function(e,t){var n=ue(t=$e(t)),i=e.display.externalMeasured=new nn(e.doc,t,n);i.lineN=n;var r=i.built=Qt(e,i);return i.text=r.pre,_(e.display.lineMeasure,r.pre),i}(e,t));var r=En(i,t,n);return{line:t,view:i,rect:null,map:r.map,cache:r.cache,before:r.before,hasHeights:!1}}function An(e,t,n,i,r){t.before&&(n=-1);var o,a=n+(i||"");return t.cache.hasOwnProperty(a)?o=t.cache[a]:(t.rect||(t.rect=t.view.text.getBoundingClientRect()),t.hasHeights||(!function(e,t,n){var i=e.options.lineWrapping,r=i&&Tn(e);if(!t.measure.heights||i&&t.measure.width!=r){var o=t.measure.heights=[];if(i){t.measure.width=r;for(var a=t.text.firstChild.getClientRects(),s=0;s<a.length-1;s++){var l=a[s],c=a[s+1];2<Math.abs(l.bottom-c.bottom)&&o.push((l.bottom+c.top)/2-n.top)}}o.push(n.bottom-n.top)}}(e,t.view,t.rect),t.hasHeights=!0),(o=function(e,t,n,i){var r,o=Rn(t.map,n,i),a=o.node,s=o.start,l=o.end,c=o.collapse;if(3==a.nodeType){for(var d=0;d<4;d++){for(;s&&re(t.line.text.charAt(o.coverStart+s));)--s;for(;o.coverStart+l<o.coverEnd&&re(t.line.text.charAt(o.coverStart+l));)++l;if((r=x&&C<9&&0==s&&l==o.coverEnd-o.coverStart?a.parentNode.getBoundingClientRect():Pn(T(a,s,l).getClientRects(),i)).left||r.right||0==s)break;l=s,s-=1,c="right"}x&&C<11&&(r=function(e,t){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!function(e){if(null!=Ft)return Ft;var t=_(e,M("span","x")),n=t.getBoundingClientRect(),i=T(t,0,1).getBoundingClientRect();return Ft=1<Math.abs(n.left-i.left)}(e))return t;var n=screen.logicalXDPI/screen.deviceXDPI,i=screen.logicalYDPI/screen.deviceYDPI;return{left:t.left*n,right:t.right*n,top:t.top*i,bottom:t.bottom*i}}(e.display.measure,r))}else{var u;0<s&&(c=i="right"),r=e.options.lineWrapping&&1<(u=a.getClientRects()).length?u["right"==i?u.length-1:0]:a.getBoundingClientRect()}if(x&&C<9&&!s&&(!r||!r.left&&!r.right)){var p=a.parentNode.getClientRects()[0];r=p?{left:p.left,right:p.left+Gn(e.display),top:p.top,bottom:p.bottom}:In}for(var h=r.top-t.rect.top,f=r.bottom-t.rect.top,g=(h+f)/2,m=t.view.measure.heights,v=0;v<m.length-1&&!(g<m[v]);v++);var y=v?m[v-1]:0,b=m[v],w={left:("right"==c?r.right:r.left)-t.rect.left,right:("left"==c?r.left:r.right)-t.rect.left,top:y,bottom:b};r.left||r.right||(w.bogus=!0);e.options.singleCursorHeightPerLine||(w.rtop=h,w.rbottom=f);return w}(e,t,n,i)).bogus||(t.cache[a]=o)),{left:o.left,right:o.right,top:r?o.rtop:o.top,bottom:r?o.rbottom:o.bottom}}var Ln,In={left:0,right:0,top:0,bottom:0};function Rn(e,t,n){for(var i,r,o,a,s,l,c=0;c<e.length;c+=3)if(s=e[c],l=e[c+1],t<s?(r=0,o=1,a="left"):t<l?o=(r=t-s)+1:(c==e.length-3||t==l&&e[c+3]>t)&&(r=(o=l-s)-1,l<=t&&(a="right")),null!=r){if(i=e[c+2],s==l&&n==(i.insertLeft?"left":"right")&&(a=n),"left"==n&&0==r)for(;c&&e[c-2]==e[c-3]&&e[c-1].insertLeft;)i=e[2+(c-=3)],a="left";if("right"==n&&r==l-s)for(;c<e.length-3&&e[c+3]==e[c+4]&&!e[c+5].insertLeft;)i=e[(c+=3)+2],a="right";break}return{node:i,start:r,end:o,collapse:a,coverStart:s,coverEnd:l}}function Pn(e,t){var n=In;if("left"==t)for(var i=0;i<e.length&&(n=e[i]).left==n.right;i++);else for(var r=e.length-1;0<=r&&(n=e[r]).left==n.right;r--);return n}function Dn(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(var t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function On(e){e.display.externalMeasure=null,E(e.display.lineMeasure);for(var t=0;t<e.display.view.length;t++)Dn(e.display.view[t])}function Bn(e){On(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null}function jn(){return a&&u?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function $n(){return a&&u?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function Hn(e,t,n,i,r){if(!r&&t.widgets)for(var o=0;o<t.widgets.length;++o)if(t.widgets[o].above){var a=bn(t.widgets[o]);n.top+=a,n.bottom+=a}if("line"==i)return n;i||(i="local");var s=ze(t);if("local"==i?s+=xn(e.display):s-=e.display.viewOffset,"page"==i||"window"==i){var l=e.display.lineSpace.getBoundingClientRect();s+=l.top+("window"==i?0:$n());var c=l.left+("window"==i?0:jn());n.left+=c,n.right+=c}return n.top+=s,n.bottom+=s,n}function Un(e,t,n){if("div"==n)return t;var i=t.left,r=t.top;if("page"==n)i-=jn(),r-=$n();else if("local"==n||!n){var o=e.display.sizer.getBoundingClientRect();i+=o.left,r+=o.top}var a=e.display.lineSpace.getBoundingClientRect();return{left:i-a.left,top:r-a.top}}function Wn(e,t,n,i,r){return i||(i=se(e.doc,t.line)),Hn(e,i,_n(e,i,t.ch,r),n)}function qn(i,e,r,o,a,s){function l(e,t){var n=An(i,a,e,t?"right":"left",s);return t?n.left=n.right:n.right=n.left,Hn(i,o,n,r)}o=o||se(i.doc,e.line),a||(a=Nn(i,o));var c=Ge(o,i.doc.direction),t=e.ch,n=e.sticky;if(t>=o.text.length?(t=o.text.length,n="before"):t<=0&&(t=0,n="after"),!c)return l("before"==n?t-1:t,"before"==n);function d(e,t,n){return l(n?e-1:e,c[t].level%2!=0!=n)}var u=Je(c,t,n),p=Ye,h=d(t,u,"before"==n);return null!=p&&(h.other=d(t,p,"before"!=n)),h}function zn(e,t){var n=0;t=Ce(e.doc,t),e.options.lineWrapping||(n=Gn(e.display)*t.ch);var i=se(e.doc,t.line),r=ze(i)+xn(e.display);return{left:n,right:n,top:r,bottom:r+i.height}}function Vn(e,t,n,i,r){var o=ge(e,t,n);return o.xRel=r,i&&(o.outside=!0),o}function Kn(e,t,n){var i=e.doc;if((n+=e.display.viewOffset)<0)return Vn(i.first,0,null,!0,-1);var r=pe(i,n),o=i.first+i.size-1;if(o<r)return Vn(i.first+i.size-1,se(i,o).text.length,null,!0,1);t<0&&(t=0);for(var a=se(i,r);;){var s=Jn(e,a,r,t,n),l=Be(a),c=l&&l.find(0,!0);if(!l||!(s.ch>c.from.ch||s.ch==c.from.ch&&0<s.xRel))return s;r=ue(a=c.to.line)}}function Yn(t,n,i,r){var o=function(e){return Hn(t,n,An(t,i,e),"line")},e=n.text.length,a=ae(function(e){return o(e-1).bottom<=r},e,0);return{begin:a,end:e=ae(function(e){return o(e).top>r},a,e)}}function Jn(n,i,e,r,o){o-=ze(i);var t,a=0,s=i.text.length,l=Nn(n,i);if(Ge(i,n.doc.direction)){var c;if(n.options.lineWrapping)a=(c=Yn(n,i,l,o)).begin,s=c.end;t=new ge(e,a);var d,u,p=qn(n,t,"line",i,l).left,h=p<r?1:-1,f=p-r;do{if(d=f,null==(t=tt(n,i,u=t,h))||t.ch<a||s<=("before"==t.sticky?t.ch-1:t.ch)){t=u;break}f=qn(n,t,"line",i,l).left-r}while(h<0!=f<0&&Math.abs(f)<=Math.abs(d));if(Math.abs(f)>Math.abs(d)){if(f<0==d<0)throw new Error("Broke out of infinite loop in coordsCharInner");t=u}}else{var g=ae(function(e){var t=Hn(n,i,An(n,l,e),"line");return t.top>o?(s=Math.min(e,s),!0):!(t.bottom<=o)&&(t.left>r||!(t.right<r)&&r-t.left<t.right-r)},a,s);t=new ge(e,g=oe(i.text,g,1),g==s?"before":"after")}var m=qn(n,t,"line",i,l);return(o<m.top||m.bottom<o)&&(t.outside=!0),t.xRel=r<m.left?-1:r>m.right?1:0,t}function Qn(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==Ln){Ln=M("pre");for(var t=0;t<49;++t)Ln.appendChild(document.createTextNode("x")),Ln.appendChild(M("br"));Ln.appendChild(document.createTextNode("x"))}_(e.measure,Ln);var n=Ln.offsetHeight/50;return 3<n&&(e.cachedTextHeight=n),E(e.measure),n||1}function Gn(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;var t=M("span","xxxxxxxxxx"),n=M("pre",[t]);_(e.measure,n);var i=t.getBoundingClientRect(),r=(i.right-i.left)/10;return 2<r&&(e.cachedCharWidth=r),r||10}function Xn(e){for(var t=e.display,n={},i={},r=t.gutters.clientLeft,o=t.gutters.firstChild,a=0;o;o=o.nextSibling,++a)n[e.options.gutters[a]]=o.offsetLeft+o.clientLeft+r,i[e.options.gutters[a]]=o.clientWidth;return{fixedPos:Zn(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:n,gutterWidth:i,wrapperWidth:t.wrapper.clientWidth}}function Zn(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}function ei(i){var r=Qn(i.display),o=i.options.lineWrapping,a=o&&Math.max(5,i.display.scroller.clientWidth/Gn(i.display)-3);return function(e){if(We(i.doc,e))return 0;var t=0;if(e.widgets)for(var n=0;n<e.widgets.length;n++)e.widgets[n].height&&(t+=e.widgets[n].height);return o?t+(Math.ceil(e.text.length/a)||1)*r:t+r}}function ti(e){var t=e.doc,n=ei(e);t.iter(function(e){var t=n(e);t!=e.height&&de(e,t)})}function ni(e,t,n,i){var r=e.display;if(!n&&"true"==gt(t).getAttribute("cm-not-content"))return null;var o,a,s=r.lineSpace.getBoundingClientRect();try{o=t.clientX-s.left,a=t.clientY-s.top}catch(t){return null}var l,c=Kn(e,o,a);if(i&&1==c.xRel&&(l=se(e.doc,c.line).text).length==c.ch){var d=B(l,l.length,e.options.tabSize)-l.length;c=ge(c.line,Math.max(0,Math.round((o-kn(e.display).left)/Gn(e.display))-d))}return c}function ii(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;for(var n=e.display.view,i=0;i<n.length;i++)if((t-=n[i].size)<0)return i}function ri(e){e.display.input.showSelection(e.display.input.prepareSelection())}function oi(e,t){for(var n=e.doc,i={},r=i.cursors=document.createDocumentFragment(),o=i.selection=document.createDocumentFragment(),a=0;a<n.sel.ranges.length;a++)if(!1!==t||a!=n.sel.primIndex){var s=n.sel.ranges[a];if(!(s.from().line>=e.display.viewTo||s.to().line<e.display.viewFrom)){var l=s.empty();(l||e.options.showCursorWhenSelecting)&&ai(e,s.head,r),l||si(e,s,o)}}return i}function ai(e,t,n){var i=qn(e,t,"div",null,null,!e.options.singleCursorHeightPerLine),r=n.appendChild(M("div"," ","CodeMirror-cursor"));if(r.style.left=i.left+"px",r.style.top=i.top+"px",r.style.height=Math.max(0,i.bottom-i.top)*e.options.cursorHeight+"px",i.other){var o=n.appendChild(M("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));o.style.display="",o.style.left=i.other.left+"px",o.style.top=i.other.top+"px",o.style.height=.85*(i.other.bottom-i.other.top)+"px"}}function si(r,e,t){var n=r.display,o=r.doc,a=document.createDocumentFragment(),i=kn(r.display),f=i.left,g=Math.max(n.sizerWidth,Tn(r)-n.sizer.offsetLeft)-i.right;function m(e,t,n,i){t<0&&(t=0),t=Math.round(t),i=Math.round(i),a.appendChild(M("div",null,"CodeMirror-selected","position: absolute; left: "+e+"px;\n                             top: "+t+"px; width: "+(null==n?g-e:n)+"px;\n                             height: "+(i-t)+"px"))}function s(n,l,c){var d,u,i=se(o,n),p=i.text.length;function h(e,t){return Wn(r,ge(n,e),"div",i,t)}return function(e,t,n,i){if(!e)return i(t,n,"ltr");for(var r=!1,o=0;o<e.length;++o){var a=e[o];(a.from<n&&a.to>t||t==n&&a.to==t)&&(i(Math.max(a.from,t),Math.min(a.to,n),1==a.level?"rtl":"ltr"),r=!0)}r||i(t,n,"ltr")}(Ge(i,o.direction),l||0,null==c?p:c,function(e,t,n){var i,r,o,a=h(e,"left");if(e==t)r=o=(i=a).left;else{if(i=h(t-1,"right"),"rtl"==n){var s=a;a=i,i=s}r=a.left,o=i.right}null==l&&0==e&&(r=f),3<i.top-a.top&&(m(r,a.top,null,a.bottom),r=f,a.bottom<i.top&&m(r,a.bottom,null,i.top)),null==c&&t==p&&(o=g),(!d||a.top<d.top||a.top==d.top&&a.left<d.left)&&(d=a),(!u||i.bottom>u.bottom||i.bottom==u.bottom&&i.right>u.right)&&(u=i),r<f+1&&(r=f),m(r,i.top,o-r,i.bottom)}),{start:d,end:u}}var l=e.from(),c=e.to();if(l.line==c.line)s(l.line,l.ch,c.ch);else{var d=se(o,l.line),u=se(o,c.line),p=$e(d)==$e(u),h=s(l.line,l.ch,p?d.text.length+1:null).end,v=s(c.line,p?0:null,c.ch).start;p&&(h.top<v.top-2?(m(h.right,h.top,null,h.bottom),m(f,v.top,v.left,v.bottom)):m(h.right,h.top,v.left-h.right,h.bottom)),h.bottom<v.top&&m(f,h.bottom,null,v.top)}t.appendChild(a)}function li(e){if(e.state.focused){var t=e.display;clearInterval(t.blinker);var n=!0;t.cursorDiv.style.visibility="",0<e.options.cursorBlinkRate?t.blinker=setInterval(function(){return t.cursorDiv.style.visibility=(n=!n)?"":"hidden"},e.options.cursorBlinkRate):e.options.cursorBlinkRate<0&&(t.cursorDiv.style.visibility="hidden")}}function ci(e){e.state.focused||(e.display.input.focus(),ui(e))}function di(e){e.state.delayingBlurEvent=!0,setTimeout(function(){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1,pi(e))},100)}function ui(e,t){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1),"nocursor"!=e.options.readOnly&&(e.state.focused||(at(e,"focus",e,t),e.state.focused=!0,I(e.display.wrapper,"CodeMirror-focused"),e.curOp||e.display.selForContextMenu==e.doc.sel||(e.display.input.reset(),b&&setTimeout(function(){return e.display.input.reset(!0)},20)),e.display.input.receivedFocus()),li(e))}function pi(e,t){e.state.delayingBlurEvent||(e.state.focused&&(at(e,"blur",e,t),e.state.focused=!1,F(e.display.wrapper,"CodeMirror-focused")),clearInterval(e.display.blinker),setTimeout(function(){e.state.focused||(e.display.shift=!1)},150))}function hi(e){for(var t=e.display,n=t.lineDiv.offsetTop,i=0;i<t.view.length;i++){var r=t.view[i],o=void 0;if(!r.hidden){if(x&&C<8){var a=r.node.offsetTop+r.node.offsetHeight;o=a-n,n=a}else{var s=r.node.getBoundingClientRect();o=s.bottom-s.top}var l=r.line.height-o;if(o<2&&(o=Qn(t)),(.001<l||l<-.001)&&(de(r.line,o),fi(r.line),r.rest))for(var c=0;c<r.rest.length;c++)fi(r.rest[c])}}}function fi(e){if(e.widgets)for(var t=0;t<e.widgets.length;++t)e.widgets[t].height=e.widgets[t].node.parentNode.offsetHeight}function gi(e,t,n){var i=n&&null!=n.top?Math.max(0,n.top):e.scroller.scrollTop;i=Math.floor(i-xn(e));var r=n&&null!=n.bottom?n.bottom:i+e.wrapper.clientHeight,o=pe(t,i),a=pe(t,r);if(n&&n.ensure){var s=n.ensure.from.line,l=n.ensure.to.line;s<o?a=pe(t,ze(se(t,o=s))+e.wrapper.clientHeight):Math.min(l,t.lastLine())>=a&&(o=pe(t,ze(se(t,l))-e.wrapper.clientHeight),a=l)}return{from:o,to:Math.max(a,o+1)}}function mi(e){var t=e.display,n=t.view;if(t.alignWidgets||t.gutters.firstChild&&e.options.fixedGutter){for(var i=Zn(t)-t.scroller.scrollLeft+e.doc.scrollLeft,r=t.gutters.offsetWidth,o=i+"px",a=0;a<n.length;a++)if(!n[a].hidden){e.options.fixedGutter&&(n[a].gutter&&(n[a].gutter.style.left=o),n[a].gutterBackground&&(n[a].gutterBackground.style.left=o));var s=n[a].alignable;if(s)for(var l=0;l<s.length;l++)s[l].style.left=o}e.options.fixedGutter&&(t.gutters.style.left=i+r+"px")}}function vi(e){if(!e.options.lineNumbers)return!1;var t=e.doc,n=fe(e.options,t.first+t.size-1),i=e.display;if(n.length!=i.lineNumChars){var r=i.measure.appendChild(M("div",[M("div",n)],"CodeMirror-linenumber CodeMirror-gutter-elt")),o=r.firstChild.offsetWidth,a=r.offsetWidth-o;return i.lineGutter.style.width="",i.lineNumInnerWidth=Math.max(o,i.lineGutter.offsetWidth-a)+a+2,i.lineNumWidth=i.lineNumInnerWidth+a,i.lineNumChars=i.lineNumInnerWidth?n.length:-1,i.lineGutter.style.width=i.lineNumWidth+"px",nr(e),!0}return!1}function yi(e,t){var n=e.display,i=Qn(e.display);t.top<0&&(t.top=0);var r=e.curOp&&null!=e.curOp.scrollTop?e.curOp.scrollTop:n.scroller.scrollTop,o=Fn(e),a={};t.bottom-t.top>o&&(t.bottom=t.top+o);var s=e.doc.height+Cn(n),l=t.top<i,c=t.bottom>s-i;if(t.top<r)a.scrollTop=l?0:t.top;else if(t.bottom>r+o){var d=Math.min(t.top,(c?s:t.bottom)-o);d!=r&&(a.scrollTop=d)}var u=e.curOp&&null!=e.curOp.scrollLeft?e.curOp.scrollLeft:n.scroller.scrollLeft,p=Tn(e)-(e.options.fixedGutter?n.gutters.offsetWidth:0),h=t.right-t.left>p;return h&&(t.right=t.left+p),t.left<10?a.scrollLeft=0:t.left<u?a.scrollLeft=Math.max(0,t.left-(h?0:10)):t.right>p+u-3&&(a.scrollLeft=t.right+(h?0:10)-p),a}function bi(e,t){null!=t&&(Ci(e),e.curOp.scrollTop=(null==e.curOp.scrollTop?e.doc.scrollTop:e.curOp.scrollTop)+t)}function wi(e){Ci(e);var t=e.getCursor(),n=t,i=t;e.options.lineWrapping||(n=t.ch?ge(t.line,t.ch-1):t,i=ge(t.line,t.ch+1)),e.curOp.scrollToPos={from:n,to:i,margin:e.options.cursorScrollMargin}}function xi(e,t,n){null==t&&null==n||Ci(e),null!=t&&(e.curOp.scrollLeft=t),null!=n&&(e.curOp.scrollTop=n)}function Ci(e){var t=e.curOp.scrollToPos;t&&(e.curOp.scrollToPos=null,ki(e,zn(e,t.from),zn(e,t.to),t.margin))}function ki(e,t,n,i){var r=yi(e,{left:Math.min(t.left,n.left),top:Math.min(t.top,n.top)-i,right:Math.max(t.right,n.right),bottom:Math.max(t.bottom,n.bottom)+i});xi(e,r.scrollLeft,r.scrollTop)}function Si(e,t){Math.abs(e.doc.scrollTop-t)<2||(g||tr(e,{top:t}),Ti(e,t,!0),g&&tr(e),Qi(e,100))}function Ti(e,t,n){t=Math.min(e.display.scroller.scrollHeight-e.display.scroller.clientHeight,t),(e.display.scroller.scrollTop!=t||n)&&(e.doc.scrollTop=t,e.display.scrollbars.setScrollTop(t),e.display.scroller.scrollTop!=t&&(e.display.scroller.scrollTop=t))}function Fi(e,t,n,i){t=Math.min(t,e.display.scroller.scrollWidth-e.display.scroller.clientWidth),(n?t==e.doc.scrollLeft:Math.abs(e.doc.scrollLeft-t)<2)&&!i||(e.doc.scrollLeft=t,mi(e),e.display.scroller.scrollLeft!=t&&(e.display.scroller.scrollLeft=t),e.display.scrollbars.setScrollLeft(t))}function Ei(e){var t=e.display,n=t.gutters.offsetWidth,i=Math.round(e.doc.height+Cn(e.display));return{clientHeight:t.scroller.clientHeight,viewHeight:t.wrapper.clientHeight,scrollWidth:t.scroller.scrollWidth,clientWidth:t.scroller.clientWidth,viewWidth:t.wrapper.clientWidth,barLeft:e.options.fixedGutter?n:0,docHeight:i,scrollHeight:i+Sn(e)+t.barHeight,nativeBarWidth:t.nativeBarWidth,gutterWidth:n}}da.posFromMouse=ni;var _i=function(e,t,n){this.cm=n;var i=this.vert=M("div",[M("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),r=this.horiz=M("div",[M("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");e(i),e(r),it(i,"scroll",function(){i.clientHeight&&t(i.scrollTop,"vertical")}),it(r,"scroll",function(){r.clientWidth&&t(r.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,x&&C<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};_i.prototype.update=function(e){var t=e.scrollWidth>e.clientWidth+1,n=e.scrollHeight>e.clientHeight+1,i=e.nativeBarWidth;if(n){this.vert.style.display="block",this.vert.style.bottom=t?i+"px":"0";var r=e.viewHeight-(t?i:0);this.vert.firstChild.style.height=Math.max(0,e.scrollHeight-e.clientHeight+r)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(t){this.horiz.style.display="block",this.horiz.style.right=n?i+"px":"0",this.horiz.style.left=e.barLeft+"px";var o=e.viewWidth-e.barLeft-(n?i:0);this.horiz.firstChild.style.width=Math.max(0,e.scrollWidth-e.clientWidth+o)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&0<e.clientHeight&&(0==i&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:n?i:0,bottom:t?i:0}},_i.prototype.setScrollLeft=function(e){this.horiz.scrollLeft!=e&&(this.horiz.scrollLeft=e),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},_i.prototype.setScrollTop=function(e){this.vert.scrollTop!=e&&(this.vert.scrollTop=e),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},_i.prototype.zeroWidthHack=function(){var e=w&&!s?"12px":"18px";this.horiz.style.height=this.vert.style.width=e,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new j,this.disableVert=new j},_i.prototype.enableZeroWidthBar=function(n,i,r){n.style.pointerEvents="auto",i.set(1e3,function e(){var t=n.getBoundingClientRect();("vert"==r?document.elementFromPoint(t.right-1,(t.top+t.bottom)/2):document.elementFromPoint((t.right+t.left)/2,t.bottom-1))!=n?n.style.pointerEvents="none":i.set(1e3,e)})},_i.prototype.clear=function(){var e=this.horiz.parentNode;e.removeChild(this.horiz),e.removeChild(this.vert)};var Mi=function(){};function Ni(e,t){t||(t=Ei(e));var n=e.display.barWidth,i=e.display.barHeight;Ai(e,t);for(var r=0;r<4&&n!=e.display.barWidth||i!=e.display.barHeight;r++)n!=e.display.barWidth&&e.options.lineWrapping&&hi(e),Ai(e,Ei(e)),n=e.display.barWidth,i=e.display.barHeight}function Ai(e,t){var n=e.display,i=n.scrollbars.update(t);n.sizer.style.paddingRight=(n.barWidth=i.right)+"px",n.sizer.style.paddingBottom=(n.barHeight=i.bottom)+"px",n.heightForcer.style.borderBottom=i.bottom+"px solid transparent",i.right&&i.bottom?(n.scrollbarFiller.style.display="block",n.scrollbarFiller.style.height=i.bottom+"px",n.scrollbarFiller.style.width=i.right+"px"):n.scrollbarFiller.style.display="",i.bottom&&e.options.coverGutterNextToScrollbar&&e.options.fixedGutter?(n.gutterFiller.style.display="block",n.gutterFiller.style.height=i.bottom+"px",n.gutterFiller.style.width=t.gutterWidth+"px"):n.gutterFiller.style.display=""}Mi.prototype.update=function(){return{bottom:0,right:0}},Mi.prototype.setScrollLeft=function(){},Mi.prototype.setScrollTop=function(){},Mi.prototype.clear=function(){};var Li={native:_i,null:Mi};function Ii(n){n.display.scrollbars&&(n.display.scrollbars.clear(),n.display.scrollbars.addClass&&F(n.display.wrapper,n.display.scrollbars.addClass)),n.display.scrollbars=new Li[n.options.scrollbarStyle](function(e){n.display.wrapper.insertBefore(e,n.display.scrollbarFiller),it(e,"mousedown",function(){n.state.focused&&setTimeout(function(){return n.display.input.focus()},0)}),e.setAttribute("cm-not-content","true")},function(e,t){"horizontal"==t?Fi(n,e):Si(n,e)},n),n.display.scrollbars.addClass&&I(n.display.wrapper,n.display.scrollbars.addClass)}var Ri=0;function Pi(e){var t;e.curOp={cm:e,viewChanged:!1,startHeight:e.doc.height,forceUpdate:!1,updateInput:null,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++Ri},t=e.curOp,on?on.ops.push(t):t.ownsGroup=on={ops:[t],delayedCallbacks:[]}}function Di(e){!function(e,t){var n=e.ownsGroup;if(n)try{!function(e){var t=e.delayedCallbacks,n=0;do{for(;n<t.length;n++)t[n].call(null);for(var i=0;i<e.ops.length;i++){var r=e.ops[i];if(r.cursorActivityHandlers)for(;r.cursorActivityCalled<r.cursorActivityHandlers.length;)r.cursorActivityHandlers[r.cursorActivityCalled++].call(null,r.cm)}}while(n<t.length)}(n)}finally{on=null,t(n)}}(e.curOp,function(e){for(var t=0;t<e.ops.length;t++)e.ops[t].cm.curOp=null;!function(e){for(var t=e.ops,n=0;n<t.length;n++)Oi(t[n]);for(var i=0;i<t.length;i++)(r=t[i]).updatedDisplay=r.mustUpdate&&Zi(r.cm,r.update);var r;for(var o=0;o<t.length;o++)Bi(t[o]);for(var a=0;a<t.length;a++)ji(t[a]);for(var s=0;s<t.length;s++)$i(t[s])}(e)})}function Oi(e){var t,n,i=e.cm,r=i.display;!(n=(t=i).display).scrollbarsClipped&&n.scroller.offsetWidth&&(n.nativeBarWidth=n.scroller.offsetWidth-n.scroller.clientWidth,n.heightForcer.style.height=Sn(t)+"px",n.sizer.style.marginBottom=-n.nativeBarWidth+"px",n.sizer.style.borderRightWidth=Sn(t)+"px",n.scrollbarsClipped=!0),e.updateMaxLine&&Ke(i),e.mustUpdate=e.viewChanged||e.forceUpdate||null!=e.scrollTop||e.scrollToPos&&(e.scrollToPos.from.line<r.viewFrom||e.scrollToPos.to.line>=r.viewTo)||r.maxLineChanged&&i.options.lineWrapping,e.update=e.mustUpdate&&new Xi(i,e.mustUpdate&&{top:e.scrollTop,ensure:e.scrollToPos},e.forceUpdate)}function Bi(e){var t=e.cm,n=t.display;e.updatedDisplay&&hi(t),e.barMeasure=Ei(t),n.maxLineChanged&&!t.options.lineWrapping&&(e.adjustWidthTo=_n(t,n.maxLine,n.maxLine.text.length).left+3,t.display.sizerWidth=e.adjustWidthTo,e.barMeasure.scrollWidth=Math.max(n.scroller.clientWidth,n.sizer.offsetLeft+e.adjustWidthTo+Sn(t)+t.display.barWidth),e.maxScrollLeft=Math.max(0,n.sizer.offsetLeft+e.adjustWidthTo-Tn(t))),(e.updatedDisplay||e.selectionChanged)&&(e.preparedSelection=n.input.prepareSelection(e.focus))}function ji(e){var t=e.cm;null!=e.adjustWidthTo&&(t.display.sizer.style.minWidth=e.adjustWidthTo+"px",e.maxScrollLeft<t.doc.scrollLeft&&Fi(t,Math.min(t.display.scroller.scrollLeft,e.maxScrollLeft),!0),t.display.maxLineChanged=!1);var n=e.focus&&e.focus==L()&&(!document.hasFocus||document.hasFocus());e.preparedSelection&&t.display.input.showSelection(e.preparedSelection,n),(e.updatedDisplay||e.startHeight!=t.doc.height)&&Ni(t,e.barMeasure),e.updatedDisplay&&ir(t,e.barMeasure),e.selectionChanged&&li(t),t.state.focused&&e.updateInput&&t.display.input.reset(e.typing),n&&ci(e.cm)}function $i(e){var t=e.cm,n=t.display,i=t.doc;(e.updatedDisplay&&er(t,e.update),null==n.wheelStartX||null==e.scrollTop&&null==e.scrollLeft&&!e.scrollToPos||(n.wheelStartX=n.wheelStartY=null),null!=e.scrollTop&&Ti(t,e.scrollTop,e.forceScroll),null!=e.scrollLeft&&Fi(t,e.scrollLeft,!0,!0),e.scrollToPos)&&function(e,t){if(!st(e,"scrollCursorIntoView")){var n=e.display,i=n.sizer.getBoundingClientRect(),r=null;if(t.top+i.top<0?r=!0:t.bottom+i.top>(window.innerHeight||document.documentElement.clientHeight)&&(r=!1),null!=r&&!l){var o=M("div","​",null,"position: absolute;\n                         top: "+(t.top-n.viewOffset-xn(e.display))+"px;\n                         height: "+(t.bottom-t.top+Sn(e)+n.barHeight)+"px;\n                         left: "+t.left+"px; width: "+Math.max(2,t.right-t.left)+"px;");e.display.lineSpace.appendChild(o),o.scrollIntoView(r),e.display.lineSpace.removeChild(o)}}}(t,function(e,t,n,i){var r;null==i&&(i=0);for(var o=0;o<5;o++){var a=!1,s=qn(e,t),l=n&&n!=t?qn(e,n):s,c=yi(e,r={left:Math.min(s.left,l.left),top:Math.min(s.top,l.top)-i,right:Math.max(s.left,l.left),bottom:Math.max(s.bottom,l.bottom)+i}),d=e.doc.scrollTop,u=e.doc.scrollLeft;if(null!=c.scrollTop&&(Si(e,c.scrollTop),1<Math.abs(e.doc.scrollTop-d)&&(a=!0)),null!=c.scrollLeft&&(Fi(e,c.scrollLeft),1<Math.abs(e.doc.scrollLeft-u)&&(a=!0)),!a)break}return r}(t,Ce(i,e.scrollToPos.from),Ce(i,e.scrollToPos.to),e.scrollToPos.margin));var r=e.maybeHiddenMarkers,o=e.maybeUnhiddenMarkers;if(r)for(var a=0;a<r.length;++a)r[a].lines.length||at(r[a],"hide");if(o)for(var s=0;s<o.length;++s)o[s].lines.length&&at(o[s],"unhide");n.wrapper.offsetHeight&&(i.scrollTop=t.display.scroller.scrollTop),e.changeObjs&&at(t,"changes",t,e.changeObjs),e.update&&e.update.finish()}function Hi(e,t){if(e.curOp)return t();Pi(e);try{return t()}finally{Di(e)}}function Ui(e,t){return function(){if(e.curOp)return t.apply(e,arguments);Pi(e);try{return t.apply(e,arguments)}finally{Di(e)}}}function Wi(e){return function(){if(this.curOp)return e.apply(this,arguments);Pi(this);try{return e.apply(this,arguments)}finally{Di(this)}}}function qi(t){return function(){var e=this.cm;if(!e||e.curOp)return t.apply(this,arguments);Pi(e);try{return t.apply(this,arguments)}finally{Di(e)}}}function zi(e,t,n,i){null==t&&(t=e.doc.first),null==n&&(n=e.doc.first+e.doc.size),i||(i=0);var r=e.display;if(i&&n<r.viewTo&&(null==r.updateLineNumbers||r.updateLineNumbers>t)&&(r.updateLineNumbers=t),e.curOp.viewChanged=!0,t>=r.viewTo)Te&&He(e.doc,t)<r.viewTo&&Ki(e);else if(n<=r.viewFrom)Te&&Ue(e.doc,n+i)>r.viewFrom?Ki(e):(r.viewFrom+=i,r.viewTo+=i);else if(t<=r.viewFrom&&n>=r.viewTo)Ki(e);else if(t<=r.viewFrom){var o=Yi(e,n,n+i,1);o?(r.view=r.view.slice(o.index),r.viewFrom=o.lineN,r.viewTo+=i):Ki(e)}else if(n>=r.viewTo){var a=Yi(e,t,t,-1);a?(r.view=r.view.slice(0,a.index),r.viewTo=a.lineN):Ki(e)}else{var s=Yi(e,t,t,-1),l=Yi(e,n,n+i,1);s&&l?(r.view=r.view.slice(0,s.index).concat(rn(e,s.lineN,l.lineN)).concat(r.view.slice(l.index)),r.viewTo+=i):Ki(e)}var c=r.externalMeasured;c&&(n<c.lineN?c.lineN+=i:t<c.lineN+c.size&&(r.externalMeasured=null))}function Vi(e,t,n){e.curOp.viewChanged=!0;var i=e.display,r=e.display.externalMeasured;if(r&&t>=r.lineN&&t<r.lineN+r.size&&(i.externalMeasured=null),!(t<i.viewFrom||t>=i.viewTo)){var o=i.view[ii(e,t)];if(null!=o.node){var a=o.changes||(o.changes=[]);-1==$(a,n)&&a.push(n)}}}function Ki(e){e.display.viewFrom=e.display.viewTo=e.doc.first,e.display.view=[],e.display.viewOffset=0}function Yi(e,t,n,i){var r,o=ii(e,t),a=e.display.view;if(!Te||n==e.doc.first+e.doc.size)return{index:o,lineN:n};for(var s=e.display.viewFrom,l=0;l<o;l++)s+=a[l].size;if(s!=t){if(0<i){if(o==a.length-1)return null;r=s+a[o].size-t,o++}else r=s-t;t+=r,n+=r}for(;He(e.doc,n)!=n;){if(o==(i<0?0:a.length-1))return null;n+=i*a[o-(i<0?1:0)].size,o+=i}return{index:o,lineN:n}}function Ji(e){for(var t=e.display.view,n=0,i=0;i<t.length;i++){var r=t[i];r.hidden||r.node&&!r.changes||++n}return n}function Qi(e,t){e.doc.mode.startState&&e.doc.frontier<e.display.viewTo&&e.state.highlight.set(t,D(Gi,e))}function Gi(l){var c=l.doc;if(c.frontier<c.first&&(c.frontier=c.first),!(c.frontier>=l.display.viewTo)){var d=+new Date+l.options.workTime,u=It(c.mode,jt(l,c.frontier)),p=[];c.iter(c.frontier,Math.min(c.first+c.size,l.display.viewTo+500),function(e){if(c.frontier>=l.display.viewFrom){var t=e.styles,n=e.text.length>l.options.maxHighlightLength,i=Ot(l,e,n?It(c.mode,u):u,!0);e.styles=i.styles;var r=e.styleClasses,o=i.classes;o?e.styleClasses=o:r&&(e.styleClasses=null);for(var a=!t||t.length!=e.styles.length||r!=o&&(!r||!o||r.bgClass!=o.bgClass||r.textClass!=o.textClass),s=0;!a&&s<t.length;++s)a=t[s]!=e.styles[s];a&&p.push(c.frontier),e.stateAfter=n?u:It(c.mode,u)}else e.text.length<=l.options.maxHighlightLength&&$t(l,e.text,u),e.stateAfter=c.frontier%5==0?It(c.mode,u):null;if(++c.frontier,+new Date>d)return Qi(l,l.options.workDelay),!0}),p.length&&Hi(l,function(){for(var e=0;e<p.length;e++)Vi(l,p[e],"text")})}}var Xi=function(e,t,n){var i=e.display;this.viewport=t,this.visible=gi(i,e.doc,t),this.editorIsHidden=!i.wrapper.offsetWidth,this.wrapperHeight=i.wrapper.clientHeight,this.wrapperWidth=i.wrapper.clientWidth,this.oldDisplayWidth=Tn(e),this.force=n,this.dims=Xn(e),this.events=[]};function Zi(e,t){var n=e.display,i=e.doc;if(t.editorIsHidden)return Ki(e),!1;if(!t.force&&t.visible.from>=n.viewFrom&&t.visible.to<=n.viewTo&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo)&&n.renderedView==n.view&&0==Ji(e))return!1;vi(e)&&(Ki(e),t.dims=Xn(e));var r=i.first+i.size,o=Math.max(t.visible.from-e.options.viewportMargin,i.first),a=Math.min(r,t.visible.to+e.options.viewportMargin);n.viewFrom<o&&o-n.viewFrom<20&&(o=Math.max(i.first,n.viewFrom)),n.viewTo>a&&n.viewTo-a<20&&(a=Math.min(r,n.viewTo)),Te&&(o=He(e.doc,o),a=Ue(e.doc,a));var s,l,c,d,u=o!=n.viewFrom||a!=n.viewTo||n.lastWrapHeight!=t.wrapperHeight||n.lastWrapWidth!=t.wrapperWidth;l=o,c=a,0==(d=(s=e).display).view.length||l>=d.viewTo||c<=d.viewFrom?(d.view=rn(s,l,c),d.viewFrom=l):(d.viewFrom>l?d.view=rn(s,l,d.viewFrom).concat(d.view):d.viewFrom<l&&(d.view=d.view.slice(ii(s,l))),d.viewFrom=l,d.viewTo<c?d.view=d.view.concat(rn(s,d.viewTo,c)):d.viewTo>c&&(d.view=d.view.slice(0,ii(s,c)))),d.viewTo=c,n.viewOffset=ze(se(e.doc,n.viewFrom)),e.display.mover.style.top=n.viewOffset+"px";var p=Ji(e);if(!u&&0==p&&!t.force&&n.renderedView==n.view&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo))return!1;var h=function(e){if(e.hasFocus())return null;var t=L();if(!t||!A(e.display.lineDiv,t))return null;var n={activeElt:t};if(window.getSelection){var i=window.getSelection();i.anchorNode&&i.extend&&A(e.display.lineDiv,i.anchorNode)&&(n.anchorNode=i.anchorNode,n.anchorOffset=i.anchorOffset,n.focusNode=i.focusNode,n.focusOffset=i.focusOffset)}return n}(e);return 4<p&&(n.lineDiv.style.display="none"),function(n,e,t){var i=n.display,r=n.options.lineNumbers,o=i.lineDiv,a=o.firstChild;function s(e){var t=e.nextSibling;return b&&w&&n.display.currentWheelTarget==e?e.style.display="none":e.parentNode.removeChild(e),t}for(var l=i.view,c=i.viewFrom,d=0;d<l.length;d++){var u=l[d];if(u.hidden);else if(u.node&&u.node.parentNode==o){for(;a!=u.node;)a=s(a);var p=r&&null!=e&&e<=c&&u.lineNumber;u.changes&&(-1<$(u.changes,"gutter")&&(p=!1),cn(n,u,c,t)),p&&(E(u.lineNumber),u.lineNumber.appendChild(document.createTextNode(fe(n.options,c)))),a=u.node.nextSibling}else{var h=(m=c,v=t,void 0,y=un(f=n,g=u),g.text=g.node=y.pre,y.bgClass&&(g.bgClass=y.bgClass),y.textClass&&(g.textClass=y.textClass),hn(f,g),fn(f,g,m,v),mn(f,g,v),g.node);o.insertBefore(h,a)}c+=u.size}var f,g,m,v,y;for(;a;)a=s(a)}(e,n.updateLineNumbers,t.dims),4<p&&(n.lineDiv.style.display=""),n.renderedView=n.view,function(e){if(e&&e.activeElt&&e.activeElt!=L()&&(e.activeElt.focus(),e.anchorNode&&A(document.body,e.anchorNode)&&A(document.body,e.focusNode))){var t=window.getSelection(),n=document.createRange();n.setEnd(e.anchorNode,e.anchorOffset),n.collapse(!1),t.removeAllRanges(),t.addRange(n),t.extend(e.focusNode,e.focusOffset)}}(h),E(n.cursorDiv),E(n.selectionDiv),n.gutters.style.height=n.sizer.style.minHeight=0,u&&(n.lastWrapHeight=t.wrapperHeight,n.lastWrapWidth=t.wrapperWidth,Qi(e,400)),n.updateLineNumbers=null,!0}function er(e,t){for(var n=t.viewport,i=!0;(i&&e.options.lineWrapping&&t.oldDisplayWidth!=Tn(e)||(n&&null!=n.top&&(n={top:Math.min(e.doc.height+Cn(e.display)-Fn(e),n.top)}),t.visible=gi(e.display,e.doc,n),!(t.visible.from>=e.display.viewFrom&&t.visible.to<=e.display.viewTo)))&&Zi(e,t);i=!1){hi(e);var r=Ei(e);ri(e),Ni(e,r),ir(e,r)}t.signal(e,"update",e),e.display.viewFrom==e.display.reportedViewFrom&&e.display.viewTo==e.display.reportedViewTo||(t.signal(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo),e.display.reportedViewFrom=e.display.viewFrom,e.display.reportedViewTo=e.display.viewTo)}function tr(e,t){var n=new Xi(e,t);if(Zi(e,n)){hi(e),er(e,n);var i=Ei(e);ri(e),Ni(e,i),ir(e,i),n.finish()}}function nr(e){var t=e.display.gutters.offsetWidth;e.display.sizer.style.marginLeft=t+"px"}function ir(e,t){e.display.sizer.style.minHeight=t.docHeight+"px",e.display.heightForcer.style.top=t.docHeight+"px",e.display.gutters.style.height=t.docHeight+e.display.barHeight+Sn(e)+"px"}function rr(e){var t=e.display.gutters,n=e.options.gutters;E(t);for(var i=0;i<n.length;++i){var r=n[i],o=t.appendChild(M("div",null,"CodeMirror-gutter "+r));"CodeMirror-linenumbers"==r&&((e.display.lineGutter=o).style.width=(e.display.lineNumWidth||1)+"px")}t.style.display=i?"":"none",nr(e)}function or(e){var t=$(e.gutters,"CodeMirror-linenumbers");-1==t&&e.lineNumbers?e.gutters=e.gutters.concat(["CodeMirror-linenumbers"]):-1<t&&!e.lineNumbers&&(e.gutters=e.gutters.slice(0),e.gutters.splice(t,1))}Xi.prototype.signal=function(e,t){ct(e,t)&&this.events.push(arguments)},Xi.prototype.finish=function(){for(var e=0;e<this.events.length;e++)at.apply(null,this.events[e])};var ar=0,sr=null;function lr(e){var t=e.wheelDeltaX,n=e.wheelDeltaY;return null==t&&e.detail&&e.axis==e.HORIZONTAL_AXIS&&(t=e.detail),null==n&&e.detail&&e.axis==e.VERTICAL_AXIS?n=e.detail:null==n&&(n=e.wheelDelta),{x:t,y:n}}function cr(e){var t=lr(e);return t.x*=sr,t.y*=sr,t}function dr(e,t){var n=lr(t),i=n.x,r=n.y,o=e.display,a=o.scroller,s=a.scrollWidth>a.clientWidth,l=a.scrollHeight>a.clientHeight;if(i&&s||r&&l){if(r&&w&&b)e:for(var c=t.target,d=o.view;c!=a;c=c.parentNode)for(var u=0;u<d.length;u++)if(d[u].node==c){e.display.currentWheelTarget=c;break e}if(i&&!g&&!m&&null!=sr)return r&&l&&Si(e,Math.max(0,a.scrollTop+r*sr)),Fi(e,Math.max(0,a.scrollLeft+i*sr)),(!r||r&&l)&&ut(t),void(o.wheelStartX=null);if(r&&null!=sr){var p=r*sr,h=e.doc.scrollTop,f=h+o.wrapper.clientHeight;p<0?h=Math.max(0,h+p-50):f=Math.min(e.doc.height,f+p+50),tr(e,{top:h,bottom:f})}ar<20&&(null==o.wheelStartX?(o.wheelStartX=a.scrollLeft,o.wheelStartY=a.scrollTop,o.wheelDX=i,o.wheelDY=r,setTimeout(function(){if(null!=o.wheelStartX){var e=a.scrollLeft-o.wheelStartX,t=a.scrollTop-o.wheelStartY,n=t&&o.wheelDY&&t/o.wheelDY||e&&o.wheelDX&&e/o.wheelDX;o.wheelStartX=o.wheelStartY=null,n&&(sr=(sr*ar+n)/(ar+1),++ar)}},200)):(o.wheelDX+=i,o.wheelDY+=r))}}x?sr=-.53:g?sr=15:a?sr=-.7:d&&(sr=-1/3);var ur=function(e,t){this.ranges=e,this.primIndex=t};ur.prototype.primary=function(){return this.ranges[this.primIndex]},ur.prototype.equals=function(e){if(e==this)return!0;if(e.primIndex!=this.primIndex||e.ranges.length!=this.ranges.length)return!1;for(var t=0;t<this.ranges.length;t++){var n=this.ranges[t],i=e.ranges[t];if(!ve(n.anchor,i.anchor)||!ve(n.head,i.head))return!1}return!0},ur.prototype.deepCopy=function(){for(var e=[],t=0;t<this.ranges.length;t++)e[t]=new pr(ye(this.ranges[t].anchor),ye(this.ranges[t].head));return new ur(e,this.primIndex)},ur.prototype.somethingSelected=function(){for(var e=0;e<this.ranges.length;e++)if(!this.ranges[e].empty())return!0;return!1},ur.prototype.contains=function(e,t){t||(t=e);for(var n=0;n<this.ranges.length;n++){var i=this.ranges[n];if(0<=me(t,i.from())&&me(e,i.to())<=0)return n}return-1};var pr=function(e,t){this.anchor=e,this.head=t};function hr(e,t){var n=e[t];e.sort(function(e,t){return me(e.from(),t.from())}),t=$(e,n);for(var i=1;i<e.length;i++){var r=e[i],o=e[i-1];if(0<=me(o.to(),r.from())){var a=we(o.from(),r.from()),s=be(o.to(),r.to()),l=o.empty()?r.from()==r.head:o.from()==o.head;i<=t&&--t,e.splice(--i,2,new pr(l?s:a,l?a:s))}}return new ur(e,t)}function fr(e,t){return new ur([new pr(e,t||e)],0)}function gr(e){return e.text?ge(e.from.line+e.text.length-1,J(e.text).length+(1==e.text.length?e.from.ch:0)):e.to}function mr(e,t){if(me(e,t.from)<0)return e;if(me(e,t.to)<=0)return gr(t);var n=e.line+t.text.length-(t.to.line-t.from.line)-1,i=e.ch;return e.line==t.to.line&&(i+=gr(t).ch-t.to.ch),ge(n,i)}function vr(e,t){for(var n=[],i=0;i<e.sel.ranges.length;i++){var r=e.sel.ranges[i];n.push(new pr(mr(r.anchor,t),mr(r.head,t)))}return hr(n,e.sel.primIndex)}function yr(e,t,n){return e.line==t.line?ge(n.line,e.ch-t.ch+n.ch):ge(n.line+(e.line-t.line),e.ch)}function br(e){e.doc.mode=Nt(e.options,e.doc.modeOption),wr(e)}function wr(e){e.doc.iter(function(e){e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null)}),e.doc.frontier=e.doc.first,Qi(e,100),e.state.modeGen++,e.curOp&&zi(e)}function xr(e,t){return 0==t.from.ch&&0==t.to.ch&&""==J(t.text)&&(!e.cm||e.cm.options.wholeLineUpdateBefore)}function Cr(e,i,t,r){function o(e){return t?t[e]:null}function n(e,t,n){!function(e,t,n,i){e.text=t,e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null),null!=e.order&&(e.order=null),Ae(e),Le(e,n);var r=i?i(e):1;r!=e.height&&de(e,r)}(e,t,n,r),sn(e,"change",e,i)}function a(e,t){for(var n=[],i=e;i<t;++i)n.push(new Vt(c[i],o(i),r));return n}var s=i.from,l=i.to,c=i.text,d=se(e,s.line),u=se(e,l.line),p=J(c),h=o(c.length-1),f=l.line-s.line;if(i.full)e.insert(0,a(0,c.length)),e.remove(c.length,e.size-c.length);else if(xr(e,i)){var g=a(0,c.length-1);n(u,u.text,h),f&&e.remove(s.line,f),g.length&&e.insert(s.line,g)}else if(d==u)if(1==c.length)n(d,d.text.slice(0,s.ch)+p+d.text.slice(l.ch),h);else{var m=a(1,c.length-1);m.push(new Vt(p+d.text.slice(l.ch),h,r)),n(d,d.text.slice(0,s.ch)+c[0],o(0)),e.insert(s.line+1,m)}else if(1==c.length)n(d,d.text.slice(0,s.ch)+c[0]+u.text.slice(l.ch),o(0)),e.remove(s.line+1,f);else{n(d,d.text.slice(0,s.ch)+c[0],o(0)),n(u,p+u.text.slice(l.ch),h);var v=a(1,c.length-1);1<f&&e.remove(s.line+1,f-1),e.insert(s.line+1,v)}sn(e,"change",e,i)}function kr(e,s,l){!function e(t,n,i){if(t.linked)for(var r=0;r<t.linked.length;++r){var o=t.linked[r];if(o.doc!=n){var a=i&&o.sharedHist;l&&!a||(s(o.doc,a),e(o.doc,t,a))}}}(e,null,!0)}function Sr(e,t){if(t.cm)throw new Error("This document is already in use.");ti((e.doc=t).cm=e),br(e),Tr(e),e.options.lineWrapping||Ke(e),e.options.mode=t.modeOption,zi(e)}function Tr(e){("rtl"==e.doc.direction?I:F)(e.display.lineDiv,"CodeMirror-rtl")}function Fr(e){this.done=[],this.undone=[],this.undoDepth=1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=e||1}function Er(e,t){var n={from:ye(t.from),to:gr(t),text:le(e,t.from,t.to)};return Lr(e,n,t.from.line,t.to.line+1),kr(e,function(e){return Lr(e,n,t.from.line,t.to.line+1)},!0),n}function _r(e){for(;e.length;){if(!J(e).ranges)break;e.pop()}}function Mr(e,t,n,i){var r=e.history;r.undone.length=0;var o,a,s,l=+new Date;if(!(1<(t.text||[]).length)&&(r.lastOp==i||r.lastOrigin==t.origin&&t.origin&&("+"==t.origin.charAt(0)&&e.cm&&r.lastModTime>l-e.cm.options.historyEventDelay||"*"==t.origin.charAt(0)))&&(o=(s=r).lastOp==i?(_r(s.done),J(s.done)):s.done.length&&!J(s.done).ranges?J(s.done):1<s.done.length&&!s.done[s.done.length-2].ranges?(s.done.pop(),J(s.done)):void 0))a=J(o.changes),0==me(t.from,t.to)&&0==me(t.from,a.to)?a.to=gr(t):o.changes.push(Er(e,t));else{"setValue"!=t.origin&&e.cm.cid&&e.cm.editor.fences.addToUndoManager(e.cm,!1,"undo");var c=J(r.done);for(c&&c.ranges||Ar(e.sel,r.done),o={changes:[Er(e,t)],generation:r.generation},r.done.push(o);r.done.length>r.undoDepth;)r.done.shift(),r.done[0].ranges||r.done.shift()}r.done.push(n),r.generation=++r.maxGeneration,r.lastModTime=r.lastSelTime=l,r.lastOp=r.lastSelOp=i,r.lastOrigin=r.lastSelOrigin=t.origin,a||at(e,"historyAdded")}function Nr(e,t,n,i){var r,o,a,s,l,c=e.history,d=i&&i.origin;n==c.lastSelOp||d&&c.lastSelOrigin==d&&(c.lastModTime==c.lastSelTime&&c.lastOrigin==d||(r=e,o=d,a=J(c.done),s=t,"*"==(l=o.charAt(0))||"+"==l&&a.ranges.length==s.ranges.length&&a.somethingSelected()==s.somethingSelected()&&new Date-r.history.lastSelTime<=(r.cm?r.cm.options.historyEventDelay:500)))?c.done[c.done.length-1]=t:Ar(t,c.done),c.lastSelTime=+new Date,c.lastSelOrigin=d,c.lastSelOp=n,i&&!1!==i.clearRedo&&_r(c.undone)}function Ar(e,t){var n=J(t);n&&n.ranges&&n.equals(e)||t.push(e)}function Lr(t,n,e,i){var r=n["spans_"+t.id],o=0;t.iter(Math.max(t.first,e),Math.min(t.first+t.size,i),function(e){e.markedSpans&&((r||(r=n["spans_"+t.id]={}))[o]=e.markedSpans),++o})}function Ir(e){if(!e)return null;for(var t,n=0;n<e.length;++n)e[n].marker.explicitlyCleared?t||(t=e.slice(0,n)):t&&t.push(e[n]);return t?t.length?t:null:e}function Rr(e,t){var n=function(e,t){var n=t["spans_"+e.id];if(!n)return null;for(var i=[],r=0;r<t.text.length;++r)i.push(Ir(n[r]));return i}(e,t),i=Me(e,t);if(!n)return i;if(!i)return n;for(var r=0;r<n.length;++r){var o=n[r],a=i[r];if(o&&a)e:for(var s=0;s<a.length;++s){for(var l=a[s],c=0;c<o.length;++c)if(o[c].marker==l.marker)continue e;o.push(l)}else a&&(n[r]=a)}return n}function Pr(e,t,n){for(var i=[],r=0;r<e.length;++r){var o=e[r];if(o.ranges)i.push(n?ur.prototype.deepCopy.call(o):o);else{var a=o.changes,s=[];i.push({changes:s});for(var l=0;l<a.length;++l){var c=a[l],d=void 0;if(s.push({from:c.from,to:c.to,text:c.text}),t)for(var u in c)(d=u.match(/^spans_(\d+)$/))&&-1<$(t,Number(d[1]))&&(J(s)[u]=c[u],delete c[u])}}}return i}function Dr(e,t,n,i){if(e.cm&&e.cm.display.shift||e.extend){var r=t.anchor;if(i){var o=me(n,r)<0;o!=me(i,r)<0?(r=n,n=i):o!=me(n,i)<0&&(n=i)}return new pr(r,n)}return new pr(i||n,n)}function Or(e,t,n,i){Ur(e,new ur([Dr(e,e.sel.primary(),t,n)],0),i)}function Br(e,t,n){for(var i=[],r=0;r<e.sel.ranges.length;r++)i[r]=Dr(e,e.sel.ranges[r],t[r],null);Ur(e,hr(i,e.sel.primIndex),n)}function jr(e,t,n,i){var r=e.sel.ranges.slice(0);r[t]=n,Ur(e,hr(r,e.sel.primIndex),i)}function $r(e,t,n,i){Ur(e,fr(t,n),i)}function Hr(e,t,n){var i=e.history.done,r=J(i);r&&r.ranges?Wr(e,i[i.length-1]=t,n):Ur(e,t,n)}function Ur(e,t,n){Wr(e,t,n),Nr(e,e.sel,e.cm?e.cm.curOp.id:NaN,n)}function Wr(e,t,n){var i,r,o,a;(ct(e,"beforeSelectionChange")||e.cm&&ct(e.cm,"beforeSelectionChange"))&&(i=e,o=n,a={ranges:(r=t).ranges,update:function(e){this.ranges=[];for(var t=0;t<e.length;t++)this.ranges[t]=new pr(Ce(i,e[t].anchor),Ce(i,e[t].head))},origin:o&&o.origin},at(i,"beforeSelectionChange",i,a),i.cm&&at(i.cm,"beforeSelectionChange",i.cm,a),t=a.ranges!=r.ranges?hr(a.ranges,a.ranges.length-1):r),qr(e,Vr(e,t,n&&n.bias||(me(t.primary().head,e.sel.primary().head)<0?-1:1),!0)),n&&!1===n.scroll||!e.cm||wi(e.cm)}function qr(e,t){t.equals(e.sel)||(e.sel=t,e.cm&&(e.cm.curOp.updateInput=e.cm.curOp.selectionChanged=!0,lt(e.cm)),sn(e,"cursorActivity",e))}function zr(e){qr(e,Vr(e,e.sel,null,!1))}function Vr(e,t,n,i){for(var r,o=0;o<t.ranges.length;o++){var a=t.ranges[o],s=t.ranges.length==e.sel.ranges.length&&e.sel.ranges[o],l=Yr(e,a.anchor,s&&s.anchor,n,i),c=Yr(e,a.head,s&&s.head,n,i);(r||l!=a.anchor||c!=a.head)&&(r||(r=t.ranges.slice(0,o)),r[o]=new pr(l,c))}return r?hr(r,t.primIndex):t}function Kr(e,t,n,i,r){var o=se(e,t.line);if(o.markedSpans)for(var a=0;a<o.markedSpans.length;++a){var s=o.markedSpans[a],l=s.marker;if((null==s.from||(l.inclusiveLeft?s.from<=t.ch:s.from<t.ch))&&(null==s.to||(l.inclusiveRight?s.to>=t.ch:s.to>t.ch))){if(r&&(at(l,"beforeCursorEnter"),l.explicitlyCleared)){if(o.markedSpans){--a;continue}break}if(!l.atomic)continue;if(n){var c=l.find(i<0?1:-1),d=void 0;if((i<0?l.inclusiveRight:l.inclusiveLeft)&&(c=Jr(e,c,-i,c&&c.line==t.line?o:null)),c&&c.line==t.line&&(d=me(c,n))&&(i<0?d<0:0<d))return Kr(e,c,t,i,r)}var u=l.find(i<0?-1:1);return(i<0?l.inclusiveLeft:l.inclusiveRight)&&(u=Jr(e,u,i,u.line==t.line?o:null)),u?Kr(e,u,t,i,r):null}}return t}function Yr(e,t,n,i,r){var o=i||1,a=Kr(e,t,n,o,r)||!r&&Kr(e,t,n,o,!0)||Kr(e,t,n,-o,r)||!r&&Kr(e,t,n,-o,!0);return a||(e.cantEdit=!0,ge(e.first,0))}function Jr(e,t,n,i){return n<0&&0==t.ch?t.line>e.first?Ce(e,ge(t.line-1)):null:0<n&&t.ch==(i||se(e,t.line)).text.length?t.line<e.first+e.size-1?ge(t.line+1,0):null:new ge(t.line,t.ch+n)}function Qr(e){e.setSelection(ge(e.firstLine(),0),ge(e.lastLine()),W)}function Gr(r,e,t){var o={canceled:!1,from:e.from,to:e.to,text:e.text,origin:e.origin,cancel:function(){return o.canceled=!0}};return t&&(o.update=function(e,t,n,i){e&&(o.from=Ce(r,e)),t&&(o.to=Ce(r,t)),n&&(o.text=n),void 0!==i&&(o.origin=i)}),at(r,"beforeChange",r,o),r.cm&&at(r.cm,"beforeChange",r.cm,o),o.canceled?null:{from:o.from,to:o.to,text:o.text,origin:o.origin}}function Xr(e,t,n){if(e.cm){if(!e.cm.curOp)return Ui(e.cm,Xr)(e,t,n);if(e.cm.state.suppressEdits)return}if(!(ct(e,"beforeChange")||e.cm&&ct(e.cm,"beforeChange"))||(t=Gr(e,t,!0))){var i=Se&&!n&&function(e,t,n){var i=null;if(e.iter(t.line,n.line+1,function(e){if(e.markedSpans)for(var t=0;t<e.markedSpans.length;++t){var n=e.markedSpans[t].marker;!n.readOnly||i&&-1!=$(i,n)||(i||(i=[])).push(n)}}),!i)return null;for(var r=[{from:t,to:n}],o=0;o<i.length;++o)for(var a=i[o],s=a.find(0),l=0;l<r.length;++l){var c=r[l];if(!(me(c.to,s.from)<0||0<me(c.from,s.to))){var d=[l,1],u=me(c.from,s.from),p=me(c.to,s.to);(u<0||!a.inclusiveLeft&&!u)&&d.push({from:c.from,to:s.from}),(0<p||!a.inclusiveRight&&!p)&&d.push({from:s.to,to:c.to}),r.splice.apply(r,d),l+=d.length-3}}return r}(e,t.from,t.to);if(i)for(var r=i.length-1;0<=r;--r)Zr(e,{from:i[r].from,to:i[r].to,text:r?[""]:t.text});else Zr(e,t)}}function Zr(e,n){if(1!=n.text.length||""!=n.text[0]||0!=me(n.from,n.to)){var t=vr(e,n);Mr(e,n,t,e.cm?e.cm.curOp.id:NaN),no(e,n,t,Me(e,n));var i=[];kr(e,function(e,t){t||-1!=$(i,e.history)||(ao(e.history,n),i.push(e.history)),no(e,n,null,Me(e,n))})}}function eo(r,o,e){if(!r.cm||!r.cm.state.suppressEdits||e){for(var a,t=r.history,n=r.sel,s="undo"==o?t.done:t.undone,i="undo"==o?t.undone:t.done,l=0;l<s.length&&(a=s[l],e?!a.ranges||a.equals(r.sel):a.ranges);l++);if(l!=s.length){for(t.lastOrigin=t.lastSelOrigin=null;(a=s.pop()).ranges;){if(Ar(a,i),e&&!a.equals(r.sel))return void Ur(r,a,{clearRedo:!1});n=a}var c=[];Ar(n,i),i.push({changes:c,generation:t.generation}),t.generation=a.generation||++t.maxGeneration;for(var d=ct(r,"beforeChange")||r.cm&&ct(r.cm,"beforeChange"),u=function(e){var n=a.changes[e];if(n.origin=o,d&&!Gr(r,n,!1))return s.length=0,{};c.push(Er(r,n));var t=e?vr(r,n):J(s);no(r,n,t,Rr(r,n)),!e&&r.cm&&r.cm.scrollIntoView({from:n.from,to:gr(n)});var i=[];kr(r,function(e,t){t||-1!=$(i,e.history)||(ao(e.history,n),i.push(e.history)),no(e,n,null,Rr(e,n))})},p=a.changes.length-1;0<=p;--p){var h=u(p);if(h)return h.v}}}}function to(e,t){if(0!=t&&(e.first+=t,e.sel=new ur(Q(e.sel.ranges,function(e){return new pr(ge(e.anchor.line+t,e.anchor.ch),ge(e.head.line+t,e.head.ch))}),e.sel.primIndex),e.cm)){zi(e.cm,e.first,e.first-t,t);for(var n=e.cm.display,i=n.viewFrom;i<n.viewTo;i++)Vi(e.cm,i,"gutter")}}function no(e,t,n,i){if(e.cm&&!e.cm.curOp)return Ui(e.cm,no)(e,t,n,i);if(t.to.line<e.first)to(e,t.text.length-1-(t.to.line-t.from.line));else if(!(t.from.line>e.lastLine())){if(t.from.line<e.first){var r=t.text.length-1-(e.first-t.from.line);to(e,r),t={from:ge(e.first,0),to:ge(t.to.line+r,t.to.ch),text:[J(t.text)],origin:t.origin}}var o=e.lastLine();t.to.line>o&&(t={from:t.from,to:ge(o,se(e,o).text.length),text:[t.text[0]],origin:t.origin}),t.removed=le(e,t.from,t.to),n||(n=vr(e,t)),e.cm?function(e,t,n){var i=e.doc,r=e.display,o=t.from,a=t.to,s=!1,l=o.line;e.options.lineWrapping||(l=ue($e(se(i,o.line))),i.iter(l,a.line+1,function(e){if(e==r.maxLine)return s=!0}));-1<i.sel.contains(t.from,t.to)&&lt(e);Cr(i,t,n,ei(e)),e.options.lineWrapping||(i.iter(l,o.line+t.text.length,function(e){var t=Ve(e);t>r.maxLineLength&&(r.maxLine=e,r.maxLineLength=t,r.maxLineChanged=!0,s=!1)}),s&&(e.curOp.updateMaxLine=!0));i.frontier=Math.min(i.frontier,o.line-1),Qi(e,400);var c=t.text.length-(a.line-o.line)-1;t.full?zi(e):o.line!=a.line||1!=t.text.length||xr(e.doc,t)?zi(e,o.line,a.line+1,c):Vi(e,o.line,"text");var d=ct(e,"changes"),u=ct(e,"change");if(u||d){var p={from:o,to:a,text:t.text,removed:t.removed,origin:t.origin};u&&sn(e,"change",e,p),d&&(e.curOp.changeObjs||(e.curOp.changeObjs=[])).push(p)}e.display.selForContextMenu=null}(e.cm,t,i):Cr(e,t,i),Wr(e,n,W)}}function io(e,t,n,i,r){if(i||(i=n),me(i,n)<0){var o=i;i=n,n=o}"string"==typeof t&&(t=e.splitLines(t)),Xr(e,{from:n,to:i,text:t,origin:r})}function ro(e,t,n,i){n<e.line?e.line+=i:t<e.line&&(e.line=t,e.ch=0)}function oo(e,t,n,i){for(var r=0;r<e.length;++r){var o=e[r],a=!0;if(o.ranges){o.copied||((o=e[r]=o.deepCopy()).copied=!0);for(var s=0;s<o.ranges.length;s++)ro(o.ranges[s].anchor,t,n,i),ro(o.ranges[s].head,t,n,i)}else{for(var l=0;l<o.changes.length;++l){var c=o.changes[l];if(n<c.from.line)c.from=ge(c.from.line+i,c.from.ch),c.to=ge(c.to.line+i,c.to.ch);else if(t<=c.to.line){a=!1;break}}a||(e.splice(0,r+1),r=0)}}}function ao(e,t){var n=t.from.line,i=t.to.line,r=t.text.length-(i-n)-1;oo(e.done,n,i,r),oo(e.undone,n,i,r)}function so(e,t,n,i){var r=t,o=t;return"number"==typeof t?o=se(e,xe(e,t)):r=ue(t),null==r?null:(i(o,r)&&e.cm&&Vi(e.cm,r,n),o)}pr.prototype.from=function(){return we(this.anchor,this.head)},pr.prototype.to=function(){return be(this.anchor,this.head)},pr.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch};var lo=function(e){this.lines=e,this.parent=null;for(var t=0,n=0;n<e.length;++n)e[n].parent=this,t+=e[n].height;this.height=t};lo.prototype.chunkSize=function(){return this.lines.length},lo.prototype.removeInner=function(e,t){for(var n,i=e,r=e+t;i<r;++i){var o=this.lines[i];this.height-=o.height,(n=o).parent=null,Ae(n),sn(o,"delete")}this.lines.splice(e,t)},lo.prototype.collapse=function(e){e.push.apply(e,this.lines)},lo.prototype.insertInner=function(e,t,n){this.height+=n,this.lines=this.lines.slice(0,e).concat(t).concat(this.lines.slice(e));for(var i=0;i<t.length;++i)t[i].parent=this},lo.prototype.iterN=function(e,t,n){for(var i=e+t;e<i;++e)if(n(this.lines[e]))return!0};var co=function(e){this.children=e;for(var t=0,n=0,i=0;i<e.length;++i){var r=e[i];t+=r.chunkSize(),n+=r.height,r.parent=this}this.size=t,this.height=n,this.parent=null};co.prototype.chunkSize=function(){return this.size},co.prototype.removeInner=function(e,t){this.size-=t;for(var n=0;n<this.children.length;++n){var i=this.children[n],r=i.chunkSize();if(e<r){var o=Math.min(t,r-e),a=i.height;if(i.removeInner(e,o),this.height-=a-i.height,r==o&&(this.children.splice(n--,1),i.parent=null),0==(t-=o))break;e=0}else e-=r}if(this.size-t<25&&(1<this.children.length||!(this.children[0]instanceof lo))){var s=[];this.collapse(s),this.children=[new lo(s)],this.children[0].parent=this}},co.prototype.collapse=function(e){for(var t=0;t<this.children.length;++t)this.children[t].collapse(e)},co.prototype.insertInner=function(e,t,n){this.size+=t.length,this.height+=n;for(var i=0;i<this.children.length;++i){var r=this.children[i],o=r.chunkSize();if(e<=o){if(r.insertInner(e,t,n),r.lines&&50<r.lines.length){for(var a=r.lines.length%25+25,s=a;s<r.lines.length;){var l=new lo(r.lines.slice(s,s+=25));r.height-=l.height,this.children.splice(++i,0,l),l.parent=this}r.lines=r.lines.slice(0,a),this.maybeSpill()}break}e-=o}},co.prototype.maybeSpill=function(){if(!(this.children.length<=10)){var e=this;do{var t=e.children.splice(e.children.length-5,5),n=new co(t);if(e.parent){e.size-=n.size,e.height-=n.height;var i=$(e.parent.children,e);e.parent.children.splice(i+1,0,n)}else{var r=new co(e.children);(r.parent=e).children=[r,n],e=r}n.parent=e.parent}while(10<e.children.length);e.parent.maybeSpill()}},co.prototype.iterN=function(e,t,n){for(var i=0;i<this.children.length;++i){var r=this.children[i],o=r.chunkSize();if(e<o){var a=Math.min(t,o-e);if(r.iterN(e,a,n))return!0;if(0==(t-=a))break;e=0}else e-=o}};var uo=function(e,t,n){if(n)for(var i in n)n.hasOwnProperty(i)&&(this[i]=n[i]);this.doc=e,this.node=t};function po(e,t,n){ze(t)<(e.curOp&&e.curOp.scrollTop||e.doc.scrollTop)&&bi(e,n)}uo.prototype.clear=function(){var e=this.doc.cm,t=this.line.widgets,n=this.line,i=ue(n);if(null!=i&&t){for(var r=0;r<t.length;++r)t[r]==this&&t.splice(r--,1);t.length||(n.widgets=null);var o=bn(this);de(n,Math.max(0,n.height-o)),e&&(Hi(e,function(){po(e,n,-o),Vi(e,i,"widget")}),sn(e,"lineWidgetCleared",e,this,i))}},uo.prototype.changed=function(){var e=this,t=this.height,n=this.doc.cm,i=this.line;this.height=null;var r=bn(this)-t;r&&(de(i,i.height+r),n&&Hi(n,function(){n.curOp.forceUpdate=!0,po(n,i,r),sn(n,"lineWidgetChanged",n,e,ue(i))}))},dt(uo);var ho=0,fo=function(e,t){this.lines=[],this.type=t,this.doc=e,this.id=++ho};function go(t,i,r,e,n){if(e&&e.shared)return function(e,n,i,r,o){(r=O(r)).shared=!1;var a=[go(e,n,i,r,o)],s=a[0],l=r.widgetNode;return kr(e,function(e){l&&(r.widgetNode=l.cloneNode(!0)),a.push(go(e,Ce(e,n),Ce(e,i),r,o));for(var t=0;t<e.linked.length;++t)if(e.linked[t].isParent)return;s=J(a)}),new mo(a,s)}(t,i,r,e,n);if(t.cm&&!t.cm.curOp)return Ui(t.cm,go)(t,i,r,e,n);var o=new fo(t,n),a=me(i,r);if(e&&O(e,o,!1),0<a||0==a&&!1!==o.clearWhenEmpty)return o;if(o.replacedWith&&(o.collapsed=!0,o.widgetNode=N("span",[o.replacedWith],"CodeMirror-widget"),e.handleMouseEvents||o.widgetNode.setAttribute("cm-ignore-events","true"),e.insertLeft&&(o.widgetNode.insertLeft=!0)),o.collapsed){if(je(t,i.line,i,r,o)||i.line!=r.line&&je(t,r.line,i,r,o))throw new Error("Inserting collapsed marker partially overlapping an existing one");Te=!0}o.addToHistory&&Mr(t,{from:i,to:r,origin:"markText"},t.sel,NaN);var s,l=i.line,c=t.cm;if(t.iter(l,r.line+1,function(e){var t,n;c&&o.collapsed&&!c.options.lineWrapping&&$e(e)==c.display.maxLine&&(s=!0),o.collapsed&&l!=i.line&&de(e,0),t=e,n=new Fe(o,l==i.line?i.ch:null,l==r.line?r.ch:null),t.markedSpans=t.markedSpans?t.markedSpans.concat([n]):[n],n.marker.attachLine(t),++l}),o.collapsed&&t.iter(i.line,r.line+1,function(e){We(t,e)&&de(e,0)}),o.clearOnEnter&&it(o,"beforeCursorEnter",function(){return o.clear()}),o.readOnly&&(Se=!0,(t.history.done.length||t.history.undone.length)&&t.clearHistory()),o.collapsed&&(o.id=++ho,o.atomic=!0),c){if(s&&(c.curOp.updateMaxLine=!0),o.collapsed)zi(c,i.line,r.line+1);else if(o.className||o.title||o.startStyle||o.endStyle||o.css)for(var d=i.line;d<=r.line;d++)Vi(c,d,"text");o.atomic&&zr(c.doc),sn(c,"markerAdded",c,o)}return o}fo.prototype.clear=function(){if(!this.explicitlyCleared){var e=this.doc.cm,t=e&&!e.curOp;if(t&&Pi(e),ct(this,"clear")){var n=this.find();n&&sn(this,"clear",n.from,n.to)}for(var i=null,r=null,o=0;o<this.lines.length;++o){var a=this.lines[o],s=Ee(a.markedSpans,this);e&&!this.collapsed?Vi(e,ue(a),"text"):e&&(null!=s.to&&(r=ue(a)),null!=s.from&&(i=ue(a))),a.markedSpans=_e(a.markedSpans,s),null==s.from&&this.collapsed&&!We(this.doc,a)&&e&&de(a,Qn(e.display))}if(e&&this.collapsed&&!e.options.lineWrapping)for(var l=0;l<this.lines.length;++l){var c=$e(this.lines[l]),d=Ve(c);d>e.display.maxLineLength&&(e.display.maxLine=c,e.display.maxLineLength=d,e.display.maxLineChanged=!0)}null!=i&&e&&this.collapsed&&zi(e,i,r+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,e&&zr(e.doc)),e&&sn(e,"markerCleared",e,this,i,r),t&&Di(e),this.parent&&this.parent.clear()}},fo.prototype.find=function(e,t){var n,i;null==e&&"bookmark"==this.type&&(e=1);for(var r=0;r<this.lines.length;++r){var o=this.lines[r],a=Ee(o.markedSpans,this);if(null!=a.from&&(n=ge(t?o:ue(o),a.from),-1==e))return n;if(null!=a.to&&(i=ge(t?o:ue(o),a.to),1==e))return i}return n&&{from:n,to:i}},fo.prototype.changed=function(){var o=this,a=this.find(-1,!0),s=this,l=this.doc.cm;a&&l&&Hi(l,function(){var e=a.line,t=ue(a.line),n=Mn(l,t);if(n&&(Dn(n),l.curOp.selectionChanged=l.curOp.forceUpdate=!0),l.curOp.updateMaxLine=!0,!We(s.doc,e)&&null!=s.height){var i=s.height;s.height=null;var r=bn(s)-i;r&&de(e,e.height+r)}sn(l,"markerChanged",l,o)})},fo.prototype.attachLine=function(e){if(!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;t.maybeHiddenMarkers&&-1!=$(t.maybeHiddenMarkers,this)||(t.maybeUnhiddenMarkers||(t.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(e)},fo.prototype.detachLine=function(e){if(this.lines.splice($(this.lines,e),1),!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;(t.maybeHiddenMarkers||(t.maybeHiddenMarkers=[])).push(this)}},dt(fo);var mo=function(e,t){this.markers=e,this.primary=t;for(var n=0;n<e.length;++n)e[n].parent=this};function vo(e){return e.findMarks(ge(e.first,0),e.clipPos(ge(e.lastLine())),function(e){return e.parent})}function yo(o){for(var e=function(e){var t=o[e],n=[t.primary.doc];kr(t.primary.doc,function(e){return n.push(e)});for(var i=0;i<t.markers.length;i++){var r=t.markers[i];-1==$(n,r.doc)&&(r.parent=null,t.markers.splice(i--,1))}},t=0;t<o.length;t++)e(t)}mo.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var e=0;e<this.markers.length;++e)this.markers[e].clear();sn(this,"clear")}},mo.prototype.find=function(e,t){return this.primary.find(e,t)},dt(mo);var bo=0,wo=function(e,t,n,i,r){if(!(this instanceof wo))return new wo(e,t,n,i,r);null==n&&(n=0),co.call(this,[new lo([new Vt("",null)])]),this.first=n,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1;var o=ge(this.frontier=n,0);this.sel=fr(o),this.history=new Fr(null),this.id=++bo,this.modeOption=t,this.lineSep=i,this.direction="rtl"==r?"rtl":"ltr",this.extend=!1,"string"==typeof e&&(e=this.splitLines(e)),Cr(this,{from:o,to:o,text:e}),Ur(this,fr(o),W)};wo.prototype=X(co.prototype,{constructor:wo,iter:function(e,t,n){n?this.iterN(e-this.first,t-e,n):this.iterN(this.first,this.first+this.size,e)},insert:function(e,t){for(var n=0,i=0;i<t.length;++i)n+=t[i].height;this.insertInner(e-this.first,t,n)},remove:function(e,t){this.removeInner(e-this.first,t)},getValue:function(e){var t=ce(this,this.first,this.first+this.size);return!1===e?t:t.join(e||this.lineSeparator())},setValue:qi(function(e,t){var n=ge(this.first,0),i=this.first+this.size-1;Xr(this,{from:n,to:ge(i,se(this,i).text.length),text:this.splitLines(e),origin:t||"setValue",full:!0},!0),this.cm&&xi(this.cm,0,0),Ur(this,fr(n),W)}),replaceRange:function(e,t,n,i){io(this,e,t=Ce(this,t),n=n?Ce(this,n):t,i)},getRange:function(e,t,n){var i=le(this,Ce(this,e),Ce(this,t));return!1===n?i:i.join(n||this.lineSeparator())},getLine:function(e){var t=this.getLineHandle(e);return t&&t.text},getLineHandle:function(e){if(he(this,e))return se(this,e)},getLineNumber:function(e){return ue(e)},getLineHandleVisualStart:function(e){return"number"==typeof e&&(e=se(this,e)),$e(e)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(e){return Ce(this,e)},getCursor:function(e){var t=this.sel.primary();return null==e||"head"==e?t.head:"anchor"==e?t.anchor:"end"==e||"to"==e||!1===e?t.to():t.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:qi(function(e,t,n){$r(this,Ce(this,"number"==typeof e?ge(e,t||0):e),null,n)}),setSelection:qi(function(e,t,n){$r(this,Ce(this,e),Ce(this,t||e),n)}),extendSelection:qi(function(e,t,n){Or(this,Ce(this,e),t&&Ce(this,t),n)}),extendSelections:qi(function(e,t){Br(this,ke(this,e),t)}),extendSelectionsBy:qi(function(e,t){Br(this,ke(this,Q(this.sel.ranges,e)),t)}),setSelections:qi(function(e,t,n){if(e.length){for(var i=[],r=0;r<e.length;r++)i[r]=new pr(Ce(this,e[r].anchor),Ce(this,e[r].head));null==t&&(t=Math.min(e.length-1,this.sel.primIndex)),Ur(this,hr(i,t),n)}}),addSelection:qi(function(e,t,n){var i=this.sel.ranges.slice(0);i.push(new pr(Ce(this,e),Ce(this,t||e))),Ur(this,hr(i,i.length-1),n)}),getSelection:function(e){for(var t,n=this.sel.ranges,i=0;i<n.length;i++){var r=le(this,n[i].from(),n[i].to());t=t?t.concat(r):r}return!1===e?t:t.join(e||this.lineSeparator())},getSelections:function(e){for(var t=[],n=this.sel.ranges,i=0;i<n.length;i++){var r=le(this,n[i].from(),n[i].to());!1!==e&&(r=r.join(e||this.lineSeparator())),t[i]=r}return t},replaceSelection:function(e,t,n){for(var i=[],r=0;r<this.sel.ranges.length;r++)i[r]=e;this.replaceSelections(i,t,n||"+input")},replaceSelections:qi(function(e,t,n){for(var i=[],r=this.sel,o=0;o<r.ranges.length;o++){var a=r.ranges[o];i[o]={from:a.from(),to:a.to(),text:this.splitLines(e[o]),origin:n}}for(var s=t&&"end"!=t&&function(e,t,n){for(var i=[],r=ge(e.first,0),o=r,a=0;a<t.length;a++){var s=t[a],l=yr(s.from,r,o),c=yr(gr(s),r,o);if(r=s.to,o=c,"around"==n){var d=e.sel.ranges[a],u=me(d.head,d.anchor)<0;i[a]=new pr(u?c:l,u?l:c)}else i[a]=new pr(l,l)}return new ur(i,e.sel.primIndex)}(this,i,t),l=i.length-1;0<=l;l--)Xr(this,i[l]);s?Hr(this,s):this.cm&&wi(this.cm)}),undo:qi(function(){eo(this,"undo")}),redo:qi(function(){eo(this,"redo")}),undoSelection:qi(function(){eo(this,"undo",!0)}),redoSelection:qi(function(){eo(this,"redo",!0)}),setExtending:function(e){this.extend=e},getExtending:function(){return this.extend},historySize:function(){for(var e=this.history,t=0,n=0,i=0;i<e.done.length;i++)e.done[i].ranges||++t;for(var r=0;r<e.undone.length;r++)e.undone[r].ranges||++n;return{undo:t,redo:n}},clearHistory:function(){this.history=new Fr(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(e){return e&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(e){return this.history.generation==(e||this.cleanGeneration)},getHistory:function(){return{done:Pr(this.history.done),undone:Pr(this.history.undone)}},setHistory:function(e){var t=this.history=new Fr(this.history.maxGeneration);t.done=Pr(e.done.slice(0),null,!0),t.undone=Pr(e.undone.slice(0),null,!0)},setGutterMarker:qi(function(e,n,i){return so(this,e,"gutter",function(e){var t=e.gutterMarkers||(e.gutterMarkers={});return!(t[n]=i)&&ne(t)&&(e.gutterMarkers=null),!0})}),clearGutter:qi(function(t){var n=this;this.iter(function(e){e.gutterMarkers&&e.gutterMarkers[t]&&so(n,e,"gutter",function(){return e.gutterMarkers[t]=null,ne(e.gutterMarkers)&&(e.gutterMarkers=null),!0})})}),lineInfo:function(e){var t;if("number"==typeof e){if(!he(this,e))return null;if(!(e=se(this,t=e)))return null}else if(null==(t=ue(e)))return null;return{line:t,handle:e,text:e.text,gutterMarkers:e.gutterMarkers,textClass:e.textClass,bgClass:e.bgClass,wrapClass:e.wrapClass,widgets:e.widgets}},addLineClass:qi(function(e,n,i){return so(this,e,"gutter"==n?"gutter":"class",function(e){var t="text"==n?"textClass":"background"==n?"bgClass":"gutter"==n?"gutterClass":"wrapClass";if(e[t]){if(S(i).test(e[t]))return!1;e[t]+=" "+i}else e[t]=i;return!0})}),removeLineClass:qi(function(e,o,a){return so(this,e,"gutter"==o?"gutter":"class",function(e){var t="text"==o?"textClass":"background"==o?"bgClass":"gutter"==o?"gutterClass":"wrapClass",n=e[t];if(!n)return!1;if(null==a)e[t]=null;else{var i=n.match(S(a));if(!i)return!1;var r=i.index+i[0].length;e[t]=n.slice(0,i.index)+(i.index&&r!=n.length?" ":"")+n.slice(r)||null}return!0})}),addLineWidget:qi(function(e,t,n){return r=e,o=new uo(i=this,t,n),(a=i.cm)&&o.noHScroll&&(a.display.alignWidgets=!0),so(i,r,"widget",function(e){var t=e.widgets||(e.widgets=[]);if(null==o.insertAt?t.push(o):t.splice(Math.min(t.length-1,Math.max(0,o.insertAt)),0,o),o.line=e,a&&!We(i,e)){var n=ze(e)<i.scrollTop;de(e,e.height+bn(o)),n&&bi(a,o.height),a.curOp.forceUpdate=!0}return!0}),sn(a,"lineWidgetAdded",a,o,"number"==typeof r?r:ue(r)),o;var i,r,o,a}),removeLineWidget:function(e){e.clear()},markText:function(e,t,n){return go(this,Ce(this,e),Ce(this,t),n,n&&n.type||"range")},setBookmark:function(e,t){var n={replacedWith:t&&(null==t.nodeType?t.widget:t),insertLeft:t&&t.insertLeft,clearWhenEmpty:!1,shared:t&&t.shared,handleMouseEvents:t&&t.handleMouseEvents};return go(this,e=Ce(this,e),e,n,"bookmark")},findMarksAt:function(e){var t=[],n=se(this,(e=Ce(this,e)).line).markedSpans;if(n)for(var i=0;i<n.length;++i){var r=n[i];(null==r.from||r.from<=e.ch)&&(null==r.to||r.to>=e.ch)&&t.push(r.marker.parent||r.marker)}return t},findMarks:function(r,o,a){r=Ce(this,r),o=Ce(this,o);var s=[],l=r.line;return this.iter(r.line,o.line+1,function(e){var t=e.markedSpans;if(t)for(var n=0;n<t.length;n++){var i=t[n];null!=i.to&&l==r.line&&r.ch>=i.to||null==i.from&&l!=r.line||null!=i.from&&l==o.line&&i.from>=o.ch||a&&!a(i.marker)||s.push(i.marker.parent||i.marker)}++l}),s},getAllMarks:function(){var i=[];return this.iter(function(e){var t=e.markedSpans;if(t)for(var n=0;n<t.length;++n)null!=t[n].from&&i.push(t[n].marker)}),i},posFromIndex:function(n){var i,r=this.first,o=this.lineSeparator().length;return this.iter(function(e){var t=e.text.length+o;if(n<t)return i=n,!0;n-=t,++r}),Ce(this,ge(r,i))},indexFromPos:function(e){var t=(e=Ce(this,e)).ch;if(e.line<this.first||e.ch<0)return 0;var n=this.lineSeparator().length;return this.iter(this.first,e.line,function(e){t+=e.text.length+n}),t},copy:function(e){var t=new wo(ce(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return t.scrollTop=this.scrollTop,t.scrollLeft=this.scrollLeft,t.sel=this.sel,t.extend=!1,e&&(t.history.undoDepth=this.history.undoDepth,t.setHistory(this.getHistory())),t},linkedDoc:function(e){e||(e={});var t=this.first,n=this.first+this.size;null!=e.from&&e.from>t&&(t=e.from),null!=e.to&&e.to<n&&(n=e.to);var i=new wo(ce(this,t,n),e.mode||this.modeOption,t,this.lineSep,this.direction);return e.sharedHist&&(i.history=this.history),(this.linked||(this.linked=[])).push({doc:i,sharedHist:e.sharedHist}),i.linked=[{doc:this,isParent:!0,sharedHist:e.sharedHist}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n],r=i.find(),o=e.clipPos(r.from),a=e.clipPos(r.to);if(me(o,a)){var s=go(e,o,a,i.primary,i.primary.type);i.markers.push(s),s.parent=i}}}(i,vo(this)),i},unlinkDoc:function(e){if(e instanceof da&&(e=e.doc),this.linked)for(var t=0;t<this.linked.length;++t){if(this.linked[t].doc==e){this.linked.splice(t,1),e.unlinkDoc(this),yo(vo(this));break}}if(e.history==this.history){var n=[e.id];kr(e,function(e){return n.push(e.id)},!0),e.history=new Fr(null),e.history.done=Pr(this.history.done,n),e.history.undone=Pr(this.history.undone,n)}},iterLinkedDocs:function(e){kr(this,e)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(e){return this.lineSep?e.split(this.lineSep):kt(e)},lineSeparator:function(){return File.useCRLF?"\r\n":"\n"},setDirection:qi(function(e){var t;("rtl"!=e&&(e="ltr"),e!=this.direction)&&(this.direction=e,this.iter(function(e){return e.order=null}),this.cm&&Hi(t=this.cm,function(){Tr(t),zi(t)}))})}),wo.prototype.eachLine=wo.prototype.iter;var xo=0;function Co(e){var r=this;if(ko(r),!st(r,e)&&!wn(r.display,e)){ut(e),x&&(xo=+new Date);var o=ni(r,e,!0),t=e.dataTransfer.files;if(o&&!r.isReadOnly())if(t&&t.length&&window.FileReader&&window.File)for(var a=t.length,s=Array(a),l=0,n=function(e,n){if(!r.options.allowDropFileTypes||-1!=$(r.options.allowDropFileTypes,e.type)){var i=new FileReader;i.onload=Ui(r,function(){var e=i.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(e)&&(e=""),s[n]=e,++l==a){var t={from:o=Ce(r.doc,o),to:o,text:r.doc.splitLines(s.join(r.doc.lineSeparator())),origin:"paste"};Xr(r.doc,t),Hr(r.doc,fr(o,gr(t)))}}),i.readAsText(e)}},i=0;i<a;++i)n(t[i],i);else{if(r.state.draggingText&&-1<r.doc.sel.contains(o))return r.state.draggingText(e),void setTimeout(function(){return r.display.input.focus()},20);try{var c=e.dataTransfer.getData("Text");if(c){var d;if(r.state.draggingText&&!r.state.draggingText.copy&&(d=r.listSelections()),Wr(r.doc,fr(o,o)),d)for(var u=0;u<d.length;++u)io(r.doc,"",d[u].anchor,d[u].head,"drag");r.replaceSelection(c,"around","paste"),r.display.input.focus()}}catch(e){}}}}function ko(e){e.display.dragCursor&&(e.display.lineSpace.removeChild(e.display.dragCursor),e.display.dragCursor=null)}function So(e){if(document.body.getElementsByClassName)for(var t=document.body.getElementsByClassName("CodeMirror"),n=0;n<t.length;n++){var i=t[n].CodeMirror;i&&e(i)}}var To=!1;function Fo(){var e;To||(it(window,"resize",function(){null==e&&(e=setTimeout(function(){e=null,So(Eo)},100))}),it(window,"blur",function(){return So(pi)}),To=!0)}function Eo(e){var t=e.display;t.lastWrapHeight==t.wrapper.clientHeight&&t.lastWrapWidth==t.wrapper.clientWidth||(t.cachedCharWidth=t.cachedTextHeight=t.cachedPaddingH=null,t.scrollbarsClipped=!1,e.setSize())}for(var _o={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",127:"Delete",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},Mo=0;Mo<10;Mo++)_o[Mo+48]=_o[Mo+96]=String(Mo);for(var No=65;No<=90;No++)_o[No]=String.fromCharCode(No);for(var Ao=1;Ao<=12;Ao++)_o[Ao+111]=_o[Ao+63235]="F"+Ao;var Lo={};function Io(e){var t,n,i,r,o=e.split(/-(?!$)/);e=o[o.length-1];for(var a=0;a<o.length-1;a++){var s=o[a];if(/^(cmd|meta|m)$/i.test(s))r=!0;else if(/^a(lt)?$/i.test(s))t=!0;else if(/^(c|ctrl|control)$/i.test(s))n=!0;else{if(!/^s(hift)?$/i.test(s))throw new Error("Unrecognized modifier name: "+s);i=!0}}return t&&(e="Alt-"+e),n&&(e="Ctrl-"+e),r&&(e="Cmd-"+e),i&&(e="Shift-"+e),e}function Ro(e){var t={};for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];if(/^(name|fallthrough|(de|at)tach)$/.test(n))continue;if("..."==i){delete e[n];continue}for(var r=Q(n.split(" "),Io),o=0;o<r.length;o++){var a=void 0,s=void 0;o==r.length-1?(s=r.join(" "),a=i):(s=r.slice(0,o+1).join(" "),a="...");var l=t[s];if(l){if(l!=a)throw new Error("Inconsistent bindings for "+s)}else t[s]=a}delete e[n]}for(var c in t)e[c]=t[c];return e}function Po(e,t,n,i){var r=(t=Bo(t)).call?t.call(e,i):t[e];if(!1===r)return"nothing";if("..."===r)return"multi";if(null!=r&&n(r))return"handled";if(t.fallthrough){if("[object Array]"!=Object.prototype.toString.call(t.fallthrough))return Po(e,t.fallthrough,n,i);for(var o=0;o<t.fallthrough.length;o++){var a=Po(e,t.fallthrough[o],n,i);if(a)return a}}}function Do(e){var t="string"==typeof e?e:_o[e.keyCode];return"Ctrl"==t||"Alt"==t||"Shift"==t||"Mod"==t}function Oo(e,t){if(m&&34==e.keyCode&&e.char)return!1;var n=_o[e.keyCode],i=n;return null!=i&&!e.altGraphKey&&(e.altKey&&"Alt"!=n&&(i="Alt-"+i),(y?e.metaKey:e.ctrlKey)&&"Ctrl"!=n&&(i="Ctrl-"+i),(y?e.ctrlKey:e.metaKey)&&"Cmd"!=n&&(i="Cmd-"+i),!t&&e.shiftKey&&"Shift"!=n&&(i="Shift-"+i),i)}function Bo(e){return"string"==typeof e?Lo[e]:e}function jo(t,e){for(var n=t.doc.sel.ranges,i=[],r=0;r<n.length;r++){for(var o=e(n[r]);i.length&&me(o.from,J(i).to)<=0;){var a=i.pop();if(me(a.from,o.from)<0){o.from=a.from;break}}i.push(o)}Hi(t,function(){for(var e=i.length-1;0<=e;e--)io(t.doc,"",i[e].from,i[e].to,"+delete");wi(t)})}Lo.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Lo.pcDefault={"Ctrl-A":"selectAll","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Lo.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Lo.macDefault={"Cmd-A":"selectAll","Cmd-Up":"goDocStart","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Lo.default=w?Lo.macDefault:Lo.pcDefault;var $o={selectAll:Qr,singleSelection:function(e){return e.setSelection(e.getCursor("anchor"),e.getCursor("head"),W)},killLine:function(n){return jo(n,function(e){if(e.empty()){var t=se(n.doc,e.head.line).text.length;return e.head.ch==t&&e.head.line<n.lastLine()?{from:e.head,to:ge(e.head.line+1,0)}:{from:e.head,to:ge(e.head.line,t)}}return{from:e.from(),to:e.to()}})},deleteLine:function(t){return jo(t,function(e){return{from:ge(e.from().line,0),to:Ce(t.doc,ge(e.to().line+1,0))}})},delLineLeft:function(e){return jo(e,function(e){return{from:ge(e.from().line,0),to:e.from()}})},delWrappedLineLeft:function(n){return jo(n,function(e){var t=n.charCoords(e.head,"div").top+5;return{from:n.coordsChar({left:0,top:t},"div"),to:e.from()}})},delWrappedLineRight:function(i){return jo(i,function(e){var t=i.charCoords(e.head,"div").top+5,n=i.coordsChar({left:i.display.lineDiv.offsetWidth+100,top:t},"div");return{from:e.from(),to:n}})},undo:function(e){return e.undo()},redo:function(e){return e.redo()},undoSelection:function(e){return e.undoSelection()},redoSelection:function(e){return e.redoSelection()},goDocStart:function(e){return e.extendSelection(ge(e.firstLine(),0))},goDocEnd:function(e){return e.extendSelection(ge(e.lastLine()))},goLineStart:function(t){return t.extendSelectionsBy(function(e){return Ho(t,e.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(t){return t.extendSelectionsBy(function(e){return Uo(t,e.head)},{origin:"+move",bias:1})},goLineEnd:function(t){return t.extendSelectionsBy(function(e){return function(e,t){var n=se(e.doc,t),i=function(e){for(var t;t=Be(e);)e=t.find(1,!0).line;return e}(n);i!=n&&(t=ue(i));return et(!0,e,n,t,-1)}(t,e.head.line)},{origin:"+move",bias:-1})},goLineRight:function(n){return n.extendSelectionsBy(function(e){var t=n.charCoords(e.head,"div").top+5;return n.coordsChar({left:n.display.lineDiv.offsetWidth+100,top:t},"div")},z)},goLineLeft:function(n){return n.extendSelectionsBy(function(e){var t=n.charCoords(e.head,"div").top+5;return n.coordsChar({left:0,top:t},"div")},z)},goLineLeftSmart:function(i){return i.extendSelectionsBy(function(e){var t=i.charCoords(e.head,"div").top+5,n=i.coordsChar({left:0,top:t},"div");return n.ch<i.getLine(n.line).search(/\S/)?Uo(i,e.head):n},z)},goLineUp:function(e){return e.moveV(-1,"line")},goLineDown:function(e){return e.moveV(1,"line")},goPageUp:function(e){return e.moveV(-1,"page")},goPageDown:function(e){return e.moveV(1,"page")},goCharLeft:function(e){return e.moveH(-1,"char")},goCharRight:function(e){return e.moveH(1,"char")},goColumnLeft:function(e){return e.moveH(-1,"column")},goColumnRight:function(e){return e.moveH(1,"column")},goWordLeft:function(e){return e.moveH(-1,"word")},goGroupRight:function(e){return e.moveH(1,"group")},goGroupLeft:function(e){return e.moveH(-1,"group")},goWordRight:function(e){return e.moveH(1,"word")},delCharBefore:function(e){return e.deleteH(-1,"char")},delCharAfter:function(e){return e.deleteH(1,"char")},delWordBefore:function(e){return e.deleteH(-1,"word")},delWordAfter:function(e){return e.deleteH(1,"word")},delGroupBefore:function(e){return e.deleteH(-1,"group")},delGroupAfter:function(e){return e.deleteH(1,"group")},indentAuto:function(e){return e.indentSelection("smart")},indentMore:function(e){return e.indentSelection("add")},indentLess:function(e){return e.indentSelection("subtract")},insertTab:function(e){return e.replaceSelection("\t")},insertSoftTab:function(e){for(var t=[],n=e.listSelections(),i=e.options.tabSize,r=0;r<n.length;r++){var o=n[r].from(),a=B(e.getLine(o.line),o.ch,i);t.push(Y(i-a%i))}e.replaceSelections(t)},defaultTab:function(e){e.somethingSelected()?e.indentSelection("add"):e.execCommand("insertTab")},transposeChars:function(a){return Hi(a,function(){for(var e=a.listSelections(),t=[],n=0;n<e.length;n++)if(e[n].empty()){var i=e[n].head,r=se(a.doc,i.line).text;if(r)if(i.ch==r.length&&(i=new ge(i.line,i.ch-1)),0<i.ch)i=new ge(i.line,i.ch+1),a.replaceRange(r.charAt(i.ch-1)+r.charAt(i.ch-2),ge(i.line,i.ch-2),i,"+transpose");else if(i.line>a.doc.first){var o=se(a.doc,i.line-1).text;o&&(i=new ge(i.line,1),a.replaceRange(r.charAt(0)+a.doc.lineSeparator()+o.charAt(o.length-1),ge(i.line-1,o.length-1),i,"+transpose"))}t.push(new pr(i,i))}a.setSelections(t)})},newlineAndIndent:function(i){return Hi(i,function(){for(var e=i.listSelections(),t=e.length-1;0<=t;t--)i.replaceRange(i.doc.lineSeparator(),e[t].anchor,e[t].head,"+input");e=i.listSelections();for(var n=0;n<e.length;n++)i.indentLine(e[n].from().line,null,!0);wi(i)})},openLine:function(e){return e.replaceSelection("\n","start")},toggleOverwrite:function(e){return e.toggleOverwrite()}};function Ho(e,t){var n=se(e.doc,t),i=$e(n);return i!=n&&(t=ue(i)),et(!0,e,i,t,1)}function Uo(e,t){var n=Ho(e,t.line),i=se(e.doc,n.line),r=Ge(i,e.doc.direction);if(!r||0==r[0].level){var o=Math.max(0,i.text.search(/\S/)),a=t.line==n.line&&t.ch<=o&&t.ch;return ge(n.line,a?0:o,n.sticky)}return n}function Wo(e,t,n){if("string"==typeof t&&!(t=$o[t]))return!1;e.display.input.ensurePolled();var i=e.display.shift,r=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),n&&(e.display.shift=!1),r=t(e)!=U}finally{e.display.shift=i,e.state.suppressEdits=!1}return r}var qo=new j;function zo(e,t,n,i){var r=e.state.keySeq;if(r){if(Do(t))return"handled";qo.set(50,function(){e.state.keySeq==r&&(e.state.keySeq=null,e.display.input.reset())}),t=r+" "+t}var o=function(e,t,n){for(var i=0;i<e.state.keyMaps.length;i++){var r=Po(t,e.state.keyMaps[i],n,e);if(r)return r}return e.options.extraKeys&&Po(t,e.options.extraKeys,n,e)||Po(t,e.options.keyMap,n,e)}(e,t,i);return"multi"==o&&(e.state.keySeq=t),"handled"==o&&sn(e,"keyHandled",e,t,n),"handled"!=o&&"multi"!=o||(ut(n),li(e)),r&&!o&&/\'$/.test(t)?(ut(n),!0):!!o}function Vo(t,e){var n=Oo(e,!0);return!!n&&(e.shiftKey&&!t.state.keySeq?zo(t,"Shift-"+n,e,function(e){return Wo(t,e,!0)})||zo(t,n,e,function(e){if("string"==typeof e?/^go[A-Z]/.test(e):e.motion)return Wo(t,e)}):zo(t,n,e,function(e){return Wo(t,e)}))}var Ko,Yo,Jo=null;function Qo(e){if(this.curOp.focus=L(),37==e.keyCode&&e.shiftKey,!st(this,e)){x&&C<11&&27==e.keyCode&&(e.returnValue=!1);var t=e.keyCode;this.display.shift=16==t||e.shiftKey;var n=Vo(this,e);m&&(Jo=n?t:null,!n&&88==t&&!Tt&&(w?e.metaKey:e.ctrlKey)&&this.replaceSelection("",null,"cut")),18!=t||/\bCodeMirror-crosshair\b/.test(this.display.lineDiv.className)||function(e){var t=e.display.lineDiv;function n(e){18!=e.keyCode&&e.altKey||(F(t,"CodeMirror-crosshair"),ot(document,"keyup",n),ot(document,"mouseover",n))}I(t,"CodeMirror-crosshair"),it(document,"keyup",n),it(document,"mouseover",n)}(this)}}function Go(e){16==e.keyCode&&(this.doc.sel.shift=!1),st(this,e)}function Xo(e){if(!(wn(this.display,e)||st(this,e)||e.ctrlKey&&!e.altKey||w&&e.metaKey)){var t=e.keyCode,n=e.charCode;if(m&&t==Jo)return Jo=null,void ut(e);if(!m||e.which&&!(e.which<10)||!Vo(this,e)){var i,r=String.fromCharCode(null==n?t:n);if("\b"!=r)if(!zo(i=this,"'"+r+"'",e,function(e){return Wo(i,e,!0)}))this.display.input.onKeyPress(e)}}}function Zo(e){var t=this,n=t.display;if(!(st(t,e)||n.activeTouch&&n.input.supportsTouch()))if(n.input.ensurePolled(),n.shift=e.shiftKey,wn(n,e))b||(n.scroller.draggable=!1,setTimeout(function(){return n.scroller.draggable=!0},100));else if(!ta(t,e)){var i=ni(t,e);switch(window.focus(),mt(e)){case 1:t.state.selectingText?t.state.selectingText(e):i?function(e,t,n){x?setTimeout(D(ci,e),0):e.curOp.focus=L();var i,r=+new Date;Yo&&Yo.time>r-400&&0==me(Yo.pos,n)?i="triple":Ko&&Ko.time>r-400&&0==me(Ko.pos,n)?(i="double",Yo={time:r,pos:n}):(i="single",Ko={time:r,pos:n});var o,a=e.doc.sel,s=w?t.metaKey:t.ctrlKey;e.options.dragDrop&&bt&&!e.isReadOnly()&&"single"==i&&-1<(o=a.contains(n))&&(me((o=a.ranges[o]).from(),n)<0||0<n.xRel)&&(0<me(o.to(),n)||n.xRel<0)?function(t,n,i,r){var o=t.display,a=!1,s=Ui(t,function(e){b&&(o.scroller.draggable=!1),t.state.draggingText=!1,ot(document,"mouseup",s),ot(document,"mousemove",l),ot(o.scroller,"dragstart",c),ot(o.scroller,"drop",s),a||(ut(e),r||Or(t.doc,i),b||x&&9==C?setTimeout(function(){document.body.focus(),o.input.focus()},20):o.input.focus())}),l=function(e){a=a||10<=Math.abs(n.clientX-e.clientX)+Math.abs(n.clientY-e.clientY)},c=function(){return a=!0};b&&(o.scroller.draggable=!0);(t.state.draggingText=s).copy=w?n.altKey:n.ctrlKey,o.scroller.dragDrop&&o.scroller.dragDrop();it(document,"mouseup",s),it(document,"mousemove",l),it(o.scroller,"dragstart",c),it(o.scroller,"drop",s),di(t),setTimeout(function(){return o.input.focus()},20)}(e,t,n,s):function(m,e,v,y,t){var o=m.display,b=m.doc;ut(e);var w,x,C=b.sel,n=C.ranges;t&&!e.shiftKey?(x=b.sel.contains(v),w=-1<x?n[x]:new pr(v,v)):(w=b.sel.primary(),x=b.sel.primIndex);if(h?e.shiftKey&&e.metaKey:e.altKey)y="rect",t||(w=new pr(v,v)),v=ni(m,e,!0,!0),x=-1;else if("double"==y){var i=m.findWordAt(v);w=m.display.shift||b.extend?Dr(b,w,i.anchor,i.head):i}else if("triple"==y){var r=new pr(ge(v.line,0),Ce(b,ge(v.line+1,0)));w=m.display.shift||b.extend?Dr(b,w,r.anchor,r.head):r}else w=Dr(b,w,v);t?-1==x?(x=n.length,Ur(b,hr(n.concat([w]),x),{scroll:!1,origin:"*mouse"})):1<n.length&&n[x].empty()&&"single"==y&&!e.shiftKey?(Ur(b,hr(n.slice(0,x).concat(n.slice(x+1)),0),{scroll:!1,origin:"*mouse"}),C=b.sel):jr(b,x,w,q):(Ur(b,new ur([w],x=0),q),C=b.sel);var k=v;var a=o.wrapper.getBoundingClientRect(),s=0;function l(e){var t=++s,n=ni(m,e,!0,"rect"==y);if(n)if(0!=me(n,k)){m.curOp.focus=L(),function(e){if(0==me(k,e))return;if(k=e,"rect"==y){for(var t=[],n=m.options.tabSize,i=B(se(b,v.line).text,v.ch,n),r=B(se(b,e.line).text,e.ch,n),o=Math.min(i,r),a=Math.max(i,r),s=Math.min(v.line,e.line),l=Math.min(m.lastLine(),Math.max(v.line,e.line));s<=l;s++){var c=se(b,s).text,d=V(c,o,n);o==a?t.push(new pr(ge(s,d),ge(s,d))):c.length>d&&t.push(new pr(ge(s,d),ge(s,V(c,a,n))))}t.length||t.push(new pr(v,v)),Ur(b,hr(C.ranges.slice(0,x).concat(t),x),{origin:"*mouse",scroll:!1}),m.scrollIntoView(e)}else{var u,p=w,h=p.anchor,f=e;if("single"!=y)0<me((u="double"==y?m.findWordAt(e):new pr(ge(e.line,0),Ce(b,ge(e.line+1,0)))).anchor,h)?(f=u.head,h=we(p.from(),u.anchor)):(f=u.anchor,h=be(p.to(),u.head));var g=C.ranges.slice(0);g[x]=new pr(Ce(b,h),f),Ur(b,hr(g,x),q)}}(n);var i=gi(o,b);(n.line>=i.to||n.line<i.from)&&setTimeout(Ui(m,function(){s==t&&l(e)}),150)}else{var r=e.clientY<a.top?-20:e.clientY>a.bottom?20:0;r&&setTimeout(Ui(m,function(){s==t&&(o.scroller.scrollTop+=r,l(e))}),50)}}function c(e){m.state.selectingText=!1,s=1/0,ut(e),o.input.focus(),ot(document,"mousemove",d),ot(document,"mouseup",u),b.history.lastSelOrigin=null}var d=Ui(m,function(e){mt(e)?l(e):c(e)}),u=Ui(m,c);m.state.selectingText=u,it(document,"mousemove",d),it(document,"mouseup",u)}(e,t,n,i,s)}(t,e,i):gt(e)==n.scroller&&ut(e);break;case 2:b&&(t.state.lastMiddleDown=+new Date),i&&Or(t.doc,i),setTimeout(function(){return n.input.focus()},20),ut(e);break;case 3:k?na(t,e):di(t)}}}function ea(e,t,n,i){var r,o;try{r=t.clientX,o=t.clientY}catch(t){return!1}if(r>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;i&&ut(t);var a=e.display,s=a.lineDiv.getBoundingClientRect();if(o>s.bottom||!ct(e,n))return ht(t);o-=s.top-a.viewOffset;for(var l=0;l<e.options.gutters.length;++l){var c=a.gutters.childNodes[l];if(c&&c.getBoundingClientRect().right>=r)return at(e,n,e,pe(e.doc,o),e.options.gutters[l],t),ht(t)}}function ta(e,t){return ea(e,t,"gutterClick",!0)}function na(e,t){wn(e.display,t)||function(e,t){if(!ct(e,"gutterContextMenu"))return!1;return ea(e,t,"gutterContextMenu",!1)}(e,t)||st(e,t,"contextmenu")||e.display.input.onContextMenu(t)}function ia(e){e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+e.options.theme.replace(/(^|\s)\s*/g," cm-s-"),Bn(e)}var ra={toString:function(){return"CodeMirror.Init"}},oa={},aa={};function sa(e){rr(e),zi(e),mi(e)}function la(e,t,n){if(!t!=!(n&&n!=ra)){var i=e.display.dragFunctions,r=t?it:ot;r(e.display.scroller,"dragstart",i.start),r(e.display.scroller,"dragenter",i.enter),r(e.display.scroller,"dragover",i.over),r(e.display.scroller,"dragleave",i.leave),r(e.display.scroller,"drop",i.drop)}}function ca(e){e.options.lineWrapping?(I(e.display.wrapper,"CodeMirror-wrap"),e.display.sizer.style.minWidth="",e.display.sizerWidth=null):(F(e.display.wrapper,"CodeMirror-wrap"),Ke(e)),ti(e),zi(e),Bn(e),setTimeout(function(){return Ni(e)},100)}function da(e,t,n,i){var r=this;if(!(this instanceof da))return new da(e,t,n,i);this.options=t=t?O(t):{},O(oa,t,!1),or(t);var o=t.value;"string"==typeof o&&(o=new wo(o,t.mode,null,t.lineSeparator,t.direction)),this.doc=o;var a=new da.inputStyles[t.inputStyle](this),s=this.display=new function(e,t,n){var i=this;this.input=n,i.scrollbarFiller=M("div",null,"CodeMirror-scrollbar-filler"),i.scrollbarFiller.setAttribute("cm-not-content","true"),i.gutterFiller=M("div",null,"CodeMirror-gutter-filler"),i.gutterFiller.setAttribute("cm-not-content","true"),i.lineDiv=N("div",null,"CodeMirror-code"),i.selectionDiv=M("div",null,null,"position: relative; z-index: 1"),i.cursorDiv=M("div",null,"CodeMirror-cursors"),i.measure=M("div",null,"CodeMirror-measure"),i.lineMeasure=M("div",null,"CodeMirror-measure"),i.lineSpace=N("div",[i.measure,i.lineMeasure,i.selectionDiv,i.cursorDiv,i.lineDiv],null,"position: relative; outline: none");var r=N("div",[i.lineSpace],"CodeMirror-lines");i.mover=M("div",[r],null,"position: relative"),i.sizer=M("div",[i.mover],"CodeMirror-sizer"),i.sizerWidth=null,i.heightForcer=M("div",null,null,"position: absolute; height: "+H+"px; width: 1px;"),i.gutters=M("div",null,"CodeMirror-gutters"),i.lineGutter=null,i.scroller=M("div",[i.sizer,i.heightForcer,i.gutters],"CodeMirror-scroll"),i.scroller.setAttribute("tabIndex","-1"),i.wrapper=M("div",[i.scrollbarFiller,i.gutterFiller,i.scroller],"CodeMirror"),x&&C<8&&(i.gutters.style.zIndex=-1,i.scroller.style.paddingRight=0),b||g&&p||(i.scroller.draggable=!0),e&&(e.appendChild?e.appendChild(i.wrapper):e(i.wrapper)),i.viewFrom=i.viewTo=t.first,i.reportedViewFrom=i.reportedViewTo=t.first,i.view=[],i.renderedView=null,i.externalMeasured=null,i.viewOffset=0,i.lastWrapHeight=i.lastWrapWidth=0,i.updateLineNumbers=null,i.nativeBarWidth=i.barHeight=i.barWidth=0,i.scrollbarsClipped=!1,i.lineNumWidth=i.lineNumInnerWidth=i.lineNumChars=null,i.alignWidgets=!1,i.cachedCharWidth=i.cachedTextHeight=i.cachedPaddingH=null,i.maxLine=null,i.maxLineLength=0,i.maxLineChanged=!1,i.wheelDX=i.wheelDY=i.wheelStartX=i.wheelStartY=null,i.shift=!1,i.selForContextMenu=null,i.activeTouch=null,n.init(i)}(e,o,a);for(var l in rr(s.wrapper.CodeMirror=this),ia(this),t.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),Ii(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,cutIncoming:!1,selectingText:!1,draggingText:!1,highlight:new j,keySeq:null,specialChars:null},t.autofocus&&!p&&s.input.focus(),x&&C<11&&setTimeout(function(){return r.display.input.reset(!0)},20),function(r){var o=r.display;it(o.scroller,"mousedown",Ui(r,Zo)),it(o.scroller,"dblclick",x&&C<11?Ui(r,function(e){if(!st(r,e)){var t=ni(r,e);if(t&&!ta(r,e)&&!wn(r.display,e)){ut(e);var n=r.findWordAt(t);Or(r.doc,n.anchor,n.head)}}}):function(e){return st(r,e)||ut(e)});k||it(o.scroller,"contextmenu",function(e){return na(r,e)});var n,i={end:0};function a(){o.activeTouch&&(n=setTimeout(function(){return o.activeTouch=null},1e3),(i=o.activeTouch).end=+new Date)}function s(e,t){if(null==t.left)return!0;var n=t.left-e.left,i=t.top-e.top;return 400<n*n+i*i}it(o.scroller,"touchstart",function(e){if(!st(r,e)&&!function(e){if(1!=e.touches.length)return!1;var t=e.touches[0];return t.radiusX<=1&&t.radiusY<=1}(e)){o.input.ensurePolled(),clearTimeout(n);var t=+new Date;o.activeTouch={start:t,moved:!1,prev:t-i.end<=300?i:null},1==e.touches.length&&(o.activeTouch.left=e.touches[0].pageX,o.activeTouch.top=e.touches[0].pageY)}}),it(o.scroller,"touchmove",function(){o.activeTouch&&(o.activeTouch.moved=!0)}),it(o.scroller,"touchend",function(e){var t=o.activeTouch;if(t&&!wn(o,e)&&null!=t.left&&!t.moved&&new Date-t.start<300){var n,i=r.coordsChar(o.activeTouch,"page");n=!t.prev||s(t,t.prev)?new pr(i,i):!t.prev.prev||s(t,t.prev.prev)?r.findWordAt(i):new pr(ge(i.line,0),Ce(r.doc,ge(i.line+1,0))),r.setSelection(n.anchor,n.head),r.focus(),ut(e)}a()}),it(o.scroller,"touchcancel",a),it(o.scroller,"scroll",function(){o.scroller.clientHeight&&(Si(r,o.scroller.scrollTop),Fi(r,o.scroller.scrollLeft,!0),at(r,"scroll",r))}),it(o.scroller,"mousewheel",function(e){return dr(r,e)}),it(o.scroller,"DOMMouseScroll",function(e){return dr(r,e)}),it(o.wrapper,"scroll",function(){return o.wrapper.scrollTop=o.wrapper.scrollLeft=0}),o.dragFunctions={enter:function(e){st(r,e)||ft(e)},over:function(e){st(r,e)||(!function(e,t){var n=ni(e,t);if(n){var i=document.createDocumentFragment();ai(e,n,i),e.display.dragCursor||(e.display.dragCursor=M("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),e.display.lineSpace.insertBefore(e.display.dragCursor,e.display.cursorDiv)),_(e.display.dragCursor,i)}}(r,e),ft(e))},start:function(e){return function(e,t){if(x&&(!e.state.draggingText||+new Date-xo<100))ft(t);else if(!st(e,t)&&!wn(e.display,t)&&(t.dataTransfer.setData("Text",e.getSelection()),t.dataTransfer.effectAllowed="copyMove",t.dataTransfer.setDragImage&&!d)){var n=M("img",null,null,"position: fixed; left: 0; top: 0;");n.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",m&&(n.width=n.height=1,e.display.wrapper.appendChild(n),n._top=n.offsetTop),t.dataTransfer.setDragImage(n,0,0),m&&n.parentNode.removeChild(n)}}(r,e)},drop:Ui(r,Co),leave:function(e){st(r,e)||ko(r)}};var e=o.input.getField();it(e,"keyup",function(e){return Go.call(r,e)}),it(e,"keydown",Ui(r,Qo)),it(e,"keypress",Ui(r,Xo)),it(e,"focus",function(e){return ui(r,e)}),it(e,"blur",function(e){return pi(r,e)})}(this),Fo(),Pi(this),this.curOp.forceUpdate=!0,Sr(this,o),t.autofocus&&!p||this.hasFocus()?setTimeout(D(ui,this),20):pi(this),aa)aa.hasOwnProperty(l)&&aa[l](r,t[l],ra);vi(this),t.finishInit&&t.finishInit(this);for(var c=0;c<ua.length;++c)ua[c](r);Di(this),b&&t.lineWrapping&&"optimizelegibility"==getComputedStyle(s.lineDiv).textRendering&&(s.lineDiv.style.textRendering="auto"),this.editor=n,this.cid=i}da.defaults=oa,da.optionHandlers=aa;var ua=[];function pa(e,t,n,i){var r,o=e.doc;null==n&&(n="add"),"smart"==n&&(o.mode.indent?r=jt(e,t):n="prev");var a=e.options.tabSize,s=se(o,t),l=B(s.text,null,a);s.stateAfter&&(s.stateAfter=null);var c,d=s.text.match(/^\s*/)[0];if(i||/\S/.test(s.text)){if("smart"==n&&((c=o.mode.indent(r,s.text.slice(d.length),s.text))==U||150<c)){if(!i)return;n="prev"}}else c=0,n="not";var u="",p=0;if("prev"==n?t>o.first?(c=B(u=se(o,t-1).text,null,a),u=d?"":u.match(/^\s*/)[0]):c=0:"add"==n?c=l+e.options.indentUnit:"subtract"==n?c=l-e.options.indentUnit:"number"==typeof n&&(c=l+n),c=Math.max(0,c),u&&!d);else{if(u="",e.options.indentWithTabs)for(var h=Math.floor(c/a);h;--h)p+=a,u+="\t";p<c&&(u+=Y(c-p))}if(u!=d)return io(o,u,ge(t,0),ge(t,d.length),"+input"),s.stateAfter=null,!0;for(var f=0;f<o.sel.ranges.length;f++){var g=o.sel.ranges[f];if(g.head.line==t&&g.head.ch<d.length){var m=ge(t,d.length);jr(o,f,new pr(m,m));break}}}da.defineInitHook=function(e){return ua.push(e)};var ha=null;function fa(e){ha=e}function ga(e,t,n,i,r){var o=e.doc;e.display.shift=!1,i||(i=o.sel);var a,s=e.state.pasteIncoming||"paste"==r,l=kt(t),c=null;if(s&&1<i.ranges.length)if(ha&&ha.text.join("\n")==t){if(i.ranges.length%ha.text.length==0){c=[];for(var d=0;d<ha.text.length;d++)c.push(o.splitLines(ha.text[d]))}}else l.length==i.ranges.length&&(c=Q(l,function(e){return[e]}));for(var u=i.ranges.length-1;0<=u;u--){var p=i.ranges[u],h=p.from(),f=p.to();p.empty()&&(n&&0<n?h=ge(h.line,h.ch-n):e.state.overwrite&&!s?f=ge(f.line,Math.min(se(o,f.line).text.length,f.ch+J(l).length)):ha&&ha.lineWise&&ha.text.join("\n")==t&&(h=f=ge(h.line,0))),a=e.curOp.updateInput;var g={from:h,to:f,text:c?c[u%c.length]:l,origin:r||(s?"paste":e.state.cutIncoming?"cut":"+input")};Xr(e.doc,g),sn(e,"inputRead",e,g)}t&&!s&&va(e,t),wi(e),e.curOp.updateInput=a,e.curOp.typing=!0,e.state.pasteIncoming=e.state.cutIncoming=!1}function ma(e,t){var n=e.clipboardData&&e.clipboardData.getData("Text");if(n)return e.preventDefault(),t.isReadOnly()||t.options.disableInput||Hi(t,function(){return ga(t,n,0,null,"paste")}),!0}function va(e,t){if(e.options.electricChars&&e.options.smartIndent)for(var n=e.doc.sel,i=n.ranges.length-1;0<=i;i--){var r=n.ranges[i];if(!(100<r.head.ch||i&&n.ranges[i-1].head.line==r.head.line)){var o=e.getModeAt(r.head),a=!1;if(o.electricChars){for(var s=0;s<o.electricChars.length;s++)if(-1<t.indexOf(o.electricChars.charAt(s))){a=pa(e,r.head.line,"smart");break}}else o.electricInput&&o.electricInput.test(se(e.doc,r.head.line).text.slice(0,r.head.ch))&&(a=pa(e,r.head.line,"smart"));a&&sn(e,"electricInput",e,r.head.line)}}}function ya(e){for(var t=[],n=[],i=0;i<e.doc.sel.ranges.length;i++){var r=e.doc.sel.ranges[i].head.line,o={anchor:ge(r,0),head:ge(r+1,0)};n.push(o),t.push(e.getRange(o.anchor,o.head))}return{text:t,ranges:n}}function ba(e,t){e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!!t)}function wa(){var e=M("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),t=M("div",[e],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return b?e.style.width="1000px":e.setAttribute("wrap","off"),c&&(e.style.border="1px solid black"),ba(e),t}function xa(i,r,o,e,a){var t=r,n=o,s=se(i,r.line);function l(e){var t,n;if(null==(t=a?tt(i.cm,s,r,o):Ze(s,r,o))){if(e||(n=r.line+o)<i.first||n>=i.first+i.size||(r=new ge(n,r.ch,r.sticky),!(s=se(i,n))))return!1;r=et(a,i.cm,s,r.line,o)}else r=t;return!0}if("char"==e)l();else if("column"==e)l(!0);else if("word"==e||"group"==e)for(var c=null,d="group"==e,u=i.cm&&i.cm.getHelper(r,"wordChars"),p=!0;!(o<0)||l(!p);p=!1){var h=s.text.charAt(r.ch)||"\n",f=te(h,u)?"w":d&&"\n"==h?"n":!d||/\s/.test(h)?null:"p";if(!d||p||f||(f="s"),c&&c!=f){o<0&&(o=1,l(),r.sticky="after");break}if(f&&(c=f),0<o&&!l(!p))break}var g=Yr(i,r,t,n,!0);return ve(t,g)&&(g.hitSide=!0),g}function Ca(e,t,n,i){var r,o,a=e.doc,s=t.left;if("page"==i){var l=Math.min(e.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),c=Math.max(l-.5*Qn(e.display),3);r=(0<n?t.bottom:t.top)+n*c}else"line"==i&&(r=0<n?t.bottom+3:t.top-3);for(;(o=Kn(e,s,r)).outside;){if(n<0?r<=0:r>=a.height){o.hitSide=!0;break}r+=5*n}return o}var ka=function(e){this.cm=e,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new j,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};function Sa(e,t){var n=Mn(e,t.line);if(!n||n.hidden)return null;var i=se(e.doc,t.line),r=En(n,i,t.line),o=Ge(i,e.doc.direction),a="left";o&&(a=Je(o,t.ch)%2?"right":"left");var s=Rn(r.map,t.ch,a);return s.offset="right"==s.collapse?s.end:s.start,s}function Ta(e,t){return t&&(e.bad=!0),e}function Fa(e,t,n){var i;if(t==e.display.lineDiv){if(!(i=e.display.lineDiv.childNodes[n]))return Ta(e.clipPos(ge(e.display.viewTo-1)),!0);t=null,n=0}else for(i=t;;i=i.parentNode){if(!i||i==e.display.lineDiv)return null;if(i.parentNode&&i.parentNode==e.display.lineDiv)break}for(var r=0;r<e.display.view.length;r++){var o=e.display.view[r];if(o.node==i)return Ea(o,t,n)}}function Ea(c,e,t){var n=c.text.firstChild,i=!1;if(!e||!A(n,e))return Ta(ge(ue(c.line),0),!0);if(e==n&&(i=!0,e=n.childNodes[t],t=0,!e)){var r=c.rest?J(c.rest):c.line;return Ta(ge(ue(r),r.text.length),i)}var o=3==e.nodeType?e:null,a=e;for(o||1!=e.childNodes.length||3!=e.firstChild.nodeType||(o=e.firstChild,t&&(t=o.nodeValue.length));a.parentNode!=n;)a=a.parentNode;var d=c.measure,u=d.maps;function s(e,t,n){for(var i=-1;i<(u?u.length:0);i++)for(var r=i<0?d.map:u[i],o=0;o<r.length;o+=3){var a=r[o+2];if(a==e||a==t){var s=ue(i<0?c.line:c.rest[i]),l=r[o]+n;return(n<0||a!=e)&&(l=r[o+(n?1:0)]),ge(s,l)}}}var l=s(o,a,t);if(l)return Ta(l,i);for(var p=a.nextSibling,h=o?o.nodeValue.length-t:0;p;p=p.nextSibling){if(l=s(p,p.firstChild,0))return Ta(ge(l.line,l.ch-h),i);h+=p.textContent.length}for(var f=a.previousSibling,g=t;f;f=f.previousSibling){if(l=s(f,f.firstChild,-1))return Ta(ge(l.line,l.ch+g),i);g+=f.textContent.length}}ka.prototype.init=function(e){var t=this,a=this,s=a.cm,l=a.div=e.lineDiv;function n(e){if(!st(s,e)){if(s.somethingSelected())fa({lineWise:!1,text:s.getSelections()}),"cut"==e.type&&s.replaceSelection("",null,"cut");else{if(!s.options.lineWiseCopyCut)return;var t=ya(s);fa({lineWise:!0,text:t.text}),"cut"==e.type&&s.operation(function(){s.setSelections(t.ranges,0,W),s.replaceSelection("",null,"cut")})}if(e.clipboardData){e.clipboardData.clearData();var n=ha.text.join("\n");if(e.clipboardData.setData("Text",n),e.clipboardData.getData("Text")==n)return void e.preventDefault()}var i=wa(),r=i.firstChild;s.display.lineSpace.insertBefore(i,s.display.lineSpace.firstChild),r.value=ha.text.join("\n");var o=document.activeElement;P(r),setTimeout(function(){s.display.lineSpace.removeChild(i),o.focus(),o==l&&a.showPrimarySelection()},50)}}ba(l,s.options.spellcheck),it(l,"paste",function(e){st(s,e)||ma(e,s)||C<=11&&setTimeout(Ui(s,function(){return t.updateFromDOM()}),20)}),it(l,"compositionstart",function(e){t.composing={data:e.data,done:!1}}),it(l,"compositionupdate",function(e){t.composing||(t.composing={data:e.data,done:!1})}),it(l,"compositionend",function(e){t.composing&&(e.data!=t.composing.data&&t.readFromDOMSoon(),t.composing.done=!0)}),it(l,"touchstart",function(){return a.forceCompositionEnd()}),it(l,"input",function(){t.composing||t.readFromDOMSoon()}),it(l,"copy",n),it(l,"cut",n)},ka.prototype.prepareSelection=function(){var e=oi(this.cm,!1);return e.focus=this.cm.state.focused,e},ka.prototype.showSelection=function(e,t){e&&this.cm.display.view.length&&((e.focus||t)&&this.showPrimarySelection(),this.showMultipleSelections(e))},ka.prototype.showPrimarySelection=function(){var e=window.getSelection(),t=this.cm,n=t.doc.sel.primary(),i=n.from(),r=n.to();if(t.display.viewTo==t.display.viewFrom||i.line>=t.display.viewTo||r.line<t.display.viewFrom)e.removeAllRanges();else{var o=Fa(t,e.anchorNode,e.anchorOffset),a=Fa(t,e.focusNode,e.focusOffset);if(!o||o.bad||!a||a.bad||0!=me(we(o,a),i)||0!=me(be(o,a),r)){var s=t.display.view,l=i.line>=t.display.viewFrom&&Sa(t,i)||{node:s[0].measure.map[2],offset:0},c=r.line<t.display.viewTo&&Sa(t,r);if(!c){var d=s[s.length-1].measure,u=d.maps?d.maps[d.maps.length-1]:d.map;c={node:u[u.length-1],offset:u[u.length-2]-u[u.length-3]}}if(l&&c){var p,h=e.rangeCount&&e.getRangeAt(0);try{p=T(l.node,l.offset,c.offset,c.node)}catch(e){}p&&(!g&&t.state.focused?(e.collapse(l.node,l.offset),p.collapsed||(e.removeAllRanges(),e.addRange(p))):(e.removeAllRanges(),e.addRange(p)),h&&null==e.anchorNode?e.addRange(h):g&&this.startGracePeriod()),this.rememberSelection()}else e.removeAllRanges()}}},ka.prototype.startGracePeriod=function(){var e=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){e.gracePeriod=!1,e.selectionChanged()&&e.cm.operation(function(){return e.cm.curOp.selectionChanged=!0})},20)},ka.prototype.showMultipleSelections=function(e){_(this.cm.display.cursorDiv,e.cursors),_(this.cm.display.selectionDiv,e.selection)},ka.prototype.rememberSelection=function(){var e=window.getSelection();this.lastAnchorNode=e.anchorNode,this.lastAnchorOffset=e.anchorOffset,this.lastFocusNode=e.focusNode,this.lastFocusOffset=e.focusOffset},ka.prototype.selectionInEditor=function(){var e=window.getSelection();if(!e.rangeCount)return!1;var t=e.getRangeAt(0).commonAncestorContainer;return A(this.div,t)},ka.prototype.focus=function(){"nocursor"!=this.cm.options.readOnly&&(this.selectionInEditor()||this.showSelection(this.prepareSelection(),!0),this.div.focus())},ka.prototype.blur=function(){this.div.blur()},ka.prototype.getField=function(){return this.div},ka.prototype.supportsTouch=function(){return!0},ka.prototype.receivedFocus=function(){var t=this;this.selectionInEditor()?this.pollSelection():Hi(this.cm,function(){return t.cm.curOp.selectionChanged=!0}),this.polling.set(this.cm.options.pollInterval,function e(){t.cm.state.focused&&(t.pollSelection(),t.polling.set(t.cm.options.pollInterval,e))})},ka.prototype.selectionChanged=function(){var e=window.getSelection();return e.anchorNode!=this.lastAnchorNode||e.anchorOffset!=this.lastAnchorOffset||e.focusNode!=this.lastFocusNode||e.focusOffset!=this.lastFocusOffset},ka.prototype.pollSelection=function(){if(null==this.readDOMTimeout&&!this.gracePeriod&&this.selectionChanged()){var e=window.getSelection(),t=this.cm;if(u&&a&&this.cm.options.gutters.length&&function(e){for(var t=e;t;t=t.parentNode)if(/CodeMirror-gutter-wrapper/.test(t.className))return!0;return!1}(e.anchorNode))return this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),void this.focus();if(!this.composing){this.rememberSelection();var n=Fa(t,e.anchorNode,e.anchorOffset),i=Fa(t,e.focusNode,e.focusOffset);n&&i&&Hi(t,function(){Ur(t.doc,fr(n,i),W),(n.bad||i.bad)&&(t.curOp.selectionChanged=!0)})}}},ka.prototype.pollContent=function(){null!=this.readDOMTimeout&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var e,t,n,i=this.cm,r=i.display,o=i.doc.sel.primary(),a=o.from(),s=o.to();if(0==a.ch&&a.line>i.firstLine()&&(a=ge(a.line-1,se(i.doc,a.line-1).length)),s.ch==se(i.doc,s.line).text.length&&s.line<i.lastLine()&&(s=ge(s.line+1,0)),a.line<r.viewFrom||s.line>r.viewTo-1)return!1;a.line==r.viewFrom||0==(e=ii(i,a.line))?(t=ue(r.view[0].line),n=r.view[0].node):(t=ue(r.view[e].line),n=r.view[e-1].node.nextSibling);var l,c,d=ii(i,s.line);if(d==r.view.length-1?(l=r.viewTo-1,c=r.lineDiv.lastChild):(l=ue(r.view[d+1].line)-1,c=r.view[d+1].node.previousSibling),!n)return!1;for(var u=i.doc.splitLines(function(l,e,t,c,d){var n="",u=!1,p=l.doc.lineSeparator();function h(){u&&(n+=p,u=!1)}function f(e){e&&(h(),n+=e)}function g(e){if(1==e.nodeType){var t=e.getAttribute("cm-text");if(null!=t)return void f(t||e.textContent.replace(/\u200b/g,""));var n,i=e.getAttribute("cm-marker");if(i){var r=l.findMarks(ge(c,0),ge(d+1,0),(s=+i,function(e){return e.id==s}));return void(r.length&&(n=r[0].find())&&f(le(l.doc,n.from,n.to).join(p)))}if("false"==e.getAttribute("contenteditable"))return;var o=/^(pre|div|p)$/i.test(e.nodeName);o&&h();for(var a=0;a<e.childNodes.length;a++)g(e.childNodes[a]);o&&(u=!0)}else 3==e.nodeType&&f(e.nodeValue);var s}for(;g(e),e!=t;)e=e.nextSibling;return n}(i,n,c,t,l)),p=le(i.doc,ge(t,0),ge(l,se(i.doc,l).text.length));1<u.length&&1<p.length;)if(J(u)==J(p))u.pop(),p.pop(),l--;else{if(u[0]!=p[0])break;u.shift(),p.shift(),t++}for(var h=0,f=0,g=u[0],m=p[0],v=Math.min(g.length,m.length);h<v&&g.charCodeAt(h)==m.charCodeAt(h);)++h;for(var y=J(u),b=J(p),w=Math.min(y.length-(1==u.length?h:0),b.length-(1==p.length?h:0));f<w&&y.charCodeAt(y.length-f-1)==b.charCodeAt(b.length-f-1);)++f;if(1==u.length&&1==p.length&&t==a.line)for(;h&&h>a.ch&&y.charCodeAt(y.length-f-1)==b.charCodeAt(b.length-f-1);)h--,f++;u[u.length-1]=y.slice(0,y.length-f).replace(/^\u200b+/,""),u[0]=u[0].slice(h).replace(/\u200b+$/,"");var x=ge(t,h),C=ge(l,p.length?J(p).length-f:0);return 1<u.length||u[0]||me(x,C)?(io(i.doc,u,x,C,"+input"),!0):void 0},ka.prototype.ensurePolled=function(){this.forceCompositionEnd()},ka.prototype.reset=function(){this.forceCompositionEnd()},ka.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},ka.prototype.readFromDOMSoon=function(){var e=this;null==this.readDOMTimeout&&(this.readDOMTimeout=setTimeout(function(){if(e.readDOMTimeout=null,e.composing){if(!e.composing.done)return;e.composing=null}e.updateFromDOM()},80))},ka.prototype.updateFromDOM=function(){var e=this;!this.cm.isReadOnly()&&this.pollContent()||Hi(this.cm,function(){return zi(e.cm)})},ka.prototype.setUneditable=function(e){e.contentEditable="false"},ka.prototype.onKeyPress=function(e){0!=e.charCode&&(e.preventDefault(),this.cm.isReadOnly()||Ui(this.cm,ga)(this.cm,String.fromCharCode(null==e.charCode?e.keyCode:e.charCode),0))},ka.prototype.readOnlyChanged=function(e){this.div.contentEditable=String("nocursor"!=e)},ka.prototype.onContextMenu=function(){},ka.prototype.resetPosition=function(){},ka.prototype.needsContentAttribute=!0;var _a,Ma,Na,Aa=function(e){this.cm=e,this.prevInput="",this.pollingFast=!1,this.polling=new j,this.inaccurateSelection=!1,this.hasSelection=!1,this.composing=null};Aa.prototype.init=function(t){var e=this,n=this,i=this.cm,r=this.wrapper=wa(),o=this.textarea=r.firstChild;function a(e){if(!st(i,e)){if(i.somethingSelected())fa({lineWise:!1,text:i.getSelections()}),n.inaccurateSelection&&(n.prevInput="",n.inaccurateSelection=!1,o.value=ha.text.join("\n"),P(o));else{if(!i.options.lineWiseCopyCut)return;var t=ya(i);fa({lineWise:!0,text:t.text}),"cut"==e.type?i.setSelections(t.ranges,null,W):(n.prevInput="",o.value=t.text.join("\n"),P(o))}"cut"==e.type&&(i.state.cutIncoming=!0)}}t.wrapper.insertBefore(r,t.wrapper.firstChild),c&&(o.style.width="0px"),it(o,"input",function(){x&&9<=C&&e.hasSelection&&(e.hasSelection=null),n.poll()}),it(o,"paste",function(e){st(i,e)||ma(e,i)||(i.state.pasteIncoming=!0,n.fastPoll())}),it(o,"cut",a),it(o,"copy",a),it(t.scroller,"paste",function(e){wn(t,e)||st(i,e)||(i.state.pasteIncoming=!0,n.focus())}),it(t.lineSpace,"selectstart",function(e){wn(t,e)||ut(e)}),it(o,"compositionstart",function(){var e=i.getCursor("from");n.composing&&n.composing.range.clear(),n.composing={start:e,range:i.markText(e,i.getCursor("to"),{className:"CodeMirror-composing"})}}),it(o,"compositionend",function(){n.composing&&(n.poll(),n.composing.range.clear(),n.composing=null)})},Aa.prototype.prepareSelection=function(){var e=this.cm,t=e.display,n=e.doc,i=oi(e);if(e.options.moveInputWithCursor){var r=qn(e,n.sel.primary().head,"div"),o=t.wrapper.getBoundingClientRect(),a=t.lineDiv.getBoundingClientRect();i.teTop=Math.max(0,Math.min(t.wrapper.clientHeight-10,r.top+a.top-o.top)),i.teLeft=Math.max(0,Math.min(t.wrapper.clientWidth-10,r.left+a.left-o.left))}return i},Aa.prototype.showSelection=function(e){var t=this.cm.display;_(t.cursorDiv,e.cursors),_(t.selectionDiv,e.selection),null!=e.teTop&&(this.wrapper.style.top=e.teTop+"px",this.wrapper.style.left=e.teLeft+"px")},Aa.prototype.reset=function(e){if(!this.contextMenuPending&&!this.composing){var t,n,i=this.cm,r=i.doc;if(i.somethingSelected()){this.prevInput="";var o=r.sel.primary(),a=(t=Tt&&(100<o.to().line-o.from().line||1e3<(n=i.getSelection()).length))?"-":n||i.getSelection();this.textarea.value=a,i.state.focused&&P(this.textarea),x&&9<=C&&(this.hasSelection=a)}else e||(this.prevInput=this.textarea.value="",x&&9<=C&&(this.hasSelection=null));this.inaccurateSelection=t}},Aa.prototype.getField=function(){return this.textarea},Aa.prototype.supportsTouch=function(){return!1},Aa.prototype.focus=function(){if("nocursor"!=this.cm.options.readOnly&&(!p||L()!=this.textarea))try{this.textarea.focus()}catch(e){}},Aa.prototype.blur=function(){this.textarea.blur()},Aa.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Aa.prototype.receivedFocus=function(){this.slowPoll()},Aa.prototype.slowPoll=function(){var e=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){e.poll(),e.cm.state.focused&&e.slowPoll()})},Aa.prototype.fastPoll=function(){var t=!1,n=this;n.pollingFast=!0,n.polling.set(20,function e(){n.poll()||t?(n.pollingFast=!1,n.slowPoll()):(t=!0,n.polling.set(60,e))})},Aa.prototype.poll=function(){var e=this,t=this.cm,n=this.textarea,i=this.prevInput;if(this.contextMenuPending||!t.state.focused||St(n)&&!i&&!this.composing||t.isReadOnly()||t.options.disableInput||t.state.keySeq)return!1;var r=n.value;if(r==i&&!t.somethingSelected())return!1;if(x&&9<=C&&this.hasSelection===r||w&&/[\uf700-\uf7ff]/.test(r))return t.display.input.reset(),!1;if(t.doc.sel==t.display.selForContextMenu){var o=r.charCodeAt(0);if(8203!=o||i||(i="​"),8666==o)return this.reset(),this.cm.execCommand("undo")}for(var a=0,s=Math.min(i.length,r.length);a<s&&i.charCodeAt(a)==r.charCodeAt(a);)++a;return Hi(t,function(){ga(t,r.slice(a),i.length-a,null,e.composing?"*compose":null),1e3<r.length||-1<r.indexOf("\n")?n.value=e.prevInput="":e.prevInput=r,e.composing&&(e.composing.range.clear(),e.composing.range=t.markText(e.composing.start,t.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Aa.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Aa.prototype.onKeyPress=function(){x&&9<=C&&(this.hasSelection=null),this.fastPoll()},Aa.prototype.onContextMenu=function(e){var n=this,i=n.cm,r=i.display,o=n.textarea,t=ni(i,e),a=r.scroller.scrollTop;if(t&&!m){i.options.resetSelectionOnContextMenu&&-1==i.doc.sel.contains(t)&&Ui(i,Ur)(i.doc,fr(t),W);var s=o.style.cssText,l=n.wrapper.style.cssText;n.wrapper.style.cssText="position: absolute";var c,d=n.wrapper.getBoundingClientRect();if(o.style.cssText="position: absolute; width: 30px; height: 30px;\n      top: "+(e.clientY-d.top-5)+"px; left: "+(e.clientX-d.left-5)+"px;\n      z-index: 1000; background: "+(x?"rgba(255, 255, 255, .05)":"transparent")+";\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);",b&&(c=window.scrollY),r.input.focus(),b&&window.scrollTo(null,c),r.input.reset(),i.somethingSelected()||(o.value=n.prevInput=" "),n.contextMenuPending=!0,r.selForContextMenu=i.doc.sel,clearTimeout(r.detectingSelectAll),x&&9<=C&&p(),k){ft(e);var u=function(){ot(window,"mouseup",u),setTimeout(h,20)};it(window,"mouseup",u)}else setTimeout(h,50)}function p(){if(null!=o.selectionStart){var e=i.somethingSelected(),t="​"+(e?o.value:"");o.value="⇚",o.value=t,n.prevInput=e?"":"​",o.selectionStart=1,o.selectionEnd=t.length,r.selForContextMenu=i.doc.sel}}function h(){if(n.contextMenuPending=!1,n.wrapper.style.cssText=l,o.style.cssText=s,x&&C<9&&r.scrollbars.setScrollTop(r.scroller.scrollTop=a),null!=o.selectionStart){(!x||x&&C<9)&&p();var e=0,t=function(){r.selForContextMenu==i.doc.sel&&0==o.selectionStart&&0<o.selectionEnd&&"​"==n.prevInput?Ui(i,Qr)(i):e++<10?r.detectingSelectAll=setTimeout(t,500):(r.selForContextMenu=null,r.input.reset())};r.detectingSelectAll=setTimeout(t,200)}}},Aa.prototype.readOnlyChanged=function(e){e||this.reset()},Aa.prototype.setUneditable=function(){},Aa.prototype.needsContentAttribute=!1,function(r){var o=r.optionHandlers;function e(e,t,i,n){r.defaults[e]=t,i&&(o[e]=n?function(e,t,n){n!=ra&&i(e,t,n)}:i)}r.defineOption=e,r.Init=ra,e("value","",function(e,t){return e.setValue(t)},!0),e("mode",null,function(e,t){e.doc.modeOption=t,br(e)},!0),e("indentUnit",2,br,!0),e("indentWithTabs",!1),e("smartIndent",!0),e("tabSize",4,function(e){wr(e),Bn(e),zi(e)},!0),e("lineSeparator",null,function(e,i){if(e.doc.lineSep=i){var r=[],o=e.doc.first;e.doc.iter(function(e){for(var t=0;;){var n=e.text.indexOf(i,t);if(-1==n)break;t=n+i.length,r.push(ge(o,n))}o++});for(var t=r.length-1;0<=t;t--)io(e.doc,i,r[t],ge(r[t].line,r[t].ch+i.length))}}),e("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b-\u200f\u2028\u2029\ufeff]/g,function(e,t,n){e.state.specialChars=new RegExp(t.source+(t.test("\t")?"":"|\t"),"g"),n!=ra&&e.refresh()}),e("specialCharPlaceholder",Gt,function(e){return e.refresh()},!0),e("electricChars",!0),e("inputStyle",p?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),e("spellcheck",!1,function(e,t){return e.getInputField().spellcheck=t},!0),e("rtlMoveVisually",!f),e("wholeLineUpdateBefore",!0),e("theme","default",function(e){ia(e),sa(e)},!0),e("keyMap","default",function(e,t,n){var i=Bo(t),r=n!=ra&&Bo(n);r&&r.detach&&r.detach(e,i),i.attach&&i.attach(e,r||null)}),e("extraKeys",null),e("lineWrapping",!1,ca,!0),e("gutters",[],function(e){or(e.options),sa(e)},!0),e("fixedGutter",!0,function(e,t){e.display.gutters.style.left=t?Zn(e.display)+"px":"0",e.refresh()},!0),e("coverGutterNextToScrollbar",!1,function(e){return Ni(e)},!0),e("scrollbarStyle","native",function(e){Ii(e),Ni(e),e.display.scrollbars.setScrollTop(e.doc.scrollTop),e.display.scrollbars.setScrollLeft(e.doc.scrollLeft)},!0),e("lineNumbers",!1,function(e){or(e.options),sa(e)},!0),e("firstLineNumber",1,sa,!0),e("lineNumberFormatter",function(e){return e},sa,!0),e("showCursorWhenSelecting",!1,ri,!0),e("resetSelectionOnContextMenu",!0),e("lineWiseCopyCut",!0),e("readOnly",!1,function(e,t){"nocursor"==t?(pi(e),e.display.input.blur(),e.display.disabled=!0):e.display.disabled=!1,e.display.input.readOnlyChanged(t)}),e("disableInput",!1,function(e,t){t||e.display.input.reset()},!0),e("dragDrop",!0,la),e("allowDropFileTypes",null),e("cursorBlinkRate",530),e("cursorScrollMargin",0),e("cursorHeight",1,ri,!0),e("singleCursorHeightPerLine",!0,ri,!0),e("workTime",100),e("workDelay",100),e("flattenSpans",!0,wr,!0),e("addModeClass",!1,wr,!0),e("pollInterval",100),e("undoDepth",200,function(e,t){return e.doc.history.undoDepth=t}),e("historyEventDelay",1250),e("viewportMargin",10,function(e){return e.refresh()},!0),e("maxHighlightLength",1e4,wr,!0),e("moveInputWithCursor",!0,function(e,t){t||e.display.input.resetPosition()}),e("tabindex",null,function(e,t){return e.display.input.getField().tabIndex=t||""}),e("autofocus",null),e("direction","ltr",function(e,t){return e.doc.setDirection(t)},!0)}(da),Ma=(_a=da).optionHandlers,Na=_a.helpers={},_a.prototype={constructor:_a,focus:function(){window.focus(),this.display.input.focus()},setOption:function(e,t){var n=this.options,i=n[e];n[e]==t&&"mode"!=e||(n[e]=t,Ma.hasOwnProperty(e)&&Ui(this,Ma[e])(this,t,i),at(this,"optionChange",this,e))},getOption:function(e){return this.options[e]},getDoc:function(){return this.doc},addKeyMap:function(e,t){this.state.keyMaps[t?"push":"unshift"](Bo(e))},removeKeyMap:function(e){for(var t=this.state.keyMaps,n=0;n<t.length;++n)if(t[n]==e||t[n].name==e)return t.splice(n,1),!0},addOverlay:Wi(function(e,t){var n=e.token?e:_a.getMode(this.options,e);if(n.startState)throw new Error("Overlays may not be stateful.");!function(e,t,n){for(var i=0,r=n(t);i<e.length&&n(e[i])<=r;)i++;e.splice(i,0,t)}(this.state.overlays,{mode:n,modeSpec:e,opaque:t&&t.opaque,priority:t&&t.priority||0},function(e){return e.priority}),this.state.modeGen++,zi(this)}),removeOverlay:Wi(function(e){for(var t=this.state.overlays,n=0;n<t.length;++n){var i=t[n].modeSpec;if(i==e||"string"==typeof e&&i.name==e)return t.splice(n,1),this.state.modeGen++,void zi(this)}}),indentLine:Wi(function(e,t,n){"string"!=typeof t&&"number"!=typeof t&&(t=null==t?this.options.smartIndent?"smart":"prev":t?"add":"subtract"),he(this.doc,e)&&pa(this,e,t,n)}),indentSelection:Wi(function(e){for(var t=this.doc.sel.ranges,n=-1,i=0;i<t.length;i++){var r=t[i];if(r.empty())r.head.line>n&&(pa(this,r.head.line,e,!0),n=r.head.line,i==this.doc.sel.primIndex&&wi(this));else{var o=r.from(),a=r.to(),s=Math.max(n,o.line);n=Math.min(this.lastLine(),a.line-(a.ch?0:1))+1;for(var l=s;l<n;++l)pa(this,l,e);var c=this.doc.sel.ranges;0==o.ch&&t.length==c.length&&0<c[i].from().ch&&jr(this.doc,i,new pr(o,c[i].to()),W)}}}),getTokenAt:function(e,t){return Wt(this,e,t)},getLineTokens:function(e,t){return Wt(this,ge(e),t,!0)},getTokenTypeAt:function(e){e=Ce(this.doc,e);var t,n=Bt(this,se(this.doc,e.line)),i=0,r=(n.length-1)/2,o=e.ch;if(0==o)t=n[2];else for(;;){var a=i+r>>1;if((a?n[2*a-1]:0)>=o)r=a;else{if(!(n[2*a+1]<o)){t=n[2*a+2];break}i=a+1}}var s=t?t.indexOf("overlay "):-1;return s<0?t:0==s?null:t.slice(0,s-1)},getModeAt:function(e){var t=this.doc.mode;return t.innerMode?_a.innerMode(t,this.getTokenAt(e).state).mode:t},getHelper:function(e,t){return this.getHelpers(e,t)[0]},getHelpers:function(e,t){var n=[];if(!Na.hasOwnProperty(t))return n;var i=Na[t],r=this.getModeAt(e);if("string"==typeof r[t])i[r[t]]&&n.push(i[r[t]]);else if(r[t])for(var o=0;o<r[t].length;o++){var a=i[r[t][o]];a&&n.push(a)}else r.helperType&&i[r.helperType]?n.push(i[r.helperType]):i[r.name]&&n.push(i[r.name]);for(var s=0;s<i._global.length;s++){var l=i._global[s];l.pred(r,this)&&-1==$(n,l.val)&&n.push(l.val)}return n},getStateAfter:function(e,t){var n=this.doc;return jt(this,(e=xe(n,null==e?n.first+n.size-1:e))+1,t)},cursorCoords:function(e,t){var n=this.doc.sel.primary();return qn(this,null==e?n.head:"object"==typeof e?Ce(this.doc,e):e?n.from():n.to(),t||"page")},charCoords:function(e,t){return Wn(this,Ce(this.doc,e),t||"page")},coordsChar:function(e,t){return Kn(this,(e=Un(this,e,t||"page")).left,e.top)},lineAtHeight:function(e,t){return e=Un(this,{top:e,left:0},t||"page").top,pe(this.doc,e+this.display.viewOffset)},heightAtLine:function(e,t,n){var i,r=!1;if("number"==typeof e){var o=this.doc.first+this.doc.size-1;e<this.doc.first?e=this.doc.first:o<e&&(e=o,r=!0),i=se(this.doc,e)}else i=e;return Hn(this,i,{top:0,left:0},t||"page",n||r).top+(r?this.doc.height-ze(i):0)},defaultTextHeight:function(){return Qn(this.display)},defaultCharWidth:function(){return Gn(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(e,t,n,i,r){var o,a,s,l=this.display,c=(e=qn(this,Ce(this.doc,e))).bottom,d=e.left;if(t.style.position="absolute",t.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(t),l.sizer.appendChild(t),"over"==i)c=e.top;else if("above"==i||"near"==i){var u=Math.max(l.wrapper.clientHeight,this.doc.height),p=Math.max(l.sizer.clientWidth,l.lineSpace.clientWidth);("above"==i||e.bottom+t.offsetHeight>u)&&e.top>t.offsetHeight?c=e.top-t.offsetHeight:e.bottom+t.offsetHeight<=u&&(c=e.bottom),d+t.offsetWidth>p&&(d=p-t.offsetWidth)}t.style.top=c+"px",t.style.left=t.style.right="","right"==r?(d=l.sizer.clientWidth-t.offsetWidth,t.style.right="0px"):("left"==r?d=0:"middle"==r&&(d=(l.sizer.clientWidth-t.offsetWidth)/2),t.style.left=d+"px"),n&&(o=this,a={left:d,top:c,right:d+t.offsetWidth,bottom:c+t.offsetHeight},null!=(s=yi(o,a)).scrollTop&&Si(o,s.scrollTop),null!=s.scrollLeft&&Fi(o,s.scrollLeft))},triggerOnKeyDown:Wi(Qo),triggerOnKeyPress:Wi(Xo),triggerOnKeyUp:Go,execCommand:function(e){if($o.hasOwnProperty(e))return $o[e].call(null,this)},triggerElectric:Wi(function(e){va(this,e)}),findPosH:function(e,t,n,i){var r=1;t<0&&(r=-1,t=-t);for(var o=Ce(this.doc,e),a=0;a<t&&!(o=xa(this.doc,o,r,n,i)).hitSide;++a);return o},moveH:Wi(function(t,n){var i=this;this.extendSelectionsBy(function(e){return i.display.shift||i.doc.extend||e.empty()?xa(i.doc,e.head,t,n,i.options.rtlMoveVisually):t<0?e.from():e.to()},z)}),deleteH:Wi(function(n,i){var e=this.doc.sel,r=this.doc;e.somethingSelected()?r.replaceSelection("",null,"+delete"):jo(this,function(e){var t=xa(r,e.head,n,i,!1);return n<0?{from:t,to:e.head}:{from:e.head,to:t}})}),findPosV:function(e,t,n,i){var r=1,o=i;t<0&&(r=-1,t=-t);for(var a=Ce(this.doc,e),s=0;s<t;++s){var l=qn(this,a,"div");if(null==o?o=l.left:l.left=o,(a=Ca(this,l,r,n)).hitSide)break}return a},moveV:Wi(function(i,r){var o=this,a=this.doc,s=[],l=!this.display.shift&&!a.extend&&a.sel.somethingSelected();if(a.extendSelectionsBy(function(e){if(l)return i<0?e.from():e.to();var t=qn(o,e.head,"div");null!=e.goalColumn&&(t.left=e.goalColumn),s.push(t.left);var n=Ca(o,t,i,r);return"page"==r&&e==a.sel.primary()&&bi(o,Wn(o,n,"div").top-t.top),n},z),s.length)for(var e=0;e<a.sel.ranges.length;e++)a.sel.ranges[e].goalColumn=s[e]}),findWordAt:function(e){var t=se(this.doc,e.line).text,n=e.ch,i=e.ch;if(t){var r=this.getHelper(e,"wordChars");"before"!=e.sticky&&i!=t.length||!n?++i:--n;for(var o=t.charAt(n),a=te(o,r)?function(e){return te(e,r)}:/\s/.test(o)?function(e){return/\s/.test(e)}:function(e){return!/\s/.test(e)&&!te(e)};0<n&&a(t.charAt(n-1));)--n;for(;i<t.length&&a(t.charAt(i));)++i}return new pr(ge(e.line,n),ge(e.line,i))},toggleOverwrite:function(e){null!=e&&e==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?I(this.display.cursorDiv,"CodeMirror-overwrite"):F(this.display.cursorDiv,"CodeMirror-overwrite"),at(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==L()},isReadOnly:function(){return!(!this.options.readOnly&&!this.doc.cantEdit)},scrollTo:Wi(function(e,t){xi(this,e,t)}),getScrollInfo:function(){var e=this.display.scroller;return{left:e.scrollLeft,top:e.scrollTop,height:e.scrollHeight-Sn(this)-this.display.barHeight,width:e.scrollWidth-Sn(this)-this.display.barWidth,clientHeight:Fn(this),clientWidth:Tn(this)}},scrollIntoView:Wi(function(e,t){var n,i;null==e?(e={from:this.doc.sel.primary().head,to:null},null==t&&(t=this.options.cursorScrollMargin)):"number"==typeof e?e={from:ge(e,0),to:null}:null==e.from&&(e={from:e,to:null}),e.to||(e.to=e.from),e.margin=t||0,null!=e.from.line?(i=e,Ci(n=this),n.curOp.scrollToPos=i):ki(this,e.from,e.to,e.margin)}),setSize:Wi(function(e,t){var n=this,i=function(e){return"number"==typeof e||/^\d+$/.test(String(e))?e+"px":e};null!=e&&(this.display.wrapper.style.width=i(e)),null!=t&&(this.display.wrapper.style.height=i(t)),this.options.lineWrapping&&On(this);var r=this.display.viewFrom;this.doc.iter(r,this.display.viewTo,function(e){if(e.widgets)for(var t=0;t<e.widgets.length;t++)if(e.widgets[t].noHScroll){Vi(n,r,"widget");break}++r}),this.curOp.forceUpdate=!0,at(this,"refresh",this)}),operation:function(e){return Hi(this,e)},refresh:Wi(function(){var e=this.display.cachedTextHeight;zi(this),this.curOp.forceUpdate=!0,Bn(this),xi(this,this.doc.scrollLeft,this.doc.scrollTop),nr(this),(null==e||.5<Math.abs(e-Qn(this.display)))&&ti(this),at(this,"refresh",this)}),swapDoc:Wi(function(e){var t=this.doc;return t.cm=null,Sr(this,e),Bn(this),this.display.input.reset(),xi(this,e.scrollLeft,e.scrollTop),this.curOp.forceScroll=!0,sn(this,"swapDoc",this,t),t}),getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},dt(_a),_a.registerHelper=function(e,t,n){Na.hasOwnProperty(e)||(Na[e]=_a[e]={_global:[]}),Na[e][t]=n},_a.registerGlobalHelper=function(e,t,n,i){_a.registerHelper(e,t,i),Na[e]._global.push({pred:n,val:i})};var La,Ia="iter insert remove copy getEditor constructor".split(" ");for(var Ra in wo.prototype)wo.prototype.hasOwnProperty(Ra)&&$(Ia,Ra)<0&&(da.prototype[Ra]=function(e){return function(){return e.apply(this.doc,arguments)}}(wo.prototype[Ra]));return dt(wo),da.inputStyles={textarea:Aa,contenteditable:ka},da.defineMode=function(e){da.defaults.mode||"null"==e||(da.defaults.mode=e),function(e,t){2<arguments.length&&(t.dependencies=Array.prototype.slice.call(arguments,2)),Et[e]=t}.apply(this,arguments)},da.defineMIME=function(e,t){_t[e]=t},da.defineMode("null",function(){return{token:function(e){return e.skipToEnd()}}}),da.defineMIME("text/plain","null"),da.defineExtension=function(e,t){da.prototype[e]=t},da.defineDocExtension=function(e,t){wo.prototype[e]=t},da.fromTextArea=function(t,e,n,i){if((e=e?O(e):{}).value=t.value,!e.tabindex&&t.tabIndex&&(e.tabindex=t.tabIndex),!e.placeholder&&t.placeholder&&(e.placeholder=t.placeholder),null==e.autofocus){var r=L();e.autofocus=r==t||null!=t.getAttribute("autofocus")&&r==document.body}function o(){t.value=c.getValue()}var a;if(t.form&&(it(t.form,"submit",o),!e.leaveSubmitMethodAlone)){var s=t.form;a=s.submit;try{var l=s.submit=function(){o(),s.submit=a,s.submit(),s.submit=l}}catch(e){}}e.finishInit=function(e){e.save=o,e.getTextArea=function(){return t},e.toTextArea=function(){e.toTextArea=isNaN,o(),t.parentNode.removeChild(e.getWrapperElement()),t.style.display="",t.form&&(ot(t.form,"submit",o),"function"==typeof t.form.submit&&(t.form.submit=a))}},t.style.display="none";var c=da(function(e){return t.parentNode.insertBefore(e,t.nextSibling)},e,n,i);return c},(La=da).off=ot,La.on=it,La.wheelEventPixels=cr,La.Doc=wo,La.splitLines=kt,La.countColumn=B,La.findColumn=V,La.isWordChar=ee,La.Pass=U,La.signal=at,La.Line=Vt,La.changeEnd=gr,La.scrollbarModel=Li,La.Pos=ge,La.cmpPos=me,La.modes=Et,La.mimeModes=_t,La.resolveMode=Mt,La.getMode=Nt,La.modeExtensions=At,La.extendMode=Lt,La.copyState=It,La.startState=Pt,La.innerMode=Rt,La.commands=$o,La.keyMap=Lo,La.keyName=Oo,La.isModifierKey=Do,La.lookupKey=Po,La.normalizeKeyMap=Ro,La.StringStream=Dt,La.SharedTextMarker=mo,La.TextMarker=fo,La.LineWidget=uo,La.e_preventDefault=ut,La.e_stopPropagation=pt,La.e_stop=ft,La.addClass=I,La.contains=A,La.rmClass=F,La.keyNames=_o,da.version="5.26.0",da}()}),define("app/document/NodeOperation",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils","app/editor/UndoManager","app/editor/Diagram","codemirror/lib/codemirror","app/editor/KeyMaster","rangy/rangy-core"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton");var r=e("app/document/Node"),f=r.Node,g=r.TYPE,m=(r.NodeCollectionUtils,e("app/document/StringUtils")),p=e("app/editor/UndoManager"),v=e("app/editor/Diagram"),d=e("rangy/rangy-core.js");f.normalizeNode=function(e){if(0==e.get("children").length){if(f.isType(e,g.paragraph)){var t=new f({type:g.line,text:e.get("text"),parent:e,in:e.get("in")});return e.unset("text"),t}if(f.isType(e,g.blockquote)){var n=new f({type:g.paragraph,parent:e,in:e.get("in")});return f.normalizeNode(n)}}};var h=function(o,a,s){return function(e,t){var n,i=!1,r={prev:e,next:t};return e.get("type")==g.line&&(!s&&e.parseFrom({skips:{enableStartMatch:!0}}),f.isType(e,g.line)||(i=!0,r.oldCid=e.get("parent").cid,n=e.separateBlockFromLine(),r.prev=n[1],r.opt_prev=n[0])),t.get("type")==g.line&&(!o&&!a&&function(e,t){try{var n,i,r=!t.isDeleted()&&t.getClosetParagraphLevel().get("parent");if(r=f.isType(r,g.list_item)&&r.get("parent"),!(n=f.isType(r,g.list)&&r.get("style")))return;if((i=e.get("text")).match(/^(\s{2, }|\t)/))return;n==f.ListType.ol?i=i.replace(/^\s*\d+\.\s+/,""):n==f.ListType.ul&&(i=i.replace(/^\s*[+*-]\s+/,"")),e.set("text",i)}catch(e){}}(t,e),!s&&t.parseFrom(),f.isType(t,g.line)?o&&f.isType(r.prev,g.math_block,g.fences,g.meta_block)&&(r.prev.set("text",t.get("text")||""),i=!1,t.remove(),r.next=null):(i=!i,n=t.separateBlockFromLine(!0),r.next=n[1],r.opt_next=n[2],f.isType(r.opt_next,g.paragraph)&&f.isType(e,g.line)&&e.get("after")&&e.get("parent").giveChildrenTo(r.opt_next,e.get("after"),null,!0))),i&&(r.prev=f.isType(r.prev,g.line)?r.prev.get("parent"):r.prev,r.next=f.isType(r.next,g.line)?r.next.get("parent"):r.next),!(!o&&f.isType(r.prev,g.line))&&(!r.prev.canContainBlock(!0)&&f.isType(r.prev.get("parent"),g.list_item)&&((a=a||r.prev.get("before"))||(r.noExit=!0),r.prev.get("parent").get("parent").get("children").toArray().forEach(function(e){e.unset("tail")})),r)}};f.genNormalSplitExitFunc=h,f.prototype.breakOn=function(l,c,d){var a,u;if(f.isType(this,g.table,g.table_row,g.table_cell,g.blockquote,g.list))return null;if(f.isType(this,g.def_footnote)){var e=c.getJQueryElem(window.getSelection().baseNode);a=e.closest(".md-def-name").length?c.selection.getOffset(e.closest(".md-def-name")):this.get("ref").length+c.selection.getOffset(e.closest(".md-def-content"))}else if(f.isType(this,g.meta_block))a=this.getText(!1).length;else{var t=c.findElemById(this.id);t.find(".md-emoji").each(function(){var t=[];this.childNodes.forEach(function(e){3==e.nodeType&&t.push(e)});for(var e=0;e<t.length;e++)this.removeChild(t[e])}),a=c.selection.getOffset(t)}function n(e,t){var n=p.makeEmptyCommand(),i={},r=t==u&&0<t,o=e.getClosetBlock();if(n.undo.push(c.selection.buildUndo()),f.isType(o.get("parent"),g.list_item)&&!l?n.undo.push(c.undo.buildReplaceUndo(o.get("parent"))):n.undo.push(c.undo.buildReplaceUndo(o)),o.unset("ahead"),o.unset("tail"),f.isType(e,g.line)&&f.isEmptyBlock(e,null,!0)&&(d=!1),i=f.splitAt(e,t,c,h(d,l),!d&&!l),n.redo.push(c.undo.buildReplaceUndo(i.prev)),i.oldCid=i.oldCid||i.prev.cid,i.next&&p.addUndoForInsert(n,i.next),i.opt_prev&&p.addUndoForInsert(n,i.opt_prev),i.opt_next&&p.addUndoForInsert(n,i.opt_next),i.newHtml="",!i.newHtml){var a=[],s="";[i.opt_prev,i.prev,i.next,i.opt_next].map(function(e){e&&(f.isType(e,g.line)&&File.option.ignoreLineBreak&&(s="\n"),a.push(e.toHTML()))}),i.newHtml=a.join(s)}return f.isType(i.prev,g.meta_block)&&r&&i.prev.get("text").match(/\n$/)?i.nextFocus=i.next.getVeryFirst().id:r&&f.isType(i.prev&&i.prev.getLastChild()||i.prev,g.math_block,g.fences,g.meta_block)?i.nextFocus=i.prev.getVeryFirst(!0).id:r&&f.isType(i.prev,g.table)?i.nextFocus=i.prev.getLastChild().getVeryFirst().cid:i.nextFocus=i.next.getVeryFirst().cid,n.redo.push({type:"cursor",id:i.nextFocus,start:0}),i.command=n,i}if(this.get("children").length)return this.get("children").toArray().map(function(e){c.findElemById(e.id).replaceWith(e.toMark())}),this.clearChildren(),this.set("text",c.findElemById(this.id).text()),n(this,this.get("text").length);if(u=this.getText(!1).length,f.isType(this,g.def_link,g.def_footnote)&&(u+=this.get("ref").length),!this.get("children").length){var i;if(i=function(e){var t,n;if(e=e.getClosetBlock(),u<=1&&f.isType(e,g.def_footnote,g.def_footnote)&&!l&&!d&&f.isEmptyBlock(e,null,!0))return(i=p.makeEmptyCommand(c.selection.buildUndo())).undo.push(p.buildReplaceUndo(e)),e.unset("ahead"),e.unset("tail"),e.set("type",g.paragraph),f.normalizeNode(e),i.redo.push(p.buildReplaceUndo(e)),i.redo.push({type:"cursor",id:e.getLastChild().cid,start:0}),{command:i,nextFocus:e.getLastChild().cid,oldCid:e.cid,newHtml:e.toHTML()};if(0==a&&0==u&&!l&&!d&&e.closest(g.blockquote,g.list)&&e.get("parent")&&e.get("parent").canContainBlock(!0)&&(e.get("parent").get("type")!=g.list_item||!e.get("after"))&&(n=(t=e).get("parent"),!f.isType(n,g.list_item)||t.get("before")||t.get("after")||n.get("before")||n.get("after")||!n.get("parent").get("attachTo"))){var i;(i=p.makeEmptyCommand()).undo.push(c.selection.buildUndo());var r={},o=e.get("before")&&f.isEmptyBlock(e.get("before"));return r=e.upStream(o),i.undo=i.undo.concat(r.command.undo),i.redo=i.redo.concat(r.command.redo),r.nextFocus=r.nextFocus||e.id,i.redo.push({type:"cursor",id:r.nextFocus,start:0}),r.command=i,r}}(this.getClosetBlock()))return i;if(i=function(e){var t=e.get("parent");if(a==u&&t&&t==c.nodeMap.getFirst()&&f.isType(t,g.paragraph)&&!e.get("before")&&!e.get("after")&&"---"===e.get("text")){var n=c.stylize.insertMetaBlock(!0);return n.command.undo.push(p.buildReplaceUndo(t)),e.set("text",""),n.command.redo.push(p.buildReplaceUndo(t)),n.newHtml=n.node.toHTML()+t.toHTML(),n.nextFocus=n.node.id,n.oldCid=t.id,n}}(this))return i;if(a<=u)return n(this,a)}},f.isEmptyBlock=function(e,t,n){var i=n?m.isNullOrBlank:m.isNullOrEmpty;if(f.isType(e,t||[]))return!1;if(e.get("children").length){if(f.isType(e,g.paragraph))return 1==e.get("children").length&&i(e.get("children").at(0).get("text"))}else{if(f.isType(e,g.def_link))return i(e.get("ref"))&&i(e.get("href"))&&i(e.get("title"));if(f.isType(e,g.def_footnote))return i(e.get("ref"))&&i(e.get("text"));if(!f.isType(e,g.table_cell,g.table_row,g.hr))return i(e.get("text"))}return!1};var s=function(e,t){if(t&&f.isType(e,g.def_link,g.def_footnote)&&f.isEmptyBlock(e)||!t&&f.isType(e,g.meta_block)||f.isType(e,g.heading)&&f.isEmptyBlock(e))return e.set("type",g.paragraph),e.set("text",""),e.clearChildren(),f.normalizeNode(e),e.id};function y(e){var t=e.get("parent"),n=t.clone(),i=e.get("after");for(i.set("before",null);i;)i.set("parent",n),i=i.get("after");return t.insert(n),{prev:t,next:n,oldCid:t.cid}}f.smartSplit=function(e,t,n){var i,r,o,a=d.createRange();if(0==t)return["",e[0].innerText];if(t==e[0].innerText.length)return[e[0].innerText,""];n?(o=$.parseHTML("<span />")[0],e[0].appendChild(o),e.prepend("<span />"),a.moveToBookmark({containerNode:e[0],start:t,end:t}),a.setEndAfter(o),r=(o=a.extractContents()).querySelectorAll("[md-inline='strong'], [md-inline='em'], [md-inline='del'], [md-inline='code']"),i=e[0].querySelectorAll("[md-inline='strong'], [md-inline='em'], [md-inline='del'], [md-inline='code']")):(e[0].childElementCount<3&&(o=$.parseHTML("<span />")[0],e[0].insertBefore(o,e[0].firstChild),e.append("<span />")),a.moveToBookmark({containerNode:e[0],start:0,end:t}),o&&a.setStart(o,0),i=(o=a.extractContents()).querySelectorAll("[md-inline='strong'], [md-inline='em'], [md-inline='del'], [md-inline='code']"),r=e[0].querySelectorAll("[md-inline='strong'], [md-inline='em'], [md-inline='del'], [md-inline='code']"));for(var s=0;s<i.length;s++){(l=$(i[s])).find(":not(.md-meta)").text().length?l.children(".md-after").length||l.append(l.children(".md-before").clone().removeClass("md-before").addClass("md-after")):l.html("")}for(s=0;s<r.length;s++){var l;(l=$(r[s])).find(":not(.md-meta)").text().length?l.children(".md-before").length||l.prepend(l.children(".md-after").clone().removeClass("md-after").addClass("md-before")):l.html("")}var c=o.querySelectorAll("svg");for(s=0;s<c.length;s++)c[s].parentElement.removeChild(c[s]);return[$(o).text(),e.textExcludeSVG()]},f.splitAt=function(e,t,n,i,r){var o,a,s,l=e.clone();if(i=i||h(!1,!0),r&&f.isType(e,g.line)&&f.isType(e.get("after"),g.line)&&t>=e.get("text").length)return l.remove(),y(e);if(f.isType(e,g.line)&&f.isType(e.get("before"),g.line)&&0==t)return l.remove(),y(e.get("before"));if(f.isType(e,g.paragraph,g.line,g.heading,g.list_item))o=(s=f.smartSplit(n.findElemById(e.id),t))[0],a=s[1],f.isType(e.get("parent"),g.list_item)&&e.get("parent").get("parent").get("children").toArray().forEach(function(e){e.unset("tail")});else if(f.isType(e,g.def_link,g.def_footnote)){var c=e.get("ref");if(t<=c.length)e.set("ref",c.substring(0,t)),l.set("ref",c.substring(t)),l.set("href",e.get("href")),l.set("title",e.get("title")),e.set("href",""),e.set("title",""),o="",a=e.get("text");else if(f.isType(e,g.def_link)){var d=e.get("href")||"",u=e.get("title")||"";t<=c.length+d.length?(e.set("title",""),l.set("ref",""),e.set("href",d.substring(0,t-c.length)),l.set("href",d.substring(t-c.length))):(l.set("ref",""),l.set("href",""),e.set("title",u.substring(0,t-c.length-d.length)),l.set("title",u.substring(t-c.length-d.length)))}else{var p=e.get("text")||"";l.set("ref",""),o=p.substring(0,t-c.length),a=p.substring(t-c.length)}}else o=e.getText().substring(0,t),a=e.getText().substring(t);return e.set("text",o),!f.isType(l,g.paragraph,g.def_link)&&l.set("text",a),b(e,l,void 0,i)},f.prototype.separateBlockFromLine=function(e){var t,n,i=this.get("before"),r=this.get("after"),o=this.get("parent"),a=o;return this.detach(),i&&(e?(a=new f({type:g.paragraph,trim:o.get("trim")}),(t=o).insert(a,!1)):(t=new f({type:g.paragraph,trim:o.get("trim")}),a.insert(t,!0)),a.giveChildrenTo(t,null,i,!0)),r&&(n=new f({type:g.paragraph,trim:o.get("trim")}),a.giveChildrenTo(n,r,null,!0),a.insert(n,!1)),a.copyContentFrom(this),this.giveChildrenTo(a),this.remove(),t&&t.unset("tail"),a&&a.unset("ahead"),a&&a.unset("tail"),n&&n.unset("ahead"),[t,a,n]};var b=function(e,t,n,i){var r,o=e.isBlock(!0);if(n=n||e.get("parent"),e.set("parent",n),e.insert(t),e.unset("tail"),t.unset("ahead"),i&&o&&"object"==typeof(o=i(e,t))&&(e=(r=o).prev,t=o.next,o.noExit&&(o=!1)),o)return s(e,!0),t&&(s(t,!1),e.insert(t)),r=r||{prev:e,next:t,oldCid:e.cid};var a=e.get("parent").clone();return a.set("text",""),e.get("parent").giveChildrenTo(a,t,null,!0),f.isType(a,g.list_item)&&a.get("style")==f.ListType.task&&a.set("checked",!1),b(e.get("parent"),a,void 0,i)};f.getTreePosition=function(e,t){function n(e){return e.get("parent")?1+n(e.get("parent")):0}if(e==t)return[e,e,t];var i=n(e)-n(t);if(0<i)for(;0<i;)e=e.get("parent"),i--;else if(i<0)for(;i<0;)t=t.get("parent"),i++;return function e(t,n){return t==n?[t,t,n]:t.get("parent")==n.get("parent")||!t.get("parent")&&!t.get("parent")?[t.get("parent"),t,n]:e(t.get("parent"),n.get("parent"))}(e,t)},f.prototype.copyContentFrom=function(t){var n=this;f.property.map(function(e){n.set(e,t.get(e))})},f.prototype.clone=function(){var e=new f;return e.copyContentFrom(this),e.set("in",this.get("in")),e},f.reverseAttrFromElem=function(e,t,n,i){var r,o,a=t.attr("mdtype");switch(e.set("type",a),n&&(t.find("[data-emoji]").text(function(){return this.getAttribute("data-emoji")}),t.find(".md-meta, .md-content").remove()),e.set("text",!i&&f.isType(a,g.line,g.def_footnote,g.heading)?(o=t,o.find("[md-inline='image'], [md-inline='imgtag']").each(function(){var e=$(this),t=e.attr("data-src");if(!/^[a-z0-9\-]+:/i.exec(t)){var n=e.find("img").attr("src")||"",i=e.text(),r=File.editor.imgEdit.resolveImagePath(n.replace(/^file:\/\//,"").replace(/[#?]([^.]*)$/,""));i="image"==this.getAttribute("md-inline")?i.replace(/(\(<?)((?:\([^)]*\)|[^()])*?)(>?[ \t]*((['"])(.*?)\5[ \t]*)?\))/,"$1"+r+"$3"):i.replace(/(^<img(\s+.+)*?\s+src=)("([^"]+)"|'([^']+)')(.*?(\/?\s*>.*?(<\/img>)?))/,'$1"'+r+'"$6'),e.text(i)}}),o).text():t.text()),a){case e.TYPE.heading:e.set("depth",t[0].tagName.replace(/H/gi,""));break;case e.TYPE.list:e.set("style",t[0].tagName.toLowerCase());break;case e.TYPE.math_block:break;case e.TYPE.fences:e.set("lang",t.attr("lang")||t.find("input.mode").val()),e.set("text",t.find("textarea[id]").val()||t.text());break;case e.TYPE.list_item:t.hasClass("md-task-list-item")&&e.set("style",f.ListType.task),e.set("checked","checked"==t.children("input").attr("checked"));break;case e.TYPE.def_link:e.set("ref",t.find(".md-def-name").text()),e.set("title",t.find(".md-def-title").text()),e.set("href",t.find(".md-def-content").text());break;case e.TYPE.def_footnote:e.set("text",t.find(".md-def-content").text()),e.set("ref",t.find(".md-def-name").text());break;case e.TYPE.table:r=[],t.find("tbody>tr:first").children().toArray().map(function(e){r[e.cellIndex]=e.style.textAlign,""==e.style.textAlign&&(r[e.cellIndex]=null)}),r.length||t.find("thead>tr:first").children().toArray().map(function(e){r[e.cellIndex]=e.style.textAlign,""==e.style.textAlign&&(r[e.cellIndex]=null)}),e.set("align",r);break;case e.TYPE.table_row:e.set("header",0<t.closest("thead").length)}},f.reverse=function(e,t,n,i){if(e.length&&e[0].hasAttribute("mdtype")){var r,o,a=new f({in:t});return f.reverseAttrFromElem(a,e,n,i),a.get("type")==a.TYPE.table?(e.find("tr[mdtype]").toArray().map(function(e){(o=f.reverse($(e),t,n)).set("parent",a),o.set("before",r),r=o}),f.TableEdit.valify(a)):a.get("type")==a.TYPE.table_row?e.children().children("span[mdtype]").toArray().map(function(e){(o=f.reverse($(e),t,n)).set("parent",a),o.set("before",r),r=o}):e.children("[mdtype]").toArray().map(function(e){(o=f.reverse($(e),t,n)).set("parent",a),o.set("before",r),r=o}),a}},f.prototype.downStream=function(e){var t=new f({type:e,parent:this.get("parent"),before:this.get("before"),after:this.get("after"),in:this.get("in"),attachTo:this.get("attachTo")});this.set("parent",t)},f.prototype.upStream=function(e,t){var n,i=this.get("parent"),r={};if(r.command=t||p.makeEmptyCommand(),i)if(!f.isType(i,g.list_item)||this.get("before")||this.get("after")){r.command.undo.push(p.buildReplaceUndo(i)),r.oldCid=i.id;var o=this.get("after"),a=this.get("before"),s=i.get("type")==g.list_item;if(this.set("parent",i.get("parent")),this.get("type")!==g.table&&(this.get("type")==g.list_item&&(this.set("type",g.paragraph),f.normalizeNode(this),r.nextFocus=this.getFirstChild().cid),i.get("type")==g.list_item)){this.set("type",i.get("type")),this.set("style",i.get("style"));var l=new f({type:g.paragraph,in:this.get("in")});this.giveChildrenTo(l),l.set("parent",this),f.normalizeNode(l)}if(r.newHtml=this.toHTML(),o)if(o.set("before",this.canContainBlock(!1)?this.getFirstChild():null),s){for(;o.set("parent",this),o=o.get("after"););r.newHtml=this.toHTML()}else{for(n=i.clone();o.set("parent",n),o=o.get("after"););r.newHtml+=n.toHTML()}a?(r.command.redo.push(p.buildReplaceUndo(i)),p.addUndoForRemove(r.command,this),i.insert(this),p.addUndoForInsert(r.command,this),r.newHtml=i.toHTML()+r.newHtml):(p.addUndoForRemove(r.command,this),i.insert(this,!0),p.addUndoForInsert(r.command,this),p.addUndoForRemove(r.command,i),i.remove()),n&&(this.insert(n),p.addUndoForInsert(r.command,n))}else{var c=p.buildReplaceUndo(i);this.giveChildrenTo(i),this.remove(),(r=i.upStream()).command.undo.unshift(c),r.nextFocus=r.nextFocus||i.id}return r},f.prototype.attr=function(i,r,o,e){function t(e,t){var n=o.undo.UndoManager.makeEmptyCommand();return n.undo.push({type:"attr",id:e.id,key:i,value:t||e.safeGetStrAttr(i)}),n.redo.push({type:"attr",key:i,id:e.id,value:r}),n}if(this.get(i)!=r){e||(o.store(),o.undo.completeSnap(!0));var n=t(this);switch(e||"align_idx"==i||o.undo.register(n),r="string"==typeof r?m.escape(r):r,i){case"lang":var a=o.fences.getCm(this.id);if(a.options.mode==r)break;v.isDiagramType(a.options.mode)&&o.diagrams.cancelDiagram(this.id),a.setOption("mode",getCodeMirrorMode(r)),a.refresh(),this.set("lang",r),$("[cid='"+this.id+"']").attr("lang",r).find(".CodeMirror").attr("lang",(r||"").toLowerCase()),e&&$("[cid='"+this.id+"'] input.mode").val(r||"").focus(),v.isDiagramType(r)&&o.diagrams.updateDiagram(this.id);break;case"checked":var s=document.querySelector("[cid='"+this.id+"']>input");r?(s.setAttribute("checked","checked"),s.parentElement.classList.remove("task-list-not-done"),s.parentElement.classList.add("task-list-done")):(s.removeAttribute("checked"),s.parentElement.classList.remove("task-list-done"),s.parentElement.classList.add("task-list-not-done")),s.checked=r||!1,this.set("checked",r||!1);break;case"href-title":if(this.get("type")==g.image){var l=r.split(/\s/);if(o.findElemById(this.id).find("img").attr("src",l[0]),this.set("href",l[0]),this.set("title",l[1]),e)(p=$("[cid='"+this.id+"']")).hasClass("onfocus")||(p.addClass("onfocus").focus(),o.EditHelper.showTooltipForImage(o,p),$("[cid='"+this.id+"'] input.t-bracket-input").val(r||"").focus())}break;case"alt":if(this.get("type")==g.image)if(o.findElemById(this.id).find("img").attr("alt",r),this.set("alt",r),e)(p=$("[cid='"+this.id+"']")).hasClass("onfocus")||(p.addClass("onfocus").focus(),o.EditHelper.showTooltipForImage(o,p),$("[cid='"+this.id+"'] input.t-alt-input").val(r||"").focus());break;case"align_idx":if(this.get("type")==g.table){var c=r[0],d=r[1],u=r[2],p=o.findElemById(this.id);n=t(this,[c,this.get("align")[c]]);if(e||((u=f.adjustAlignText(this,c,d))&&(n.undo.last().value.push(this.get("alignText")[c]),n.redo.last().value.push(u)),o.undo.register(n)),this.get("alignText")&&(this.get("alignText")[c]=u),d=(this.get("align")[c]=d)||"",p.find("tbody>tr>td:nth-child("+(c+1)+")").css("text-align",d),p.find("thead>tr>th:nth-child("+(c+1)+")").css("text-align",d),e)o.tableEdit.showTableEdit(p);else{var h=p.find(".md-align-gp[data-col='"+c+"']");h.find("button").removeClass("active").blur(),h.find(".md-align-"+d).addClass("active").focus()}}}return n}},f.adjustAlignText=function(e,t,n){if(e.get("alignText")){var i=e.get("alignText")[t];if(i)return i="left"==n||"center"==n?(i=i.replace(/(^\s*)-/,"$1:")).replace(/(^\s*):(\s*$)/,"$1:-$2"):i.replace(/(^\s*):/,"$1-"),i="right"==n||"center"==n?(i=i.replace(/-(\s*$)/,":$1")).replace(/(^\s*):(\s*$)/,"$1-:$2"):i.replace(/:(\s*$)/,"-$1"),/^\s*::\s*$/.exec(i)&&(i=i.replace("::",":-:")),i}},f.tryResetTable=function(e){e&&!e.isDeleted()&&e.get("type")==g.table&&e.get("userText")&&e.set("userText",void 0)},f.prototype.unwrap=function(e){var t=[],n=this.getFirstChild();do{var i=n.get("after");n.set("parent",this.get("parent")),n.set("attachTo",this.get("attachTo")),n.get("before")||n.set("before",this.get("before")),n.get("after")||n.set("after",this.get("after")),t.push(n),n.get("pattern")&&n.set("pattern",n.get("pattern").replace(/^\s+/,"")),n=i}while(n);return this.remove(!0),e&&e.findElemById(this.cid).replaceWith(r.NodeCollectionUtils.toHTML(t)),t},f.prototype.wrap=function(e,t,n,i){for(var r,o=e,a=[],s={parent:e.get("parent"),before:e.get("before"),after:t?t.get("after"):e.get("after")};o&&o!=s.after;)n&&n.findElemById(o.id).remove(),o=(r=o).get("after"),this.append(r);s.after&&(s.after.insert(this,!0),i||(a=n.findElemById(s.after.id)).before(this.toHTML())),!a.length&&s.before&&(s.before.insert(this,!1),i||(a=n.findElemById(s.before.id)).after(this.toHTML())),a.length||(s.parent?(this.set("parent",s.parent),!i&&n&&n.findElemById(s.parent.id).html(this.toHTML())):i||0!==$(n.sessionStr).children().length||(this.set("attachTo",this.get("in")),n&&($(n.sessionStr).html(this.toHTML()),n.focusCid=null)))}}),define("rangy/rangy-core.js",[],function(e,t,n){"use strict";var i=function(e){var i="object",r="function",n="undefined",l=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],c=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],t=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],o=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"];function d(e,t){var n=typeof e[t];return n==r||!(n!=i||!e[t])||"unknown"==n}function a(e,t){return!(typeof e[t]!=i||!e[t])}function s(e,t){return typeof e[t]!=n}function u(i){return function(e,t){for(var n=t.length;n--;)if(!i(e,t[n]))return!1;return!0}}var p=u(d),h=u(a),f=u(s);function g(e){return e&&p(e,o)&&f(e,t)}function m(e){return a(e,"body")?e.body:e.getElementsByTagName("body")[0]}var v,y={},b={version:"1.3alpha.20140716",initialized:!1,supported:!0,util:{isHostMethod:d,isHostObject:a,isHostProperty:s,areHostMethods:p,areHostObjects:h,areHostProperties:f,isTextRange:g,getBody:m},features:{},modules:y,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};function w(e){a(window,"console")&&d(window.console,"log")&&window.console.log(e)}function x(e,t){t?window.alert(e):w(e)}function C(e){b.initialized=!0,b.supported=!1,x("Rangy is not supported on this page in your browser. Reason: "+e,b.config.alertOnFail)}b.fail=C,b.warn=function(e){x("Rangy warning: "+e,b.config.alertOnWarn)},!{}.hasOwnProperty?C("hasOwnProperty not supported"):b.util.extend=function(e,t,n){var i,r;for(var o in t)t.hasOwnProperty(o)&&(i=e[o],r=t[o],n&&null!==i&&"object"==typeof i&&null!==r&&"object"==typeof r&&b.util.extend(i,r,!0),e[o]=r);return t.hasOwnProperty("toString")&&(e.toString=t.toString),e},function(){var e=document.createElement("div");e.appendChild(document.createElement("span"));var t,n=[].slice;try{1==n.call(e.childNodes,0)[0].nodeType&&(t=function(e){return n.call(e,0)})}catch(e){}t||(t=function(e){for(var t=[],n=0,i=e.length;n<i;++n)t[n]=e[n];return t}),b.util.toArray=t}(),d(document,"addEventListener")?v=function(e,t,n){e.addEventListener(t,n,!1)}:d(document,"attachEvent")?v=function(e,t,n){e.attachEvent("on"+t,n)}:C("Document does not have required addEventListener or attachEvent method"),b.util.addListener=v;var k=[];function S(e){return e.message||e.description||String(e)}function T(){if(!b.initialized){var e,t=!1,n=!1;d(document,"createRange")&&(e=document.createRange(),p(e,c)&&f(e,l)&&(t=!0));var i=m(document);if(i&&"body"==i.nodeName.toLowerCase())if(i&&d(i,"createTextRange")&&g(e=i.createTextRange())&&(n=!0),t||n){var r;for(var o in b.initialized=!0,b.features={implementsDomRange:t,implementsTextRange:n},y)(r=y[o])instanceof E&&r.init(r,b);for(var a=0,s=k.length;a<s;++a)try{k[a](b)}catch(e){w("Rangy init listener threw an exception. Continuing. Detail: "+S(e))}}else C("Neither Range nor TextRange are available");else C("No body element found")}}b.init=T,b.addInitListener=function(e){b.initialized?e(b):k.push(e)};var F=[];function E(e,t,n){this.name=e,this.dependencies=t,this.initialized=!1,this.supported=!1,this.initializer=n}function _(e,t,n,i){var r=new E(t,n,function(e){if(!e.initialized){e.initialized=!0;try{i(b,e),e.supported=!0}catch(e){w("Module '"+t+"' failed to load: "+S(e))}}});y[t]=r}function M(){}b.addCreateMissingNativeApiListener=function(e){F.push(e)},b.createMissingNativeApi=function(e){e=e||window,T();for(var t=0,n=F.length;t<n;++t)F[t](e)},E.prototype={init:function(e){for(var t,n,i=this.dependencies||[],r=0,o=i.length;r<o;++r){if(n=i[r],!((t=y[n])&&t instanceof E))throw new Error("required module '"+n+"' not found");if(t.init(),!t.supported)throw new Error("required module '"+n+"' not supported")}this.initializer(this)},fail:function(e){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+e)},warn:function(e){b.warn("Module "+this.name+": "+e)},deprecationNotice:function(e,t){b.warn("DEPRECATED: "+e+" in module "+this.name+"is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in Rangy "+this.name+" module: "+e)}},b.createModule=function(e){var t,n;2==arguments.length?(t=arguments[1],n=[]):(t=arguments[2],n=arguments[1]),_(0,e,n,t)},b.createCoreModule=function(e,t,n){_(0,e,t,n)},b.RangePrototype=M,b.rangePrototype=new M,b.selectionPrototype=new function(){};var N=!1,A=function(e){N||(N=!0,b.initialized||T())};if(typeof window!=n){if(typeof document!=n)return d(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",A,!1),v(window,"load",A),b;C("No document found")}else C("No window found")}();i.createCoreModule("DomUtil",[],function(n,c){var i="undefined",r=n.util;r.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||c.fail("document missing a Node creation method"),r.isHostMethod(document,"getElementsByTagName")||c.fail("document missing getElementsByTagName method");var e=document.createElement("div");r.areHostMethods(e,["insertBefore","appendChild","cloneNode"]||!r.areHostObjects(e,["previousSibling","nextSibling","childNodes","parentNode"]))||c.fail("Incomplete Element implementation"),r.isHostProperty(e,"innerHTML")||c.fail("Element is missing innerHTML property");var t=document.createTextNode("test");r.areHostMethods(t,["splitText","deleteData","insertData","appendData","cloneNode"]||!r.areHostObjects(e,["previousSibling","nextSibling","childNodes","parentNode"])||!r.areHostProperties(t,["data"]))||c.fail("Incomplete Text Node implementation");var o=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1};function d(e){for(var t=0;e=e.previousSibling;)++t;return t}function u(e,t){var n,i=[];for(n=e;n;n=n.parentNode)i.push(n);for(n=t;n;n=n.parentNode)if(o(i,n))return n;return null}function a(e,t,n){for(var i=n?t:t.parentNode;i;){if(i===e)return!0;i=i.parentNode}return!1}function p(e,t,n){for(var i,r=n?e:e.parentNode;r;){if((i=r.parentNode)===t)return r;r=i}return null}function s(e){var t=e.nodeType;return 3==t||4==t||8==t}function l(e,t){var n=t.nextSibling,i=t.parentNode;return n?i.insertBefore(e,n):i.appendChild(e),e}function h(e){if(9==e.nodeType)return e;if(typeof e.ownerDocument!=i)return e.ownerDocument;if(typeof e.document!=i)return e.document;if(e.parentNode)return h(e.parentNode);throw c.createError("getDocument: no document found for node")}function f(e){var t=h(e);if(typeof t.defaultView!=i)return t.defaultView;if(typeof t.parentWindow!=i)return t.parentWindow;throw c.createError("Cannot get a window object for node")}function g(e){if(typeof e.contentDocument!=i)return e.contentDocument;if(typeof e.contentWindow!=i)return e.contentWindow.document;throw c.createError("getIframeDocument: No Document object found for iframe element")}function m(e){return e&&r.isHostMethod(e,"setTimeout")&&r.isHostObject(e,"document")}var v,y=!1;function b(e){try{return e.parentNode,!1}catch(e){return!0}}function w(e){if(!e)return"[No node]";if(y&&b(e))return"[Broken node]";if(s(e))return'"'+e.data+'"';if(1==e.nodeType){var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">[index:"+d(e)+",length:"+e.childNodes.length+"]["+(e.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return e.nodeName}function x(e){this.root=e,this._next=e}function C(e,t){this.node=e,this.offset=t}function k(e){this.code=this[e],this.codeName=e,this.message="DOMException: "+this.codeName}!function(){var e=document.createElement("b");e.innerHTML="1";var t=e.firstChild;e.innerHTML="<br>",y=b(t),n.features.crashyTextNodes=y}(),typeof window.getComputedStyle!=i?v=function(e,t){return f(e).getComputedStyle(e,null)[t]}:typeof document.documentElement.currentStyle!=i?v=function(e,t){return e.currentStyle[t]}:c.fail("No means of obtaining computed style properties found"),x.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var e,t,n=this._current=this._next;if(this._current)if(e=n.firstChild)this._next=e;else{for(t=null;n!==this.root&&!(t=n.nextSibling);)n=n.parentNode;this._next=t}return this._current},detach:function(){this._current=this._next=this.root=null}},C.prototype={equals:function(e){return!!e&&this.node===e.node&&this.offset==e.offset},inspect:function(){return"[DomPosition("+w(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},(k.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24}).toString=function(){return this.message},n.dom={arrayContains:o,isHtmlNamespace:function(e){var t;return typeof e.namespaceURI==i||null===(t=e.namespaceURI)||"http://www.w3.org/1999/xhtml"==t},parentElement:function(e){var t=e.parentNode;return 1==t.nodeType?t:null},getNodeIndex:d,getNodeLength:function(e){switch(e.nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}},getCommonAncestor:u,isAncestorOf:a,isOrIsAncestorOf:function(e,t){return a(e,t,!0)},getClosestAncestorIn:p,isCharacterDataNode:s,isTextOrCommentNode:function(e){if(!e)return!1;var t=e.nodeType;return 3==t||8==t},insertAfter:l,splitDataNode:function(e,t,n){var i=e.cloneNode(!1);if(i.deleteData(0,t),e.deleteData(t,e.length-t),l(i,e),n)for(var r,o=0;r=n[o++];)r.node==e&&r.offset>t?(r.node=i,r.offset-=t):r.node==e.parentNode&&r.offset>d(e)&&++r.offset;return i},getDocument:h,getWindow:f,getIframeWindow:function(e){if(typeof e.contentWindow!=i)return e.contentWindow;if(typeof e.contentDocument!=i)return e.contentDocument.defaultView;throw c.createError("getIframeWindow: No Window object found for iframe element")},getIframeDocument:g,getBody:r.getBody,isWindow:m,getContentDocument:function(e,t,n){var i;if(e?r.isHostProperty(e,"nodeType")?i=1==e.nodeType&&"iframe"==e.tagName.toLowerCase()?g(e):h(e):m(e)&&(i=e.document):i=document,!i)throw t.createError(n+"(): Parameter must be a Window object or DOM node");return i},getRootContainer:function(e){for(var t;t=e.parentNode;)e=t;return e},comparePoints:function(e,t,n,i){var r,o,a,s,l;if(e==n)return t===i?0:t<i?-1:1;if(r=p(n,e,!0))return t<=d(r)?-1:1;if(r=p(e,n,!0))return d(r)<i?-1:1;if(!(o=u(e,n)))throw new Error("comparePoints error: nodes have no common ancestor");if((a=e===o?o:p(e,o,!0))===(s=n===o?o:p(n,o,!0)))throw c.createError("comparePoints got to case 4 and childA and childB are the same!");for(l=o.firstChild;l;){if(l===a)return-1;if(l===s)return 1;l=l.nextSibling}},isBrokenNode:b,inspectNode:w,getComputedStyleProperty:v,fragmentFromNodeChildren:function(e){for(var t,n=h(e).createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n},createIterator:function(e){return new x(e)},DomPosition:C},n.DOMException=k}),i.createCoreModule("DomRange",["DomUtil"],function(l,e){var c=l.dom,i=l.util,t=c.DomPosition,a=l.DOMException,d=c.isCharacterDataNode,u=c.getNodeIndex,s=c.isOrIsAncestorOf,p=c.getDocument,h=c.comparePoints,f=c.splitDataNode,g=c.getClosestAncestorIn,m=c.getNodeLength,o=c.arrayContains,v=c.getRootContainer,n=l.features.crashyTextNodes;function y(e,t){return 3!=e.nodeType&&(s(e,t.startContainer)||s(e,t.endContainer))}function b(e){return e.document||p(e.startContainer)}function w(e){return new t(e.parentNode,u(e))}function x(e){return new t(e.parentNode,u(e)+1)}function r(e,t,n){var i=11==e.nodeType?e.firstChild:e;return d(t)?n==t.length?c.insertAfter(e,t):t.parentNode.insertBefore(e,0==n?t:f(t,n)):n>=t.childNodes.length?t.appendChild(e):t.insertBefore(e,t.childNodes[n]),i}function C(e,t,n){if(z(e),z(t),b(t)!=b(e))throw new a("WRONG_DOCUMENT_ERR");var i=h(e.startContainer,e.startOffset,t.endContainer,t.endOffset),r=h(e.endContainer,e.endOffset,t.startContainer,t.startOffset);return n?i<=0&&0<=r:i<0&&0<r}function k(e,t,n){var i,r,o,a;for(n=n||{stop:!1};o=e.next();)if(e.isPartiallySelectedSubtree()){if(!1===t(o))return void(n.stop=!0);if(k(a=e.getSubtreeIterator(),t,n),a.detach(),n.stop)return}else for(i=c.createIterator(o);r=i.next();)if(!1===t(r))return void(n.stop=!0)}function S(e){for(var t;e.next();)e.isPartiallySelectedSubtree()?(S(t=e.getSubtreeIterator()),t.detach()):e.remove()}function T(e){for(var t,n,i=b(e.range).createDocumentFragment();t=e.next();){if(e.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),n=e.getSubtreeIterator(),t.appendChild(T(n)),n.detach()):e.remove(),10==t.nodeType)throw new a("HIERARCHY_REQUEST_ERR");i.appendChild(t)}return i}function F(e){return"["+(void 0===e.getName?"Range":e.getName())+"("+c.inspectNode(e.startContainer)+":"+e.startOffset+", "+c.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function E(e,t){if(this.range=e,this.clonePartiallySelectedTextNodes=t,!e.collapsed){this.sc=e.startContainer,this.so=e.startOffset,this.ec=e.endContainer,this.eo=e.endOffset;var n=e.commonAncestorContainer;this.sc===this.ec&&d(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||d(this.sc)?g(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||d(this.ec)?g(this.ec,n,!0):this.ec.childNodes[this.eo-1])}}E.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return e&&(this._next=e!==this._last?e.nextSibling:null,d(e)&&this.clonePartiallySelectedTextNodes&&(e===this.ec&&(e=e.cloneNode(!0)).deleteData(this.eo,e.length-this.eo),this._current===this.sc&&(e=e.cloneNode(!0)).deleteData(0,this.so))),e},remove:function(){var e,t,n=this._current;!d(n)||n!==this.sc&&n!==this.ec?n.parentNode&&n.parentNode.removeChild(n):(e=n===this.sc?this.so:0)!=(t=n===this.ec?this.eo:n.length)&&n.deleteData(e,t-e)},isPartiallySelectedSubtree:function(){return y(this._current,this.range)},getSubtreeIterator:function(){var e;if(this.isSingleCharacterDataNode)(e=this.range.cloneRange()).collapse(!1);else{e=new ue(b(this.range));var t=this._current,n=t,i=0,r=t,o=m(t);s(t,this.sc)&&(n=this.sc,i=this.so),s(t,this.ec)&&(r=this.ec,o=this.eo),de(e,n,i,r,o)}return new E(e,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var _=[1,3,4,5,7,8,10],M=[2,9,11],N=[1,3,4,5,7,8,10,11],A=[1,3,4,5,7,8];function L(r){return function(e,t){for(var n,i=t?e:e.parentNode;i;){if(n=i.nodeType,o(r,n))return i;i=i.parentNode}return null}}var I=L([9,11]),R=L([5,6,10,12]),P=L([6,10,12]);function D(e,t){if(P(e,t))throw new a("INVALID_NODE_TYPE_ERR")}function O(e,t){if(!o(t,e.nodeType))throw new a("INVALID_NODE_TYPE_ERR")}function B(e,t){if(t<0||t>(d(e)?e.length:e.childNodes.length))throw new a("INDEX_SIZE_ERR")}function j(e,t){if(I(e,!0)!==I(t,!0))throw new a("WRONG_DOCUMENT_ERR")}function $(e){if(R(e,!0))throw new a("NO_MODIFICATION_ALLOWED_ERR")}function H(e,t){if(!e)throw new a(t)}function U(e){return n&&c.isBrokenNode(e)||!o(M,e.nodeType)&&!I(e,!0)}function W(e,t){return t<=(d(e)?e.length:e.childNodes.length)}function q(e){return!!e.startContainer&&!!e.endContainer&&!U(e.startContainer)&&!U(e.endContainer)&&W(e.startContainer,e.startOffset)&&W(e.endContainer,e.endOffset)}function z(e){if(!q(e))throw new Error("Range error: Range is no longer valid after DOM mutation ("+e.inspect()+")")}var V=document.createElement("style"),K=!1;try{V.innerHTML="<b>x</b>",K=3==V.firstChild.nodeType}catch(e){}var Y=(l.features.htmlParsingConforms=K)?function(e){var t=this.startContainer,n=p(t);if(!t)throw new a("INVALID_STATE_ERR");var i=null;return 1==t.nodeType?i=t:d(t)&&(i=c.parentElement(t)),(i=null===i||"HTML"==i.nodeName&&c.isHtmlNamespace(p(i).documentElement)&&c.isHtmlNamespace(i)?n.createElement("body"):i.cloneNode(!1)).innerHTML=e,c.fragmentFromNodeChildren(i)}:function(e){var t=b(this).createElement("body");return t.innerHTML=e,c.fragmentFromNodeChildren(t)};function J(e,t){z(e);var n=e.startContainer,i=e.startOffset,r=e.endContainer,o=e.endOffset,a=n===r;d(r)&&0<o&&o<r.length&&f(r,o,t),d(n)&&0<i&&i<n.length&&(n=f(n,i,t),a?(o-=i,r=n):r==n.parentNode&&o>=u(n)&&o++,i=0),e.setStartAndEnd(n,i,r,o)}var Q=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],G=0,X=1,Z=2,ee=3,te=0,ne=1,ie=2,re=3;function oe(e){e.START_TO_START=G,e.START_TO_END=X,e.END_TO_END=Z,e.END_TO_START=ee,e.NODE_BEFORE=te,e.NODE_AFTER=ne,e.NODE_BEFORE_AND_AFTER=ie,e.NODE_INSIDE=re}function ae(e){oe(e),oe(e.prototype)}function se(a,s){return function(){z(this);var e,t=this.startContainer,n=this.startOffset,i=this.commonAncestorContainer,r=new E(this,!0);t!==i&&(t=(e=x(g(t,i,!0))).node,n=e.offset),k(r,$),r.reset();var o=a(r);return r.detach(),s(this,t,n,t,n),o}}function le(e,c){function t(n,i){return function(e){O(e,_),O(v(e),M);var t=(n?w:x)(e);(i?r:o)(this,t.node,t.offset)}}function r(e,t,n){var i=e.endContainer,r=e.endOffset;t===e.startContainer&&n===e.startOffset||(v(t)==v(i)&&1!=h(t,n,i,r)||(i=t,r=n),c(e,t,n,i,r))}function o(e,t,n){var i=e.startContainer,r=e.startOffset;t===e.endContainer&&n===e.endOffset||(v(t)==v(i)&&-1!=h(t,n,i,r)||(i=t,r=n),c(e,i,r,t,n))}var n=function(){};n.prototype=l.rangePrototype,e.prototype=new n,i.extend(e.prototype,{setStart:function(e,t){D(e,!0),B(e,t),r(this,e,t)},setEnd:function(e,t){D(e,!0),B(e,t),o(this,e,t)},setStartAndEnd:function(){var e=arguments,t=e[0],n=e[1],i=t,r=n;switch(e.length){case 3:r=e[2];break;case 4:i=e[2],r=e[3]}c(this,t,n,i,r)},setBoundary:function(e,t,n){this["set"+(n?"Start":"End")](e,t)},setStartBefore:t(!0,!0),setStartAfter:t(!1,!0),setEndBefore:t(!0,!1),setEndAfter:t(!1,!1),collapse:function(e){z(this),e?c(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):c(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(e){D(e,!0),c(this,e,0,e,m(e))},selectNode:function(e){D(e,!1),O(e,_);var t=w(e),n=x(e);c(this,t.node,t.offset,n.node,n.offset)},extractContents:se(T,c),deleteContents:se(S,c),canSurroundContents:function(){z(this),$(this.startContainer),$(this.endContainer);var e=new E(this,!0),t=e._first&&y(e._first,this)||e._last&&y(e._last,this);return e.detach(),!t},splitBoundaries:function(){J(this)},splitBoundariesPreservingPositions:function(e){J(this,e)},normalizeBoundaries:function(){z(this);var r=this.startContainer,o=this.startOffset,a=this.endContainer,s=this.endOffset,e=function(e){var t=e.nextSibling;t&&t.nodeType==e.nodeType&&(s=(a=e).length,e.appendData(t.data),t.parentNode.removeChild(t))},t=function(e){var t=e.previousSibling;if(t&&t.nodeType==e.nodeType){var n=(r=e).length;if(o=t.length,e.insertData(0,t.data),t.parentNode.removeChild(t),r==a)s+=o,a=r;else if(a==e.parentNode){var i=u(e);s==i?(a=e,s=n):i<s&&s--}}},n=!0;if(d(a))a.length==s&&e(a);else{if(0<s){var i=a.childNodes[s-1];i&&d(i)&&e(i)}n=!this.collapsed}if(n){if(d(r))0==o&&t(r);else if(o<r.childNodes.length){var l=r.childNodes[o];l&&d(l)&&t(l)}}else r=a,o=s;c(this,r,o,a,s)},collapseToPoint:function(e,t){D(e,!0),B(e,t),this.setStartAndEnd(e,t)}}),ae(e)}function ce(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e.commonAncestorContainer=e.collapsed?e.startContainer:c.getCommonAncestor(e.startContainer,e.endContainer)}function de(e,t,n,i,r){e.startContainer=t,e.startOffset=n,e.endContainer=i,e.endOffset=r,e.document=c.getDocument(t),ce(e)}function ue(e){this.startContainer=e,this.startOffset=0,this.endContainer=e,this.endOffset=0,this.document=e,ce(this)}i.extend(l.rangePrototype,{compareBoundaryPoints:function(e,t){var n,i,r,o;z(this),j(this.startContainer,t.startContainer);var a=e==ee||e==G?"start":"end",s=e==X||e==G?"start":"end";return n=this[a+"Container"],i=this[a+"Offset"],r=t[s+"Container"],o=t[s+"Offset"],h(n,i,r,o)},insertNode:function(e){if(z(this),O(e,N),$(this.startContainer),s(e,this.startContainer))throw new a("HIERARCHY_REQUEST_ERR");var t=r(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){var e,t;if(z(this),this.collapsed)return b(this).createDocumentFragment();if(this.startContainer===this.endContainer&&d(this.startContainer))return(e=this.startContainer.cloneNode(!0)).data=e.data.slice(this.startOffset,this.endOffset),(t=b(this).createDocumentFragment()).appendChild(e),t;var n=new E(this,!0);return e=function e(t){for(var n,i,r,o=b(t.range).createDocumentFragment();i=t.next();){if(n=t.isPartiallySelectedSubtree(),i=i.cloneNode(!n),n&&(r=t.getSubtreeIterator(),i.appendChild(e(r)),r.detach()),10==i.nodeType)throw new a("HIERARCHY_REQUEST_ERR");o.appendChild(i)}return o}(n),n.detach(),e},canSurroundContents:function(){z(this),$(this.startContainer),$(this.endContainer);var e=new E(this,!0),t=e._first&&y(e._first,this)||e._last&&y(e._last,this);return e.detach(),!t},surroundContents:function(e){if(O(e,A),!this.canSurroundContents())throw new a("INVALID_STATE_ERR");var t=this.extractContents();if(e.hasChildNodes())for(;e.lastChild;)e.removeChild(e.lastChild);r(e,this.startContainer,this.startOffset),e.appendChild(t),this.selectNode(e)},cloneRange:function(){z(this);for(var e,t=new ue(b(this)),n=Q.length;n--;)t[e=Q[n]]=this[e];return t.isBackward=this.isBackward,t},toString:function(){z(this);var e=this.startContainer;if(e===this.endContainer&&d(e))return 3==e.nodeType||4==e.nodeType?e.data.slice(this.startOffset,this.endOffset):"";var t=[],n=new E(this,!0);return k(n,function(e){3!=e.nodeType&&4!=e.nodeType||t.push(e.data)}),n.detach(),t.join("")},compareNode:function(e){z(this);var t=e.parentNode,n=u(e);if(!t)throw new a("NOT_FOUND_ERR");var i=this.comparePoint(t,n),r=this.comparePoint(t,n+1);return i<0?0<r?ie:te:0<r?ne:re},comparePoint:function(e,t){return z(this),H(e,"HIERARCHY_REQUEST_ERR"),j(e,this.startContainer),h(e,t,this.startContainer,this.startOffset)<0?-1:0<h(e,t,this.endContainer,this.endOffset)?1:0},createContextualFragment:Y,toHtml:function(){z(this);var e=this.commonAncestorContainer.parentNode.cloneNode(!1);return e.appendChild(this.cloneContents()),e.innerHTML},intersectsNode:function(e,t){if(z(this),H(e,"NOT_FOUND_ERR"),p(e)!==b(this))return!1;var n=e.parentNode,i=u(e);H(n,"NOT_FOUND_ERR");var r=h(n,i,this.endContainer,this.endOffset),o=h(n,i+1,this.startContainer,this.startOffset);return t?r<=0&&0<=o:r<0&&0<o},isPointInRange:function(e,t){return z(this),H(e,"HIERARCHY_REQUEST_ERR"),j(e,this.startContainer),0<=h(e,t,this.startContainer,this.startOffset)&&h(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e){return C(this,e,!1)},intersectsOrTouchesRange:function(e){return C(this,e,!0)},intersection:function(e){if(this.intersectsRange(e)){var t=h(this.startContainer,this.startOffset,e.startContainer,e.startOffset),n=h(this.endContainer,this.endOffset,e.endContainer,e.endOffset),i=this.cloneRange();return-1==t&&i.setStart(e.startContainer,e.startOffset),1==n&&i.setEnd(e.endContainer,e.endOffset),i}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var t=this.cloneRange();return-1==h(e.startContainer,e.startOffset,this.startContainer,this.startOffset)&&t.setStart(e.startContainer,e.startOffset),1==h(e.endContainer,e.endOffset,this.endContainer,this.endOffset)&&t.setEnd(e.endContainer,e.endOffset),t}throw new a("Ranges do not intersect")},containsNode:function(e,t){return t?this.intersectsNode(e,!1):this.compareNode(e)==re},containsNodeContents:function(e){return 0<=this.comparePoint(e,0)&&this.comparePoint(e,m(e))<=0},containsRange:function(e){var t=this.intersection(e);return null!==t&&e.equals(t)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(0<n.length){t.setStart(n[0],0);var i=n.pop();return t.setEnd(i,i.length),this.containsRange(t)}return this.containsNodeContents(e)},getNodes:function(e,t){return z(this),function(i,e,r){var o,a=!(!e||!e.length),s=!!r;a&&(o=new RegExp("^("+e.join("|")+")$"));var l=[];return k(new E(i,!1),function(e){if((!a||o.test(e.nodeType))&&(!s||r(e))){var t=i.startContainer;if(e!=t||!d(t)||i.startOffset!=t.length){var n=i.endContainer;e==n&&d(n)&&0==i.endOffset||l.push(e)}}}),l}(this,e,t)},getDocument:function(){return b(this)},collapseBefore:function(e){this.setEndBefore(e),this.collapse(!1)},collapseAfter:function(e){this.setStartAfter(e),this.collapse(!0)},getBookmark:function(e){function t(e){var t=e.cloneContents();if(t.querySelector("text")){for(var n=t.querySelectorAll("svg"),i=0;i<n.length;i++)n[i].parentElement.removeChild(n[i]);return t.textContent.length}return e.toString().length}var n=b(this),i=l.createRange(n);e=e||c.getBody(n),i.selectNodeContents(e);var r=this.intersection(i),o=e.querySelectorAll("text").length,a=0,s=0;return r&&(i.setEnd(r.startContainer,r.startOffset),s=(a=o?t(i):i.toString().length)+(o?t(r):r.toString().length)),{start:a,end:s,containerNode:e}},moveToBookmark:function(e){var t=e.containerNode,n=0;this.setStart(t,0),this.collapse(!0);for(var i,r,o,a,s=[t],l=!1,c=!1;!c&&(i=s.pop());)if(3==i.nodeType)r=n+i.length,!l&&e.start>=n&&e.start<=r&&(this.setStart(i,e.start-n),l=!0),l&&e.end>=n&&e.end<=r&&(this.setEnd(i,e.end-n),c=!0),n=r;else if(!/^text$/i.exec(i.tagName||""))for(o=(a=i.childNodes).length;o--;)s.push(a[o])},getName:function(){return"DomRange"},equals:function(e){return ue.rangesEqual(this,e)},isValid:function(){return q(this)},inspect:function(){return F(this)},detach:function(){}}),le(ue,de),i.extend(ue,{rangeProperties:Q,RangeIterator:E,copyComparisonConstants:ae,createPrototypeRange:le,inspect:F,getRangeDocument:b,rangesEqual:function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset}}),l.DomRange=ue}),i.createCoreModule("WrappedRange",["DomRange"],function(d,u){var p,e,C=d.dom,h=d.util,k=C.DomPosition,f=d.DomRange,g=C.getBody,m=C.getContentDocument,S=C.isCharacterDataNode;if(d.features.implementsDomRange&&function(){var t,n,i=f.rangeProperties;function r(e){for(var t,n=i.length;n--;)e[t=i[n]]=e.nativeRange[t];e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset}p=function(e){if(!e)throw u.createError("WrappedRange: Range must be specified");this.nativeRange=e,r(this)},f.createPrototypeRange(p,function(e,t,n,i,r){var o=e.startContainer!==t||e.startOffset!=n,a=e.endContainer!==i||e.endOffset!=r,s=!e.equals(e.nativeRange);(o||a||s)&&(e.setEnd(i,r),e.setStart(t,n))}),(t=p.prototype).selectNode=function(e){this.nativeRange.selectNode(e),r(this)},t.cloneContents=function(){return this.nativeRange.cloneContents()},t.surroundContents=function(e){this.nativeRange.surroundContents(e),r(this)},t.collapse=function(e){this.nativeRange.collapse(e),r(this)},t.cloneRange=function(){var e=new p(this.nativeRange.cloneRange());return e.isBackward=this.isBackward,e},t.refresh=function(){r(this)},t.toString=function(){return this.nativeRange.toString()};var e=document.createTextNode("test");g(document).appendChild(e);var o=document.createRange();o.setStart(e,0),o.setEnd(e,0);try{o.setStart(e,1),t.setStart=function(e,t){this.nativeRange.setStart(e,t),r(this)},t.setEnd=function(e,t){this.nativeRange.setEnd(e,t),r(this)},n=function(t){return function(e){this.nativeRange[t](e),r(this)}}}catch(e){t.setStart=function(t,n){try{this.nativeRange.setStart(t,n)}catch(e){this.nativeRange.setEnd(t,n),this.nativeRange.setStart(t,n)}r(this)},t.setEnd=function(t,n){try{this.nativeRange.setEnd(t,n)}catch(e){this.nativeRange.setStart(t,n),this.nativeRange.setEnd(t,n)}r(this)},n=function(n,i){return function(t){try{this.nativeRange[n](t)}catch(e){this.nativeRange[i](t),this.nativeRange[n](t)}r(this)}}}t.setStartBefore=n("setStartBefore","setEndBefore"),t.setStartAfter=n("setStartAfter","setEndAfter"),t.setEndBefore=n("setEndBefore","setStartBefore"),t.setEndAfter=n("setEndAfter","setStartAfter"),t.selectNodeContents=function(e){this.setStartAndEnd(e,0,C.getNodeLength(e))},o.selectNodeContents(e),o.setEnd(e,3);var a=document.createRange();a.selectNodeContents(e),a.setEnd(e,4),a.setStart(e,2),-1==o.compareBoundaryPoints(o.START_TO_END,a)&&1==o.compareBoundaryPoints(o.END_TO_START,a)?t.compareBoundaryPoints=function(e,t){return e==(t=t.nativeRange||t).START_TO_END?e=t.END_TO_START:e==t.END_TO_START&&(e=t.START_TO_END),this.nativeRange.compareBoundaryPoints(e,t)}:t.compareBoundaryPoints=function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)};var s=document.createElement("div");s.innerHTML="123";var l=s.firstChild,c=g(document);c.appendChild(s),o.setStart(l,1),o.setEnd(l,2),o.deleteContents(),"13"==l.data&&(t.deleteContents=function(){this.nativeRange.deleteContents(),r(this)},t.extractContents=function(){var e=this.nativeRange.extractContents();return r(this),e}),c.removeChild(s),c=null,h.isHostMethod(o,"createContextualFragment")&&(t.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}),g(document).removeChild(e),t.getName=function(){return"WrappedRange"},d.WrappedRange=p,d.createNativeRange=function(e){return(e=m(e,u,"createNativeRange")).createRange()}}(),d.features.implementsTextRange){var o=function(e,t,n,i,r){var o=e.duplicate();o.collapse(n);var a=o.parentElement();if(C.isOrIsAncestorOf(t,a)||(a=t),!a.canHaveHTML){var s=new k(a.parentNode,C.getNodeIndex(a));return{boundaryPosition:s,nodeInfo:{nodeIndex:s.offset,containerElement:s.node}}}var l=C.getDocument(a).createElement("span");l.parentNode&&l.parentNode.removeChild(l);for(var c,d,u,p,h,f=n?"StartToStart":"StartToEnd",g=r&&r.containerElement==a?r.nodeIndex:0,m=a.childNodes.length,v=m,y=v;y==m?a.appendChild(l):a.insertBefore(l,a.childNodes[y]),o.moveToElementText(l),0!=(c=o.compareEndPoints(f,e))&&g!=v;){if(-1==c){if(v==g+1)break;g=y}else v=v==g+1?g:y;y=Math.floor((g+v)/2),a.removeChild(l)}if(h=l.nextSibling,-1==c&&h&&S(h)){var b;if(o.setEndPoint(n?"EndToStart":"EndToEnd",e),/[\r\n]/.test(h.data)){var w=o.duplicate(),x=w.text.replace(/\r\n/g,"\r").length;for(b=w.moveStart("character",x);-1==(c=w.compareEndPoints("StartToEnd",w));)b++,w.moveStart("character",1)}else b=o.text.length;p=new k(h,b)}else d=(i||!n)&&l.previousSibling,p=(u=(i||n)&&l.nextSibling)&&S(u)?new k(u,0):d&&S(d)?new k(d,d.data.length):new k(a,C.getNodeIndex(l));return l.parentNode.removeChild(l),{boundaryPosition:p,nodeInfo:{nodeIndex:y,containerElement:a}}},r=function(e,t){var n,i,r,o,a=e.offset,s=C.getDocument(e.node),l=g(s).createTextRange(),c=S(e.node);return c?i=(n=e.node).parentNode:(n=a<(o=e.node.childNodes).length?o[a]:null,i=e.node),(r=s.createElement("span")).innerHTML="&#feff;",n?i.insertBefore(r,n):i.appendChild(r),l.moveToElementText(r),l.collapse(!t),i.removeChild(r),c&&l[t?"moveStart":"moveEnd"]("character",a),l};if(((e=function(e){this.textRange=e,this.refresh()}).prototype=new f(document)).refresh=function(){var e,t,n,i,r=function(e){var t=e.parentElement(),n=e.duplicate();n.collapse(!0);var i=n.parentElement();(n=e.duplicate()).collapse(!1);var r=n.parentElement(),o=i==r?i:C.getCommonAncestor(i,r);return o==t?o:C.getCommonAncestor(t,o)}(this.textRange);0==(i=this.textRange).compareEndPoints("StartToEnd",i)?t=e=o(this.textRange,r,!0,!0).boundaryPosition:(e=(n=o(this.textRange,r,!0,!1)).boundaryPosition,t=o(this.textRange,r,!1,!1,n.nodeInfo).boundaryPosition),this.setStart(e.node,e.offset),this.setEnd(t.node,t.offset)},e.prototype.getName=function(){return"WrappedTextRange"},f.copyComparisonConstants(e),e.rangeToTextRange=function(e){if(e.collapsed)return r(new k(e.startContainer,e.startOffset),!0);var t=r(new k(e.startContainer,e.startOffset),!0),n=r(new k(e.endContainer,e.endOffset),!1),i=g(f.getRangeDocument(e)).createTextRange();return i.setEndPoint("StartToStart",t),i.setEndPoint("EndToEnd",n),i},d.WrappedTextRange=e,!d.features.implementsDomRange||d.config.preferTextRange){var t=function(){return this}();void 0===t.Range&&(t.Range=e),d.createNativeRange=function(e){return e=m(e,u,"createNativeRange"),g(e).createTextRange()},d.WrappedRange=e}}d.createRange=function(e){return e=m(e,u,"createRange"),new d.WrappedRange(d.createNativeRange(e))},d.createRangyRange=function(e){return e=m(e,u,"createRangyRange"),new f(e)},d.createIframeRange=function(e){return u.deprecationNotice("createIframeRange()","createRange(iframeEl)"),d.createRange(e)},d.createIframeRangyRange=function(e){return u.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),d.createRangyRange(e)},d.addCreateMissingNativeApiListener(function(e){var t=e.document;void 0===t.createRange&&(t.createRange=function(){return d.createRange(t)}),t=e=null})}),i.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(o,l){o.config.checkSelectionRanges=!0;var r,a,e="number",i=o.dom,t=o.util,n=t.isHostMethod,s=o.DomRange,c=o.WrappedRange,d=o.DOMException,u=i.DomPosition,p=o.features,h="Control",f=i.getDocument,g=i.getBody,m=s.rangesEqual;function v(e){return"string"==typeof e?/^backward(s)?$/i.test(e):!!e}function y(e,t){if(e){if(i.isWindow(e))return e;if(e instanceof U)return e.win;var n=i.getContentDocument(e,l,t);return i.getWindow(n)}return window}function b(e){return y(e,"getDocSelection").document.selection}function w(e){var t=!1;return e.anchorNode&&(t=1==i.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)),t}var x=n(window,"getSelection"),C=t.isHostObject(document,"selection");p.implementsWinGetSelection=x;var k=(p.implementsDocSelection=C)&&(!x||o.config.preferTextRange);k?(r=b,o.isSelectionValid=function(e){var t=y(e,"isSelectionValid").document,n=t.selection;return"None"!=n.type||f(n.createRange().parentElement())==t}):x?(r=function(e){return y(e,"getWinSelection").getSelection()},o.isSelectionValid=function(){return!0}):l.fail("Neither document.selection or window.getSelection() detected.");var S=(o.getNativeSelection=r)(),T=o.createNativeRange(document),F=g(document),E=t.areHostProperties(S,["anchorNode","focusNode","anchorOffset","focusOffset"]);p.selectionHasAnchorAndFocus=E;var _=n(S,"extend");p.selectionHasExtend=_;var M=typeof S.rangeCount==e;p.selectionHasRangeCount=M;var N=_?function(e,t){var n=s.getRangeDocument(t),i=o.createRange(n);i.collapseToPoint(t.endContainer,t.endOffset),e.addRange(D(i)),e.extend(t.startContainer,t.startOffset)}:null;t.areHostMethods(S,["addRange","getRangeAt","removeAllRanges"])&&typeof S.rangeCount==e&&p.implementsDomRange&&function(){var e=window.getSelection();if(e){for(var t=e.rangeCount,n=[],i=w(e),r=0;r<t;++r)n[r]=e.getRangeAt(r);for(r=0;r<t;++r)0==r&&i?N?N(e,n[r]):(o.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),e.addRange(n[r])):e.addRange(n[r])}}(),p.selectionSupportsMultipleRanges=!1,p.collapsedNonEditableSelectionsSupported=!0;var A,L,I=!1;function R(e,t,n){var i=n?"end":"start",r=n?"start":"end";e.anchorNode=t[i+"Container"],e.anchorOffset=t[i+"Offset"],e.focusNode=t[r+"Container"],e.focusOffset=t[r+"Offset"]}function P(e){e.anchorNode=e.focusNode=null,e.anchorOffset=e.focusOffset=0,e.rangeCount=0,e.isCollapsed=!0,e._ranges.length=0}function D(e){var t;return e instanceof s?((t=o.createNativeRange(e.getDocument())).setEnd(e.endContainer,e.endOffset),t.setStart(e.startContainer,e.startOffset)):e instanceof c?t=e.nativeRange:p.implementsDomRange&&e instanceof i.getWindow(e.startContainer).Range&&(t=e),t}function O(e){var t=e.getNodes();if(!function(e){if(!e.length||1!=e[0].nodeType)return!1;for(var t=1,n=e.length;t<n;++t)if(!i.isAncestorOf(e[0],e[t]))return!1;return!0}(t))throw l.createError("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element");return t[0]}function B(e){return!!e&&void 0!==e.text}function j(e,t){var n=new c(t);e._ranges=[n],R(e,n,!1),e.rangeCount=1,e.isCollapsed=n.collapsed}function $(e){if(e._ranges.length=0,"None"==e.docSelection.type)P(e);else{var t=e.docSelection.createRange();if(B(t))j(e,t);else{e.rangeCount=t.length;for(var n,i=f(t.item(0)),r=0;r<e.rangeCount;++r)(n=o.createRange(i)).selectNode(t.item(r)),e._ranges.push(n);e.isCollapsed=1==e.rangeCount&&e._ranges[0].collapsed,R(e,e._ranges[e.rangeCount-1],!1)}}}function H(e,t){for(var n=e.docSelection.createRange(),i=O(t),r=f(n.item(0)),o=g(r).createControlRange(),a=0,s=n.length;a<s;++a)o.add(n.item(a));try{o.add(i)}catch(e){throw l.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}newControlrange.select(t.isBackward),$(e)}function U(e,t,n){this.nativeSelection=e,this.docSelection=t,this._ranges=[],this.win=n,this.refresh()}function W(e){e.win=e.anchorNode=e.focusNode=e._ranges=null,e.rangeCount=e.anchorOffset=e.focusOffset=0,e.detached=!0}F&&n(F,"createControlRange")&&(A=F.createControlRange(),t.areHostProperties(A,["item","add"])&&(I=!0)),p.implementsControlRange=I,a=E?function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}:function(e){return!!e.rangeCount&&e.getRangeAt(e.rangeCount-1).collapsed},n(S,"getRangeAt")?L=function(e,t){try{return e.getRangeAt(t)}catch(e){return null}}:E&&(L=function(e){var t=f(e.anchorNode),n=o.createRange(t);return n.setStartAndEnd(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset),n.collapsed!==this.isCollapsed&&n.setStartAndEnd(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset),n}),U.prototype=o.selectionPrototype;var q=[];function z(e,t){for(var n,i,r=q.length;r--;)if(i=(n=q[r]).selection,"deleteAll"==t)W(i);else if(n.win==e)return"delete"==t?(q.splice(r,1),!0):i;return"deleteAll"==t&&(q.length=0),null}var V=function(e){if(e&&e instanceof U)return e.refresh(),e;var t=z(e=y(e,"getNativeSelection")),n=r(e),i=C?b(e):null;return t?(t.nativeSelection=n,t.docSelection=i,t.refresh()):(t=new U(n,i,e),q.push({win:e,selection:t})),t};o.getSelection=V,o.getIframeSelection=function(e){return l.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),o.getSelection(i.getIframeWindow(e))};var K,Y=U.prototype;function J(e,t){for(var n,i=f(t[0].startContainer),r=g(i).createControlRange(),o=0,a=t.length;o<a;++o){n=O(t[o]);try{r.add(n)}catch(e){throw l.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}controlrange.select(range.isBackward),$(e)}if(!k&&E&&t.areHostMethods(S,["removeAllRanges","addRange"])){Y.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),P(this)};var Q=function(e,t){N(e.nativeSelection,t),e.refresh()};Y.addRange=M?function(e,t){var n;if(I&&C&&this.docSelection.type==h)H(this,e);else if(v(t)&&_)Q(this,e);else if(this.removeAllRanges(),n=0,this.nativeSelection.addRange(D(e).cloneRange()),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==n+1){if(o.config.checkSelectionRanges){var i=L(this.nativeSelection,this.rangeCount-1);i&&!m(i,e)&&(e=new c(i))}R(this,this._ranges[this.rangeCount-1]=e,G(this.nativeSelection)),this.isCollapsed=a(this)}else this.refresh()}:function(e,t){v(t)&&_?Q(this,e):(this.nativeSelection.addRange(D(e)),this.refresh())},Y.setRanges=function(e){if(I&&1<e.length)J(this,e);else{this.removeAllRanges();for(var t=0,n=e.length;t<n;++t)this.addRange(e[t])}}}else{if(!(n(S,"empty")&&n(T,"select")&&I&&k))return l.fail("No means of selecting a Range or TextRange was found"),!1;Y.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var e;if(this.anchorNode)e=f(this.anchorNode);else if(this.docSelection.type==h){var t=this.docSelection.createRange();t.length&&(e=f(t.item(0)))}if(e){g(e).createTextRange();textrange.select(range.isBackward),this.docSelection.empty()}}}catch(e){}P(this)},Y.addRange=function(e){this.docSelection.type==h?H(this,e):(o.WrappedTextRange.rangeToTextRange(e).select(),this._ranges[0]=e,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,R(this,e,!1))},Y.setRanges=function(e){this.removeAllRanges();var t=e.length;1<t?J(this,e):t&&this.addRange(e[0])}}if(Y.getRangeAt=function(e){if(e<0||e>=this.rangeCount)throw new d("INDEX_SIZE_ERR");return this._ranges[e].cloneRange()},k)K=function(e){var t;o.isSelectionValid(e.win)?t=e.docSelection.createRange():(t=g(e.win.document).createTextRange()).collapse(!0),e.docSelection.type==h?$(e):B(t)?j(e,t):P(e)};else if(n(S,"getRangeAt")&&typeof S.rangeCount==e)K=function(e){if(I&&C&&e.docSelection.type==h)$(e);else if(e._ranges.length=e.rangeCount=e.nativeSelection.rangeCount,e.rangeCount){for(var t=0,n=e.rangeCount;t<n;++t)e._ranges[t]=new o.WrappedRange(e.nativeSelection.getRangeAt(t));R(e,e._ranges[e.rangeCount-1],G(e.nativeSelection)),e.isCollapsed=a(e)}else P(e)};else{if(!E||"boolean"!=typeof S.isCollapsed||"boolean"!=typeof T.collapsed||!p.implementsDomRange)return l.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;K=function(e){var t,n,i,r=e.nativeSelection;r.anchorNode?(t=L(r,0),e._ranges=[t],e.rangeCount=1,i=(n=e).nativeSelection,n.anchorNode=i.anchorNode,n.anchorOffset=i.anchorOffset,n.focusNode=i.focusNode,n.focusOffset=i.focusOffset,e.isCollapsed=a(e)):P(e)}}Y.refresh=function(e){var t=e?this._ranges.slice(0):null,n=this.anchorNode,i=this.anchorOffset;if(K(this),e){var r=t.length;if(r!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=i)return!0;for(;r--;)if(!m(t[r],this._ranges[r]))return!0;return!1}};var G,X=function(e,t){var n=e.getAllRanges();e.removeAllRanges();for(var i=0,r=n.length;i<r;++i)m(t,n[i])||e.addRange(n[i]);e.rangeCount||P(e)};function Z(e,t){if(e.win.document!=f(t))throw new d("WRONG_DOCUMENT_ERR")}function ee(i){return function(e,t){var n;this.rangeCount?(n=this.getRangeAt(0))["set"+(i?"Start":"End")](e,t):(n=o.createRange(this.win.document)).setStartAndEnd(e,t),this.setSingleRange(n,this.isBackward())}}function te(e){var t=[],n=new u(e.anchorNode,e.anchorOffset),i=new u(e.focusNode,e.focusOffset),r="function"==typeof e.getName?e.getName():"Selection";if(void 0!==e.rangeCount)for(var o=0,a=e.rangeCount;o<a;++o)t[o]=s.inspect(e.getRangeAt(o));return"["+r+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+i.inspect()+"]"}Y.removeRange=I?function(e){if(this.docSelection.type==h){for(var t=this.docSelection.createRange(),n=O(e),i=f(t.item(0)),r=g(i).createControlRange(),o=!1,a=0,s=t.length;a<s;++a)t.item(a)!==n||o?r.add(t.item(a)):o=!0;newControlrange.select(e.isBackward),$(this)}else X(this,e)}:function(e){X(this,e)},!k&&E&&p.implementsDomRange?(G=w,Y.isBackward=function(){return G(this)}):G=Y.isBackward=function(){return!1},Y.isBackwards=Y.isBackward,Y.toString=function(){for(var e=[],t=0,n=this.rangeCount;t<n;++t)e[t]=""+this._ranges[t];return e.join("")},Y.collapse=function(e,t){Z(this,e);var n=o.createRange(e);n.collapseToPoint(e,t),this.setSingleRange(n),this.isCollapsed=!0},Y.collapseToStart=function(){if(!this.rangeCount)throw new d("INVALID_STATE_ERR");var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)},Y.collapseToEnd=function(){if(!this.rangeCount)throw new d("INVALID_STATE_ERR");var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)},Y.selectAllChildren=function(e){Z(this,e);var t=o.createRange(e);t.selectNodeContents(e),this.setSingleRange(t)},Y.deleteFromDocument=function(){if(I&&C&&this.docSelection.type==h){for(var e,t=this.docSelection.createRange();t.length;)e=t.item(0),t.remove(e),e.parentNode.removeChild(e);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var i=0,r=n.length;i<r;++i)n[i].deleteContents();this.addRange(n[r-1])}}},Y.eachRange=function(e,t){for(var n=0,i=this._ranges.length;n<i;++n)if(e(this.getRangeAt(n)))return t},Y.getAllRanges=function(){var t=[];return this.eachRange(function(e){t.push(e)}),t},Y.setSingleRange=function(e,t){this.removeAllRanges(),this.addRange(e,t)},Y.callMethodOnEachRange=function(t,n){var i=[];return this.eachRange(function(e){i.push(e[t].apply(e,n))}),i},Y.setStart=ee(!0),Y.setEnd=ee(!1),o.rangePrototype.select=function(e){V(this.getDocument()).setSingleRange(this,e)},Y.changeEachRange=function(t){var n=[],e=this.isBackward();this.eachRange(function(e){t(e),n.push(e)}),this.removeAllRanges(),e&&1==n.length?this.addRange(n[0],"backward"):this.setRanges(n)},Y.containsNode=function(t,n){return this.eachRange(function(e){return e.containsNode(t,n)},!0)},Y.getBookmark=function(e){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[e])}},Y.moveToBookmark=function(e){for(var t,n,i=[],r=0;t=e.rangeBookmarks[r++];)(n=o.createRange(this.win)).moveToBookmark(t),i.push(n);e.backward?this.setSingleRange(i[0],"backward"):this.setRanges(i)},Y.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")},Y.getName=function(){return"WrappedSelection"},Y.inspect=function(){return te(this)},Y.detach=function(){z(this.win,"delete"),W(this)},U.detachAll=function(){z(null,"deleteAll")},U.inspect=te,U.isDirectionBackward=v,o.Selection=U,o.selectionPrototype=Y,o.addCreateMissingNativeApiListener(function(e){void 0===e.getSelection&&(e.getSelection=function(){return V(e)}),e=null})}),n.exports=i}),define("app/editor/Fences",["codemirror/lib/codemirror","app/document/StringUtils","jquery/jquery","exoskeleton-master/exoskeleton","autoComplete","app/document/Node","app/editor/KeyMaster","app/editor/Diagram","app/editor/KeyMaster","codemirror/addon/selection/mark-selection","codemirror/addon/edit/closebrackets","codemirror/addon/edit/closetag","codemirror/addon/mode/overlay","codemirror/addon/lint/lint"],function(t,e,n){"use strict";var f=t("codemirror/lib/codemirror"),o=t("app/document/StringUtils"),g=t("jquery/jquery"),i=t("exoskeleton-master/exoskeleton"),m=t("autoComplete.js"),r=t("app/document/Node"),a=t("app/editor/KeyMaster"),v=t("app/editor/Diagram"),y=a.map;Node=r.Node;var s=f.prototype.focus;f.prototype.focus=function(){f.signal(this,"focus",this),s.apply(this)};t("codemirror/addon/selection/mark-selection"),t("codemirror/addon/edit/closebrackets"),t("codemirror/addon/edit/closetag"),t("codemirror/addon/mode/overlay"),t("codemirror/addon/lint/lint.js");var l,c,d=["js","javascript","java","json","typescript","clojure","coffeescript","css","less","scss","gfm","markdown","xaml","xml","haskell","html","lua","lisp","commonlisp","pascal","perl","php","php+HTML","python","cython","ruby","shell","sh","sql","sql lite","mssql","mysql","CQL","mariadb","cassandra","plsql","tiddlywiki","wiki","vb","basic","visual basic","vbscript","velocity","verilog","xquery","yaml","go","groovy","nginx","octave","c","clike","c++","cpp","objc","objective-c","csharp","c#","squirrel","ceylon","kotlin","tex","latex","swift","scala","R","D","diff","erlang","http","jade","rst","rust","jinja2","reStructuredText","asp","jsp","erb","ejs","embeddedjs","powershell","dockerfile","jsx","react","vue","nsis","mathematica","tiki wiki","properties","ini","livescript","assembly","gas","toml","matlab","ocaml","F#","fsharp","elm","pgp","asciiarmor","spreadsheet","elixir","cmake","cypher","dart","django","dtd","xml-dtd","dylan","handlebars","idl","web-idl","yacas","mbox","vhdl","julia","haxe","hxml","fortran","protobuf","makefile","tcl","scheme","twig","bash","SAS"];c=(l=f).commands.delLineLeft,l.commands.delLineLeft=function(e){try{return 0==e.getCursor().ch?l.commands.delCharBefore(e):c(e)}catch(e){}};var b=function(t,e){var n=[];return d.map(function(e){0==e.toLowerCase().indexOf(t.toLowerCase())&&n.push(e)}),n.sort(),n.length<4&&d.map(function(e){0<e.toLowerCase().indexOf(t.toLowerCase())&&n.push(e)}),e&&1==n.length&&n[0]==t?[]:n};function u(e){if(e)switch(e){case"javascript":case"text/javascript":case"js":return e="javascript";case"json":return e={name:"javascript",json:!0};case"text/typescript":case"typescript":case"ts":return e={name:"javascript",typescript:!0};case"clojure":return e;case"coffee":case"coffeescript":case"css":return e;case"less":return"text/x-less";case"scss":return e="text/x-scss";case"gfm":case"github flavored markdown":return e="gfm";case"markdown":case"md":case"mkd":return e;case"xml":case"xaml":return"xml";case"haskell":return e;case"htmlmixed":case"html":return e="htmlmixed";case"lua":return e;case"lisp":case"commonlisp":case"common lisp":return e="commonlisp";case"pascal":case"perl":return e;case"php+html":return"application/x-httpd-php";case"php":case"php3":case"php4":case"php5":case"php6":return"text/x-php";case"cython":return e="text/x-cython";case"python":return e="text/x-python";case"ruby":return e;case"shell":case"sh":case"zsh":case"bash":return e="shell";case"sql":case"sql lite":return e="text/x-sql";case"mssql":return e="text/x-mssql";case"mysql":return e="text/x-mysql";case"mariadb":return e="text/x-mariadb";case"cassandra":case"cql":return e="text/x-cassandra";case"plsql":return e="text/x-plsql";case"stex":case"tex":case"latex":return"text/x-stex";case"tiddlywiki":case"wiki":return e="tiddlywiki";case"vb":case"visual basic":case"visualbasic":case"basic":return e="vb";case"vbscript":case"velocity":return e;case"verilog":return e="text/x-verilog";case"xquery":case"yaml":case"go":case"groovy":case"nginx":return e;case"octave":case"matlab":return"text/x-octave";case"c":case"clike":case"csrc":return e="text/x-csrc";case"c++":case"c++src":case"cpp":case"cc":case"hpp":case"h++":case"h":return e="text/x-c++src";case"obj-c":case"objc":case"objective c":case"objective-c":case"objectivec":return e="text/x-objectivec";case"text/x-scala":case"scala":return e="text/x-scala";case"csharp":case"c#":case"cs":return e="text/x-csharp";case"java":return e="text/x-java";case"squirrel":return e="text/x-squirrel";case"ceylon":return e="text/x-ceylon";case"kotlin":return e="text/x-kotlin";case"swift":return e="swift";case"r":case"rlang":case"r-lang":return e="text/x-rsrc";case"d":case"diff":case"erlang":case"http":case"jade":return e;case"rst":case"restructuredtext":return e="rst";case"rust":case"jinja2":return e;case"aspx":case"asp":case"asp.net":return e="application/x-aspx";case"jsp":return e="application/x-jsp";case"erb":return e="application/x-erb";case"ejs":case"embeddedjs":case"embedded javaScript":return e="application/x-ejs";case"powershell":case"bat":case"cmd":return"application/x-powershell";case"dockerfile":return"text/x-dockerfile";case"jsx":case"react":return"text/jsx";case"vue.js":case"vue":case"vue-template":return"script/x-vue";case"nsis":return"text/x-nsis";case"mathematica":return"text/x-mathematica";case"tiki":case"tiki wiki":case"tiki-wiki":case"tikiwiki":return"tiki";case"properties":case"ini":return"text/x-properties";case"livescript":return"text/x-livescript";case"asm":case"assembly":case"nasm":case"gas":return"assembly";case"toml":return"text/x-toml";case"sequence":return"sequence";case"flow":case"flowchart":return"flow";case"mermaid":return"mermaid";case"ocaml":return"text/x-ocaml";case"f#":case"fsharp":return"text/x-fsharp";case"elm":return"text/x-elm";case"pgp":case"pgp-keys":case"pgp-key":case"pgp-signature":case"asciiarmor":case"ascii-armor":case"ascii armor":return"application/pgp";case"spreadsheet":case"excel":return"text/x-spreadsheet";case"elixir":return"elixir";case"cmake":return"text/x-cmake";case"cypher":case"cypher-query":return"application/x-cypher-query";case"dart":return"dart";case"django":return"text/x-django";case"dtd":case"xml-dtd":case"xml dtd":case"xmldtd":return"application/xml-dtd";case"dylan":return"text/x-dylan";case"handlebars":return"text/x-handlebars-template";case"idl":return"text/x-idl";case"webidl":case"web-idl":case"web idl":return"text/x-webidl";case"yacas":return"text/x-yacas";case"mbox":return"application/mbox";case"vhdl":return"text/x-vhdl";case"julia":return"julia";case"haxe":return"text/x-haxe";case"hxml":return"text/x-hxml";case"fortran":return"text/x-fortran";case"protobuf":return"text/x-protobuf";case"makefile":return"text/x-makefile";case"tcl":return"text/x-tcl";case"scheme":return"text/x-scheme";case"twig":return"text/x-twig";case"sas":return"text/x-sas"}}window.getCodeMirrorMode=function(e,t){var n=((e=(e=e?e.toLowerCase():"").replace(/^\s*\.*lang(uage)*-/g,"").replace(/[{}]/g,"").trim()).split(/\s+/)||[e])[0],i=u(e);return i||e==n||(i=u(n)),i||(t?null:e)};var p=i.Model.extend({initialize:function(e){var n=this;this.editor=e,this.queue={},this.cachedCharWidth,this.$container=g("#fences-auto-suggest"),this.editor.diagrams=new v(e),File.option.enableDiagram&&(d=d.concat(v.MODES)),g(document).on("losefocus",".md-fences",function(){var e=g(this),t=n.queue[e.attr("cid")];t&&(n.syncToNode(this.getAttribute("cid")),t.doc.setCursor(0,0,{scroll:!1}),e.find(".md-tooltip-hide").hide(),e[0].style.marginBottom="")}).on("mousedown",".autoComplt-list li",function(e){return g("input.mode:focus").val(this.textContent),!1}),this.lazyload(),this.editor.diagrams.lazyload()},showAutoSuggest:function(e,t){if(t.token===e)return!1;var n=b(e,!0),i="";if(t.type="fences",t.token=e,t.match=n,t.found=n.length,t.pageNo=0,t.pageCnt=Math.floor((n.length-1)/5+1),!t.found)return this.$container.hide(),!1;for(var r=0;r<n.length&&r<40;r++)r%5==0&&(i+=(0<r?"</ul>":"")+"<ul data-page='"+r/5+"' style='display:none'>"),i+="<li data-content='"+n[r]+"' > "+n[r]+"</span></li>";return i+="</ul>",this.$container.html(i),this.$container},clickEventHandled:function(e,t){var n,i,r;this.queue[t]||(r=window.scrollY,this.getCm(t),r-=window.scrollY,window.scrollBy(0,r),(n=document.elementFromPoint(e.clientX,e.clientY))&&(e.stopPropagation(),(i=document.createEvent("MouseEvents")).initMouseEvent("mousedown",!0,!0,n.ownerDocument.defaultView,1,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button),n.dispatchEvent(i)),this.editor.refocus(t))},getCm:function(e){if(this.queue[e]){if(g("[cid='"+e+"'] textarea").length)return this.queue[e];delete this.queue[e]}if(!this.queue[e])return this.addCodeBlock(e)},getValue:function(e){return this.queue[e]?this.queue[e].getValue():this.editor.findElemById(e).text()},addCodeBlock:function(t){var a=this.editor,s=this;function e(e,t){var n,i=t.which||t.keyCode,r=f.keyName(t),o=!t.metaKey&&!t.shiftKey&&!t.ctrlKey;if("Up"==f.keyNames[i]){if((n=e.getCursor())&&0==n.line){if(o)return a.selection.moveUpOrDown(!0,t),t.codemirrorIgnore;if(0==n.ch&&!t.shiftKey&&(File.isNode&&t.ctrlKey||File.isMac&&t.metaKey))return void(t.codemirrorIgnore=!0)}t.stopPropagation()}else if("Down"==f.keyNames[i]){if((n=e.getCursor())&&n.line>=e.lineCount()-1){if(o)return a.selection.moveUpOrDown(!1,t),t.codemirrorIgnore;if(n.ch==e.doc.getLine(n.line).length&&!t.shiftKey&&(File.isNode&&t.ctrlKey||File.isMac&&t.metaKey))return void(t.codemirrorIgnore=!0)}t.stopPropagation()}else if("Left"==f.keyNames[i]){if((n=e.doc.getCursor())&&!n.line&&!n.ch&&o)return a.selection.moveUpOrDown(!0,t),t.codemirrorIgnore;t.stopPropagation()}else if("Right"==f.keyNames[i]){if((n=e.doc.getCursor())&&n.line>=e.lineCount()-1&&n.ch>=e.doc.getLine(n.line).length&&o)return a.selection.moveUpOrDown(!1,t),t.codemirrorIgnore;t.stopPropagation()}else if("Backspace"==f.keyNames[i]){if((n=e.doc.getCursor())&&e.lineCount()<=1&&!n.line&&!n.ch&&!e.getSelection().length)return function(e){a.findElemById(e.cid);var t=a.getNode(e.cid),n=a.undo.UndoManager,i=n.makeEmptyCommand();t.get("before"),s.beforeDeleteFences(e.cid),i.undo.push({type:"fences-pos",pos:e.getCursor(),id:e.cid}),n.append(i,a.UserOp.backToParagraph(a,t,!1)),a.undo.register(i)}(e),t.preventDefault(),t.codemirrorIgnore;t.stopPropagation()}else if("PageDown"==f.keyNames[i]){if(!(n=e.doc.getCursor(n))||e.doc.indexFromPos(n)>=e.doc.getValue().length)return e.execCommand("goDocEnd"),a.selection.moveUpOrDown(!1),void(t.codemirrorIgnore=!0)}else if("PageUp"==f.keyNames[i]){if(!(n=e.doc.getCursor())||0==n.line&&0==n.ch)return e.execCommand("goDocStart"),a.selection.moveUpOrDown(!0),void(t.codemirrorIgnore=!0)}else if("Enter"==f.keyNames[i]&&(File.isMac?t.metaKey:t.ctrlKey)&&(n=e.doc.getCursor(),e.lineCount()-1==n.line&&n.ch>=e.doc.getLine(n.line).length))return a.UserOp.insertParagraph(!1),t.stopPropagation(),void(t.codemirrorIgnore=!0);(f.keyMap.macDefault[r]||f.keyMap.pcDefault[r])&&t.stopPropagation()}function n(e){a.undo.completeSnap(!0),e.getWrapperElement().offsetHeight||e.refresh(),g(e.getTextArea()).closest(".md-fences").find(".md-tooltip-hide").show(),a.refocus(t.id),c(e),v.isDiagramType(e.options.mode)&&a.diagrams.startPreview(e.cid),File.isMac&&app.touchBar&&app.touchBar.setFencesOnSetLang(!1)}function i(e,t){}function r(e,t){if(e.focus(),""==e.getSelection()){f.posFromMouse(e,t);var n=e.findWordAt(f.posFromMouse(e,t));e.setSelection(n.head,n.anchor)}File.isNodeHtml&&File.contextMenu.show(t)}function o(e,t){a.brush.updateWordCount(),v.isDiagramType(e.options.mode)&&a.diagrams.updateDiagram(e.cid),t.length&&t[0].origin&&a.syncChange([{type:"sync",id:e.cid,cmChanges:t}])}function l(e,t){v.isDiagramType(e.options.mode)&&t.ranges.length&&t.ranges[0].anchor.line!=(e.getCursor()||{}).line&&a.diagrams.attachError(e)}function c(e,t){File.isTypeWriterMode&&File.option.scrollWithCursor&&a.selection.typeWriterScroll(g(e.display.wrapper).find(".CodeMirror-activeline")),a.brush.updateWordCountInSelection()}function d(e,t){File.isTypeWriterMode&&t.preventDefault()}if("string"==typeof t&&(t=this.editor.getNode(t)),!this.queue[t.id]&&t.get("type")==t.TYPE.fences){var u="<textarea id = 'for-fence-"+t.id+"' />",p=g("[cid = "+t.id+"]").removeClass("mock-cm"),h=p.find(".md-diagram-panel").clone();p.html(u),(u=g("#for-fence-"+t.id)[0]).value=t.safeGetStrAttr("text").replace(/\u200b```/gi,"```"),this.queue[t.id]=f.fromTextArea(u,{lineWrapping:!File.option.noLineWrapping,mode:getCodeMirrorMode(t.get("lang")),styleSelectedText:!0,maxHighlightLength:1/0,viewportMargin:1/0,styleActiveLine:!0,autoCloseBrackets:!File.option.noPairingMatch,autoCloseTags:!File.option.noPairingMatch,theme:" inner",lineNumbers:File.option.showLineNumbersForFence,resetSelectionOnContextMenu:!0,cursorScrollMargin:60,dragDrop:!1,indentUnit:File.option.codeIndentSize,tabSize:File.option.codeIndentSize},this.editor,t.id),t.get("history")&&this.queue[t.id].setHistory(t.get("history")),this.queue[t.id].off("keydown",e),this.queue[t.id].on("keydown",e),this.queue[t.id].off("focus",n),this.queue[t.id].on("focus",n),this.queue[t.id].off("mousedown",i),this.queue[t.id].on("mousedown",i),this.queue[t.id].off("changes",o),this.queue[t.id].on("changes",o),this.queue[t.id].off("scrollCursorIntoView",d),this.queue[t.id].on("scrollCursorIntoView",d),this.queue[t.id].off("cursorActivity",c),this.queue[t.id].on("cursorActivity",c),this.queue[t.id].off("contextmenu",r),this.queue[t.id].on("contextmenu",r),this.queue[t.id].off("beforeSelectionChange",l),this.queue[t.id].on("beforeSelectionChange",l),g("[cid = "+t.id+"] .CodeMirror").before("<div class= 'code-tooltip md-tooltip-hide' align='right'><input class='mode' autocorrect='false' type='text' value='"+(t.get("lang")?t.get("lang"):"").replace(/'/g,"&#39;")+"' placeholder='select a language'></div> ").find(".CodeMirror").attr("lang",(t.get("lang")||"").toLowerCase()),h.length&&p.append(h),function(e,t){var n=this,i=e.find("input.mode").change(function(){t.attr("lang",g(this).val(),n.editor,!1)}).keydown(function(e){var t=e.which||e.keyCode;"Enter"==y[t]&&g(this).trigger("change")}).focus(function(){File.isMac&&app.touchBar&&app.touchBar.setFencesOnSetLang(!0)});return m.enable(i[0],{hintsFetcher:function(e,t){t(b(e));var n=document.querySelector(".autoComplt-list");n&&(n.style.height="auto")},maxHintNum:5}),e}.call(this,p,t)}return this.queue[t.id]},toggleFocusedComponent:function(){var e=document.activeElement,t=g(e).closest(".md-fences");if(t.length)if("INPUT"==e.tagName){var n=t.attr("cid"),i=this.getCm(n),r=i.getCursor();g("[cid = "+n+"] textarea").focus(),i.focus(),i.setCursor(r)}else t.find(".CodeMirror-focused").removeClass("CodeMirror-focused").end().find("input.mode").show().focus()},focus:function(e){this.editor.undo.completeSnap(!0);var t="string"==typeof e?e:e.id;this.editor;this.editor.findElemById(t).addClass("md-focus").closest("p").addClass("md-focus-p"),this.getCm(t),window.getSelection().removeAllRanges(),setTimeout(function(){g("[cid = "+t+"] textarea").focus()},50)},getFocused:function(){for(var e in this.queue)if(this.queue.hasOwnProperty(e)&&this.queue[e].hasFocus())return this.queue[e]},updateCodeNum:function(){for(var e in this.queue)this.editor.getNode(e)||delete this.queue[e]},syncToNode:function(e){var t,n;(t="string"==typeof e?this.editor.getNode(e):e)&&((n=this.getCm(t.id)).save(),t.set("history",n.doc.getHistory()),this.editor.findElemById(t.id).children().length?t.set("text",this.queue[t.id].getValue()):t.set("text",""))},refreshEditor:function(t,e,n){var i=this,r=0;for(var o in this.queue)this.editor.getNode(o)&&this.editor.findElemById(o).find(".CodeMirror").length?(e&&this.queue[o].refresh(),r++):(delete this.queue[o],Node.isType(this.editor.getNode(o),Node.TYPE.fences)&&this.addCodeBlock(o));var a=(n?n.find("[mdtype='fences']"):g("[mdtype='fences']")).toArray(),s=this.editor,l=0;a.length!=r&&a.map(function(e){s.getNode(e.getAttribute("cid")).get("lang")?(l++,i.addCodeBlock(e.getAttribute("cid"))):(t||l<30)&&(i.addCodeBlock(e.getAttribute("cid")),l++)})},lazyload:function(){var e=this;t.async(window.debugMode?"codemirror/mode.js":File.isMac?"lib/codemirror/mode.min.js":"lib.asar/codemirror/mode.min.js",function(){e.modeLoaded=!0,e.refreshEditor()})},addToUndoManager:function(e){this.editor.undo.register({undo:[{type:"fences",cmd:"undo",id:e.cid}],redo:[{type:"fences",cmd:"redo",id:e.cid}]})},jumpCmEnd:function(e){var t=this.getCm(e),n=0,i=0;t&&(n=t.doc.lastLine(),i=t.doc.getLine(n).length,t.focus(),t.setCursor({line:n,ch:i}))},jumpCmBegin:function(e){var t=this.getCm(e);t.focus(),t.setCursor({line:0,ch:0})},beforeDeleteFences:function(e,t){var n,i;"string"==typeof e?(n=this.queue[e],i=this.editor.getNode(e)):(i=e,n=this.queue[i.id]),n&&(i.set("text",n.getValue()),i.set("history",n.doc.getHistory()),n.toTextArea(),n.doc.history=null,delete this.queue[i.id],t&&t.map(function(e){e&&(e.id==i.id&&e.json&&e.json.content&&e.json.content.type==i.TYPE.fences?(e.json.content.text=i.get("text"),e.json.content.history=i.get("history")):Array.isArray(e.json)&&e.json.map(function(e){e.id==i.id&&e.content.type==i.TYPE.fences&&(e.content.text=i.get("text"),e.content.history=i.get("history"))}))}))},deletionMonitor:function(e){var t=this;e.find("[mdtype='fences']").toArray().map(function(e){t.beforeDeleteFences(e.getAttribute("cid"))})},searchOn:function(e,t,n){this.searchStatus=this.searchStatus||{},this.searchStatus.overlay=this.searchStatus.overlay||{};var i,r=new RegExp("^"+o.escapeRegExp(t),n.caseSensitive?"":"i");this.searchStatus.overlay[e.cid||"source"]=(i=t,{token:function(e){return n.wholeWord&&e.pos&&/[a-z_\\u00C0-\\u024f]/.exec(e.string.substring(e.pos-1,e.pos))||!e.match(r)||n.wholeWord&&/[a-z_\\u00C0-\\u024f]/.exec(e.string.substr(e.pos,e.pos+1))?(e.next(),e.pos=e.string.toLowerCase().indexOf(i,e.pos),!~e.pos&&e.skipToEnd(),null):"search-hit"}}),e.addOverlay(this.searchStatus.overlay[e.cid||"source"])},clearSearchOn:function(e){this.searchStatus&&e.removeOverlay(this.searchStatus.overlay[e.cid||"source"])},clearSearchAll:function(){if(this.editor.sourceView.inSourceMode)return this.searchStatus&&this.editor.sourceView.cm.removeOverlay(this.searchStatus.overlay.source),void(this.searchStatus=null);if(this.searchStatus&&this.searchStatus.overlay)for(var e in this.queue)this.queue.hasOwnProperty(e)&&this.searchStatus.overlay[e]&&this.queue[e].removeOverlay(this.searchStatus.overlay[e])}});n.exports=p,window.CodeMirror=f,window.Fences=p}),define("autoComplete",[],function(e,t,n){var v=e("jquery/jquery"),i=function(){var t="autoComplt-list",i="autoComplt-hint",r="active",n=10,d=100,o={attr:"data-listStatus",open:"open"},u={up:38,down:40,esc:27,enter:13,left:37,right:39},a={autoCompltList:{maxHeight:"none",border:"1px solid #aaa",padding:"0",margin:"0",zIndex:99,overflowX:"hidden",overflowY:"auto",display:"none",position:"absolute",backgroundColor:"#fff"},autoCompltHint:{height:"1.5em",padding:"2px 6px 2px 10px",margin:"6px 0",overflow:"hidden",listStyleType:"none",color:"#000",backgroundColor:"#fff",cursor:"default",fontSize:"1em"},autoCompltHintSelected:{color:"#fff",backgroundColor:"#3399ff"}},s=function(e){return(e=e||window.event).target=e.target||e.srcElement,e},p=function(e,t,n){e.addEventListener?e.addEventListener(t,n):e.attachEvent&&e.attachEvent("on"+t,n)},h=function(e,t,n){e.removeEventListener?e.removeEventListener(t,n):e.detachEvent&&e.detachEvent("on"+t,n)},l=function(e,t){var n=null;if(window.getComputedStyle)n=window.getComputedStyle(e)[t]||null;else if(e.currentStyle){n=e.currentStyle&&e.currentStyle[t];var i,r,o=e.style;null==n&&o&&o[t]&&(n=o[t]),i=o.left,(r=e.runtimeStyle&&e.runtimeStyle.left)&&(e.runtimeStyle.left=e.currentStyle.left),o.left="fontSize"===t?"1em":n,n=o.pixelLeft+"px",o.left=i,r&&(e.runtimeStyle.left=r)}return n},c={buildElem:function(e){var t=document.createElement("DIV");return t.innerHTML=e,t.firstChild.cloneNode(!0)},buildHint:function(e,t){return"string"==typeof e&&e?e=this.buildElem('<li class="'+i+'">'+e+"</li>"):null},buildList:function(e){return this.buildElem('<div class="auto-suggest-container md-tooltip-hide"><ul class="'+t+'"></ul></div>')}},f=function(e){this.uiElem=null,this.assocInput=e,this.mouseOnList=!1,this.pauseMouseoverSelection=!1,this.pauseMouseoutDeselection=!1,this.maxHintNum=n,this.styles=JSON.parse(JSON.stringify(a))};f.prototype.genList=function(){if(!this.uiElem){var t=this;this.uiElem=c.buildList(this.styles),p(this.uiElem,"mouseover",function(e){e=s(e),t.isHint(e.target)&&(t.select(e.target),t.autoScroll())}),p(this.uiElem,"mouseout",function(e){e=s(e),t.deselect()}),p(this.uiElem,"mousedown",function(e){t.mouseOnList=!0,"INPUT"!==t.assocInput.tagName&&t.getSelected()&&e.preventDefault()}),p(this.uiElem,"mouseup",function(e){e=s(e),t.isHint(e.target)&&(t.select(e.target),m(t.assocInput,t.getSelected().innerHTML),t.assocInput.autoComplt.close(),v(t.assocInput).trigger("change"))}),document.body.appendChild(this.uiElem)}},f.prototype.isHint=function(e){return!(!e||"object"!=typeof e||1!==e.nodeType)&&0<=(" "+e.className+" ").indexOf(" "+i+" ")},f.prototype.putHints=function(e){var t=0;if(e instanceof Array){var n,i,r=[];for(i=Math.min(e.length,this.maxHintNum),n=0;n<i;n++)r.push(c.buildHint(e[n],this.styles)),r[r.length-1]||r.pop();if(0<r.length){var o=document.createDocumentFragment();for(n=0,t=r.length;n<t;n++)o.appendChild(r[n]);this.clearHints(),this.genList(),this.uiElem.querySelector("ul").appendChild(o)}}return t},f.prototype.clearHints=function(){this.uiElem&&(this.uiElem.querySelector("ul").innerHTML="")},f.prototype.isOpen=function(){return!!this.uiElem&&this.uiElem.getAttribute(o.attr)==o.open},f.prototype.open=function(){var e;if(this.uiElem&&(e=this.uiElem.querySelectorAll("."+i))&&e.length){var t,n;for(n=this.assocInput.getBoundingClientRect(),this.uiElem.style.top=(document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop)+n.bottom+"px",this.uiElem.style.left=n.left+"px",n=n.right-n.left-parseFloat(l(this.uiElem,"borderLeftWidth"))-parseFloat(l(this.uiElem,"borderRightWidth")),this.uiElem.style.width=n+"px",n=t=0;t<e.length;t++)n+=parseFloat(l(e[t],"height"))+parseFloat(l(e[t],"paddingTop"))+parseFloat(l(e[t],"paddingBottom")),e[t+1]&&(n+=Math.max(parseFloat(l(e[t],"marginBottom")),parseFloat(l(e[t+1],"marginTop"))));n+=parseFloat(l(e[0],"marginTop"))+parseFloat(l(e[e.length-1],"marginBottom")),this.uiElem.style.height=n+1+"px",this.uiElem.setAttribute(o.attr,o.open),this.uiElem.style.display="block"}},f.prototype.close=function(){this.uiElem&&(this.mouseOnList=!1,this.uiElem.parentNode.removeChild(this.uiElem),this.uiElem=null,v(this.assocInput).trigger("change"))},f.prototype.autoScroll=function(){var e=this.getSelected();if(e){var t,n,i=0,r=e.clientHeight,o=parseFloat(l(e,"marginTop")),a=parseFloat(l(e,"marginBottom"));for(n=r+((t=e.previousSibling)?Math.max(o,a):o);t;)i+=r,i+=(t=t.previousSibling)?Math.max(o,a):o;(this.uiElem.clientHeight+this.uiElem.scrollTop-i<n||i-this.uiElem.scrollTop<n)&&(this.uiElem.scrollTop=i)}},f.prototype.select=function(e){if(this.uiElem){var t=null;if(this.isHint(e))t=e;else if("number"==typeof e&&(0<=e||-1===e)){var n=this.uiElem.querySelectorAll("."+i);0<n.length&&(t=n[t=-1===(t=+e)||t>n.length-1?n.length-1:t])}null!==t&&(this.deselect(),t.className+=" "+r)}},f.prototype.deselect=function(){if(this.uiElem){var e=this.getSelected();e&&(e.className=i)}},f.prototype.getSelected=function(){return this.uiElem&&this.uiElem.querySelector("."+r)||null};var g=function(e){return"INPUT"==e.tagName?e.value:e.innerText},m=function(e,t){"INPUT"==e.tagName?e.value=t:e.innerText=t};return{enable:function(i,e){if(i&&1===i.nodeType&&!i.autoComplt){i.autoComplt={};var r=d,o=!0,a="",s=null,l=new f(i),c=function(){if(o){var e=l.getSelected();m(this,e?e.innerHTML:a)}},t=function(e){l.mouseOnList&&"INPUT"==i.tagName&&(i.focus(),l.mouseOnList=!1),i.autoComplt.close()},n=function(e){if(o)if("keydown"==e.type){if(e.keyCode===u.enter)return e.preventDefault();if(l.isOpen()&&(e.keyCode===u.up||e.keyCode===u.down)){var t=l.getSelected();e.keyCode===u.up?(e.preventDefault(),t?t.previousSibling?l.select(t.previousSibling):l.deselect():l.select(-1)):e.keyCode===u.down&&(e.preventDefault(),t?t.nextSibling?l.select(t.nextSibling):l.deselect():l.select(0)),l.autoScroll(),c.call(i)}}else if("keyup"==e.type){var n=!1;switch(e.keyCode){case u.up:case u.down:e.preventDefault();break;case u.left:case u.right:break;case u.esc:l.isOpen()&&(i.value=a,i.autoComplt.close());break;case u.enter:l.isOpen()&&(c.call(i),i.autoComplt.close(),v(i).trigger("change"));break;default:n=!0}n&&function(){if(0<g(this).length&&o&&"function"==typeof s&&a!==g(this)){var n={call:function(){s.call(n.that,n.compltTarget,n.openHint)}};n.that=i,n.compltTarget=a=g(this),n.openHint=function(e){if(n.compltTarget===a)if(l.putHints(e)){var t=v(i).offset();t.top+=i.offsetHeight+5,l.open(),v(l.uiElem).css("min-width",100),v(l.uiElem).offset(t)}else n.that.autoComplt.close()},setTimeout(n.call,r)}}.call(i)}};return i.autoComplt.setHintsFetcher=function(e){return"function"==typeof e&&(s=e,!0)},i.autoComplt.config=function(e){if(e instanceof Object){var t,n={};return 0<(t=Math.floor(e.delay))&&(r=n.delay=t),0<(t=Math.floor(e.maxHintNum))&&(l.maxHintNum=n.maxHintNum=t),n}return!1},i.autoComplt.close=function(){a="",l.close()},i.autoComplt.enable=function(){o=!0},i.autoComplt.disable=function(){this.close(),o=!1},i.autoComplt.destroy=function(){h(i,"blur",t),h(i,"keyup",n),h(i,"keydown",n),this.close(),delete i.autoComplt},p(i,"blur",t),p(i,"keyup",n),p(i,"keydown",n),e instanceof Object&&(i.autoComplt.config(e),i.autoComplt.setHintsFetcher(e.hintsFetcher)),i}return null}}}();n.exports=i}),define("codemirror/addon/selection/mark-selection.js",[],function(e,t,n){"use strict";!function(r){function o(e){e.state.markedSelection&&e.operation(function(){!function(e){if(!e.somethingSelected())return l(e);if(1<e.listSelections().length)return c(e);var t=e.getCursor("start"),n=e.getCursor("end"),i=e.state.markedSelection;if(!i.length)return s(e,t,n);var r=i[0].find(),o=i[i.length-1].find();if(!r||!o||n.line-t.line<p||0<=f(t,o.to)||f(n,r.from)<=0)return c(e);for(;0<f(t,r.from);)i.shift().clear(),r=i[0].find();f(t,r.from)<0&&(r.to.line-t.line<p?(i.shift().clear(),s(e,t,r.to,0)):s(e,t,r.from,0));for(;f(n,o.to)<0;)i.pop().clear(),o=i[i.length-1].find();0<f(n,o.to)&&(n.line-o.from.line<p?(i.pop().clear(),s(e,o.from,n)):s(e,o.to,n))}(e)})}function a(e){e.state.markedSelection&&e.state.markedSelection.length&&e.operation(function(){l(e)})}r.defineOption("styleSelectedText",!1,function(e,t,n){var i=n&&n!=r.Init;t&&!i?(e.state.markedSelection=[],e.state.markedSelectionStyle="string"==typeof t?t:"CodeMirror-selectedtext",c(e),e.on("cursorActivity",o),e.on("change",a)):!t&&i&&(e.off("cursorActivity",o),e.off("change",a),l(e),e.state.markedSelection=e.state.markedSelectionStyle=null)});var p=8,h=r.Pos,f=r.cmpPos;function s(e,t,n,i){if(0!=f(t,n))for(var r=e.state.markedSelection,o=e.state.markedSelectionStyle,a=t.line;;){var s=a==t.line?t:h(a,0),l=a+p,c=l>=n.line,d=c?n:h(l,0),u=e.markText(s,d,{className:o});if(null==i?r.push(u):r.splice(i++,0,u),c)break;a=l}}function l(e){for(var t=e.state.markedSelection,n=0;n<t.length;++n)t[n].clear();t.length=0}function c(e){l(e);for(var t=e.listSelections(),n=0;n<t.length;n++)s(e,t[n].from(),t[n].to())}}(e("codemirror/lib/codemirror"))}),define("codemirror/addon/edit/closebrackets.js",[],function(e,t,n){!function(b){var n={pairs:"()[]{}''\"\"",triples:"",explode:"[]{}"},w=b.Pos;function x(e,t){return"pairs"==t&&"string"==typeof e?e:"object"==typeof e&&null!=e[t]?e[t]:n[t]}b.defineOption("autoCloseBrackets",!1,function(e,t,n){n&&n!=b.Init&&(e.removeKeyMap(i),e.state.closeBrackets=null),t&&(e.state.closeBrackets=t,e.addKeyMap(i))});for(var e=n.pairs+"`",i={Backspace:function(e){var t=C(e);if(!t||e.getOption("disableInput"))return b.Pass;for(var n=x(t,"pairs"),i=e.listSelections(),r=0;r<i.length;r++){if(!i[r].empty())return b.Pass;var o=s(e,i[r].head);if(!o||n.indexOf(o)%2!=0)return b.Pass}for(var r=i.length-1;0<=r;r--){var a=i[r].head;e.replaceRange("",w(a.line,a.ch-1),w(a.line,a.ch+1),"+delete")}},Enter:function(n){var e=C(n),t=e&&x(e,"explode");if(!t||n.getOption("disableInput"))return b.Pass;for(var i=n.listSelections(),r=0;r<i.length;r++){if(!i[r].empty())return b.Pass;var o=s(n,i[r].head);if(!o||t.indexOf(o)%2!=0)return b.Pass}if(n.getModeAt(n.getCursor()).indent||n.getMode().indent)return n.operation(function(){n.replaceSelection("\n",null),n.execCommand("goCharLeft");for(var e=0;e<i.length;e++){var t=i[e].head.line;n.indentLine(t,null,!0),n.indentLine(t+1,null,!0)}}),b.Pass;n.operation(function(){n.replaceSelection("\n\n",null),n.execCommand("goCharLeft"),i=n.listSelections();for(var e=0;e<i.length;e++){var t=i[e].head.line;n.indentLine(t,null,!0),n.indentLine(t+1,null,!0),n.indentLine(t,"add",!0)}})}},t=0;t<e.length;t++)i["'"+e.charAt(t)+"'"]=r(e.charAt(t));function r(t){return function(e){return function(r,e){var t=C(r);if(!t||r.getOption("disableInput"))return b.Pass;var n=x(t,"pairs"),i=n.indexOf(e);if(-1==i)return b.Pass;for(var o,a=x(t,"triples"),s=n.charAt(i+1)==e,l=r.listSelections(),c=i%2==0,d=0;d<l.length;d++){var u,p=l[d],h=p.head,f=r.getRange(h,w(h.line,h.ch+1));if(c&&!p.empty())u="surround";else if(!s&&c||f!=e)if(s&&1<h.ch&&0<=a.indexOf(e)&&r.getRange(w(h.line,h.ch-2),h)==e+e&&(h.ch<=2||r.getRange(w(h.line,h.ch-3),w(h.line,h.ch-2))!=e))u="addFour";else if(s){if(b.isWordChar(f)||!k(r,h,e))return b.Pass;u="both"}else{if(!c||!(r.getLine(h.line).length==h.ch||(g=f,void 0,-1<(m=n.lastIndexOf(g))&&m%2==1)||/\s/.test(f)))return b.Pass;u="both"}else u=s&&S(r,h)?"both":0<=a.indexOf(e)&&r.getRange(h,w(h.line,h.ch+3))==e+e+e?"skipThree":"skip";if(o){if(o!=u)return b.Pass}else o=u}var g,m;var v=i%2?n.charAt(i-1):e,y=i%2?e:n.charAt(i+1);r.operation(function(){if("skip"==o)r.execCommand("goCharRight");else if("skipThree"==o)for(var e=0;e<3;e++)r.execCommand("goCharRight");else if("surround"==o){for(var t=r.getSelections(),e=0;e<t.length;e++)t[e]=v+t[e]+y;r.replaceSelections(t,"around"),t=r.listSelections().slice();for(var e=0;e<t.length;e++)t[e]=(n=t[e],void 0,i=0<b.cmpPos(n.anchor,n.head),{anchor:new w(n.anchor.line,n.anchor.ch+(i?-1:1)),head:new w(n.head.line,n.head.ch+(i?1:-1))});r.setSelections(t)}else"both"==o?(r.replaceSelection(v+y,null),r.triggerElectric(v+y),r.execCommand("goCharLeft")):"addFour"==o&&(r.replaceSelection(v+v+v+v,"before"),r.execCommand("goCharRight"));var n,i})}(e,t)}}function C(e){var t=e.state.closeBrackets;return!t||t.override?t:e.getModeAt(e.getCursor()).closeBrackets||t}function s(e,t){var n=e.getRange(w(t.line,t.ch-1),w(t.line,t.ch+1));return 2==n.length?n:null}function k(e,t,n){var i=e.getLine(t.line),r=e.getTokenAt(t);if(/\bstring2?\b/.test(r.type)||S(e,t))return!1;var o=new b.StringStream(i.slice(0,t.ch)+n+i.slice(t.ch),4);for(o.pos=o.start=r.start;;){var a=e.getMode().token(o,r.state);if(o.pos>=t.ch+1)return/\bstring2?\b/.test(a);o.start=o.pos}}function S(e,t){var n=e.getTokenAt(w(t.line,t.ch+1));return/\bstring/.test(n.type)&&n.start==t.ch}}(e("codemirror/lib/codemirror"))}),define("codemirror/addon/edit/closetag",["codemirror/lib/codemirror"],function(e,t,n){var x=e("codemirror/lib/codemirror");!function(){x.defineOption("autoCloseTags",!1,function(e,t,n){if(n!=x.Init&&n&&e.removeKeyMap("autoCloseTags"),t){var i={name:"autoCloseTags"};("object"!=typeof t||t.whenClosing)&&(i["'/'"]=function(e){return(t=e).getOption("disableInput")?x.Pass:r(t,!0);var t}),("object"!=typeof t||t.whenOpening)&&(i["'>'"]=function(e){return function(e){if(e.getOption("disableInput"))return x.Pass;for(var t=e.listSelections(),n=[],i=0;i<t.length;i++){if(!t[i].empty())return x.Pass;var r=t[i].head,o=e.getTokenAt(r),a=x.innerMode(e.getMode(),o.state),s=a.state;if("xml"!=a.mode.name||!s.tagName)return x.Pass;var l=e.getOption("autoCloseTags"),c="html"==a.mode.configuration,d="object"==typeof l&&l.dontCloseTags||c&&v,u="object"==typeof l&&l.indentTags||c&&y,p=s.tagName;o.end>r.ch&&(p=p.slice(0,p.length-o.end+r.ch));var h=p.toLowerCase();if(!p||"string"==o.type&&(o.end!=r.ch||!/[\"\']/.test(o.string.charAt(o.string.length-1))||1==o.string.length)||"tag"==o.type&&"closeTag"==s.type||o.string.indexOf("/")==o.string.length-1||d&&-1<b(d,h)||w(e,p,r,s,!0))return x.Pass;var f=u&&-1<b(u,h);n[i]={indent:f,text:">"+(f?"\n\n":"")+"</"+p+">",newPos:f?x.Pos(r.line+1,0):x.Pos(r.line,r.ch+1)}}for(var i=t.length-1;0<=i;i--){var g=n[i];e.replaceRange(g.text,t[i].head,t[i].anchor,"+insert");var m=e.listSelections().slice(0);m[i]={head:g.newPos,anchor:g.newPos},e.setSelections(m),g.indent&&(e.indentLine(g.newPos.line,null,!0),e.indentLine(g.newPos.line+1,null,!0))}}(e)}),e.addKeyMap(i)}});var v=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],y=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];function r(e,t){for(var n=e.listSelections(),i=[],r=t?"/":"</",o=0;o<n.length;o++){if(!n[o].empty())return x.Pass;var a,s=n[o].head,l=e.getTokenAt(s),c=x.innerMode(e.getMode(),l.state),d=c.state;if(t&&("string"==l.type||"<"!=l.string.charAt(0)||l.start!=s.ch-1))return x.Pass;if("xml"!=c.mode.name)if("htmlmixed"==e.getMode().name&&"javascript"==c.mode.name)a=r+"script";else{if("htmlmixed"!=e.getMode().name||"css"!=c.mode.name)return x.Pass;a=r+"style"}else{if(!d.context||!d.context.tagName||w(e,d.context.tagName,s,d))return x.Pass;a=r+d.context.tagName}">"!=e.getLine(s.line).charAt(l.end)&&(a+=">"),i[o]=a}e.replaceSelections(i),n=e.listSelections();for(o=0;o<n.length;o++)(o==n.length-1||n[o].head.line<n[o+1].head.line)&&e.indentLine(n[o].head.line)}function b(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,i=e.length;n<i;++n)if(e[n]==t)return n;return-1}function w(e,t,n,i,r){if(!x.scanForClosingTag)return!1;var o=Math.min(e.lastLine()+1,n.line+500),a=x.scanForClosingTag(e,n,null,o);if(!a||a.tag!=t)return!1;for(var s=i.context,l=r?1:0;s&&s.tagName==t;s=s.prev)++l;n=a.to;for(var c=1;c<l;c++){var d=x.scanForClosingTag(e,n,null,o);if(!d||d.tag!=t)return!1;n=d.to}return!0}x.commands.closeTag=function(e){return r(e)}}()}),define("codemirror/addon/mode/overlay",[],function(e,t,n){"use strict";var a=e("codemirror/lib/codemirror");a.overlayMode=function(i,r,o){return{startState:function(){return{base:a.startState(i),overlay:a.startState(r),basePos:0,baseCur:null,overlayPos:0,overlayCur:null,streamSeen:null}},copyState:function(e){return{base:a.copyState(i,e.base),overlay:a.copyState(r,e.overlay),basePos:e.basePos,baseCur:null,overlayPos:e.overlayPos,overlayCur:null}},token:function(e,t){return(e!=t.streamSeen||Math.min(t.basePos,t.overlayPos)<e.start)&&(t.streamSeen=e,t.basePos=t.overlayPos=e.start),e.start==t.basePos&&(t.base.lineBefore=t.lineBefore,t.base.lineAfter=t.lineAfter,t.baseCur=i.token(e,t.base),t.basePos=e.pos),e.start==t.overlayPos&&(e.pos=e.start,t.overlayCur=r.token(e,t.overlay),t.overlayPos=e.pos),e.pos=Math.min(t.basePos,t.overlayPos),null==t.overlayCur?t.baseCur:null!=t.baseCur&&t.overlay.combineTokens||o&&null==t.overlay.combineTokens?t.baseCur+" "+t.overlayCur:t.overlayCur},indent:i.indent&&function(e,t){return i.indent(e.base,t)},electricChars:i.electricChars,innerMode:function(e){return{state:e.base,mode:i}},blankLine:function(e){var t,n;return i.blankLine&&(t=i.blankLine(e.base)),r.blankLine&&(n=r.blankLine(e.overlay)),null==n?t:o&&null!=t?t+" "+n:n}}}}),define("codemirror/addon/lint/lint",[],function(e,t,n){var l=e("codemirror/lib/codemirror"),f="CodeMirror-lint-markers";function a(e){e.parentNode&&e.parentNode.removeChild(e)}function d(e,t,n){var i=function(e,t){var n=document.createElement("div");function i(e){if(!n.parentNode)return l.off(document,"mousemove",i);n.style.top=Math.max(0,e.clientY-n.offsetHeight-5)+"px",n.style.left=e.clientX+5+"px"}return n.className="CodeMirror-lint-tooltip",n.appendChild(t.cloneNode(!0)),document.body.appendChild(n),l.on(document,"mousemove",i),i(e),null!=n.style.opacity&&(n.style.opacity=1),n}(e,t);function r(){var e;l.off(n,"mouseout",r),i&&((e=i).parentNode&&(null==e.style.opacity&&a(e),e.style.opacity=0,setTimeout(function(){a(e)},600)),i=null)}var o=setInterval(function(){if(i)for(var e=n;;e=e.parentNode){if(e&&11==e.nodeType&&(e=e.host),e==document.body)return;if(!e){r();break}}if(!i)return clearInterval(o)},400);l.on(n,"mouseout",r)}function c(t,e,n){this.marked=[],this.options=e,this.timeout=null,this.hasGutter=n,this.onMouseOver=function(e){!function(e,t){var n=t.target||t.srcElement;if(!/\bCodeMirror-lint-mark-/.test(n.className))return;for(var i=n.getBoundingClientRect(),r=(i.left+i.right)/2,o=(i.top+i.bottom)/2,a=e.findMarksAt(e.coordsChar({left:r,top:o},"client")),s=[],l=0;l<a.length;++l){var c=a[l].__annotation;c&&s.push(c)}s.length&&function(e,t){for(var n=t.target||t.srcElement,i=document.createDocumentFragment(),r=0;r<e.length;r++){var o=e[r];i.appendChild(v(o))}d(t,i,n)}(s,t)}(t,e)},this.waitingFor=0}function g(e){var t=e.state.lint;t.hasGutter&&e.clearGutter(f);for(var n=0;n<t.marked.length;++n)t.marked[n].clear();t.marked.length=0}function m(t,e,n,i){var r=document.createElement("div"),o=r;return r.className="CodeMirror-lint-marker-"+e,n&&((o=r.appendChild(document.createElement("div"))).className="CodeMirror-lint-marker-multiple"),0!=i&&l.on(o,"mouseover",function(e){d(e,t,o)}),r}function v(e){var t=e.severity;t||(t="error");var n=document.createElement("div");return n.className="CodeMirror-lint-message-"+t,n.appendChild(document.createTextNode(e.message)),n}function u(t){var e=t.state.lint.options,n=e.options||e,i=e.getAnnotations||t.getHelper(l.Pos(0,0),"lint");if(i)if(e.async||i.async)!function(n,e,t){var i=n.state.lint,r=++i.waitingFor;function o(){r=-1,n.off("change",o)}n.on("change",o),e(n.getValue(),function(e,t){n.off("change",o),i.waitingFor==r&&(t&&e instanceof l&&(e=t),s(n,e))},t,n)}(t,i,n);else{var r=i(t.getValue(),n,t);if(!r)return;r.then?r.then(function(e){s(t,e)}):s(t,r)}}function s(e,t){g(e);for(var n,i,r=e.state.lint,o=r.options,a=function(e){for(var t=[],n=0;n<e.length;++n){var i=e[n],r=i.from.line;(t[r]||(t[r]=[])).push(i)}return t}(t),s=0;s<a.length;++s){var l=a[s];if(l){for(var c=null,d=r.hasGutter&&document.createDocumentFragment(),u=0;u<l.length;++u){var p=l[u],h=p.severity;h||(h="error"),i=h,c="error"==(n=c)?n:i,o.formatAnnotation&&(p=o.formatAnnotation(p)),r.hasGutter&&d.appendChild(v(p)),p.to&&r.marked.push(e.markText(p.from,p.to,{className:"CodeMirror-lint-mark-"+h,__annotation:p}))}r.hasGutter&&e.setGutterMarker(s,f,m(d,c,1<l.length,r.options.tooltips))}}o.onUpdateLinting&&o.onUpdateLinting(t,a,e)}function p(e){var t=e.state.lint;t&&(clearTimeout(t.timeout),t.timeout=setTimeout(function(){u(e)},t.options.delay||500))}l.defineOption("lint",!1,function(e,t,n){if(n&&n!=l.Init&&(g(e),!1!==e.state.lint.options.lintOnChange&&e.off("change",p),l.off(e.getWrapperElement(),"mouseover",e.state.lint.onMouseOver),clearTimeout(e.state.lint.timeout),delete e.state.lint),t){for(var i=e.getOption("gutters"),r=!1,o=0;o<i.length;++o)i[o]==f&&(r=!0);var a=e.state.lint=new c(e,(s=t)instanceof Function?{getAnnotations:s}:(s&&!0!==s||(s={}),s),r);!1!==a.options.lintOnChange&&e.on("change",p),0!=a.options.tooltips&&"gutter"!=a.options.tooltips&&l.on(e.getWrapperElement(),"mouseover",a.onMouseOver),u(e)}var s}),l.defineExtension("performLint",function(){this.state.lint&&u(this)}),l.clearMarks=g,l.updateLinting=s}),define("app/editor/MathBlock",["codemirror/lib/codemirror","jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","codemirror/addon/display/placeholder","codemirror/mode/stex/stex","app/editor/UndoManager","app/editor/KeyMaster"],function(e,t,n){"use strict";var y=e("codemirror/lib/codemirror"),b=e("jquery/jquery"),i=e("exoskeleton-master/exoskeleton"),r=e("app/document/Node"),c=r.Node,o=(e("codemirror/addon/display/placeholder"),e("codemirror/mode/stex/stex"),e("app/editor/UndoManager"),e("app/document/StringUtils")),a=e("app/editor/KeyMaster"),w=r.TYPE,s=a.map;var d=!1;function l(){if(d)return!0;var l,c;File.option.autoNumberingForMath&&(MathJax.Hub.config.TeX.equationNumbers?MathJax.Hub.config.TeX.equationNumbers.autoNumber="all":MathJax.Hub.config.TeX.equationNumbers={autoNumber:"all",useLabelIds:!0}),l=[],c=[],MathJax.Hub.Register.MessageHook("Begin Attach MathJax",function(e){x()&&(l=Object.keys(u.labels).clone(),c=Object.keys(u.eqlabels).clone())}),MathJax.Hub.Register.MessageHook("End Attach MathJax",function(e){var t=[],n=[],i=b(e[1]),r=(i.closest(".md-inline-math"),i.closest("[mdtype='math_block']"));if(x()&&r.length){var o=File.editor.findNodeByElem(r);for(var a in u.labels)-1==l.indexOf(a)&&t.push(a);for(var s in u.eqlabels)-1==c.indexOf(s)&&n.push(s);o.set("mathLabel",t),o.set("mathEqLabel",n)}}),d=!0}var u,p=i.Model.extend({initialize:function(e){this.editor=e,this.queue={},this.preview,this.bindEvent()},bindEvent:function(){var n=this,t=this.editor;b(this.editor.sessionStr).on("click","[cid].mathjax-block",function(e){if(1==e.which)return n.startEditing(b(this)),!1}).on("click mousedown",".jax-trigger-delete-button",function(e){n.remove(b(this).closest("[cid]"))}).on("click",".jax-trigger-finish-button",function(e){n.stopEditing(n.currentCm.cid,!0),t.refocus(null)}).on("losefocus",".md-mathjax-panel",function(e){n.stopEditing(this.getAttribute("cid"))}).on("keydown",".mathjax-block",function(e){var t=event.keyCode||event.which;if("Enter"===s[t])return n.startEditing(b(this)),e.stopPropagation(),e.preventDefault()})},renderAll:function(e){var t=(e&&e.jquery?e[0]:document).querySelectorAll(".mathjax-block");e||(l(),C.Init());for(var n=0;n<t.length;n++){var i=t[n],r=i.querySelector("script");if(!r||!r.MathJax){if(File.option.autoNumberingForMath)return void this.forceRefresh();var o=this.editor.getNode(i.getAttribute("cid"));MathJax.Hub.Queue(["BeforeRender",C,o],["Typeset",MathJax.Hub,i.getAttribute("id")],["AfterRender",C,o])}}},getTex:function(e){return this.editor.findElemById(e).find("script").text()},getCidAndElem:function(e){var t=e,n=e;return"string"==typeof e?n=this.editor.findElemById(t):t=n.attr("cid"),[t,n]},syncToNode:function(e){var t="string"==typeof e?this.editor.getNode(e):e;return(this.currentCm||{}).cid===t.cid&&(t.set("history",this.currentCm.doc.getHistory()),t.set("text",this.currentCm.getValue())),t},remove:function(e){var t,n=this.getCidAndElem(e),i=n[0],r=n[1],o=editor.getNode(i),a=editor.undo.UndoManager,s=a.makeEmptyCommand(),l=(o.get("before"),this.currentCm);this.editor.undo.completeSnap(!0),this.beforeDeleteFences(o),l&&l.cid===o.cid?s.undo.push({type:"fences-pos",pos:l.getCursor(),id:l.cid}):s.undo.push(this.editor.selection.buildUndo()),s.undo.push(a.buildReplaceUndo(o)),o.set("type",o.TYPE.paragraph),o.set("text",""),c.normalizeNode(o),s.redo.push(a.buildReplaceUndo(o)),t=b(b.parseHTML(o.toHTML())[0]),r.replaceWith(t),editor.selection.jumpIntoElemEnd(t),s.redo.push(editor.selection.buildUndo()),editor.undo.register(s),this.currentCm=void 0,this.renderAll()},deletionMonitor:function(e){var t=this;e.find(".md-mathjax-panel[cid]").toArray().map(function(e){t.currentCm.cid===e.getAttribute("cid")&&this.beforeDeleteFences(e.getAttribute("cid"))})},beforeDeleteFences:function(e,t){var n=this.syncToNode(e);this.currentCm=void 0;var i=this.editor.findElemById(e);(i=i&&i.find("script")[0])&&i.MathJax&&File.option.autoNumberingForMath?h.call(this):x()&&g(n),t&&t.map(function(e){e&&(e.id==n.id&&e.json&&e.json.content&&e.json.content.type==n.TYPE.math_block?(e.json.content.text=n.get("text"),e.json.content.history=n.get("history")):Array.isArray(e.json)&&e.json.map(function(e){e.id==n.id&&e.content.type==n.TYPE.math_block&&(e.content.text=n.get("text"),e.content.history=n.get("history"))}))})},stopEditing:function(e,t){if(e=e||(this.currentCm||{}).cid){var n=this.getCidAndElem(e),i=n[0],r=n[1],o=r[0].querySelectorAll(".mathjax-candidate"),a="hidden"===o[0].style.visibility?o[1]:o[0],s=this.syncToNode(i),l=this;if(a.className="mathjax-block",a.setAttribute("cid",i),a.setAttribute("mdtype","math_block"),a.setAttribute("id","math-jax"+i),r.replaceWith(b(a)),t){var c=s.getVeryFirstBrotherIncludeTopBlock(!1);c?(this.editor.selection.jumpIntoElemBegin(this.editor.findElemById(c.id)),this.editor.refocus()):window.getSelection().removeAllRanges()}this.currentCm=void 0,File.option.autoNumberingForMath&&C.isDirty?(C.Init(),this.forceRefresh()):(a.querySelector("script").MathJax=void 0,MathJax.Hub.Queue(["BeforeRender",C,s],["Typeset",MathJax.Hub,a.getAttribute("id")],["AfterRender",C,s]),MathJax.Hub.Queue(function(){void 0!==l.startNumber&&(u.startNumber=Math.max(l.startNumber,u.startNumber),u.number=u.startNumber,l.startNumber=void 0,C.Init())}))}},startEditing:function(e,t,n){if(n){var i=this;return this.forceRefresh(),void MathJax.Hub.Queue(function(){i.startEditing(e,t)})}var r,o,a,s,l,c,d,u,p,h=this.getCidAndElem(e),f=h[0],g=h[1],m=(this.editor,this.editor.getNode(f));if(f)if(this.currentCm&&this.currentCm.cid===f)this.currentCm.focus();else{this.currentCm&&(this.stopEditing(this.currentCm.cid),window.getSelection().removeAllRanges(),this.editor.refocus(null)),function(){if(File.option.autoNumberingForMath){var e=this.editor.findElemById(m.id).find("script")[0];C.startNumber=this.startNumber=void 0,e&&e.MathJax&&void 0!==e.MathJax.startNumber&&(this.startNumber=x().startNumber,C.startNumber=e.MathJax.startNumber,e.MathJax=void 0),null==C.startNumber&&File.option.autoNumberingForMath&&(C.startNumber=(x()||{}).startNumber||0)}}.call(this);var v=b(document.querySelector("#md-mathjax-panel-templ").textContent).attr("cid",f).attr("mdtype",w.math_block);v.children(".code-tooltip-p").removeClass("code-tooltip-p").addClass("code-tooltip"),g.replaceWith(v),this.currentCm=(u=this.editor,p=y(v[0].querySelector(".md-mathjax-input"),{styleSelectedText:!0,styleActiveLine:!0,lineWrapping:!0,mode:"stex",placeholder:b.localize.getString("Input Math TeX here"),theme:" inner",autoCloseBrackets:!File.option.noPairingMatch,autoCloseTags:!File.option.noPairingMatch,value:m.get("text").trim(),lineNumbers:File.option.showLineNumbersForFence,resetSelectionOnContextMenu:!0,dragDrop:!1,indentUnit:File.option.codeIndentSize,tabSize:File.option.codeIndentSize},u,f),m.get("history")&&p.setHistory(m.get("history")),p.doc.on("change",function(e){C.getTextFunc&&C.Update(),u.syncChange([{type:"sync",id:m.id,tex:p.getValue()}])}),p.on("blur",function(e){try{m.set("history",e.doc.getHistory()),m.set("text",e.getValue())}catch(e){console.warn(e.stack)}}),p.on("focus",function(e){u.undo.completeSnap(!0),u.refocus(m.id)}),p.on("keydown",function(e,t){var n,i=t.which||t.keyCode,r=y.keyName(t);if(!t.metaKey&&!t.shiftKey&&t.ctrlKey,"Up"==y.keyNames[i])return u.selection.moveUpOrDown(!0,t),t.codemirrorIgnore;if("Down"==y.keyNames[i])return u.selection.moveUpOrDown(!1,t),t.codemirrorIgnore;if("Backspace"==y.keyNames[i]){if(!e.getValue().length)return u.mathBlock.remove(e.cid),t.preventDefault(),t.codemirrorIgnore}else{if("Enter"==y.keyNames[i]&&(t.ctrlKey||t.metaKey))return setTimeout(function(){u.UserOp.insertParagraph()},20),t.stopPropagation(),t.codemirrorIgnore;if("PageDown"==y.keyNames[i]){if(!(n=e.doc.getCursor(n))||e.doc.indexFromPos(n)>=e.doc.getValue().length)return e.execCommand("goDocEnd"),u.selection.moveUpOrDown(!1),void(t.codemirrorIgnore=!0)}else if("PageUp"==y.keyNames[i]&&(!(n=e.doc.getCursor())||0==n.line&&0==n.ch))return e.execCommand("goDocStart"),u.selection.moveUpOrDown(!0),void(t.codemirrorIgnore=!0)}(y.keyMap.macDefault[r]||y.keyMap.pcDefault[r])&&t.stopPropagation()}),u.refocus(m.id),p.focus(),p),o=v[0],a=this.currentCm,s=m,l=C.startNumber,c=o.querySelector(".CodeMirror").CodeMirror,(d=o.querySelector(".md-mathjax-preview")).textContent="$$\n"+c.getValue()+"\n$$",C.Init(d,o.querySelector(".md-mathjax-buffer"),function(){return"$$\n"+(a.doc.getValue().trim()||"<Empty \\space Math \\space Block>")+"\n$$"},s),C.startNumber=l,MathJax.Hub.Queue(["BeforeRender",C,s,!1],["Typeset",MathJax.Hub,d]),C.Update(),(r=this.currentCm).focus(),"<Empty \\space Math \\space Block>"==r.getValue()?r.execCommand("selectAll"):r.execCommand("goDocEnd")}return this.currentCm},copyAsTex:function(e){var t=b(e||document.activeElement).closest("[cid]").find("script")[0].textContent.trim();this.editor.UserOp.setClipboard(null,null,t,!0)},copyAsMathML:function(e){var t=MathJax.Hub.getAllJax(b(e||document.activeElement).closest("[cid]")[0])[0],n=this.editor;f(t,function(e){n.UserOp.setClipboard("<pre class='md-fences' lang='xml'>"+o.escape(e)+"</pre>",null,e,!0)})},copyAsImage:function(e){var t=(e&&e.querySelector||document.activeElement).querySelector("svg"),n=this.editor,i=n.EditHelper.SVG2HtmlImg(t);n.UserOp.setClipboard(i,null,i,!0)},forceRefresh:function(){File.editor.sourceView.inSourceMode||(this.currentCm&&(this.stopEditing(this.currentCm.cid),window.getSelection().removeAllRanges(),this.editor.refocus(null)),l(),window.svgCache={},this.editor.brush.clearAndPause(),h.call(this),File.option.enableInlineMath?MathJax.Hub.Queue(["Typeset",MathJax.Hub,document.querySelector("#write")]):b(".mathjax-block").each(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub,this])}),this.editor.mathInline.renderAll(!0),MathJax.Hub.Queue(function(){this.editor.brush.resume()}))}}),h=function(){this.currentCm&&(self.stopEditing(self.currentCm.cid),window.getSelection().removeAllRanges(),this.editor.refocus(null));for(var e=document.querySelectorAll("script"),t=0;t<e.length;t++)e[t].MathJax&&(e[t].MathJax=void 0);x()&&(u.labels=u.eqlabels=u.IDs=u.eqIDs={},u.refs=[],this.startNumber=u.number=u.startNumber=0,C.Init())},f=function(t,n){var e;try{e=t.root.toMathML("")}catch(e){if(!e.restart)throw e;return MathJax.Callback.After([f,t,n],e.restart)}MathJax.Callback(n)(e)},x=function(){return u=MathJax.Extension["TeX/AMSmath"]},C={delay:0,preview:null,buffer:null,timeout:null,mjRunning:!1,oldText:null,maxIgnored:3,curIgnored:0,startNumber:void 0,originalEnd:void 0,isDirty:!1,Init:function(e,t,n,i){this.preview=e,this.buffer=t,this.getTextFunc=n,this.node=i,this.originalEnd=void 0,this.isDirty=!1,this.startNumber=void 0},SwapBuffers:function(){var e=this.preview,t=this.buffer;this.buffer=e,this.preview=t,e.style.visibility="hidden",e.style.position="absolute",t.style.position="",t.style.visibility=""},Update:function(){this.callback()},CreatePreview:function(){if(this.curIgnored=0,C.timeout=null,!this.mjRunning){var e=this.getTextFunc();e!==this.oldtext&&(this.buffer.textContent=this.oldtext=e,this.mjRunning=!0,MathJax.Hub.Queue(["BeforeRender",this,this.node,!1],["Typeset",MathJax.Hub,this.buffer],["AfterRender",this,this.node],["PreviewDone",this,this.node]))}},PreviewDone:function(){this.mjRunning=!1,this.SwapBuffers()},BeforeRender:function(e,t){x()&&(t?(e.unset("mathLabel"),e.unset("mathEqLabel")):g(e),void 0!==this.startNumber&&(u.startNumber=u.number=this.startNumber))},AfterRender:function(e){File.option.autoNumberingForMath&&x()&&(this.isDirty||(void 0===this.originalEnd?this.originalEnd=u.startNumber:this.isDirty=this.originalEnd!==u.startNumber))}};function g(e){(e.get("mathLabel")||[]).map(function(e){delete u.labels[e]}),(e.get("mathEqLabel")||[]).map(function(e){delete u.eqlabels[e]})}C.callback=MathJax.Callback(["CreatePreview",C]),C.callback.autoReset=!0,p.Preview=C,n.exports=p}),define("codemirror/addon/display/placeholder",[],function(e,t,n){var o=e("codemirror/lib/codemirror");function a(e){e.state.placeholder&&(e.state.placeholder.parentNode.removeChild(e.state.placeholder),e.state.placeholder=null)}function i(e){a(e);var t=e.state.placeholder=document.createElement("pre");t.style.cssText="height: 0; overflow: visible",t.className="CodeMirror-placeholder";var n=e.getOption("placeholder");"string"==typeof n&&(n=document.createTextNode(n)),t.appendChild(n),e.display.lineSpace.insertBefore(t,e.display.lineSpace.firstChild)}function s(e){r(e)&&i(e)}function l(e){var t=e.getWrapperElement(),n=r(e);t.className=t.className.replace(" CodeMirror-empty","")+(n?" CodeMirror-empty":""),n?i(e):a(e)}function r(e){return 1===e.lineCount()&&""===e.getLine(0)}o.defineOption("placeholder","",function(e,t,n){var i=n&&n!=o.Init;if(t&&!i)e.on("blur",s),e.on("change",l),e.on("swapDoc",l),l(e);else if(!t&&i){e.off("blur",s),e.off("change",l),e.off("swapDoc",l),a(e);var r=e.getWrapperElement();r.className=r.className.replace(" CodeMirror-empty","")}t&&!e.hasFocus()&&s(e)})}),define("codemirror/mode/stex/stex",[],function(e,t,n){var i=e("codemirror/lib/codemirror");i.defineMode("stex",function(){"use strict";function o(e,t){e.cmdState.push(t)}function a(e){return 0<e.cmdState.length?e.cmdState[e.cmdState.length-1]:null}function e(e,t,n){return function(){this.name=e,this.bracketNo=0,this.style=t,this.styles=n,this.argument=null,this.styleIdentifier=function(){return this.styles[this.bracketNo-1]||null},this.openBracket=function(){return this.bracketNo++,"bracket"},this.closeBracket=function(){}}}var s={};function l(e,t){e.f=t}function r(e,t){var n;if(e.match(/^\\[a-zA-Z@]+/)){var i=e.current().slice(1);return o(t,n=new(n=s[i]||s.DEFAULT)),l(t,d),n.style}if(e.match(/^\\[$&%#{}_]/))return"tag";if(e.match(/^\\[,;!\/\\]/))return"tag";if(e.match("\\["))return l(t,function(e,t){return c(e,t,"\\]")}),"keyword";if(e.match("$$"))return l(t,function(e,t){return c(e,t,"$$")}),"keyword";if(e.match("$"))return l(t,function(e,t){return c(e,t,"$")}),"keyword";var r=e.next();return"%"==r?(e.skipToEnd(),"comment"):"}"==r||"]"==r?(n=a(t))?(n.closeBracket(r),l(t,d),"bracket"):"error":"{"==r||"["==r?(o(t,n=new(n=s.DEFAULT)),"bracket"):/\d/.test(r)?(e.eatWhile(/[\w.%]/),"atom"):(e.eatWhile(/[\w\-_]/),"begin"==(n=function(e){for(var t=e.cmdState,n=t.length-1;0<=n;n--){var i=t[n];if("DEFAULT"!=i.name)return i}return{styleIdentifier:function(){return null}}}(t)).name&&(n.argument=e.current()),n.styleIdentifier())}function c(e,t,n){if(e.eatSpace())return null;if(e.match(n))return l(t,r),"keyword";if(e.match(/^\\[a-zA-Z@]+/))return"tag";if(e.match(/^[a-zA-Z]+/))return"variable-2";if(e.match(/^\\[$&%#{}_]/))return"tag";if(e.match(/^\\[,;!\/]/))return"tag";if(e.match(/^[\^_&]/))return"tag";if(e.match(/^[+\-<>|=,\/@!*:;'"`~#?]/))return null;if(e.match(/^(\d+\.\d*|\d*\.\d+|\d+)/))return"number";var i=e.next();return"{"==i||"}"==i||"["==i||"]"==i||"("==i||")"==i?"bracket":"%"==i?(e.skipToEnd(),"comment"):"error"}function d(e,t){var n,i=e.peek();return"{"==i||"["==i?(a(t).openBracket(i),e.eat(i),l(t,r),"bracket"):/[ \t\r]/.test(i)?(e.eat(i),null):(l(t,r),(n=t.cmdState.pop())&&n.closeBracket(),r(e,t))}return s.importmodule=e("importmodule","tag",["string","builtin"]),s.documentclass=e("documentclass","tag",["","atom"]),s.usepackage=e("usepackage","tag",["atom"]),s.begin=e("begin","tag",["atom"]),s.end=e("end","tag",["atom"]),s.DEFAULT=function(){this.name="DEFAULT",this.style="tag",this.styleIdentifier=this.openBracket=this.closeBracket=function(){}},{startState:function(){return{cmdState:[],f:r}},copyState:function(e){return{cmdState:e.cmdState.slice(),f:e.f}},token:function(e,t){return t.f(e,t)},blankLine:function(e){e.f=r,e.cmdState.length=0},lineComment:"%"}}),i.defineMIME("text/x-stex","stex"),i.defineMIME("text/x-latex","stex")}),define("app/editor/MathInline",["jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","app/editor/UndoManager","app/editor/KeyMaster","app/editor/EditHelper","app/editor/KeyMaster","rangy/rangy-core","rangy/rangy-classapplier"],function(e,t,n){"use strict";var c=e("jquery/jquery"),i=e("exoskeleton-master/exoskeleton"),r=(e("app/document/Node").Node,e("app/editor/UndoManager"),e("app/editor/KeyMaster")),d=e("app/editor/EditHelper"),o=(r.map,e("app/document/StringUtils")),a=e("rangy/rangy-core.js");e("rangy/rangy-classapplier"),/Apple Computer/.test(navigator.vendor);window.svgCache={};var s=function(n){var i=c(n),r=i.textExcludeSVG().replace(/\u200B*/g,"");if(!/^\$+$/.exec(r))return MathJax.Hub.Queue(["Typeset",MathJax.Hub,n],function(){if(n.querySelector(".noError")&&n.querySelector("script").classList.add("math-jax-error"),!n.classList.contains("math-jax-postprocess")){var e=i.parent().attr("pattern")||"$",t=i.removeClass("math-jax-preprocess").addClass("math-jax-postprocess").before("<span class='md-before md-meta'>"+e+"</span>").after("<span class='md-math-after-sym'></span><span class='md-after md-meta'>"+e+"</span>")[0].innerHTML;/^\$/.exec(r)||(r=e+r+e),svgCache[r]=d.processExportedSVG(t)}}),!0},l=function(e,t,n,i){if(t.length){!i&&MathJax.Hub.Queue(function(){e.brush.pause()}),MathJax.Hub.Queue(["setRenderer",MathJax.Hub,"SVG"]);for(var r=0;r<t.length;r++)s(t[r]);n&&MathJax.Hub.Queue(function(){e.undo.exeCommand(n)}),!i&&MathJax.Hub.Queue(function(){e.brush.resume()})}},u=null,p=function(a,e){var s=c("#math-inline-preview"),l=c("#math-inline-preview-content"),t=e.clone().find("svg").remove().end().text();u=function(){var e=MathJax.Hub.getAllJax(l[0])[0],t=c(".md-inline-math.md-expand"),n=t.attr("pattern"),i=t.find("script"),r=(i.text()||t.find(".math-jax-preprocess").text()).replace(/\u200B*/g,""),o=u;if(e)return i.height()?void(svgCache[r]||MathJax.Hub.Queue(["Text",e,r.replace("$$"==n?/(^\$\$)|(\$\$$)/g:/(^\$)|(\$$)/g,"")],function(){d.fixPopoverPosition(i,s)})):c(a.sessionStr).off("inline-math-changed",o)},(s.hasClass("md-math-inline-prep-preview")||"none"===s[0].style.display)&&/^\$/.exec(t)&&(s.removeClass("md-math-inline-prep-preview"),MathJax.Hub.Queue(["setRenderer",MathJax.Hub,"SVG"]),l.text(t),MathJax.Hub.Queue(["Typeset",MathJax.Hub,l[0]],function(){s.show(),d.fixPopoverPosition(e.find("script"),s),c(a.sessionStr).on("inline-math-changed",u)}))},h=function(e){var t=c("#math-inline-preview");"none"!==t[0].style.display&&t.hide(),u&&(c(e.sessionStr).off("inline-math-changed",u),u=null)},f=function(t,n){var e;try{e=t.root.toMathML("")}catch(e){if(!e.restart)throw e;return MathJax.Callback.After([f,t,n],e.restart)}MathJax.Callback(n)(e)},g=function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub,document.querySelector("#math-preheat")])},m=i.Model.extend({initialize:function(e){this.editor=e,this.queue={},function(){var i=this.editor;c(this.editor.sessionStr).on("cursorChange",function(e){var t,n=e.cursor||i.selection.getRangy();if(!n)return h(i);(t=c(n.commonAncestorContainer).closest(".md-inline-math.md-expand")).find("script").length?p(i,t):h(i)}).on("mousedown",".md-inline-math svg",function(e){h(i),c(".md-expand").removeClass("md-expand");var t=c(this).closest(".md-inline-math"),n=t.addClass("md-expand").find("script");i.selection.selectAllElem(n),p(i,t)})}.call(this),this.mathPrepApplier=a.createClassApplier("md-math-prep"),File.option.enableInlineMath&&setTimeout(g,1e3)},brushSpan:function(e){l.call(this,this.editor,[e],null,!0)},brush:function(e,t,n){var i=e.querySelectorAll(".math-jax-preprocess");return l.call(this,this.editor,i,t&&e.getAttribute("cid")===t.startId?t:null),i.length},showAutoSuggest:function(e){if(File.option.enableInlineMath){c(".md-math-prep").removeClass("md-math-prep"),this.mathPrepApplier.applyToRange(e);var t=c("#math-inline-preview").show().addClass("md-math-inline-prep-preview").css("width","auto");t.find("#math-inline-preview-content").text("<Empty Inline Math>"),d.fixPopoverPosition(c(".md-math-prep"),t)}},renderAll:function(e,t){e&&c(".math-jax-postprocess").parent().toArray().forEach(function(e){var t=e.getAttribute("pattern")||"$";e.innerHTML="<span class='inline-math-svg math-jax-preprocess'>"+t+o.escape(e.querySelector("script").textContent)+t+"</span></span>"});var n=(t&&t.jquery?t[0]:document).querySelectorAll(".math-jax-preprocess");l.call(this,this.editor,n),this.renderInToc()},renderInToc:function(){File.option.enableInlineMath&&l.call(this,this.editor,document.querySelectorAll(".math-in-toc"))},tryCloseInlinePreview:function(){h(this.editor)},copyAsTex:function(){var e=function(){var e=this.editor.selection.getRangy();return c(e.commonAncestorContainer).closest(".md-inline-math")}.call(this),t=e.attr("pattern"),n=e.text().replace("$$"==t?/(^\$\$)|(\$\$$)/g:/(^\$)|(\$$)/g,"");this.editor.UserOp.setClipboard(null,null,n,!0)},copyAsMathML:function(){var e=c("#math-inline-preview-content")[0],t=MathJax.Hub.getAllJax(e)[0],n=this.editor;f(t,function(e){n.UserOp.setClipboard("<pre class='md-fences' lang='xml'>"+o.escape(e)+"</pre>",null,e,!0)})},copyAsImage:function(){var e=document.querySelector("#math-inline-preview-content svg"),t=this.editor,n=t.EditHelper.SVG2HtmlImg(e);t.UserOp.setClipboard(n,null,n,!0)}});n.exports=m}),define("rangy/rangy-classapplier",[],function(e,t,n){"use strict";e("rangy/rangy-core").createModule("ClassApplier",["WrappedSelection"],function(i,h){var v=i.dom,r=v.DomPosition,o=v.arrayContains,a=v.isHtmlNamespace;function f(e,t){for(var n in e)if(e.hasOwnProperty(n)&&!1===t(n,e[n]))return!1;return!0}function n(e,t){return e.className&&new RegExp("(?:^|\\s)"+t+"(?:\\s|$)").test(e.className)}function u(e,t){e.className?n(e,t)||(e.className+=" "+t):e.className=t}var s=function(){function n(e,t,n){return t&&n?" ":""}return function(e,t){e.className&&(e.className=e.className.replace(new RegExp("(^|\\s)"+t+"(\\s|$)"),n))}}();function p(e){return e&&e.split(/\s+/).sort().join(" ")}function l(e){return p(e.className)}function c(e,t){return l(e)==l(t)}function g(e,t,n,i){-1==n&&(n=t.childNodes.length);for(var r,o,a,s,l,c,d,u,p,h,f=e.parentNode,g=v.getNodeIndex(e),m=0;r=i[m++];)a=f,s=g,l=t,c=n,h=p=void 0,d=(o=r).node,u=o.offset,h=u,(p=d)==l&&c<u&&++h,d!=a||u!=s&&u!=s+1||(p=l,h+=c-s),d==a&&s+1<u&&--h,o.node=p,o.offset=h;t.childNodes.length==n?t.appendChild(e):t.insertBefore(e,t.childNodes[n])}function d(e,t){for(var n,i,r,o,a=e.parentNode,s=v.getNodeIndex(e),l=0;n=t[l++];)r=a,o=s,(i=n).node==r&&i.offset>o&&--i.offset;e.parentNode.removeChild(e)}function m(e,t){return function(e,t,n,i,r){for(var o,a=[];o=e.firstChild;)g(o,t,n++,r),a.push(o);return i&&d(e,r),a}(e,e.parentNode,v.getNodeIndex(e),!0,t)}function y(e,t){var n=e.cloneRange();n.selectNodeContents(t);var i=n.intersection(e);return""!=(i?i.toString():"")}function b(e){for(var t,n=e.getNodes([3]),i=0;(t=n[i])&&!y(e,t);)++i;for(var r=n.length-1;(t=n[r])&&!y(e,t);)--r;return n.slice(i,r+1)}function w(e,t){if(e.attributes.length!=t.attributes.length)return!1;for(var n,i,r,o=0,a=e.attributes.length;o<a;++o)if("class"!=(r=(n=e.attributes[o]).name)){if(null===n!=(null===(i=t.attributes.getNamedItem(r))))return!1;if(n.specified!=i.specified)return!1;if(n.specified&&n.nodeValue!==i.nodeValue)return!1}return!0}function t(e,t){for(var n,i=0,r=e.attributes.length;i<r;++i)if(n=e.attributes[i].name,(!t||!o(t,n))&&e.attributes[i].specified&&"class"!=n)return!0;return!1}function x(n,e){return f(e,function(e,t){if("object"==typeof t){if(!x(n[e],t))return!1}else if(n[e]!==t)return!1})}var C=v.getComputedStyleProperty,k="boolean"==typeof document.createElement("div").isContentEditable?function(e){return e&&1==e.nodeType&&e.isContentEditable}:function(e){return!(!e||1!=e.nodeType||"false"==e.contentEditable)&&("true"==e.contentEditable||k(e.parentNode))};function S(e){var t;return e&&1==e.nodeType&&((t=e.parentNode)&&9==t.nodeType&&"on"==t.designMode||k(e)&&!k(e.parentNode))}function T(e){return(k(e)||1!=e.nodeType&&k(e.parentNode))&&!S(e)}var F=/^inline(-block|-table)?$/i;function E(e){return e&&1==e.nodeType&&!F.test(C(e,"display"))}var _=/[^\r\n\t\f \u200B]/;function M(e){var t,n,i=[];for(t=0;n=e[t++];)i.push(new r(n.startContainer,n.startOffset),new r(n.endContainer,n.endOffset));return i}function N(e,t){for(var n,i,r,o=0,a=e.length;o<a;++o)n=e[o],i=t[2*o],r=t[2*o+1],n.setStartAndEnd(i.node,i.offset,r.node,r.offset)}function A(e,t,n,i){var r,o,a,s,l=0==n;if(v.isAncestorOf(t,e))return e;if(v.isCharacterDataNode(t)){var c=v.getNodeIndex(t);if(0==n)n=c;else{if(n!=t.length)throw h.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+n+" in "+t.data);n=c+1}t=t.parentNode}if(a=t,s=n,v.isCharacterDataNode(a)?0==s?a.previousSibling:s!=a.length||a.nextSibling:0<s&&s<a.childNodes.length){r=t.cloneNode(!1),o=t.parentNode,r.id&&r.removeAttribute("id");for(var d,u=0;d=t.childNodes[n];)g(d,r,u++,i);return g(r,o,v.getNodeIndex(t)+1,i),t==e?r:A(e,o,v.getNodeIndex(r),i)}if(e!=t){r=t.parentNode;var p=v.getNodeIndex(t);return l||p++,A(e,r,p,i)}return e}function e(s){var l=s?"nextSibling":"previousSibling";return function(e,t){var n,i,r=e.parentNode,o=e[l];if(o){if(o&&3==o.nodeType)return o}else if(t&&(o=r[l])&&1==o.nodeType&&(i=o,(n=r).namespaceURI==i.namespaceURI&&n.tagName.toLowerCase()==i.tagName.toLowerCase()&&c(n,i)&&w(n,i)&&"inline"==C(n,"display")&&"inline"==C(i,"display"))){var a=o[s?"firstChild":"lastChild"];if(a&&3==a.nodeType)return a}return null}}var L=e(!1),I=e(!0);function R(e){this.isElementMerge=1==e.nodeType,this.textNodes=[];var t=this.isElementMerge?e.lastChild:e;t&&(this.textNodes[0]=t)}R.prototype={doMerge:function(e){var t=this.textNodes,n=t[0];if(1<t.length){for(var i,r,o,a,s=v.getNodeIndex(n),l=[],c=0,d=0,u=t.length;d<u;++d){if(r=(i=t[d]).parentNode,0<d&&(r.removeChild(i),r.hasChildNodes()||r.parentNode.removeChild(r),e))for(o=0;a=e[o++];)a.node==i&&(a.node=n,a.offset+=c),a.node==r&&a.offset>s&&(--a.offset,a.offset==s+1&&d<u-1&&(a.node=n,a.offset=c));l[d]=i.data,c+=i.data.length}n.data=l.join("")}return n.data},getLength:function(){for(var e=this.textNodes.length,t=0;e--;)t+=this.textNodes[e].length;return t},toString:function(){for(var e=[],t=0,n=this.textNodes.length;t<n;++t)e[t]="'"+this.textNodes[t].data+"'";return"[Merge("+e.join(",")+")]"}};var P=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],D={};function O(e,t,n){var i,r,o,a,s=this;s.cssClass=s.className=e;var l=null,c={};if("object"==typeof t&&null!==t){for(n=t.tagNames,l=t.elementProperties,c=t.elementAttributes,r=0;a=P[r++];)t.hasOwnProperty(a)&&(s[a]=t[a]);i=t.normalize}else i=t;s.normalize=void 0===i||i,s.attrExceptions=[];var d=document.createElement(s.elementTagName);s.elementProperties=s.copyPropertiesToElement(l,d,!0),f(c,function(e){s.attrExceptions.push(e)}),s.elementAttributes=c,s.elementSortedClassName=s.elementProperties.hasOwnProperty("className")?s.elementProperties.className:e,s.applyToAnyTagName=!1;var u,p=typeof n;if("string"==p)"*"==n?s.applyToAnyTagName=!0:s.tagNames=(u=n.toLowerCase(),u.replace(/^\s\s*/,"").replace(/\s\s*$/,"")).split(/\s*,\s*/);else if("object"==p&&"number"==typeof n.length)for(s.tagNames=[],r=0,o=n.length;r<o;++r)"*"==n[r]?s.applyToAnyTagName=!0:s.tagNames.push(n[r].toLowerCase());else s.tagNames=[s.elementTagName]}O.prototype={elementTagName:"span",elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(e,t,n){var i,r,o,a,s,l,c={};for(var d in e)if(e.hasOwnProperty(d))if(a=e[d],s=t[d],"className"==d)u(t,a),u(t,this.className),t[d]=p(t[d]),n&&(c[d]=t[d]);else if("style"==d){for(i in r=s,n&&(c[d]=o={}),e[d])r[i]=a[i],n&&(o[i]=r[i]);this.attrExceptions.push(d)}else t[d]=a,n&&(c[d]=t[d],l=D.hasOwnProperty(d)?D[d]:d,this.attrExceptions.push(l));return n?c:""},copyAttributesToElement:function(e,t){for(var n in e)e.hasOwnProperty(n)&&t.setAttribute(n,e[n])},hasClass:function(e){return 1==e.nodeType&&o(this.tagNames,e.tagName.toLowerCase())&&n(e,this.className)},getSelfOrAncestorWithClass:function(e){for(;e;){if(this.hasClass(e))return e;e=e.parentNode}return null},isModifiable:function(e){return!this.applyToEditableOnly||T(e)},isIgnorableWhiteSpaceNode:function(e){return this.ignoreWhiteSpace&&e&&3==e.nodeType&&function(e){if(0==e.data.length)return!0;if(_.test(e.data))return!1;switch(C(e.parentNode,"whiteSpace")){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(e.data))return!1}return E(e.previousSibling)||E(e.nextSibling)}(e)},postApply:function(e,t,n,i){for(var r,o,a,s=e[0],l=e[e.length-1],c=[],d=s,u=l,p=0,h=l.length,f=0,g=e.length;f<g;++f)o=e[f],(a=L(o,!i))?(r||(r=new R(a),c.push(r)),r.textNodes.push(o),o===s&&(p=(d=r.textNodes[0]).length),o===l&&(u=r.textNodes[0],h=r.getLength())):r=null;var m=I(l,!i);if(m&&(r||(r=new R(l),c.push(r)),r.textNodes.push(m)),c.length){for(f=0,g=c.length;f<g;++f)c[f].doMerge(n);t.setStartAndEnd(d,p,u,h)}},createContainer:function(e){var t=e.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,t,!1),this.copyAttributesToElement(this.elementAttributes,t),u(t,this.className),this.onElementCreate&&this.onElementCreate(t,this),t},applyToTextNode:function(e,t){var n=e.parentNode;if(1==n.childNodes.length&&this.useExistingElements&&a(n)&&o(this.tagNames,n.tagName.toLowerCase())&&x(n,this.elementProperties))u(n,this.className);else{var i=this.createContainer(v.getDocument(e));e.parentNode.insertBefore(i,e),i.appendChild(e)}},isRemovable:function(e){return a(e)&&e.tagName.toLowerCase()==this.elementTagName&&l(e)==this.elementSortedClassName&&x(e,this.elementProperties)&&!t(e,this.attrExceptions)&&this.isModifiable(e)},isEmptyContainer:function(e){var t=e.childNodes.length;return 1==e.nodeType&&this.isRemovable(e)&&(0==t||1==t&&this.isEmptyContainer(e.firstChild))},removeEmptyContainers:function(e){for(var t,n=this,i=e.getNodes([1],function(e){return n.isEmptyContainer(e)}),r=[e],o=M(r),a=0;t=i[a++];)d(t,o);N(r,o)},undoToTextNode:function(e,t,n,i){if(!t.containsNode(n)){var r=t.cloneRange();r.selectNode(n),r.isPointInRange(t.endContainer,t.endOffset)&&(A(n,t.endContainer,t.endOffset,i),t.setEndAfter(n)),r.isPointInRange(t.startContainer,t.startOffset)&&(n=A(n,t.startContainer,t.startOffset,i))}this.isRemovable(n)?m(n,i):s(n,this.className)},applyToRange:function(e,t){var n=M((t=t||[])||[]);e.splitBoundariesPreservingPositions(n),this.removeEmptyElements&&this.removeEmptyContainers(e);var i=b(e);if(i.length){for(var r,o=0;r=i[o++];)this.isIgnorableWhiteSpaceNode(r)||this.getSelfOrAncestorWithClass(r)||!this.isModifiable(r)||this.applyToTextNode(r,n);r=i[i.length-1],e.setStartAndEnd(i[0],0,r,r.length),this.normalize&&this.postApply(i,e,n,!1),N(t,n)}},applyToRanges:function(e){for(var t=e.length;t--;)this.applyToRange(e[t],e);return e},applyToSelection:function(e){var t=i.getSelection(e);t.setRanges(this.applyToRanges(t.getAllRanges()))},undoToRange:function(e,t){var n=M(t=t||[]);e.splitBoundariesPreservingPositions(n),this.removeEmptyElements&&this.removeEmptyContainers(e,n);var i,r,o=b(e),a=o[o.length-1];if(o.length){for(var s=0,l=o.length;s<l;++s)i=o[s],(r=this.getSelfOrAncestorWithClass(i))&&this.isModifiable(i)&&this.undoToTextNode(i,e,r,n),e.setStartAndEnd(o[0],0,a,a.length);this.normalize&&this.postApply(o,e,n,!0),N(t,n)}},undoToRanges:function(e){for(var t=e.length;t--;)this.undoToRange(e[t],e);return e},undoToSelection:function(e){var t=i.getSelection(e),n=i.getSelection(e).getAllRanges();this.undoToRanges(n),t.setRanges(n)},isAppliedToRange:function(e){if(e.collapsed||""==e.toString())return!!this.getSelfOrAncestorWithClass(e.commonAncestorContainer);var t=e.getNodes([3]);if(t.length)for(var n,i=0;n=t[i++];)if(!this.isIgnorableWhiteSpaceNode(n)&&y(e,n)&&this.isModifiable(n)&&!this.getSelfOrAncestorWithClass(n))return!1;return!0},isAppliedToRanges:function(e){var t=e.length;if(0==t)return!1;for(;t--;)if(!this.isAppliedToRange(e[t]))return!1;return!0},isAppliedToSelection:function(e){var t=i.getSelection(e);return this.isAppliedToRanges(t.getAllRanges())},toggleRange:function(e){this.isAppliedToRange(e)?this.undoToRange(e):this.applyToRange(e)},toggleSelection:function(e){this.isAppliedToSelection(e)?this.undoToSelection(e):this.applyToSelection(e)},getElementsWithClassIntersectingRange:function(e){var n=[],i=this;return e.getNodes([3],function(e){var t=i.getSelfOrAncestorWithClass(e);t&&!o(n,t)&&n.push(t)}),n},detach:function(){}},O.util={hasClass:n,addClass:u,removeClass:s,hasSameClasses:c,replaceWithOwnChildren:m,elementsHaveSameNonClassAttributes:w,elementHasNonClassAttributes:t,splitNodeAt:A,isEditableElement:k,isEditingHost:S,isEditable:T},i.CssClassApplier=i.ClassApplier=O,i.createCssClassApplier=i.createClassApplier=function(e,t,n){return new O(e,t,n)}})}),define("app/editor/Brush",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/MarkParser","app/document/Node","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileHelper","app/editor/UndoManager","app/editor/Emoji","app/editor/Stylize","rangy/rangy-core","app/window/MenuHelper","app/editor/polyfill","app/editor/UndoManager","app/editor/EditHelper"],function(e,t,n){"use strict";var f=e("exoskeleton-master/exoskeleton"),i=e("app/document/StringUtils"),g=e("app/document/MarkParser"),r=e("app/document/Node"),v=r.Node,y=r.TYPE,m=e("app/editor/Stylize"),s=e("app/editor/UndoManager"),b=s.SnapFlag,o=e("app/editor/EditHelper"),l=e("rangy/rangy-core.js"),a=function(e){this.editor=e,this.queue=[],this.interval=200,this.inline=new g.InlineLexer,this.articleArea=document.querySelector(this.editor.sessionStr),u.call(this)},w=null,c=null,x={},d=function(e,t){if(e||t){try{e.brush.pause(),c?e.focusCid=c.id||c.startId:e.refocus(void 0,void 0,!0),e.undo.completeSnap(!0);var n=w,i=l.createRange(),r=s.makeEmptyCommand(c||e.selection.buildUndo()),o=e.getNode(e.focusCid);if(r.undo.push(s.buildReplaceUndo(o)),i.moveToBookmark(n),e.selection.deRange(i),i.deleteContents(),i.insertNode(document.createTextNode(t)),n.start=n.start+=t.length,n.end=n.start,e.store(e.focusCid,!0),i.moveToBookmark(n),r.redo.push(s.buildReplaceUndo(o)),e.selection.setRange(i,!0),r.redo.push(e.selection.buildUndo()),e.undo.register(r),"fences"==x.type){var a=o.breakOn(!1,e);e.findElemById(a.oldCid).replaceWith(a.newHtml),e.selection.jumpIntoElemBegin(e.findElemById(a.nextFocus)),e.undo.register(a.command)}else e.brush.addToQueue(e.focusCid,!0)}catch(e){console.sendError(e.stack)}e.brush.hideAutoComplete(),e.brush.resume(!0)}else e.brush.hideAutoComplete()},u=function(){var t=this.editor;$(document).click(function(e){document.activeElement!==t.brush.articleArea&&t.brush.hideAutoComplete()}),$(".auto-suggest-container").on("mousedown","li[data-content]",function(e){c=t.selection.buildUndo()}).on("click","li[data-content]",function(e){d(t,this.getAttribute("data-content"))})},C=function(e){if(!e||!e.length)return!1;var t=window.getSelection().getRangeAt(0).getClientRects()[0],n="none"==e[0].style.display,i=document.querySelector("content").getBoundingClientRect(),r=t.left-15;return n&&(r=r+200>window.innerWidth?window.innerWidth-200:r,e.css({top:t.bottom+(File.isMac&&app.shouldFixFontGlitch?$("content").scrollTop()-i.top:0),left:r}).show()),e.find("[data-page]").hide().filter("[data-page="+x.pageNo+"]").show(),!0};a.prototype={addToQueue:function(e,t){t=t||!1,i.isNullOrEmpty(e)||this.queue.push({cid:e,inlineOnly:t})},run:function(){var e=this;this.timerID||(this.timerID=window.setInterval(function(){e.brushQueue()},this.interval))},clearAndPause:function(){this.queue=[],this.pause()},pause:function(){clearInterval(this.timerID),this.timerID=null},resume:function(e){e&&this.brushQueue(),this.run()},restart:function(){this.queue=[],this.run()},updateWordCountInSelection:function(){this.updateWordCountInSelectionTimeout&&(clearTimeout(this.updateWordCountInSelectionTimeout),this.updateWordCountInSelectionTimeout=null);var t=this;this.updateWordCountInSelectionTimeout=setTimeout(function(){var e=t.editor.selection.getWordCountInSelection();File.isMac?e&&e<t.wordCount?app.window.updateWordCountInSelection(e):app.document.updateWordCount(t.wordCount):File.isNodeHtml&&window.requestAnimationFrame(function(){$("#footer-word-count").text((e&&e!=t.wordCount?e+"/"+t.wordCount:t.wordCount)+" "+$.localize.getString("Words","Panel"))})},50)},updateWordCount:function(){this.updateWordCountTimeout&&(clearTimeout(this.updateWordCountTimeout),this.updateWordCountTimeout=null);var n=this;setTimeout(function(){var e=$(n.articleArea).clone().find("[mdtype]").after("\n").find(".CodeMirror-gutter-wrapper").remove().end().filter(".md-toc").text("[toc]").end().filter(".mathjax-block").text(function(){return $(this).children("script").html()}).end().end().text();if(n.wordCount=o.getWordCount(e),File.isMac)app.document.updateWordCount(n.wordCount);else if(File.isNodeHtml){var t=n.wordCount;window.requestAnimationFrame(function(){$("#footer-word-count").text(t+" "+$.localize.getString("Words","Panel")),$("#footer-word-count-td").text(t)})}},File.inBusyMode?500:100)},brushNode:function(e){var t=this.editor.selection.buildUndo();F.call(this,e,{},t,!1)&&this.editor.undo.exeCommand(t)},brushQueue:function(){var t=this,n={},e=t.queue.length;if(!this.editor.isIME&&!this.editor.isMousePressed){if(0<t.queue.length&&!File.isLocked){var i=t.editor.selection.buildUndo(),r=!1;t.queue.map(function(e){n[e.cid]||(r=F.call(t,e.cid,n,i,e.inlineOnly)||r,n[e.cid]=1)}),t.queue=[],r&&i&&t.editor.undo.exeCommand(i),this.expand(!0)}e&&(this.updateWordCount(),this.triggerAutoComplete())}},applyAutocompleteByKey:function(){c=null,d(this.editor,$(".auto-suggest-container:visible .active").attr("data-content"))},triggerAutoComplete:function(e){var t,n,i=null,r=this.editor.selection.getTextAround(),o=r[0],a=r[1],s=r[2],l=this.editor.getJQueryElem((this.editor.selection.getRangy()||{}).commonAncestorContainer),c=l.closest(".md-inline-math").length,d=e&&File.option.enableInlineMath,u=e||File.option.autoToggleEmojiAutoComplete||x.found&&"emoji"==x.type,p=this.editor.selection.getRangy();if(s&&p&&p.collapsed&&(o||a)){if(n=function(){if(p&&p.collapsed){var e=$(p.endContainer).closest(".md-lang"),t=e.text(),n=e.prev().text().length;if(t)return w={start:n,end:n+t.length,containerNode:e.closest("[mdtype]")[0]},t}}.call(this))return void C(this.editor.fences.showAutoSuggest(n,x));if(u&&(i=E.exec(o)))return void((t=/^(\w*:*)(\s|$)/.exec(a||""))&&(C(this.editor.emoji.showAutoSuggest(i[1]+t[1],x)),s.start-=i[1].length+1,s.end+=t[1].length,w=s));if(d&&(n=/\$?\$$/.exec(o))&&0==$(".md-expand.md-inline-math").length){var h,f=(/^\$+/.exec(a)||"").length;if(f<=n[0].length)return(h="$".repeat(n[0].length-f)).length&&(this.editor.undo.snap(editor.focusCid,b.REPLACE),p.insertNode(document.createTextNode(h)),p.collapse(!0)),this.editor.lastCursor=this.editor.selection.buildUndo(),s.start-=n[0].length,s.end+=n[0].length,p.moveToBookmark(s),this.editor.mathInline.showAutoSuggest(p),this.editor.restoreLastCursor(null,!0),void(w=null)}}else{if(!c)return this.hideAutoComplete();l.trigger("inline-math-changed")}this.hideAutoComplete()},changeAutoCompleteSelection:function(e,t){var n,i=$(".auto-suggest-container:visible"),r=i.find(".active");i.length&&x.pageCnt&&(t&&t.preventDefault(),r.length?(r.length&&(r=r.removeClass("active")[e?"prev":"next"]().addClass("active")),r.length||(x.pageNo+=e?-1:1,x.pageNo<0?x.pageNo=x.pageCnt-1:x.pageNo>=x.pageCnt&&(x.pageNo=0),n=i.find("[data-page]").hide().filter("[data-page="+x.pageNo+"]").show(),e?n.find("li:last").addClass("active"):n.find("li:first").addClass("active"))):r=i.find("ul:first>li:first").addClass("active"))},hideAutoComplete:function(){x={},w=null,$(".auto-suggest-container").hide()},expandOnDelay:function(e){var t=this;this.willExpandSoon&&clearTimeout(this.willExpandSoon),this.willExpandSoon=setTimeout(function(){t.expand(e)},10)},getFarest:function(e){var t=e.parent().closest("[md-inline]");return t.length?this.getFarest(t):e.closest("[md-inline]")},expand:function(a,e){if(!e&&this.updateWordCountInSelection(),this.willExpandSoon&&(clearTimeout(this.willExpandSoon),this.willExpandSoon=null),!this.editor.isIME){var t,n=this.editor.selection,i=n.getRangy(),r=n.rangy,o=i?i.cloneRange():null;if(o&&(o.startContainer!=this.editor.writingArea||0!=o.startOffset))if($(".selected").removeClass("selected"),i&&!File.isLocked){if(this.editor.selection.deRange(i),t=this.editor.getJQueryElem(i.commonAncestorContainer),this.editor.stylize.putBookmark(o,this.editor.stylize.buildBookmark(t)),v.isType(document.activeElement.tagName,"INPUT","TEXTAREA")||document.activeElement.hasAttribute("tabindex"))return $(".md-expand").removeClass("md-expand"),$(this.editor.sessionStr).trigger("cursorChange",this.editor.styleBookmark);if(i.collapsed){var s,l=T(t),c=t.closest("[mdtype]"),d=(c.attr("contenteditable"),[]),u=l.visibleText().length;if(!c.length||v.isType(c.attr("mdtype"),y.fences,y.math_block))return $(this.editor.sessionStr).trigger("cursorChange",this.editor.styleBookmark);if(window.getSelection().baseOffset===u&&u<l.text().length)s=l.addClass("md-expand"),(o=r.createRange()).collapseToPoint(l[0],l[0].childNodes.length),this.editor.selection.setRange(o,!0);else if(g(i,-1),s=c[0]!=$(i.startContainer).closest("[mdtype]")[0]?l:T(this.editor.getJQueryElem(i.startContainer)),i.startContainer===i.endContainer)if(i.toString().length&&i.collapse(!1),3==i.endContainer.nodeType&&i.endOffset==i.endContainer.textContent.length&&m(i.endContainer.nextElementSibling))i.endContainer.nextElementSibling.classList.add("selected"),i.selectNode(i.endContainer.nextElementSibling);else{g(i,1);var p=i.getNodes([1],m);p.length&&(o.setStart(p[0],0),o.setEnd(p[0],0),editor.selection.setRange(o,!0))}}else s=T(this.editor.getJQueryElem(i.startContainer));if(!(d=T(this.editor.getJQueryElem(i.endContainer))).length&&(d=s),s.length||d.length){var h=(o=function(e){try{var t,n,i=e.commonAncestorContainer;if(0==e.startOffset&&s.length&&(s=editor.getJQueryElem(e.startContainer)).length)if(s.closest(".md-expand").length||s[0].hasAttribute("cid")||s[0].querySelector("[cid]")||s.closest(".md-image:not(.md-img-loaded)").length)(n=s.closest(".md-expand")).length&&(s=n);else{t=s.closest("[cid]")[0];var r=e.collapsed;s=function e(t,n){if(!t.prevAll(":not(.md-meta, .md-content)").text().length){var i=t.parent();return i.attr("mdtype")?t:n.contains(i[0])||a?e(i,n):T(t)}return T(t)}(s,i.contains&&i.contains(t)?t:i),e.setStartBefore(s[0]),r&&e.collapse(!0)}if(e.endOffset==(e.endContainer.nodeType===document.TEXT_NODE?e.endContainer.length:e.endContainer.childNodes.length)){var o=editor.getJQueryElem(e.endContainer);o.length&&(o.closest(".md-expand").length||o[0].hasAttribute("cid")||o[0].querySelector("[cid]")||o.closest(".md-image:not(.md-img-loaded)").length?(n=o.closest(".md-expand")).length&&(o=n):(t=o.closest("[cid]")[0],o=function e(t,n){if(!t.nextAll(":not(.md-meta, .md-content)").text().length){var i=t.parent();return i.hasClass("[mdtype]")||i[0].contains(n)?T(t):e(i,n)}return T(t)}(o,i.contains&&i.contains(t)?t:i),e.setEndAfter(o[0])))}}catch(e){console.warn(e)}return e}(o)||o)&&!o.collapsed;$(".md-expand").removeClass("md-expand"),s.length?S.call(this,s):S.call(this,d),s.length&&d.length&&s.next().is(d)&&!d.hasClass("md-img-loaded")&&S.call(this,d,!0)}else $(".md-expand").removeClass("md-expand");if(h)window.getSelection().removeAllRanges(),this.editor.selection.deRange(o,!0);else{var f=window.getSelection().anchorNode;f&&(3===f.nodeType||f.hasAttribute&&f.hasAttribute("contenteditable"))&&this.editor.selection.deRange(o||this.editor.selection.getRangy(),!0),o.commonAncestorContainer.parentElement&&o.commonAncestorContainer.parentElement.classList.contains("ty-focusable-btn")?o.commonAncestorContainer.parentElement.classList.add("selected"):m(f)&&f.classList.add("selected")}$(this.editor.sessionStr).trigger("cursorChange",this.editor.styleBookmark)}else t=this.editor.getMarkElem(),$(".md-expand").removeClass("md-expand"),t.length&&v.isType(t.attr("mdtype"),v.TYPE.hr,v.TYPE.toc)&&(this.editor.stylize.putBookmark(null,this.editor.stylize.buildBookmark(t)),$(this.editor.sessionStr).trigger("cursorChange",this.editor.styleBookmark))}function g(e,t){return n.extendRange(e,t)}function m(e){return e&&e.classList&&e.classList.contains("ty-focusable-btn")}},isAutoCompleteShown:function(){return $(".auto-suggest-container:visible").length},focusContainer:function(e){k.call(this,e)}};var k=function(e){var t=e.closest("tr.md-end-block, li[cid]")[0],n=e[0];if(t&&n){for(;t!==n&&t.contains(n);){if(n.previousSibling&&n.previousSibling.hasAttribute&&n.previousSibling.hasAttribute("cid"))return!1;n=n.parentElement}t.classList.add("md-focus-container")}},S=function(e,t){t||($(".md-focus-container").removeClass("md-focus-container"),$(".md-focus-p").removeClass("md-focus-p")),e.length&&k(e.addClass("md-expand").trigger("expand").closest("[cid]").addClass("md-focus").closest("p").addClass("md-focus-p"))};function T(e){var t=e.parent().closest("[md-inline]");return t.length?T(t):e.closest("[md-inline]")}var F=function(e,t,n,i){function r(e){for(var t=0;t<e.attributes.length;t++)v.isType(e.attributes[t].name,"cid","contenteditable","id","for","onerror","onload")&&e.removeAttributeNode(e.attributes[t]);e.classList.remove("md-img-loaded"),e.classList.remove("md-img-error")}function u(e){for(var t=e.querySelectorAll("*"),n=0;n<t.length;n++)r(t[n]);r(e)}function p(e,t,n,i,r,o){var a,s=n.innerHtml,l=e.clone(),c=(o=n.cursorDiff,$($.parseHTML("<div>"+s+"</div>")[0]));if(l.find(".md-inline-math.md-expand").find(".MathJax_SVG").remove().end().text(function(){return this.textContent}),l.find(".md-expand").removeClass("md-expand"),u(l[0]),u(c[0]),l.html().replace(/\s*class=\"\"/gi,"")!=c.html().replace(/\s*class=\"\"/gi,"")){e.html(s),n.mdlike?e.attr("mdlike")!=n.mdlike&&e.attr("mdlike",n.mdlike):e.removeAttr("mdlike"),r.mathInline.brush(e[0],i,!0),a=!0;var d=c.textExcludeSVG().substr(0,i.start).replace(/\u200b/g,"").length-l.text().substr(0,i.start).replace(/\u200b/g,"").length;i.start-=d,i.end-=d}else l.closest(".unholdable").removeClass("unholdable"),l.find(".math-jax-preprocess").length&&r.mathInline.brush(e[0],i,!0);return r.undo&&r.undo.snap(t.cid,0,null,!0),function(e,t,n,i,r){if(t.length&&r.focusCid===i.cid)return e&&(n&&n.undo.unshift(f.utils.clone(e)),e.start=h(t,e.start),e.end=h(t,e.end),n&&n.redo.push(f.utils.clone(e))),r.undo.register(n),!0;return!1}(i,o,n.command,t,r)||a}function o(e,t,n,i,r){return n.blockChanged?(o=e,a=t,l=i,c=r,d=(s=n).cursorDiff||[],s.replaceCid?(c.findElemById(s.replaceCid).replaceWith(s.html),c.refreshUnder(c.findElemById(s.replaceCid))):o.closest("p").replaceWith(s.html),s.toRemove&&s.toRemove.forEach(function(e){c.findElemById(e).remove()}),c.focusCid&&c.focusCid!==a.cid||(c.focusCid=s.focus,c.focusCid&&k(c.findElemById(c.focusCid)),l&&(s.command.undo.unshift(f.utils.clone(l)),d.length&&(l.start=h(d,l.start),l.end=h(d,l.end)),l.startId=s.focus,l.endId=s.focus,l.start-=s.offset,l.end-=s.offset,s.command.redo.push(f.utils.clone(l))),c.undo.register(s.command)),!0):p(e,t,n,i,r);var o,a,s,l,c,d}function h(e,t){var n=t;for(var i in e)void 0!==i&&i<=t&&(n+=e[i]);return n}try{var a,s,l=e,c=e;if("string"==typeof e?l=this.editor.getNode(e):c=l.id,!l)return;if(v.isType(l,y.meta_block))return;if(-1<m.CONST.NoInline.indexOf(l.get("type")))return;if(l.get("children").length)return l.get("children").toArray().map(function(e){t&&(t[e.id]=1),F.call(this,e,t,n,i)},this),!0;if(a=this.editor.findElemById(c).addClass("md-expand"),l.get("type")==y.def_footnote){var d=a.children(".md-def-content");return s=File.option.enableInlineMath?d.textExcludeSVG():d.text(),o(d,l,g.quickParse(s,this,l,!0),n,this.editor)}return s=File.option.enableInlineMath?a.textExcludeSVG():a.text(),o(a,l,g.quickParse(s,this,l,i||!v.isType(l,y.line)),n,this.editor)}catch(e){e.stack}},E=/:(\w+)$/;n.exports=a}),define("app/editor/Stylize",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core","app/window/MenuHelper","app/editor/UndoManager","app/editor/polyfill"],function(e,t,n){"use strict";var w=e("exoskeleton-master/exoskeleton"),f=e("app/document/StringUtils"),i=e("app/document/Node"),x=e("app/editor/UndoManager"),C=(x.SnapFlag,i.Node),k=i.TYPE,b=i.NodeCollectionUtils,S=e("rangy/rangy-core.js"),m=e("app/window/MenuHelper"),g=function(){return File.isMac?app.clipboard.paste():File.isNode?reqnode("electron").remote.clipboard.readText():""};function T(e){if(e.get("style")==C.ListType.ol)return C.ListType.ol;var t=!1;return e.get("children").map(function(e){t=t||e.get("style")!==C.ListType.task}),t?C.ListType.ul:C.ListType.task}var a=function(e,n,i,t,r){var o=S.createRange();function a(e){var t;t=e.attr("md-inline")==n?e.children(".md-meta:not(.md-content)"):e.find('[md-inline="'+n+'"]').children(".md-meta:not(.md-content)"),i&&(i.end-=t.text().length),t.remove(),e.attr("md-inline")==n&&i&&(i.end=i.start+e.text().length)}if(e[0].hasAttribute("mdtype")&&(e.wrapInner("<span></span>"),e=$(e[0].firstChild)),i?(i.containerNode=e[0],o.moveToBookmark(i)):o.selectNode(e[0]),o.commonAncestorContainer.nodeType==document.ELEMENT_NODE&&o.commonAncestorContainer.getAttribute("md-inline")==n)a($(o.commonAncestorContainer));else{for(var s=document.createElement("SPAN"),l=o.extractContents(),c=0;c<l.childNodes.length;c++)s.appendChild(l.childNodes[c].cloneNode(!0));a($(s)),o.insertNode(s),o.selectNode(s)}r||v.call(this,o,n,e[0],t?i:null),this.editor.brush.addToQueue(e.attr("cid"))},v=function(e,t,n,i){var r,o,a,s,l,c,d=F.SyntaxMap[t];if(i){var u,p=this.editor.getJQueryElem(e.startContainer),h=this.editor.getJQueryElem(e.endContainer);if(p.closest("md-before").length||p.closest("md-content").length?(e.setStartBefore(p.closest("[md-inline]")[0]),u=!0):p.closest("md-meta").length&&(e.setStartAfter(p.closest("[md-inline]")[0]),u=!0),h.closest("md-after").length||p.closest("md-content").length?(e.setEndAfter(p.closest("[md-inline]")[0]),u=!0):h.closest("md-meta").length&&(e.setEndBefore(p.closest("[md-inline]")[0]),u=!0),r=e.toString(),e.collapsed||0===r.trim())return;o=u?o||e.getBookmark(n||e.commonAncestorContainer):i instanceof Object?i:{start:i,end:i}}else r=e.toString();a=/^\s+/g.exec(r),s=/\s+$/g.exec(r),a=a?a[0].length:0,s=s?s[0].length:0,(a||s)&&((o=o||e.getBookmark(n||e.commonAncestorContainer)).start+=a,o.end-=s,e.moveToBookmark(o)),l=d[1],(c=g())&&5e3<c.length&&(c=""),C.isType(t,k.link)&&(f.isURL(r)?l="]("+r+")":f.isURL(c)&&(l="]("+c+")")),C.isType(t,k.image)&&(f.isImg(r)?l="]("+r+")":f.isImg(c)&&(l="]("+c+")")),e.insertNodeAtEnd(document.createTextNode(l)),e.insertNode(document.createTextNode(d[0])),i&&(C.isType(t,k.link)?e.moveToBookmark({containerNode:n,start:o.start+1,end:1+o.end}):e.moveToBookmark({containerNode:n,start:o.start+d[0].length,end:o.end+d[0].length}),editor.selection.setRange(e,!0))},r=w.Model.extend({initialize:function(e){this.editor=e,this.CONST=F,this.putBookmark(null,{block:[]})},removeStyle:function(e,t,n){e.children(".md-meta").remove()},canContainInline:function(e){return e.jquery&&(e=e.attr("mdtype")),C.isType(e,k.line,k.def_footnote,k.heading,k.table_cell)},putStyle:function(e,t,n){this.editor.selection.deRange(e);var i=this.editor.getMarkElem(e.commonAncestorContainer),r=-1<F.InsertInline.indexOf(t);if(r&&(i=this.editor.getMarkElem(e.startContainer)),i.length&&0===i.find("[mdtype]").length&&this.canContainInline(i)){var o=x.makeEmptyCommand(this.editor.selection.buildUndo()),a=this.editor.store(i.attr("cid"));o.undo.push(x.buildReplaceUndo(a)),this.putStyleForRange(i,t,e,!0),this.editor.store(i.attr("cid")),o.redo.push(x.buildReplaceUndo(a)),o.redo.push(this.editor.selection.buildUndo()),this.editor.undo.register(o),this.editor.brush.addToQueue(a.id,!0)}else if(!r){var s=n&&this.hasStyleInRange(t,e);return function(e,n,i){var r=this.editor;function o(e){var t=e.get("children");return t.length?t.toArray().map(o):r.stylize.canContainInline(e.get("type"))&&(r.stylize.putStyleInBlock(r.findElemById(e.id),n,void 0,void 0,!0,i),r.store(e),r.brush.addToQueue(e.id)),e}var t=r.selection.getDetailPos(e.startContainer,e.startOffset),a=r.selection.getDetailPos(e.endContainer,e.endOffset),s=r.getMarkElem(t[0]),l=r.getMarkElem(a[0]),c=r.findNodeByElem(s),d=r.findNodeByElem(l),u=C.getTreePosition(c,d),p=u[1],h=u[2],f=x.makeEmptyCommand(r.selection.buildUndo()),g=e.cloneRange(),m=e.cloneRange(),v=p;for(f.undo.push(x.buildReplaceUndo(p)),m.setEndAfter(s[0]),this.canContainInline(c)&&(this.putStyleInBlock(s,n,m.getBookmark(s[0]),void 0,!0,i),r.store(c,!0)),r.UserOp.decorateOneSide(c,p,"after",o),f.redo.push(x.buildReplaceUndo(p)),r.brush.addToQueue(s.attr("cid")),v=p.get("after");v&&v!==h;)f.undo.push(x.buildReplaceUndo(v)),o(v),f.redo.push(x.buildReplaceUndo(v)),v=v.get("after");d&&d!=p&&(g.setStartBefore(l[0]),f.undo.push(x.buildReplaceUndo(h)),this.canContainInline(d)&&(this.putStyleInBlock(l,n,g.getBookmark(l[0]),void 0,!0,i),r.store(d,!0)),r.UserOp.decorateOneSide(d,h,"before",o),f.redo.push(x.buildReplaceUndo(h)),r.brush.addToQueue(l.attr("cid"))),f.redo.push(r.selection.buildUndo()),r.undo.register(f),$(".md-expand").removeClass("md-expand")}.call(this,e,t,s)}},putStyleInBlock:function(e,t,n,i,r,o){if(!r||0!=e.text().length){e[0].hasAttribute("mdtype")&&e.addClass("md-expand");try{a.call(this,e,t,n,i,o)}catch(e){console.error(e)}}},putStyleForRange:function(e,t,n,i){var r=n.getBookmark(e[0]);e[0].hasAttribute("mdtype")&&n.commonAncestorContainer.nodeType!=document.TEXT_NODE&&e.addClass("md-expand"),a.call(this,e,t,r,i)},addStyle:function(e,t){var n,i=F.SyntaxMap[t],r=document.createElement("SPAN");r.className="md-meta md-expand",r.setAttribute("md-inline",t),"link"==t&&(n=g(),f.isURL(n)&&(i[1]="]("+n+")")),r.appendChild(document.createTextNode(i[0]+i[1])),e.insertNode(r),e.moveToBookmark({containerNode:r,start:i[0].length,end:i[0].length}),this.editor.selection.rangy.getSelection().setSingleRange(e)},detach:function(e,t){return!(!e.collapsed||!$.parseHTML("<div>"+e.toHtml()+"</div>")[0].querySelector('[md-inline="'+t+'"]'))||$(e.commonAncestorContainer).closest('[md-inline="'+t+'"]').length},canToggleStyle:function(e,t,n){var i=function(e){for(var t=0;t<e.CONST.NoInline.length;t++)if(e.hasStyle(e.CONST.NoInline[t]))return!0}(this);return!!this.hasStyle(e)||!(i||/(md-meta|md-content)(\s+|$)/g.exec(t[0].className)&&!n||/md-blockmeta/g.exec(t[0].className))&&!i},clearStyle:function(){if(window.getSelection().rangeCount&&"INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&!File.isLocked){this.editor.brush.clearAndPause(),this.editor.undo.completeSnap(!0);var e=this.editor.selection.getRangy();if(e){for(var t,n=x.makeEmptyCommand(editor.selection.buildUndo()),i=editor.selection.getDetailPos(e.startContainer,e.startOffset),r=editor.selection.getDetailPos(e.endContainer,e.endOffset),o=editor.getMarkElem(i[0]),a=editor.getMarkElem(r[0]),s=editor.findNodeByElem(o),l=editor.findNodeByElem(a),c=C.getTreePosition(s,l),d=c[1],u=c[2],p=d;p&&p!=u.get("after");)p=(t=p).get("after"),n.undo.push(x.buildReplaceUndo(t)),this.editor.findElemById(t.id).find(".md-meta, .md-content").remove(),this.editor.store(t.id),this.editor.brush.addToQueue(t.id),n.redo.push(x.buildReplaceUndo(t));this.editor.undo.register(n)}this.editor.brush.resume(),this.editor.brush.expand()}},toggleStyle:function(e){if(!File.isLocked&&window.getSelection().rangeCount&&"INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&!File.isLocked){var t,n,i,r,o=this.editor.selection.getRangy(),a=this.hasStyle(e),s=this.editor.getJQueryElem(o.commonAncestorContainer),l=this.editor.getMarkElem(o.commonAncestorContainer);l.attr("cid");if(this.editor.undo.completeSnap(!0),!a){var c=this.editor.getJQueryElem(o.startContainer);"link"==e&&(a=c.closest('[md-inline="reflink"], [md-inline="autolink"]').length),"image"==e&&(a=c.closest('[md-inline="refimg"], .md-url').length)}this.editor.brush.pause();do{if(!this.canToggleStyle(e,s,o.collapsed))break;if(a){var d,u=s.closest('[md-inline="'+e+'"]');u.length||"link"!=e||(u=s.closest('[md-inline="reflink"], [md-inline="autolink"]')),"image"==e&&(u.length?d=/!\[([^\]]*)\]/.exec(u.text())[1]:d||((u=s.closest('[md-inline="refimg"]')).length?d=/!\[((?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*)\]/.exec(u.text())[1]:(u=s.closest(".md-url").closest("[md-inline]")).length&&(d="!"+u.text()))),e==k.comment&&(d=u.text().replace(/(^<\!--)|(-->)$/g,"")),n=this.editor.findNodeByElem(l),this.editor.undo.snap(n.id,x.SnapFlag.REPLACE),d?(u.text(d),this.editor.selection.selectAllElem(u)):(u.children(".md-meta, .md-content").remove(),this.editor.brush.addToQueue(u.closest("[cid]").attr("cid"),!0))}else{if(!o.collapsed){this.putStyle(o,e,!0);break}n=this.editor.findNodeByElem(l),this.editor.undo.snap(n.id,x.SnapFlag.REPLACE),t=o.getBookmark(l[0]).start;var p=l.text().substring(t-1,t+1),h="**"==p&&$(o.startContainer).closest("[md-inline='plain']").length;e==k.em&&h?(o.moveToBookmark({containerNode:l[0],start:t-1,end:t+1}),o.extractContents()):(i=o,!(r=p)||i.collapsed&&/^[\(\)\[\]\^&_\-+*#@!~`\\\/\{\}'":;<>,.?%\s]+$/.exec(r)?this.addStyle(o,e):(l.addClass("md-expand"),!h&&this.editor.selection.selectWord(!0,!1,o),(o=this.editor.selection.getRangy()).collapsed?this.addStyle(o,e):v.call(this,o,e,l[0],t)))}if(this.editor.brush.addToQueue(l.attr("cid")),e==k.inline_math&&!a){var f=this.editor;setTimeout(function(){f.brush.triggerAutoComplete(!0)},100)}}while(0);this.editor.brush.resume(!0)}},putBookmark:function(e,t){return this.editor.styleBookmark={cursor:e,style:t}},isAtFootnoteDefSpan:function(){var e=this.editor.selection.getRangy();return e&&this.editor.getJQueryElem(e.startContainer).closest(".md-def-name").length},buildBookmark:function(e){if(File.ignoreStyleChange)return File.editor.styleBookmark.style;var t,n={inline:[],block:[],state:""},i=this.editor.selection.getRangy(),r=(e=e||this.editor.getJQueryElem(i&&i.commonAncestorContainer||document.activeElement)||$()).closest("[md-inline]"),o=e;if(0==e.length){if(!(e=this.editor.getMarkElem()).length||!C.isType(e.attr("mdtype"),C.TYPE.hr,C.TYPE.toc))return n;o=e}for(;r.length;)t=r.attr("md-inline"),-1<this.CONST.LinkList.indexOf(t)&&(t="link"),n.inline.push(t),r=(o=r).parent().closest("[md-inline]");for(r=o.closest("[mdtype]");r.length;)(t=r.attr("mdtype"))===k.heading?n.block.push("header"+r[0].tagName.substring(1)):t===k.list?n.block.push(T(this.editor.findNodeByElem(r))):t===k.list_item?r.hasClass("md-task-list-item")&&!n.state&&(n.state=r.hasClass("task-list-done")?"checked":"unchecked"):n.block.push(t),r=r.parent().closest("[mdtype]");return n},hasStyleInRange:function(e,t){return 0==$(t.toHtml()).find("[md-inline='"+e+"']").remove().end().text().trim().length},hasStyle:function(e){var t=this.editor.styleBookmark.style;if(t)return-1<(t.inline||[]).indexOf(e)||-1<(t.block||[]).indexOf(e)},changeStyleFromMenu:function(e){if(!File.isLocked&&!document.body.classList.contains("modal-open")){var t=F.NameMapToStyle[e.toLowerCase()];C.isType(t,"header1","header2","header3","header4","header5","header6",k.paragraph)?this.changeBlock(t):C.isType(t,k.def_footnote,k.def_link,k.hr,k.fences,k.math_block,k.toc)?this.insertBlock(t):C.isType(t,k.table)?File.editor.tableEdit.insertTable():C.isType(t,k.meta_block)?this.insertMetaBlock():C.isType(t,k.blockquote)&&this.toggleIndent(k.blockquote)}},changeBetweenCodeMirror:function(e,t){if(C.isType(t,k.math_block,k.fences)){var n=this.editor,i=x.makeEmptyCommand(n.selection.buildUndo());n.undo.completeSnap(!0),C.isType(t,k.fences)?(n.fences.syncToNode(t.cid),n.fences.beforeDeleteFences(t)):(n.mathBlock.syncToNode(t.cid),n.mathBlock.beforeDeleteFences(t)),i.undo.push(x.buildReplaceUndo(t)),t.set("type",e),i.redo.push(x.buildReplaceUndo(t)),n.findElemById(t.id).replaceWith(t.toHTML()),e==k.fences?n.fences.getCm(t.id):e==k.math_block&&n.mathBlock.startEditing(t.id),n.selection.jumpIntoElemBegin(n.findElemById(t.id)),i.redo.push(n.selection.buildUndo()),n.undo.register(i),n.refocus(),m.refreshBlockMenu()}},toggleFences:function(){if(!File.isLocked&&!document.body.classList.contains("modal-open")){var e=this.editor.getNode(null,!0);C.isType(e,k.fences)?this.changeBlock(k.paragraph,e):C.isType(e,k.math_block)?this.changeBetweenCodeMirror(k.fences,e):this.insertBlock(k.fences)}},toggleMathBlock:function(){if(!File.isLocked&&!document.body.classList.contains("modal-open")){var e=this.editor.getNode(null,!0);C.isType(e,k.math_block)?this.changeBlock(k.paragraph,e):C.isType(e,k.fences)?this.changeBetweenCodeMirror(k.math_block,e):this.insertBlock(k.math_block)}},changeBlock:function(e,i){if(!File.isLocked&&!document.body.classList.contains("modal-open")){i=i||this.editor.getNode(null,!0);var r,t,n,o,a,s,l,c,d,u=F.getMenuBlockType(i),p=this.editor,h=i.cid;if(!C.isType(i,k.table,k.table_row,k.table_cell,k.blockquote,k.list)&&!File.isLocked)if(p.lastCursor=p.selection.buildUndo(),u!=e&&u){if(p.undo.completeSnap(!0),C.isType(u,k.fences,k.math_block)&&(p.fences.syncToNode(i.cid),p.fences.beforeDeleteFences(i)),(r=x.makeEmptyCommand(p.lastCursor)).undo.push(x.buildReplaceUndo(i.getClosetParagraphLevel())),C.isType(u,k.def_link)&&i.set("text",i.get("href")+(i.get("tittle")?' "'+i.get("tittle")+'"':"")),0==e.indexOf("header")?(n=e.substr(6)-0,(t=i.get("pattern"))&&/-|=/.exec(t)?t=n<=2?t.replace(/-|=/g,1==n?"=":"-"):void 0:t&&(t=t.replace(/#+/g,"#".repeat(n))),C.isType(i,k.line)?(a=n,s=t,d=i.getClosetParagraphLevel(),b(a,s,!0),c=((l=i.separateBlockFromLine(!1))[0]?l[0].toHTML():"")+l[1].toHTML()+(l[2]?l[2].toHTML():""),l[0]&&x.addUndoForInsert(r,l[0]),l[2]&&x.addUndoForInsert(r,l[2]),p.findElemById(d.id).replaceWith(c),i=l[1]):i=b(n,t)):(i.set("type",e),i.set("pattern",void 0)),C.isType(u,k.meta_block,k.fences)&&C.isType(i,k.paragraph)){i.set("type",k.raw_edit);var f=p.simpleParse(i),g=$(f[1]),m=g[0].getAttribute("cid"),v=g.last()[0].getAttribute("cid"),y=S.createRange();p.findElemById(f[2]).replaceWith(f[1]),f&&x.append(r,f[0]),y.setStartBefore(p.findElemById(m)[0]),y.setEndAfter(p.findElemById(v)[0]),y=p.selection.deRange(y,!0),o=p.selection.buildUndo(y)}else C.normalizeNode(i),r.redo.push(x.buildReplaceUndo(i)),p.findElemById(i.id).replaceWith(i.toHTML());o||((o=w.utils.clone(r.undo[0])).startId===h&&(o.startId=i.cid),o.endId===h&&(o.endId=i.cid),o.id===h&&(o.id=i.cid),p.undo.exeCommand(o)),r.redo.push(o),p.undo.register(r),p.refocus()}}function b(e,t,n){return i.set("type",k.heading),i.set("depth",e),i.set("pattern",t),n||(p.findElemById(i.id).replaceWith(i.toHTML()),r.redo.push(x.buildReplaceUndo(i))),i}},increaseHeaderLevel:function(){if(!File.isLocked&&!document.body.classList.contains("modal-open")){var e=this.editor.getMarkElem(),t=e.attr("mdtype");"heading"!=t&&"line"!=t||this.editor.stylize.changeHeadingLevel(this.editor.findNodeByElem(e),!0)}},decreaseHeaderLevel:function(){if(!File.isLocked&&!document.body.classList.contains("modal-open")){var e=this.editor.getMarkElem(),t=e.attr("mdtype");"heading"!=t&&"line"!=t||this.editor.stylize.changeHeadingLevel(this.editor.findNodeByElem(e),!1)}},insertMetaBlock:function(e,t){if(!File.isLocked&&!document.body.classList.contains("modal-open")){t=t||"";var n=this.editor.nodeMap.getFirst();if(!C.isType(n,k.meta_block)){this.editor.undo.completeSnap(!0),this.editor.lastCursor=this.editor.selection.buildUndo();var i=x.makeEmptyCommand(this.editor.lastCursor||this.editor.selection.buildUndo()),r=new C({type:k.meta_block,in:this.editor.nodeMap,attachTo:this.editor.nodeMap,after:n,text:t});return x.addUndoForInsert(i,r),e?{command:i,node:r}:(this.editor.findElemById(n.cid).before(r.toHTML()),this.editor.selection.restoreSelection(this.editor.findElemById(r.cid),0),i.redo.push(this.editor.selection.buildUndo()),this.editor.undo.register(i),$(this.editor.sessionStr).trigger("cursorChange"),this.editor.selection.scrollAdjust(),this.editor.refocus(r.cid),r)}}},insertBlock:function(e,t){if(!(File.isLocked||"table"!=e&&document.body.classList.contains("modal-open"))){var n=this.editor,i=n.selection.getRangy(),r="",o=null;i.collapsed||t?o=x.makeEmptyCommand():(r=n.UserOp.prepMarkHtml(i.toHtml(),n).html(),o=n.UserOp.backspaceHandler(n,null,"delSelection",!0),i=n.selection.getRangy(),n.selection.deRange(i,!0),n.refocus(null,!1,!0));var a=this.editor.getNode(null,!0),s=F.getMenuBlockType(a),l=this.editor.findElemById(a.getClosetParagraphLevel().id);if(this.editor.lastCursor=this.editor.selection.buildUndo(i),s==e||!s||!C.isType(a,k.paragraph,k.heading,k.line))return t&&t.remove(),void m.refreshBlockMenu();this.editor.undo.completeSnap(!0),o.undo.push(this.editor.lastCursor),o.undo.push(x.buildReplaceUndo(a.getClosetParagraphLevel()));var c,d=C.splitAt(a,this.editor.lastCursor.start,n,C.genNormalSplitExitFunc(!1,!0)),u=d.prev,p=t||new C({type:e,text:""}),h=d.next,f="",g=e==k.hr?(h||opt_next||u.get("after")).id:p.id;C.isType(e,k.math_block,k.fences)?p.set("text",r?n.UserOp.getMarkdownSourceFrom(r):""):k.def_link,u.insert(p,!1),x.addUndoForInsert(o,p),o.redo.push(n.undo.buildReplaceUndo(d.prev)),t&&function t(e,n){e.set("in",n),e.get("children").toArray().map(function(e){t(e,n)})}(t,a.get("in")),h&&C.isEmptyBlock(h)&&C.isType(h.get("after"),k.paragraph)?(h.remove(),h=null):h&&x.addUndoForInsert(o,h),d.opt_next&&x.addUndoForInsert(o,d.opt_next),d.opt_prev&&x.addUndoForInsert(o,d.opt_prev),C.isEmptyBlock(u)&&(x.addUndoForRemove(o,u),u.remove(),u=null),[d.opt_prev,u,p,h,d.opt_next].map(function(e){e&&(f+=e.toHTML())}),l.replaceWith(f),c=this.editor.findElemById(g),e==k.fences?this.editor.fences.getCm(p.id):e==k.math_block&&this.editor.mathBlock.startEditing(p.id),this.editor.selection.jumpIntoElemBegin(c),this.editor.lastCursor=this.editor.selection.buildUndo(),o.redo.push(this.editor.lastCursor),this.editor.undo.register(o),this.editor.refocus(),$(this.editor.sessionStr).trigger("cursorChange"),this.editor.selection.scrollAdjust()}},toggleTaskStatus:function(t){if(!File.isLocked&&!document.body.classList.contains("modal-open")){var e=this.editor.selection.getRangy(),n=this.editor.getMarkElem(e&&e.startContainer).closest(".md-task-list-item"),i=n.hasClass("task-list-done");if(void 0===t&&(t=!i),n.length&&t!==i){var r=this.editor;if(e.collapsed)r.getNode(n.attr("cid")).attr("checked",t,r,!1);else{r.undo.completeSnap(!0);var o=x.makeEmptyCommand(),a=$.parseHTML(e.toHtml());$(a).find(t?".task-list-not-done":".task-list-done").andSelf(t?".task-list-not-done":".task-list-done").each(function(){var e=r.getNode(this.getAttribute("cid")).attr("checked",t,r,!0);x.append(o,e)}),o.undo.length?r.undo.register(o):r.getNode(n.attr("cid")).attr("checked",t,r,!1)}var s=(File.isMac?app.menu.getItem("Paragraph").submenu():reqnode("electron").remote.Menu.getApplicationMenu().getItem("Paragraph").submenu).getItem("Task Status"),l=File.isNode?s.submenu:s.submenu();t?(l.getItem("Mark as Complete").setState(!0),l.getItem("Mark as Incomplete").setState(!1)):(l.getItem("Mark as Complete").setState(!1),l.getItem("Mark as Incomplete").setState(!0))}}},toggleIndent:function(f,g){if(!File.isLocked&&!document.body.classList.contains("modal-open")){var e,t,m=this.editor,n=x.makeEmptyCommand(m.selection.buildUndo()),v=this.editor.selection.getRangy();if(!(C.isType(document.activeElement.tagName,"INPUT","TEXTAREA")&&!this.editor.fences.getFocused()||File.isLocked)){if(this.editor.undo.completeSnap(!0),this.editor.store(),this.editor.lastCursor=this.editor.selection.buildUndo(),function(e){if(e&&!e.collapsed){var r=!1;!function e(t){var n,i=o(t.endContainer);i.text().length||i.parent()[0]!=t.commonAncestorContainer||(n=i.prev()[0])&&(r=!0,t.setEndAfter(n),e(t))}(e),function e(t){var n,i=o(t.startContainer);i.text().length||i.parent()[0]!=t.commonAncestorContainer||(n=i.after()[0])&&(r=!0,t.setStartBefore(n),e(t))}(e),r&&m.selection.deRange(e)}function o(e){return $(e).closest("p")}}(v),v){var i=m.selection.getDetailPos(v.startContainer,v.startOffset),r=m.selection.getDetailPos(v.endContainer,v.endOffset),o=m.getMarkElem(i[0]),a=m.getMarkElem(r[0]),s=m.findNodeByElem(o),l=m.findNodeByElem(a),c=C.getTreePosition(s,l),d=(u=c,v.collapsed&&u[2]===u[1]&&C.isType(u[1],k.line)?[u[0],u[1].getLastBrother(!0),u[1].getLastBrother(!1)]:u);e=d[1],t=d[1]===d[2]?null:d[2]}else e=this.editor.findNodeByElem(this.editor.getMarkElem());var u;e&&(this.editor.brush.pause(!0),f==k.blockquote?function(e,t,n){e=e.getClosetBlock(),t=t&&t.getClosetBlock();var i,r,o,a=e.get("parent");if(i=e,r=(r=t)||i,(o=a)&&o.get("type")==k.blockquote&&(v.collapsed||!i.get("before")&&!r.get("after")))x.addUndoForUnwrap(n,a),a.unwrap(m);else{var s=new C({type:f,in:e.get("in")});s.wrap(e,t,m),x.addUndoForWrap(n,s)}}(e=e.getClosetParagraphLevel(),t=t&&t.getClosetParagraphLevel(),n):function(e,t,n,i){var r=function(e,t){t=(t||e).getClosetParagraphLevel();var n=(e=e.getClosetParagraphLevel()).get("parent");if(v.collapsed){if(!e.get("before")&&!t.get("after")&&n&&C.isType(n.get("parent"),k.list))return n.get("parent")}else if(n&&C.isType(n.getClosetBlock(),k.list))return n.getClosetBlock()}(e,t),o=r?T(r):void 0;if(g)if("none"==i){if(!r)return;i=o}else if(r&&i==o)return;if(r)o==i?(r.get("children").map(function(e){x.addUndoForUnwrap(n,e),e.unwrap()}),x.addUndoForUnwrap(n,r),r.unwrap(m)):(n.undo.push(x.buildReplaceUndo(r)),r.set("pattern",void 0),y(r,i),m.findElemById(r.id).replaceWith(r.toHTML()),n.redo.push(x.buildReplaceUndo(r)));else{!function(e,t,n){if(t=t||e,e.get("parent")==t.get("parent")&&C.isType(e,k.line)){var i,r=e.get("parent"),o=[];if(n.undo.push(x.buildReplaceUndo(r)),o.push(r),t.get("after")&&(i=new C({type:k.paragraph}),r.giveChildrenTo(i,t.get("after"),null,!0),o.push(i),r.insert(i),n.redo.push(x.buildReplaceUndo(r)),x.addUndoForInsert(n,i)),e.get("before")&&(i=new C({type:k.paragraph}),r.giveChildrenTo(i,null,e.get("before"),!0),o.unshift(i),r.insert(i,!0),n.redo.push(x.buildReplaceUndo(r)),x.addUndoForInsert(n,i)),e!=t){for(var a,s=o.indexOf(r)+1,l=[],c=e.get("after");c!=t.get("after");)i=new C({type:k.paragraph}),c=(a=c).get("after"),a.detach(),a.set("parent",i),l.push(i),o.splice(s,0,i),s++;r.insertArray(l,!1,!0),x.addUndoForInsertArray(n,l)}1<o.length&&m.findElemById(r.cid).replaceWith(b.toHTML(o))}}(e,t=t||e,n);for(var a,s=e=e.getClosetParagraphLevel(),l=[],c=(t=t.getClosetParagraphLevel()).get("after");s&&s!=c;){var d=new C({type:k.list_item,in:e.get("in")});s=(a=s).get("after"),d.wrap(a,a,m,!0),l.push(d),x.addUndoForWrap(n,d)}y(r=new C({type:k.list,in:e.get("in")}),i);var u=l[0],p=l.last();if(f==C.ListType.task)for(var h=u;h!=p.get("after");)h.set("style",C.ListType.task),h=h.get("after");r.wrap(u,p,m),x.addUndoForWrap(n,r),m.refresh()}}(e,t,n,f),n.redo.push(this.editor.lastCursor),this.editor.undo.exeCommand(this.editor.lastCursor),this.editor.undo.register(n),this.editor.brush.resume(),this.editor.refocus(),this.editor.selection.scrollAdjust())}}function y(e,t){t!=C.ListType.ol&&t!=C.ListType.ul||(e.set("style",t),e.get("children").map(function(e){e.unset("style"),e.unset("checked")})),t==C.ListType.task&&(e.set("style",C.ListType.ul),e.get("children").map(function(e){e.set("style",C.ListType.task)}))}},changeHeadingLevel:function(e,t){var n=null;if(e.get("type")==k.line)t&&(n="header6");else if(e.get("type")==k.heading){var i=e.get("depth")-0;7==(i-=t?1:-1)?n="paragraph":0<i&&(n="header"+i)}n&&this.changeBlock(n)}}),F={SyntaxMap:{strong:["**","**"],em:["*","*"],code:["`","`"],del:["~~","~~"],underline:["<u>","</u>"],footnote:["[^"," ]"],link:["[","]()"],image:["![","]()"],highlight:["==","=="],superscript:["^","^"],subscript:["~","~"],inline_math:["$","$"],comment:["\x3c!--","--\x3e"]},NormalBlockMap:{line:"Paragraph",paragraph:"Paragraph",header1:"Header 1",header2:"Header 2",header3:"Header 3",header4:"Header 4",header5:"Header 5",header6:"Header 6",def_link:"Link Reference",def_footnote:"Footnotes"},InsertInline:["link","image","footnote","inline_math"],LinkList:["autolink","reflink","link"],NoInline:["hr","fences","def_link","code","meta_block","math_block","toc","comment","tag","atag","imgtag"],Selectable:["hr","math_block","toc"],InsertBlock:["table","fences","hr"],StyleToNameMap:{paragraph:"Paragraph",header1:"Heading 1",header2:"Heading 2",header3:"Heading 3",header4:"Heading 4",header5:"Heading 5",header6:"Heading 6",def_link:"Link Reference",def_footnote:"Footnotes",table:"Table",fences:"Code Fences",blockquote:"Quote",toc:"Table of Contents",hr:"Horizontal Line",meta_block:"YAML Front Matter",ol:"Ordered List",ul:"Unordered List",tasklist:"Task List",strong:"Strong",em:"Emphasis",code:"Code",del:"Strike",highlight:"Highlight",inline_math:"Inline Math",math_block:"Math Block",superscript:"Superscript",subscript:"subscript",image:"Image",footnote:"Superscript",autolink:"Hyperlink",reflink:"Hyperlink",link:"Hyperlink",url:"Hyperlink",underline:"Underline",comment:"Comment"},NameMapToStyle:{}};for(var o in F.StyleToNameMap)F.NameMapToStyle[F.StyleToNameMap[o].toLowerCase()]=o;F.InsertQuery='[md-inline="'+F.InsertInline.join('"],[md-inline="')+'"]',F.getMenuBlockType=function(e){var t=e.get("type");switch(t){case k.line:return k.paragraph;case k.heading:return"header"+e.get("depth");case k.list:return e.get("style")}return t},r.CONST=F,n.exports=r}),define("app/editor/Selection",["app/document/StringUtils","jquery/jquery","rangy/rangy-core","codemirror/lib/codemirror","app/document/Node","exoskeleton-master/exoskeleton","app/editor/KeyMaster"],function(e,t,n){"use strict";var S,a,b=e("app/document/StringUtils"),k=e("jquery/jquery"),T=e("rangy/rangy-core.js"),l=e("codemirror/lib/codemirror"),F=e("app/document/Node"),E=F.Node,_=e("app/editor/KeyMaster").map,M=E.TYPE,w=b.WESTERN_WORD_SPLITER,i=function(t){(this.rangy=T).init(),this.savedSel={},this.editor=t,k(document).on("selectionchange",function(e){t.selection.selectWordTime&&200<new Date-t.selection.selectWordTime&&(t.selection.selectWordTime=null)}),this.updateMetrics()},s=!1,r=k.fn.scrollTop;function o(e){return!1}function h(e){k("content").on(e?"scroll":"DOMMouseScroll mousewheel",o),setTimeout(function(){k("content").off(e?"scroll":"DOMMouseScroll mousewheel",o)},500)}k.fn.oldScrollTop=r,k.fn.scrollTop=function(e){if(void 0===e||!s)return r.apply(this,arguments)},k(document.body).on("hidden.bs.modal",".modal",function(e){File.editor.restoreLastCursor()}).on(".show.bs.modal",".modal",function(){var e=File.editor.selection.buildUndo();e&&(File.editor.lastCursor=e)}),h(),T.rangePrototype.insertNodeAtEnd=function(e){var t=this.cloneRange();t.collapse(!1),t.insertNode(e),t.detach(),this.setEndAfter(e)},k("window").on("resize",function(){File.suppressResize||(a=document.querySelector("content").clientHeight)}),i.prototype={preventScrollOnce:h,enableScroll:function(e){k("content").off(e?"scroll":"DOMMouseScroll mousewheel",o)},updateMetrics:function(){a=document.querySelector("content").clientHeight,k("content").offset().top,this.editor.defaultTextHeight=parseInt(k(".md-line").css("line-height"))},jumpIntoElemBegin:function(e,t){var n=this,i=(this.editor,e.find(".CodeMirror")[0]),r=e.children("[mdtype]");if(!e.length)return window.getSelection().removeAllRanges(),!1;if(1<e.length&&(e=k(e[0])),i)return i.CodeMirror.focus(),i.CodeMirror.execCommand("goDocStart");if(e.attr("mdtype")==F.TYPE.fences)return this.editor.fences.focus(e.attr("cid"));if(E.isType(e.attr("mdtype"),E.TYPE.image,E.TYPE.hr,E.TYPE.math_block))return this.selectNode(null,e);if(e.hasClass("footnotes"))return this.jumpIntoElemBegin(e.find(".md-def-name"));if(r.length)return this.jumpIntoElemBegin(k(r[0]),t);var o=T.createRange();return o.setStart(e[0],0),o.setEnd(e[0],0),this.deRange(o),t&&setTimeout(function(){n.setRange(o,!0),n.editor.refocus()},20),n.setRange(o,!0),!window.getSelection().anchorNode&&e.length&&(!function e(t){3==t.nodeType?(o.setStart(t,0),o.setEnd(t,0)):t.childNodes.length?e(t.childNodes[0]):(o.setStart(t,0),o.setEnd(t,0))}(e[0]),window.getSelection().addRange(o)),window.getSelection().anchorOffset},jumpIntoElemEnd:function(e,t){var n=e.find(".CodeMirror")[0];if(1<e.length&&(e=k(e[0])),n)n.CodeMirror.execCommand("goDocEnd");else{if(e.attr("mdtype")==F.TYPE.fences)return this.editor.fences.jumpCmEnd(e.attr("cid"));if(E.isType(e.attr("mdtype"),E.TYPE.image,E.TYPE.hr,E.TYPE.math_block))return this.selectNode(null,e);if(e.children("[mdtype]").length)return this.jumpIntoElemEnd(k(e.children("[mdtype]")[0]),t);e.addClass("md-expand"),this.restoreSelection(e[0],e.text().length),e.removeClass("md-expand")}},jumpInto:function(e,t){if(""==e.text())return this.jumpIntoElemBegin(e);this.restoreSelection(e[0],t)},setRange:function(e,t){this.editor.brush.updateWordCountInSelection(),t||(this.editor.brush.getFarest(k(e.startContainer)).addClass("md-expand"),this.editor.brush.getFarest(k(e.endContainer)).addClass("md-expand")),File.isTypeWriterMode&&File.option.scrollWithCursor&&this.typeWriterScroll(e.nativeRange||e),this.rangy.getSelection().setSingleRange(e,e.isBackward)},getOffset:function(e,t){if(t=t||this.getRangy())try{return t.getBookmark(e[0]).start}catch(e){}return 0},restoreEdge:function(e,o,a,s){e.jquery&&(e=e.length?e[0]:null);var l,c=0,d={};if(!a){var t=k(e).closest("[mdtype='line'], [mdtype='heading']");l=t.length&&o<t.text().length}s=s||T.createRange();try{e&&function e(t){if(3==t.nodeType){var n=c+t.textContent.length;if(a){if(c<=o&&o<=n)throw s.setEnd(t,o-c),d}else if(l){if(c<=o&&o<n)throw s.setStart(t,o-c),d}else if(c<=o&&o<=n)throw s.setStart(t,o-c),d;c=n}else{t.childNodes.length||t.nodeType!==t.ELEMENT_NODE||t.appendChild(document.createTextNode(""));for(var i=0,r=t.childNodes.length;i<r;++i)e(t.childNodes[i])}}(e)}catch(e){if(e==d)return s;throw e}return s},saveSelection:function(e,t){if(e)return e.jquery&&(e=e[0]),(t=t||this.getRangy())?(this.savedSel=t.getBookmark(e),this.savedSel):void 0},restoreSelection:function(e,t){if(!e)return window.getSelection().removeAllRanges();if(e.jquery&&(e=e[0]),!e)return window.getSelection().removeAllRanges();var n="false"===e.getAttribute("contenteditable");if(null==t||""===t?t=this.savedSel:"number"==typeof t&&(t={start:t,end:t}),"fences"===e.getAttribute("mdtype")){var i=this.editor.fences.getCm(e.getAttribute("cid"));return i.focus(),void i.setCursor(t.start)}var r=T.createRange();if(r.moveToBookmark({start:t.start,end:t.end,containerNode:e}),"BODY"==document.activeElement.tagName||document.activeElement.hasAttribute("tabindex")){var o=k("content").scrollTop();this.editor.writingArea.focus(),k("content").scrollTop(o)}r.collapsed&&this.deRange(r),n&&e.setAttribute("contenteditable","true"),this.setRange(r),n&&e.setAttribute("contenteditable","false")},getVeryFirstElem:function(e){return 0<e.children("[cid]").length?this.getVeryFirstElem(e.children("[cid]").first()):e},getVeryLastElem:function(e){return 0<e.children("[cid]").length?this.getVeryLastElem(e.children("[cid]").last()):e},getSelection:function(){return this.rangy.getSelection()},prepNode:function(e,t,n,i){var r,o=this.editor,a=this.getRangy(),s=this.editor.undo.UndoManager,l=s.SnapFlag;S=void 0;this.editor.writingArea.getAttribute("contenteditable");File.inBusyMode&&this.editor.writingArea.setAttribute("contenteditable","false");try{if(a&&!a.collapsed){if(n)return r;if(o.undo.completeSnap(!0),r=o.UserOp.surroundPair(o,e,a))return t&&t.preventDefault(),!n&&o.undo.register(r),r;r=o.UserOp.backspaceHandler(o,null,"delSelection",!0,!0)}a=this.getRangy();var c,d,u=this.rangy.getSelection(),p=u.anchorOffset==T.dom.getNodeLength(u.anchorNode),h=o.getJQueryElem(window.getSelection().anchorNode),f=o.getMarkElem(window.getSelection().anchorNode),g=o.findNodeByElem(f),m=a.getBookmark(f[0]);if(r||n||(o.undo.snap(g.cid,l.ADD,void 0,i),o.brush.addToQueue(g.cid)),h.hasClass("md-def-url")&&e.match(/\s/g).length)return p&&this.jumpIntoElemBegin(f.find(".md-def-title")),t&&t.preventDefault();if(!n&&r&&o.undo.snap(f.attr("cid"),e.length||l.ADD,o.docMenu.getAttrByElem(h)),f.removeClass("unholdable").find(".md-math-after-sym").text(""),f.closest(".unholdable").removeClass("unholdable"),g.get("type")==M.paragraph?(0===g.get("children").length&&E.normalizeNode(g),0===f.children("[mdtype]").length&&(f.replaceWith(g.toHTML()),this.jumpIntoElemEnd(this.editor.findElemById(g.cid)))):g.get("type")==M.meta_block||g.get("type")==M.fences||(g.isBlock()&&g.canNotDirectEdit()?(window.getSelection().removeAllRanges(),t&&t.preventDefault()):h.hasClass("md-image")&&(1!=a.startOffset||h.prev().length||(h.before("​"),a.setStartBefore(h.parent()),u.setSingleRange(a)))),g.get("children").length){var v=window.getSelection().anchorNode.childNodes,y=window.getSelection().anchorOffset,b=0<y?v[y-1]:null,w=y<v.length?v[y]:null,x=o.findNodeByElem(b?o.getMarkElem(b):[]),C=o.findNodeByElem(w?o.getMarkElem(w):[]);if(e=e.replace("​",""),E.isType(C,F.TYPE.table)){o.undo.completeSnap(!0),r=r||s.makeEmptyCommand();var k=new E({type:F.TYPE.paragraph,text:e,in:C.get("in")});C.insert(k,!0),s.addUndoForInsert(r,k),o.findElemById(C.id).before(k.toHTML()),o.selection.restoreSelection(o.findElemById(k.id)[0],e.length),c=k}else if(E.isType(x,F.TYPE.table)){o.undo.completeSnap(!0),r=r||s.makeEmptyCommand();k=new E({type:F.TYPE.paragraph,text:e,in:x.get("in")});x.insert(k),s.addUndoForInsert(r,k),o.findElemById(x.id).after(k.toHTML()),o.selection.restoreSelection(o.findElemById(k.id)[0],e.length),c=k}else C?(C=C.getVeryFirst(),o.undo.snap(C.cid,l.ADD),C.set("text",e+C.safeGetStrAttr("text",!0)),o.findElemById(C.id).replaceWith(C.toHTML()),C&&o.selection.jumpInto(o.findElemById(C.id),1),r=null):x&&(x=x.getVeryFirst(!0),o.undo.snap(x.cid,l.ADD),x.set("text",x.safeGetStrAttr("text",!0)+e),o.findElemById(x.id).replaceWith(x.toHTML()),o.selection.jumpIntoElemEnd(o.findElemById(x.id)),r=null);r&&r.redo.push(this.buildUndo()),!n&&o.refocus(c.id),t&&t.preventDefault()}else a.collapsed&&!File.isMac&&(d=o.UserOp.hanldePair(o,e,g,m,r,a))?("object"==typeof d&&(r=d),t&&t.preventDefault()):r&&(o.UserOp.insertInlineText(o,g,e,m.start,r,!0),s.append(r,o.undo.completeSnap(!0,!0)),t&&t.preventDefault());return!n&&r&&this.editor.undo.register(r),r}catch(e){}},getPosBookmark:function(){var e=editor.getMarkElem();if(e.length){var t=this.editor.fences.queue[e.attr("cid")];return t?{isCm:t,cid:t.cid,start:t.indexFromPos(t.getCursor())}:{isCm:!1,cid:e.attr("cid"),start:this.getRangy().getBookmark(e[0]).start}}},getRangy:function(e){var t=this.rangy.getSelection(),n=t.rangeCount?t.getRangeAt(0):null;return n&&(n.isBackward=t.isBackward(),e&&this.deRange(n)),n},buildUndo:function(e){var t={type:"cursor"};if(this.editor.sourceView.inSourceMode)return t.pos=this.editor.sourceView.cm.getCursor(),t.inSourceMode=!0,t;try{e=e||this.getRangy();var n=this.editor.getMarkElem(e?e.commonAncestorContainer:void 0);if(n.children(".CodeMirror").length){var i=n.children(".CodeMirror")[0].CodeMirror;t.id=i.cid,t.pos=i.getCursor(),t.selections=i.listSelections()}else if(n.attr("mdtype")&&n.children("[tabindex]").andSelf("[tabindex]").length)t.id=n.attr("cid"),t.focus=n.attr("mdtype");else{if(!e)return null;var r=this.editor.getMarkElem(this.getDetailPos(e.startContainer,e.startOffset)[0]),o=this.editor.getMarkElem(this.getDetailPos(e.endContainer,e.endOffset)[0]),a=e.getBookmark(r[0]);if(r===o){if(t.id=r.attr("cid"),!t.id)return null;t.start=a.start,t.end=a.end}else{if(t.startId=r.attr("cid"),t.endId=o.attr("cid"),!t.startId||!t.endId)return null;t.start=a.start,t.end=e.getBookmark(o[0]).end}}}catch(e){return e.stack,null}return t},selectNode:function(e,t){(t=t||editor.findElemById(e.id)).length&&void 0!==t.attr("tabindex")&&(window.getSelection().removeAllRanges(),t.addClass("onfocus"),t.focus())},extendToLineEdge:function(e){var t=this.editor.getMarkElem()[0],n=this.getRangy();if("TEXTAREA"!=event.target.tagName&&"INPUT"!=event.target.tagName&&n&&t){var i=n.getBookmark(t),r=T.createRange();e?i.end=t.textContent.length:i.start=0,r.moveToBookmark(i),this.setRange(r)}},extendCharFromCollapse:function(e,t){var n,i=!1,r=!t;if(e.commonAncestorContainer.nodeType==document.TEXT_NODE&&(t&&0<e.startOffset&&(e.setStart(e.startContainer,e.startOffset-1),0<e.startOffset&&56320<=(n=e.toString().charCodeAt(0))&&n<=57343&&(e.setStart(e.startContainer,e.startOffset-1),55296<=(n=e.toString().charCodeAt(0))&&n<=56319||e.setStart(e.startContainer,e.startOffset+1)),i=!0),r&&e.endOffset<e.commonAncestorContainer.textContent.length&&(e.setEnd(e.endContainer,e.endOffset+1),55296<=(n=e.toString().charCodeAt(e.toString().length))&&n<=56319&&e.endOffset<e.commonAncestorContainer.textContent.length&&e.setEnd(e.endContainer,e.endOffset+1),i=!0)),!i){var o=this.editor.getMarkElem(e.startContainer)[0],a=e.getBookmark(o);if(t&&0===a.start||r&&a.end>=o.textContent.length)return!1;t?a.start--:a.end++,e.moveToBookmark(a)}return e},moveLeftOrRight:function(e,t){S=void 0;var n,i=this.editor.getMarkElem()[0],r=this.getRangy(),o=this.editor;if("TEXTAREA"!=t.target.tagName&&"INPUT"!=t.target.tagName&&r&&i&&(!File.inBusyMode||r&&!k(r.startContainer).closest("[contenteditable='false'][cid]").length||o.writingArea.setAttribute("contenteditable","true"),!(n=k(t.target).closest("[mdtype='table_cell']")).length||n.closest("th").length&&!n.closest("th").prev().length)){var a,s=r.getBookmark(i),l=T.createRange();if(t&&!t.metaKey){if(e&&0===s.start)return this.moveUpOrDown(!0,t,!0);if(!e&&s.end>=i.textContent.length&&(!i.classList.contains("md-def-link")||0!=o.getJQueryElem(r.startContainer).closest(".md-def-title").length))return this.moveUpOrDown(!1,t,!0);var c=document.querySelector(".ty-focusable-btn.selected");if(c&&!t.ctrlKey&&!t.shiftKey&&s.end==s.start)return c.classList.remove("selected"),s.end+=e?-1:1,s.start+=e?-1:1,l.moveToBookmark(s),this.setRange(l,!0),t.preventDefault(),!0}if(File.isNodeHtml&&!e&&t&&t.ctrlKey&&!t.shiftKey){var d=i.textContent.substring(s.end)||"";if(/^\w+$/.exec(d))return s.start=s.end=i.textContent.length,l.moveToBookmark(s),this.setRange(l,!0),t.preventDefault(),!0}return e?(s.end=s.start,s.start--):(s.start=s.end,s.end++),l.moveToBookmark(s),/\u200b|\007F/g.exec(l.toString())?(l.collapse(e),this.setRange(l,!0),!0):(a=l,!k(e?a.startContainer:a.endContainer).closest(".md-inline-math").addClass("md-expand").length||t.ctrlKey||t.metaKey||t.altKey?void 0:(l.collapse(e),this.setRange(l,!0),t&&t.preventDefault(),!0))}},addUnholdable:function(e,t,n,i){this.editor.undo.completeSnap(!0);var r=function(e,t,n){var i=M.paragraph;e.get("type")==M.list_item&&(i=M.list_item);var r=new E({type:i});return e.insert(r,t),E.normalizeNode(r),r}(e,n),o=this.editor.findElemById(e.id),a=n?e:void 0,s=n?void 0:e;return n?o.before(r.toHTML()):o.after(r.toHTML()),t=t||this.editor.undo.UndoManager.makeEmptyCommand(),k(".unholdable").removeClass("unholdable"),this.editor.findElemById(r.id).addClass(i?"":"unholdable"),this.editor.undo.UndoManager.addUndoForInsert(t,r,s,a),t.discardable=!0,r},moveUpOrDown:function(f,g,m){File.inBusyMode&&g&&(g.shiftKey||g.metaKey||g.ctrlK)&&this.editor.writingArea.setAttribute("contenteditable","true");var r,v=this,o=g&&E.isType(_[g.keyCode||g.which],"Right","Left"),s=File.isNode&&g&&g.ctrlKey&&!g.shiftKey;function y(e,t){return E.isType(e,E.TYPE.hr,E.TYPE.toc)&&(!t||t[0].hasAttribute("tabindex"))}function a(e,t){return t?!e||E.isType(e,M.fences,M.table,M.math_block,M.hr,M.toc):E.isType(e,M.fences,M.table,M.math_block,M.hr,M.toc,M.def_footnote,M.def_link)}function l(e,t,n){var i=e.getVeryFirstBrotherIncludeTopBlock(t),r=v.editor.undo.UndoManager.makeEmptyCommand();return(!o&&!i&&!e.get(t?"before":"after")||a(e)&&a(e.get(t?"before":"after"),!0))&&(t&&E.isType(e,e.TYPE.meta_block)||(i=v.addUnholdable(function e(t,n){if(E.isType(t,M.fences,M.table,M.hr,M.def_link,M.def_footnote))return t;var i=n?"before":"after";return t.get("parent")?t.get("parent").get(i)?t:t.get(i)?t:e(t.get("parent")):t}(e),r,t))),r.undo.push(v.buildUndo()),n&&n(),t?s?v.jumpIntoElemBegin(v.editor.findElemById(i.id),!0):v.jumpIntoElemEnd(v.editor.findElemById(i.id),!0):v.jumpIntoElemBegin(v.editor.findElemById(i.id),!0),r}function e(e,t){d=l(e.getClosetBlock(),t),g&&g.preventDefault(),v.editor.undo.UndoManager.isEmptyCommand(d)||(d.redo.push(v.buildUndo()),v.editor.undo.register(d)),v.scrollAdjust()}function b(e){e&&(e.codemirrorIgnore=!0,e.preventDefault(),e.stopPropagation())}function t(e,t,n){var i=n||v.editor.fences.getCm(e.id),r=(i.doc.getCursor(),!n&&document.activeElement===c[0].querySelector("input.mode")),o=t&&0==i.doc.getCursor().line,a=!t&&i.doc.getCursor().line==i.lineCount()-1;s&&(o=!0),!n&&k(".autoComplt-list").is(":visible")||(t&&r?v.editor.fences.jumpCmEnd(c.attr("cid")):!a||n||r?(o||a||!t&&r)&&(d=l(e,t,function(){i.getInputField().blur()}),b(g),t&&!v.editor.undo.UndoManager.isEmptyCommand(d)&&(d.redo.push(v.buildUndo()),v.editor.undo.register(d))):(i.getInputField().blur(),b(g),setTimeout(function(){c.find("input.mode").focus()},10)),g&&g.stopPropagation())}try{var c=this.editor.getMarkElem(),n=c.attr("mdtype"),w=this.editor.findNodeByElem(c),d=v.editor.undo.UndoManager.makeEmptyCommand();if(!w)return;if(y(w,c)||c.hasClass("rawedit"))e(w,f);else if(n==F.TYPE.fences)t(w,f);else if(n==F.TYPE.math_block&&this.editor.mathBlock.currentCm)t(w,f,this.editor.mathBlock.currentCm);else if(c.closest(".td-span").length){var i=function(e,t){var n,i=e.closest("td"),r=i.prevAll().length+1;if(!i.length){if(t)return[];r=(i=e.closest("th")).prevAll().length+1}return"TD"==i[0].tagName?(n=i.closest("tr")[t?"prev":"next"]().find("td:nth-child("+r+")>.td-span"),t&&!n.length&&(n=i.closest("tbody").prev().find("tr:last > th:nth-child("+r+") > .td-span")),n):t?[]:i.closest("thead").next().find("tr:first > td:nth-child("+r+")>.td-span")}(c.closest(".td-span"),f);if(i.length)g&&g.preventDefault(),f?this.jumpIntoElemEnd(i):this.jumpIntoElemBegin(i),this.scrollAdjust(void 0,void 0,!0);else{if(o)return b(g),!1;e(w,f)}}else if(c.closest(".md-meta-block").length&&!f)!c.text().substring(window.getSelection().focusOffset).match(/\S+\n+/)&&e(w,f);else{var u=w.getClosetBlock(!0).getVeryFirstBrotherIncludeTopBlock(f);if(d.undo.push(this.editor.lastCursor),function(e,t,n){if((n=n||this.getRangy()).collapsed){if(!(r=N(n.nativeRange))||!e.length)return 0==e.text().length;var i=e[0].getBoundingClientRect();return t?i.bottom-r.bottom<parseInt(e.css("paddingBottom"))+10:r.top-i.top<parseInt(e.css("paddingTop"))+10}}.call(this,c,!f))u?function(e,t,n){var i,r,o,a,s=v.editor.findElemById(e.id);if(i=t.closest(".unholdable"),r=w.getClosetParagraphLevel(),o=n,i.hasClass("unholdable")&&r&&(i.text().length||1<i.children(".md-line").length?i.removeClass("unholdable"):(v.editor.undo.UndoManager.addUndoForRemove(o,r),o.redo.push(v.buildUndo()),r.remove(),i.remove(),v.editor.undo.register(o))),E.isType(e,M.fences))(l=v.editor.fences.getCm(e.id)).focus(),l.execCommand(f?"goDocEnd":"goDocStart"),v.editor.refocus();else if(E.isType(e,M.table,M.table_row,M.table_cell))v.jumpIntoElemBegin(s),b(g);else if(E.isType(e,M.math_block)){var l;(l=v.editor.mathBlock.startEditing(s,!0)).focus(),l.execCommand(f?"goDocEnd":"goDocStart"),v.editor.refocus()}else if(y(e))b(g),window.getSelection().removeAllRanges(),editor.findElemById(e.id).focus(),editor.refocus();else if(0<(a=s[0]).childElementCount&&function(){for(var e=0;e<a.childElementCount;e++)if(a.children[0].getAttribute("md-inline")!==M.image)return!1;return!0}())b(g),s.find("img:first").trigger("click");else if(E.isType(e,M.line,M.paragraph,M.heading,M.def_link,M.def_footnote)&&!e.get("text"))v.jumpIntoElemBegin(s),g&&g.preventDefault();else if(E.isType(e,M.meta_block)&&f)v.jumpIntoElemEnd(s),g&&g.preventDefault();else if(s.length){if(m||0==t.closest("#write").length)f?v.jumpIntoElemEnd(s):v.jumpIntoElemBegin(s);else{editor.selection.scrollAdjust(s,void 0,!0,!0),File.inBusyMode&&editor.writingArea.setAttribute("contenteditable","true");var c=v.getRangy();if(c.getBookmark(t[0]).end==t.text().length&&S){var d=v.getRangy(),u=null;if(d&&d.nativeRange.getClientRects()[0]){var p=(s.children[0]||s[0]).getBoundingClientRect(),h=f?p.y+p.height-3:p.y+3;u=document.caretRangeFromPoint(S,h)}u&&(s[0]==u.startContainer||s[0].contains(u.startContainer))?v.setRange(u):window.getSelection().modify("move",f?"backward":"forward","line")}else S=(c.nativeRange.getClientRects()[0]||{}).left,window.getSelection().modify("move",f?"backward":"forward","line")}File.isFocusMode&&(k(".md-focus").removeClass("md-focus"),k(".md-focus-p").removeClass("md-focus-p"),s.addClass("md-focus").closest("p").addClass("md-focus-p")),b(g)}}(u,c,d):!f&&c.text().trim().length&&e(w,f);else{var p=v.getRangy();if(S=(p.nativeRange.getClientRects()[0]||{}).left,!f&&p.collapsed&&p.startContainer.parentElement.classList.contains("md-def-name")&&r&&r.left){var h=r.left,x=f?r.top-9:r.bottom+9,C=document.caretRangeFromPoint(h,x);this.setRange(C,!0),b(g)}else if(File.isTypeWriterMode&&File.option.scrollWithCursor&&r&&r.left){h=r.left,x=f?r.top-9:r.bottom+9,C=document.caretRangeFromPoint(h,x);this.editor.writingArea.contains(C.startContainer)&&N(C).top!=r.top&&(this.setRange(C),b(g))}}}}catch(e){e.message}},click:function(e,t,n){window.getSelection().removeAllRanges();var i=document.createEvent("MouseEvent"),r=document.elementFromPoint(e,t);n="click",i.initMouseEvent(n,!0,!0,window,null,e,t,0,0,!1,!1,!1,!1,0,null),r.dispatchEvent(i)},jumpDefComponent:function(e){var t=this.editor.getMarkElem(),n=T.createRange();e?n.selectNodeContents(t.children(".md-def-name")[0]):n.selectNodeContents(t.children(".md-def-content")[0]),this.deRange(n,!0),this.editor.refocus()},jumpSelection:function(){return this.scrollAdjust(null,20)},jumpTop:function(e){var t=this.editor;if(t.sourceView.inSourceMode)t.sourceView.cm.execCommand("goDocStart");else{var n=this.getRangy();e&&n?(n.setStart(t.writingArea,0),this.deRange(n,!0)):this.jumpIntoElemBegin(this.editor.findElemById(this.editor.nodeMap.getFirst().cid)),File.isTypeWriterMode||k("content").animate({scrollTop:0},"100","swing",function(){t.docMenu.highlightVisibleHeader()})}},jumpBottom:function(e){var t=this.editor;if(t.sourceView.inSourceMode)t.sourceView.cm.execCommand("goDocEnd");else{var n=this.getRangy();if(e&&n){n.setEnd(t.writingArea,t.writingArea.childNodes.length),n=this.deRange(n,!0);try{n.endContainer.parentElement.classList.contains("md-def-title")&&""==n.endContainer.parentElement.textContent&&(n.setEndAfter(n.endContainer.parentElement.previousSibling.previousSibling),n=this.deRange(n,!0))}catch(e){}}else this.jumpIntoElemEnd(this.editor.findElemById(this.editor.nodeMap.getLast().getVeryFirst(!0).cid));File.isTypeWriterMode||k("content").animate({scrollTop:document.querySelector(this.editor.sessionStr).scrollHeight-window.innerHeight},"100","swing",function(){t.docMenu.highlightVisibleHeader()})}},lockScroll:function(){s=!0},unlockScroll:function(){s=!1},typeWriterScroll:function(e,t,n){s=!1;var i=this.editor;function r(e){return(0!=e.top||0!=e.bottom)&&(e=e.top-a/2+i.defaultTextHeight/2,2<Math.abs(e)&&(n?k("content").animate({scrollTop:k("content").scrollTop()+e},120,"swing",n):k("content").scrollTop(k("content").scrollTop()+e)),!0)}if(File.isTypeWriterMode){var o;if(t)return void((o=e.jquery&&e.length&&e[0].getBoundingClientRect())&&(o=document.caretRangeFromPoint((o.left+o.right)/2,o.bottom-10),this.typeWriterScroll(o)));if(!e||e.getBoundingClientRect)return void((o=e||window.getSelection().rangeCount&&window.getSelection().getRangeAt(0))&&(o.startContainer.nodeType==document.TEXT_NODE&&o.startContainer.parentElement.hasAttribute("cid")?r(o.startContainer.parentElement.getBoundingClientRect()):r(N(o))));e.jquery&&e.length&&r(e[0].getBoundingClientRect())}},scrollAdjust:function(e,t,n,i){if(this.editor.sourceView&&this.editor.sourceView.inSourceMode)this.editor.sourceView.scrollAdjust();else{if(File.isTypeWriterMode&&!i)return this.typeWriterScroll(e);try{var r,o,a,s=window.innerHeight,l=k("content").scrollTop(),c=this.editor,d=e&&e.jquery&&e.closest("[mdtype='heading']").toArray();if(e&&e.jquery){if(!e.length)return;r=e.offset().top+l}else if(e&&void 0!==e.startContainer)r=(e.nativeRange||e).getClientRects()[0].top+l;else{if(k(document.activeElement).closest(".CodeMirror-focused").find(".CodeMirror-selected").length)return this.scrollAdjust(selectedCodeMirrorDom);(o=window.getSelection().getRangeAt(0))?((a=o.getClientRects()[0])||(a=o.endContainer.nodeType===document.TEXT_NODE?o.endContainer.parentElement.getClientRects()[0]:o.endContainer.getClientRects()[0]),r=a.top+l):r=k(document.activeElement).offset().top}var u=(File.isNodeHtml?k("#top-titlebar").height():document.body.classList.contains("mac-seamless-mode")?30:0)+(k("#md-searchpanel:visible").height()||0);null!=t?k("content").animate({scrollTop:r-t-u},"500","swing",function(){c.docMenu.highlightVisibleHeader(d)}):s+l-(n?70:140)+u<r?p(r-s+(n?70:140)):r<l+u?p(r-u-(n?70:140)):c.docMenu.highlightVisibleHeader()}catch(e){}}function p(e){k("content").scrollTop(e),c.docMenu.highlightVisibleHeader(),h()}},selectAllElem:function(e){if(this.editor.sourceView.inSourceMode)this.editor.sourceView.cm.execCommand("selectAll");else{if(k("body").hasClass("typora-sourceview-on"))return this.editor.sourceView.cm.execCommand("selectAll");k(".md-math-after-sym").text("​");var t=T.createRange();e.children().length?(t.setStart(e.children()[0]),t.setEndAfter(e.children()[e.children().length-1])):t.selectNode(e[0]),this.deRange(t,!0)}},selectAll:function(e){if(this.editor.sourceView.inSourceMode)this.editor.sourceView.cm.execCommand("selectAll");else if(File.inBusyMode&&!File.isLocked&&this.editor.writingArea.setAttribute("contenteditable","true"),k(".md-math-after-sym").text("​"),document.activeElement&&E.isType(document.activeElement.tagName,"INPUT"))document.activeElement.select();else{var t=this.editor.getMarkElem(),n=T.createRange();if(t.hasClass("rawedit"))e||(n.selectNode(t[0]),this.setRange(n));else if(t.hasClass("md-fences")){var i=t.attr("cid");e||this.editor.fences.getCm(i).execCommand("selectAll")}else{if(e&&"INPUT"==e.target.tagName)return!0;t.closest('[mdtype="table"]').length?(this.selectAllElem(t.closest("[mdtype='table_cell']")),e&&e.preventDefault()):t.closest(".md-meta-block").length?(this.selectAllElem(t.closest("[mdtype='meta_block']")),e&&e.preventDefault()):(k(this.editor.sessionStr).addClass("md-expand"),k(".footnotes, .md-fences, .hr, .mathjax-block").attr("contenteditable",!0),n.setStart(k(this.editor.sessionStr).children()[0]),k(this.editor.sessionStr).children()[0].classList.contains("md-hr")&&n.setStart(k(this.editor.sessionStr).children()[1]),n.setEndAfter(k(this.editor.sessionStr).children().last()[0]),k(this.editor.sessionStr).removeClass("md-expand"),this.deRange(n,!0),e&&e.preventDefault(),setTimeout(function(){k(".footnotes, .md-fences, .hr, .mathjax-block").attr("contenteditable",!1)},10))}this.editor.lastCursor=this.buildUndo()}},getEndNode:function(e){return this.getDetailPos(e.endContainer,e.endOffset)[0]},getDetailPos:function(t,n,e){var i={};function r(e){1===e.nodeType&&0===e.childNodes.length&&e.appendChild(document.createTextNode(""))}function o(e){if(r(e),e.childNodes.length)return e.childNodes.length;if(3===e.nodeType)return e.textContent.length;if(void 0!==e.length)return e.length;throw i}if(t.parentElement&&t.parentElement.classList.contains("md-def-split"))return 0==n?this.getDetailPos(t.parentElement.previousElementSibling,t.parentElement.previousElementSibling.textContent.length,e):this.getDetailPos(t.parentElement.nextElementSibling,0,e);if(1==t.nodeType){var a=t.childNodes;if(t.classList.contains("md-image")&&2===n&&(n=1),r(t),!a||!a.length||t.classList&&t.classList.contains("md-fences"))return[t,n];try{var s=a[n]&&a[n].getAttribute&&"checkbox"===a[n].getAttribute("type");return e?(s&&n++,n==a.length?this.getDetailPos(a[n-1],o(a[n-1])):this.getDetailPos(a[n],0,!0)):0==n?(s&&n++,this.getDetailPos(a[n],0)):this.getDetailPos(a[n-1],o(a[n-1]))}catch(e){return[t,n]}}return[t,n]},deRange:function(e,t){var n=e.cloneRange();try{var i=this.getDetailPos(e.startContainer,e.startOffset,!0),r=this.getDetailPos(e.endContainer,e.endOffset,!1);return t&&i[0].parentElement&&"HR"==i[0].parentElement.tagName&&(i[0]=i[0].parentElement.parentElement),e.setStart.apply(e,i),e.setEnd.apply(e,r),t&&this.setRange(e,!0),e}catch(e){}return n},selectLine:function(){var e,t;if(this.editor.sourceView.inSourceMode)return t=(e=this.editor.sourceView.cm).getCursor(),void e.setSelection(l.Pos(t.line,0),l.Pos(t.line,e.getLine(t.line).length));var n=k(document.activeElement).closest(".CodeMirror");if(n.length)return t=(e=n[0].CodeMirror).getCursor(),void e.setSelection(l.Pos(t.line,0),l.Pos(t.line,e.getLine(t.line).length));if(document.activeElement&&E.isType(document.activeElement.tagName,"INPUT"))document.activeElement.select();else{if(window.getSelection().rangeCount){var i=window.getSelection(),r=this.editor.getMarkElem(i.commonAncestorContainer),o=T.createRange();if(r.length)if(r.closest("tr[mdtype='table_row']").length){var a=r.closest("tr[mdtype='table_row']");o.selectNode(a[0]),a.closest('[mdtype="table"]').attr("contenteditable",!0),this.deRange(o,!0),a.closest('[mdtype="table"]').attr("contenteditable",!1)}else{r.addClass("md-expand-on-selection"),window.getSelection().modify("move","backward","sentence"),window.getSelection().modify("extend","forward","sentence"),o=this.getRangy();var s=k(o.commonAncestorContainer).closest(".md-meta");s.length?this.selectAllElem(s.closest("[md-inline]")):(s=this.editor.getMarkElem(o.startContainer)).length&&s[0]!==this.editor.getMarkElem(o.endContainer)[0]&&(o.setEndAfter(s[0]),this.deRange(o,!0)),r.removeClass("md-expand-on-selection")}}this.editor.brush.updateWordCountInSelection()}},selectWord:function(e,t,n){var i,r;if(this.editor.sourceView.inSourceMode)return r=(i=this.editor.sourceView.cm).findWordAt(i.getCursor()),void i.extendSelection(r.anchor,r.head);this.selectWordTime=new Date;var o=k(document.activeElement).closest(".CodeMirror");if(o.length)return r=(i=o[0].CodeMirror).findWordAt(i.getCursor()),void i.extendSelection(r.anchor,r.head);n=n||this.getRangy();var a=null;if(e&&(a=k(n.startContainer).closest(".md-meta, .md-content")).length)return n.selectNode(a.closest("[md-inline]")[0]),void this.setRange(n);if((a=k(n.startContainer).closest(".md-content, [md-inline='url'], [md-inline='emoji'], [md-inline='escape']")).length)return n.selectNode(a.closest("[md-inline]")[0]),void this.setRange(n,!0);if((a=k(n.startContainer).closest("[md-inline]")).length||(a=k(n.startContainer).closest("[cid]")),a.length){var s=n.getBookmark(a[0]).start,l=a.text(),c=l.split(w).filter(function(e){return!!e}),d=/[\u3040-\uABFF\uD7A4-\uFAFF]/,u=[],p=null;if(c.forEach(function(e){d.test(e)?p?p+=e:p=e:(p&&u.push(p),u.push(e),p=null)}),p&&u.push(p),u.length){var h=0,f=l.length,g=0,m=0,v=!1;for(m=0;m<u.length;m++){var y=u[m].length;if(s<=g+y){v=g+y==s;break}g+=y}if(m>=u.length-1){if(h=(f=l.length)-u.last().length,e&&b.NOT_WORD.exec(u.last()))return}else if(v&&!b.NOT_WORD.exec(u[m+1]))f=(h=g+u[m].length)+u[1+m].length,t&&/\s/.exec(u[m+2]||"a")&&(f+=1);else if(b.NOT_WORD.exec(u[m])){if(e)return;f=(h=g+u[m].length)+u[1+m].length}else f=(h=g)+u[m].length,t&&/\s/.exec(u[m+1]||"a")&&(f+=1);n.moveToBookmark({containerNode:a[0],start:h,end:f}),this.setRange(n,!0),this.editor.brush.updateWordCountInSelection()}}},selectPhrase:function(){if(this.editor.sourceView.inSourceMode){var e=this.editor.sourceView.cm,t=e.findWordAt(e.getCursor());e.extendSelection(t.anchor,t.head)}else if(document.activeElement&&E.isType(document.activeElement.tagName,"INPUT"))document.activeElement.select();else{var n,i,r,o,a=this.getRangy(!0),s=!1;if(a){if(this.editor.styleBookmark.style){var l=this.editor.styleBookmark.style.block;if(-1<l.indexOf(M.def_footnote)||-1<l.indexOf(M.def_link)?/md-def-(name|url|title)|/gi.exec(document.activeElement.className)&&(s=!0,n=k(a.startContainer).closest(".md-def-name, .md-def-url, .md-def-title")[0]):-1<l.indexOf(M.table)&&(s=!0,n=k(a.startContainer).closest("[mdtype='table_cell']")[0]),n=n||function e(t){return t?t.nodeType===t.ELEMENT_NODE?t.hasAttribute("md-inline")&&t.getAttribute("md-inline")!==M.plain?t:t.hasAttribute("mdtype")?t:t.classList.contains("md-def-name")||t.classList.contains("md-def-content")||t.classList.contains("md-def-title")?t:e(t.parentElement):t.nodeType===t.TEXT_NODE?e(t.parentElement):null:null}(a.startContainer))return r=a,o=s,(i=n).getAttribute("md-inline")==M.image&&(o=!1,i=i.children[0]),o?r.selectNodeContents(i):(r.selectNode(i),editor.selection.deRange(r)),this.setRange(a,!0)}return this.selectWord()}}},isCrossBlock:function(e){return(e=e||this.getRangy())?!e.collapsed&&this.editor.getJQueryElem(e.commonAncestorContainer).find("[mdtype]").length:e},handleMouseSelection:function(e){"false"==this.editor.writingArea.getAttribute("contenteditable")&&(this.getBlockFromMouseEvent(e).closest(".md-focus").length||this.editor.writingArea.setAttribute("contenteditable","true"))},getBlockFromMouseEvent:function(e){var t=document.elementFromPoint(e.clientX,e.clientY);return k(t).closest("[cid]")},getTextAround:function(){var e,t,n=this.getRangy();if(n&&n.collapsed){var i=k(n.startContainer).closest("[md-inline='plain'], .md-lang")[0],r=n.getBookmark(i);if(i)return n.setStartBefore(i),e=n.toString(),n.collapse(!1),n.setEndAfter(i),t=n.toString(),n.setStart(i,0),[e,t,r]}return[]},getCharCountInSelection:function(e){return(e=e||this.getTextInSelection()).length},getWordCountInSelection:function(e){var t=this.editor.EditHelper.getWordCount(e||this.getTextInSelection());return Math.min(t,this.editor.brush.wordCount)},getTextInSelection:function(){var e=k(document.activeElement).closest(".CodeMirror");if(e.length)return e[0].CodeMirror.getSelection();var t=self.editor.selection.getRangy();return t&&!t.collapsed&&k(t.commonAncestorContainer).closest("#write").length?k(k.parseHTML("<div>"+t.toHtml()+"</div>")).find("[mdtype]").after("\n").filter(".md-toc").text("[toc]").end().filter(".mathjax-block").text(function(){return k(this).children("script").html()}).end().find(".CodeMirror-gutter-wrapper").remove().end().end().text():""},extendRange:function(e,t){if(e.commonAncestorContainer.nodeType===document.TEXT_NODE){if(0<t&&e.endOffset+t<=e.commonAncestorContainer.length)return e.setEnd(e.commonAncestorContainer,e.endOffset+t),e;if(t<0&&0<=e.startOffset+t)return e.setStart(e.commonAncestorContainer,e.startOffset+t),e}var n=k(e.startContainer).closest("[cid]")[0],i=e.getBookmark(n);return 0<t?i.end+=t:i.start+=t,e.moveToBookmark(i),e},createRange:function(e,t,n,i){var r=T.createRange();return r.setStart(e,t),r.setEnd(n,i),r.startContainer?r:null}};var N=function(e){var t=e.getClientRects(),n=t.length&&t[t.length-1];return!n&&e.collapsed?(e.startContainer.nodeType==document.TEXT_NODE?e.startContainer.parentElement:e.startContainer).getBoundingClientRect():n};n.exports=i,n.exports.buildRange=function(e,o,a){if(!e)return window.getSelection().removeAllRanges();var s=0,l=T.createRange(),c=!1,d={};l.collapseToPoint(e,0);try{!function e(t){if(3==t.nodeType){var n=s+t.textContent.length;if(!c&&s<=o&&o<=n&&(l.setStart(t,o-s),c=!0),c&&s<=a&&a<=n)throw l.setEnd(t,a-s),d;s=n}else for(var i=0,r=t.childNodes.length;i<r;++i)e(t.childNodes[i])}(e)}catch(e){if(e==d)return l;throw e}},n.exports.rangy=T}),define("app/editor/TableEdit",["jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","app/editor/UndoManager","app/editor/polyfill","app/editor/KeyMaster"],function(e,t,n){"use strict";var E=e("jquery/jquery"),i=e("exoskeleton-master/exoskeleton"),r=e("app/document/Node"),a=r.TYPE,_=r.Node,M=e("app/editor/UndoManager"),N=(e("app/editor/polyfill"),e("app/editor/KeyMaster").map),A=99,L=20,I=i.Model.extend({initialize:function(u){var n,p=this;this.editor=u,this.TableEdit=I,E(u.sessionStr).on("click",".md-align-gp button",function(e){var t,n=/md-align-\S+/g.exec(this.className)[0].substring(9),i=E(this).closest(".md-align-gp").attr("data-col"),r=E(this).closest('[mdtype="table"]'),o=u.findNodeByElem(r);null!=i&&(i-=0,t=o.get("align")[i]==n?null:n,o.attr("align_idx",[i,t],u),e.stopPropagation(),u.lastCursor&&u.undo.exeCommand(u.lastCursor))}).on("click",".md-delete-table",function(){u.tableEdit.deleteTable(E(this).closest("[mdtype='table']"))}).on("click",".md-resize-table",function(e){E(this).next(".md-table-resize-popover").length?(E(".md-table-resize-popover").remove(),u.lastCursor&&u.undo.exeCommand(u.lastCursor)):function(e){var l,t='<div class="popover bottom md-table-resize-popover" style="display:block; bottom:auto; top:20px; margin-left:-10px;" contenteditable="false">\t\t\t\t\t<div class="arrow" style="left:20px;"></div>\t\t\t\t\t<div class="md-grid-board-wrap md-reset code-tooltip-content">\t\t\t\t\t\t<table role="grid" class="md-grid-board md-reset">\t\t\t\t\t\t\t<tbody>\t\t\t\t\t\t\t\t<tr class="md-reset" row="1">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="2">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="3">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="4">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="5">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="6">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="7">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="8">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="9">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="10">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t</tbody>\t\t\t\t\t\t</table>\t\t\t\t\t\t<div class="popover-title">\t\t\t\t\t\t\t<input id="md-grid-width" type="text"  max="20" size="2" min="1" value="0" /> x <input id="md-grid-height" maxlength="2" size="2" min="1" value="0"/><button id="md-resize-grid" class="btn btn-primary btn-xs">'+E.localize.getString("OK")+"</button>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t</div>",c=e.closest('[mdtype="table"]'),d=u.findNodeByElem(c),n=d.get("align").length,i=c.children("table").children("tbody").children("tr").length+1;function r(){E(this).val().trim().length||E(this).val(2);var e=l.find("#md-grid-width").val(),t=l.find("#md-grid-height").val();l.find("a.md-active").removeClass("md-active"),l.find("tr:nth-child(-n+"+t+")>td:nth-child(-n+"+e+")>a").addClass("md-active")}E(".md-table-resize-popover").remove(),e.append(t),(l=e.find(".md-table-resize-popover")).find("tr:nth-child(-n+"+i+")>td:nth-child(-n+"+n+")").addClass("md-grid-ext"),l.find("#md-grid-width, #md-grid-height").off("keydown keypress").on("keypress",function(e){if(!/\d/.exec(String.fromCharCode(e.which)))return!1}).on("keydown",function(e){var t=e.keyCode||e.which;return"Up"===N[t]?(this.value=this.value-0+1,this.value=Math.min("md-grid-height"==this.getAttribute("id")?A:L,this.value),!1):"Down"===N[t]?(this.value=this.value-1,this.value=Math.max(2,this.value),!1):void 0}),l.find("#md-grid-width").val(n).off("blur focus").blur(r).focus(function(){l.find("#md-resize-grid").show()}).blur(function(){this.value>L?this.value=L:this.value<2&&(this.value=2)}).on("keydown",function(e){var t=e.keyCode||e.which;if("Tab"===N[t]&&!e.ctrlKey)return l.find("#md-grid-height").focus(),!1;"Enter"===N[t]&&l.find("#md-grid-height").focus()}),l.find("#md-grid-height").val(i).off("blur focus").blur(r).focus(function(){l.find("#md-resize-grid").show()}).blur(function(){this.value>A?this.value=A:this.value<2&&(this.value=2)}).on("keydown",function(e){var t=e.keyCode||e.which;if("Tab"===N[t]&&!e.ctrlKey)return l.find("#md-grid-width").focus(),!1;"Enter"===N[t]&&l.find("#md-resize-grid").click()}),l.find(".md-grid-board a").off("mouseenter mouseleave click").hover(function(){var e=E(this).closest("td"),t=e.prevAll().length+1,n=e.closest("tr").prevAll().length+1;n=1===n?2:n,l.find("a.md-active").removeClass("md-active"),l.find("tr:nth-child(-n+"+n+")>td:nth-child(-n+"+t+")>a").addClass("md-active"),l.find("#md-grid-width").val(t),l.find("#md-grid-height").val(n),l.find("#md-resize-grid").hide()}).click(function(e){e.stopPropagation(),e.preventDefault(),l.find("#md-resize-grid").click()}),l.find(".md-grid-board").off("mouseleave").on("mouseleave",function(e){E(this).find("a").removeClass("md-active"),E("#md-grid-width").val(n),E("#md-grid-height").val(i)}),l.find("#md-resize-grid").off("click").click(function(e){var t,n=(l.find("#md-grid-width").val()||0)-0,i=(l.find("#md-grid-height").val()||0)-0,r=d.getFirstChild(),o=d.get("align").length,a=0,s=u.undo.UndoManager.makeEmptyCommand();for(s.undo.push(u.undo.buildReplaceUndo(d));r||a<i;)a<i?(r?I.resizeRow(r,n,d):r=I.newEmptyRowAfter(t,n,d),r=(t=r).get("after")):r&&(r=(t=r).get("after"),t.delete()),a++;n<o?d.set("align",d.get("align").slice(0,n)):d.set("align",d.get("align").concat([].repeat(null,n-o))),c.replaceWith(d.toHTML()),u.lastCursor?u.undo.exeCommand(u.lastCursor):window.getSelection().removeAllRanges(),p.showTableEdit(d),s.redo.push(u.undo.buildReplaceUndo(d)),u.undo.register(s)})}(E(this).parent()),e.stopPropagation()}).on("click",".ty-table-edit",function(e){E(e.target).closest(".md-table-resize-popover").length||(E(".md-table-resize-popover").remove(),u.lastCursor&&E(".md-table-resize-popover").length&&u.undo.exeCommand(u.lastCursor)),e.stopPropagation()}).on("mousedown",".ty-table-edit button",function(){File.editor.lastCursor=File.editor.selection.buildUndo()||File.editor.lastCursor}).on("refocus","[mdtype='table']",function(){E(document.activeElement).closest("[md-inline='image']").length||p.showTableEdit(E(this))}).on("mouseup",".ty-table-edit",function(e){e.stopPropagation()}).on("click",".md-table-more",function(){E(File.editor.sessionStr).trigger("cursorChange"),File.editor.lastCursor=File.editor.selection.buildUndo(),File.editor.contextMenu.updateTableVisiblity(),File.editor.contextMenu.showExtMenu("#table-menu",E(this))}),(n=E("#table-insert-dialog")).find("#table-insert-col, #table-insert-row").off("keydown keypress keyup change").on("keypress",function(e){if(!/\d/.exec(String.fromCharCode(e.which)))return!1}).on("keydown",function(e){var t=e.keyCode||e.which;return"Up"===N[t]?(this.value=this.value-0+1,this.value=Math.min("table-insert-row"==this.getAttribute("id")?A:L,this.value),!1):"Down"===N[t]?(this.value=this.value-1,this.value=Math.max(2,this.value),!1):void 0}).on("keyup",function(){E(this).trigger("change")}).on("change",function(){File.isMac&&app.touchBar&&app.touchBar.updateInsertTableTouchBar()}),n.find("#table-insert-col").blur(function(){0===E(this).val().trim().length&&E(this).val(2),this.value>L?this.value=L:this.value<1&&(this.value=1)}).on("keydown",function(e){var t=e.keyCode||e.which;if("Tab"===N[t]&&!event.ctrlKey||"Enter"===N[t])return n.find("#table-insert-row").focus(),!1}),n.find("#table-insert-row").blur(function(){0===E(this).val().trim().length&&E(this).val(2),this.value>A?this.value=A:this.value<2&&(this.value=2)}).on("keydown",function(e){var t=e.keyCode||e.which;if("Tab"===N[t]&&!event.ctrlKey)return n.find("#table-insert-col").focus(),!1;"Enter"===N[t]&&n.find(".btn-primary").trigger("click")}),n.find(".btn-primary").click(function(){n.modal("hide"),u.restoreLastCursor(),E(File.editor.sessionStr).trigger("cursorChange");var e=new _({type:_.TYPE.table,in:u.nodeMap});I.valify(e,n.find("#table-insert-col").val(),n.find("#table-insert-row").val()),u.stylize.insertBlock(_.TYPE.table,e)}),E(u.sessionStr).on("keydown","[mdtype='table']",function(e){var t=e.keyCode||e.which;if("Tab"===N[t]&&!event.ctrlKey)return p.moveToNextCell(!0,e.shiftKey),!1;if("Enter"===N[t]){var n=p.editor.UserOp.backspaceHandler(p.editor,null,"delSelection");if(e.shiftKey)p.editor.UserOp.pasteHandler(p.editor,"<br />",!0);else if(File.isMacOrMacNode?e.metaKey:e.ctrlKey){var i=p.addRow(!1,-1<p.editor.undo.commandStack.indexOf(n));M.append(n,i)}else p.moveToBeblowCell(M.isEmptyCommand(n));return!1}return File.isMac&&_.isType(N[t],"Left","Right","Up","Down")&&e.metaKey&&e.ctrlKey?("Up"==N[t]?p.moveRowUpOrDown(!0):"Down"==N[t]?p.moveRowUpOrDown(!1):"Left"==N[t]?p.moveColLeftOrRight(!0):"Right"==N[t]&&p.moveColLeftOrRight(!1),!1):File.isNode&&_.isType(N[t],"Left","Right","Up","Down")&&e.shiftKey&&e.ctrlKey?("Up"==N[t]?p.moveRowUpOrDown(!0):"Down"==N[t]?p.moveRowUpOrDown(!1):"Left"==N[t]?p.moveColLeftOrRight(!0):"Right"==N[t]&&p.moveColLeftOrRight(!1),!1):(File.isMacOrMacNode?e.metaKey:e.ctrlKey)&&("Left"===N[t]||"Right"===N[t])?(p.moveToNextCell(!1,"Left"===N[t],!0),!1):void 0});var a,r,s,t,o,l,c,d,h,f,g,m,i,v,y=0;function e(e){if(!File.isLocked){p.editor.focusCid=null,o=!0,window.getSelection().removeAllRanges(),C();var t,n=r.children();E("#typora-table-row-tracker .typora-table-data-area").html((t=r.height(),r.closest("thead").length?"<table class='md-table' style='margin:0 ; padding:0; margin-left:0; height:"+t+"px;'><thead>"+r[0].outerHTML+"</thead></table>":"<table class='md-table' style='margin:0 ; padding:0; margin-left:0; height:"+t+"px;'><tbody>"+r[0].outerHTML+"</tbody></table>")).find("td, th").each(function(e){this.style.width=n[e].offsetWidth+"px"}),g=e.offsetX,m=e.offsetY,d=c=r.closest("thead").length?0:r.prevAll().length+1,f=[];var i=a.offset().top;return r.closest("table").find("[mdtype='table_row']").each(function(){f.push(this.offsetTop+i)}),f.push(f.last()+a.find("tbody tr:last-child")[0].offsetHeight),!1}}function b(e){if(!File.isLocked){p.editor.focusCid=null,l=!0,window.getSelection().removeAllRanges();var t,n,i=k(d=c=h),r=E(i[0]).offset();E("#typora-table-col-tracker .typora-table-data-area").offset(r).html((t=i,n=s[0].offsetWidth,"<table class='md-table' style='margin:0 ; padding:0; height:"+a.height()+"px; width:"+n+"px;'><thead><tr>"+t[0].outerHTML+"</tr></thead><tbody>"+t.toArray().map(function(e,t){return t?"<tr style='width:"+e.offsetWidth+"px; height:"+e.offsetHeight+"px;'>"+e.outerHTML+"</tr>":""}).join("")+"</tbody></table>")),C(!0),g=e.offsetX,m=e.offsetY,y=E("content").offset().left,f=[];var o=a.offset().left;a.find("thead:last-of-type th").each(function(){f.push(this.offsetLeft+o)}),f.push(f.last()+a.find("thead [mdtype='table_row'] th:last-child")[0].offsetWidth)}}function w(e){o?function(n){if(!o)return;var e;E("#typora-table-row-tracker").css("top",n.clientY-m-t+document.querySelector("content").scrollTop),0<(e=f.findIndex(function(e,t){return f[t]>n.clientY}))&&(e-=1);-1==e&&(e=f.length-1);c!=e&&function(e){var t;if(e>=f.length-1)(t=a.find("tbody tr:last-child").offset()).top+=a.find("tbody tr:last-child")[0].offsetHeight;else{var n=E(a.find("tr[mdtype]")[e]);if(n[0]==r[0]||!n.length)return x();t=n.offset()}E("#typora-table-row-insert-marker").width(a[0].offsetWidth).show().offset(t)}(c=e)}(e):l&&function(n){if(!l)return;var e;E("#typora-table-col-tracker").css("left",n.clientX-g-y);var i=a.scrollLeft();0<(e=f.findIndex(function(e,t){return f[t]>n.clientX+i}))&&(e-=1);-1==e&&(e=f.length-1);c!=e&&function(e){var t;if(e>=f.length-1)(t=a.offset()).left+=a[0].offsetWidth;else{if(d==e||d+1==e)return x();t=k(e).offset()}a.find(".ty-table-edit").remove(),E("#typora-table-col-insert-marker").height(a[0].offsetHeight).show().offset(t)}(c=e)}(e)}function x(){E(".typora-table-insert-marker").hide()}function C(e){E("#write").addClass("no-selection"),File.preventScroll=!0,e?(k(h).addClass("typora-on-moving"),E("#typora-table-row-tracker").hide()):(r.addClass("typora-on-moving"),E("#typora-table-col-tracker").hide())}function k(e){return a.find("[mdtype='table_row']>*:nth-child("+(e+1)+")")}function S(e){File.preventScroll=!1,E("#write").removeClass("no-selection"),E("content").removeClass("prevent-scroll"),E(".typora-on-moving").removeClass("typora-on-moving"),x()}function T(e){o?function(e){if(!o)return;o=!1,S(),R(),p.moveTableRow(d,c,a),F()}():l&&function(e){if(!l)return;l=!1,S(),R(),p.moveTableCol(d,c,a),p.showAlignCol(a),F()}()}function F(){l=o=!1,c=d=s=r=a=null}setTimeout(function(){t=E("content").offset().top},200),i=E("#typora-table-row-tracker"),v=E("#typora-table-col-tracker"),E(u.sessionStr).on("mouseenter click","th, td",function(e){if(0!=(s=E(this)).children("[mdtype]").length){r=s.closest("tr"),a=r.closest("[mdtype='table']"),h=s.prevAll().length;var t=r.offset(),n=s.offset();i.show().offset(t).find(".typora-table-drag-area").height(r[0].offsetHeight+1),n.top=a.offset().top,v.show().offset(n).find(".typora-table-drag-area").width(s[0].offsetWidth+1)}}),E(document).on("mousedown","#typora-table-row-tracker",e).on("mousedown","#typora-table-col-tracker",b).on("mousemove",w).on("mouseup",T)},moveTableRow:function(e,t,n){if(this.editor.undo.completeSnap(!0),e!=t&&e+1!=t){n=n||this.editor.getMarkElem().closest("[mdtype='table']");var i=this.editor,r=i.selection.buildUndo(),o=M.makeEmptyCommand(r),a=i.findNodeByElem(n),s=a.getNthChild(e);o.undo.push(M.buildReplaceUndo(a)),_.tryResetTable(a),e<--t&&t--,s.detach(),0<=t?a.getNthChild(t).insert(s):a.getFirstChild().insert(s,!0),o.redo.push(M.buildReplaceUndo(a)),n.replaceWith(a.toHTML()),r&&(i.undo.exeCommand(r),o.redo.push(i.selection.buildUndo())),i.undo.register(o),this.showTableEdit(a)}},moveTableCol:function(e,t,n){this.editor.undo.completeSnap(!0),n=n||this.editor.getMarkElem().closest(".md-table");var i=this.editor,r=i.selection.buildUndo(),o=M.makeEmptyCommand(r),a=i.findNodeByElem(n),s=a.getFirstChild();if(e!=t&&e+1!=t){for(o.undo.push(M.buildReplaceUndo(a)),_.tryResetTable(a),e<--t&&t--;s;){var l=s.getNthChild(e);l.detach(),0<=t?s.getNthChild(t).insert(l):s.getFirstChild().insert(l,!0),s=s.get("after")}var c=a.get("align").splice(e,1)[0];a.get("align").splice(t+1,0,c),a.get("alignText")&&(c=a.get("alignText").splice(e,1)[0],a.get("alignText").splice(t+1,0,c)),o.redo.push(M.buildReplaceUndo(a)),n.replaceWith(a.toHTML()),r&&(i.undo.exeCommand(r),o.redo.push(i.selection.buildUndo())),i.undo.register(o),this.showTableEdit(a)}else this.showTableEdit(a)},moveRowUpOrDown:function(e){var t=this.editor.selection.getRangy();if(t&&!File.isLocked){var n=E(t.commonAncestorContainer).closest("[mdtype='table_row']").closest("tr");if(0!=n.length){var i=n.closest("thead").length?0:n.prevAll().length+1;e&&0==i||!e&&i&&0==n.nextAll().length||this.moveTableRow(i,e?i-1:i+2,n.closest("[mdtype='table']"))}}},moveColLeftOrRight:function(e){var t=this.editor.selection.getRangy();if(t&&!File.isLocked){var n=E(t.commonAncestorContainer).closest("[mdtype='table_cell']").closest("td, th");if(0!=n.length){var i=n.prevAll().length;e&&0==i||!e&&0==n.nextAll().length||this.moveTableCol(i,e?i-1:i+2,n.closest("[mdtype='table']"))}}},insertTable:function(){File.isLocked||document.body.classList.contains("modal-open")||(this.editor.lastCursor=this.editor.selection.buildUndo(),E("#table-insert-dialog").modal({keyboard:!0}),File.isMac&&app.touchBar&&app.touchBar.showInsertTableTouchBar(),setTimeout(function(){E("#table-insert-col").focus()},500))},resizeTableEdit:function(e){var t=e.parent().children(".ty-table-edit"),n=e.parent()[0].getBoundingClientRect(),i=t.length&&t[0].getBoundingClientRect();t.length&&(t[0].style.marginTop="-"+i.height+"px",t[0].style.width=n.width+10+"px")},showTableEdit:function(e){var t=e,n=e;function i(e){var t=[],n=E.localize.getString("Align Left"),i=E.localize.getString("Align Center"),r=E.localize.getString("Align Right"),o=E.localize.getString("Resize Table"),a=E.localize.getString("Delete Table"),s=E.localize.getString("More Actions"),l='<span class="btn-group btn-group-xs md-align-gp"><button type="button" class="btn btn-default md-align-left" ty-hint="'+n+'" aria-label="'+n+'"><span class="glyphicon glyphicon-align-left"></span></button><button type="button" class="btn btn-default md-align-center" ty-hint="'+i+'" aria-label="'+i+'"><span class="glyphicon glyphicon-align-justify"></span></button><button type="button" class="btn btn-default md-align-right" ty-hint="'+r+'" aria-label="'+r+'"><span class="glyphicon glyphicon-align-right"></span></button></span>';return t.push("<div class='ty-table-edit md-table-edit md-tooltip-remove' contenteditable='false'>"),t.push('<span class="md-th-button btn-group-xs md-resize-table-th"><button type="button" class="btn btn-default md-resize-table" ty-hint="'+o+'" aria-label="'+o+'"><span class="glyphicon glyphicon-th"></span></button></span>'),t.push(l),t.push('<span class="md-th-button right-th-button btn-group-xs"><button type="button" class="btn btn-default md-delete-table" ty-hint="'+a+'" aria-label="'+a+'"><span class="glyphicon glyphicon-trash"></span></button></span>'),t.push('<span class="md-th-button right-th-button"><button type="button" class="btn btn-default md-table-more" aria-label="'+s+'"><span class="md-table-more-label">More Actions</span><span class="ty-icon ty-dots-v" style="margin-left:8px;"></span></button></span>'),t.push("</div>"),t.join("")}e.jquery?t=editor.findNodeByElem(e):n=editor.findElemById(t.id),n.children(".md-table").length&&(n=n.children(".md-table")),n.prev(".ty-table-edit").length||(E(".ty-table-edit").remove(),i(),n.before(i())),this.resizeTableEdit(n),this.showAlignCol(n)},showAlignCol:function(e){var t=this.editor.selection.getRangy(),n=t&&E(t.startContainer).closest("td, th");if(n&&n.length){E(".md-table-more, .md-delete-table").show();var i,r,o,a=this.editor.findNodeByElem(e.closest("[cid]")).get("align"),s=n.prevAll().length;r=a[i=s],(o=e.closest("figure").find(".md-align-gp").show()).find("button").removeClass("active"),o.attr("data-col",i),"left"!==r&&"right"!==r&&"center"!==r||o.find(".md-align-"+r).addClass("active")}else E(".md-align-gp, .md-table-more, .md-delete-table").hide()},moveToNextCell:function(e,t,n){try{var i,r=this.editor.getMarkElem(window.getSelection().anchorNode).closest("[mdtype='table_cell']").parent(),o=(t?r.prev():r.next()).children("[mdtype='table_cell']");if(n){var a=this.editor.selection.getRangy().getBookmark(r[0]);if(t&&0<a.end)return this.editor.selection.jumpIntoElemBegin(r),this.editor.refocus();if(!t&&a.start<r.text().length)return this.editor.selection.jumpIntoElemEnd(r),this.editor.refocus()}!o.length&&r.length&&(i=r.parent(),(o=(t?i.prev().children(":last"):i.next().children(":first")).children("[mdtype='table_cell']")).length||(t&&"TD"===r[0].tagName?o=i.closest("table").find("thead>tr>th:last>[mdtype='table_cell']"):t||"TH"!==r[0].tagName||(o=i.closest("table").find("tbody>tr:first>td:first>[mdtype='table_cell']")))),o.focus(),o.length&&(e?this.editor.selection.selectAllElem(o):t?this.editor.selection.jumpIntoElemEnd(o):this.editor.selection.jumpIntoElemBegin(o)),this.editor.refocus()}catch(e){}},moveToBeblowCell:function(e,t,n){try{var i=this.editor.getMarkElem(window.getSelection().anchorNode).closest("[mdtype='table_cell']"),r=this.editor.findNodeByElem(i),o=I.getNextCellInColumn(r,t),a=o&&this.editor.findElemById(o.cid);o?a.length&&(e?this.editor.selection.selectAllElem(a):t?this.editor.selection.jumpIntoElemEnd(a):this.editor.selection.jumpIntoElemBegin(a)):this.editor.selection.moveUpOrDown()}catch(e){}},getSibling:function(e,t,n){return I.getSibling(e,t,n)},unfocusAll:function(e){e?E(".ty-table-edit").fadeOut(function(){E(".ty-table-edit").remove()}):E(".ty-table-edit").remove(),E(".typora-table-tracker").hide()},deleteRow:function(){I.deleteRow(this.editor)},addRow:function(e,t){return I.addRow(this.editor,e,t)},deleteCol:function(){I.deleteCol(this.editor)},addCol:function(e){I.addCol(this.editor,e)},copyTable:function(){var e=this.editor.getMarkElem(window.getSelection().anchorNode).closest(".md-table-fig");(e=e.clone()).find(".md-tooltip-remove").remove(),e.find("td, th").attr("style",function(e,t){return"border: 1px solid rgb(204, 204, 204);min-height:1ch;min-width:4ch;"+(this.style.textAlign?"text-align:"+this.style.textAlign+";":"")});var t=e.html(),n=this.editor.UserOp.prepMarkHtml(e[0].outerHTML,editor),i=this.editor.UserOp.getMarkdownSourceFrom(n.html());this.editor.UserOp.setClipboard(t,"",i,!0)},deleteTable:function(e,t){R(),E("#ty-tooltip").hide(),editor.undo.completeSnap(!0),e=e||editor.getMarkElem(window.getSelection().anchorNode).closest("[mdtype='table']");var n=this.editor.getNode(e.attr("cid")),i=editor.undo.UndoManager.makeEmptyCommand(this.editor.selection.buildUndo()),r=n.get("after"),o=n.get("before");return r||o?(M.addUndoForRemove(i,n),n.remove(),e.remove()):(i.undo.push(M.buildReplaceUndo(n)),n.set("type",a.paragraph),n.set("text",""),n.clearChildren(),_.normalizeNode(n),e.replaceWith(n.toHTML()),i.redo.push(M.buildReplaceUndo(n))),editor.focusCid=null,r?this.editor.selection.jumpIntoElemBegin(this.editor.findElemById(r.id)):this.editor.selection.jumpIntoElemEnd(this.editor.findElemById((o||n).id)),this.editor.lastCursor=null,i.redo.push(this.editor.selection.buildUndo()),!t&&this.editor.undo.register(i),i},isTableEmpty:function(e){function t(e){for(var t=0,n=e.get("children").length;t<n;t++)if(e.get("children").at(t).get("text"))return!1;return!0}for(var n=0,i=e.get("children").length;n<i;n++)if(!t(e.get("children").at(n)))return!1;return!0},reformatTable:function(e){if(this.editor.undo.completeSnap(!0),(e=e||editor.getMarkElem(window.getSelection().anchorNode).closest("[mdtype='table']")).length){var t=this.editor.getNode(e.attr("cid")),n=editor.undo.UndoManager.makeEmptyCommand(this.editor.selection.buildUndo());n.undo.push(M.buildReplaceUndo(t)),t.set("userText",void 0),t.set("style",void 0),t.set("alignText",void 0);for(var i=t.getFirstChild();i;){for(var r=i.getFirstChild();r;)r.set("marginRight",void 0),r.set("marginLeft",void 0),r=r.get("after");i=i.get("after")}n.redo.push(M.buildReplaceUndo(t)),n.redo.push(this.editor.selection.buildUndo()),this.editor.undo.register(n)}}});function R(){E("#typora-table-row-tracker, #typora-table-col-tracker").hide().find(".typora-table-data-area").html("")}I.deleteRow=function(e){E(".md-tooltip-hide").hide();var t,n,i,r,o,a=e.getMarkElem(window.getSelection().anchorNode).closest("td"),s=e.getMarkElem(window.getSelection().anchorNode).closest("tr[mdtype='table_row']"),l=s.prevAll().length;if(s.siblings().length){for(n=e.findNodeByElem(s).get("parent"),e.undo.completeSnap(!0),(t=e.undo.UndoManager.makeEmptyCommand()).undo.push(e.selection.buildUndo()),t.undo.push(e.undo.UndoManager.buildReplaceUndo(n)),_.tryResetTable(n),r=n.getNthChild(1),i=l;i;)r=r.get("after"),i--;r.remove(),t.redo.push(e.undo.UndoManager.buildReplaceUndo(n)),e.findElemById(n.id).replaceWith(n.toHTML()),l?l--:l++,o=document.createRange();try{o.setStart(e.findElemById(n.id).find("tbody>tr:nth-child("+(l+1)+")>td:nth-child("+(a.prevAll().length+1)+")>span")[0],0),window.getSelection().removeAllRanges(),window.getSelection().addRange(o),t.redo.push(e.selection.buildUndo())}catch(e){}e.undo.register(t),e.tableEdit.showTableEdit(n)}},I.addRow=function(e,t,n){E(".md-tooltip-hide").hide();var i,r,o=e.getMarkElem(window.getSelection().anchorNode).closest("tr[mdtype='table_row']"),a=(e.getMarkElem(window.getSelection().anchorNode).closest("td, th").prevAll().length,"TBODY"==o.parent()[0].tagName),s=a?o.prevAll().length+1:0,l=e.undo.UndoManager.makeEmptyCommand();if(!t||a){i=e.findNodeByElem(o).get("parent"),e.undo.completeSnap(!0),l.undo.push(e.selection.buildUndo()),l.undo.push(e.undo.UndoManager.buildReplaceUndo(i)),_.tryResetTable(i),r=i.getNthChild(s),r=I.newEmptyRowAfter(t?r.get("before"):r,r.get("children").length,i),a?o[t?"before":"after"](r.toHTML()):e.findElemById(i.id).replaceWith(i.toHTML());var c=e.findElemById(r.getFirstChild().id);e.selection.jumpIntoElemBegin(c),e.selection.scrollAdjust(),l.redo.push(e.undo.UndoManager.buildReplaceUndo(i)),l.redo.push(e.selection.buildUndo()),!n&&e.undo.register(l),e.tableEdit.showTableEdit(i)}return l},I.addCol=function(e,n){E(".md-tooltip-hide").hide();var t,i,r=e.getMarkElem(window.getSelection().anchorNode).closest("td, th"),o=r.find("[cid]").attr("cid"),a=r.prevAll().length;if(i=e.findNodeByElem(r.children("[cid]")).get("parent").get("parent"),e.undo.completeSnap(!0),(t=e.undo.UndoManager.makeEmptyCommand()).undo.push(e.selection.buildUndo()),t.undo.push(e.undo.UndoManager.buildReplaceUndo(i)),_.tryResetTable(i),i.get("children").toArray().map(function(e){var t=e.getNthChild(a);t.insert(new _({type:_.TYPE.table_cell,text:"",marginLeft:t.get("marginLeft"),marginRight:t.get("marginRight")}),n)}),i.get("align").splice(n?a:a+1,0,null),i.get("alignText")){var s=_.adjustAlignText(i,0,null);i.get("align").splice(n?a:a+1,0,s)}e.findElemById(i.id).replaceWith(i.toHTML()),r=e.findElemById(o).closest("th, td"),e.selection.jumpIntoElemBegin(n?r.prev():r.next()),t.redo.push(e.undo.UndoManager.buildReplaceUndo(i)),e.undo.register(t),e.tableEdit.showTableEdit(i)},I.deleteCol=function(e){E(".md-tooltip-hide").hide();var t,n,i=e.getMarkElem(window.getSelection().anchorNode).closest("td, th"),r=i.prevAll().length,o=i.nextAll().length,a=i.closest("tr"),s="TBODY"==a.parent()[0].tagName?a.prevAll().length+1:0;if(r||o){n=e.findNodeByElem(i.children("[cid]")).get("parent").get("parent"),e.undo.completeSnap(!0),(t=e.undo.UndoManager.makeEmptyCommand()).undo.push(e.selection.buildUndo()),t.undo.push(e.undo.UndoManager.buildReplaceUndo(n)),_.tryResetTable(n),n.get("children").toArray().map(function(e){e.getNthChild(r).remove()}),n.get("align").splice(r,1),n.get("alignText")&&n.get("alignText").splice(r,1),e.findElemById(n.id).replaceWith(n.toHTML());var l=document.createRange();try{s?l.setStart(e.findElemById(n.id).find("tbody>tr:nth-child("+s+")>td:nth-child("+(r+1)+")>span")[0],0):l.setStart(e.findElemById(n.id).find("thead>tr[mdtype]>th:nth-child("+(r+1)+")>span")[0],0),window.getSelection().removeAllRanges(),window.getSelection().addRange(l),t.redo.push(e.selection.buildUndo())}catch(e){}t.redo.push(e.undo.UndoManager.buildReplaceUndo(n)),e.undo.register(t),e.tableEdit.showTableEdit(n)}},I.getSibling=function(e,t,n){if(_.isType(e,_.TYPE.table_cell)){t=t||"after";var i=e.get(t),r=e.get("parent").get(t);return i||!r||n||(i="after"==t?r.getFirstChild():r.getLastChild()),i}},I.getColumnIndex=function(e,t){return t=t||0,t++,(e?I.getColumnIndex(e.get("before"),t):t)-2},I.getCellAt=function(e,t){if(_.isType(e,_.TYPE.table_row)){for(var n=e.getFirstChild();0<t;)t--,n=n.get("after");return n}},I.getNextCellInColumn=function(e,t,n){if(_.isType(e,_.TYPE.table_cell)){n=n||I.getColumnIndex(e),t=t||"after";var i=e.get("parent").get(t);return i?I.getCellAt(i,n):void 0}},I.resizeRow=function(e,t){var n,i=e.getFirstChild(),r=0,o=e.get("before"),a=o?o.getFirstChild():null,s=e.get("parent");function l(e){return 1<e.length?e[0]:e}_.tryResetTable(s);for(var c=Math.max(t,e.get("children").length);r<c;)r<t?(i||(i=new _({type:_.TYPE.table_cell,in:e.get("in"),parent:e,before:n}),a&&void 0!==a.get("marginLeft")?(i.set("marginLeft",l(a.get("marginLeft"))),i.set("marginRight",l(a.get("marginRight")))):!o&&n&&void 0!==n.get("marginLeft")&&(i.set("marginLeft",l(n.get("marginLeft"))),i.set("marginRight",l(n.get("marginRight")))),s.get("alignText")&&!s.get("alignText")[r]&&(s.get("alignText")[r]=_.adjustAlignText(s,0,null))),i=(n=i).get("after")):i&&(i=(n=i).get("after"),n.delete()),r++,a&&(a=a.get("after"))},I.newEmptyRowAfter=function(e,t,n){var i=new _({type:_.TYPE.table_row,in:n.get("in"),parent:n,before:e,after:e?e.get("after"):null});return I.resizeRow(i,t),i},I.valify=function(e,n,t,i){var r;if(t=t||2,void 0===n&&(n=(n=e.get("children").at(0))?n.get("children").length:1),i&&1==e.get("children").length&&1==n)i(e,e.get("children").at(0).get("children").at(0).get("text"));else{e.get("children").map(function(e){for(var t=e.get("children").length;t<n;t++)t===e.get("children").length&&(r=e.getLastChild()),r=new _({type:_.TYPE.table_cell,parent:e,in:e.get("in"),before:r,text:""})});for(var o=e.get("children").length;o<t;o++)I.newEmptyRowAfter(e.get("children").at(o-1),n,e);e.get("align")||e.set("align",new Array(n-0))}},_.TableEdit=I,n.exports=I}),define("app/editor/ImageEdit",["jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","app/editor/UserOp","app/editor/UndoManager","rangy/rangy-core","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileHelper","app/editor/Emoji","app/editor/TableEdit","app/editor/polyfill","app/editor/ConvertUtils","app/editor/DeleteOp","app/editor/Stylize","app/window/MenuHelper","app/editor/PairOp","app/editor/IndentOp","app/editor/ClipboardOp","app/editor/Inline","app/editor/Selection","codemirror/lib/codemirror","app/editor/UndoManager","app/editor/EditHelper"],function(e,t,n){"use strict";var g=e("jquery/jquery"),i=e("exoskeleton-master/exoskeleton"),a=e("app/document/Node"),p=a.Node,f=a.TYPE,m=e("app/editor/UserOp"),c=e("app/editor/Inline"),r=e("app/editor/Selection").rangy,v=e("app/editor/UndoManager"),o=e("app/editor/EditHelper"),d=e("app/document/StringUtils"),u=(c=e("app/editor/Inline"),e("app/window/FileHelper")),y=window.reqnode?reqnode("electron").remote:null,s=null,l={},h=null,b="typora-copy-images-to",w="http://support.typora.io/Images/";function x(e,t,n){if(n&&e&&t){var i=n.clientHeight,r=n.clientWidth;i&&r&&(imagePreLoadAfterMove["file://"+e.replace(/^file:\/\//,"").replace(/\\/g,"/")]={src:t,size:"height:"+i+"px;width:"+r+"px;"})}}function C(e,t){return e.replace(/(\(<?)((?:\([^)]*\)|[^()])*?)(>?[ \t]*((['"])(.*?)\5[ \t]*)?\))/,"$1"+t+"$3")}function k(e,t){return e.replace(/(src=(["'])).+?(\2)/i,"$1"+t+"$3")}function S(e){var t,n=g("[data-origin-path="+JSON.stringify(e)+"]");return n.length,uploadImageQueue.delete(e),moveImageQueue.delete(e),(t=n).removeClass("md-on-uploading").removeClass("md-on-moving"),t.find(".md-image-uploading-mask-wrapper").remove(),t.removeAttr("data-origin-path"),n}window.imgLastModified=Math.floor((new Date-0)/1e3),window.uploadImageQueue=new Set,window.moveImageQueue=new Set,window.imagePreLoadAfterMove={};var T={};function F(e,t,n,a){var i=c.applyUploadingStyle;if(e.length){var r=e.find("img")[0];loadedImgCache.remove(r.getAttribute("src")||""),r.onload=null}return this.editor.brush.clearAndPause(!0),window.moveImageQueue.add(n),i(e,n,!0,!0),this.editor.brush.resume(),File.isMac?function(e,n,i){return i=i.replace(/^file:\/\//,""),new Promise(function(e,t){app.ipic.copyImage(i,n,e,t,a||!1)})}.call(this,e,t,n):function(e,t,o){return new Promise(function(p,h){var f=reqnode("fs-extra"),i=null;function r(e,t,n){var i,r,o,a,s,l,c,d,u;/^(http(s?))|(ftp):\/\//.exec(e)?(i=e,r=t,o=p,a=h,s=n,l=y.getCurrentWindow(),c=reqnode("fs-extra"),d=reqnode("path").dirname(r),u=function(e,t){"completed"===e?(s&&t!=r?c.renameSync(t,r):r=t,o(r)):a(e?"Image download "+e:"")},T[i]?T[i].callbacks.push(u):T[i]={dest:r,callbacks:[u]},y.app.download(l.webContents.id,i,d),setTimeout(function(){T[i]&&(T[i].callbacks.remove(u),T[i].callbacks.length||delete T[i]),a("Download timeout.")},3e4)):f.copy(e,t,{overwrite:n},function(e){if(e)return h("Failed to copy image\n."+e.message);p(t)})}if(a)r(o,i=t,!0);else{var e=u.getFileNameFromPath(o);e=d.removeInvalidPathCh(e.replace(/\?([^.\/]*)$/,"")),t=(t+"/").replace(/[\/\\]{2}$/,"/"),i=t+e,f.access(i,f.R_OK,function(e){var t,n;e||(t=i,n=reqnode("path"),i=t.replace(/(\.[^.\/\\]+?$)/,"")+"-"+(new Date-0)+n.extname(t)),r(o,i,!1)})}})}.call(this,e,t,n)}function E(e,t,n){if(t=this.resolveImagePath(t),!e[0])return this.editor.selection.buildUndo();var i=this.editor,r=i.selection.getRangy(),o=e[0].querySelector(".md-content").textContent,a=e.attr("md-inline")==f.imgtag?k(o,t):C(o,t),s=i.selection.buildUndo(r),l=v.makeEmptyCommand(s),c=g.extend({},s),d=a.length-o.length,u=i.findNodeByElem(e.closest("[cid]"));i.undo.completeSnap(!0);var p=e.find(".md-content")[0];r&&p&&r.comparePoint&&r.comparePoint(p,1)<0&&(c.start+=d),r&&p&&r.comparePoint&&r.comparePoint(p,2)<0&&(c.end+=d),l.undo.push(v.buildReplaceUndo(u)),e.find(".md-content").text(a),i.store(u,!0);var h=i.findElemById(u.cid);return i.brush.brushNode(u.cid),h.removeClass("md-expand"),i.undo.exeCommand(c),l.redo.push(v.buildReplaceUndo(u)),l.redo.push(c),i.undo.register(l),c}function _(t,e,n,i){var r=this;t&&t.length&&F.call(this,t,e,n,i).then(function(e){t=S(n),x(e,n,t.find("img")[0]),E.call(r,t,e)},function(e){t=S(n),console.error(e),e&&setTimeout(function(){g("#md-notification").html("<p style='padding-right: 100px;'>"+g.localize.getString("Failed to Copy Image to Target Folder.")+" <code>"+d.escape(e)+"</code><span class='btn-default btn-xs btn ok-btn' style='right: 40px;position: absolute;bottom: 8px;'>"+g.localize.getString("Close")+"</span></p>").show()},500)})}window.onImageDownloaded=function(e,t,n){var i=T[e];i&&(i.callbacks.map(function(e){e(t,n)}),delete T[e])};var M=i.Model.extend({initialize:function(i){var n=this;this.editor=i,g(i.sessionStr).on("mousemove",".md-image>.md-meta",function(){event.offsetX-event.target.offsetLeft<20&&event.offsetY<30?0<(this.nextElementSibling.getAttribute("src")||"").trim().length&&this.classList.add("md-show-hint"):this.classList.remove("md-show-hint")}).on("mouseleave",".md-image>.md-meta",function(){this.classList.remove("md-show-hint")}).on("click","img",function(e){var t=g(e.target).closest(".md-image").addClass("md-expand"),n=r.createRange();n.moveToBookmark({containerNode:t.children(".md-meta")[0],start:2,end:2+(e.target.getAttribute("alt")||"").length}),i.selection.setRange(n,!0)}).on("btn-action",".md-image-input-src-btn",function(e){g("#ty-tooltip").hide();var t=document.createRange();t.setStart(this.parentElement,0),t.setEnd(this.parentElement,0),g(this).remove(),i.selection.setRange(t,!0)}).on("click btn-action",".md-image-pick-file-btn",function(e){return g("#ty-tooltip").hide(),File.isMac?app.controller.insertLocalImage():File.isNode&&n.insertImagesFromLocalFile(),!1}).on("cursorChange",function(e,t){t&&-1!=t.style.inline.indexOf("image")||!document.querySelector("#user-context-menu.show")||i.contextMenu.hide("#user-context-menu")}),g(".context-menu").on("click","[data-key='select-img-target'] a",function(){File.editor.contextMenu.hide(),n.copyToSelectedFolderAction()}).on("click","[data-key='upload-img'] a",function(){File.editor.contextMenu.hide(),n.uploadAction()}).on("click","[data-key='move-img-to-target'] a",function(){File.editor.contextMenu.hide(),n.copyToTargetFolderAction()}).on("click","[data-key='reveal-img-in-finder'] a",function(){if(File.editor.contextMenu.hide(),File.isNode){var e=g(".md-expand.md-img-loaded");if(!e)return;var t=n.getAbsolutePath(e.attr("data-src"));y.shell.showItemInFolder(t)}})},getLocalRootUrlForInsert:function(){return this.editor.docMenu.getLocalRootUrl()||File.option.useRelativePathForImg&&u.getCurrentFileFolderPath()||""},getAbsolutePath:function(e){var t=this.getRealSrc(e).replace(/^file:\/\//,"");return File.isWin&&(t=t.replace(/^[\/\\]+/,"")),t},getRealSrc:function(e){if(!e)return e;if(/^data:/.exec(e))return e;function t(e,t){return"file://"+u.normalizePath(e.replace(/^file:\/\//,"").replace(/\/$/,"")+"/"+t.replace(/^\//gi,""))}try{if(/^(file|ftp|https?):(\/\/|\\\\)/gi.exec(e))return e;if(File.isNode){var n=reqnode("path"),i=this.editor.docMenu.getLocalRootUrl();return File.isWin||!/^\//.exec(e)||i?"file://"+n.resolve(this.editor.docMenu.getLocalRootUrl()||u.getCurrentFileFolderPath()||"",e.replace(/^\s*(\\\\|\/)/,"")):"file://"+e}return/^(\/)|(\/\/)|(\\\\)|([a-z]+\:\\\\)/gi.exec(e)?t(this.editor.docMenu.getLocalRootUrl()||"",e||""):t(u.getCurrentFileFolderPath()||"",e||"")}catch(e){}return e},updateImgRef:function(e){var t=this.editor.brush.inline;g("[data-ref='"+d.escape(e)+"']").each(function(){var e=(this.querySelector(".md-content")||{}).textContent;void 0!==e&&g(this).replaceWith(t.output(e))})},willUpdateImgRef:function(e){e&&(h&&clearTimeout(h),l[e]=!0,s=s||new Date,200<new Date-s?setTimeout(function(){Object.keys(l).map(this.updateImgRef,this)}.bind(this),10):h=setTimeout(function(){Object.keys(l).map(this.updateImgRef,this)}.bind(this),300))},refreshLocalImg:function(){var i=Math.floor((new Date-0)/1e3);g(".md-image img").each(function(){var e=this.getAttribute("src");if(/^file:/i.exec(e)){var t=e.replace(/\?lastModify=\d+$/,""),n=t+"?lastModify="+imgLastModified;failImgCache.remove(n),loadedImgCache.remove(n),this.setAttribute("src",t+"?lastModify="+i),this.dataset.localRefresh=!0,this.onload=onImageLoadedFunc,this.onError=onImageErrorFunc}}),imgLastModified=i},updateLocalRootUrl:function(){var e=this.editor.docMenu.getLocalRootUrl()||"";if(this.editor.localRootUrl!=e)for(var t=document.querySelectorAll("[md-inline='image']"),n=0;n<t.length;n++){var i=t[n],r=i.querySelector("img");if(i.getAttribute("data-src")!=r.getAttribute("src")){var o=g.parseHTML(c.decorate({type:a.TYPE.image,markdown:i.textContent,alt:r.getAttribute("alt"),href:i.getAttribute("data-src")}))[0];i.parentElement.replaceChild(o,i)}}},selectComponent:function(e){var t=this.editor.selection.getRangy(),n=g(t.startContainer).closest("[md-inline='image']"),i=n.text(),r=t.getBookmark(n[0]),o=i.indexOf("]"),a=v.makeEmptyCommand(this.editor.selection.buildUndo());e?(r.start=o+2,r.end=i.length-1):(r.start=2,r.end=o),t.moveToBookmark(r),this.editor.selection.setRange(t,!0),a.redo.push(this.editor.selection.buildUndo()),this.editor.undo.register(a)},buildImageMapToUpload:function(){A={};for(var e,t,n=document.querySelectorAll(".md-image.md-img-loaded"),i=n.length,r=0;r<i;r++)N(t=(e=n[r]).querySelector("img").getAttribute("src")||"")&&(t=t.replace(/\?[^.\\\/]*$/,""),A[t]=A[t]||[],A[t].push(e));return Object.keys(A)},replaceImageMap:function(e,t){var n=JSON.parse(e),c=v.makeEmptyCommand(this.editor.selection.buildUndo()),d=this.editor,u=new Set;if(Object.keys(n).forEach(function(e){if(A[e]){var l=n[e];A[e].forEach(function(e){e.querySelector("img").src=l,e.hasAttribute("data-src")&&e.setAttribute("data-src",l);var t,n,i=d.findNodeByElem(g(e).closest("[cid]")),r=e.getAttribute("md-inline");if(!u.has(i)&&p.isType(r,f.image,f.imgtag)&&(u.add(i),c.undo.push(v.buildReplaceUndo(i))),t=e.querySelector(".md-content").textContent,r==f.image)n=C(t,l),e.querySelector(".md-content").textContent=n;else if(r==f.imgtag)n=k(t,l),e.querySelector(".md-content").textContent=n;else if(r==f.refimg){var o=/^!\[((?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*)\]\s*\[([^\]]*)\]/.exec(t),a=(o[2]||o[1]).replace(/\s+/g," "),s=d.nodeMap.link_list.getNodeByRef(a);if(u.has(s))return;u.add(s),c.undo.push(v.buildReplaceUndo(s)),s.set("href",l),d.findElemById(s.cid).replaceWith(s.toHTML())}})}}),u.forEach(function(e){e.get("type")!==f.def_link&&d.store(e,!0),c.redo.push(v.buildReplaceUndo(e))}),c.redo.push(d.selection.buildUndo()),d.undo.register(c),t){var i=Object.keys(n).length;o.showNotification(g.localize.getString("Successfully uploaded {0} images.").format(i)+"<span class='btn-default btn-xs btn undo-btn' style='right: 40px;position: absolute;'>"+g.localize.getString("Undo")+"</span>")}},insertImagesFromLocalFile:function(){if(!File.isLocked){var e=reqnode("electron").remote,t=e.getCurrentWindow(),n=(e.app,e.dialog),i=this.editor;n.showOpenDialog(t,{filters:[{name:"Images",extensions:["png","jpg","jpng","bmp","svg","tiff","webp","gif"]}],properties:["openFile","multiSelections"],buttonLabel:"Select"},function(e){e&&0!=e.length&&i.imgEdit.doInsertFromURLs(e)})}},shouldTriggerMove:function(e,t){if(void 0===t&&(t=this.getTagetImageStorageFolder()),!e)return!1;if(/^\s*(https?|ftp):\/\//.exec(e))return File.option.applyImageMoveForWeb;if(File.option.applyImageMoveForLocal){var n=this.getAbsolutePath(e);if(0!=n.indexOf(t)||n.substring(t.length+1).match(/[\\\/]/g))return!0}return!1},tryMoveImageDom:function(e,t){if(t){var n=e.attr("data-src");if(this.shouldTriggerMove(n,t))if(File.isMac&&"ipic"==t)this.uploadAction(e,!0);else{var i=this.getAbsolutePath(n);_.call(this,e,t,i)}}},prepImageMove:function(c,d){var u=this;return new Promise(function(t,n){if(d)return t();function i(e){e&&alert(e.message||e),n()}if(File.isMac){if(void 0===c&&(c=u.getTagetImageStorageFolder()),"ipic"==c)return t();var e=app.ipic.prepImageMove(c);"success"!=e?i(e):t()}else{var r=reqnode("fs-extra"),o=!1;u.getTagetImageStorageFolder(!0)&&(o=!0),void 0===c&&(c=u.getTagetImageStorageFolder()),(a=c,s=o,l=reqnode("fs-extra"),new Promise(function(n,i){if(!s)return n();l.stat(a,function(e){if(!e)return n();if("ENOENT"!=e.code)return i(e.message);var t=g("#image-create-folder-confirm").find("#image-create-folder-target").text(a).end().modal({backdrop:"static",keyboard:!1});File.isLocked=!0,t.off("mousedown",".image-create-folder-dialog-yes, .image-create-folder-dialog-no, .image-create-folder-dialog-help, .close").one("mousedown",".image-create-folder-dialog-yes",function(){t.modal("hide"),File.isLocked=!1,File.freshMenu(),n()}).one("mousedown",".image-create-folder-dialog-no",function(){t.modal("hide"),File.isLocked=!1,File.freshMenu(),i(!1)}).one("mousedown",".close",function(){t.modal("hide"),File.isLocked=!1,File.freshMenu(),i(!1)}).on("mousedown",".image-create-folder-dialog-help",function(){y.shell.openExternal(w)})})})).then(function(){r.ensureDir(c,function(e){e?i(e):t()})},i)}var a,s,l})},tryMoveImageInRange:function(e){var t=this.editor,n=this.getTagetImageStorageFolder();if(n){this.editor.brush.clearAndPause();var i=e.getNodes([document.ELEMENT_NODE],function(e){return"image"==e.getAttribute("md-inline")});i.length&&this.prepImageMove(n).then(function(){i.forEach(function(e){t.imgEdit.tryMoveImageDom(g(e),n)})}),this.editor.brush.resume()}},doInsertFromURL:function(r,e){c.applyUploadingStyle;var o=r;function h(){return(u.getFileNameFromPath(r)||"").replace(/(^\.)|(\.[^.]+$)/g,"")}function f(){var e=window.getSelection(),t="";return!File.editor.sourceView.inSourceMode&&0<e.startOffset&&(t=" "),t}function t(e){var t=this.editor,n=t.getMarkElem();if(!n.length||!t.stylize.canContainInline(n))return!1;m.backspaceHandler(t,null,"delSelection");var i,r=h(),o=f(),a=t.getNode(n.attr("cid")),s=this.resolveImagePath(e),l=o+"!["+r+"]("+s+")",c=t.selection.getRangy();if(!c)return null;if((i=g(c.startContainer).closest("[md-inline='image']")).length)return window.moveImageQueue.add(e),E.call(this,i,e),i.attr("data-src",s),this.selectComponent(!0),i;var d=c.getBookmark(n[0]).start,u=(a.cid,t.selection.prepNode("​",null,!0)||v.makeEmptyCommand());u.undo.push(t.selection.buildUndo()),m.insertInlineText(t,a,l,d,u,!0);var p=t.findElemById(a.cid);return t.brush.brushNode(a.cid),p.removeClass("md-expand"),c.moveToBookmark({containerNode:p[0],start:d+l.length,end:d+l.length}),(i=g(c.startContainer).closest(".md-image")).find("img").attr("src","file://"+e),t.undo.register(u),window.getSelection(),i}if((r=this.resolveImagePath(r))&&/\.(png|jpg|jpeg|svg|gif|bmp|webp|tiff)$/gi.exec(r)){var n,i=o,a=this,s=this.editor,l=this.getTagetImageStorageFolder();if(this.shouldTriggerMove(r,l)&&l)if(this.editor.undo.completeSnap(!0),File.isMac&&"ipic"==l){if(app.ipic.validateBeforeUpload())return this.editor.brush.clearAndPause(),n=t.call(this,i),a.uploadAction(n),void this.editor.brush.resume()}else if(l&&!e)return i=u.normalizePath(i),this.editor.brush.clearAndPause(),n=t.call(this,i),a.prepImageMove(l,File.isMac).then(function(){_.call(a,n,l,i)}),void this.editor.brush.resume();(function(){var e,t=h(),n=f(),i=s.selection.getRangy();i&&(e=g(i.startContainer).closest("[md-inline='image']")).length&&!function(e){if(e.startContainer.parentElement.classList.contains("md-image-after-src")&&e.startContainer.textContent.length==e.startOffset)return!0}(i)?(E.call(this,e,o,!0),this.selectComponent(!0)):m.pasteHandler(this.editor,n+"!["+t+"]("+r+")",!0,!0)}).call(this)}},doInsertFromURLs:function(e){var n=this.editor;e.forEach(function(e,t){0<t&&n.UserOp.insertParagraph(!1,n),n.imgEdit.doInsertFromURL(e)})},resolveImagePath:function(e){if(/^[^:]+:\/\//.exec(e))return e;var t=this.getLocalRootUrlForInsert(),n=u.getCurrentFileFolderPath();if(t&&t.length){var i=d.getRelativePath(t,e);t==n&&(i=i.replace(/^\s*(\\\\|\/)/,"")),e=(!i.match(/^\.[\/\\]/)&&this.editor.docMenu.getLocalRootUrl()?"/":"")+i}else{if(!File.option.useRelativePathForImg||!n||0!==e.indexOf(n))return e;e=e.substring(n.length).replace(/^\//,"").replace(/\\/,"/")}return File.isWin&&(e=e.replace(/[\/\\]{1,2}/g,"/")),e},getTagetImageStorageFolder:function(e){var t=this.editor.docMenu.getValueInMeta(b);if(t&&!File.editor.sourceView.inSourceMode){if(File.option.allowImageUpload&&"ipic"==t.toLowerCase())return"ipic";var n=u.getCurrentFileFolderPath();if(n)return/[\\\/]$/.exec(n[n.length-1])||(n+="/"),u.normalizePath(n+t,!0)}return e?null:this.getTagetImageStorageFolderFromSetting()},getTagetImageStorageFolderFromSetting:function(){if("ipic"==File.option.defaultImageStorage)return"ipic";var e=u.getCurrentFileFolderPath();if(e){if(/[\\\/]$/.exec(e[e.length-1])||(e+="/"),"folder"==File.option.defaultImageStorage)return u.normalizePath(e.replace(/[\\\/]$/,""),!0);if("assert"==File.option.defaultImageStorage)return u.normalizePath(e+"assets",!0);if("per-file-assert"==File.option.defaultImageStorage)return this.preFileImageStorage||(this.preFileImageStorage=u.normalizePath(e+File.getFileName().replace(/\.[^.\/\\]+$/,"")+".assets",!0)),this.preFileImageStorage}return null},onFileMoved:function(){if("per-file-assert"!=!File.option.defaultImageStorage){this.getTagetImageStorageFolder();this.preFileImageStorage=void 0}},moveImageTo_:function(e,t,n,i){_.call(this,e,t,n,i)},copyToSelectedFolderAction:function(){var n=g(".md-expand.md-img-loaded");if(n){var i=this,r=i.getRealSrc(n.attr("data-src"));/^file:\/\//.exec(r)&&(r=r.replace(/^file:\/\//,"").replace(/[?#]([^.\/\\]*)$/,""));var e=u.getFileNameFromPath(r);File.isMac?app.ipic.selectImageSavePath(e,r,function(e,t){e&&i.moveImageTo_(n,e,r,!0)}):y.dialog.showSaveDialog({title:"Copy and update image srouce to..",defaultPath:e},function(e){e&&i.moveImageTo_(n,e,r,!0)})}},copyToTargetFolderAction:function(){this.editor.brush.clearAndPause();var e=g(".md-expand.md-img-loaded");if(e){var t=this.getAbsolutePath(e.attr("data-src")),n=this.getTagetImageStorageFolder(),i=this;this.prepImageMove(n,File.isMac).then(function(){i.moveImageTo_(e,n,t)}),this.editor.brush.resume()}},uploadAction:function(t,n){if(t=t||g(".md-expand.md-img-loaded")){var i=this;if(File.isMac&&app.ipic.validateBeforeUpload()){var r=this.getRealSrc(t.attr("data-src")).replace(/^file:\/\//,"");(function(e,n){return this.editor.brush.pause(),window.uploadImageQueue.add(n.replace(/^file:\/\//,"")),c.applyUploadingStyle(e,n,!1),n=n.replace(/^file:\/\//,""),File.isWin&&(n=n.replace(/^[\/\\]+/,"")),this.editor.brush.resume(),new Promise(function(e,t){app.ipic.upload(n,e,t)})}).call(i,t,r).then(function(e){n||x(e,r,t),t=S(r),E.call(i,t,e)},function(e){t=S(r),E.call(i,t,r),e&&setTimeout(function(){g("#md-notification").html("<p style='padding-right: 100px;'>"+g.localize.getString("Failed to upload image. Error Message:")+" <code>"+d.escape(e)+"</code><span class='btn-default btn-xs btn ok-btn' style='right: 40px;position: absolute;bottom: 8px;'>"+g.localize.getString("Close")+"</span></p>").show()},500)})}}},contextMenuItems:function(e){var t=(e.getAttribute("src")||"").replace(/\?(.+)$/,""),n=[],i=this.getTagetImageStorageFolder();i&&"ipic"!=i&&(i=i.replace(/[\\\/]$/,"")+(File.isWin?"\\":"/"));var r=d.escapeURL(i);if(i&&"ipic"!=i&&(0!=t.replace(/^file:\/\//,"").indexOf(r)||t.replace(/^file:\/\//,"").substring(r.length+1).match(/[\\\/]/g))){var o=d.getFolder(i);o&&n.push("copyImgToTarget-"+o.replace(/\|/g,""))}return n.push("copyImgToSelect"),File.isMac&&app.ipic.quickValidate()&&("ipic"==i?n.unshift("uploadImg"):n.push("uploadImg")),/^file:\/\//.exec(t)&&n.unshift("revealInFinder"),n},afterUserInsertImage:function(e){var t=(e.getAttribute("src")||"").replace(/\?(.+)$/,"");if(t!=this.lastUrl&&e.parentElement&&e.parentElement.contains(window.getSelection().anchorNode)){var n=[],i=this.editor,r=this.getTagetImageStorageFolder();if(r&&"ipic"!=r){r=r.replace(/[\\\/]$/,"")+(File.isWin?"\\":"/"),t=t.replace(/^file:\/\//,""),File.isWin&&(t=t.replace(/^[\/\\]+/,""));var o=d.escapeURL(r);if(0!=t.replace(/[\\]/g,"/").indexOf(o)||t.substring(o.length+1).match(/[\\\/]/g)){var a=d.getFolder(r);a&&n.push({label:"Copy to %@",key:"move-img-to-target",variable:a})}else this.lastUrl=t}if(n.push({label:"Copy Image to...",key:"select-img-target"}),File.isMac&&app.ipic.quickValidate()&&("ipic"==r?n.unshift({label:"Upload via iPic",key:"upload-img"}):n.push({label:"Upload via iPic",key:"upload-img"})),n.length){var s=i.selection.getRangy(),l=g(s.endContainer).closest("[md-inline='image']");s&&l.length&&!l.hasClass("md-on-moving")&&!l.hasClass("md-on-uploading")&&i.contextMenu.showCustom(n,"image")}}},toggleCopyToFolder:function(){var e=reqnode("electron").remote,t=e.getCurrentWindow(),n=e.dialog,i=this,r=this.getTagetImageStorageFolder(!0),o=u.getCurrentFileFolderPath();if(File.refreshImageCopyStatus(!0),!File.isLocked&&!File.editor.sourceView.inSourceMode)if(r)this.doRemoveImageCopyToFolder(!1);else{if(!o)return void n.showMessageBox(t,{title:g.localize.getString("Document must be saved first.","Panel"),message:g.localize.getString("Typora will copy newly inserted image to folder by selected relative path, so please save the file first.","Panel"),buttons:[g.localize.getString("OK")]});n.showOpenDialog(t,{defaultPath:u.getCurrentFileFolderPath(),title:g.localize.getString("Select Container Folder"),properties:["openDirectory","createDirectory"],buttonLabel:g.localize.getString("Select")},function(e){e&&0!=e.length&&i.doSetImageCopyToFolder(e[0])})}},toggleUseImageRootPath:function(){var e=reqnode("electron").remote,t=e.getCurrentWindow(),n=e.dialog,i=this.editor.docMenu.getLocalRootUrl(),r=this.editor;i?this.editor.docMenu.removeProperty("typora-root-url"):n.showOpenDialog(t,{defaultPath:u.getCurrentFileFolderPath(),title:g.localize.getString("Select Container Folder"),properties:["openDirectory","createDirectory"],buttonLabel:g.localize.getString("Select")},function(e){e&&0!=e.length&&r.imgEdit.doSetImageRootPath(e[0])})},doSetImageCopyToFolder:function(e,t){e=t&&File.isMac?"ipic":d.getRelativePath(u.getCurrentFileFolderPath(),e,!0),this.editor.docMenu.writeProperty(b,e)},doSetImageRootPath:function(e){this.editor.docMenu.writeProperty("typora-root-url",d.getRelativePath(u.getCurrentFileFolderPath(),e,!0)),this.refreshLocalImg()},doRemoveImageCopyToFolder:function(e){return this.editor.docMenu.removeProperty(b,e)}});function N(e){return!!/^\s*(file|data):/.exec(e)}var A={};n.exports=M}),define("app/editor/UserOp",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileHelper","app/editor/UndoManager","app/editor/Emoji","app/editor/TableEdit","app/editor/polyfill","app/editor/ConvertUtils","app/editor/TableEdit","app/editor/DeleteOp","app/editor/ConvertUtils","app/editor/Stylize","app/window/MenuHelper","app/editor/PairOp","app/editor/IndentOp","app/editor/ClipboardOp"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton"),e("app/document/StringUtils");var i=e("app/document/Node"),p=e("app/editor/UndoManager"),h=(p.SnapFlag,i.Node),f=i.TYPE,g=(i.NodeCollectionUtils,e("rangy/rangy-core.js"),e("app/document/MarkParser")),r=(e("app/editor/TableEdit"),e("app/editor/ConvertUtils"),e("app/editor/DeleteOp")),o=e("app/editor/IndentOp"),a=e("app/editor/PairOp"),s=e("app/editor/ClipboardOp"),l=function(e,t,n,i){var r,o=e;if(e==t)return null;for(r=e.get(n);r;)i(r,o),r=(o=r).get(n);return l(e.get("parent"),t,n,i),o};t.getDisplayText=function(e){var t=e.clone();return t.find(".md-meta, .md-content").remove(),t.text().replace(/\u00A0/g," ")},t.decorateOneSide=l,t.simpleExpand=function(e,t){if(File.isLocked)return!1;var n,i,r,o=e.getNode(t),a=e.selection.buildUndo();if(!h.isType(o,f.heading,f.def_footnote,f.def_link)||a.startId&&a.startId!=a.endId)return!1;if((n=o.toMark().trim()).match(/\n/))return!1;var s=p.makeEmptyCommand(e.lastCursor),l=new h({type:f.line,text:n});if(!s.undo.length||!s.undo[0].id&&s.undo[0].startId!=s.undo[0].endId)return!1;if(s.undo.push(p.buildReplaceUndo(o)),h.isType(o,f.heading)&&(i=o.get("pattern")&&o.get("pattern").replace("{0}","").length||o.get("depth")+1),h.isType(o,f.def_link,f.def_footnote)){var c,d=e.selection.getRangy(),u=e.getJQueryElem(d.startContainer);c=u.closest(".md-def-content"),i=h.isType(o,f.def_link)?1:2,c.length&&(i+=3),(c=u.closest(".md-def-title")).length&&u.text().length&&(i+=5)}return o.unset("text"),o.set("type",f.paragraph),o.append(l),s.redo.push(p.buildReplaceUndo(o)),(a=e.selection.buildUndo()).start+=i,a.end+=i,a.id=l.cid,a.startId=a.endId=void 0,s.redo.push(a),r=o.toHTML(g.renderHtmlWithBlockMeta(l,e.brush)),e.findElemById(o.cid).replaceWith(r),e.undo.exeCommand(a,[]),e.undo.stashUndo(s),l.cid},t.backspaceHandler=r.backspaceHandler,t.deleteSelectable=r.deleteSelectable,t.deleteLineProcessor=r.deleteLineProcessor,t.deleteLine=r.deleteLine,t.backToParagraph=r.backToParagraph,t.getMarkdownSourceFrom=s.getMarkdownSourceFrom,t.copyAsMarkdown=s.copyAsMarkdown,t.copyAsHTMLSource=s.copyAsHTMLSource,t.copyHandler=s.copyHandler,t.insertInlineText=s.insertInlineText,t.pasteHandler=s.pasteHandler,t.setClipboard=s.setClipboard,t.insertURLs=s.insertURLs,t.insertDom=s.insertDom,t.prepMarkHtml=s.prepMarkHtml,t.insertParagraph=s.insertParagraph,t.processClipboardHTML=s.processClipboardHTML,t.moreIndent=o.moreIndent,t.lessIndent=o.lessIndent,t.hanldePair=a.hanldePair,t.surroundPair=a.surroundPair}),define("app/editor/ConvertUtils",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/TableEdit","app/editor/UndoManager","app/editor/polyfill","app/editor/KeyMaster","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/window/FileHelper","app/editor/Emoji"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton");var d=e("app/document/StringUtils"),i=e("app/document/Node"),k=i.Node,S=i.TYPE,v=(i.NodeCollectionUtils,d=e("app/document/StringUtils"),e("app/editor/TableEdit")),y=e("app/document/MarkParser"),b=e("jquery/jquery"),w=["CONTENT","HEADER","FOOTER","ARTICLE","SECTION","DIV","P","BLOCKQUOTE","PRE","UL","OL","TABLE","HR","H1","H2","H3","H4","H5","H6","DL","DT","DD","TBODY","THEAD","TFOOT","ASID","LI","HTML","BODY","IFRAME","STYLE","SCRIPT","FIGURE"],x=["INPUT","BUTTON","SELECT","SCRIPT","CANVAS","META","PROGRESS","VIDEO","HEAD","EMBED","STYLE","TEMPLATE"];t.convertToPlain=function(e){function x(e,t){for(var n=(e instanceof Array?e[0]:e.first()).getLastBrother(!0),i=[],r=0;r<e.length;r++)i=i.concat(C(n,t)),n=n.get("after");return i}function C(e,t){var n,i=[];function r(e){return t?[e]:[e,""]}switch(e.get("type")){case S.fences:i=e.get("text").replace(/\u200B/g,"").split("\n");for(var o=0;o<i.length;o++)i[o]="    "+i[o];return t||i.push(""),i;case S.list:var a=e.get("style"),s=e.get("children").length;if(s){var l=e.getFirstChild();for(o=0;l;){var c=C(l,!0),d=k.getIndentPrefix(a,o,l,void 0,(s+"").length);c.map(function(e,t){c[t]=(t?" ".repeat(d.length):d)+c[t],i.push(c[t])}),o++,l=l.get("after")}}return t||i.push(""),i;case S.table:for(var u,p,h,f,g,m,v=[],y=[],b=0,w=e.getFirstChild();w;){for(u=w.getFirstChild(),y[b]=[],p=0;u;)y[b][p]=u.toMark().trim(),u=u.get("after"),0===b&&(v[p]=4),v[p]=Math.max(y[b][p].length,v[p]),v[p]=Math.min(v[p],40),p++;w=w.get("after"),b++}for(b=0;b<y.length;b++){for(h="  ",p=0;p<v.length;p++)f=Math.max(v[p]-y[b][p].length,0),h+="right"==(g=e.get("align")[p])?" ".repeat(f)+y[b][p]:"center"==g?" ".repeat(m=~~(f/2))+y[b][p]+" ".repeat(f-m):y[b][p]+" ".repeat(f),h+="\t";i.push(h.replace(/\s$/,""))}return t||i.push(""),i;case S.hr:return r("---");case S.def_link:return n="["+e.get("ref")+"]: "+e.safeGetStrAttr("href")+(e.safeGetStrAttr("title").length?'\t"'+e.get("title")+'"':""),k.isType(e.get("after"),S.def_link)?[n]:r(n);case S.def_footnote:return n="["+e.get("ref")+"]: "+e.get("text"),k.isType(e.get("after"),S.def_footnote)?[n]:r(n);default:return e.get("children")&&0<e.get("children").length?x(e.get("children"),t):r(e.get("text"))}}return x(e).join("\n")},t.parseHTML=function(e,r,s,l){var t=b(b.parseHTML("<div>"+e+"</div>")[0]),n=[];function c(e){var t=["",e,""],n=/^(\s*)/.exec(e);return n&&(e=e.substring(n[0].length),t[0]=n[0]),(n=/(\s*)$/.exec(e))&&(e=e.substring(0,e.length-n[0].length),t[2]=n[0]),t[1]=e,t}function u(e,t){var n,i,r,o;e.find("img").each(function(){var e;(n=b(this)).text("!["+(n.attr("alt")||n.attr("title")||"img").replace(/\r?\n/gi," ")+"]("+(e=n.attr("src")||"",File.isMac&&(0==e.indexOf("file:///")&&-1==e.substring("file:///".length).indexOf("/")?(e=e.substring("file:///".length),e=d.getAbsoluteURL(l,e)):0==e.indexOf("webkit-fake-url:")&&(e=app.controller.convertFakeUrl(e))),-1==e.indexOf(":/")&&(e=s.imgEdit.resolveImagePath(e)),e)+")"),n.replaceWith(n[0].childNodes[0])}),e.find("strong, b").each(function(){n=b(this),(o=c(n.text()))[1]=o[1]?"**"+o[1].replace(/([^\\])\*/,"$1\\*")+"**":"",n.text(o.join(""))}),e.find("em, i").each(function(){n=b(this),(o=c(n.text()))[1]=o[1]?"*"+o[1].replace(/([^\\])\*/,"$1\\*")+"*":"",n.text(o.join(""))}),e.find("code, pre, tt").each(function(){(n=b(this)).text("`"+n.text()+"`")}),e.find("del, strike").each(function(){(n=b(this)).text("~~"+n.text()+"~~")}),e.find("br").each(function(){(n=b(this)).replaceWith("")}),e.find("a[href]:not(:empty)").each(function(){n=b(this),i=d.getAbsoluteURL(l,n.attr("href")),0==(r=n.text()).length?n.replaceWith(""):i==r?n.replaceWith("&lt;"+i.replace(/</g,encodeURI("<")).replace(/>/g,encodeURI(">"))+"&gt;"):n.replaceWith("["+r.replace(/([^\\])]([^(]|$)/,"$1\\]$2").replace(/\r?\n/gi," ")+"]("+i+")")}),File.option.highlight&&e.find("mark").each(function(){(n=b(this)).text("=="+n.text().replace(/([^\\])\=/,"\\=")+"==")});var a=e[0].innerText.replace(/\r?\n/gi," ");return t?a.split(/\uE033/g):a.replace(/\uE033/g," ")}function p(e,t,n){e.in=r,e.parent=t,e.before=n.last(),e&&e.text&&(e.text=e.text.replace(/\u200b/g,"").replace(/\u00a0/g," "));var i=new k(e);return n.push(i),i}function h(e,t,n){var i=[];if(t)for(var r=0;r<e[0].childNodes.length;r++)m(b(e[0].childNodes[r]),n,i);else k.isType(n,S.blockquote,S.list_item)?f(e,n,i):n.set("text",u(e))}function a(e,t,n){for(var i,r,o=[],a=null,s=0;s<e.length;s++)i=e[s],(o=y.reDefLink.exec(i))?(a=null,p({type:S.def_link,ref:o[1],href:o[3],title:o[7]},t,n)):(o=y.reDefFootnote.exec(i))?(a=null,p({type:S.def_footnote,ref:o[1],text:(o[2]||"").trim()},t,n)):(null==a&&(a=p({type:S.paragraph},t,n),r=[]),p({type:S.line,text:d.escapeHead(i)},a,r))}function f(e,t,n){if(e.find("br").length){for(var i=u(e,!0),r=[],o=0;o<i.length;o++)i[o].trim().length&&r.push(i[o]);a(r,t,n)}else{if(3==e[0].nodeType&&!e.text().trim().length)return;a([u(e)],t,n)}}var g={center:"center",left:"left",right:"right"};function m(e,r,o){var t,n,i=function(e){if(-1==w.indexOf(e[0].tagName))return!1;var t=!1;return e.children().each(function(){t=t||this.tagName&&(-1<w.indexOf(this.tagName)||"BLOCK"==this.style.display)}),t}(e),a=e[0].tagName;if(!(e.data("skip")||-1<x.indexOf(a)||e[0].nodeType===document.COMMENT_NODE)){if("BLOCKQUOTE"===a)h(e,i,t=p({type:S.blockquote},r,o));else if("LI"===a&&k.isType(r,S.list))h(e,i,t=p({type:S.list_item},r,o));else if("UL"===a||"OL"===a)h(e,i,t=p({type:S.list,style:a.toLowerCase()},r,o));else if("DL"===a)t=p({type:S.list,style:"ul"},r,o),function(e,t){for(var n,i=[],r=0;r<e.length;r++)"DT"==e[r].tagName&&((n=p({type:S.list_item},t,i)).itemList=[],p({type:S.paragraph,text:u(b(e[r]))},n,n.itemList)),"DD"==e[r].tagName&&n&&p({type:S.paragraph,text:u(b(e[r]))},n,n.itemList)}(e.children(),t);else if("TABLE"===a)(n=e.children().children("tr").add(e.children("tr"))).length&&(t=p({type:S.table},r,o),o=[],t.cols=1,n.toArray().map(function(e){m(b(e),t,o)}),t.set("align",new Array(t.cols-0)),v.valify(t,t.cols,2,function(e,t){var n=t.split(/(\r|\n)+/);e.set("type",S.paragraph),e.set("text",n[0]);for(var i=1;i<n.length;i++)n[i].trim().length&&p({type:S.paragraph,text:n[i]},r,o)}));else if("THEAD"===a||"TBODY"===a||"TFOOTER"===a){for(var s=[e],l=$elem.next();l.length&&k.isType(l[0].tagName,"THEAD","TBODY","TFOOTER");)s.push(l),l.data("skip",!0);e.wrap("<table></table>"),m(e.parent(),r,o)}else if("TR"===a&&k.isType(r,S.table)){var c;c=(n=e.children("th")).length,n=n.add(e.children("td")),r.cols=n.length>r.cols?n.length:r.cols,t=p({type:S.table_row,isHeader:c},r,o),o=[],n.toArray().map(function(e){m(b(e),t,o)})}else if("TD"!==a&&"TH"!==a||!k.isType(r,S.table_row))if("HR"===a)p({type:S.hr},r,o);else if(/H[1-6]/g.exec(a))p({type:S.heading,text:u(e),depth:e[0].tagName[1]},r,o);else if("CODE"===a||"PRE"===a&&0==e.find("pre").length||"FIGURE"==a&&e.hasClass("highlight"))e.find("div").each(function(){b(this).before("<br/>")}),p({type:S.fences,text:e[0].innerText.replace(/(^\s*\n+)|([\r\n]+$)/g,"")},r,o);else if(i)e.children().each(function(){m(b(this),r,o)});else{var d=function(e){try{return 3<(e.match(/\n\s*(\!?\[|#{1,5}|>|```)/g)||"").length||e.match(/\|(.+)\n *\|( *[-:]+[-| :]*)\n((?: *\|.*(?:\n|$))*)/)||e.match(/(\S.*\|.*)\n *([-:]+ *\|[-| :]*)\n((?:.*\|.*(?:\n|$))*)/)?e:null}catch(e){}return null}(e[0].innerText||"");if(d)return d;f(e,r,o)}else t=p({type:S.table_cell,text:u(e)},r,o),"TH"===a&&function(e,t){if("TH"===e[0].tagName){var n=e.attr("style")||"",i=/text\-align:([^;]+)($|;)/.exec(n),r=null;if(i&&(r=g[i[1].replace(/;/g,"").trim()]||null),r){var o=e.prevAll("th").length;(t.get("parent").get("parent").get("align")||[])[o]=r}}}(e,t);return null}}t.find("head, meta, script, css, .gutter, style, title").remove();var i=m(t,null,n);if(i)return i;if(n.length&&(function e(t,n,i,r){var o,a=n,s=[];if(n&&n!==i){for(;a&&a!==i;)k.isType(a,S.paragraph)&&k.isEmptyBlock(a)?(a=(o=a).get("after"),o.remove(),r&&r.splice(r.indexOf(o),1)):a=a.get("after");for(n=a.get("before")||a,a=i;a&&a!==n;)k.isType(a,S.paragraph)&&k.isEmptyBlock(a)?(a=(o=a).get("before"),o.remove(),r&&r.splice(r.indexOf(o),1)):a=a.get("before")}for(a=n;a;){var l=null;if(k.isType(a,S.blockquote,S.list_item))e(a,a.getFirstChild(),a.getLastChild());else if(k.isType(a,S.fences)&&k.isType(a.get("before"),S.fences))s.push(a),a.head=a.get("before").head||a.get("before"),a.head.set("text",a.head.get("text")+"\n"+a.get("text"));else if(k.isType(a,S.list)&&0===a.get("children").length)a.set("type",S.paragraph);else if(k.isType(a,S.paragraph)&&(l=/^(`+)([\s\S]*?[^`])\1(?!`)\s*$/g.exec(a.get("text")))){a.set("type",S.fences),a.set("text",l[2]);continue}a=a.get("after")}s.map(function(e){r&&r.splice(r.indexOf(e),1),e.remove()})}(0,n[0],n.last(),n),1===n.length&&k.isType(n[0],S.paragraph))){t.find("br").replaceWith(""),t.html(t.html().replace(/^\s+/gm,""));var o=t.text().replace(/^(\s*\n)+/,"").replace(/(\r?\n)+/g," ").replace(/\uE033/g," ").replace(/\u200b/g,"");return n[0].delete(),k.parseFrom(o,r,{noTop:!0,skips:{old_code:!0}},!0)[1]}return n}}),define("app/editor/DeleteOp",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileHelper","app/editor/UndoManager","app/editor/Emoji","app/editor/TableEdit","app/editor/polyfill","app/editor/ConvertUtils","app/editor/TableEdit","app/editor/Stylize","app/window/MenuHelper","app/editor/Emoji","app/editor/EditHelper","app/editor/PairOp"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton"),e("app/document/StringUtils");var L=e("app/document/Node"),I=e("app/editor/UndoManager"),R=I.SnapFlag,P=L.Node,D=L.TYPE,O=(L.NodeCollectionUtils,e("rangy/rangy-core.js"),e("app/document/MarkParser"),e("app/editor/TableEdit")),B=(e("app/editor/ConvertUtils"),e("app/editor/Stylize")),j=(e("app/editor/Emoji"),e("app/editor/EditHelper"),e("app/window/FileHelper"),e("app/editor/PairOp")),H=(window.reqnode&&reqnode("electron").remote,"skipCommand"),U=$("content"),W=function(e,t){var n=t.get("parent"),i=n&&n.get("parent");if(i&&i.get("style")==P.ListType.task&&!n.get("before")&&P.isType(n,D.paragraph)){var r=I.makeEmptyCommand(e.selection.buildUndo());return r.undo.push(I.buildReplaceUndo(i)),i.unset("style"),i.unset("checked"),e.findElemById(i.cid).replaceWith(i.toHTML()),r.redo.push(I.buildReplaceUndo(i)),e.undo.exeCommand(r.undo[0]),r.redo.push(e.selection.buildUndo()),r}},q=function(e,t,n){if(P.isType(t,D.line)&&!t.get("before")&&(t=t.get("parent")),P.isType(t.get("parent"),D.blockquote)&&(n||!t.get("before"))){var i=I.makeEmptyCommand(e.selection.buildUndo()),r=t.upStream();return I.append(i,r.command),e.findElemById(r.oldCid).replaceWith(r.newHtml),e.undo.exeCommand(i.undo[0]),i.redo.push(e.selection.buildUndo()),i}if(P.isType(t.get("parent"),D.list_item)&&(n||!t.get("parent").get("before")&&!t.get("before"))){i=I.makeEmptyCommand(e.selection.buildUndo());var o=t.get("parent"),a=o.get("parent");i.undo.push(I.buildReplaceUndo(a)),a.unset("start"),o.set("parent",null),o.set("after",null),a.insert(o,!0);var s=o.unwrap();return I.addUndoForInsertArray(i,s),e.findElemById(a.id).before(L.NodeCollectionUtils.toHTML(s)),a.get("children").length?(e.findElemById(a.id).replaceWith(a.toHTML()),i.redo.push(I.buildReplaceUndo(a))):(I.addUndoForRemove(i,a),a.remove(),e.findElemById(a.id).remove()),e.selection.jumpIntoElemBegin(e.findElemById(s[0].id)),i.redo.push(e.selection.buildUndo()),i}},z=function(e,t,n,i){var r=I.makeEmptyCommand(e.selection.buildUndo());return r.undo.push(I.buildReplaceUndo(t)),t.set("type",D.paragraph),t.clearChildren(),n?t.set("text",""):t.set("text",t.get("text").replace(/\u200B|(\r?\n)/g,"")),P.normalizeNode(t),r.redo.push(I.buildReplaceUndo(t)),e.findElemById(t.id).replaceWith(t.toHTML()),e.selection.jumpIntoElemBegin(e.findElemById(t.id)),r.redo.push(e.selection.buildUndo()),!i&&$(e.sessionStr).trigger("cursorChange"),r},V=function(e,t,n,i){if(t&&t.length){n&&n.preventDefault(),!i&&e.undo.completeSnap(!0);var r=e.findNodeByElem(t),o=I.makeEmptyCommand(e.selection.buildUndo());return r?(r.set("text",""),o=I.append(o,z(e,r))):(r=e.findNodeByElem(t.closest("[mdtype]")),o.undo.push(I.buildReplaceUndo(r)),e.selection.moveLeftOrRight(!0),t.remove(),e.store(r.id),o.redo.push(I.buildReplaceUndo(r)),o.redo.push(e.selection.buildUndo())),!i&&e.undo.register(o),o}},a=function(i,r,o,t,e){var n,a,f,s,l=i.selection.getRangy(),c=l&&i.selection.deRange(l.cloneRange()),g=c&&!c.collapsed,d=document.activeElement,u=!1,m=l;function p(e,t,n){var i,r=e;if(e==t)return null;for(i=e.get(n);i;)$("[cid='"+i.id+"']").remove(),i.remove(),i=e.get(n);return p(e.get("parent"),t,n),r}function y(e,t,n,i,r){var o,a,s,l=t.cloneRange(),c=e.findElemById(n.id);return l.setEndAfter(c[0]),e.selection.deRange(l),a=e.findNodeByElem(e.getMarkElem(l.startContainer)),!r&&$(l.startContainer).closest("table").length?(I.append(i,S(e,l,!0)),a=e.findNodeByElem($(l.startContainer).closest("[mdtype='table']")),n.contains(a)&&(p(a,n,"after"),0===a.getText().length)?(I.append(i,z(e,a)),"abortAndSkipCursor"):"abort"):(i.undo.push(I.buildReplaceUndo(n)),o=$(l.extractContents()),P.isType.apply(null,[n].concat(B.CONST.Selectable))&&I.append(i,z(e,n,!0,!0)),e.store(a,!0),e.findElemById(a.cid).replaceWith(a.toHTML()),s=p(a,n,"after"),!!(o.text().length||o.find("img").length||s)&&(i.redo.push(I.buildReplaceUndo(n)),a))}function b(e,t,n,i,r){var o,a,s,l=t.cloneRange(),c=e.findElemById(n.id);if(l.setStartBefore(c[0]),e.selection.deRange(l),!r&&$(l.endContainer).closest("table").length)return I.append(i,S(e,l,!0)),a=e.findNodeByElem($(l.endContainer).closest("[mdtype='table']")),"abort";i.undo.push(I.buildReplaceUndo(n)),a=e.findNodeByElem(e.getMarkElem(e.selection.getEndNode(l))),o=$(l.extractContents()),e.store(a,!0);var d=e.findElemById(a.cid);if(s=p(a,n,"before"),o.text().length||o.find("img").length||s){for(i.redo.push(I.buildReplaceUndo(n));d.parent().closest(".md-task-list-item").length;)d=d.parent().closest(".md-task-list-item");return d.hasClass("md-task-list-item")?d.replaceWith(e.findNodeByElem(d).toHTML()):d.replaceWith(a.toHTML()),a}return d.replaceWith(a.toHTML()),!1}function w(e,t,n,i,r,o,a){var s,l,c,d;function u(e,t){return e==t||e.get("before")||e.get("after")?e:u(e.get("parent"),t)}var p=P.isEmptyBlock(i);if(!p||i==r||P.isEmptyBlock(r)&&!a)if(p&&i==r&&r.isBlock())r.set("type",D.paragraph),r.clearChildren(),e.findElemById(r.id).replaceWith(r.toHTML()),e.selection.jumpIntoElemBegin(e.findElemById(r.id)),o.redo.push(e.selection.buildUndo());else{if(console.assert(t!=n,"Error on spliceStartAndEnd"),t!=n){if(s=n.safeGetStrAttr("text"),d=u(n,r),I.addUndoForRemove(o,d),e.findElemById(d.id).remove(),d.remove(),l=$(t.toHTML()).textExcludeSVG().length,o.undo.push(I.buildReplaceUndo(i)),P.isType(t,D.def_link))if(t.safeGetStrAttr("title").length)t.set("title",t.get("title")+s);else{var h=/["']([^"]*)["']\s*$/g.exec(s);s=s.replace(/"([^"])*"\s*$/,""),h&&t.set("title",h[1]),t.set("href",t.get("href")+s)}else t.set("text",t.safeGetStrAttr("text")+s);if(d!=r&&r!==n&&r.get("before")==i&&P.isType(i,D.list_item)){var f=r.getFirstChild();f.set("before",i.getLastChild()),r.giveChildrenTo(i,f),I.addUndoForRemove(o,r),e.findElemById(r.id).remove(),r.remove()}o.redo.push(I.buildReplaceUndo(i)),e.findElemById(i.id).replaceWith(i.toHTML()),c=e.findElemById(t.id)}c=e.findElemById(t.id),e.selection.restoreSelection(c,l),o.redo.push(e.selection.buildUndo())}else e.findElemById(i.id).remove(),I.addUndoForRemove(o,i),i.remove(),d=u(n,r),e.findElemById(d.id).replaceWith(d.toHTML()),e.selection.jumpIntoElemBegin(e.findElemById(d.id))}function h(n,e){P.isType(e,D.line)&&!e.get("before")&&(e=e.get("parent"));var t=e.get("before");function i(e){var t=I.makeEmptyCommand(n.selection.buildUndo());return I.addUndoForRemove(t,e),n.findElemById(e.id).remove(),e.remove(),t.redo.push(n.selection.buildUndo()),t}return P.isType(t,D.hr)?i(t):t&&!P.isEmptyBlock(e)&&P.isEmptyBlock(t)?i(t):!t&&P.isType(e.get("parent"),D.list_item)&&(t=e.get("parent").get("before"))&&1==t.get("children").length&&P.isEmptyBlock(t.get("children").at(0))?i(t):void 0}function v(e,t){if(P.isType(t,D.table_cell)){var n=t.get("parent").get("parent");if(r&&!o&&!t.get("before")&&!t.get("parent").get("before")&&e.tableEdit.isTableEmpty(n))return e.tableEdit.deleteTable(e.findElemById(n.cid),!0);var i=O.getSibling(t,"before");return i&&(f=I.makeEmptyCommand(e.selection.buildUndo()),e.selection.jumpIntoElemEnd(e.findElemById(i.id)),f.redo.push(e.selection.buildUndo())),f}}function x(e,t){if(P.isType(t,D.line)&&!t.get("before")&&(t=t.get("parent")),P.isType(t.get("parent"),D.list_item)&&t.get("parent").get("before")&&!t.get("before"))return n=e,i=t.get("parent"),o=I.makeEmptyCommand(n.selection.buildUndo()),a=i.get("before"),s=a.get("children").at(a.get("children").length-1).getLastBrother(),o.undo.push(I.buildReplaceUndo(a.get("parent"))),n.findElemById(i.id).remove(),s.insert(i),r=i.unwrap(),o.redo.push(I.buildReplaceUndo(a.get("parent"))),n.findElemById(s.id).after(L.NodeCollectionUtils.toHTML(r)),n.selection.jumpIntoElemBegin(n.findElemById(r[0].id)),o.redo.push(n.selection.buildUndo()),o;var n,i,r,o,a,s}function C(e,t){if(P.isType(t,P.backToParagraphBeforeDelete))return e.stylize.changeBlock(D.paragraph,t),H}function k(e,t,n,i,r){for(var o=[v,h,W,q,x,C],a=null,s=0;s<o.length;s++)if(a=o[s](e,t))return a;if(n=P.isType(t,D.line)&&!t.get("before")?n||t.get("parent"):n||t,r=r||n.get("before"),i=i||r&&r.getVeryFirst(!0),!a&&i&&w(e,i,t,r,n,a=I.makeEmptyCommand(e.selection.buildUndo())),!a&&!i&&P.isType(t,D.paragraph)&&P.isEmptyBlock(t)&&t.get("after")){a=I.makeEmptyCommand(e.selection.buildUndo());var l=t.get("after").cid;I.addUndoForRemove(a,t),t.remove(),e.findElemById(t.cid).remove(),e.selection.jumpIntoElemBegin(e.findElemById(l)),a.redo.push(e.selection.buildUndo())}return a}function S(e,t,n){var i,r=e.selection.getDetailPos(t.startContainer,t.startOffset),o=e.selection.getDetailPos(t.endContainer,t.endOffset),a=I.makeEmptyCommand(),s=e.getMarkElem(r[0]),l=e.getMarkElem(o[0]),c=s.closest('[mdtype="table"]'),d=e.findNodeByElem(c),u=e.findNodeByElem(s),p=e.findNodeByElem(l);if(n||((i=t.cloneRange()).collapse(!0),i=e.selection.buildUndo(i)),t.setStart(r[0],r[1]),t.setEnd(o[0],o[1]),u==p)return t.collapsed||!P.isType(u,D.table_cell)||s[0]!=t.commonAncestorContainer&&!s[0].contains(t.commonAncestorContainer)||(a.undo.push(I.buildReplaceUndo(u)),t.extractContents(),e.store(u,!0),a.redo.push(I.buildReplaceUndo(u)),a.redo.push(e.selection.buildUndo(t))),a;var h,f,g=y(e,t,u,a,!0),m=b(e,t,p,a,!0);for(a.undo.push(I.buildReplaceUndo(d)),h=e.tableEdit.getSibling(u,"after");h&&h!=p;)h.set("text",""),f=!0,h=e.tableEdit.getSibling(h,"after");return g||m||f?(e.findElemById(d.id).replaceWith(d.toHTML()),a.redo.push(I.buildReplaceUndo(d))):a.undo.pop(),n||(a.redo.push(i),e.undo.exeCommand(i)),a}function T(e){return i.selection.deRange(e),n=i.getMarkElem(e.commonAncestorContainer),a=i.nodeMap.allNodes.get(n.attr("cid")),s=e.getBookmark(n[0]),n.length&&!a.get("children").length&&0==s.start&&!o}function F(){var e=null;if(P.isType(a.getClosetParagraphLevel().get("before"),P.TYPE.hr,P.TYPE.toc)&&(e=a.get("before")),i.undo.completeSnap(!0),r&&r.preventDefault(),$(".md-tooltip-remove").remove(),n.prev("[cid]").addClass("md-expand"),(f=k(i,a))===H);else if(!t)return e&&(i.selection.selectNode(e),f.redo.push(i.selection.buildUndo())),i.undo.register(f),i.refresh(),e||i.findElemById(a.cid).trigger("refocus"),i.refocus(),i.selection.scrollAdjust(),f}var E=$(document.activeElement).closest(".CodeMirror");if(E.length){E[0].CodeMirror.execCommand("delCharBefore")}else{if(P.isType(d.getAttribute("mdtype"),P.TYPE.hr,P.TYPE.toc)){var _=$(d).closest("[mdtype]");return V(i,_,r,t)}if(d.getAttribute("mdtype")==D.math_block)return r&&r.preventDefault(),i.mathBlock.remove(d.getAttribute("cid")),f;if(o&&"Backspace"!=o?!0===o&&(o="Delete"):o=!1,c){if($(c.commonAncestorContainer).closest("[mdtype='table_row']").length&&r&&r.shiftKey&&(File.isMac?r.metaKey:r.ctrlKey))return r.preventDefault(),i.tableEdit.deleteRow(),H;if(c.collapsed){if(o){if("Delete"==o&&(A=c,i.selection.deRange(A),n=i.getMarkElem(A.commonAncestorContainer),a=i.nodeMap.allNodes.get(n.attr("cid")),s=A.getBookmark(n[0]),"Delete"==o&&P.isType(n.attr("mdtype"),D.line,D.heading)&&!a.get("children").length&&0==s.start&&0==n.text().length&&(f=function(){function e(e,t){var n=I.makeEmptyCommand(i.selection.buildUndo());return i.findElemById(e.cid).remove(),I.addUndoForRemove(n,e),e.remove(),i.selection.jumpIntoElemBegin(i.findElemById(t)),n.redo.push(i.selection.buildUndo()),n}if(i.undo.completeSnap(!0),P.isType(a,D.line)){var t=a.get("parent");if(a.get("after"))return e(a,a.get("after").cid);if(t.get("after"))return a.get("before")?e(a,t.get("after").getVeryFirst().cid):e(t,t.get("after").getVeryFirst().cid)}else if(a.get("after"))return e(a,a.get("after").getVeryFirst().cid);return null}())))return t||(i.undo.register(f),i.refocus()),r&&r.preventDefault(),f}else if(T(c))return F();if(M=r&&(File.isNodeHtml?r.ctrlKey:r.altKey),N=!1,!0===(c="delSelection"==o?i.selection.getRangy():(M||(N=i.selection.extendCharFromCollapse(c,!o)),N||(u=!0,o?(window.getSelection().modify("extend","forward",M?"word":"character"),c=i.selection.getRangy()):(window.getSelection().modify("extend","backward",M?"word":"character"),c=M?(/\n/.exec(window.getSelection().toString())?(c.setStart(c.startContainer,0),c.select(c.isBackward)):c=i.selection.getRangy(),c):i.selection.getRangy())),!o&&/^\u200b|\007F$/g.exec(c.toString())?(i.selection.extendCharFromCollapse(c,!0),T(c)||c):c)))return F();if(!o&&j.tryRemovePairStart(i,c)&&(e=!1),"delSelection"==o&&c&&c.collapsed)return r&&r.preventDefault(),I.makeEmptyCommand()}else!function(e){if(i.selection.selectWordTime&&File.isMac)if(o)"Delete"==o&&e.endContainer.nodeType===document.TEXT_NODE&&(t=e.endContainer.textContent.charAt(e.endOffset),/\s/.exec(t)&&(e.endOffset++,m=e.cloneRange()));else if(0<e.startOffset&&e.startContainer.nodeType===document.TEXT_NODE){var t=e.startContainer.textContent.charAt(e.startOffset-1);/\s/.exec(t)&&(e.startOffset--,m=e.cloneRange())}}(c);var M,N,A;if(e&&!(c.commonAncestorContainer.nodeType!=document.TEXT_NODE||0==o&&c.startOffset<=1||"Delete"==o&&c.endOffset>=c.commonAncestorContainer.textContent.length-1))return null;if(i.selection.selectWordTime=null,i.selection.deRange(c),n=i.getMarkElem(c.commonAncestorContainer),a=i.nodeMap.allNodes.get(n.attr("cid")),u&&(window.getSelection().removeAllRanges(),window.getSelection().addRange(l.nativeRange)),n.length&&!a.get("children").length){if(n.get("type")!==D.fences)return function(e,t,n,i,r){var o,a=3!==n.commonAncestorContainer.nodeType,s=e.getNode(i.attr("cid"));r||(e.undo.snap(s.cid,g?R.DELETE_ACCROSS_BLOCK:R.DELETE),e.brush.clearAndPause());var l=e.selection.buildUndo(m);if((f=I.makeEmptyCommand(l)).undo.push(I.buildReplaceUndo(s)),!a&&l.startId==l.endId&&P.isType(s,D.line)){var c=(i.text().substring(0,l.start).match(/\u200b/g)||[]).length,d=(i.text().substring(0,l.end).match(/\u200b/g)||[]).length;e.undo.snapSelection&&e.undo.snapSelection.end==l.end&&e.undo.snapSelection.start==l.start?(e.undo.snapSelection.start-=c,e.undo.snapSelection.end-=d):(l.start-=c,l.end-=d)}var u=U.scrollTop();if(!n.commonAncestorContainer.contains(document.querySelector("#write"))){if(o=n.extractContents(),u!=U.scrollTop()&&e.undo.clearEventTimer(),e.store(s.cid),f.redo.push(I.buildReplaceUndo(s)),P.isType(s,D.def_link,D.def_footnote)||s.getText().length||(e.findElemById(s.cid).html($(s.toHTML()).html()),n=e.selection.getRangy(),e.selection.deRange(n,!0)),f.redo.push(e.selection.buildUndo()),o.querySelector("img"),n.collapse(!1),a){var p=i.attr("cid");a=e.selection.saveSelection(i,n),n.setStart(i[0],0);var h=(n.toString().match(/(:\u200b)|(\u200b:)/g)||[]).length;e.store(p,!0),i.replaceWith(e.nodeMap.allNodes.get(p).toHTML()),i=e.findElemById(p),a.start-=h,a.end-=h,e.selection.restoreSelection(i,a),e.focusCid=null,e.refocus()}return e.brush.addToQueue(i.attr("cid")),!r&&e.brush.resume(!0),t&&(t.preventDefault(),$("#write").trigger("input")),f}}(i,r,c,n,t);!t&&i.undo.completeSnap(!0),f=V(i,n,r,t)}else!t&&i.undo.completeSnap(!0),r&&r.preventDefault(),$(".md-tooltip-remove").remove(),f=function(t,e,n){if(!document.contains(e.startContainer)&&!(e=t.selection.getRangy()))return I.makeEmptyCommand();var i=t.selection.getDetailPos(e.startContainer,e.startOffset),r=t.selection.getDetailPos(e.endContainer,e.endOffset),o=t.getMarkElem(i[0]),a=t.getMarkElem(r[0]),s=t.findNodeByElem(o),l=t.findNodeByElem(a);if(!s||!l)return I.makeEmptyCommand();var c=P.getTreePosition(s,l),d=c[1],u=c[2],p=I.makeEmptyCommand(t.selection.buildUndo()),h=e.cloneRange();if(o[0]==a[0])return p;if(h.collapse(!0),h=t.selection.buildUndo(h),e.setStart(i[0],i[1]),e.setEnd(r[0],r[1]),$(e.commonAncestorContainer).closest('[mdtype="table"]').length)return I.append(p,S(t,e));var f=y(t,e,d,p),g=b(t,e,u,p),m=d.get("after"),v=[];for(e=t.selection.getRangy(),t.selection.deRange(e,!0);m&&m!=u;)v.push(m),m=m.get("after");return I.addUndoForRemoveArray(p,v,d,u),v.map(function(e){t.findElemById(e.id).remove(),e.remove()}),"abort"==f||"abort"==g||"abortAndSkipCursor"==f?("abortAndSkipCursor"!=f&&(e.collapse(!0),p.redo.push(h),t.undo.exeCommand(h)),!1===g&&0==l.getText().length&&(I.addUndoForRemove(p,l),t.findElemById(l.id).remove(),l.remove())):f||g||v.length||n?w(t,f||s,g||l,d,u,p,f):p=k(t,l,u,s,d),t.refresh(),p}(i,c,o),t||(i.undo.register(f),i.refocus()),i.selection.scrollAdjust();return f}}},s={"[mdtype='hr']":a,"tr[mdtype='table_row']":O.deleteRow,".md-toc":V};t.backspaceHandler=a,t.deleteSelectable=V,t.deleteLineProcessor=s,t.deleteLine=function(e){var t=$(document.activeElement).closest(".CodeMirror");if(t.length)t[0].CodeMirror.execCommand("deleteLine");else{var n,i=e.getMarkElem();if(i&&i.length){for(n in s)if(i.closest(n).length)return void s[n](e,i.closest(n));var r,o;o=(r=i).hasClass("md-expand"),r.addClass("md-expand"),window.getSelection().modify("move","backward","sentence"),window.getSelection().modify("extend","forward","sentence"),o&&r.removeClass("md-expand"),a(e,null,"delSelection")}}},t.backToParagraph=z}),define("app/editor/PairOp",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton"),e("app/document/StringUtils");var i=e("app/document/Node"),v=e("app/editor/UndoManager"),y=v.SnapFlag,b=(i.Node,i.TYPE,e("rangy/rangy-core.js"),{"(":")","[":"]","{":"}",'"':'"',"'":"'","~":"~","^":"^","=":"=","*":"*","`":"`",$:"$",_:"_"}),c=null;var a=null;var w=null;t.hanldePair=function(n,i,r,t,o,e){if(!File.option.noPairingMatch){var a,s,l,c;if(/^[\]\)\}'"]$/.exec(i)){if(a=n.findElemById(r.cid).textExcludeSVG(),i===a.substring(t.start,t.start+1))return g(),o||!0;if("'"==i||'"'==i){if(""==a)return m();if(s=(c=a.substring(0,t.start)).slice(-1),i!=s&&"\\"!=s&&!/\w/.exec(a.substring(Math.max(0,t.start-1),t.start+1))&&!function(e,t){for(var n,i,r=e.length,o=0;o<r;o++){var a=e[o];"'"!=a&&'"'!=a||(n?i=n==a?n=null:i?null:a:n=a)}return t==n||t==i}(c,i))return m()}}else if(/^[\[\(\{]$/.exec(i)){if(l=(a=n.findElemById(r.cid).textExcludeSVG()).substring(t.start,t.start+1),!/[^\[\]{}()"'\s`“”‘’«»‹›>$]/.exec(l))return m()}else if(File.option.autoPairExtendSymbol&&function(){if(!w){var e="*`_";File.option.enableInlineMath&&(e+="$"),w=new RegExp("^["+e+"]$")}return w}().exec(i)){if(e&&e.commonAncestorContainer&&e.commonAncestorContainer.parentElement&&("CODE"==e.commonAncestorContainer.parentElement.tagName&&"`"!=i||"SCRIPT"==e.commonAncestorContainer.parentElement.tagName&&"$"!=i))return;if(a=n.findElemById(r.cid).textExcludeSVG(),File.option.enableInlineMath&&"$"==a.substring(t.start-1,t.start)&&/[*`^_~=]/.exec(i))return;l=a.substring(t.start,t.start+1);var d=a.substring(t.start+1,t.start+2),u=/[*_]/.exec(i);if(l==i){if(!u)return g()||!0;if(u&&d)return g()||!0;var p=$(n.selection.getRangy().commonAncestorContainer);if(p.closest(".md-after").length||p.parent().parent("em").length)return g()||!0;if(c=a.substring(0,t.start),/[*_]$/.exec(c))return m()}var h=(c=c||a.substring(0,t.start))[c.length-1]||"",f=0==h.trim().length;if(f||!function(e,t){if("`"==t&&/``$/.exec(e))return!0;e.replace(/\\[*`_$]/g,""),"_"==t&&(e=e.replace(/([a-z])_([a-z])/gi,""));for(var n=e.length,i=!1,r=0;r<n;r++)e[r]==t&&(i=!i);return i}(c,i)){if(f&&!/^[^\s\>\)\]}'";:.,?!~*\/&#=_+-]/.exec(l))return m();if(1<(h+"a").trim().split(/\b/).length)return m()}}return!1}function g(){var e=n.selection.rangy.createRange();t.end++,t.start++,e.moveToBookmark(t),e.select(e.isBackward),o&&o.redo.push(n.selection.buildUndo())}function m(){var e=n.selection.getRangy(),t=document.createTextNode(i+b[i]);return n.undo.completeSnap(!0),n.undo.snap(r.cid,y.ADD),o=o||v.makeEmptyCommand(n.selection.buildUndo()),e.insertNode(t),t.parentElement.normalize(),g(),o}},t.surroundPair=function(e,t,n){if(!File.option.noPairingMatch){var i,r,o,a,s=$(n.commonAncestorContainer).closest("[cid]"),l=$(n.commonAncestorContainer).closest(".md-def-content:not(.md-def-url)");return(s.length&&!s.find("[cid], .md-def-name").length||l.length)&&function(){if(!c){var e="\\{\\(\\[\"'";File.option.autoPairExtendSymbol&&(e+="*`~_",File.option.enableInlineMath&&(e+="$"),File.option.enableSuperscript&&(e+="^"),File.option.enableHighlight&&(e+="=")),c=new RegExp("^["+e+"]$")}return c}().exec(t)?(r=e.findNodeByElem(s),s=l.length?l:s,i=n.getBookmark(s[0]),a=v.makeEmptyCommand(e.selection.buildUndo()),e.store(r,!0),a.undo.push(v.buildReplaceUndo(r)),o=r.get("text"),r.set("text",o.substring(0,i.start)+t+o.substring(i.start,i.end)+b[t]+o.substring(i.end)),a.redo.push(v.buildReplaceUndo(r)),(n=e.selection.rangy.createRange()).moveToBookmark(i),e.selection.deRange(n),n.insertNodeAtEnd(document.createTextNode(b[t])),n.insertNode(document.createTextNode(t)),i.start++,i.end++,n.moveToBookmark(i),n.select(n.isBackward),a.redo.push(e.selection.buildUndo()),a):void 0}},t.tryRemovePairStart=function(e,t){var n=t.toString();if(!File.option.noPairingMatch&&function(){if(!a){var e="\\{\\(\\[\"'";File.option.autoPairExtendSymbol&&(e+="*`~_",File.option.enableInlineMath&&(e+="$"),File.option.enableSuperscript&&(e+="^")),a=new RegExp("["+e+"]")}return a}().exec(n)){var i=$(t.commonAncestorContainer).closest("[cid]"),r=i.text(),o=t.getBookmark(i[0]);if(b[n]==r.substring(o.end,o.end+1))return o.end++,t.moveToBookmark(o),t}}}),define("app/editor/IndentOp",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton"),e("app/document/StringUtils");var i=e("app/document/Node"),v=e("app/editor/UndoManager"),y=(v.SnapFlag,i.Node),b=i.TYPE,w=i.NodeCollectionUtils,r=(e("rangy/rangy-core.js"),function(e,t){if(t(e))return e;var n=e.get("parent");return n?r(n,t):null}),x=function(e,t){if(y.isType(e,b.list)&&y.isType(e.get("before"),b.list)&&e.get("style")==e.get("before").get("style"))return e.get("before").appendTillEnd(e.getFirstChild()),e.remove(),t&&t.remove.push(e.cid),!0};function f(e,t){var n,i;if(e=e.getClosetParagraphLevel(),y.isType(e.get("before"),b.list))return e;if(!(n=r(e,function(e){return y.isType(e.get("parent"),b.list_item)}))&&t)for(i=t;i;){if(i==e||i.contains(e))return i;i=i.get("after")}return n}function C(e,t){return e=e.getClosetParagraphLevel(),r(e,function(e){return y.isType(e.get("parent"),b.list_item)})}function p(e){return r(e,function(e){return y.isType(e.get("parent"),b.blockquote)})}function k(e,t){return e?e.get("after")?t(e.get("after").getVeryFirst()):k(e.get("parent"),t):null}var g=function(e,t,n,a,i,s){function r(e){var t,n,i,r=e.get("before");if(y.isType(r,b.list))return i=e.get("after"),a.undo.push(v.buildReplaceUndo(r)),v.addUndoForRemove(a,e),r.getLastChild().getLastChild().set("tail",r.get("tail")||r.getLastChild().get("tail")||r.getLastChild().getLastChild().get("tail")),S(r,2),r.getLastChild().append(e),S(e),y.isType(i,b.list)&&i.get("style")==r.get("style")&&(v.addUndoForRemove(a,i),x(i,s)),a.redo.push(v.buildReplaceUndo(r)),s.remove.push(e.cid),s.replace.push(r),!0;if(n=(t=e.get("parent")).get("before"),!r&&n){var o=n.getLastChild();return a.undo.push(v.buildReplaceUndo(n)),y.isType(o,b.list)?(o.getLastChild().set("tail",n.get("tail")||o.get("tail")),n.set("tail",e.get("tail"))):(n.getLastChild().set("tail",n.get("tail")),S(n),(o=t.get("parent").clone()).unset("start"),S(o),n.append(o),n.set("tail",e.get("tail")),S(e)),function(e,t,n){var i,r=n.get("parent");v.addUndoForRemove(a,r),i=n.get("after"),e.append(r),i&&(i.set("before",null),t.set("tail",r.get("tail")),S(r),t.appendTillEnd(i),S(t.getLastChild(),2),x(i,s));S(r,2),a.redo.push(v.buildReplaceUndo(t)),s.remove.push(r.cid),s.replace.push(t)}(o,n,e),!0}}s=s||{replace:[],remove:[]};var o,l,c,d,u,p,h=t.get("parent");if(t.get("before"))c=r(t);else{if(!h.get("before")){if(o=(l=h.get("parent")).get("before"),!y.isType(o,b.list)||o.get("style")!=l.get("style"))return!1;a.undo.push(v.buildReplaceUndo(o)),v.addUndoForRemove(a,l),o.getLastChild().set("tail",Math.min(o.get("tail"),1)),o.set("tail",l.get("tail")),x(l,s),a.redo.push(v.buildReplaceUndo(o)),s.remove.push(l.cid),s.replace.push(o)}i.containsNode(document.querySelector("[cid='"+h.getLastChild().cid+"']"),!0)?(c=!!(p=(d=h).get("before"))&&(a.undo.push(v.buildReplaceUndo(p)),u=p.getLastChild(),y.isType(u,b.list)?u.getLastChild().set("tail",p.get("tail")||u.get("tail")):((u=p.get("parent").clone()).unset("start"),p.getLastChild().set("tail",p.get("tail")),p.append(u),S(u)),v.addUndoForRemove(a,d),u.append(d),p.set("tail",d.get("tail")),S(d,2),a.redo.push(v.buildReplaceUndo(p)),s.remove.push(d.cid),s.replace.push(p),!0),t=h):c=r(t)}return!c||t==n||t.contains(n)||n.contains(t)||(t=k(t,f))&&g(e,t,n,a,i,s),c&&s};function S(e,t){for(t=t||1;0<t&&e;)e.unset("tail"),e=e.getLastChild(),t--}var h=function(e,o,t,a,n,s){function i(){var e,t,n=o.get("parent"),i={},r=[];i.oldCid=n.cid,a.undo.push(v.buildReplaceUndo(n)),o.get("before")?(t=[o],r.push(n),o.get("after")&&(e=n.clone(),t.push(e),e.appendTillEnd(o.get("after")),n.insert(e)),n.insert(o),n.set("tail",n.getLastChild().get("tail")),S(n.getLastChild()),r.push(o),e&&r.push(e),a.redo.push(v.buildReplaceUndo(n)),v.addUndoForInsertArray(a,t)):(v.addUndoForRemove(a,o),n.insert(o,!0),v.addUndoForInsert(a,o),r.push(o),n.get("children").length?(a.redo.push(v.buildReplaceUndo(n)),r.push(n)):(v.addUndoForRemove(a,n),n.remove())),i.html=w.toHTML(r),s.push(i)}for(s=s||[],i();o&&o!=t&&!o.contains(t)&&!t.contains(o);)o&&(o=k(o,p)),i();return s},T=function(e,t){for(var n=[],i=e;i!=t;)n.push(i),i=i.get("after");return t&&n.push(t),n},F=function(e,t,n,i,r,o){o=o||[];var a,s,l,c,d,u=t.get("before"),p=t.get("parent"),h={};if(u)s=t.getLastBrother(),i.undo.push(v.buildReplaceUndo(p)),h.oldCid=p.get("parent").cid,p.get("after")&&(l=T(p.get("after")),v.addUndoForRemoveArray(i,l),(a=p.get("parent").clone()).unset("start"),p.get("parent").set("tail",p.getLastChild().get("tail")),S(p,2),a.appendTillEnd(p.get("after")),p.append(a),x(a)?a=null:l.push(a),v.addUndoForInsertArray(i,l)),S(t.get("before")),l=T(t),p.get("parent").insertTillEnd(t),i.redo.push(v.buildReplaceUndo(p)),v.addUndoForInsertArray(i,l),t=s,l.unshift(p.get("parent")),h.html=w.toHTML(l),o.push(h);else{var f=p.get("parent").get("parent"),g=f&&f.get("parent");if(!y.isType(g,b.list))return!1;if(p.get("parent").get("before")||p.get("before")){if(i.undo.push(v.buildReplaceUndo(g)),s=p.getLastChild(),!r.containsNode(document.querySelector("[cid='"+p.getLastChild().cid+"']"),!0)&&y.isType(n.get("before"),b.list)){var m=n.get("before");m.getLastChild().getLastChild().set("tail",m.get("tail"),m.getLastChild().get("tail")),S(m,2),m.set("tail",n.getLastBrother().get("tail")),S(n.getLastBrother()),m.getLastChild().appendTillEnd(n)}p.get("after")&&((c=p.get("parent").clone()).unset("start"),p.getLastChild().set("tail",p.get("tail")),S(p),S(p.get("after")),c.appendTillEnd(p.get("after")),p.append(c)),d=(c=p.get("parent")).get("parent"),c.get("after")&&(S(c),p.set("tail",d.get("tail")||p.get("tail")),c.getLastChild().appendTillEnd(c.get("after"))),d.insert(p),0==c.get("children").length&&c.remove(),d.set("tail",d.getLastChild().get("tail")),S(d.getLastChild()),h.oldCid=d.cid,h.html=w.toHTML(T(d,p)),o.push(h),t=s,i.redo.push(v.buildReplaceUndo(g))}else i.undo.push(v.buildReplaceUndo(f)),s=p.getLastChild(),function(){var e,t;t=(e=p.get("parent")).get("parent"),p.detach(),0==e.get("children").length&&e.remove();for(var n,i=p.getLastChild();i;)n=i.get("before"),t.append(i,!0),i=n;h.oldCid=t.cid,h.html=t.toHTML(),o.push(h)}(),t=s,i.redo.push(v.buildReplaceUndo(f))}return s=k(t,C),o&&s&&r.containsNode(document.querySelector("[cid='"+s.cid+"']"),!0)&&F(e,s,n,i,r,o),o};t.moreIndent=function(t){var e=t.selection.getRangy();if(!e||File.isLocked)return!0;if(y.isType(document.activeElement.tagName,"TEXTAREA","INPUT")){var n=$(document.activeElement).closest(".CodeMirror")[0];return n&&n.CodeMirror.execCommand("indentMore"),!0}var i=t.getMarkElem(e.startContainer),r=f(t.findNodeByElem(i)),o=t.getMarkElem(e.endContainer),a=f(t.findNodeByElem(o),r);t.undo.completeSnap(!0),t.brush.pause(),r&&!a&&(a=r.closest(b.list).getLastChild().getFirstChild());var s=!1;if(r&&a){var l=t.selection.buildUndo(),c=v.makeEmptyCommand(l);return(s=g(t,r,a,c,e))&&(c.redo.push(l),s.remove.forEach(function(e){t.findElemById(e).remove()}),s.replace.forEach(function(e){e.isDeleted()||t.findElemById(e.cid).replaceWith(e.toHTML())}),t.undo.exeCommand(l),t.undo.register(c)),t.refresh(),t.selection.scrollAdjust(),t.brush.resume(),s||r!==a}return t.brush.resume(),!1},t.lessIndent=function(e){var t=e.selection.getRangy();if(!t||File.isLocked)return!0;if(y.isType(document.activeElement.tagName,"TEXTAREA","INPUT")){var n=$(t.startContainer).closest(".CodeMirror")[0];return n&&n.CodeMirror.execCommand("indentLess"),!0}t=e.selection.deRange(t);var i,r,o=e.getMarkElem(t.startContainer),a=C(e.findNodeByElem(o)),s=e.getMarkElem(t.endContainer),l=C(e.findNodeByElem(s));function c(){e.undo.completeSnap(!0),e.brush.pause(),i=e.selection.buildUndo(),r=v.makeEmptyCommand(i)}a&&!l&&(l=a.closest(b.list).getLastChild().getFirstChild());var d=!1;if(a&&l&&(c(),d=F(e,a,l,r,t)),d||(a=p(e.findNodeByElem(o).getClosetParagraphLevel()),l=p(e.findNodeByElem(s).getClosetParagraphLevel()),y.isType(a,b.paragraph,b.def_footnote,b.def_link,b.heading)&&l&&(c(),d=h(e,a,l,r,t))),d){for(var u=0;u<d.length;u++)Object.keys(d[u])[0],e.findElemById(d[u].oldCid).replaceWith(d[u].html);e.undo.exeCommand(i),r.redo.push(i),e.mathBlock.renderAll(),e.undo.register(r)}return e.brush.resume(),d&&a!=l}}),define("app/editor/ClipboardOp",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileHelper","app/editor/UndoManager","app/editor/Emoji","app/editor/TableEdit","app/editor/polyfill","app/editor/ConvertUtils","app/editor/TableEdit","app/editor/Stylize","app/window/MenuHelper","app/editor/Emoji","app/editor/DeleteOp","app/editor/ConvertUtils","app/editor/Stylize","app/editor/PairOp"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton");var p=e("app/document/StringUtils"),F=e("app/document/Node"),E=e("app/editor/UndoManager"),_=(E.SnapFlag,F.Node),M=F.TYPE,N=(F.NodeCollectionUtils,e("rangy/rangy-core.js"),e("app/document/MarkParser"),e("app/editor/TableEdit"),e("app/editor/ConvertUtils")),A=e("app/editor/Stylize"),u=e("app/editor/Emoji"),r=e("app/window/FileHelper"),i=e("app/editor/DeleteOp"),h=window.reqnode?reqnode("electron").remote:null,L="",I=i.backspaceHandler,R=function(e,t,n,i,r,o){t=t||(s=e.getMarkElem(),e.getNode(s.attr("cid")));var a=e.getJQueryElem(window.getSelection().anchorNode),s=e.findElemById(t.id);if(_.noChangeLine(t)&&(n=n.trim().split(/[\n\r]+/gi)[0]),"\n"==n&&s.text().length<=i&&(n="\n​"),r&&r.undo.push(E.buildReplaceUndo(t,void 0)),a.hasClass("md-def-name"))s=a.closest("[cid]"),e.docMenu.getAttrByElem(a),e.selection.getRangy().insertNode(document.createTextNode(p.escape(n))),t.set("ref",a.text());else if(a.hasClass("md-def-url"))s=a.closest("[cid]"),e.docMenu.getAttrByElem(a),n=n.replace(/\s/gi,""),e.selection.getRangy().insertNode(document.createTextNode(p.escape(n))),t.set("href",a.text());else if(a.hasClass("md-def-title"))s=a.closest("[cid]"),e.docMenu.getAttrByElem(a),e.selection.getRangy().insertNode(document.createTextNode(p.escape(n))),t.set("title",a.text());else{var l,c="",d=i;a.hasClass("md-meta-block")&&0==a.text().length&&"\n​"==n?l="\n\n":(a.hasClass("md-meta-block")&&c.length==i&&"\n"==c[i-1]?i--:a.closest(".md-def-content").length?(d-=t.get("ref").length,c=a.closest(".md-def-content").textExcludeSVG()):(c=s.textExcludeSVG(),_.isType(t,M.meta_block)&&(c=c.replace(/\n$/,""))),l=void 0!==d?c.substring(0,d)+n+c.substring(d):c.text()+n),t.set("text",l.replace("​","")),s.html($(t.toHTML()).html())}r&&(e.store(t,!0),r.redo.push(E.buildReplaceUndo(t,void 0)));var u={id:t.id,type:"cursor",start:i+n.length};o&&(e.undo.exeCommand(u),e.brush.addToQueue(t.id)),r&&r.redo.push(u),e.brush.addToQueue(t.id),s=e.findElemById(t.id),o&&s.addClass("md-focus").closest("p").addClass("md-focus-p")},f=function(e,t,n,i,r){if(File.isMac)setTimeout(function(){i&&app.clipboard.clearContents(),e&&app.clipboard.copyForType(o(e)[0],"text/html"),app.clipboard.copyForType(t,"text/markhtml"),n&&app.clipboard.copyForType(n,"text/plain")},20);else if(File.isNode&&r){if("cut_before"===File._CopyContentFlag||"cut"==r.type&&e){if(!e)return setTimeout(h.getCurrentWindow().webContents.copy,30),void(File._CopyContentFlag="cut_after");I(File.editor,null,"delSelection"),File._CopyContentFlag=!1}else if("cut_after"===File._CopyContentFlag)File._CopyContentFlag=!1,e=(o(h.clipboard.readHTML())||[])[0],I(File.editor,null,"delSelection");else if(e&&!File._CopyContentFlag);else{if(!File._CopyContentFlag)return File._CopyContentFlag=!0,void(!e&&setTimeout(h.getCurrentWindow().webContents.copy,30));!0===File._CopyContentFlag&&(e=(o(h.clipboard.readHTML()||e)||[])[0]||""),File._CopyContentFlag=!1}n&&r.clipboardData.setData("text/plain",n),e&&r.clipboardData.setData("text/html",e),t&&r.clipboardData.setData("text/markhtml",t),r.preventDefault()}else File.isNode&&h.clipboard.write({html:o(e)[0]||n,text:n})},g=function(e,t,n){var i,r,o,a;return t=t||File.editor,e.find(".md-fences").toArray().map(function(e){i=e.getAttribute("cid"),(r=$(e)).attr("lang",r.attr("lang")),r.text(t.fences.getValue(i))}),n&&n.skipEmoji||e.find(".md-emoji").toArray().map(function(e){(r=$(e)).text(":"+r.attr("data-content")+":")}),e.find("[mdtype='math_block']").toArray().map(function(e){i=e.getAttribute("cid"),(r=$(e)).text(t.mathBlock.getTex(i))}),e.find(".md-math-after-sym").remove(),(o=e.children("li[cid]")).length&&((a=$(document.querySelector("[cid='"+o[0].getAttribute("cid")+"']").parentElement).clone()).empty().append(o).wrap("div"),e=a.parent()),e},a=function(e,t){/^\<(tbody|thead)/.exec(e)&&(e="<table mdtype='table'>"+e+"</table>");var n=$($.parseHTML("<div>"+e+"</div>"));return g(n,t)},m=function(e,t){e=e||File.editor;var n=document.activeElement,i=e.selection.getRangy();if(e.sourceView.inSourceMode)f(null,null,File.editor.sourceView.cm.getSelection(),!0,t);else if("HR"==n.getAttribute("mdtype"))f(null,null,"---",!0,t);else if(n.getAttribute("mdtype")!==M.math_block||i&&!i.collapsed){if("INPUT"==n.tagName||"TEXTAREA"==n.tagName||void 0!==n.tabindex)f(null,null,n.value||n.innerText,!0,t);else if(window.getSelection().rangeCount){var r,o;i.collapsed&&(r=(r=$(i.startContainer).closest(".md-table-fig")).length?a(r[0].outerHTML,e):null),r||(r=a(i.toHtml(),e)),o=r.html(),f(null,o,b(o),!0,t)}}else f(null,null,"$$\n"+e.mathBlock.getTex(n.getAttribute("cid"))+"\n$$",!0,t);File._CopyContentFlag=!1},v=function(i,r){i=i||File.editor;var e=document.activeElement,t=i.selection.getRangy();function n(e){var t=P(a(e,i).html()),n=i.export.exportCollection(t,null,!0,!0,!0);f(null,"<pre mdtype='fences' lang='HTML'>"+p.escape(n)+"</pre>",n,!0,r)}if(i.sourceView.inSourceMode)f(null,null,File.editor.sourceView.cm.getSelection(),!0,r);else if("HR"==e.getAttribute("mdtype"))f(null,null,"<hr/>",!0,r);else if(e.getAttribute("mdtype")!==M.math_block||t&&!t.collapsed)if("INPUT"==e.tagName||"TEXTAREA"==e.tagName||0==e.childElementCount){if(e.classList.contains("md-content")&&t.toString()==e.textContent){var o=$(e).closest(".md-image");if(o.length)return void n(o[0].outerHTML)}f(null,null,e.value||e.innerText,!0,r)}else window.getSelection().rangeCount&&n(t.toHtml());else f(null,null,"$$\n"+i.mathBlock.getTex(e.getAttribute("cid"))+"\n$$",!0,r)},o=function(e){if(!e)return"";var t=$.parseHTML(e||""),i="<!DOCTYPE html>",r="<!DOCTYPE html>",o=File.option.showLineNumbersForFence?"  ":"";if(!t)return["",""];t.map(function(e){var t=$(e),n=t.find(".md-emoji").andSelf(".md-emoji");n.text(function(e){return $(n[e]).children("[data-emoji]").attr("data-emoji")}),t.find(".ty-table-edit, .md-meta, .md-content").remove(),t.find("[cid].md-fences").andSelf("[cid].md-fences").html(function(){var e=this.querySelectorAll("pre");if(e.length){for(var t=[],n=0;n<e.length;n++)e[n].innerHTML&&t.push(o+e[n].innerHTML);return t.join("<br/>")}return this.innerHTML+"<br/><br/>"}),t.find(".md-line, h1, h2, h3, h4, h5, h6, .md-def-link, .md-def-footnoote").css("width",""),t.find(".md-def-name").before("[").after("]   "),i+=e.outerHTML||e.textContent,e.getAttribute&&e.getAttribute("mdtype")==M.toc||(t.find(".md-toc").remove(),t.find(".mathjax-block").andSelf(".mathjax-block").html(function(){try{return File.editor.findElemById(this.getAttribute("cid")).find("script").text()}catch(e){return""}}).css("font-size","1rem"),t.find(".md-line").oldReplaceWith(function(){return this.innerHTML+(this.nextSibling?"\n":"")}),t.find("li p").oldReplaceWith(function(){return this.innerHTML+(this.nextSibling?"\n":"")}),t.find("ul, ol, .md-def-link, .md-def-footnoote, blockquote, .md-fences, .mathjax-block").after("<br/>"),t.find(".md-def-name").before("[").after("]   "),r+=e.outerHTML||e.textContent,_.isType(e.tagName,"UL","OL")&&(r+="<br/>"))});return[i,r]};function y(e,t,n,i){t||(c.reset(!0),t=c);var r,o,a=$($.parseHTML("<div>"+e+"</div>")[0]),s=[],l=a.children("[mdtype]");return l.length?(l.each(function(){(o=_.reverse($(this),t,n,i)).set("before",r),r=o,s.push(o)}),s):n?(a.find("[data-emoji]").text(function(){return this.getAttribute("data-emoji")}),a.find(".md-meta, .md-content").remove(),a.text()):a.textExcludeSVG()}function P(e,t,n,i,r){var o=y(e,t,!1,r);if(_.isType(o[0],M.line)){var a=new _({type:M.paragraph,in:o[0].get("in")});return o.map(function(e){a.append(e)}),[a]}return o}var c=new F.NodeMap;function b(e){var t=P(e,void 0,0,0,!0);return"string"==typeof t?t:_.markFromArr(t)}var s=function(m,e,t,o){function p(e,t){return e.get("attr")&&e.get("attr").trim().length?e.get("attr"):void 0}function h(e,t,n,i){var r=m.tableEdit.TableEdit;function o(e,t,n,i){var r=e.safeGetStrAttr("text"),o=function n(e){return _.isType(e,_.TYPE.line,_.TYPE.heading,_.TYPE.raw_edit,_.TYPE.fences,_.TYPE.table_cell)?e.get("text"):(!_.isType(e,M.def_footnote)||p(e)&&p(e))&&(!_.isType(e,M.def_link)||p(e)&&p(e))?e.get("children").toArray().reduce(function(e,t){return e+n(t)}," "):p(blocks[0])||p(blocks[0])||p(blocks[0])||p(blocks[0])||""}(n).replace(/\r?\n/g," ");return e.set("text",r.substr(0,t)+o+r.substr(t)),t+o.length}var a,s=e.get("parent").get("parent"),l=e,c=l;i.undo.push(E.buildReplaceUndo(s));var d=[];n.forEach(function(e,t){e.get("type")==M.table?d=d.concat(function(e){for(var t,n=e.getFirstChild().getFirstChild(),i=[];n;)t=n,i.push(n),n=r.getSibling(n),t.detach();return e.remove(),i}(e)):d.push(e)});for(var u=0;u<d.length&&l;u++)a=o(l,0===u?t:0,d[u]),c=l,l=_.isType(d[u],M.table_cell)?r.getSibling(l,!1,!0):r.getNextCellInColumn(l);m.findElemById(s.id).replaceWith(s.toHTML()),i.redo.push(E.buildReplaceUndo(s)),void 0!==a?m.selection.jumpInto(m.findElemById(c.id),a):m.selection.jumpIntoElemEnd(m.findElemById(c.id)),i.redo.push(m.selection.buildUndo())}function f(e,t,n,i){if(!o)try{var r=m.selection.restoreEdge(m.findElemById(e),t);void 0!==i?r=m.selection.restoreEdge(m.findElemById(n),i,!0,r):r.setEndAfter(m.findElemById(n)[0]||m.findElemById(e)[0]),m.imgEdit.tryMoveImageInRange(r)}catch(e){console.error(e)}}function n(e,t,n,i,r){n.undo.push(m.selection.buildUndo());var o=r(i,m.nodeMap,m,L);if("string"==typeof o)return g(e,t,o,n);if(0!=o.length){if(_.isType(e,M.table_cell))h(e,t,o,n);else if(_.isType(e,M.table_row,M.table));else{var a=e.getClosetBlock();_.isType(a.get("parent"),M.list_item)?n.undo.push(m.undo.buildReplaceUndo(a.get("parent"))):n.undo.push(m.undo.buildReplaceUndo(a));var s=e===m.nodeMap.getFirst()&&0===t,l=[];o.map(function(e,t){_.isType(e,M.meta_block)&&(0!=t||!s)&&l.push(e)}),l.map(function(e){o.remove(e)});var c=_.splitAt(e,t,m,_.genNormalSplitExitFunc(!1,!1,!0));if(y(c.prev,c.next,o,n,c.opt_prev,c.opt_next),c.prev&&o.last())try{var d=c.prev.isDeleted()?o[0]:c.prev,u=o.last();!c.prev.isDeleted()&&_.isType(c.prev,M.list_item)&&(u.isDeleted()||c.prev.contains(o.last()))&&(d=c.prev.getVeryFirst()),f(d.getVeryFirst(!0,!1).cid,t,o.last().cid,void 0)}catch(e){console.stackError(e)}}m.undo.register(n)}}function v(e,t,n){var i=e.canContainBlock()?e.getLastChild():e,r=t.canContainBlock()?t.getFirstChild():t,o=-1;if(!r.canContainBlock()){var a=r.getVeryFirst(),s=i.getVeryFirst(!0);o=s.get("text").length,s.set("text",s.get("text")+a.get("text")),0==o&&_.isType(i,M.paragraph)&&1==i.get("children").length&&!_.isType(a,M.line)&&(_.property.map(function(e){i.set(e,a.get(e))}),i.set("text",s.get("text")),s.remove()),a.remove(),r.isDeleted()||(0==r.get("children").length?r.remove():_.isType(r,M.paragraph)&&_.isType(i,M.paragraph)&&(i.getLastChild().insertTillEnd(r.getFirstChild()),r.remove())),r.isDeleted()||0!=r.get("children").length||r.remove()}return r.isDeleted()||(i.insert(r),_.isEmptyBlock(i)&&i.remove()),t.isDeleted()||(0==t.get("children").length?t.remove():_.isType(t,M.list_item)?(e.getLastChild().insertTillEnd(t.getFirstChild()),t.remove()):_.isType(t,M.paragraph)&&_.isType(e,M.paragraph)&&(e.getLastChild().insertTillEnd(t.getFirstChild()),t.remove())),n&&n.redo.push(E.buildReplaceUndo(e)),o}function g(e,t,n,i){var r=n.split(/\r?\n/g);if(1<r.length&&!r[0].trim().length&&r[1].trim().length&&(r=r.slice(1)),_.noChangeLine(e)&&(r=[r[0]]),r.length<=1||-1<A.CONST.NoInline.indexOf(e.get("type")))R(m,e,r.join("\n"),t,i,!0),m.undo.register(i);else{i.undo.push(m.selection.buildUndo()),i.undo.push(E.buildReplaceUndo(e.getClosetParagraphLevel()));var o=_.splitAt(e,t,m,_.genNormalSplitExitFunc(!1,!1,!0)),a=_.parseFrom(r.join("\n"),o.prev.get("in"),{noTop:!o.prev.get("attachTo")||t,skips:{old_code:!1,pass_format:!0}},!0);y(o.prev,o.next,a[1],i,o.opt_prev,o.opt_next),m.undo.register(i)}f(e.cid,t,e.cid,t+n.length)}function y(e,s,l,c,d,u){var p,h=e.id,f=l.slice(0),g=-1;l=function(e){for(var t=[],n=-2,i=0;i<e.length;i++){var r=e[i];_.isType(r,M.table_cell)?(n!==i-1?(r.set("type",M.paragraph),t.push(r)):(t.last().set("text",t.last().get("text")+"  "+r.get("text")),r.remove()),n=i):t.push(r)}return t}(l),p=l.last().getVeryFirst(!0),(_.isEmptyBlock(s)||_.isType(s,M.list_item)&&1==s.get("children").length&&_.isEmptyBlock(s.getFirstChild()))&&s.remove(),_.isType(e,M.blockquote,M.list)||(!function(e){if(_.isType(e,M.list_item))i=e,o=i.get("after"),a=i.get("parent"),c.undo.push(E.buildReplaceUndo(i)),_.isType(l[0],M.list)?(h=i.id,i.insert(l[0]),f=l[0].unwrap().clone(),v(i,f.shift(),c),f.length&&E.addUndoForInsertArray(c,f),f.unshift(i),l.shift(),s.isDeleted()||(g=v(f.last().getVeryFirst(!0,!0),s,c))):function(e){for(var t=1;t<e.length;t++)if(e[t].get("type")!=e[t-1].get("type"))return!1;return!0}(l)&&_.isType(l[0],M.list_item)?(i.insertArray(l,!1,!0),v(i,l.shift(),c),(f=l.clone()).length&&E.addUndoForInsertArray(c,f),f.unshift(i),s.isDeleted()||(g=v(f.last().getVeryFirst(!0,!0),s,c))):(o=new _({type:M.list_item}),i.insert(o),l.map(function(e){o.append(e)}),v(i,o,c),f=[i],l=[]),!s.isDeleted()&&f.push(s),l.length?(h=a.cid,a.insertArray(l,!1,!0),f=(f=[a]).concat(l),o&&(h=a.cid,c.undo.push(E.buildReplaceUndo(a)),a.unset("ahead"),a.unset("tail"),(r=a.clone()).unset("start"),a.giveChildrenTo(r,o,null,!0),l.last().insert(r),f.push(r)),d=u=null):p=f.last();else{c.redo.push(E.buildReplaceUndo(e)),1==l.length&&_.isType(l[0],M.blockquote)&&_.isType(e.get("parent"),M.blockquote)?(e.insert(l[0]),l=l[0].unwrap(),(f=l.slice(0)).unshift(e)):(e.insertArray(l,!1,!0),f=[e].concat(l));var t,n=e.get("after");_.isType(n,M.table)||(e.canContainBlock()||!n||n.canContainBlock()||(v(e,n,c),n.isDeleted()&&(l.remove(n),f.remove(n))),t=f.last().getVeryFirst(!0,!0),s.isDeleted()||s.canContainBlock()||t.canContainBlock()||(p=t.getVeryFirst(!0),g=v(t,s,c))),l.length&&E.addUndoForInsertArray(c,l),_.isEmptyBlock(e)&&!n.isDeleted()&&(E.addUndoForRemove(c,e),e.remove(),f.remove(e)),d&&f.unshift(d),!s.isDeleted()&&f.push(s),g<0&&(p=f.last()),u&&f.push(u)}var i,r,o,a}(e),s.isDeleted()||E.addUndoForInsert(c,s),d&&E.addUndoForInsert(c,d),u&&E.addUndoForInsert(c,u),m.findElemById(h).replaceWith(F.NodeCollectionUtils.toHTML(f)),0<=g?m.selection.jumpInto(m.findElemById(p.cid),g):p==s?m.selection.jumpIntoElemBegin(m.findElemById(s.cid)):m.selection.jumpIntoElemEnd(m.findElemById(p.getVeryFirst(!0).cid)),c.redo.push(m.selection.buildUndo()),setTimeout(function(){m.refresh(),m.selection.scrollAdjust()},100))}L="",File._PasteContentFlag=!1;var i="string"!=typeof e||t?null:e,r="string"==typeof e&&t?e:null,a="object"==typeof e?e:null;if("INPUT"==document.activeElement.tagName)return!0;if("TEXTAREA"==document.activeElement.tagName){if(!a&&r){var s=$(document.activeElement).closest(".CodeMirror");s&&(s=s[0].CodeMirror).replaceSelection(r)}return!0}if(_.isType(w,M.hr))return!1;if("BODY"==document.activeElement.tagName)return!1;m.undo.completeSnap(!0);var l,c,d,u=m.selection.prepNode("​",null,!0)||E.makeEmptyCommand(),b=m.getMarkElem(),w=m.findNodeByElem(b),x=File.isNode?reqnode("electron").remote.app:window.app;if(a){if(a.preventDefault(),(r=a.clipboardData.getData("text/plain"))&&(r=r.replace(/(\r?\n)$/,"")),i=a.clipboardData.getData("text/html"),d=a.clipboardData.getData("text/markhtml"),File.isMac&&!i&&!d){var C=x.clipboard.getHTML()||["",""];i=C[0],L=C[1]}}else r||i||File.isMac&&(r=x.clipboard.paste());if(File.isMac&&!i&&!d&&!t){var k=x.clipboard.getImage();if(k&&k.length)return D(m,k),m.selection.scrollAdjust(),!1}if(File.isNode&&!i&&!d&&!t){var S=reqnode("electron").clipboard.readImage();if(!S.isEmpty()){var T=m.imgEdit.getTagetImageStorageFolder()||x.getPath("temp");return m.imgEdit.prepImageMove(T).then(function(){var e=reqnode("path").join(T,Number(new Date)+".png");reqnode("fs").writeFileSync(e,S.toPNG()),D(m,[e]),m.selection.scrollAdjust()}),!1}}u.undo.push(m.selection.buildUndo()),u=E.append(u,I(m,a,"delSelection",!0)),w=m.findNodeByElem(m.getMarkElem()),c=(l=m.selection.getRangy()).getBookmark(m.findElemById(w.id)[0]).start,t=t||l.startContainer&&$(m.getJQueryElem(l.startContainer)).closest(".md-def-url, .md-def-name, .md-def-title, pre, code").length,d&&!t?(o=!0,n(w,c,u,d,P)):i&&!t?n(w,c,u,i,N.parseHTML):g(w,c,r,u),m.selection.scrollAdjust()},l=function(e,t){if(!File.isNode||!File.isLocked){var n=(t=t||File.editor).getMarkElem(),i=t.findNodeByElem(n).getClosetBlock(),r=new _({type:M.paragraph}),o=E.makeEmptyCommand(t.selection.buildUndo());i.insert(r,e);var a=r.append(new _({type:M.line,text:""}));E.addUndoForInsert(o,r),e?t.findElemById(i.cid).before(r.toHTML()):t.findElemById(i.cid).after(r.toHTML()),t.selection.jumpIntoElemBegin(t.findElemById(a.cid)),o.redo.push(t.selection.buildUndo()),t.undo.register(o),t.refocus()}},D=function(n,e){if(window.app){if(app.document.isLocked())return}else if(File.isLocked)return!1;if(!n.sourceView.inSourceMode){e.length;e.forEach(function(e,t){t&&l(!1,n),d(n,e)})}},d=function(e,t){if(!t)return!0;if(/\.(png|jpe?g|svg|gif|bmp|webp|tiff)$/gi.exec(t))return e.imgEdit.doInsertFromURL(t),!0;var n=r.getFileNameFromPath(t),i=(t=p.getRelativePath(r.getCurrentFileFolderPath(),t),"["+n.replace(/(^|[^\\])]/,"$1\\]")+"]("+t.replace(/(^|[^\\])\)/,"$1\\)")+")");return s(e,i,!0),!1};t.getMarkdownSourceFrom=b,t.copyAsMarkdown=m,t.copyAsHTMLSource=v,t.copyHandler=function(e,t){if("copyAsMarkdown"===File._CopyContentFlag)return m(e,t);if("copyAsHTMLSource"===File._CopyContentFlag)return v(e,t);var n,i,r=document.activeElement,o=e.selection.getRangy();if(e.sourceView.inSourceMode&&f(null,null,File.editor.sourceView.cm.getSelection(),!0,t),"hr"==r.getAttribute("mdtype"))f(r.outerHTML,null,"---",!0,t);else if("toc"==r.getAttribute("mdtype"))f(r.outerHTML,"<div mdtype='toc'><div>","[toc]",!0,t);else if("IMG"==r.tagName)f(r.outerHTML,null,r.getAttribute("src")||"",!0,t);else if(r.getAttribute("mdtype")!==M.math_block||o&&!o.collapsed){if("INPUT"==r.tagName||"TEXTAREA"==r.tagName)return t||console.sendError("in copyHandler : shouldn't be here"),!0;if(window.getSelection().rangeCount){if(!File._CopyContentFlag&&File.isNode)return File._CopyContentFlag=!0,h.clipboard.writeHTML(""),void setTimeout(h.getCurrentWindow().webContents.copy,0);var a=o.toHtml(),s=$($.parseHTML("<div>"+a+"</div>"));s.find(".md-emoji").text(function(){return u.data[this.getAttribute("data-content")]}),s.find(".math-jax-postprocess").text(function(){return this.querySelector("script").textContent.replace(/\u200B*/g,"")}).parent().addClass("md-expand");var l=(s=g(s,e,{skipEmoji:!File.option.copyMarkdownByDefault})).html(),c=File.option.copyMarkdownByDefault?b(l):(n=l,i=y(n,null,!0),"string"==typeof i?i:N.convertToPlain(i)).replace(/\u200B/gi,"");f(null,l,c,!1,t)}}else{var d=e.mathBlock.getTex(r.getAttribute("cid"));f(r.querySelector(".MathJax_Display").outerHTML,"<div mdtype='"+M.math_block+"'>"+d+"</div>",d,!0,t)}},t.insertInlineText=R,t.pasteHandler=s,t.setClipboard=f,t.insertURLs=D,t.prepMarkHtml=a,t.insertParagraph=l,t.insertDom=function(e){File.editor.focusAndRestorePos(),s(File.editor,$("<div>").append(e).html(),!1)},t.processClipboardHTML=o}),define("app/editor/DocMenu",["app/document/StringUtils","exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileHelper","app/editor/UndoManager","app/editor/Emoji","app/editor/Selection","rangy/rangy-core","codemirror/lib/codemirror","app/editor/UndoManager","app/editor/Inline"],function(e,t,n){"use strict";var o,i=e("app/document/StringUtils"),r=e("exoskeleton-master/exoskeleton"),a=e("app/document/Node"),s=a.Node,l=a.TYPE,h=e("jquery/jquery"),c=e("app/document/MarkParser"),d=(e("app/editor/Selection").rangy,e("app/window/FileHelper")),f=e("app/editor/UndoManager"),u=window.reqnode?reqnode("electron").remote:null,p=e("app/editor/Inline"),g=u?u.app:window.app,m=r.Collection.extend({model:s,getNodeByRef:function(e){for(var t in this.models)if(this.models.hasOwnProperty(t)){var n=this.models[t];if(i.escape(n.get("ref")).toLowerCase()==i.escape(e).toLowerCase())return n}},getFootHTMLByRef:function(e,t){var n=this.getNodeByRef(e);return n?(t&&File.editor.store(n.cid,!0),"<div class='code-tooltip md-tooltip-remove md-hover-tip md-f-tooltip' contenteditable='false'><div class='md-arrow' /><div class='code-tooltip-content'>"+editor.brush.inline.output(n.get("text"))+"</div></div>"):null},getHrefByRef:function(e,t){var n=this.getNodeByRef(e);return n&&t&&File.editor.store(n.cid,!0),n?i.escape(n.get("href")):void 0}}),v=function(e){switch(e.type){case l.strong:return"<strong>"+e.inner+"</strong>";case l.em:return"<em>"+e.inner+"</em>";case l.code:return"<code>"+i.escape(e.text)+"</code>";case l.plain:return e.text;case l.tag:return"";case l.imgtag:case l.refimg:case l.image:case l.inline_math:return p.decorateAsExport(e,{forPrint:!0});case l.underline:return"<u>"+e.inner+"</u>";case l.del:return"<del>"+e.inner+"</del>";case l.footnote:return"";case l.escape:return e.text;case l.highlight:return"<mark>"+e.inner+"</mark>";case l.superscript:return"<sup>"+e.inner+"</sup>";case l.subscript:return"<sub>"+e.inner+"</sub>";case l.linebreak:return"";default:return e.inner||e.text||""}};function y(e,t){for(var n=e.find(".outline-item-wrapper"),i=0;i<n.length;i++)n[i].querySelector(".outline-item-wrapper")?t&&n[i].classList.contains("outline-h1")&&n[i].classList.add("outline-item-open"):n[i].classList.add("outline-item-signle")}function b(){return o||(o=new c.InlineLexer(null,v)),o}var w=r.Model.extend({initialize:function(e){this.nodeMap=e,this.refresh(),this.delay=300,this.refreshTimeout=null},remove:function(e){var t=this.headers.indexOf(e);-1<t&&this.headers.splice(t,1)},updateHeaderText:function(e){if(!this.refreshTimeout&&!File._onInitPars&&-1!=this.headers.indexOf(e)){var t=o.output(e.get("text"));h(".md-toc-item[data-ref='"+e.cid+"']").children(".md-toc-inner").html(t),h("#outline-content .outline-label[data-ref='"+e.cid+"']").html(t)}},refresh:function(e,t){if(!File._onInitParse){var n=this;this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=null,e?i.call(n):this.refreshTimeout=setTimeout(function(){i.call(n)},this.delay)}function i(){var e=this.nodeMap.getFirst();for(this.headers=[];e;)s.isType(e,s.TYPE.heading)?this.headers.push(e):File.option.expandSimpleBlock&&s.isType(e,s.TYPE.paragraph)&&e.get("depth")&&this.headers.push(e),e=e.get("after");!t&&this.updateHTML(),this.refreshTimeout=null}},getTocInnerHTML:function(){var i="";return(this.headers||[]).map(function(e){var t,n;e.isDeleted()||(i+=(n=(t=e).get("text"),s.isType(t,s.TYPE.paragraph)&&(n=t.getText().replace(/^#+\s*/,"").replace(/\n.*/,"")),"<span class='md-toc-item md-toc-h"+t.get("depth")+"' data-ref='"+t.cid+"'><a class='md-toc-inner'>"+o.output(n)+"</a></span>"))}),i},updateHTML:function(){var e=0,t=document.querySelectorAll(".md-toc-content");if(0<t.length){var n=this.getTocInnerHTML();for(e=0;e<t.length;e++)t[e].innerHTML!=n&&(t[e].innerHTML=n)}this.updateOutlineHtml()},updateOutlineHtml:function(){if(document.body.classList.contains("pin-outline")){var n=document.querySelector("#outline-content"),e=C(this),t=n.scrollTop,i=!document.body.classList.contains(".no-collapse-outline"),r=[],o=0==n.innerHTML.trim().length;if(a=n.innerHTML,s=e,l=h(h.parseHTML("<div>"+a+"<div>")[0]),c=h(h.parseHTML("<div>"+s+"<div>")[0]),l.find(".outline-item-open, .outline-active").removeClass("outline-item-open").removeClass("outline-active"),c.find(".outline-item-open, .outline-active").removeClass("outline-item-open").removeClass("outline-active"),l.html()==c.html())return;i&&!o&&h(n).find(".outline-item-open>.outline-item>.outline-label").map(function(){r.push(this.getAttribute("data-ref"))}),n.innerHTML=C(this),n.scrollTop=t,i&&(y(h(n)),h(n.querySelector(".outline-active")).parents(".outline-item-wrapper:not(.outline-item-signle)").addClass("outline-item-open"),o?1==n.children.length&&n.children[0].classList.add("outline-item-open"):r.forEach(function(e){var t=n.querySelector("[data-ref='"+e+"']");t&&((t=t.parentElement.parentElement).classList.contains("outline-item-signle")||t.classList.add("outline-item-open"))})),File.editor.docMenu.highlightVisibleHeader()}var a,s,l,c}}),x=null,C=function(e){var r="",o=[],a=b();try{!function(e){for(var t=0;t<e.length;t++)if(!e[t].isDeleted()){i=e[t],r+="<li class='outline-item-wrapper outline-h"+i.get("depth")+"'><div class='outline-item'><span class='outline-expander'></span><span class='outline-label' data-ref='"+i.cid+"'>"+a.output(i.get("text"))+"</span></div><ul class='outline-children'>",o.push(i.get("depth"));var n=e[t+1]&&!e[t+1].isDeleted()?e[t+1].get("depth"):1;if(n<=e[t].get("depth"))for(;o.last()&&o.last()>=n;)r+="</ul></li>",o.pop()}var i}(e.headers)}catch(e){window.debugMode&&console.warn(e.stack),r=""}return r},k=r.Model.extend({initialize:function(i){var r=this;b(),this.headerStr="h1, h2, h3, h4, h5, h6, [mdlike='h1'], [mdlike='h2'], [mdlike='h3'], [mdlike='h4'], [mdlike='h5'], [mdlike='h6']",this.expandedOutlineItem=[],i.nodeMap.foot_list=new m,i.nodeMap.link_list=new m,i.nodeMap.toc=new w(i.nodeMap),this.editor=i,function(){var e,t,n=r.editor;function i(){e=!1,setTimeout(function(){e||h(".md-f-tooltip").remove()},500)}setTimeout(function(){h(document).on("mouseenter mousemove",".md-footnote",function(){if(!e||t!==n.focusCid){if(window.getSelection().anchorNode&&this.contains(window.getSelection().anchorNode.parentElement))return;e=!0,t=n.focusCid,r.showTooltipForSup(h(this))}}).on("mouseleave",".md-footnote",i).on("mouseenter",".md-f-tooltip",function(){e=!0}).on("mouseleave",".md-f-tooltip",i)},300)}(),h(document).on("mousedown",".md-toc-inner",function(e){if(1===e.which){var t=this.parentElement.getAttribute("data-ref"),n=i.findElemById(t);return i.store(),i.undo.completeSnap(!0),i.selection.jumpIntoElemEnd(n),i.selection.scrollAdjust(n,10),!1}}).on("mousedown",".md-delete-toc",function(e){1===e.which&&i.UserOp.deleteSelectable(i,h(this).closest(".md-toc"))}).on("click","#md-notification .close-btn",function(e){h("#md-notification").hide()}),h(document).on("click",".outline-expander",function(e){var t=this.nextElementSibling.getAttribute("data-ref");h(".outline-label[data-ref='"+t+"']").parent().parent().toggleClass("outline-item-open")}).on("click",".outline-label",function(e){var t=this.getAttribute("data-ref"),n=i.findElemById(t);return i.undo.completeSnap(!0),r.autoHideOutline(),i.focusAndRestorePos(),i.selection.scrollAdjust(n,10),File.isFocusMode&&i.updateFocusMode(!1),!1}).on("mousewheel","#sidebar-content",function(e){x&&clearTimeout(x)}).on("mousewheel","content",function(e){if(document.querySelector(".dropmenu.open")&&!File.editor.sourceView.inSourceMode){var t=h(i.sessionStr).children(r.headerStr);100<t.length?(x&&clearTimeout(x),x=setTimeout(r.highlightVisibleHeader.bind(r),30)):(r.highlightVisibleHeader(t),x&&clearTimeout(x),x=setTimeout(r.highlightVisibleHeader.bind(r),100))}}).on("click","#close-outline-btn, #close-sidebar-btn",function(){return i.focusAndRestorePos(),r.hideOutline(),!1}).on("click","#pin-outline-btn",function(){return i.focusAndRestorePos(),i.library.showSidebar("outline"),!1}).on("click","#unpin-outline-btn",function(){return i.focusAndRestorePos(),i.library.hideSidebar(),r.showOutline(),!1})},highlightVisibleHeader:function(e,t){if(document.querySelector("#typora-sidebar.open")){var r=this,n=this.editor,i=e||h(n.sessionStr).children(this.headerStr),o=0,a=i.length-1,s=void 0===t?null:t;if(i.length){for(o=1===d(i[i.length-1])?0:i.length-1;1<a-o&&null==s;){var l=Math.floor((o+a)/2),c=d(i[l]);1==c?a=l:-1==c?o=l:s=u(l)}null==s&&(s=o),s<i.length&&function(e){if((!r.editor.library||r.editor.library.isOutlineShown())&&e.length){var t,n,i=h("#outline-content:visible")[0];i&&(File.isNodeHtml||(i=i.parentElement),(t=e.offset().top-h(i).offset().top)<0?n=t-200+i.scrollTop:t>i.offsetHeight-20&&(n=t+200-i.offsetHeight+i.scrollTop),void 0!==n&&(i.scrollTop=n))}}(h("#outline-content .outline-label").removeClass("outline-active").filter("[data-ref='"+i[s].getAttribute("cid")+"']").addClass("outline-active"))}x=null}function d(e){var t=h("content").scrollTop(),n=e.offsetTop;return n<t?-1:n>t+window.innerHeight?1:0}function u(e){for(e--;i[e]&&0==d(i[e]);)e--;return e+1}},getAttrByElem:function(e){return e.hasClass("md-def-name")?"ref":e.hasClass("md-def-content")?e.hasClass("md-def-url")?"href":"text":e.hasClass("md-def-title")?"title":void 0},addEmptyDef:function(i,r){var o=this.editor;function e(e){var t=o.findNodeByElem(e),n=o.undo.UndoManager.makeEmptyCommand();t.insert(new s({type:r,ref:i,url:"",text:""})),o.undo.UndoManager.addUndoForInsert(n,t.get("after")),e.after(t.get("after").toHTML()),o.selection.jumpIntoElemBegin(e.next().find(".md-def-content")),n.redo.push(o.selection.buildUndo()),o.undo.register(n),o.refocus()}var t=h(o.sessionStr).find(r==s.TYPE.def_link?".md-def-link":".md-def-footnote").last();!t.length||t.nextAll(":not(.footnotes)").length?e(h(o.sessionStr).children().last()):e(t)},resizeFooter:function(){},showTooltipForSup:function(e){var t,n,i=this.editor;if(e.length){var r=e.find(".md-text").text();t=i.nodeMap.foot_list.getFootHTMLByRef(r,!0),h(".md-tooltip-remove").remove(),t?(n=h(h.parseHTML(t)[0]),h("body").append(n)):File.isLocked||(t="<div class='code-tooltip md-tooltip-remove md-hover-tip md-f-tooltip' contenteditable='false'><div class='md-arrow' /><div class='code-tooltip-content'><span class='fa text-warning fa-exclamation-triangle' title='warning' aria-hidden='true' /> "+h.localize.getString("Need to define the reference footnote <b>{0}</b> with syntax <a>[^{1}]: www.example.com</a>").format(r,r).trim()+" </div></div>",n=h(h.parseHTML(t)[0]),h("body").append(n),n.find(".code-tooltip-content a").unbind("click").click(function(){i.docMenu.addEmptyDef(r,a.TYPE.def_footnote)})),this.editor.EditHelper.fixPopoverPosition(e,n)}},getLocalRootUrl:function(e){var t=this.getMetaNode();if(e=e||"img",t){var n=(/^\s*typora-root-url\s*:\s*(.*)$/im.exec(t.get("text"))||[])[1];if(n){var i=d.getCurrentFileFolderPath();return i?File.isMac?g.path.resolvePathRelateTo(n,i):reqnode("path").resolve(i,n):n}}return null},buildMetaMap:function(){var t,n,e=this.getMetaNode(),i=/^\s*([^:]+)\s*:\s*(.*)$/,r=/^\s#/,o={};function a(e){return e.replace(/(^\s*['"]*)(['"]*\s*$)/,"")}return e&&((e.get("text")||"").split(/\r|\n|\r\n/g).forEach(function(e){e.match(r)||((n=i.exec(e))?(t=n[1],o[t]=n[2].replace(/^\s*[|>]\s*/,"")):t&&(o[t]+="\n"+e.trim()))}),Object.keys(o).forEach(function(e){o[e].match(/^\s*-/)?o[e]=o[e].split(/(^|\n+)\s*-/g).filter(function(e){return e.match(/\S/)}).map(function(e){return a(e)}):(n=o[e].match(/^\s*\[(.*)\]\s*$/))?o[e]=n[1].split(/\s*,\s*/).map(a):o[e]=a(o[e])})),o},getMetaNode:function(){this.editor.undo&&this.editor.undo.completeSnap(!0);var e=this.editor.nodeMap.getFirst();return s.isType(e,l.meta_block)?e:null},getValueInMeta:function(e,t){if(t=t||this.getMetaNode()){var n=(new RegExp("^s*"+e+"s*:s*(.*)$","mi").exec(t.get("text"))||[])[1];return n?n.trim():n}return null},renderOutline:function(){var e=C(this.editor.nodeMap.toc),t=h(".outline-content");if(t.html(e),y(t,!0),this.editor.inlineMath&&this.editor.inlineMath.renderInToc(),this.expandedOutlineItem)this.expandedOutlineItem.forEach(function(e){try{t.find("[data-ref='"+e+"']").parent().parent().addClass("outline-item-open")}catch(e){}}),this.expandedOutlineItem=null;else{var n=t.children();n.length<20&&n.addClass(".outline-item-open")}},showOutline:function(e){this.editor.library.isSidebarShown()?h("#toc-content").html(h("#outline-content").html()).find(".outline-active").removeClass("outline-active"):this.renderOutline(),h(".dropdown-menu.open, .dropdown-menu.show").removeClass("open").removeClass("show"),document.querySelector("#toc-dropmenu").classList.add("open")},storeOutline:function(){this.expandedOutlineItem=[];for(var e=document.querySelectorAll(".outline-item-open:not(.outline-h1)>.outline-item>.outline-label"),t=0;t<e.length;t++)this.expandedOutlineItem.push(e[t].getAttribute("data-ref"));return this.expandedOutlineItem},hideOutline:function(e){this.storeOutline(),document.querySelector("#toc-dropmenu").classList.remove("open")},autoHideOutline:function(){document.querySelector("#toc-dropmenu").classList.contains("open")&&this.hideOutline()},toggleOutline:function(){document.querySelector("#toc-dropmenu.open")?this.hideOutline():this.showOutline()},getHeaderMatrix:function(i){var r=[];return this.editor.nodeMap.toc.headers.map(function(e){var t=e.get("type")==l.heading?e.get("text"):e.getText().replace(/(^#+)|(#+$)/g,""),n=o.output(t);i&&(n=h.parseHTML("<div>"+n+"<div>")[0].textContent),r.push([e.get("depth")-0,n,e.cid])}),r},writeProperty:function(e,t){this.editor.undo.completeSnap(!0);var n=this.editor.docMenu.getMetaNode(),i=this.editor.selection.buildUndo()||{},r=f.makeEmptyCommand(i),o=e+": "+t,a=n&&i&&(i.id||i.startId)==n.id,s=h.extend({},i),l=0;if(n){r.undo.push(f.buildReplaceUndo(n));var c=n.get("text"),d=S(e,c);if(d){s.start>d.index+d[0].length?l=o.length-d[0].length:s.start>d.index&&(l=s.start-d.index+o.length),s.end=s.start=s.start-l;var u=new RegExp("^s*"+e+"s*:s*(.*)$","mi");n.set("text",c.replace(u,o))}else n.set("text",c?c.replace(/\n?$/,"\n"+o):o);r.redo.push(f.buildReplaceUndo(n)),this.editor.findElemById(n.cid).replaceWith(n.toHTML()),a&&this.editor.undo.exeCommand(s)}else{var p=this.editor.stylize.insertMetaBlock(!0,o);n=p.node,f.append(r,p.command),this.editor.findElemById(n.get("after").cid).before(n.toHTML())}r.redo.push(s),this.editor.undo.register(r)},removeProperty:function(e,t){this.editor.undo.completeSnap(!0);var n=this.editor.docMenu.getMetaNode(),i=this.editor.selection.buildUndo(),r=f.makeEmptyCommand(i),o=(i.id||i.startId)==n.id,a=new RegExp("^s*"+e+"s*:s*(.*)$","mi"),s=h.extend({},i),l=0;if(n){if(r.undo.push(f.buildReplaceUndo(n)),o){var c=S(e,n.get("text"));c&&(s.start>c.index+c[0].length?l=c[0].length:s.start>c.index&&(l=s.start-c.index),s.end=s.start=s.start-l)}n.set("text",n.get("text").replace(a,"")),r.redo.push(f.buildReplaceUndo(n)),this.editor.findElemById(n.cid).replaceWith(n.toHTML()),r.redo.push(s),o&&this.editor.undo.exeCommand(s),!t&&this.editor.undo.register(r)}return r}});function S(e,t){return new RegExp("^s*"+e+"s*:s*(.*)$","mig").exec(t)}n.exports=k}),define("app/editor/SearchPanel",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","rangy/rangy-core","app/editor/KeyMaster","codemirror/lib/codemirror","app/document/Node","rangy/rangy-classapplier"],function(e,t,n){"use strict";var f=e("exoskeleton-master/exoskeleton"),i=e("app/document/StringUtils"),g=e("rangy/rangy-core.js"),r=e("app/editor/KeyMaster"),a=e("codemirror/lib/codemirror"),o=e("app/document/Node"),s=window.Node,l=o.Node,c=o.TYPE,m=(e("rangy/rangy-classapplier"),/[A-Za-z_\\u00C0-\\u024f]/i);function v(e,t){return new RegExp(i.escapeRegExp(e)+(t.wholeWord?"(?![A-Za-z_\\u00C0-\\u024f])":""),t.caseSensitive?"g":"gi")}var y=null;var d=f.Model.extend({initialize:function(e){this.editor=e,this.bindEvents(),this.curSel=null,this.searchTimer,this.applier=g.createClassApplier("md-search-hit"),this.selectApplier=g.createClassApplier("md-search-select")},bindEvents:function(){var t,o=this,n=!1,i=r.map;!File.isMac&&!File.isNode&&r("command+f, ctrl+f",function(e){o.showPanel(),e.preventDefault()}),!File.isMac&&!File.isNode&&r("command+h, ctrl+h",function(e){o.showPanel(!0),e.preventDefault()}),$(document.body).on("keydown",function(e){var t=event.keyCode||event.which;if("Esc"==i[t]&&o.isOpen)return o.closePanel(),!1}).on("mouseup",".md-search-hit",function(){o.closePanel(!1,$(this))}).on("mouseup",".cm-search-hit",function(e){var t=$(e.target).closest(".CodeMirror")[0].CodeMirror,n=a.posFromMouse(t,e),i=t.indexFromPos(n),r=o.searchStatus.hits.find(function(e){return e.isCm==t&&e.start<=i&&e.end>=i});if(o.closePanel(!0),r)return t.doc.setSelection(t.posFromIndex(r.start),t.posFromIndex(r.end)),!1}).on("mouseup",".CodeMirror",function(e){o.closePanel(!0)}),$("#md-searchpanel").on("blur",function(){o.closePanel()}).on("click",".close-btn .glyphicon-remove",function(){o.closePanel()}).on("keydown","input",function(){var e=event.keyCode||event.which;if("Esc"==i[e])return o.closePanel(),!1}).on("keydown","#search-panel-input",function(){var e=event.keyCode||event.which;return"Enter"==i[e]?(o.highlightNext(),!1):"Tab"==i[e]?($("#md-searchpanel.searchpanel-replace-mode").length?$("#search-panel-replace-input").focus():this.value+="\t",!1):void 0}).on("keyup","#search-panel-input",function(){var e=event.keyCode||event.which;(n=n&&!(String.fromCharCode(e).match(/\s|[0-9]/g)||"Enter"==i[e]))||t==$(this).val()||(t=$(this).val(),o.doSearch(t))}).on("keydown","#search-panel-replace-input",function(){var e=event.keyCode||event.which;if((n=229==e)||"Enter"!=i[e]){if("Tab"==i[e]&&!event.shiftKey)return!1}else o.replaceSelection()}).on("mousedown","#search-panel-prev",function(){o.highlightNext(!0)}).on("mousedown","#search-panel-next",function(){o.highlightNext()}).on("click","#md-search-type-label",function(){$("#md-searchpanel").addClass("searchpanel-replace-mode"),$("#search-panel-replace-input").focus(),document.body.classList.add("on-replace-panel-open")}).on("click","#md-replace-type-label",function(){$("#md-searchpanel").removeClass("searchpanel-replace-mode").removeClass("searchpanel-msg-mode"),$("#search-panel-input").focus(),document.body.classList.remove("on-replace-panel-open"),$("content").removeClass("on-replace-panel-open")}).on("click","#search-panel-replace-btn",function(){o.replaceSelection(),$("#md-searchpanel").removeClass("searchpanel-msg-mode")}).on("click","#search-panel-replaceall-btn",function(){$("#md-searchpanel").removeClass("searchpanel-msg-mode"),o.replaceAll()}).on("click","#searchpanel-msg-close-btn",function(){$("#md-searchpanel").removeClass("searchpanel-msg-mode")}).on("click","#searchpanel-msg-undo-btn",function(){o.editor.undo.undo(),$("#md-searchpanel").removeClass("searchpanel-msg-mode"),!o.editor.sourceView.inSourceMode&&o.doSearch($("#search-panel-input").val())}).on("mousedown","#searchpanel-case-option-btn",function(e){return this.classList.toggle("active"),File.isMac&&app.touchBar&&app.touchBar.updateFindReplaceMode(),o.doSearch(),!1}).on("mousedown","#searchpanel-word-option-btn",function(){return this.classList.toggle("active"),File.isMac&&app.touchBar&&app.touchBar.updateFindReplaceMode(),o.doSearch(),!1})},replaceAll:function(){if(this.searchStatus&&this.searchStatus.hits.length){var e,t,i=this.searchStatus.searchText,r=$("#search-panel-replace-input").val(),n=this.searchStatus.hits;if(function(e){y&&clearTimeout(y),$("#md-searchpanel.searchpanel-replace-mode").addClass("searchpanel-msg-mode").find("#searchpanel-msg-content").text(e),y=setTimeout(function(){$("#md-searchpanel").removeClass("searchpanel-msg-mode")},5e3)}.call(this,(t=this.searchStatus.hits.length,this.searchStatus.searchText,"Replaced "+t+" occurrence(s)")),this.editor.sourceView.inSourceMode){var o="",a=0,s=n.length;for(e=0,i=this.editor.sourceView.cm.getValue();a<s;a++)o=o+i.substring(e,n[a].start-0)+r,e=n[a].end-0;return o+=i.substring(e),this.editor.sourceView.cm.setValue(o),void this.clearSearch()}var l=this.editor.undo.UndoManager,c=l.makeEmptyCommand(f.utils.extend(this.searchStatus.curSelection,{type:"cursor"})),d=this.searchStatus,u=null;this.clearSearch();for(a=0;a<n.length;a++)u!=(e=n[a]).cid&&(u=e.cid,h.call(this,e));this.editor.undo.register(c)}function p(e,t){var n=e.get(t);n&&e.set(t,n.replace(v(i,d),function(e,t,n){return d.wholeWord&&0<t&&m.exec(n.substr(t-1,1))?e:r}))}function h(e){var t=this.editor.getNode(e.cid);c.undo.push(l.buildReplaceUndo(t)),p(t,"text"),p(t,"title"),p(t,"ref"),c.redo.push(l.buildReplaceUndo(t)),this.editor.findElemById(t.cid).replaceWith(t.toHTML())}},replaceSelection:function(){if(this.editor.sourceView.inSourceMode&&!this.searchStatus.curSelection&&this.highlightNext(),this.searchStatus.curSelection&&this.searchStatus.hits.length&&$("#md-searchpanel.searchpanel-replace-mode").length){var e,t,i,n=$("#search-panel-replace-input").val(),r=n.length-this.searchStatus.searchText.length,o=this.searchStatus.curPos,a=this.editor.undo.UndoManager,s=a.makeEmptyCommand(),l=this.searchStatus.curSelection,c=l.isCm;i=r,this.searchStatus.lastRange?(e=this.editor.nodeMap.allNodes.get(l.cid),s.undo.push({type:"cursor",id:e.cid,start:l.start,end:l.end}),this.selectApplier.undoToRange(this.searchStatus.lastRange),this.applier.undoToRange(this.searchStatus.lastRange),i=n.length-(this.searchStatus.curSelection.end-this.searchStatus.curSelection.start),this.searchStatus.lastRange.deleteContents(),this.searchStatus.lastRange.insertNode(document.createTextNode(n)),this.searchStatus.lastRange=null,s.undo.push(a.buildReplaceUndo(e)),this.editor.store(e.cid),s.redo.push(a.buildReplaceUndo(e))):c&&c.doc.replaceSelection(n,"start","+findReplace"),function(e){for(var t=e.curPos+1;t<e.hits.length;t++){var n=e.hits[t];n.cid==e.curSelection.cid&&(n.start+=i,n.end+=i)}}(this.searchStatus),this.highlightNext(),this.searchStatus.hits.splice(o,1),this.searchStatus.curPos--,this.searchStatus.curPos<0&&(this.searchStatus.curPos=this.searchStatus.hits.length-1),this.searchStatus.hits.length||this.clearSearch(),t=this.searchStatus.curSelection||this.searchStatus.initRange,this.editor.sourceView.inSourceMode||(t&&s.redo.push({type:"cursor",id:t.cid,start:t.start,end:t.end}),this.editor.undo.register(s))}},isOpen:function(){return"block"==document.querySelector("#md-searchpanel").style.display},showPanel:function(e){$("#md-searchpanel").is(":visible")||(editor.lastCursor=editor.selection.buildUndo(),this.editor.undo.completeSnap(!0),this.clearSearch(),this.searchStatus.initPos=editor.selection.getPosBookmark(),$("#md-searchpanel").show().find("#search-panel-input").focus()[0].select(),$("#search-panel-input").val()&&this.doSearch($("#search-panel-input").val()),document.body.classList.add("on-search-panel-open")),e?($("#md-searchpanel").addClass("searchpanel-replace-mode"),document.body.classList.add("on-replace-panel-open")):($("#md-searchpanel").removeClass("searchpanel-replace-mode"),document.body.classList.remove("on-replace-panel-open")),File.isMac&&app.touchBar&&(app.touchBar.showFindReplaceTouchBar(),app.touchBar.updateFindReplaceMode())},closePanel:function(e,t){t=t||$(".md-search-select");var n=this.editor.getMarkElem().length;if(document.body.classList.remove("on-replace-panel-open"),document.body.classList.remove("on-search-panel-open"),$("#md-searchpanel").removeClass("searchpanel-msg-mode").hide(),this.editor.sourceView.inSourceMode)return this.searchStatus&&this.searchStatus.hits.length&&(this.editor.fences.clearSearchAll(),this.editor.sourceView.cm.focus()),void this.resetSearchStatus();e?n=!0:t.length?(this.editor.selection.selectAllElem(t),this.editor.lastCursor=this.editor.selection.buildUndo(),n=!1):this.searchStatus&&this.searchStatus.curSelection&&this.searchStatus.curSelection.isCm&&(this.searchStatus.curSelection.isCm.focus(),this.editor.lastCursor=this.editor.selection.buildUndo(),n=!1),this.clearSearch(),$(".md-search-hit").removeClass("md-search-hit"),!n&&this.editor.restoreLastCursor(),!e&&this.editor.refocus()},doSearch:function(e){this.clearSearch(void 0,!0);var d=this.editor,t=this,u=this.searchStatus,n=u&&u.initPos,i=n&&document.querySelector("[cid='"+n.cid+"']");function p(e){var t=e.containerNode||document.querySelector("[cid='"+e.cid+"']");return!!i&&(i.compareDocumentPosition(t)==s.DOCUMENT_POSITION_PRECEDING||i==t&&e.start<n.start)}function r(e,t){for(var n=v(t,u),i=e.getValue(),r=!1,o=null;n.exec(i);)r=!0,o={isCm:e,cid:e.cid,start:n.lastIndex-t.length,end:n.lastIndex},u.wholeWord&&0<o.start&&m.exec(i.substr(o.start-1,1))||(u.hits.push(o),p(o)&&u.curPos++);r&&d.fences.searchOn(e,t,u)}function o(e,t,n){e.get("children").length?e.get("children").toArray().map(function(e){o(e,t)}):d.fences.queue[e.cid]?r(d.fences.queue[e.cid],t):l.isType(e,c.math_block)?(d.mathBlock.currentCm||{}).cid===e.cid&&(d.fences.clearSearchOn(d.mathBlock.currentCm),r(d.mathBlock.currentCm,t)):function(e,t,n){for(var i,r,o,a,s=v(t,u),l=d.findElemById(e.cid)[0],c=l.textContent;s.exec(c);)r={cid:e.cid,containerNode:l,start:s.lastIndex-t.length,end:s.lastIndex},u.wholeWord&&0<r.start&&m.exec(c.substr(r.start-1,1))||((i=i||g.createRange()).moveToBookmark(r),h.applyToRange(i),o=i,a=void 0,(a=$(o.commonAncestorContainer)).closest(".md-meta, .md-content, script").length||a.hasClass("md-meta")||a.hasClass("md-content")||a[0]&&"script"==a[0].tagName?a.closest("[md-inline]").addClass("md-search-expand"):o.getNodes([1],function(e){return e.classList.contains("md-meta")||e.classList.contains("md-content")||"script"==e.tagName}).forEach(function(e){$(e).closest("[md-inline]").addClass("md-search-expand")}),u.hits.push(r),p(r)&&u.curPos++)}(e,t)}if(u.searchText=void 0===e?$("#search-panel-input").val():e,u.caseSensitive=$("#searchpanel-case-option-btn.active").length,u.wholeWord=$("#searchpanel-word-option-btn.active").length,u.searchText.match(/^([a-z]|\s)?$/gi))$(".md-search-expand").removeClass("md-search-expand");else{t=this;var h=this.applier;if(this.editor.sourceView.inSourceMode)return void r(this.editor.sourceView.cm,u.searchText);this.searchTimer=setTimeout(function(){$(".md-search-expand").removeClass("md-search-expand");for(var e=d.nodeMap.getFirst();e;)o(e,u.searchText),e=e.get("after");t.highlightNext()},50)}},highlightNext:function(t){if(!$("#md-searchpanel").is(":visible"))return this.showPanel();$("#md-searchpanel").removeClass("searchpanel-msg-mode");var n,i=this.searchStatus,r=this.editor;i&&i.hits.length&&(i.curSelection&&(i.curPos+=t?-1:1),i.curPos>=i.hits.length?i.curPos=0:i.curPos<0&&(i.curPos=i.hits.length-1),function(e){(function(){i.curSelection&&((n=i.curSelection.isCm)?n.execCommand(t?"goDocStart":"goDocEnd"):i.lastRange&&this.selectApplier.undoToRange(this.searchStatus.lastRange))}).call(this),i.curSelection=i.hits[i.curPos],$(".md-focus").removeClass("md-focus"),$(".md-focus-p").removeClass("md-focus-p"),(n=i.curSelection.isCm)?(i.lastRange=null,n.doc.setSelection(n.posFromIndex(i.curSelection.start),n.posFromIndex(i.curSelection.end)),File.isTypeWriterMode?r.selection.typeWriterScroll($(".CodeMirror-selectedtext")):r.selection.scrollAdjust($(".CodeMirror-selectedtext"),null,window.innerHeight-200),$(".CodeMirror-selectedtext").closest("[cid]").addClass("md-focus")):(i.lastRange=i.lastRange||g.createRange(),i.lastRange.moveToBookmark({containerNode:document.querySelector("[cid='"+i.curSelection.cid+"']"),start:i.curSelection.start,end:i.curSelection.end}),this.selectApplier.applyToRange(i.lastRange),File.isTypeWriterMode?r.selection.typeWriterScroll(i.lastRange.nativeRange):r.selection.scrollAdjust(i.lastRange,null,window.innerHeight-200),$("[cid='"+i.curSelection.cid+"']").addClass("md-focus").closest("p").addClass("md-focus-p"))}.call(this,i.curPos))},clearSearch:function(e,t){if(this.editor.sourceView.inSourceMode)return this.editor.fences.clearSearchAll(),void this.resetSearchStatus(this.searchStatus&&(this.searchStatus.curSelection||this.searchStatus.initPos));if(t||$(".md-search-expand").removeClass("md-search-expand"),this.searchStatus){try{this.searchStatus.lastRange&&this.selectApplier.undoToRange(this.searchStatus.lastRange)}catch(e){}for(var n,i=g.createRange(),r=0;r<this.searchStatus.hits.length;r++){var o=this.searchStatus.hits[r];o.isCm||(i.moveToBookmark({containerNode:document.querySelector("[cid='"+o.cid+"']"),start:o.start,end:o.end}),this.applier.undoToRange(i))}(n=this.searchStatus.curSelection&&this.searchStatus.curSelection.isCm)&&(n.doc.setSelection(n.posFromIndex(this.searchStatus.curSelection.start)),$(n.display.input.textarea).blur())}this.editor.fences.clearSearchAll(),clearTimeout(this.searchTimer);var a=this.searchStatus&&(this.searchStatus.curSelection||this.searchStatus.initPos);this.resetSearchStatus(a)},resetSearchStatus:function(e){this.searchStatus={hits:[],curPos:0,searchText:null,lastRange:null,initPos:e,curSelection:null}}});n.exports=d}),define("app/editor/Word",["jquery/jquery","exoskeleton-master/exoskeleton"],function(e,t,n){"use strict";var s=e("jquery/jquery"),i=e("exoskeleton-master/exoskeleton").Model.extend({initialize:function(e){this.editor=e,this.$container=s("#word-auto-suggest")},search:function(e,t,n,i){var r=e.substring(t,t+n);if(!r)return[];var o=[];return File.isMac?(o=app.word.getSpellSuggestionInContext(e,t,n),i.type="word",i.token=r,i.match=o,i.found=o.length,i.pageNo=0,i.pageCnt=Math.floor((o.length-1)/5+1)):i.found=!1,o},showAutoSuggest:function(e,t,n,i){if(i.token===e.substring(t,t+n))return!1;var r=this.search(e,t,n,i),o="";if(!i.found)return this.$container.hide(),!1;for(var a=0;a<r.length&&a<40;a++)a%5==0&&(o+=(0<a?"</ul>":"")+"<ul data-page='"+a/5+"' style='display:none'>"),o+=s("<li/>").attr("data-content",r[a]).text(r[a])[0].outerHTML;return o+="</ul>",this.$container.html(o),this.$container}});n.exports=i}),define("app/document/Export",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils","app/document/StringUtils","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileHelper","app/editor/UndoManager","app/editor/Emoji","app/document/Node2Native","app/editor/Diagram","codemirror/lib/codemirror","app/document/MarkParser","app/editor/polyfill"],function(t,e,n){"use strict";var i,f,r=t("exoskeleton-master/exoskeleton"),o=t("app/document/Node"),R=o.Node,P=o.TYPE,D=(o.NodeCollectionUtils,t("app/document/StringUtils")),l=t("app/document/MarkParser"),c=t("app/editor/Inline"),O=(t("app/document/Node2Native"),t("app/editor/EditHelper")),B=t("jquery/jquery"),g=(t("app/editor/polyfill"),1e4),d=function(){for(var e=document.querySelectorAll("#write figure"),t=0;t<e.length;t++){var n=e[t];n.style.zoom=Math.min(n.clientWidth/n.scrollWidth,1),n.style.overflowX="hidden",n.style.overflowy="hidden"}},u=function(){for(var e=document.querySelectorAll("#write a"),t=/^\s*#(.+)$/,n={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"'":"\\'","\\":"\\\\"},i=function(e){return e.replace(/["\\\b\t\n\f\r]/g,function(e){return n[e]}).replace(/\u200b/g,"")},r=0;r<e.length;r++){var o,a=e[r],s=a.getAttribute("name"),l=a.getAttribute("href");if(s){var c=document.createElement("a"),d=document.createTextNode(" ");c.appendChild(d),c.setAttribute("class","md-print-anchor"),c.setAttribute("href","uaf://"+i(s)),a.parentNode.insertBefore(c,a)}l&&(o=t.exec(l))&&(l=o[1],a.setAttribute("href","uat://"+i(l)))}};function m(){f&&(f.close(),f.destroy(),f=null),B("#md-notification").fadeOut()}window.releaseCaptureWin_=m;var a=r.Model.extend({initialize:function(e){this.editor=e,window.debugMode&&t.async("FileSaver.min",function(e){i=e})},exportToNative:function(e,t,n){return t=File.isMac?function(e){app.controller.exportWithPandocCallback(e)}:t||function(){},this.editor.nodeMap.exportToNative(e,t,n)},exportToImage:function(){var r,o=reqnode("electron").remote,e=o.getCurrentWindow(),t=o.app,n=o.dialog,i=o.BrowserWindow,a=this,s=o.screen.getPrimaryDisplay().scaleFactor||1,l=t.setting.get("zoomFactor")||1,c=[],d=null;function u(e){return/png$/i.exec(d)?e.toPNG():e.toJPEG(100)}function p(t,e){reqnode("fs").writeFile(t,e,function(e){e?n.showErrorBox(B.localize.getString("Export Failed","Panel"),e.message):o.shell.showItemInFolder(t)})}function h(){if(d&&c.length){var e=null,n=0;try{if(1<c.length){var t=document.createElement("canvas"),i=t.getContext("2d");t.width=640,t.height=r,c.forEach(function(e){var t=new Image(640,e.getSize().height);t.src=e.toDataURL(),i.drawImage(t,0,n),n+=t.height}),e=u(o.nativeImage.createFromDataURL(t.toDataURL())),p(d,e),m()}else e=u(c[0]),p(d,e),m()}catch(e){console.sendError(e),m()}}}try{(function(){File.editor.store(!0),m();var e=a.exportToHTML(!0,!1,!1,!0),t=o.app.setting.config;return(f=new i({skipTaskbar:!0,show:!1,webPreferences:{webSecurity:!1,allowDisplayingInsecureContent:!0,allowRunningInsecureContent:!0,nodeIntegration:!1,directWrite:t.directWrite,defaultFontFamily:t.defaultFontFamily,zoomFactor:l},webgl:!1,useContentSize:!0,width:640,height:960,enableLargerThanScreen:!0,offscreen:!0,alwaysOnTop:!0,minimizable:!1,closable:!1})).loadURL("data:text/html;charset=UTF-8,  "+encodeURIComponent(e)),f})().webContents.once("did-finish-load",function(){setTimeout(function(){f.webContents.executeJavaScript("document.body.clientHeight;").then(function(e){return e-=0,isNaN(e)?m():(f.setContentSize(640,e),4*g<(r=e)?(m(),n.showErrorBox(B.localize.getString("Export Failed","Panel"),B.localize.getString("Generated Image too Large","Panel")),!1):void function t(n){var i=r-n;g<i&&(i=g),f.setContentSize(640,i),f.webContents.executeJavaScript("document.body.scrollTop = {d};".replace("{d}",n)).then(function(){setTimeout(function(){f.webContents.capturePage(function(e){if(e.isEmpty())return m();1<s&&(e=e.resize({width:640,quality:"best"})),c.push(e),n+i<r?t(n+=i):h()})},400)})}(0))})},400)})}catch(e){m()}n.showSaveDialog(e,{properties:["saveFile"],title:"Export to…",defaultPath:t.getPath("userDesktop")+"/"+File.getSuggestedFileName(!0)+".png",filters:[{name:"PNG",extensions:["png"]},{name:"JPEG",extensions:["jpg","jpng"]}]},function(e){if(!e)return m();d=e,B("#md-notification").html("<p> "+B.localize.getString("Exporting in progress...","Panel")+" </p>").show(),h()})},exportAndSaveHTML:function(e){var t=new Blob([this.exportToHTML(e)],{type:"text/html;charset=utf-8"});i(t,"export.html")},exportCollection:function(e,o,F,E,i,a,_){var M=this.editor.nodeMap,N=this.editor,t=(a=a||new l.InlineLexer({nodeMap:M,count:1,footnoteList:[],appendFootnote:function(e,t){if(!o[t]){o[t]=[""];var n=a.output(e.get("text"),c.decorateAsExport,!1,{parent:e,skipFootnote:t});o[t][0]="<span class='md-fn-count'>"+t+"</span> "+n}var i=o[t].length-1,r=t+(i?"-"+i:"");return o[t].push("<a name='dfref-footnote-"+r+"' href='#ref-footnote-"+r+"' title='"+B.localize.getString("back to document")+"' class='reversefootnote' >↩</a>"),r},noStyle:E,forPrint:F,skipOp:{atag:!0,underline:!0,comment:!0,imgtag:!0}},c.decorateAsExport),""),A=E?"\n":"",r=this;function L(e){if("string"==typeof e)return a.output(e,c.decorateAsExport);var t=e.get("children");if(R.isType(e,P.paragraph)){var n=[];return t.sortedForEach(function(e){n.push(a.output(e.get("text"),c.decorateAsExport))}),n.join("\n")}return t&&0<t.length?r.exportCollection(t,o,F,E,i,a):a.output(e.get("text"),c.decorateAsExport)}function I(i){var e,t=null;function n(t){return t?M.toc.headers.findIndex(function(e){return e.cid==t}):-1}switch(i.get("type")){case P.paragraph:if(1==i.get("children").length){var r=R.parseFrom(i.getText(),null,{noTop:!0},!0)[1][0];if(R.isType(r,P.heading)&&(r.cid=i.cid,-1==n(r.cid)&&i.isTopBlock())){var o=N.findElemById(r.cid).prevAll(".md-heading").last().attr("cid");M.toc.headers.splice(n(o)+1,0,r)}if(R.isType(r,P.heading,P.def_footnote,P.def_link))return r.cid=i.cid,I(r)}return"<p>"+(L(i)||"&nbsp;")+"</p>";case P.heading:var a="";return F&&1==i.get("depth")&&!i.get("parent")&&i.get("before")&&(a=" data-breakpage"),"<h"+i.get("depth")+a+">"+(E||_?"":"<a name='header-"+i.cid+"' class='md-header-anchor "+(F?"md-print-anchor' href='af://"+i.cid+"'> ":"'>")+"</a>")+L(i)+"</h"+i.get("depth")+">";case P.blockquote:return"<blockquote>"+L(i)+"</blockquote>";case P.list:var s=i.get("style"),l=function(){for(var e=i.get("children").toArray(),t=0;t<e.length;t++){var n=e[t].getFirstChild();if(!R.isType(n,P.paragraph)||n.get("after"))return!0}return!1}();i.set("loose",l);var c="";return s==R.ListType.ol&&(c=""===i.get("start")?void 0:i.get("start")-0,c=Number.isNaN(c)||1==c?"":" start='"+i.get("start")+"' "),"<"+s+c+">"+A+L(i)+A+"</"+s+">";case P.list_item:return i.get("style")===R.ListType.task?"<li "+(E?"":"class='md-task-list-item task-list-item task-list-"+(i.get("checked")?"done":"not-done")+"'")+" ><input type='checkbox' disabled='disabled' "+(i.get("checked")?"checked":"")+"/>"+L(i)+"</li>":"<li>"+(!1===(e=i).get("parent").get("loose")?L(e.getFirstChild()):L(e))+"</li>";case P.fences:if(E){var d=D.escapeInQuote(i.get("lang")||"");return d?"<pre><code class='language-"+d+"' lang='"+d+"'>"+D.escape(i.get("text"))+A+"</code></pre>":"<pre><code>"+D.escape(i.get("text"))+A+"</code></pre>"}var u,p=N.findElemById(i.id).clone();if(File.option.enableDiagram&&R.isType((i.get("lang")||"").toLowerCase(),"flow","sequence","mermaid")){u=!1;var h=N.findElemById(i.id).find("svg"),f=p.find("svg");return h.attr("width")&&!h.attr("viewBox")&&(f.attr("viewBox","0 0 "+h.attr("width")+" "+h.height()),f.css("max-width","100%"),f.css("height","auto")),O.processExportedSVG(p.find(".md-diagram-panel").html(p.find(".md-diagram-panel-preview").html())[0].outerHTML)}if(!1!==u&&(u=13<i.get("text").split(/\n/).length),p.removeAttr("cid").removeAttr("contenteditable").removeAttr("mdtype").find("input, textarea, .code-tooltip, .CodeMirror-cursors, .CodeMirror-hscrollbar, .CodeMirror-vscrollbar, .CodeMirror-selected").remove().end().find(".CodeMirror-sizer").css("min-height","").end().find(".CodeMirror-selectedtext").removeClass("CodeMirror-selectedtext").end(),u&&p.css("page-break-inside","unset"),F&&File.isNode){var g=window.getComputedStyle(File.editor.writingArea).fontFamily||"initial";g=g.replace(/'/g,"\\'"),p.find(".CodeMirror-line > span").each(function(){!function t(e,n){if(e.nodeType==document.TEXT_NODE){var i=e.textContent;(i=i.split(/(;|-)/).map(function(e){return";"==e||"-"==e?"<span style='font-family:"+n+"'>"+e+"</span>":D.escape(e)}).join(""))!=e.textContent&&(e.innerHTML=i)}else 1==e.nodeType&&e.childNodes.forEach(function(e){t(e,n)})}(this,g)})}return p[0].outerHTML;case P.math_block:if(_){var m=N.findElemById(i.id).find(".MathJax_SVG").clone();return function(e,t){if(e&&t){var n=(e.getAttribute("viewBox")||"").split(" ");if(n&&4===n.length){n=n.map(function(e){return e-0});var i=e.getBoundingClientRect(),r=e.querySelector("g").getBoundingClientRect();n[0]=n[0]+(r.left-i.left)/i.width*n[2],n[2]=r.width/i.width*n[2],t.setAttribute("viewBox",n.join(" ")),_?t.setAttribute("width",Math.min(r.width,640)):t.setAttribute("width",r.width)}}}(N.findElemById(i.id).find("svg")[0],m.find("svg")[0]),m[0]?O.processExportedSVG(m[0].outerHTML):"<p class='math-block'>$$"+D.escape(i.get("text"))+"$$</p>"}var v=N.findElemById(i.id),y=v.width(),b=v.find(".MathJax_SVG").width();return y<b-10&&(v=v.clone().find(".MathJax_SVG").css("zoom",y/b)),v[0]?O.processExportedSVG(v[0].outerHTML):"<p class='math-block'>$$"+D.escape(i.get("text"))+"$$</p>";case P.hr:return"<hr />";case P.def_footnote:case P.def_link:return"";case P.table:i.get("align").length;for(var w="<figure><table>"+A,x=i.getFirstChild();x;)x.get("before")?w+=I(x):w+="<thead>"+A+I(x)+"</thead>"+A+"<tbody>",(x=x.get("after"))||(w+="</tbody>"+A);return w+="</table></figure>";case P.table_row:w="<tr>",x=i.getFirstChild();for(var C,k=i.get("parent").get("align"),S=0,T=i.get("before")?"td":"th";x;)w+="<"+T+(C=(C=k[S])?" style='text-align:"+C+";' ":"")+">"+I(x)+"</"+T+">",x=x.get("after"),S++;return w+="</tr>";case P.table_cell:return L(i)||"&nbsp;";case P.meta_block:return"";case P.toc:return function(){if(E)return"<div>[TOC]</div>";if(!t){var e=B(document.querySelector(".md-toc-content")).clone();e.find("[data-ref]").each(function(){this.querySelector("a").setAttribute("href",(F&&File.isMac?"at://":"#header-")+this.getAttribute("data-ref"))}),e.find(".md-meta").remove(),t="<div class='md-toc' mdtype='toc'>"+e[0].outerHTML+"</div>"}return t}();default:return"<p>"+L(i)+"</p>"}}if(o=o||[],"string"==typeof e)return L(e);if(e.length)for(var n=e instanceof Array,s=n?e[0]:e.sortedFirst();t+=I(s)+A,(s=s.get("after"))&&(!n||-1<e.indexOf(s)););return t+(i?w(o):"")},exportToHTML:function(p,s,h,f){var e=this.editor.nodeMap,t=this.editor,l=[],n=File.editor.docMenu.getValueInMeta("title")||(File.getFileName()||"").replace(/\.(md|mmd|markdown|txt|text)$/i,""),g=File.option.enableDiagram&&B(".md-fences[lang='mermaid']").length,m=Object.keys(File.editor.fences.queue).length,v="";function y(e,t){if(!e)return"";t=t||[];var n,i,r=/^\s*@include-when-export\s+(url)?([('"]+)([^\)"']+)([)'"]+)/im;try{(i=e.match(/^\s*@include-when-export\s.+$/gim))&&i.map(function(e){(n=r.exec(e)||[])[3]&&t.push(n[3])})}catch(e){}r=/^\s*@import\s+(url)?([('"]+)([^\)"']+)([)'"]+)/im;try{(i=e.match(/^\s*@import\s.+$/gim))&&i.map(function(e){(n=r.exec(e)||[])[3]&&t.push(n[3])})}catch(e){}return t.map(function(e){return"<link href='"+e+"' rel='stylesheet' type='text/css' />"}).join("\n")}function b(e){return File.isMac?app.path.readText(e):File.isNode?reqnode("fs").readFileSync(e,"utf-8"):void 0}return File.option.showLineNumbersForFence&&t.fences.refreshEditor(!0),function(e,t){t=D.escape(t)||"",l.length&&(window.app&&app.setting.get("split_pages"),e+="<div class='footnotes-area' "+(p?"data-breakpage":"")+" ><hr/>"+w(l)+"</div>");var n=p?"<script> window.setBreakPage = function(b){var node = document.querySelectorAll('[data-breakpage]'); for(var i=0;i<node.length;i++){node[i].style.pageBreakBefore = b ? 'always':'' }}; setBreakPage("+(window.app&&app.setting.get("split_pages")?"true":"false")+");<\/script>":"",i=File.isMac?"is-mac":"is-node",r=f?"24px":document.body.parentElement.style.fontSize||"";if(r&&(r=" style='font-size:"+r+" !important'"),File.option.showLineNumbersForFence&&(i+=" show-fences-line-number"),p&&File.isMac&&(n+="<script>("+u.toString()+")();<\/script>"),p&&(n+="<script>("+d.toString()+")();<\/script>"),s)return"<!doctype html>\n<html>\n<head>\n<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>\n<title>"+t+"</title></head>\n<body>"+e+"</body>\n</html>";var o=function(){var e,t,n,i,r,o,a=[];if(v="",p){if(document.querySelectorAll("link[css-include]").forEach(function(e){v+="<link rel='stylesheet' href='"+D.escapeInQuote(e.href)+"' type='text/css' />"}),!f&&File.colorBrightness<.5&&File.isNode){var s=reqnode("electron").remote.app.getPath("userData");v+=["github.css","base.user.css","github.user.css"].map(function(e){return"<link rel='stylesheet' href='file:///"+D.escapeInQuote(s+"/themes/"+e)+"' type='text/css' />"}).join("\n")}else if(!f&&File.colorBrightness<.5&&h&&File.isMac){var l=app.path.getThemeFolderPath();v+=["github.css","base.user.css","github.user.css"].map(function(e){return"<link rel='stylesheet' href='file:///"+D.escapeInQuote(l+"/"+e)+"' type='text/css' />"}).join("\n")}else v+=["theme_css","base_user_css","theme_user_css"].map(function(e){return"<link rel='stylesheet' href='file://"+(File.isWin?"/":"")+D.escapeInQuote(B("#"+e).attr("href"))+"' type='text/css' />"}).join("\n");return""}function c(e){for(var t in e.cssRules){var n=e.cssRules[t];if(n.styleSheet){if(n.href.match(/mermaid/i)&&!g)continue;if(n.href.match(/sourcemode\.dark\.css/i))continue;c(n.styleSheet)}else a.push((n.cssText||"").replace(/content: ([^;]{1});/g,"content: '$1';"))}}File.isMac&&(n=["theme_css","base_user_css","theme_user_css"].map(function(e){return r=[],o=B("#"+e).attr("href"),y(i=b(o),r),r.forEach(function(e){(/^\/\//.exec(e)||/.+:\/\//.exec(e))&&(v+="<link href='"+e+"' rel='stylesheet' type='text/css' />")}),function n(e,i){var r=/^["']/,o=[];function a(e){var t=(e.match(r)||[""])[0];return e=decodeURI(t.length?e.substring(1,e.length-1):e),(e=File.isMac?app.path.resolvePathRelateTo(e,i):reqnode("path").resolve(i,e)).match(/\.css$/)?(o.push(n(b(e),e)),e=""):e=(File.isMac?"file://":"file:///")+e,t+encodeURI(e)+t}return i=(i||"").replace(/[\/\\][^\/\\]*$/,""),e=(e||"").replace(/(^|;|\n)[\s]*@import([^;\n]+)(;|$|\n)/,function(e,t){var n=(/['"]([^"']+)['"]/.exec(e)||[])[0];return n?e.replace(n,a(n)):e}).replace(/url\([^:)]+\)/gi,function(e){return"url("+a(e=e.substring(4,e.length-1))+")"}),e=o.join("\n")+e}(i,B("#"+e).attr("href"))}).join("\n")),t=["(base\\.css)"],n||t.push("(theme)"),m&&t.push("(codemirror)"),g&&t.push("(mermaid)"),t=new RegExp(t.join("|"),"i");for(var d=0;d<document.styleSheets.length;d++)if(e=document.styleSheets[d],t.exec(e.href)&&(c(e),/themes/.exec(e.href)))try{var u=decodeURI(e.href.replace(File.isWin?/^[\w_-]+:[\/]+/:/^[\w_-]+:\/\//,""));v+=y(b(u))}catch(e){}return n&&a.push(n),a.join("\n")}(),a=["typora-export"];return f&&(a.push("for-image"),o+=" ::-webkit-scrollbar {display: none;} "),File.option.preLinebreakOnExport||(o+=" .typora-export p, .typora-export .footnote-line {white-space: normal;} "),File.option.indentFirstLine&&a.push("first-line-indent"),document.body.classList.contains("os-windows")&&(a.push("os-windows"),File.option.monocolorEmoji&&a.push("monocolor-emoji")),"<!doctype html>\n<html"+r+(p?" class='blink-to-pdf' ":"")+">\n<head>\n<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>\n<title>"+t+"</title>"+v+"<style type='text/css'>html {overflow-x: initial !important;}"+o+"\n</style>\n</head>\n<body class='"+a.join(" ")+"' >\n<div  id='write' "+(p?"style='top:auto'":"")+" class = '"+i+"'>"+e+"</div>\n"+n+"</body>\n</html>"}(this.exportCollection(e.blocks,l,p,s,void 0,void 0,f),n)}});function w(e){return e.map(function(e){return"<div class='footnote-line'>"+e.join("")+"</div>"}).join("\n")}n.exports=a}),define("app/document/Node2Native",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils","app/editor/Diagram","codemirror/lib/codemirror","app/editor/KeyMaster","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/window/FileHelper","app/editor/UndoManager","app/editor/Emoji"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton");var o,g,i=e("app/document/Node"),p=i.Node,r=i.NodeMap,m=i.TYPE,v=e("app/document/StringUtils"),h=e("app/editor/Diagram"),a=e("app/document/MarkParser"),u=e("app/editor/EditHelper"),s={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"'":"'","\\":"\\\\"};var f,y,b="",l={},w=[],x=[];function c(e,o){var t=document.querySelector("[cid='"+e+"'] svg"),n=$(t).closest("[lang='mermaid']").length;if(File.isMac&&n){var i=(a="<html><body>$1</body></html>",s={x:0,y:0,width:(s=(r=t).getBoundingClientRect()).width,height:s.height},a=a.replace("$1",u.svg2DataURL(r,!0,!0)),app.controller.screenshotHTML(a,s));o(i)}else{var r,a,s,l=u.svg2DataURL(t,n),c=t.getBoundingClientRect(),d=new Image;d.onerror=function(e){o("")},d.onload=function(){var t=document.createElement("canvas"),e=t.getContext("2d"),n=File.canvasratio,i=d.width,r=c.bottom-c.top;t.width=d.width,t.height=c.bottom-c.top,1.1<n&&(t.width=i*n,t.height=r*n,e.scale(n,n)),e.drawImage(d,0,0),t.style.width=i+"px",t.style.height=r+"px",setTimeout(function(){var e="";try{e=t.toDataURL("image/png")}catch(e){console.warn(e)}!function(e,t){var n;if(File.isNode){var i=e.replace(/^data:image\/png;base64,/,""),r=reqnode("electron").remote.app;n=r.getPath("temp").replace(/[\/\\]$/,"")+(File.isWin?"\\\\":"/")+Number(new Date)+".png",reqnode("fs").writeFile(n,i,"base64",function(e){e?console.sendError(e.stack):(t(n),x.push(n))})}else{if(!File.isMac)return;n=window.app.path.savePNG(e),t(n),x.push(n)}}(e,o)},100)},d.src=l}}function d(t,n,r,o){var e=t.split(/(\uE040\d+)\uE041/g);e.length;if(!e)return n(t);Promise.all(e.map(function(i,e){return new Promise(function(t){if(i.charAt(0)==b){var e=i.substring(1)-0,n=f[e].cid;c(n,function(e){y.delete(n),"latex"==r&&(e=function(e,t){if(!t)return e;var n=null;return File.isNode?(n=reqnode("path").basename(e),reqnode("fs-extra").moveSync(e,t+"/"+n)):File.isMac&&(n=app.path.moveItem(e,t)),n}(e,o)),t(JSON.stringify(e))})}else t(i)})})).then(function(e){t=e.join(""),n(t)},function(e){n(t)})}function C(){if(File.isNode)for(;x.length;)reqnode("fs").unlink(x.pop(),function(){});else File.isMac&&(app.path.removeTempFiles(JSON.stringify(x)),x=[])}var k,S=function(e){return a.recoverEscape(e).replace(/["'\\\b\t\n\f\r]/g,function(e){return s[e]}).replace(/\u200b/g,"")},T={left:"AlignLeft",right:"AlignRight",center:"AlignCenter"},F=function(e,t,n,i){t=void 0===t?",":t,i=i||l;for(var r,o=[],a=n||e.getFirstChild();a;)(r=L(a,i))&&o.push(r),a=a.get("after");return o.join(t)},E=function(e,t){return t=t||e.get("text"),k.output(t,null,e).replace(/, $/,"")||'Str ""'},_=function(e){return p.isType(e,"epub","rst","opml","textile")},M=/([^\\]|^)\\tag{([^}]+)}\s*/,N=/([^\\]|^)\\label{([^}]+)}\s*/,A=/([^\\]|^)\\over[^\w\d]/,L=function(e,t){var n;_(t.target);switch(e.get("type")){case m.line:return E(e);case m.paragraph:if(1==e.get("children").length){var i=p.parseFrom(e.getText(),null,{noTop:!0},!0)[1][0];if(p.isType(i,m.heading,m.def_footnote,m.def_link))return i.cid=e.cid,L(i,t)}return"Para ["+(n=F(e,File.option.preLinebreakOnExport?",LineBreak,":",Space,"))+"]";case m.meta_block:return"";case m.heading:var r=p.isType(t.target,"textile","opml")?"":"header-"+e.cid;return"Header "+e.get("depth")+' ("'+r+'", [], []) ['+E(e)+"]";case m.blockquote:return"BlockQuote ["+(n=F(e))+"]";case m.list:var o=e.get("style");return n=F(e),o==p.ListType.ol?"OrderedList (1,Decimal,Period) ["+n+"]":"BulletList ["+n+"]";case m.list_item:return"["+(n=F(e))+"]";case m.fences:if(h.isDiagramType(e.get("lang"))&&p.isType(t.target,"epub","docx","odt","latex")){f.push(e),y.add(e.cid);var a=document.querySelector("[cid='"+e.cid+"'] svg").getBoundingClientRect();return'Div ("",[],[("style","text-align:center"), ("align", "center")]) [Para [Image ('+JSON.stringify(e.get("lang"))+',[],[("width", "'+(a.right-a.left)+'"), ("align", "center")]) [Str ""] ('+(b+(f.length-1))+',"fig:")]] '}return'CodeBlock ("",["'+S(e.get("lang")||"")+'"],[]) "'+S(e.get("text"))+'"';case m.math_block:if(n=e.get("text").trim().replace(/\u200b/g,""),"epub"==t.target){var s=g[n];if(s)return'RawBlock (Format "html") '+JSON.stringify(function(e){try{var t=(new DOMParser).parseFromString(e,"text/html");return t.querySelectorAll("mtable").forEach(function(e){e.hasAttribute("columnalign")&&!e.getAttribute("columnalign")&&e.removeAttribute("columnalign")}),t.body.innerHTML}catch(e){}return e}(s))+" "}else if("latex"==t.target){if(n.match(/^\\(begin|newcommand|renewcommand|newenvironment|renewenvironment|def|let){/))return'RawBlock (Format "latex") '+JSON.stringify(n)}else if("docx"==t.target){var l=function(e,t){var n;if(t.number=t.number||1,File.option.autoNumberingForMath&&(n=t.number,t.number++),A.test(e))return[e,n];var i=M.exec(e);return e=e.replace(/([^\\]|^)\\eqref{([^}]+)}\s*/g,"$1($2)"),i?(n=i[2],[e=e.replace(/([^\\]|^)\\tag{([^}]+)}\s*/g,"$1")+"\\qquad\\text{("+v.escapeInQuote(n)+")}",n]):(e=e+="\\qquad\\text{("+v.escapeInQuote(n+"")+")}",(i=N.exec(e))&&(n=i[2]),[e,n])}(n,t);return"Plain ["+['RawInline (Format "openxml") "<w:bookmarkStart w:id=\\"0\\" w:name=\\"%s\\"/><w:r><w:t>" '.replace("%s",l[1]),'Math DisplayMath "'+S(l[0])+'" ','RawInline (Format "openxml") "</w:t></w:r><w:bookmarkEnd w:id=\\"0\\"/>"'].join(",")+"]"}return'Plain [Math DisplayMath "'+S(n)+'"]';case m.hr:return"HorizontalRule";case m.def_footnote:case m.def_link:return"";case m.toc:return"latex"==t.target?'RawBlock (Format "latex") "\\\\tableofcontents"':"wiki"==t.target?'RawBlock (Format "mediawiki") "__TOC__", RawBlock (Format "mediawiki") ""':"rst"==t.target?'RawBlock (Format "rst") ".. contents::", RawBlock (Format "rst") "\n"':"opml"==t.target?"":"textile"==t.target?'RawBlock (Format "textile") "{toc}", RawBlock (Format "textile") "\n"':function(e,t){try{return'Div ("toc", [], []) [Para ['+e.toc.headers.map(t?function(e){return'Str "'+" ".repeat(e.get("depth")-1)+'", Link ("", [], []) ['+E(e)+'] ("#header-'+e.cid+'","")'}:function(e){return'Str "'+"\\t".repeat(e.get("depth")-1)+'", Link ("", [], []) ['+E(e)+'] ("#header-'+e.cid+'","")'}).join(",LineBreak,")+"]]"}catch(e){return console.warn(e.stack),""}}(e.get("in"),"epub"==t.target);case m.table:var c=e.get("align").map(function(e){return T[e]||"AlignDefault"}),d=c.map(function(){return"0.0"}),u=e.getFirstChild();return"Table [] ["+c.join(",")+"] ["+d.join(",")+"] ["+F(u)+"] ["+F(e,",",u.get("after"))+"]";case m.table_row:return"["+F(e)+"]";case m.table_cell:return"[Plain ["+E(e)+"]]";default:return""}},I=[];I[m.strong]="Strong",I[m.em]="Emph",I[m.del]="Strikeout",I[m.subscript]="Subscript",I[m.superscript]="Superscript";var R,P={html:'RawInline (Format "html") "<u>", $0, RawInline (Format "html") "</u>", ',docx:'RawInline (Format "openxml") "<w:r><w:rPr><w:u w:val=\\"single\\" /></w:rPr><w:t>$0</w:t></w:r>", ',rtf:'RawInline (Format "rtf") "{\\\\ul ", $0, RawInline (Format "rtf") " }", ',latex:'RawInline (Format "latex") "\\\\underline{", $0, RawInline (Format "latex") "}", '},D={html:'RawInline (Format "html") "<mark>", $0, RawInline (Format "html") "</mark>", ',docx:'RawInline (Format "openxml") "<w:r><w:rPr><w:shd w:val=\\"clear\\" w:fill=\\"ffff00\\" /></w:rPr><w:t>$0</w:t></w:r>", ',rtf:'RawInline (Format "rtf") "{{\\\\colortbl;\\\\red255\\\\green255\\\\blue0;} \\\\cb1 ", $0, RawInline (Format "rtf") "}", ',latex:'RawInline (Format "latex") "\\\\hl{", $0, RawInline (Format "latex") "}", '},O={atag:!1,imgtag:!1,comment:!0},B=function(e,t){var n=function(e){if(p.isType(e.type,m.plain,m.escape,m.emoji))return e.inner||e.text;if(t)return e.text||"";throw Error("caught styles")};R||(R=new a.InlineLexer({skipOp:O},n));try{return R.output(e.text,n,!0)}catch(e){return!1}},j=function(e,t){var n,i,r,o,a,s=/^(\S*)(\s*)/,l=function(e){for(var t,n="";e.length&&(t=s.exec(e));)e=e.substring(t[0].length),t[1]&&(n+='Str "'+S(t[1])+'", '),t[2]&&(n+="Space, ");return n};e.inner&&(e.inner=e.inner.replace(/, $/,""));var c=/^file:[\\\/]{0,2}/i;switch(e.type){case m.strong:case m.em:case m.del:case m.subscript:case m.superscript:return I[e.type]+" ["+e.inner+"], ";case m.plain:case m.escape:return l(e.text);case m.code:return'Code ("", [], []) "'+S(e.text.trim())+'", ';case m.autolink:case m.url:return'Link ("", [], []) [Str "'+S(e.text)+'"] ("'+S(e.href)+'", ""), ';case m.atag:if(!_(t.target))return'Link ("", [], []) ['+e.inner+'] ("'+S(e.href)+'", "'+S("")+'"), ';case m.imgtag:if(!_(t.target)){var d=$($.parseHTML(e.text));return'Image ("",[],[]) [Str "'+S(d.attr("title")||d.attr("alt")||"")+'"] ("'+S(File.editor.imgEdit.getRealSrc(e.href).replace(c,""))+'","fig:"), '}case m.tag:case m.comment:return'RawInline (Format "html") "'+S(e.text)+'", ';case m.link:if("#"==(e.href||"").trim()[0]){var u=e.href.substr(1),p=$("h1, h2, h3, h4, h5, h6").filter(function(){return $(this).text().toLowerCase().trim()==u.toLowerCase().trim()});p.length&&(e.href="#header-"+p.attr("cid"))}return'Link ("", [], []) ['+e.inner+'] ("'+S(e.href)+'", "'+S(e.title||"")+'"), ';case m.image:return'Image ("",[],[]) [Str "'+S(e.title||"")+'"] ("'+S(File.editor.imgEdit.getRealSrc(e.href).replace(c,""))+'","fig:"), ';case m.refimg:r="Image";case m.reflink:return i=(n=t.nodeMap.link_list.getNodeByRef(e.ref||e.text))?S(n.get("href").replace(c,"")):"",u=S(n&&n.get("title")||""),"Image"==(r=r||"Link")&&(e.inner='Str "'+S(u||"")+'"'),r+' ("", [], []) ['+e.inner+'] ("'+i+'", "'+u+'"), ';case m.footnote:var h=t.nodeMap.foot_list.getNodeByRef(e.text);return h?"Note [Para ["+E(h)+"]], ":l(e.text);case m.attr:return l(e.text);case m.emoji:return'Str "'+S(e.inner)+'", ';case m.inline_math:if("epub"==t.target){var f=g[e.text.replace(/(^\s*\$+)|(\$+\s*$)|\u200b/g,"").trim()];if(f)return'RawInline (Format "html") '+JSON.stringify(f)+", "}return'Math InlineMath "'+S(e.text.replace(/(^\s*\$+)|(\$+\s*$)|\u200b/g,""))+'", ';case m.linebreak:return"LineBreak, ";case m.highlight:if("latex"==t.target)w.push("\\usepackage{color}"),w.push("\\usepackage{soulutf8}");else if("docx"==t.target)return a=B(e,!0),D[t.target].replace("$0",S(v.escape(a)));o=D;case m.underline:return o=o||P,"docx"==t.target?(a=B(e,!0),o[t.target].replace("$0",S(v.escape(a)))):(o[t.target]||o.html).replace("$0",e.inner);default:return""}},H=function(e){var t=[];function n(e,t){return t instanceof Array?(n=t,'("'+S(e)+'", MetaList ['+n.map(function(e){return'MetaInlines [RawInline (Format "tex") "'+S(e)+'"]'}).join(", ")+"])"):'("'+S(e)+'", MetaInlines [ '+(k.output(t).replace(/, $/,"")||'Str ""')+"])";var n}for(var i in e["header-includes"]&&e["header-includes"]instanceof Array?e["header-includes"]=e["header-includes"].concat(w):w.length&&(e["header-includes"]=w),e)t.push(n(i,e[i]));return t.join(", ")};r.prototype.exportToNative=function(e,t,n){File.editor.export.cleanUpTempFiles=C,function(e){if(l={target:e,nodeMap:this,skipOp:O},w=[],f=[],y=new Set,void 0===File.canvasratio){File.canvasratio=1;var t=document.createElement("canvas").getContext("2d"),n=window.devicePixelRatio||1,i=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;File.canvasratio=n/i}}.call(this,e),"epub"==e&&(g=Object.create(null),!o&&File.option.enableInlineMath&&(o=document.querySelector("#inline-math-export-jax"),MathJax.Hub.Typeset(o),o=MathJax.Hub.getAllJax(o)[0]),$(".md-inline-math, [mdtype='math_block']").each(function(){try{var e,t=this.querySelector("script").textContent.trim().replace(/\u200b/g,"");this.classList.contains("md-inline-math")?(o.Text(t),e=o.root.toMathML("")):e=MathJax.Hub.getAllJax(this)[0].root.toMathML(""),g[t]=e}catch(e){}})),k&&k.options.nodeMap===this||(k=new a.InlineLexer(l,j));var i=F(null,"\n ,",this.getFirst(),l),r="Pandoc (Meta {unMeta = fromList ["+H(File.editor.docMenu.buildMetaMap())+"]})\n ["+i+"]";return p.isType(e,"epub","docx","odt","latex")?d(r,t,e,n):t(r),r}}),define("app/editor/SourceView",["codemirror/lib/codemirror","codemirror/addon/selection/active-line","codemirror/addon/edit/visiblespace","jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileHelper","app/editor/UndoManager","app/editor/Emoji","app/editor/UndoManager"],function(e,t,n){"use strict";var o,a=e("codemirror/lib/codemirror"),i=(e("codemirror/addon/selection/active-line"),e("codemirror/addon/edit/visiblespace"),e("jquery/jquery")),r=(e("exoskeleton-master/exoskeleton"),e("app/document/Node")),u=e("app/document/StringUtils"),d=e("app/document/MarkParser"),s=e("app/editor/UndoManager"),l=window.reqnode?reqnode("electron").remote:null,p=r.Node,h=r.TYPE,c=i("#typora-source"),f=(i("#toggle-sourceview-btn"),!1),g=null,m=function(e){this.editor=e,this.cm=null,this.inSourceMode=!1,this.renderedHTML=""};function v(e,t){var n="number"==typeof e?e:e.get("tail");return void 0===n?void 0===t?e.get("after")?1:0:t:n}function y(e,t){function n(e,n){return e.get("children").toArray().reduce(function(e,t){return e+y(t,n)},0)}function i(e){return p.isType(e.get("parent"),h.list_item)&&!1!==e.get("parent").get("tight")}switch(e.get("type")){case h.meta_block:return 2+e.get("text").match(/(\n|$)/g).length+v(e);case h.heading:return(e.get("ahead")||0)+((e.get("pattern")||(!p.isType(e.get("parent"),h.list_item)&&(1==File.option.headingStyle||3==File.option.headingStyle)&&e.get("depth")<=2?"===":"#")).match(/[-=]/)?2:1)+v(e);case h.paragraph:var r=e.get("tail");return t&&(r=0),p.isType(e.get("after"),h.paragraph)&&r<1&&(e.unset("tail"),r=1),void 0!==r||!p.isType(e.get("after"),h.math_block)&&e.get("after")||(r=0),(e.get("ahead")||0)+(e.get("children").length||1)+v(void 0===r?e:r,r);case h.line:return 1;case h.blockquote:return(e.get("ahead")||0)+n(e,!0)+v(e);case h.list:var o=e.get("ahead")||0;return e.isLoose(!0),o+=n(e),p.isType(e.get("after"),h.list)&&(!e.get("tail")||e.get("tail"))<2&&e.get("pattern")==e.get("after").get("pattern")&&e.get("style")==e.get("after").get("style")&&(e.unset("tail"),o++,i(e)&&o++),t||(o+=v(e,i(e)?0:1)),o;case h.list_item:return e.toMark().split(/\n/).length;case h.fences:var a=/`|~/.exec(e.get("pattern")||"```");return(e.get("ahead")||0)+(a?3:1)+(e.get("text").match(/\n/g)||[]).length+v(e);case h.math_block:return(e.get("ahead")||0)+3+(e.get("text").match(/\n/g)||[]).length+v(e,p.isType(e.get("before"),h.paragraph)&&p.isType(e.get("after"),h.paragraph)?0:1);case h.hr:return v(e)+1;case h.toc:return(e.get("ahead")||0)+1+v(e);case h.def_footnote:case h.def_link:return(e.get("ahead")||0)+1+v(e,!e.get("after")||p.isType(e.get("after"),p.TYPE.def_link)?0:1);case h.table:return(e.get("ahead")||0)+e.get("children").length+1+v(e);case h.table_row:return e.get("before")?1:2;case h.table_cell:return 0;default:return 1}}m.prototype.prep=function(){if(!this.cm){var e=document.querySelector("#typora-source-input"),r=this;this.cm=a.fromTextArea(e,{lineWrapping:!0,mode:"gfm",theme:"typora-default",styleSelectedText:!0,maxHighlightLength:1/0,styleActiveLine:!0,visibleSpace:!0,viewportMargin:100,autoCloseBrackets:!0,autoCloseTags:!0,resetSelectionOnContextMenu:!1,extraKeys:{Enter:"newlineAndIndentContinueMarkdownList"},lineNumbers:!0,dragDrop:!1,indentUnit:File.option.codeIndentSize,tabSize:File.option.codeIndentSize},this.editor),c.css("z-index","2");var i=null,o=(this.cm,this.editor);File.isMac?i=app.menu.getItem("Edit").submenu():File.isNode&&(i=reqnode("electron").remote.Menu.getApplicationMenu().getItem("Edit").submenu),this.cm.on("changes",function(e,t){if(r.inSourceMode&&(document.querySelector(".on-search-panel-open")&&"+findReplace"!==t[0].origin&&"setValue"!==t[0].origin&&r.editor.searchPanel.closePanel(),"begin"!==t[0].origin&&"sync"!==t[0].origin)){f=!0;var n=File.editor.sourceView.cm.doc.historySize();i&&(i.getItem("Undo").setEnabled(!File.isLocked&&0<n.undo),i.getItem("Redo").setEnabled(!File.isLocked&&0<n.redo)),"fromDisk"!==t[0].origin&&File.updateChangeCount(File.ChangeType.NSChangeDone),o.syncChange([{type:"sync",srcChanges:t}]),File.needsUpdateSnap()}}),this.cm.on("contextmenu",function(e,t){if(r.inSourceMode){var n=e.getCursor("from"),i=e.getCursor("to");setTimeout(function(){e.setSelection(n,i,{scroll:!1})},180)}}),this.cm.on("cursorActivity",function(e,t){r.inSourceMode&&(File.isFocusMode&&o.updateFocusMode(!0),File.isTypeWriterMode&&r.scrollAdjust())}),this.cm.on("scrollCursorIntoView",function(e,t){r.inSourceMode&&!File.isTypeWriterMode||t.preventDefault()}),this.cm.display.scroller.addEventListener("wheel",function(e){Math.abs(e.deltaY)<4||File.isFocusMode&&File.isTypeWriterMode&&o.updateFocusMode(!1)},{passive:!0})}},m.prototype.show=function(){File.sync();var e=this.editor.getMarkdown();try{g=S.call(this)}catch(e){g=null,console.warn(e.stack)}this.editor.cleanTooltip(),this.editor.searchPanel.closePanel(!0),this.inSourceMode=!0,File.isNode&&l.getCurrentWindow().setInSourceMode(!0),i("body").addClass("typora-sourceview-on"),i(".md-tooltip-hide").hide(),this.renderedHTML="",this.prep(),this.cm.setValue(e,"begin"),f=!1,c.show(),T.call(this),this.cm.refresh(),this.cm.focus(),this.cm.getDoc().clearHistory(),this.cm.options.readOnly=File.isLocked,this.enableTypeWriterMode(File.isTypeWriterMode)},m.prototype.enableTypeWriterMode=function(e){if(this.cm){if(e){var t=this.cm.defaultTextHeight();o=document.querySelector("content").clientHeight,this.cm.display.lineSpace.parentNode.style.paddingTop=(o-t)/2+"px",this.cm.display.lineSpace.parentNode.style.paddingBottom=(o-t)/2+"px"}else this.cm.display.lineSpace.parentNode.style.paddingTop="",this.cm.display.lineSpace.parentNode.style.paddingBottom="";this.scrollAdjust()}},m.prototype.setValue=function(e,t,n){this.cm&&(this.cm.setValue(e,n||"begin"),t&&(f=!0))},m.prototype.onSave=function(){if(this.cm.doc.history.lastModTime=0,f){var e=this.cm.getScrollInfo().top;File.reloadContent(this.cm.getValue(File.useCRLF?"\r\n":"\n"),!1,!0,!1,!0),this.cm.scrollTo(0,e)}},m.prototype.hide=function(){var e,t=this.editor;i("body").removeClass("typora-sourceview-on"),this.inSourceMode=!1,File.isNode&&l.getCurrentWindow().setInSourceMode(!1),(g=this.cm.getCursor()).lineText=this.cm.getLine(g.line),e=g.lineText.substring(0,g.ch),g.inRef=e.match(b)&&!e.match(w),g.textBefore=e,f&&(File.isMac&&!app.document.isDocumentEdited()&&this.renderedHTML?(i(File.editor.sessionStr).html(this.renderedHTML),setTimeout(function(){File.editor.refresh()},500),File.editor.syncChange([{type:"sync",allHtml:this.renderedHTML,json:s.buildAllDoc(File.editor.nodeMap).json}])):File.reloadContent(this.cm.getValue(File.useCRLF?"\r\n":"\n"),!1,!0,!1,!0)),c.hide(),k.call(this),t.selection.scrollAdjust()},m.prototype.scrollAdjust=function(){var e=this.cm;if(File.isTypeWriterMode){var t=e.cursorCoords(!0,"window"),n=t.top-(o+t.bottom-t.top)/2;2<Math.abs(n)&&e.scrollTo(null,e.getScrollInfo().top+n)}else{var i=this.cm.charCoords(this.cm.getCursor(),"local").top,r=this.cm.getScrollerElement().offsetHeight/2;this.cm.scrollTo(null,i-r-5)}};var b=/\[/,w=/\]/;var x=function(e,t,n){var i,r=null;function o(e,t,n){return void 0===n&&(n=(n=t?g.lineText.indexOf(e):g.lineText.lastIndexOf(e))<0?0:n),Math.max(0,g.ch-n)}switch(t.get("type")){case h.line:case h.heading:e.undo.exeCommand({type:"cursor",id:t.cid,start:function(e,t){var n=t;for(var i in e)void 0!==i&&i<=t&&(n+=e[i]);return n}(t.cursorDiff||[],o(t.get("text")))});break;case h.hr:case h.toc:t.get("after")?e.selection.jumpIntoElemBegin(e.findElemById(t.get("after").getVeryFirst().cid)):e.selection.selectNode(t);break;case h.math_block:r=e.mathBlock.startEditing(t.cid,!0),n--;break;case h.fences:(t.get("pattern")||"```").match(/`/)&&n--,r=e.fences.getCm(t.cid);break;case h.def_link:case h.def_footnote:if(g.inRef)e.undo.exeCommand({type:"cursor",id:t.cid,start:o(t.get("ref"),!0)});else{var a=new RegExp("(]:\\s*)"+u.escapeRegExp(t.get("href")||t.get("text"))).exec(g.lineText),s=a?a.index+a[1].length:0;e.undo.exeCommand({type:"cursor",id:t.cid,start:t.get("ref").length+o(void 0,void 0,s)})}break;case h.meta_block:for(var l=t.get("text").split(/\n/),c=(s=g.ch,0);c<n-1;c++)s+=(l[c]||"").length+1;e.undo.exeCommand({type:"cursor",id:t.cid,start:s});break;case h.table_row:i=g.textBefore,g.cellsBefore=d.splitTableCell(i.replace(/^\s*\|/,""),!0)||[i],g.cellsOffset=g.cellsBefore.last().length,g.cellsBefore=g.cellsBefore.length,e.undo.exeCommand({type:"cursor",id:t.getNthChild(Math.max(0,g.cellsBefore-1)).cid,start:g.cellsOffset});break;default:e.selection.jumpIntoElemEnd(e.findElemById(t.getVeryFirst(!0).cid))}r&&(r.focus(),n>=r.lineCount()?r.execCommand("goDocEnd"):r.setCursor({line:n,ch:o(r.getLine(n))}))},C=function(e,t,n){var i,r=0;for(n+(t.get("ahead")||0)>g.line&&e.selection.jumpIntoElemBegin(e.findElemById(t.getVeryFirst().cid)),r=y(t);t.get("after")&&n+r<=g.line;)n+=r,r=y(t=t.get("after"));t.get("children").length&&!p.isType(t,h.table_row)?C(e,t.getFirstChild(),n+(t.get("ahead")||0)):n+r-(i=t,p.isType(i,h.table_row,h.line)?0:v(i))>g.line?x(e,t,g.line-n-(t.get("ahead")||0)):e.selection.jumpIntoElemEnd(e.findElemById(t.getVeryFirst(!0).cid))},k=function(){var e=this.editor;try{C(e,e.nodeMap.getFirst(),0)}catch(e){console.warn(e.stack)}e.refocus()},S=function(){if(this.editor.focusCid){var e=this.editor.findElemById(this.editor.focusCid),t=this.editor.getNode(this.editor.focusCid),n=0,i="",r="",o=this.editor.selection.getRangy();if(t){if(n=function e(t,n){return n=n||0,t?t.get("before")?e(t.get("before"),n+y(t.get("before"))):t.get("parent")?e(t.get("parent"),n+(t.get("parent").get("ahead")||0)):n:n}(t)+(t.get("ahead")||0),p.isType(t,h.fences)){var a=!/`|~/.exec(t.get("pattern")||"```");return!a&&n++,(g=document.activeElement.classList.contains("mode")?{line:-1,before:t.get("pattern")||"```"}:this.editor.fences.getCm(t.cid).doc.getCursor()).before=(a?t.get("pattern"):"")+this.editor.fences.getCm(t.cid).getLine(g.line).substring(0,g.ch),g.line=g.line+n,g.ch=void 0,g}if(p.isType(t,h.math_block))return this.editor.mathBlock.currentCm?((g=this.editor.mathBlock.currentCm.doc.getCursor()).line=g.line+n+1,g):{line:n,ch:-1};if(p.isType(t,h.toc))return{line:n,before:"]"};if(p.isType(t,h.hr))return{line:n,before:this.get("pattern")||"------"};if(p.isType(t,h.def_link,h.def_footnote)){var s,l=this.editor.getJQueryElem(o.startContainer);if((s=l.closest(".md-def-content")).length)return o.setStartBefore(s[0]),{line:n,before:i="]: "+o.toString()};if((s=l.closest(".md-def-title")).length&&l.text().length)return o.setStartBefore(s[0]),{line:n,before:i='"'+o.toString()}}if(p.isType(t,h.table,h.table_row))return{line:n,ch:-1};if(o.setStartBefore(e[0]),i=o.toString().replace(/(\u200B*):(\u200B*)/g,":").replace(/\200B\$/,"$"),p.isType(t,h.table_cell)){for(r="",t=t.get("before");t;)r="\\|[^|]*"+r,t=t.get("before");return{line:n,beforeRegExp:i=r+"\\|\\s*"+u.escapeRegExp(i)}}if(p.isType(t,h.meta_block))return{line:n=((i=i.replace(/^---/gm,"​---").replace(/\n$/g,"")).match(/\n/g)||[]).length+1,before:i=i.substring(i.lastIndexOf("\\n"))};if(""===i&&p.isType(t,h.line,h.heading)){if(p.isType(t,h.heading)){var c=t.toMark();if(/^\s*#/.exec(c))return{line:n,beforeRegExp:"^\\s*#+\\s*"}}var d=t.getTopBlock();if(p.isType(d,h.list,h.blockquote))return{line:n,ch:0,afterIndent:!0}}return{line:n,before:i}}}},T=function(){if(g)try{var e=g.ch;if(g.line<0&&(g.line=this.cm.doc.lineCount()-1),g.afterIndent){var t=this.cm.doc.getLine(g.line);e=(/^((\s+)|([-+*]\s)|(\[( |x)\])|>|(\d+\.\s))+/i.exec(t)||[""])[0].length}if(void 0===e){t=this.cm.doc.getLine(g.line);if(g.before)e=t.indexOf(g.before)+g.before.length;else if(g.beforeRegExp){var n=new RegExp(g.beforeRegExp,"g");n.exec(t),e=n.lastIndex}}this.cm.doc.setCursor({line:g.line,ch:0<e?e:0}),e<0&&this.cm.execCommand("goLineEnd")}catch(e){console.warn(e.stack)}};n.exports=m}),define("codemirror/addon/selection/active-line",[],function(e,t,n){var r=e("codemirror/lib/codemirror"),s="CodeMirror-activeline",l="CodeMirror-activeline-background",c="CodeMirror-activeline-gutter";function d(e){for(var t=0;t<e.state.activeLines.length;t++)e.removeLineClass(e.state.activeLines[t],"wrap",s),e.removeLineClass(e.state.activeLines[t],"background",l),e.removeLineClass(e.state.activeLines[t],"gutter",c)}function o(t,e){for(var n=[],i=0;i<e.length;i++){var r=e[i],o=t.getOption("styleActiveLine");if("object"==typeof o&&o.nonEmpty?r.anchor.line==r.head.line:r.empty()){var a=t.getLineHandleVisualStart(r.head.line);n[n.length-1]!=a&&n.push(a)}}(function(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0})(t.state.activeLines,n)||t.operation(function(){d(t);for(var e=0;e<n.length;e++)t.addLineClass(n[e],"wrap",s),t.addLineClass(n[e],"background",l),t.addLineClass(n[e],"gutter",c);t.state.activeLines=n})}function a(e,t){o(e,t.ranges)}r.defineOption("styleActiveLine",!1,function(e,t,n){var i=n!=r.Init&&n;t!=i&&(i&&(e.off("beforeSelectionChange",a),d(e),delete e.state.activeLines),t&&(e.state.activeLines=[],o(e,e.listSelections()),e.on("beforeSelectionChange",a)))})}),define("codemirror/addon/edit/visiblespace.js",[],function(e,t,n){"use strict";var i=e("codemirror/lib/codemirror");i.defineOption("visibleSpace",!1,function(e,t,n){n==i.Init&&(n=!1),n&&!t?e.removeOverlay("visiblespace"):!n&&t&&e.addOverlay({token:function(e,t){if(!t)return null;if(t.atBlockStart&&e.pos<t.atBlockStart)return e.eat(" ")?"startspace startspace-"+(e.pos-1):e.eat("\t")?"starttab startspace-"+(e.pos-1):(e.pos++,null);var n=/(^[ \t]+)|(\s+$)/.exec(e.string),i=e.string.length,r=n&&n[1]?n[1].length:-1;n&&n[2]&&n[2].length;return 0<r&&r>e.pos?(e.pos++,"startspace-"+(e.pos-1)+("\t"==e.string.charAt(e.pos-1)?" starttab":" startspace")):(e.pos=i,null)},name:"visiblespace"})})}),define("app/editor/QuickOpenPanel",["jquery/jquery","app/document/StringUtils","app/editor/KeyMaster"],function(e,t,n){"use strict";var a,s=e("jquery/jquery"),l=e("app/document/StringUtils"),i=e("app/editor/KeyMaster").map,r=window.reqnode?reqnode("electron").remote.app:window.app,o=function(e){this.editor=e,this.worker=null},c=s(s("#typora-quick-open-item-templ").html()),d=s(s("#typora-quick-loading-item-templ").html()),u=s(".typora-quick-open-list"),p=s(".typora-quick-open-list-inner"),h=s("#typora-quick-open-input input"),f=[],g=[],m=[],v="",y=[],b=40,w=5,x=-1,C=null,k=window.app&&new RegExp("^"+l.escapeRegExp(r.path.home)),S=0,T=!0,F=-1,E=20;function _(e){var t,n,i;File.isMac&&r.path.openURL(e,void 0,!0),File.isNode&&r.openFileOrFolder(e,{mountFolder:(t=File.getMountFolder(),n=e,i=File.isWin?"\\":"/",t&&n&&0==n.indexOf(t.replace(/[\/\\]$/,"")+i)?File.getMountFolder():void 0)})}function M(e,t,n){var i,r=/[^\\\/]+$/.exec(e),o=r[0],a=e.substring(0,r.index);y.length&&(o=l.escape(o).replace(new RegExp("(("+y.join(")|(")+"))","gi"),"<b>$1</b>")),t.append(c.find(".typora-quick-open-item-title").html(o).end().find(".typora-quick-open-item-path").text((i=a,60<(i=i.replace(k,"~")).length?i.substring(0,30)+"..."+i.substring(i.length-30,i.length):i)).end().clone().attr("data-original",e).attr("data-index",n+"").addClass(F==n?"active":"")).css("translate3d","(0, 0, 0)")}function N(e){if(f.length){F=-1==F?0:(F+e)%f.length,s(".typora-quick-open-item.active").removeClass("active"),s(".typora-quick-open-item[data-index='"+F+"']").addClass("active");var t=F*b,n=u.scrollTop();(t<n||n+b*w-10<t)&&u.scrollTop(Math.min(t,(f.length-w)*b))}}function A(e,o){function t(e){if(!(e<0)){o.find("[data-block-index='"+e+"']").remove();var t,n=s("<div class='quick-open-group-block' data-block-index='"+e+"'>").css("position","absolute").css("top",e*E*40+"px").css("width","100%"),i=f.length;a=Math.min(i+S,e*E+E+S);for(var r=e*E;r<a;r++)r==i?(t=i,n.append(d.clone().find(".typora-quick-open-info").text(s.localize.getString(t?"Gathering more results":"Searching")).end())):M(f[r],n,r);o.append(n)}}o=o||p;var n=u.scrollTop(),i=Math.floor(n/40),r=Math.floor(i/E);r!=x&&(t((x=r)-1),t(x),t(x+1))}function L(){x=-1,p.html("").height(b*(f.length+S)),A(0,p)}function I(e,t){e=l.removeDiacritics(e);var n=t.exec(e);return n?(n[1]=n[1]||"",n[3]=n[3]||"",4-n[1].length-(/\w/.test(n[1])?1:0)-(/\w/.test(n[3])?1:0)):0}function R(e){C=(f[F]||{}).p,T?(this.setSearchState(1),File.isMac&&r.quickOpen.query(e),File.isNode&&File.mountFolder_&&this.worker.postMessage(["quickFind",File.mountFolder_,e])):this.setSearchState(0),function(e){y=e.split(/\s+/).filter(l.isNotNullOrEmpty).map(function(e){return e.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace("*",".*")});var r=[],o=y.map(function(e){return new RegExp("(.)?"+e+"(.)?","i")}),t=[];y.length?(g.forEach(function(e){for(var t,n=0,i=0;i<o.length;i++){if(!(t=I(e.n,o[i])))return;n+=t}e.s=n,r.push(e)}),r.sort(function(e,t){var n=t.s-e.s;return n||t.d-e.d}),r=m.filter(function(e){for(var t=0;t<o.length;t++){if(-1<e.p.indexOf(File.getMountFolder()+(File.isWin?"\\":"/")))return!1;if(!I(e.n,o[t]))return!1}return!0}).concat(r)):r=(m||[]).clone().concat(g),r.forEach(function(e){-1==t.indexOf(e.p)&&t.push(e.p)}),this.initResult(t)}.call(this,e),File.isMac&&r.quickOpen.reindexFolderIfNeeded()}o.prototype.init=function(){var n=this;h.on("input",function(){var e=s(this).val();e!=v&&(f=[],v=e.replace(/[()'"%\\\/.?]/," "),R.call(n,v))}).on("keydown",function(e){var t=e.keyCode||e.which;if("Esc"==i[t]||"o"==i[t]&&e.shiftKey&&e.metaKey)return n.close(),!1;if("Tab"==i[t])return!1;if("Up"==i[t])return N(-1),!1;if("Down"==i[t])return N(1),!1;if("Enter"==i[t]&&s(".typora-quick-open-item.active").length)return _(f[F]),n.close(),!1;if(File.isMac&&e.ctrlKey&&!e.metaKey&&!e.shiftKey){if("P"==String.fromCharCode(t))return N(-1),!1;if("N"==String.fromCharCode(t))return N(1),!1}e.stopPropagation()}).on("blur",function(){setTimeout(n.close,200)}),u.on("mousedown",".typora-quick-open-item",function(e){1==e.which&&_(this.getAttribute("data-original"))}).on("scroll",A),File.isMac?r.quickOpen.cacheRecentFiles():File.isNode&&(this.initWorker(),T=!1,this.setRecentFiles((r.setting.getRecentDocuments()||[]).map(function(e){return e.path})),this.cacheFolder(File.getMountFolder()))},o.prototype.stopQuery=function(){File.isMac&&r.quickOpen.stopQuery(),File.isNode&&this.worker.postMessage(["stopQuery"])},o.prototype.initWorker=function(){this.worker=new Worker("app/finder-worker.js");var t=this;this.worker.onmessage=function(e){switch(e.data.type){case"initFileCache":t.initFileCache.apply(t,e.data.detail);break;case"addInitFiles":t.addInitFiles.apply(t,e.data.detail);break;case"removeInitFiles":t.removeInitFiles.apply(t,e.data.detail);break;case"queryMatch":t.updateResult.apply(t,e.data.detail);break;case"queryEnd":t.setSearchState.apply(t,[0])}}},o.prototype.cacheFolder=function(e){File.isNode&&(T=!0,g=[],this.worker.postMessage(["listAllFiles",e]))},o.prototype.show=function(){var e=s("#typora-quick-open:not(:visible)").show();this.editor.searchPanel.closePanel(!0),e.length&&(h[0].select(),F=-1,R.call(this,h.val().replace(/[()'"%\\\/.?]/," ")))},o.prototype.close=function(){s("#typora-quick-open:visible").hide().length&&File.isMac&&r.quickOpen.stopQuery(),F=-1},o.prototype.appendResultAtEnd=function(e,n){var i=p.children().last();return!!(i.hasClass("quick-open-group-block")&&i[0].childElementCount+e.length<=E)&&(e.forEach(function(e,t){M(e,i,n+t)}),!0)},o.prototype.updateResult=function(e){e=e.filter(function(e){return-1==f.indexOf(e)});var t=f.length;e.length&&((f=f.concat(e)).length-t==e.length&&this.appendResultAtEnd(e,t)||L.call(this))},o.prototype.initResult=function(e){F=C?f.indexOf(C):e.length?0:-1,f=e,L.call(this)},o.prototype.addInitFiles=function(e,n,i){g=g.concat(e.map(function(e,t){return{n:n[t],p:e,d:i[t]}}))},o.prototype.removeInitFiles=function(t){var n=t.length;g=g.filter(function(e){return e.p.substring(0,n)!=t})},o.prototype.initFileCache=function(e,n,i,t,r){g=e.map(function(e,t){return{n:n[t],p:e,d:i[t]}}),r&&(m=r.map(function(e){return{n:(/[^\\\/]+$/.exec(e)||[])[0]||"",p:e}})),T=t>e.length},o.prototype.setRecentFiles=function(e){m=e.map(function(e){return{n:(/[^\\\/]+$/.exec(e)||[])[0]||"",p:e}})},o.prototype.setSearchState=function(e){S!==e&&(e&&a==f.length?(s(".typora-quick-open-item:last").after(d.clone().find(".typora-quick-open-info").text(s.localize.getString(a?"Gathering more results":"Searching")).end()),a++):e||(s(".typora-quick-open-info-item").remove().length&&p.height(p.height()-40),a==f.length+1&&a--),S=e)},n.exports=o}),define("app/window/ContextMenu",["app/editor/KeyMaster","app/document/Node","exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/editor/Stylize","app/editor/UndoManager","rangy/rangy-core","app/window/MenuHelper","app/editor/polyfill","app/editor/UserOp","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/window/FileHelper","app/editor/Emoji","app/editor/TableEdit","app/editor/ConvertUtils","app/editor/DeleteOp","app/editor/PairOp","app/editor/IndentOp","app/editor/ClipboardOp"],function(e,t,n){"use strict";var o="",g=(e("app/editor/KeyMaster"),e("app/document/Node")),m=g.Node,v=g.TYPE,y=e("app/editor/Stylize"),i=e("app/editor/UserOp"),b=e("app/document/StringUtils"),r=e("app/editor/KeyMaster").map,a=window.reqnode?reqnode("electron").remote:null,s=function(){try{return window.reqnode&&reqnode("spellchecker")}catch(e){console.warn(e.stack)}}();function l(e){e=e||".context-menu",$(e).removeClass("show").find(".active").removeClass("active")}function c(e){var t=a.getCurrentWindow();l(),t.inspectElement(e.clientX,e.clientY)}var d=!1;function u(){d=!0;var i=(a.app.setting.config||{}).searchService||[["Search with Google","https://google.com/search?q=%s"]];i.forEach(function(t,e){var n=$($.parseHTML('<li data-group="search" data-key>\n<a role="menuitem">'+b.escape($.localize.getString(t[0],"Menu"))+"</a></li>")[0]);0===e?($("#search-service-placeholder").after('<li class="divider" data-group="search"></li>').replaceWith(n),n.attr("data-key","search-default"),2<i.length&&n.after('<li data-key="search-with" data-group="search" class="has-extra-menu">\n<a role="menuitem"><span>'+$.localize.getString("Search With…")+'</span><i class="fa fa-caret-right"></i></a></li>')):1===e&&2==i.length?$("[data-key='search-default']").after(n):$("#search-menu").append(n),n.click(function(){var e;e=t[1],l(),a.shell.openExternal(e.replace(/%s/,encodeURIComponent(o)))})})}function w(e,t){var n=$("[data-group='"+e+"']");t?n.show():n.hide()}function p(){File.editor.lastCursor&&File.editor.undo.exeCommand(File.editor.lastCursor)}var h=function(e){this.sessionStr=e,$(document).ready(x.bind(this))},f=function(e){$("#user-context-menu.show").length?this.showCustom(R,I):l()},x=function(){$("content").on("scroll",f.bind(this)),$(window).on("resize",f.bind(this)),_.call(this),File.isMac||(T.call(this),N.call(this),C.call(this),F.call(this),E.call(this),window.reqnode&&M.call(this))},C=function(){document.querySelector("#context-menu");$("[data-style]").click(function(){l(),p(),File.editor.refocus(),File.editor.stylize.toggleStyle(this.getAttribute("data-style"))})},k=function(){var e=File.editor.getMarkElem();e.closest("thead").length?$("[data-key='insert_row_before'], [data-key='delete_table_row']").hide():($("[data-key='insert_row_before']").show(),2<=e.closest("tbody").children().length?$("[data-key='delete_table_row']").show():$("[data-key='delete_table_row']").hide()),2<=e.closest("tr").children().length?$("[data-key='delete_table_col']").show():$("[data-key='delete_table_col']").hide()};h.prototype.updateTableVisiblity=k;var S,T=function(){$("body").on("mouseenter",".context-menu [data-key]",function(){var e=$(this);e.closest(".context-menu").find(".active").removeClass("active"),e.addClass("active")}).on("mouseleave",".context-menu",function(e){$(this).find(".active:not(.has-extra-menu)").removeClass("active")}),$("#context-menu").on("mouseenter","[data-key]",function(){var e=$(this);"block-style"==e.attr("data-key")?(A("#block-style-menu",e),e.addClass("active")):(document.querySelector("#block-style-menu").classList.remove("show"),document.querySelector("[data-key='block-style']").classList.remove("active")),"insert"==e.attr("data-key")?(A("#insert-menu",e),e.addClass("active")):(document.querySelector("#insert-menu").classList.remove("show"),document.querySelector("[data-key='insert']").classList.remove("active")),"copy-as"==e.attr("data-key")?(A("#edit-menu",e),e.addClass("active")):(document.querySelector("[data-key='copy-as']").classList.remove("active"),document.querySelector("#edit-menu").classList.remove("show")),"search-with"==e.attr("data-key")?(A("#search-menu",e),e.addClass("active")):(document.querySelector("#search-menu").classList.remove("show"),$("[data-key='search-with']").removeClass("active")),"table"==e.attr("data-key")?(k(),A("#table-menu",e),e.addClass("active")):(document.querySelector("#table-menu").classList.remove("show"),document.querySelector("[data-key='table']").classList.remove("active")),"math"==e.attr("data-key")?(A("#math-menu",e),e.addClass("active")):(document.querySelector("#math-menu").classList.remove("show"),document.querySelector("[data-key='math']").classList.remove("active"))})},F=function(){$("#context-menu").on("click","[data-indent]",function(){var e=this.getAttribute("data-indent");l(),p(),File.editor.refocus(),File.editor.stylize.toggleIndent(e)}).on("click","[data-tab]",function(){l(),p(),File.editor.refocus();"left"==this.getAttribute("data-tab")?i.lessIndent(File.editor):i.moreIndent(File.editor)}),$("#block-style-menu").on("click","[data-block]",function(){var e=this.getAttribute("data-block");l(),p(),File.editor.refocus(),File.editor.stylize.changeBlock(e)}),$("#insert-menu").on("click","[data-insert]",function(){var e=this.getAttribute("data-insert");l(),p(),File.editor.refocus(),e===v.table?File.editor.tableEdit.insertTable():e===v.meta_block?File.editor.stylize.insertMetaBlock():File.editor.stylize.insertBlock(e)}).on("click","[data-insert-p]",function(){var e="before"==this.getAttribute("data-insert-p");l(),p(),File.editor.refocus(),File.editor.UserOp.insertParagraph(e)})},E=function(){$("#math-menu").on("click",'[data-key="copy_as_mathml"]',function(){l(),p(),-1<File.editor.styleBookmark.style.block.indexOf(v.math_block)?File.editor.mathBlock.copyAsMathML(S):File.editor.mathInline.copyAsMathML()}).on("click",'[data-key="copy_as_math_tex"]',function(){l(),p(),-1<File.editor.styleBookmark.style.block.indexOf(v.math_block)?File.editor.mathBlock.copyAsTex(S):File.editor.mathInline.copyAsTex()}).on("click",'[data-key="copy_as_math_image"]',function(){l(),p(),-1<File.editor.styleBookmark.style.block.indexOf(v.math_block)?File.editor.mathBlock.copyAsImage(S):File.editor.mathInline.copyAsImage()}),File.isWin||$("#math-menu [menu-for-win]").hide()},_=function(){$("#table-menu").on("click",'[data-key="insert_row_before"]',function(){l(),p(),File.editor.tableEdit.addRow(!0)}).on("click",'[data-key="insert_row_after"]',function(){l(),p(),File.editor.tableEdit.addRow(!1)}).on("click",'[data-key="delete_table_row"]',function(){l(),p(),File.editor.tableEdit.deleteRow(!1)}).on("click",'[data-key="insert_col_before"]',function(){l(),p(),File.editor.tableEdit.addCol(!0)}).on("click",'[data-key="insert_col_after"]',function(){l(),p(),File.editor.tableEdit.addCol(!1)}).on("click",'[data-key="delete_table_col"]',function(){l(),p(),File.editor.tableEdit.deleteCol()}).on("click",'[data-key="delete_table"]',function(){l(),p(),File.editor.tableEdit.deleteTable()}).on("click",'[data-key="copy_table"]',function(){l(),p(),File.editor.tableEdit.copyTable()}).on("click",'[data-key="reformat_table"]',function(){l(),p(),File.editor.tableEdit.reformatTable()})},M=function(){s&&!File.option.noSpellCheck&&(reqnode("electron").webFrame.setSpellCheckProvider("en-US",File.option.autoCorrectMisspell,{spellCheck:function(e){return!s.isMisspelled(e)}}),$("#context-menu").on("click","[data-key='learn']",function(){l(),p(),s.add(o)}).on("click","[data-key='correct']",function(e){l(),p(),i.pasteHandler(File.editor,$(e.target).text(),!0)}))},N=function(){($("[data-key='jumpto']").click(function(){l(),p(),File.editor.tryOpenLink(File.editor.getJQueryElem(window.getSelection().anchorNode).closest("a"))}),$(".context-menu").mousedown(function(e){if(!$(e.target).closest("a").length)return!1}),$("[data-key='dev-tool']").click(c),File.isNode)&&(a.app.setting.get("debug",!1)?$("[data-group='dev-tool']").show():$("[data-group='dev-tool']").hide());$("[data-key='cut']").click(function(e){var t;l(),p(),ClientCommand.cut(),(t=$(document.activeElement.tagName).closest(".CodeMirror")[0])&&setTimeout(function(){t.CodeMirror.replaceSelection("","start")},30)}),$("[data-key='copy']").click(function(e){l(),p(),ClientCommand.copy()}),$("[data-key='copy_as_markdown']").click(function(e){l(),p(),ClientCommand.copyAsMarkdown()}),$("[data-key='paste_as_plain']").click(function(e){l(),p(),ClientCommand.pasteAsPlain()}),$("[data-key='paste']").click(function(){l(),p(),ClientCommand.paste()}),$("[data-key='copy-emoji']").click(function(){l(),p();var e=$(".md-emoji.md-expand [data-emoji]").attr("data-emoji");File.editor.UserOp.setClipboard("","",e,!0)})};h.prototype.show=function(e){!d&&window.reqnode&&u.call(this),$(File.editor.sessionStr).trigger("cursorChange"),File.editor.lastCursor=File.editor.selection.buildUndo(),$(e.target).closest(".mathjax-block, [mdtype][tabindex]").length&&(S=e.target,File.editor.stylize.putBookmark(null,File.editor.stylize.buildBookmark($(e.target).closest(".mathjax-block"))),File.ignoreStyleChange=!0,setTimeout(function(){File.ignoreStyleChange=!1},400)),$(".context-menu").removeClass("show").find(".active").removeClass("active"),function(){try{var e=File.editor.getJQueryElem(window.getSelection().anchorNode).closest("a");w("hyperlink",e.attr("href")||e.attr("data-ref"))}catch(e){w("hyperlink",!1)}}(),function(){o="";try{w("search",0<(o=window.getSelection().toString()).trim().length&&-1==o.indexOf("\n"))}catch(e){w("search")}}(),function(){var e=File.editor.styleBookmark.style,t=e.block[0],n=document.querySelector("#context-menu"),i=-1<File.editor.stylize.CONST.NoInline.indexOf(e.block[0]),r=!1,o=!1,a=!1,s=!1,l=!1,c=function(){try{return File.editor.getMarkElem(window.getSelection().getRangeAt(0).startContainer).attr("mdtype")==g.TYPE.meta_block}catch(e){}return!1}();if(w("inline-style",!i),$("[data-style]").removeClass("active"),e.inline.map(function(e){var t=document.querySelector("[data-style='"+e+"']");t&&t.classList.add("active"),m.isType(e,v.inline_math)&&(a=!0),(m.isType(e,v.image)||m.isType(e,v.imgtag))&&(s=!0),m.isType(e,v.emoji)&&(l=!0)}),e.block.map(function(e){m.isType(e,v.blockquote,v.list_item)&&(r=!0),m.isType(e,v.table)&&(o=!0),m.isType(e,v.math_block)&&(a=!0)}),t==v.line&&(t=v.paragraph),$("[data-key='block-style'] span").text($.localize.getString(y.CONST.StyleToNameMap[t],"Menu")),$("#block-style-menu [data-block]").removeClass("state-on").filter("[data-block='"+t+"']").addClass("state-on"),0<e.block.length&&File.editor.stylize.CONST.NormalBlockMap[t]?($("[data-block-auto-disable]").removeClass("disabled"),$("[data-block-auto-hide]").removeClass("hide")):($("[data-block-auto-disable]").addClass("disabled"),$("[data-block-auto-hide]").addClass("hide")),t!=v.def_footnote&&t!=v.def_link||($("#insert-menu [data-block-auto-disable]").addClass("disabled"),$("#insert-menu [data-block-auto-hide]").addClass("hide")),c&&t===File.editor.docMenu.getMetaNode()?($('[data-insert="meta_block"]').parent().addClass("hide"),$('[data-group="block-wrap"]').addClass("hide")):(t==v.meta_block&&$('[data-insert-p="before"]').parent().addClass("disabled"),$('[data-insert="meta_block"]').removeClass("hide"),$('[data-group="block-wrap"]').removeClass("hide")),r?n.querySelector('[data-group="block-tab"]').classList.remove("hide"):n.querySelector('[data-group="block-tab"]').classList.add("hide"),o?(n.querySelector('[data-key="table"]').classList.remove("hide"),n.querySelector('[data-key="block-style"]').classList.add("hide")):(n.querySelector('[data-key="table"]').classList.add("hide"),n.querySelector('[data-key="block-style"]').classList.remove("hide")),a?n.querySelector('[data-key="math"]').classList.remove("hide"):n.querySelector('[data-key="math"]').classList.add("hide"),l){var d=$(".md-emoji.md-expand [data-emoji]").attr("data-emoji");d&&(n.querySelector('[data-key="copy-emoji"] a').textContent=$.localize.getString("Copy '%@'","Menu").replace("%@",d)),$("#context-menu [data-group='emoji']").addClass(d?"show":"hide")}else $("#context-menu [data-group='emoji']").addClass("hide");if($("#context-menu [data-group='image']").addClass("hide"),s){var u=$(".md-image.md-expand").find("img").attr("src")||"";if(!u)return;/^file:\/\//.exec(u)&&n.querySelector('[data-key="reveal-img-in-finder"]').classList.remove("hide");var p=File.editor.imgEdit.getTagetImageStorageFolder();if(p){var h=b.escapeURL(p);if(-1==u.replace(/^file:\/\//,"").indexOf(h)){var f=b.getFolder(p);f&&($(n).find('[data-key="move-img-to-target"] a').text($.localize.getString("Copy to %@","Menu").replace("%@",f)),n.querySelector('[data-key="move-img-to-target"]').classList.remove("hide"))}}n.querySelector('[data-key="select-img-target"]').classList.remove("hide"),$('.divider[data-group="image"]').removeClass("hide")}}(),window.reqnode&&function(){if(";"==o.trim()&&(o=""),s&&!File.option.noSpellCheck&&!/\s/gi.exec(o.trim())&&0<o.trim().length&&s.isMisspelled(o.trim())){w("spell-check",!0),$("[data-key='correct']").remove();var e=s.getCorrectionsForMisspelling(o.trim());0==e.length?$("#divider-before-learn").hide():$("#divider-before-learn").show().before(e.reduce(function(e,t){return e+='<li data-group="spell-check" data-key="correct"><a role="menuitem">'+t+"</a></li>"},""))}else w("spell-check",!1)}();var t=$("#context-menu").addClass("show"),n=t.height()+48,i=e.clientX>window.innerWidth-220?window.innerWidth-220:e.clientX,r=e.clientY>window.innerHeight-n?window.innerHeight-n:e.clientY-$("#top-titlebar").height()+8;t.css({top:r+"px",left:i+"px"}),e.preventDefault(),e.stopPropagation()},h.prototype.hide=l;var A=function(e,t){var n=$(e).addClass("show"),i=n.height()+48,r=t.offset(),o=r.left,a=o+200,s=r.top-30,l=a+160>window.innerWidth?o-184:a,c=s+i>window.innerHeight?window.innerHeight-i:s;return n.css({top:c+"px",left:l+"px"}),!1};h.prototype.showExtMenu=A;var L,I,R,P=function(e,t){var n,i,r=$(e);if("Enter"==t){if(!r.hasClass("has-extra-menu")){var o=r.find("a");return o.length?o.trigger("click"):r.trigger("click"),!0}t="OpenSubmenu"}if("Up"==t||"Down"==t)return r=r.closest("li"),0==(n="Up"==t?r.prev():r.next()).length?(r.closest("#user-context-menu").length&&l(),!0):!n.height()||n.hasClass("divider")?P(n[0],t):(r=r.closest(".context-menu").find(".active"),n.hasClass("has-btn-submenu")?(i=r.prevAll("a").length/(r.closest(".has-btn-submenu").find("a").length||1)*n.find("a").length,(n=$(n.find("[data-key]")[Math.floor(i)])).trigger("mouseenter")):(r.removeClass("active"),n.addClass("active")),!0);if(("Left"==t||"Right"==t)&&"A"==r[0].tagName)return n="Left"==t?r.prev():r.next(),r.removeClass("active"),n.addClass("active"),!0;if("Left"==t||"Esc"==t){if((r=r.closest(".context-menu")).hasClass("ext-context-menu"))return r.find(".active").removeClass("active"),r.removeClass("show"),!0;if("Left"==t)return!0}return"Right"==t||"OpenSubmenu"==t?(r.hasClass("has-extra-menu")&&(r.trigger("mouseenter"),$(".ext-context-menu:visible [data-key]:visible").first().trigger("mouseenter")),!0):void 0};h.prototype.handleKeyEvent=function(e){var t,n=r[e.keyCode||e.which],i=$(".context-menu:visible");return!!i.length&&("Esc"==n?($(".context-menu").removeClass("show").find(".active").removeClass("active"),!0):i.find(".active").length?(t=$(".ext-context-menu .active")[0])?P(t,n):P($(".context-menu .active")[0],n):"Up"==n?(i.find("li[data-key]:visible").last().addClass("active"),!0):"Down"==n?(i.find("li[data-key]:visible").first().addClass("active"),!0):void 0)},h.prototype.getCustomFocuedElem=function(){return L.length?L:null},h.prototype.hideCustomMenu=function(e){e==I&&$("#user-context-menu.show").length&&this.hide()},h.prototype.showCustom=function(e,t){if(L=null,window.getSelection().rangeCount){I=t,R=e;var r=$("#user-context-menu").html(e.map(function(e){return e.key==h.SPLITER?'<li for-file class="divider"></li>':'<li data-key="'+e.key+'"><a role="menuitem">'+$.localize.getString(e.label,"Menu").replace("%@",e.variable||"")+"</a></li>"}).join(""));setTimeout(function(){var e=window.getSelection().getRangeAt(0),t=e.getClientRects(),n=t.length&&t[t.length-1];if((!n||0==n.left&&0==n.height)&&(e.selectNodeContents(e.commonAncestorContainer),n=(t=e.getClientRects()).length&&t[t.length-1]),n&&(0!=n.left||0!=n.height)){var i=$(e.commonAncestorContainer).closest("[cid]")[0].getBoundingClientRect().left||0;r.addClass("show").css({top:n.bottom+"px",left:Math.max(i,n.right-r.width()+20)+"px"}),L=$(e.commonAncestorContainer).closest("[md-inline]")}},100)}},h.SPLITER="divider",n.exports=h}),define("app/window/Library",["app/document/StringUtils","exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/window/FileHelper","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileInfoPanel","app/window/FileHelper","app/editor/FileTree","app/window/FileInfoPanel","app/editor/FileList","app/window/MenuHelper","app/editor/UndoManager","app/editor/polyfill"],function(e,t,n){"use strict";var l,i,r=e("app/document/StringUtils"),o=e("exoskeleton-master/exoskeleton"),a=e("app/document/Node"),c=(a.Node,a.TYPE,e("app/window/FileHelper")),s=e("app/window/FileInfoPanel"),p=(r=e("app/document/StringUtils"),e("app/editor/KeyMaster").map),d=e("app/editor/FileTree"),u=e("app/editor/FileList"),h=(e("app/window/MenuHelper"),e("jquery/jquery")),f=window.reqnode?reqnode("electron").remote:null,g=f?f.app:window.app,m=f?f.getCurrentWindow():null;window.onWindowFocus=function(e){try{if(File.isNode&&File.getCurrentDocByNode().setActiveWindow(m),File.isMac?(File.bindMenu(),g.document.isLocked()||File.unlock()):File.freshMenu(!0),File.editor.imgEdit.refreshLocalImg(),File.isNode){if(!i&&File.filePath&&!reqnode("fs-plus").isFileSync(File.filePath))return void s.onPresentationMoved();File.getMountFolder()&&(reqnode("fs-plus").isDirectorySync(File.getMountFolder())||File.editor.library.onRootChanged())}if(!e&&File.editor.selection){var t=File.editor.selection.buildUndo();File.restoreEditStateFromData(File.getDocumentSnap(),!0)||(File.editor.lastCursor=t,File.editor.restoreLastCursor())}File.isMac&&File.editor.library.markOpenedFile(c.getCurrentFilePath())}catch(e){console.sendError(e)}finally{return"DONE"}},window.onWindowBlur=function(){try{if(!window.File||!File.editor||!File.editor.sourceView)return;!!File.editor.sourceView.inSourceMode||(File.editor.selection.buildUndo()||!0),File.isMac?window.File.isLocked=!0:document.body.classList.remove("mouse-entered"),File.backupDocumentSnap()}catch(e){console.sendError(e)}finally{return"DONE"}};h(".sidebar-content"),h(".sidebar-mac-tab");var v,y=function(i){File.isBroken||(i=i||"").toLowerCase()!=(File.filePath||"").toLowerCase()&&c.tryLeaveDocument(function(e){if(!e){var t,n=f.getCurrentWindow();g.getDocumentController();File.contentSnapRestoredTime=-1,File.buildDocumentSnap(),(t=g.getDocumentController().switchDocument(n.id,i)).snap?(s.setFileTitle(i,t.snap.fileEncode),File.onSwitchDocumentTarget(t.snap)):(File.fileName=void 0,File.onSwitchDocumentTarget(null,i))}},!0)},b=[],w=o.Model.extend({initialize:function(e){this.editor=e,this.root,this.items,this.fsWatcher,this.fileTree=new d(this),this.fileList=new u(this),this.useTreeStyle=File.option.useTreeStyle,this.supportResize_,this.onInit_=!0,this.bindLiveResize(),this.defaultTab=File.option.sidebarTab||(File.isMac?"file-list":"outline"),"outline"==this.defaultTab?document.querySelector("#typora-sidebar").classList.add("active-tab-outline"):document.querySelector("#typora-sidebar").classList.add("active-tab-files"),File.isNode&&h("#reveal-folder-from-sidebar-menu").text(h.localize.getString("Reveal in File Explorer"))},supportResize:function(){return void 0===this.supportResize_&&(this.supportResize_=!(!window.CSS||!window.CSS.supports||!window.CSS.supports("--sidebar-width",0)&&!window.CSS.supports("(--foo: red)"))),this.supportResize_},bindLiveResize:function(){var n=h("#typora-sidebar-resizer"),i=this;if(this.supportResize()){var r,o,a=!1;n.on("mousedown",function(e){1===e.which&&(r=!0)}).on("mousemove",function(e){if(1===e.which&&r){a||(a=!0,n.addClass("dragging"),o=window.innerWidth-220);var t=Math.min(Math.max(160,e.pageX),o);n.children().css("left",t)}}).on("mouseup",function(e){if(a){a=r=!1,n.removeClass("dragging"),n.children().css("left","");var t=Math.min(Math.max(160,e.pageX),o);i.setSidebarWidth(t,!0)}});var e=window.app&&g.setting.get("sidebar-width");e&&this.setSidebarWidth(e,!1)}else n.remove()},setSidebarWidth:function(e,t){var n=e?e+"px":"";(document.documentElement.style.setProperty("--sidebar-width",n),File.isMac)&&("true"!=(window.getComputedStyle(document.body).getPropertyValue("--typora-center-window-title")||"").trim()&&document.body.classList.contains("pin-outline")?g.window.setTitlebarTextMarginLeft(e):g.window.setTitlebarTextMarginLeft(void 0));t&&g.setting.put("sidebar-width",e)},isSuppressOnChange:function(){return l},markFocusOnDialogClose:function(){i=!0,setTimeout(function(){i=!1},200)},pauseOnChange:function(e){l=!0,e&&setTimeout(function(){l=!1},File.isMac?2e3:200)},resumeOnChange:function(){l=!1},isFileTabShown:function(){return!!document.querySelector(".pin-outline .active-tab-files")},isSidebarShown:function(){return document.body.classList.contains("pin-outline")},isOutlineShown:function(){return 0<h(".pin-outline .active-tab-outline").length},getActiveTab:function(){return this.isSidebarShown()?this.isFileTabShown()?this.useTreeStyle?"file-tree":"file-list":"outline":""},togglePanel:function(e){this.isSidebarShown();this.getActiveTab()==e?this.toggleSidebar():this.showSidebar(e)},toggleSidebar:function(){this.isSidebarShown()?this.hideSidebar():this.showSidebar()},tmpHideSidebar:function(e){this.savedSidebarStatus=this.isSidebarShown(),this.editor.docMenu.autoHideOutline(),this.hideSidebar(!e)},recoverSidebar:function(){this.savedSidebarStatus&&this.showSidebar()},hideSidebar:function(e){this.editor.docMenu.storeOutline(),document.querySelector("#typora-sidebar").classList.remove("open"),document.body.classList.remove("pin-outline"),!e&&g&&g.setting.put("sidebar_tab",""),h(window).trigger("resize"),File.isMac?g.window.setTitlebarTextMarginLeft(void 0):window.ClientCommand.refreshViewMenu()},showSidebar:function(e,t){this.editor.docMenu.autoHideOutline(),t&&this.isSidebarShown()?this.switch(e):this.show(e)},show:function(e){document.querySelector("#typora-sidebar").classList.add("open"),document.body.classList.add("pin-outline"),this.switch(e||this.getActiveTab()||this.defaultTab),this.editor.docMenu.renderOutline(),h(window).trigger("resize"),File.isMac&&"true"!=(window.getComputedStyle(document.body).getPropertyValue("--typora-center-window-title")||"").trim()&&g.window.setTitlebarTextMarginLeft(document.querySelector("#typora-sidebar").getBoundingClientRect().width)},switchTreeOrList:function(e){(this.useTreeStyle!==e||this.onInit_)&&(this.onInit_=!1,this.useTreeStyle=e,h(".sidebar-content").scrollTop(0),this.useTreeStyle?h("#typora-sidebar").addClass("use-file-tree-style").removeClass("use-file-list-style").find("#sidepanel-segmented-input-files").attr("data-localize","Files").text(h.localize.getString("Files")):h("#typora-sidebar").addClass("use-file-list-style").removeClass("use-file-tree-style").find("#sidepanel-segmented-input-files").attr("data-localize","Articles").text(h.localize.getString("Articles")),h("#sidepanel-segmented-input-files").localize("Front",{language:File.language,pathPrefix:"locales"}),File.isNode&&window.ClientCommand.refreshViewMenu(),g&&g.setting.put("useTreeStyle",e)),this.isFileTabShown()&&!this.renderIfNeed()&&this.markCurrentFile(!0),h("[data-side-mode]").removeClass("selected-folder-menu-item"),this.useTreeStyle?h("[data-side-mode='file-tree']").addClass("selected-folder-menu-item"):h("[data-side-mode='file-list']").addClass("selected-folder-menu-item"),h("#sidebar-footer-main-item-label").attr("data-localize","").text(c.getFileNameFromPath(File.getMountFolder())||h.localize.getString("Open Folder...")),g&&g.setting.put("sidebar_tab",e?"file-tree":"file-list")},openFile:function(e){e&&!File.isBroken&&(h("#sidebar-files-menu").trigger("blur"),File.isMac?g.controller.switchDocumentTarget(e):(File.megaMenu.hide(),y(e)))},openFileInNewWindow:function(e,t){e&&(File.backupDocumentSnap(),File.isMac?t?g.app.openFolder(e):g.app.openInTypora(e,!0):f.app.openFileOrFolder(e,{forceCreateWindow:!0,mountFolder:File.getMountFolder()}))},onLoadFolderFailed:function(e){e=e||this.slient;var t=this;e?"pinFolder"==this.slient&&f.dialog.showMessageBox({type:"question",message:h.localize.getString("Cannot open folder {0}").format(File.mountFolder_),buttons:[h.localize.getString("Ignore","Panel"),h.localize.getString("Choose Default Folder","Panel")],defaultId:1,normalizeAccessKeys:!0},function(e){f.app.setting.put("restoreWhenLaunch",0),1==e&&f.dialog.showOpenDialog({defaultPath:File.mountFolder_,properties:["openDirectory","promptToCreate"]},function(e){0<e.length&&(f.app.setting.put("restoreWhenLaunch",3),f.app.setting.put("pinFolder",e[0]),t.setMountFolder(e[0]))})}):alert(h.localize.getString("Cannot open folder {0}").format(File.mountFolder_)),File.isNode&&f.app.setting.removeRecentFolder(File.getMountFolder()),h("#file-library-tree, #file-library-list-children").attr("data-state","").html(""),File.mountFolder_=null,this.root=null,this.slient=!1,this.refreshMenuVisibility()},addFolderWatchByWin:function(i,e){if(i){var a=this;this.fsWatcher&&this.fsWatcher.close();reqnode("fswin-aio");var t={WATCH_SUB_DIRECTORIES:!0,CHANGE_FILE_SIZE:!1};t.CHANGE_LAST_WRITE=!e,t.CHANGE_LAST_ACCESS=!1,t.CHANGE_CREATION=!0,t.CHANGE_ATTRIBUTES=!1,t.CHANGE_SECUTITY=!1,this.folderWatchedOnWin=!0,this.fsWatcher=reqnode("fswin-aio").dirWatcher(i,function(e,t){if(!l){if(t&&t.OLD_NAME,"ERROR"==e)return a.folderWatchedOnWin=!1,void("INITIALIZATION_FAILED"==(n=t)?console.sendError("failed to initialize the watcher. any failure during the initialization may case this error. such as the path is inaccessible or nonexistent."):"UNABLE_TO_WATCH_SELF"==n?console.sendError('failed to watch parent diectory. it means the "MOVED" event will nolonger fire. this error always occurs at the start up under winxp. since the GetFinalPathNameByHandleW API is not available.'):"UNABLE_TO_CONTINUE_WATCHING"==n&&console.sendError('some error makes the watcher stop working. perhaps the directory you are watching is deleted or becoming inaccessible. the "ENDED" event will fire after this error.'));if("STARTED"!=e)if("MOVED"!=e){var n,i,r;i=e,r=t,v&&clearTimeout(v),b.push([i,r]),v=setTimeout(s,200)}else{if(File.filePath&&0==File.filePath.indexOf(File.getMountFolder()+"\\")){var o=t+"\\"+File.filePath.substr(File.getMountFolder().length);doApplyRename(o)}a.onRootChanged(t)}else console.log("start monitoring folder change.")}},t)}function s(){var e=b.clone();v=null,b=[];var t=[],n=[];e.forEach(function(e){a.fileTree.onChangeForWin(e[0],e[1],i,t),a.fileList.onChangeForWin(e[0],e[1],i,n)})}},bindContext:function(){var a,s=this;function e(e){if((a=this)==document.querySelector("#file-library")&&s.useTreeStyle){if(e.target!=this||!File.editor.library.root)return!1;a=s.findElemFromPath(File.editor.library.root.path)[0],h("#file-menu").children("li").hide().end().find('[data-action="new_file"],[data-action="new_folder"]').show()}else h("#file-menu li").show();File.sync(),s.editor.lastCursor=s.editor.selection.buildUndo(),h("#write").blur(),h(".context-menu").removeClass("show").find(".active").removeClass("active");var t=h(a).closest(".file-library-node").focus(),n=h("#file-menu").addClass("show");s.useTreeStyle?(n.find('[data-action="new_folder"]').show(),t.attr("data-path")==File.getMountFolder()?n.find("[for-file]").hide():"true"==t.attr("data-is-directory")?n.find("[for-file]:not([for-folder])").hide():n.find("[for-folder]:not([for-file])").hide()):(n.find('[data-action="new_folder"]').hide(),n.find("[for-folder]:not([for-file])").hide());var i=n.height()+48,r=e.clientX>window.innerWidth-220?window.innerWidth-220:e.clientX,o=e.clientY>window.innerHeight-i?window.innerHeight-i:e.clientY-h("#top-titlebar").height()+8;return n.css({top:o+"px",left:r+"px"}),t.one("blur",function(){document.activeElement&&document.activeElement.classList.contains("file-node-content")||h(".context-menu").removeClass("show")}),!1}h("#file-menu").on("mousedown","[data-key]",function(e){var t=this.getAttribute("data-action");if(t&&1==e.which){switch(h(".context-menu").removeClass("show").find(".active").removeClass("active"),t){case"open":s.openFileCommand(a);break;case"open_in_new_window":s.openFileInNewWindowCommand(a);break;case"new_file":return s.newFileCommand(a),!1;case"new_folder":return s.newFolderCommand(a),!1;case"delete":s.deleteFileCommand(a);break;case"rename":return s.getDelegate().renameFileCommand(a),!1;case"copy_path":s.copyFullPathCommand(a);break;case"reveal":s.revealFileInFinderCommand(a);break;default:return}s.editor.restoreLastCursor(null,!0)}}),h("#file-library").on("contextmenu",".file-node-content, .file-list-item",e).on("contextmenu",e)},bindEvents:function(){var n=this,e=this.editor;function t(){h(".show-sidebar-footer-context").removeClass("show-sidebar-footer-context")}File.isNodeHtml,h("#sidepanel-segmented-input-files").click(function(){n.switch("files",!0)}),h("#sidepanel-segmented-input-outline").click(function(){n.switch("outline",!0)}),h("#typora-sidebar").on("keydown","[tabindex]",function(e){"Esc"==p[e.keyCode||e.which]&&n.editor.focusCid&&n.editor.restoreLastCursor(null,!0)}).on("mousedown","[tabindex]",function(e){if("INPUT"!=e.target.tagName){var t=n.editor.selection.buildUndo();t&&(n.editor.lastCursor=t)}}),h("#ty-sidebar-footer").on("click","#sidebar-new-file-btn",function(){return e.focusAndRestorePos(),n.newFile(File.getMountFolder()),!1}).on("click","#switch-file-list-btn",function(){return e.focusAndRestorePos(),n.switchTreeOrList(!n.useTreeStyle),!1}).on("click","#target-cur-file-btn",function(){return e.focusAndRestorePos(),File.getMountFolder()&&n.getDelegate().focusToFile(c.getCurrentFilePath()),!1}).on("click","#sidebar-menu-btn",function(){return e.focusAndRestorePos(),h(".show-sidebar-footer-context").length?t():n.showSidebarMenu(),!1}),h(".sidebar-tabs").on("click","#hide-sidebar-btn",function(){return e.focusAndRestorePos(),n.hideSidebar(),!1}).on("click","#switch-sidebar-icon",function(){return e.focusAndRestorePos(),n.switch(n.isFileTabShown()?"outline":"files"),!1}),h("#sidebar-files-menu").on("blur",function(){t()}).on("mousedown","#close-sidebar-menu-btn",function(){t()}).on("mousedown","#new-file-from-sidebar-menu",function(e){1==e.which&&n.newFile(File.getMountFolder())}).on("mousedown","#reveal-folder-from-sidebar-menu",function(e){1==e.which&&File.getMountFolder()&&(File.isMac?g.path.openFolderInFinder(File.getMountFolder()):f.shell.openItem(File.getMountFolder()))}).on("mousedown","#refresh-from-sidebar-menu",function(e){1==e.which&&File.getMountFolder()&&n.refreshPanelCommand()}).on("mousedown","#open-folder-from-sidebar-menu",function(e){1==e.which&&setTimeout(n.selectFolder.bind(n),100)}).on("mousedown","[data-side-mode]",function(e){1==e.which&&n.switch(this.getAttribute("data-side-mode"))}).on("mousedown",".folder-menu-item",function(e){1==e.which&&File.getMountFolder()!=this.getAttribute("data-path")&&(File.isMac?g.controller.switchFolder(this.getAttribute("data-path")):g.switchFolder(this.getAttribute("data-path"),f.getCurrentWindow()))}).on("click","#ty-group-by-folder-btn",function(e){return n.getDelegate().setGroupByFolder(!n.fileList.expandFolders),!1}).on("click","#ty-sort-by-natural-btn",function(){return n.getDelegate().setSortType(0),!1}).on("click","#ty-sort-by-name-btn",function(){return n.getDelegate().setSortType(1),!1}).on("click","#ty-sort-by-date-btn",function(){return n.getDelegate().setSortType(2),!1}).on("keydown",function(e){"Esc"==p[e.keyCode||e.which]&&this.blur()}),this.fileTree.bindEvents(),this.fileList.bindEvents(),File.isNodeHtml&&this.bindContext()},selectFolder:function(){if(File.isMac)g.controller.selectFolder();else{var e=f.dialog,t=f.getCurrentWindow(),n=this;e.showOpenDialog(t,{buttonLabel:h.localize.getString("Select"),properties:["openDirectory"]},function(e){var t=(e||[])[0];t&&n.onRootChanged(t)})}},showSidebarMenu:function(){h(".sidebar-footer").addClass("show-sidebar-footer-context");var s=h("#sidebar-files-menu").focus();function l(e,t){var n=h(h("#folder-menu-item-template").html());return n.find("span").text(c.getFileNameFromPath(e)),n.attr("data-path",e),n.attr("ty-hint",r.abbreviatingWithTilde(e)),t.before(n),n}!function(){s.find(".folder-menu-item").remove().end().find(".folder-menu-group").show();var e=h(".sidebar-content").height(),t=s.find("#reveal-folder-from-sidebar-menu")[0].clientHeight,n=s[0].clientHeight,i=Math.max(0,Math.min(6,Math.floor((e-n-20)/t))),r=File.isMac?g.controller.getRecentFolders():g.setting.getRecentFolders().map(function(e){return e.path});r=r.slice(0),File.getMountFolder()?(r.remove(File.getMountFolder()),r=r.slice(0,(i||1)-1)):r=r.slice(0,i);for(var o=h("#folder-menu-item-after"),a=0;a<r.length;a++)l(r[a],o);File.getMountFolder()?l(File.getMountFolder(),o).addClass("selected-folder-menu-item"):0==r.length&&s.find(".folder-menu-group").removeClass("show")}()},init:function(){if(File.option.sidebarTab&&this.show(File.option.sidebarTab),this.bindEvents(),File.isMac&&g.controller.isLoadFolder()&&!c.getCurrentFilePath()&&(this.isFileTabShown()||this.show(this.useTreeStyle?"file-tree":"file-list"),this.useTreeStyle)){g.controller.setLoadFolder(!1)}},switch:function(e,t){if(h(".sidebar-content").scrollTop(0),"outline"==e){var n;h("#typora-sidebar").addClass("active-tab-outline").removeClass("active-tab-files"),h("[data-side-mode]").removeClass("selected-folder-menu-item"),h("[data-side-mode='outline']").addClass("selected-folder-menu-item"),h("#sidebar-footer-main-item-label").text(h.localize.getString("Outline")),this.editor.docMenu.highlightVisibleHeader(),this.useTreeStyle?(n=h.localize.getString("Switch to File Tree view"),h("#switch-sidebar-icon").html('<span class="ty-icon ty-file-tree"></span>').attr("ty-hint",n).attr("aria-label",n)):(n=h.localize.getString("Switch to File List view"),h("#switch-sidebar-icon").html('<span class="ty-icon ty-three-cells"></span>').attr("ty-hint",n).attr("aria-label",n))}else{h("#typora-sidebar").removeClass("active-tab-outline").addClass("active-tab-files");var i=this.useTreeStyle||!1;"file-list"==e?i=!1:"file-tree"==e?i=!0:e=i?"file-tree":"file-list",this.switchTreeOrList(i),this.refreshMenuVisibility(),h("#switch-sidebar-icon").html('<span class="ty-icon ty-list"></span>').attr("ty-hint",h.localize.getString("Switch to Outline view"))}h("#switch-sidebar-icon").localize("Front",{language:File.language,pathPrefix:"locales"}),g&&g.setting.put("sidebar_tab",e),File.isNode?window.ClientCommand.refreshViewMenu():h(".sidebar-tab").removeClass("active").filter("outline"==e?"#sidepanel-segmented-input-outline":"#sidepanel-segmented-input-files").addClass("active")},calcMountFolder:function(a){File.getMountFolder();if(File.isMac)File.mountFolder_=g.controller.mountFolder();else{if(!File.isNode)return null;if(!File.getMountFolder())try{File.mountFolder_=function(e){var t=reqnode("path"),n=reqnode("fs"),i=e;if(!e)return null;for(;i&&/^\w*\/+\w/.exec(i);){var r=n.readdirSync(i);if(-1<r.indexOf(".git")||-1<r.indexOf(".svn")||-1<r.indexOf(".hg")||-1<r.indexOf("package.json"))return i;if(/((dropbox\/apps\/[^\/]+)|pages|articles?|blogs?|content)\/?$/i.exec(i))return i;if(/(_?posts?|_?drafts?)\/?$/i.exec(i))return i;if(/(node_modules)\/[^\/]+\/?$/i.exec(i))return i;var o=i;if((i=t.join(i,"../"))==o||a)break}return/^\w*\/+\w/.exec(e)?e.replace(/[\/\\]$/,"")||null:e}(c.getCurrentFileFolderPath()),File.editor.quickOpenPanel.cacheFolder(File.mountFolder_)}catch(e){}}return this.isFileTabShown()&&(File.getMountFolder()?h("#sidebar-menu-btn .sidebar-footer-main-item-label").text(c.getFileNameFromPath(File.getMountFolder())):h("#sidebar-menu-btn .sidebar-footer-main-item-label").text("Open Folder…")),File.getMountFolder()},fetchRecentFile:function(){},renderIfNeed:function(){return this.useTreeStyle?this.fileTree.renderIfNeed():this.fileList.renderIfNeed()},findElemFromPath:function(e){return h(".file-library-node[data-path='"+r.escapeSelector(e)+"']")},revealInSidebar:function(){this.isFileTabShown()?this.markCurrentFile():c.getCurrentFilePath()&&this.showSidebar("files")},revealInFileList:function(){this.showSidebar("file-list"),this.markCurrentFile()},revealInFileTree:function(){this.showSidebar("file-tree"),this.markCurrentFile()},markCurrentFile:function(e,t){var n=c.getCurrentFilePath();n&&(this.markOpenedFile(n,t),this.getDelegate().focusToFile(n,e))},markOpenedFile:function(e,t){return e?(t||h(".file-library-node.active").removeClass("active"),this.findElemFromPath(e).addClass("active")):h()},end:function(){this.fileTree.needRepaint(),this.fileList.needRepaint(!0),this.root=null,File.mountFolder_=null,this.fsWatcher?(this.fsWatcher.close(),this.fsWatcher=null,v&&clearTimeout(v)):File.isUnixNode&&(this.fileTree.unixWatchers={},this.fileList.unixWatchers={},reqnode("pathwatcher").closeAllWatchers())},refreshMenuVisibility:function(){var e=h("#ty-sidebar-footer");File.getMountFolder()?(e.find(".empty-menu-group").removeClass("show"),e.find(".not-empty-menu-group").addClass("show")):(e.find(".empty-menu-group").addClass("show"),e.find(".not-empty-menu-group").removeClass("show")),h("#sidebar-footer-main-item-label").text(c.getFileNameFromPath(File.getMountFolder())||h.localize.getString("Open Folder..."))},onRootChanged:function(e){this.end(),File.isNode&&(File.mountFolder_=e)&&f.app.setting.addRecentFolder(e),h("#file-library:visible").length&&this.renderIfNeed(),this.editor.quickOpenPanel.cacheFolder(e),this.refreshMenuVisibility()},setMountFolder:function(e,t,n){this.slient=n,this.onRootChanged(e),t&&this.showSidebar(this.useTreeStyle?"file-tree":"file-library",!0)},onFileChanges:function(e){if(File.getMountFolder()){var t=JSON.parse(e);this.fileTree.onChangeForMac(t),this.fileList.onChangeForMac(t)}},getDelegate:function(){return this.useTreeStyle?this.fileTree:this.fileList},newFile:function(e){File.getMountFolder()&&this.getDelegate().newFile(e)},openFileCommand:function(e){e||retrun;var t=this.editor.getJQueryElem(e).closest(".file-library-node").attr("data-path");this.openFile(t),this.editor.docMenu.autoHideOutline()},openFileInNewWindowCommand:function(e){if(e=this.editor.getJQueryElem(e).closest(".file-library-node")[0]){var t="true"==e.dataset.isDirectory,n=e.dataset.path;this.openFileInNewWindow(n,t)}},copyFullPathCommand:function(e){var t=this.editor.getJQueryElem(e).closest(".file-library-node").attr("data-path");this.editor.UserOp.setClipboard("<span>"+t+"</span>",null,t,!0)},revealFileInFinderCommand:function(e){var t="string"==typeof e?e:this.editor.getJQueryElem(e).closest(".file-library-node").attr("data-path");File.isMac?g.path.showInFinder(t):f.shell.showItemInFolder(t)},renameFileCommand:function(e,t){this.getDelegate().renameFileCommand(e,t)},newFileCommand:function(e,t){this.getDelegate().newFileCommand(e,t)},newFolderCommand:function(e){this.fileTree.newFolderCommand(e)},deleteFileCommand:function(e){var t=this.editor.getJQueryElem(e).closest(".file-library-node"),n=t.attr("data-path");if(n==c.getCurrentFilePath()){var i=this.useTreeStyle?h():t.filter(".file-list-item").next();i.length?this.openFileCommand(i[0]):File.isNode?y(null):g.controller.switchDocumentTarget("")}t.hide(),File.isMac?g.library.trashItem(n):File.isNode&&f.shell.moveItemToTrash(n)},refreshPanelCommand:function(){var e=File.getMountFolder();this.end(),File.isNode?File.mountFolder_=e:(g.controller.switchFolder(e),g.controller.bindFolderMonitor()),this.renderIfNeed(),this.refreshMenuVisibility()},bindRename:function(i,t,n,r){var o,a,s=i.val(),l=this;function c(e){return File.isWin?e.replace(/[\\\/:*?"<>\|\000-\031]/g,"").trim():e.replace(/[\/\\\000-\031]/g,"")}function d(){if(!a){a=!0;var e=c(i.val());0<e.length&&e!=s?(i.val(e),t(i)):n()}}function u(e){var t=i.val(),n=t.lastIndexOf(".");n<0&&e&&(n=t.length),0<n&&i[0].setSelectionRange(0,n)}i.one("blur",function(){var e;o||(o=!0,r?d():((e=i).val(c(e.val())),s!=e.val()?File.isLinux?f.dialog.showMessageBox(null,{title:h.localize.getString("Confirm"),message:h.localize.getString('Rename to "{0}" ?').format(e.val()),type:"question",buttons:["OK","Cancel"]},function(e){0==e?(l.markFocusOnDialogClose(),d()):n()}):confirm(h.localize.getString('Rename to "{0}" ?').format(e.val()))?(l.markFocusOnDialogClose(),d()):n():n()))}).on("keydown",function(e){return"Enter"==p[e.keyCode||e.which]?(o=!0,d(),!1):"Esc"==p[e.keyCode||e.which]?(o=!0,n(),!1):"A"==p[e.keyCode||e.which]&&(File.isMacOrMacNode?e.metaKey:e.ctrlKey)?(u(!0),!1):void 0}).on("mousedown",function(e){e.stopPropagation()}).on("click",function(e){e.stopPropagation()}).on("mouseup",function(e){1==e.which&&this.selectionEnd==this.selectionStart&&this.selectionEnd==this.value.length&&u()}).on("focus",u)}});n.exports=w}),define("app/editor/FileTree",["app/document/StringUtils","exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/window/FileHelper","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileInfoPanel","app/editor/KeyMaster"],function(e,t,n){"use strict";var a,p=e("app/document/StringUtils"),i=e("exoskeleton-master/exoskeleton"),r=e("app/document/Node"),u=(r.Node,r.TYPE,e("app/window/FileHelper")),h=e("app/window/FileInfoPanel"),f=(p=e("app/document/StringUtils"),e("app/editor/KeyMaster").map,e("jquery/jquery")),g=window.reqnode?reqnode("electron").remote:null,m=g?g.app:window.app,v=!1,o=(g&&g.getCurrentWindow(),"_recent"),s=[];var c=u.statWrapper;u.allowedExtensions;function l(n,e){return File.isMac?new Promise(function(e,t){e(y(n))}):b(n,!1,e)}function d(e,t){return p.naturalSort(e.name,t.name)}function y(e){var t=m.library.listDocsUnder(e.path);if(!t)return null;var n=JSON.parse(t);return e.fetched=!0,e.subdir=n.subdir,e.subdir.forEach(function(e){e.fetched=!0}),e.content=n.content,e.isDirectory=n.isDirectory,e.isFile=n.isFile,e.name=n.name,function e(t){t.subdir&&(t.subdir.sort(d),t.content.sort(d),t.subdir.forEach(e))}(e),e}function b(r,o,a){var s=reqnode("fs-plus"),t=reqnode("path"),l=File.isWin?"\\":"/";return new Promise(function(n,e){var i=r.path;if(r.name=t.basename(i)||i,r.subdir=[],r.content=[],r.fetched=!o,"."==r.name[0])return n();c(i,function(e){if(!e||e.shouldIgnore)return n();if(r.isDirectory=e.isDir,r.isFile=e.isFile,e.isFile)return r.fetched=!0,u.isSupportedFile(r.name)?n(r):n();if(e.isDir){if(t=i,File.filePath&&t&&0==File.filePath.indexOf(t.replace(/[\/\\]$/,"")+l))r.isOpen=!0;else if(o)return n(r);r.isDirectory&&(r.fetched||r.isOpen)&&File.isUnixNode&&a.addFolderWatchByUnix(r),s.list(i,void 0,function(e,t){if(e)return n();Promise.all(t.map(function(e){return b({path:e},!r.isOpen,a)})).then(function(e){if(0<r.subdir.length+r.content.length)return r.fetched=!0,void n(r);e.forEach(function(e){e&&(e.isDirectory?r.subdir.push(e):r.content.push(e))}),r.fetched=!0,r.subdir.sort(d),r.content.sort(d),n(r)})})}var t})})}var w=i.Model.extend({initialize:function(e){this.parent=e,this.editor=e.editor,this.$template=f(document.querySelector("#file-library-node-template").textContent),this.root,this.unixWatchers={}},getRoot:function(){return this.parent.root},setRoot:function(e){return this.parent.root=e},renderNode:function(e){if(!e)return f();var t=this.$template.clone();e==this.getRoot()?(e.isOpen=!0,t.find(".file-node-open-state").remove()):e.isDirectory&&e.subdir&&(e.subdir.length||e.content.length)&&t.attr("data-has-sub","true").addClass(e.isOpen?"file-node-expanded":"file-node-collapsed");var n=e.name.lastIndexOf(".");if((n<0||e.isDirectory)&&(n=e.name.length),t.find(".file-node-title-name-part").text(e.name.substr(0,n)),t.find(".file-node-title-ext-part").text(e.name.substr(n)),t.attr("data-path",e.path).attr("data-is-directory",e.isDirectory),t.find(".file-node-icon").addClass(function(e){return e==this.getRoot()?e.path==o?"fa fa-history":"fa fa-folder":e.isDirectory?"fa fa-folder":"fa fa-file-text-o"}.call(this,e)),e.isDirectory||t.addClass("file-library-file-node"),e==this.getRoot()?t.addClass("file-node-root"):e.isDirectory||e.path!=u.getCurrentFilePath()||t.addClass("active"),e.isDirectory&&e.subdir){var i=t.find(".file-node-children");i.html(""),e.isOpen&&(e.subdir.forEach(function(e){i.append(this.renderNode(e))},this),e.content.forEach(function(e){i.append(this.renderNode(e))},this))}return t},renderIfNeed:function(){return!v&&(this.render(),File.isWin&&this.parent.addFolderWatchByWin(File.getMountFolder()),!0)},render:function(){v=!0;var t=this,n=File.getMountFolder();this.getRoot()||(this.parent.root={path:this.parent.calcMountFolder(),isOpen:!0},this.getRoot().path?l(this.getRoot(),t).then(function(e){(t.parent.root=e)?function(){v="complete",f("#file-library-tree").html("").append(this.renderNode(this.getRoot())).attr("data-state",""),this.parent.markCurrentFile()}.call(t):File.getMountFolder()&&t.parent.onLoadFolderFailed(!n),t.parent.slient=!1}):t.parent.onLoadFolderFailed(!0)),this.getRoot()?f("#file-library-tree").attr("data-state","rendering").html(""):f("#file-library-tree").html("")},findElemFromPath:function(e){return f(".file-tree-node[data-path='"+p.escapeSelector(e)+"']")},focusToFile:function(e){if(this.getRoot()&&e&&!0!==v){var t=File.getMountFolder(),n=(File.isWin,window.innerHeight,f(".sidebar-content"));n.scrollTop();e.indexOf(t)}},markOpenedFile:function(e){return this.parent.markOpenedFile(e).filter(".file-tree-node")},needRepaint:function(){v=!1},addFolderWatchByUnix:function(i){var r=this,e=reqnode("pathwatcher"),t=this.unixWatchers[i.path];function o(){var e=s.clone();a=null,s=[];var t=[];r.parent.isSuppressOnChange()||e.forEach(function(e){r.onChangeForLinux(e[0],e[1],t)})}t&&t.close();try{this.unixWatchers[i.path]=e.watch(i.path,function(e){var t,n;t=e,n=i,r.parent.isSuppressOnChange()||(a&&clearTimeout(a),s.push([t,n]),a=setTimeout(o,200))})}catch(e){console.warn("Unable to watch path "+i.path)}},findNodeFromPath:function(e,o){if(e&&this.getRoot()){File.isWin;return o=o||[],function e(t,n){if(t){if(t.path==n)return t;o.push(t);for(var i=0;i<t.subdir.length;i++){var r=t.subdir[i];if(r.path==n)return r;if(0==n.indexOf(r.path+(File.isWin?"\\":"/")))return e(r,n)}return t.content.find(function(e){return e.path==n})}return null}(this.getRoot(),e)}},expandNode:function(t,e,n){if(!0!==v){var i=this.findNodeFromPath(e,[]),r=this;i&&(i.isOpen=!0,t.children(".file-node-children").children().length?t.removeClass("file-node-collapsed").addClass("file-node-expanded"):!i.fetched||0<i.subdir.length&&!i.subdir[0].fetched?l(i,r).then(function(e){e&&(t.replaceWith(r.renderNode(e)),f(".file-library-node.active").length||r.markOpenedFile(u.getCurrentFilePath()),n&&n())}):t.replaceWith(this.renderNode(i)),f(".file-library-node.active").length||this.markOpenedFile(u.getCurrentFilePath()),n&&n())}},onChangeForMac:function(e){if(v){var t,n=[],r=new Set,o=new Set,a=this;if(e.forEach(function(e){if(t=this.findNodeFromPath(e.path,n),this.getRoot())if("removed"==e.type)e.path==this.getRoot().path?this.parent.root=null:t&&n.length&&l.call(this,t,n.last());else if("rename"==e.type){if(e.oldPath==this.getRoot().path)return void(this.parent.root=null);n=[],t=this.findNodeFromPath(e.oldPath,n),l.call(this,t,n.last()),d(e.newPath,e.isDir)}else"created"!=e.type||t||t==this.getRoot()||d(e.path,e.isDir)},this),this.getRoot()){o.forEach(function(e){(e=y(e))&&s.call(this,e)},this),r.forEach(function(e){e.subdir.sort(c),e.content.sort(c),s.call(this,e)},this);var i=u.getCurrentFilePath();this.parent.markOpenedFile(i),this.focusToFile(i)}else this.parent.onRootChanged()}function s(e){var t=a.findElemFromPath(e.path);t.length&&t.replaceWith(this.renderNode(e))}function l(e,t){e&&(e.isDirectory?t.subdir.remove(e):t.content.remove(e),t.subdir.length+t.content.length==0?(e.isOpen=!1,s.call(this,t)):a.findElemFromPath(e.path).remove())}function c(e,t){return p.naturalSort(e.name,t.name)}function d(e,t){var n=p.pathByDeleteLastComponent(e),i=a.findNodeFromPath(n);i&&function(t,e,n){if(e.fetched&&!o.has(e)){var i;if(e.content.length+e.subdir.length==0&&o.add(e),n){if(-1<e.subdir.findIndex(function(e){return e.path==t}))return;(i=y({path:t}))&&e.subdir.push(i)}else{if(-1<e.content.findIndex(function(e){return e.path==t}))return;i={path:t,isDirectory:!1,name:t.split("/").last()},e.content.push(i)}r.add(e)}}.call(a,e,i,t)}},isPathTooDeepToDisplay:function(e,t){return t=t||[],this.findNodeFromPath(e,t),!t.length||!!e.substr(t.last().path.length).replace(/^[\\\/]+/,"").match(/[\\\/]/)},onChangeForWin:function(e,t,n,s){if(v&&t&&!this.parent.isSuppressOnChange()){var i="string"==typeof t?t:t.OLD_NAME,l=(reqnode("fs"),reqnode("path")),r=l.join(n,i),o=(reqnode("util"),[]),c=File.isWin?"\\":"/",d=this;if(!this.isPathTooDeepToDisplay(r,o))if("REMOVED"!=e){if("ADDED"!=e)return"RENAMED"==e?(a(r,o),a(r.replace(/\$$/,""),o),void u(l.join(n,t.NEW_NAME))):void 0;u(r,o)}else a(r,o)}function a(e,t){t=t||[];var n=d.findNodeFromPath(e,t);if(n){var i=t.last();i.subdir.remove(n),i.content.remove(n),i.subdir.length+i.content.length==0?d.findElemFromPath(i.path).replaceWith(d.renderNode(i)):d.findElemFromPath(e).remove()}}function u(t,e){if(e=e||[],!s.find(function(e){return e==t||0==t.indexOf(e+c)})){s.push(t);var n=d.findNodeFromPath(t),i=l.dirname(t),r=d.findNodeFromPath(i);if((!n||!n.fetched)&&r&&r.fetched){var o=!r.isOpen,a=r.content.length+r.subdir.length==0;b({path:t},o,d).then(function(t){if(t){var e=t.isDirectory?r.subdir:r.content,n=e.findIndex(function(e){return t.path.localeCompare(e.path)<=0});if(n<0&&(n=e.length),e.splice(n,0,t),t.isDirectory||(n+=r.subdir.length),a)d.findElemFromPath(r.path).replaceWith(d.renderNode(r));else{var i=d.findElemFromPath(r.path).children(".file-node-children");(r.isOpen||i.children().length)&&i[0].insertChildAtIndex(d.renderNode(t)[0],n)}}})}}}},onChangeForLinux:function(e,t,n){var i=this;n.find(function(e){return e==t.path||0==t.path.indexOf(e+"/")})||(n.push(t.path),"change"==e&&b(t,!1,this).then(function(e){if(e){var t=i.findElemFromPath(e.path);t.length&&t.replaceWith(i.renderNode(e)),i.parent.markCurrentFile()}}),"rename"==e&&t==i.getRoot()&&i.parent.onRootChanged(),"delete"==e&&t==i.getRoot()&&i.parent.onRootChanged())},newFile:function(e){this.newFileCommand(this.findElemFromPath(e),!1)},newFolderCommand:function(e){this.newFileCommand(e,!0)},newFileCommand:function(e,c){var t=this.editor.getJQueryElem(e).closest(".file-library-node"),d=t.attr("data-path"),n="true"==t.attr("data-is-directory"),u=this;if(d)if(n||(d=p.pathByDeleteLastComponent(d)),n){u=this;this.expandNode(t,d,function(){i.call(u)})}else i.call(this);function i(){var e=this.findNodeFromPath(d);if(e){var t,n,i=(t=e,n=0,c?(t.subdir.forEach(function(e){var t=/^untitled folder( (\d+))?$/i.exec(e.name);t&&(n=Math.max(n,(t[2]||0)-0+1))}),"Untitled Folder"+(n?" "+n:"")):(t.content.forEach(function(e){var t=/^untitled( (\d+))?\./i.exec(e.name);t&&(n=Math.max(n,(t[2]||0)-0+1))}),"Untitled"+(n?" "+n:"")+".md")),r=File.isNode&&reqnode("fs");try{var o=this.findElemFromPath(d),a=d+(File.isWin?"\\":"/")+i,s={fetched:!0,subdir:[],content:[],isDirectory:!!c,name:i,path:a};if(c){if(File.isNode)r.mkdirSync(a);else if(!m.library.newFolder(a))return;u.parent.pauseOnChange(!0),e.subdir.push(s)}else{if(File.isNode){var l=r.openSync(a,"wx");r.close(l)}else{if(!m.library.newFile(a))return}u.parent.pauseOnChange(!0),e.content.push(s)}o.replaceWith(this.renderNode(e)),this.focusToFile(s.path),this.renameFileCommand(this.findElemFromPath(s.path)[0])}catch(e){}}}},renameFileCommand:function(e,t){f(".file-node-on-edit").removeClass("file-node-on-edit");var s=this.editor.getJQueryElem(e).closest(".file-library-node").addClass("file-node-on-edit"),l=s.attr("data-path"),n=(s.attr("data-is-directory"),s.children(".file-node-content").children(".file-tree-rename-div")),c=n.prev().text().trim(),i=n.children("input").val(c),d=this;this.parent.bindRename(i,function(e){File.isMac?(t=e,n=t.val().replace(/[\/\\]/g,""),i=p.pathByDeleteLastComponent(l)+"/"+n,d.parent.pauseOnChange(!0),l!=i&&m.library.renameFile(l,i)?(s.children(".file-node-content").children(".file-node-title").text(n),l==u.getCurrentFilePath()&&setTimeout(function(){d.parent.markCurrentFile(!1,!0)},1e3)):t.val(c),s.removeClass("file-node-on-edit"),d.editor.restoreLastCursor()):function(e){var t=e.val();d.parent.resumeOnChange(),t=File.isWin?t.replace(/[\\\/:*?"<>\|\000-\031]/g,"").trim():t.replace(/[\/\\\000-\031]/g,"");var i=p.pathByDeleteLastComponent(l)+(File.isWin?"\\":"/")+t;e.closest(".file-node-on-edit").removeClass("file-node-on-edit");var n=File.filePath&&(reqnode("fs-plus").isCaseInsensitive?0==File.filePath.toLowerCase().indexOf(l.toLowerCase()):0==File.filePath.indexOf(l)),r=g.getCurrentWindow().id,o=reqnode("fs");function a(e){g.dialog.showErrorBox(f.localize.getString("Rename Failed"),f.localize.getString('Failed to rename from "{0}" to "{1}"').format(c,t)+"\n"+e),n&&h.watchFileChange(File.filePath)}if(File.filePath,l.toLowerCase()!=i.toLowerCase()&&o.existsSync(i))return a(f.localize.getString("File with same name already exists at target path."));m.sendEvent("willRename",{oldPath:l,fromWin:r}),o.rename(l,i,function(e){if(s.removeClass("file-node-on-edit"),d.editor.restoreLastCursor(),e&&(i=l),m.sendEvent("didRename",{oldPath:l,newPath:i,fromWin:r}),File.isWin&&!d.parent.folderWatchedOnWin){s.attr("data-path",i);var t=reqnode("path").basename(i),n=t.lastIndexOf(".");n<0&&(n=t.length),s.find(".file-node-title-name-part").text(t.substr(0,n)),s.find(".file-node-title-ext-part").text(t.substr(n))}if(e)a(e);else if(!File.filePath)return})}(e);var t,n,i},function(){i.closest(".file-node-on-edit").removeClass("file-node-on-edit")}),i.focus()},bindEvents:function(){var a=this;f("#file-library-tree").on("click",".file-node-content",function(e){if(1===e.which){e.preventDefault(),e.stopPropagation(),document.activeElement.blur();var t,n,i=f(this).parent(),r=i.attr("data-path"),o=i.attr("data-is-directory");if(i.hasClass("file-node-on-edit"))return!1;if("false"==o)(File.isMacOrMacNode?e.metaKey:e.ctrlKey)?a.parent.openFileInNewWindow(r):a.parent.openFile(r);else if("true"==i.attr("data-has-sub"))i.hasClass("file-node-expanded")?(t=i,n=r,a.findNodeFromPath(n).isOpen=!1,t.addClass("file-node-collapsed").removeClass("file-node-expanded")):a.expandNode(i,r)}}).on("dragstart",".file-tree-node",function(e){})}});n.exports=w}),define("app/editor/FileList",["app/document/StringUtils","exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/window/FileHelper","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileInfoPanel","app/editor/KeyMaster","app/editor/EditHelper"],function(e,t,n){"use strict";var y,i,f,r,d,g=e("app/document/StringUtils"),o=e("exoskeleton-master/exoskeleton"),a=e("app/document/Node"),s=a.Node,b=(a.TYPE,e("app/window/FileHelper")),v=(e("app/window/FileInfoPanel"),g=e("app/document/StringUtils"),e("app/editor/KeyMaster").map,e("app/editor/EditHelper")),w=e("jquery/jquery"),u=window.reqnode?reqnode("electron").remote:null,p=u?u.app:window.app,x=w("#file-library-list-children"),C=w("#file-library-list"),h=[],l=function(e){return e.replace(/^\s*(([\n#>]+)|([-=*`\s]{3,}))/gm,"").replace(/\s*[*_`$=]+\s*/gm," ").replace(/\[([^\]]+)\]\([^)]*\)/gm,"$1")},c=function(e,t,n,i){for(var r=t+1;r<i;r++){if(0<=e[r].indexOf(":"))return n;n+="\n"+e[r]}return n},m=function(e,t){var n=t.lastIndexOf(".");n<0&&(n=t.length),e.find(".file-list-item-file-name-part").text(t.substr(0,n)),e.find(".file-list-item-file-ext-part").text(t.substr(n))},k=1,S=2,T=function(e,t){var n,i=e.split(/\r*\n+/),r=i.length;if("---"==i[0]){for(var o,a=[],s=1;s<r;s++){if("---"==i[s])return a.length<3&&a.push(l(i.slice(s+1).join("\n")||e)),a.join("\n");(n=/^\s*(title)\s*:(.+)$/.exec(i[s]))?(o=c(i,s,n[2],r))&&a.push(o.trim()):(n=/^\s*(subtitle)\s*:(.+)$/.exec(i[s]))?(o=c(i,s,n[2],r))&&a.push(o.trim()):(n=/^\s*(overview|summary|description|excerpt)\s*:(.+)$/.exec(i[s]))&&(o=c(i,s,n[2],r))&&a.push(o.trim())}return l(e)}return l(e)},F=b.statWrapper;function E(t,e){var n=File.isWin?"\\":"/";if(e.find(function(e){return e==t||0==t.indexOf(e+n)}))return!0;e.push(t)}var _=400,M=o.Model.extend({initialize:function(e){var t;this.parent=e,this.editor=e.editor,this.$template=w(document.querySelector("#file-list-item-template").textContent),this.expandFolders=(t="not_group_by_folders",File.isMac?p.setting.getBool(t)||!1:File.isNode&&p.setting.get(t)||!1),this.sortType=File.option.sortType,this.setGroupByFolder(this.expandFolders),this.setSortType(this.sortType),this.unixWatchers={},this.needRepaint(),File.isNode&&(_=Number.parseInt(p.setting.config.maxFetchCountOnFileList)||200,Number.isNaN(_)&&(_=200))},isShown:function(){return this.parent.isFileTabShown()&&!this.parent.useTreeStyle},isRendering:function(){return y},renderIfNeed:function(){return!y&&(this.render(),File.isWin&&this.parent.addFolderWatchByWin(File.getMountFolder()),!0)},appendTreeByNode:function(e,t,l,c){var i=reqnode("fs-plus"),d=reqnode("path"),u=(reqnode("util"),this),p=File.option.useFsQueue;l=l||0;var a=!!c;c=c||C;var h=[],f=0,g=function(){h=[]},r=function(){if("oversize"!=y)for(var e=0;e<20&&h.length;){e++;var t=h.shift();t[1]?n(t[0],t[2]):m(t[0],t[2])}else g()},n=function(e,n){f++,i.readdir(e,function(e,t){f--,p&&f<50&&r(),n(e,t)})},m=function(e,t){f++,F(e,function(e){f--,p&&f<50&&r(),t(e)})},v=function(o,a,s,i){if(!o)return i();var e,t;e=o,t=function(e,t){if(e)return i(void 0,e);!File.isWin&&u.addFileWatchByUnix(o,!0);var n=t.length;n||i();var r=function(){--n<=0&&i()};t.forEach(function(t){var e,n,i=d.join(o,t);e=i,n=function(e){if(y){if(!e||e.shouldIgnore)return r();if(50==l&&!0===y&&"rendering"!=c.attr("data-state")&&c.attr("data-state","rendering"),_<l)return g(),void u.endRender(!0);e.isFile?a(e,t,o,i,r)&&l++:e.isDir&&s(e,t,o,i)?v(i,a,s,r):r()}},p&&50<=f?h.push([e,!1,n]):m(e,n)})},p&&50<=f?h.push([e,!0,t]):n(e,t)};v(e,function(e,t,n,i,r){if(!e.shouldIgnore){var o={folderPath:n,folderName:b.getFileNameFromPath(n),name:t,path:i,lastModified:e.mtime};return u.fetchSummaryByNode(i,function(e){o.summary=e,u.appendItemToView(o,!1,a?c[0]:void 0),!File.isWin&&u.addFileWatchByUnix(o.path,!1,o),r()}),!0}r()},function(e,t,n,i){return!e.shouldIgnore},t=t||function(){})},fecthAllDocsByNode:function(){this.appendTreeByNode(this.parent.calcMountFolder(!0),this.endRender.bind(this))},fetchSummaryByNode:function(e,t){var i;reqnode("fs-plus").createReadStream(e,{start:0,end:600}).on("data",function(e){if("string"==typeof e)i=e;else{var t=b.detectEncodeByNode(e),n=b.getContentFromBuffer(e,t);i=n}}).on("end",function(){void 0===i&&(i=""),t(i)})},render:function(e){if(e&&this.needRepaint(),!y){y=!0,i=new Date,f=!1;var t=this;setTimeout(function(){!0===y&&"rendering"!=C.attr("data-state")&&C.attr("data-state","rendering")},500),x.html("").removeClass("show-folder-name"),File.isMac?p.library.fetchAllDocs(this.parent.calcMountFolder(!0)||""):File.isNode&&this.fecthAllDocsByNode(),setTimeout(function(){!0===y&&8e3<new Date-i&&(console.warn("render file list timeout"),t.endRender(!0))},1e4)}},endRender:function(e,t,n){if("oversize"!=y||!e){if(y=e?"oversize":"complete",w("#file-library-list").attr("data-state",y),r&&clearTimeout(r),r=setTimeout(function(){"oversize"==y&&w("#file-library-list").attr("data-state","oversize-end")},2e3),e)(File.isLinux||File.isMacNode)&&Object.values(this.unixWatchers||{}).map(function(e){try{e&&e.close()}catch(e){}});else{if(t&&File.getMountFolder())return void this.parent.onLoadFolderFailed();this.parent.markCurrentFile(!1,!0)}this.parent.slient=!1}},setSortType:function(e){if(w(".ty-side-sort-btn2").removeClass("active"),e==k?w("#ty-sort-by-name-btn").addClass("active"):e==S?w("#ty-sort-by-date-btn").addClass("active"):w("#ty-sort-by-natural-btn").addClass("active"),this.sortType!=e){this.sortType=e,p&&p.setting.put("file_sort_type",e),x.html("");var n=document.createDocumentFragment();this.expandFolders?(this.files.sort(this.compareItem_.bind(this)),this.files.forEach(function(e){this.appendItemToView(e,!1,n)},this)):this.dirArr.forEach(function(e){var t=e.content;e.content=[],t.forEach(function(e){this.appendItemToView(e,!1,n)},this)},this),x.append(n)}},setGroupByFolder:function(e){if(e?w("#ty-group-by-folder-btn").removeClass("active"):w("#ty-group-by-folder-btn").addClass("active"),this.expandFolders!=e){this.expandFolders=e,p&&p.setting.put("not_group_by_folders",e),x.html("");var t=document.createDocumentFragment();e?(this.files=[],this.dirArr.forEach(function(e){this.files=this.files.concat(e.content)},this),this.dirArr=[],this.dirMap={},this.files.sort(this.compareItem_.bind(this)),this.files.forEach(function(e){this.appendItemToView(e,!1,t)},this)):(this.dirArr=[],this.dirMap={},this.files.forEach(function(e){this.appendItemToView(e,!1,t)},this),this.files=[]),x.append(t),"oversize"==y?this.endRender(!0):"complete"==y&&this.endRender(!1)}},compareItem_:function(e,t){return this.sortType==k?e.name.localeCompare(t.name):this.sortType==S?t.lastModified-e.lastModified:g.naturalSort(e.name,t.name)},getItem:function(t){if(this.expandFolders)for(var e=this.files.length,n=0;n<e;n++){if(this.files[n].path==t)return this.files[n];if(this.files[n].folderPath==t)return{path:t,isDir:!0}}else{if(this.dirMap[t])return{path:t,isDir:!0};var i=g.pathByDeleteLastComponent(t);if(this.dirMap[i])return this.dirMap[i].content.find(function(e){return e.path==t})}},computeIndex:function(e){return(this.expandFolders?function(e){for(var t=0,n=0;n<this.files.length&&!(0<this.compareItem_(this.files[n],e));n++)t++;return this.files.splice(t,0,e),t}:function(e){var t=e.folderPath,n=this.dirMap[t],i=0,r=0;n||(n={path:t,content:[]},this.dirArr.push(n),this.dirMap[t]=n);for(var o=0;o<this.dirArr.length-1;o++){var a=this.dirArr[o];if(a.path==t)break;i+=a.content.length}for(o=0;o<n.content.length&&!(0<this.compareItem_(n.content[o],e));o++)r++;return n.content.splice(r,0,e),r+i}).call(this,e)},appendItemToView:function(e,t,n,i){if("oversize"!=y&&y){var r=i||{},o=r.forceMark,a=r.skipAnim,s=this.$template.clone();this.parent.calcMountFolder(!0);if(e&&e.path){f||File.getMountFolder()!=e.folderPath&&(f=!0,x.addClass("show-folder-name")),s.attr("data-path",e.path),s.attr("data-parent-path",e.folderPath),s.children(".file-list-item-parent-loc").text(e.folderName),s.children(".file-list-item-time").text(g.date2NatrualLang(new Date(e.lastModified),!0)),m(s,e.name);var l,c=s.children(".file-list-item-summary");if(c.text(T(e.summary,e.name)),c.html(c.html().replace(/([^\s]+)\s*\n+/g,"$1<br/>")),e.path==b.getCurrentFilePath()&&s.addClass("active"),n)this.expandFolders?n.appendChild(s[0]):(l=this.computeIndex(e),n.insertChildAtIndex(s[0],l));else{if(t){var d,u,p=this.removeItemFromView(e,!0),h=p.hasClass("active");if(p&&p.length)return u=p.prevAll().length,l=this.computeIndex(e),u!=l||e.oldPath?(e.oldPath=void 0,d=p[0].clientHeight,p.remove(),x[0].insertChildAtIndex(s[0],l),(h||o)&&s.addClass("active"),a||x.children().each(function(e){var t=this;if(t==s[0])t.style.transition="transform 0s",t.style.transform="translate(0px, "+d*(u-e)+"px)";else if(l<=e&&e<u)t.style.transition="transform 0s",t.style.transform="translate(0px, -"+d+"px)";else{if(!(u<=e&&e<l))return;t.style.transform="translate(0px, "+d+"px)"}requestAnimationFrame(function(){t.style.transform="",t.style.transition="transform 400ms"})}),b.getCurrentFilePath()==e.path&&this.parent.markCurrentFile(),s[0]):p.find("input").length?p[0]:(p.replaceWith(s),s[0])}l=this.computeIndex(e),x[0].insertChildAtIndex(s[0],l)}return s[0]}}},removeFileOrFolder:function(e,n){var t,i,r,o=this,a=File.isWin?"\\":"/";function s(e){var t=o.findElemFromPath(e);t.length&&(n?t.remove():t.hide("slow",function(){t.remove()}))}if(o.expandFolders)return t=e,void o.files.removeIf(function(e){if(e.path==t||0==e.path.indexOf(t+a))return s(e.path),!0});o.findElemFromPath(e).length?o.removeItemFromView({path:e},!1,n):(i=e,r=0,o.dirArr.removeIf(function(e){return r++,e.path==i||0==e.path.indexOf(i+a)}),0!=r&&Object.keys(o.dirMap).clone().forEach(function(e){e!=i&&0!=e.indexOf(i+a)||(o.dirMap[e].content.forEach(function(e){s(e.path)}),delete o.dirMap[e])}))},removeItemFromView:function(e,t,n){function i(e,t){~e.indexOf(t)?e.remove(t):e.removeIf(function(e){return e.path.toLowerCase()==(t.oldPath||t.path).toLowerCase()},!0)}var r=this.findElemFromPath(e.oldPath||e.path);if(e.folderPath||(e.folderPath=r.attr("data-parent-path")),!r.length)return w();if(this.expandFolders)i(this.files,e);else{var o=this.dirMap[e.folderPath];o&&i(o.content,e)}if(!t){r.nextAll(),r[0].offsetHeight;n?r.remove():r.hide("slow",function(){r.remove()})}return r},appendItemToViewByMac:function(e,t,n){this.appendItemToView(JSON.parse(e),t,void 0,{forceMark:n})},bindEvents:function(){var f=this;x.on("mousedown",".file-list-item",function(e){if("INPUT"==document.activeElement.tagName&&w(document.activeElement).trigger("blur"),1==event.which)return event.ctrlKey||event.metaKey?f.parent.openFileInNewWindowCommand(this):(w(".file-list-item:focus").blur(),f.parent.openFile(this.getAttribute("data-path"))),!1}),w("#switch-to-tree-on-oversize").on("click",function(e){f.parent.switch("file-tree")});var g=!1;function m(){f.editor.dropTargetDom=null,document.querySelector("#sidebar-content").classList.remove("on-drop")}w("#file-library").on("dragenter",function(e){if(!f.parent.useTreeStyle){var t=e.originalEvent.dataTransfer.files[0];g=!1,File.isMac?(window.focus(),g=-1<(e.originalEvent.dataTransfer.types||[]).indexOf("Files")):t&&File.getMountFolder()&&(g=b.isSupportedFile(t.path)),g&&(f.editor.dropTargetDom=this,document.querySelector("#sidebar-content").classList.add("on-drop"))}}).on("dragend mouseleave dragfileLeave",function(e){m()}).on("dragfile",function(e){e.stopPropagation(),m();var t=e.originalEvent.data.folders,n=e.originalEvent.data.urls;!File.getMountFolder()||1==t.length&&0==n.length?t[0]&&p.controller.switchFolder(t[0]):p.controller.moveFilesToLibrary(n)?e.stopPropagation():e.originalEvent.data.resultFromFront="cancel"}).on("dragover",function(e){e.preventDefault(),e.stopPropagation()}).on("drop",function(e){if(!File.isNode||!g||!File.getMountFolder())return m();e.stopPropagation(),e.preventDefault();var t,n,i=e.originalEvent.dataTransfer.files,r=e.originalEvent.dataTransfer.items,o=reqnode("fs-extra"),a=reqnode("path"),s=File.fileHasModified&&File.changeCounter.isDocumentEdited();function l(e){return a.join(File.getMountFolder(),a.basename(e))}function c(e){var t=l(e);o.move(e,t,function(e){e||s||(s=!0,f.parent.openFile(t))})}if(0==i.length)return m();if(0!=i[0].path.toLowerCase().indexOf(File.getMountFolder())){for(var d=0;d<i.length;d++){var u=i[d],p=r[d];if(u.path,p.webkitGetAsEntry().isFile)if(!t&&o.existsSync(l(u.path))){if(n)continue;var h=v.getDialog("Save",w.localize.getString("Should continue moving and overwrite exisiting file(s) ?"),!0,"two-way-dialog","Continue & Overwrite");h.modal({backdrop:!1,keyboard:!0}),h.find(".btn-primary").one("click",function(){t=!0,c(u.path),h.modal("hide")}),h.one("hidden.bs.modal",function(){n=!0})}else c(u.path)}m()}else r[0].webkitGetAsEntry().isDirectory||b.isSupportedFile(i[0].path)&&f.parent.openFile(i[0].path)})},needRepaint:function(e){(e||!0!==y)&&(y=!1,this.dirArr=[],this.dirMap={},this.files=[])},findElemFromPath:function(e){return w(".file-list-item[data-path='"+g.escapeSelector(e)+"']")},onChangeForMac:function(e){if("complete"==y&&!this.parent.isSuppressOnChange()){for(var t=[],n=0;n<e.length;n++){var i=e[n];if(s.isType(i.type,"created","modified")&&E(i.path,t))return;if("rename"==i.type){if(i.isDir){this.needRepaint();break}var r=b.getCurrentFilePath()==i.oldPath;this.removeFileOrFolder(i.oldPath),p.library.updateListItem(i.newPath,r)}else"removed"==i.type&&this.removeFileOrFolder(i.path);if(i.isDir&&"modified"!=i.type){this.needRepaint();break}"created"==i.type?p.library.updateListItem(i.path):"modified"!=i.type||i.isDir||("oversize"!=y||p.library.isOpened(i.path))&&p.library.updateListItem(i.path)}!y&&this.isShown()&&this.render()}},onChangeForWin:function(e,t,n,i){if("complete"==y&&!this.parent.isSuppressOnChange()&&t){var r="string"==typeof t?t:t.OLD_NAME,o=(reqnode("fs"),reqnode("path").join(n,r)),a=(reqnode("util"),File.isWin,this);if("ADDED"!=e)if("REMOVED"!=e){if("RENAMED"==e)return a.removeFileOrFolder(o),a.removeFileOrFolder(o.replace(/\$$/,"")),void s(reqnode("path").join(n,t.NEW_NAME));if("MODIFIED"!=e);else{if(E(o,i))return;if(0==a.findElemFromPath(o).length)return;F(o,function(t){if(t&&!t.shouldIgnore&&t.isFile){var n=a.getItem(o);a.fetchSummaryByNode(o,function(e){n.summary=e,n.lastModified=t.mtime,a.appendItemToView(n,!0)})}})}}else a.removeFileOrFolder(o);else{if(E(o,i))return;s(o)}}function s(i){File.getMountFolder()&&0==i.indexOf(File.getMountFolder())&&F(i,function(t){if(t&&!t.shouldIgnore)if(t.isFile){var e=g.pathByDeleteLastComponent(i),n={folderPath:e,folderName:b.getFileNameFromPath(e),name:b.getFileNameFromPath(i),path:i};a.fetchSummaryByNode(i,function(e){n.summary=e,n.lastModified=t.mtime,a.appendItemToView(n,!0)})}else t.isDir&&a.appendTreeByNode(i)})}},addFileWatchByUnix:function(r,o){if(!File.isMac&&!File.isWin&&"oversize"!=y){var l=this,e=reqnode("pathwatcher"),c=(reqnode("fs-plus"),reqnode("util"),"/"),t=this.unixWatchers[r];try{t&&t.close(),this.unixWatchers[r]=e.watch(r,function(e){var t,n,i;t=e,n=r,i=o,l.parent.isSuppressOnChange()||(d&&clearTimeout(d),h.push([t,n,i]),d=setTimeout(a,200))})}catch(e){console.warn(e)}}function a(){var e=h.clone();d=null,h=[];var t=[];if(!l.parent.isSuppressOnChange()){for(var n=[],i=[],r=!1,o=0;o<e.length;o++){var a=e[o],s=a[1];if(a[2]){if("change"!=a[0]){r=!1;break}-1==i.indexOf(s)&&i.push(s)}else if(-1==n.indexOf(s))r=a[0],n.push(s);else if(r!=a[0]){r=!1;break}}r&&1==n.length&&1==i.length&&0==n[0].indexOf(i[0])&&("delete"==r?e.length<=2&&(e=[[r,n[0],!1]]):"change"==r&&(e=[[r,n[0],!1]])),e.forEach(function(e){!function(e,n,t,i){if(!i.find(function(e){return e==n||0==n.indexOf(e+c)}))if(i.push(n),"rename"!=e&&"delete"!=e||n!=File.getMountFolder()){if("change"==e)if(t){var r=File.getMountFolder()==n,o=w("#file-library").scrollTop();C.clone(),l.removeFileOrFolder(n,r),l.appendTreeByNode(n,function(){r&&w("#file-library").scrollTop(o)})}else{var a=l.getItem(n);if(!a)return;b.statWrapper(n,function(t){t&&!t.shouldIgnore&&l.fetchSummaryByNode(n,function(e){a.summary=e,a.lastModified=t.mtime,l.appendItemToView(a,!0)})})}else if("delete"==e)l.removeFileOrFolder(n);else if("rename"==e);}else l.parent.onRootChanged()}(e[0],e[1],e[2],t)})}}},update:function(e,t){if(void 0!==t){var n=this.parent.findElemFromPath(e).children(".file-list-item-summary");n.text(T(t.substr(0,500))),n.html(n.html().replace(/([^\s]+)\s*\n+/g,"$1<br/>"))}},focusToFile:function(e,t){var n=this.findElemFromPath(e)[0];if(n){var i=n?n.offsetTop:0,r=n.clientHeight,o=n?{scrollTop:Math.max(0,i-r)}:null,a=w(File.isMac?".sidebar-content":"#file-library"),s=a.parent().height();!o||a.scrollTop()<i+40&&s+a.scrollTop()>i+40||(t?a.scrollTop(o.scrollTop):a.animate(o,500))}},newFile:function(){var e,t,i=this;function n(e,t){var n=this.appendItemToView({folderPath:File.getMountFolder(),folderName:b.getFileNameFromPath(File.getMountFolder()),name:t,path:e,lastModified:new Date,summary:""},!0);i.renameFileCommand(n,!0)}if(File.getMountFolder())if(f)File.isMac?p.library.newFileUnder(File.getMountFolder()):u.dialog.showSaveDialog(File.isLinux?null:u.getCurrentWindow(),{title:"New",defaultPath:File.getMountFolder()+"/Untitled.md",buttonLabel:"Create",filters:[{name:"Markdown",extensions:["md","markdown","mmd","mdown","txt","text"]}]},function(e){e&&reqnode("fs").writeFile(e,"",function(){i.parent.openFile(e)})});else{var r=(e=File.getMountFolder(),t=0,w(".file-list-item[data-parent-path='"+JSON.stringify(e).replace(/(^")|("$)/g,"")+"']").each(function(){var e=/^untitled( (\d+))?\./i.exec(this.querySelector(".file-list-item-file-name").textContent.trim());e&&(t=Math.max(t,(e[2]||0)-0+1))}),"Untitled"+(t?" "+t:"")+".md"),o=File.getMountFolder()+(File.isWin?"\\":"/")+r;if(this.parent.pauseOnChange(!0),File.isMac)this.parent.pauseOnChange(!0),p.library.newFile(o)?n.call(this,o,r):(this.parent.resumeOnChange(),p.library.newFileUnder(File.getMountFolder()));else{var a=reqnode("fs");o=reqnode("path").resolve(o);var s=a.openSync(o,"wx");a.close(s),this.parent.pauseOnChange(!0),n.call(this,o,r)}}},newFileCommand:function(e){this.newFile()},renameFileCommand:function(r,e){r=w(r).closest(".file-library-node")[0],File.isMac&&p.window.focus();var a=this,o=w("<input class='file-list-item-file-name' />"),t=w(r).find(".file-list-item-file-name"),s=t.clone(),l=r.getAttribute("data-path"),c=t.children().text();function d(e,t){if(m(s,e),o.replaceWith(s),l!=t){var n=w(r);a.appendItemToView({path:t,folderPath:r.getAttribute("data-parent-path"),folderName:w(r).children(".file-list-item-parent-loc").text(),lastModified:new Date,name:e,summary:(i=n.children(".file-list-item-summary"),i.length?i[0].innerText||i[0].textContent:""),oldPath:l},!0)}var i;a.editor.restoreLastCursor()}t.replaceWith(o),o.val(c),this.parent.bindRename(o,function(e){return File.isMac?(t=e.val().replace(/[\/\\]/g,""),n=g.pathByDeleteLastComponent(l)+"/"+t,a.parent.pauseOnChange(!0),void(l!=n&&p.library.renameFile(l,n)?(d(t,n),l==b.getCurrentFilePath()&&setTimeout(function(){a.parent.markCurrentFile(!1,!0)},1e3)):d(c,l))):function(e){var t=e.val();t=File.isWin?t.replace(/[\\\/:*?"<>\|\000-\031]/g,"").trim():t.replace(/[\/\\\000-\031]/g,"");var n=reqnode("path").resolve(g.pathByDeleteLastComponent(l)+(File.isWin?"\\":"/")+t),i=u.getCurrentWindow().id,r=reqnode("fs");function o(e){d(c,l),u.dialog.showErrorBox(w.localize.getString("Rename Failed"),w.localize.getString('Failed to rename from "{0}" to "{1}"').format(c,t)+"\n"+e)}l!=n?l.toLowerCase()!=n.toLowerCase()&&r.existsSync(n)?o(w.localize.getString("File with same name already exists at target path.")):(a.parent.pauseOnChange(!0),p.sendEvent("willRename",{oldPath:l,fromWin:i}),r.rename(l,n,function(e){p.sendEvent("didRename",{oldPath:l,newPath:e?l:n,fromWin:i}),e?o(e):d(t,n)})):d(c,l)}(e);var t,n},function(){d(c,l)},e),o.focus()}});n.exports=M}),define("app/window/ClientCommand",["app/document/File","exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/editor/UndoManager","app/document/Node","app/editor/polyfill","app/window/FileHelper","app/editor/EditHelper","app/editor/KeyMaster","app/window/MenuHelper","app/window/FileInfoPanel","app/window/steno2","app/window/MenuHelper","app/window/FileHelper","app/window/PDFBridge","app/window/PandocBridge"],function(e,t,n){"use strict";var i=e("app/document/File"),r=e("jquery/jquery"),o=e("app/window/MenuHelper");if(i.isNodeHtml){if(i.isNode)var a=reqnode("electron").remote,s=a.app,l=a.getCurrentWindow(),c=a.BrowserWindow;var d={},u=e("app/window/FileHelper"),p=e("app/window/PDFBridge"),h=e("app/editor/EditHelper"),f=e("app/window/PandocBridge");d.newFile=function(){i.megaMenu.hide(),s.openFile(null,{mountFolder:i.mountFolder_})},d.newWindow=function(){i.megaMenu.hide(),3==s.setting.get("restoreWhenLaunch")?s.openFile(null,{mountFolder:s.setting.get("pinFolder"),slient:"pinFolder"}):s.openFile()},d.close=function(){i.megaMenu.hide(),l.close()},d.quit=function(){s.getAllWindows().map(function(e){e.close()})},d.openWithPath=function(e){var t=s.getDocumentController().getDocument(e);t?(t.activeWindow||t.windows.keys().next().value).focus():i.fileHasModified||i.filePath?s.openFileOrFolder(e,{curWindow:l}):reqnode("fs-plus").isDirectorySync(e)?s.switchFolder(e,l):g(e)};var g=function(e){s.getDocumentController().getDocument(e)||(s.getDocumentController().getDocumentFromWindowId(l.id).rename(e),i.reloadContent(i.getContent(),!0),i.updateChangeCount(i.ChangeType.NSChangeCleared))};d.open=function(e){var t=e?["openFile","openDirectory"]:["openFile"];a.dialog.showOpenDialog(l,{properties:t,filters:[{name:r.localize.getString("Markdown File"),extensions:["md","markdown","text","txt","mmd","mdown",""]},{name:r.localize.getString("All Files"),extensions:["*"]}]},function(e){e&&e.length&&(d.openWithPath(e[0]),i.megaMenu.hide())})},d.openFolder=function(){a.dialog.showOpenDialog(l,{properties:["openDirectory"]},function(e){e&&e.length&&(d.openWithPath(e[0]),i.megaMenu.hide())})},d.quickOpen=function(){i.editor.quickOpenPanel.show()},d.import=function(){i.megaMenu.hide(),f.prepImport()},d.validatePandocInstall=function(){return f.validatePandocInstall()},d.doImport=function(e){f.import(e)},d.openFileLocation=function(){i.filePath&&a.shell.showItemInFolder(i.filePath)},d.showPreferencePanel=function(){document.body.classList.contains("native-window")?r("#preference-dialog:visible").length||(i.megaMenu.prepPreferencePanel(),r(".modal").modal("hide"),r("#preference-dialog").modal("show"),r("*:focus").blur()):r(".megamenu-opened #megamenu-section-preference:not(.hide)").length?i.megaMenu.hide():(i.megaMenu.show(),r("#m-preference").trigger("click"))},d.save=function(){i.saveUseNode(!1)},d.saveAs=function(){i.saveUseNode(!1,!0)},d.saveAll=function(){d.execForAll("function() {            ClientCommand.save();        }")};var m,v=function(){m.webContents.print()};window.releasePrintWin_=function(){m&&(m.destroy(),m=null)},d.print=function(){y().webContents.on("did-finish-load",function(){setTimeout(v,300)}),document.body.classList.contains("megamenu-opened")&&i.megaMenu.hide()},d.exportHTML=function(){i.editor.store(!0),u.showExportDialog("html",i.editor.export.exportToHTML(),null,null,!0),i.megaMenu.hide()},d.exportHTMLPlain=function(){i.editor.store(!0),u.showExportDialog("html",i.editor.export.exportToHTML(!1,!0),null,null,!0),i.megaMenu.hide()},d.exportImage=function(){i.editor.export.exportToImage(),i.megaMenu.hide()},d.exportDocx=function(){f.export("docx")},d.exportOdt=function(){f.export("odt")},d.exportRTF=function(){f.export("rtf")},d.exportEpub=function(){f.export("epub")},d.exportLaTeX=function(){f.export("latex")},d.exportWiki=function(){f.export("wiki")},d.exportRST=function(){f.export("rst")},d.exportOPML=function(){f.export("opml")},d.exportTextile=function(){f.export("textile")};var y=function(){var e=i.editor.export.exportToHTML(!0),t=a.app.setting.config;if(m&&(m.destroy(),m=null),m=new c({skipTaskbar:!0,title:"Print PDF Preview",show:!1,webPreferences:{webSecurity:!1,allowDisplayingInsecureContent:!0,allowRunningInsecureContent:!0,nodeIntegration:!1,directWrite:t.directWrite,defaultFontFamily:t.defaultFontFamily,zoomFactor:s.setting.get("zoomFactor")}}),i.megaMenu.hide(),e.length<1e5)m.loadURL("data:text/html;charset=UTF-8,  "+encodeURIComponent(e));else{var n=reqnode("path").join(s.getPath("temp"),new Date-0+"tmp.html");reqnode("fs-extra").outputFileSync(n,e),m.loadURL("file:///"+n)}return m},b=null;d.exportPDF=function(){if(i.colorBrightness<.5&&1!==a.dialog.showMessageBox(l,{type:"warning",title:r.localize.getString("Dark Theme not support","Panel"),message:r.localize.getString('Sorry, current version of Typora won\'t print background color on exported PDF, So dark theme is not yet supported for PDF exporting. \nPlease choose a light theme or click "Print with default theme"',"Panel"),buttons:[r.localize.getString("Cancel"),r.localize.getString("Print with default theme","Panel")],cancelId:0}))return;function n(e){e&&alert(r.localize.getString("Export Failed","Panel")+"\n"+e,r.localize.getString("Export Failed","Panel")),m&&m.destroy(),b=m=null,r("#md-notification").hide()}i.sync(),b=p.startPDFJob(y()),setTimeout(function(){b&&r("#md-notification").html(["<p>"+r.localize.getString("Exporting in progress...","Panel"),'\n<div class="typora-search-spinner" style="margin-right:16px;top:8px">','<div class="rect1"></div>','<div class="rect2"></div>','<div class="rect3"></div>','<div class="rect4"></div>','<div class="rect5"></div>',"</div></p>"].join("")).show()},2e3),u.showExportDialog("pdf",function(t){t?b.then(function(e){i.fs.writeFile(t,e,function(e){e?n(e):(r("#md-notification .typora-pdf-warning").length||h.showNotification(r.localize.getString("Export to PDF successfully.","Panel")),a.shell.showItemInFolder(t))})},n):n()},void 0,void 0,!0)},d.selectAll=function(){if("INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName){if(i.editor.sourceView.inSourceMode)return i.editor.sourceView.cm.focus(),void i.editor.sourceView.cm.execCommand("selectAll");i.editor.focusAndRestorePos(),i.editor.selection.selectAll(),i.editor.brush.expand()}else i.isNode&&l.webContents.selectAll()},d.deleteWord=function(){i.isLocked||(i.editor.selection.selectWord(!1,!0),i.editor.UserOp.backspaceHandler(i.editor,null,"delSelection"))},d.deleteScope=function(){i.isLocked||(i.editor.selection.selectPhrase(),i.editor.UserOp.backspaceHandler(i.editor,null,"delSelection"))},d.deleteLine=function(){i.isLocked||i.editor.UserOp.deleteLine(i.editor)},d.undo=function(){i.isLocked||(i.editor.undo.undo(),i.freshMenu())},d.redo=function(){i.isLocked||(i.editor.undo.redo(),i.freshMenu())},d.toggleOutline=function(){i.editor.library.togglePanel("outline")},d.toggleFileList=function(){i.editor.library.togglePanel("file-list")},d.toggleFileTree=function(){i.editor.library.togglePanel("file-tree")},d.pinWindow=function(){l.setAlwaysOnTop(!0),document.body.classList.add("always-on-top"),d.refreshViewMenu()},d.execForAll=function(e){var t=e.toString(),n=arguments;t=t.replace(/\$(\d+)/gi,function(e,t){return t-0<n.length?n[t]:e}),reqnode("electron").ipcRenderer.send("execForAll",t)},d.unpinWindow=function(){l.setAlwaysOnTop(!1),document.body.classList.remove("always-on-top"),d.refreshViewMenu()},d.refreshViewMenu=function(){if(i.isNode){var e=a.Menu.getApplicationMenu().items[4].submenu;o.refreshViewMenu(e);var t=e.getItem("Show Status Bar"),n=e.getItem("Actual Size");t.checked=!1,document.body.classList.contains("show-footer")&&(t.checked=!0),n.checked=!s.setting.get("customZoom"),o.forceRefreshMenu()}};var w=function(e){"string"==typeof e&&(i._CopyContentFlag=e),l.webContents.copy()},x=function(e){"string"==typeof e&&(i._PasteContentFlag=e),l.webContents.paste()};d.cut=function(){l.webContents.cut()},d.copy=function(){w()},d.copyAsMarkdown=function(){w("copyAsMarkdown")},d.copyAsHTMLSource=function(){w("copyAsHTMLSource")},d.paste=function(){x(!1)},d.pasteAsPlain=function(){x("pasteAsPlain")},d.setTheme=function(e,t){console.log("set theme: "+e),a.Menu.getApplicationMenu().getItem("Themes").submenu.items.map(function(e){e.checked=e.label==t}),s.setting.put("theme",e),d.execForAll("function(){            File.setTheme();        }")},d.resetZoom=function(){s.setting.put("customZoom",!1),i.resetZoom()},d.zoomIn=function(){s.setting.put("customZoom",!0);var e=reqnode("electron").webFrame,t=e.getZoomLevel()+1;e.setZoomLevel(t),s.setting.put("zoomLevel",t),s.setting.put("zoomFactor",e.getZoomFactor())},d.zoomOut=function(){s.setting.put("customZoom",!0);var e=reqnode("electron").webFrame,t=e.getZoomLevel()-1;e.setZoomLevel(t),s.setting.put("zoomLevel",t),s.setting.put("zoomFactor",e.getZoomFactor())},n.exports=d,window.ClientCommand=d}}),define("app/window/PDFBridge",["app/document/StringUtils","app/editor/EditHelper","jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/editor/KeyMaster","app/window/FileHelper"],function(e,t,n){"use strict";if(File.isNode){var i=reqnode("electron").remote;i.app,i.getCurrentWindow(),i.BrowserWindow,i.dialog,e("app/document/StringUtils"),e("app/editor/EditHelper"),e("app/window/FileHelper");e.async(window.debugMode?["pdf/pdf-designer.min.js","pdf/pdf.js"]:["lib.asar/pdf/pdf-designer.min.js","lib.asar/pdf/pdf.min.js"]);var a=function(l){return new Promise(function(t,n){var i=l.numPages,r={},o=0,a=0;function e(e){n(e)}0==i&&n("Genrated PDF only have 0 page");for(var s=0;s<i;s++)l.getPage(s+1).then(function(n){n.getAnnotations().then(function(e){a||(a=n.getViewport(1).height),o++,e.forEach(function(e){var t;(e.subtype="Link")&&((t=/^af:\/\/(.+)$/.exec(e.url||""))&&(r[t[1]]=[n.pageIndex+1,a-e.rect[3]]))}),i<=o&&t(r)},e)},e)})},s=function(u,e){var t=new TPDFAnalyst,p=new TPDFOutLineMaker,h=File.editor.docMenu.getHeaderMatrix(!0);return t.LoadFromStream(e),p.Info.Title=File.editor.docMenu.getValueInMeta("title")||"",p.Info.Subject=File.editor.docMenu.getValueInMeta("subject")||"",p.Info.Author=File.editor.docMenu.getValueInMeta("author")||"",p.Info.Keywords=File.editor.docMenu.getValueInMeta("keywords")||"",p.Info.Creator=File.editor.docMenu.getValueInMeta("creator")||"Typora",p.Info.Producer=File.editor.docMenu.getValueInMeta("producer")||"Typora",p.Info.CreationDate=PDF_GetDateTime_Now(),p.Info.ModDate=PDF_GetDateTime_Now(),p.View.PageMode=TPDFPageMode.pmUseOutlines,function e(t,n,i,r){for(var o=7,a=null,s=i;s<r;s++){var l,c=h[s],d=c[0];if(7==o&&(o=d),d<=n)return s;if(o<d)s=e(a,o,s,r)-1;else{if(!(l=u[c[2]]))continue;a=t?t.AddChild(c[1],l[0],l[1],"",!1,!1,null):p.OutLine.AddRoot(c[1],l[0],l[1],"",!1,!1,null)}}return r}(null,0,0,h.length),p.Save(t)};t.startPDFJob=function(r){return new Promise(function(n,i){new Promise(function(e,t){r.webContents.once("did-finish-load",function(){e()}),setTimeout(function(){try{r.webContents.stop()}catch(e){t(e)}e()},1e4)}).then(function(){setTimeout(function(){r.webContents.printToPDF({printBackground:!1,marginsType:0},function(e,t){!function(e,n,i,t){var r=Buffer.from(n);function o(e){console.sendError("failed to add book to exported PDF\n"+e.stack||e.details),$("#md-notification").html("<p class='typora-pdf-warning'>"+$.localize.getString("[Warning] Failed to attach bookmark for PDF file.","Panel")+"<span class='btn close-btn btn-xs'><span class='glyphicon glyphicon-remove'></span></span></p>").show(),i(r)}e?t(e):e?t(e):(PDFJS.disableWorker=!0,PDFJS.getDocument(n).then(a,function(e){t(e)}).then(function(e){try{var t=new FileReader;t.onloadend=function(){i(new Buffer(new Uint8Array(t.result)))},t.onerror=t.onabort=o,t.readAsArrayBuffer(s(e,n))}catch(e){o(e)}},o))}(e,t,n,i)})},200)},i)})}}}),define("app/window/PandocBridge",["app/document/StringUtils","app/editor/EditHelper","jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/editor/KeyMaster","app/window/FileHelper","app/window/FileInfoPanel","app/window/FileHelper"],function(e,t,n){"use strict";if(File.isNode){var o,s=reqnode("child_process").spawn,a=reqnode("electron").remote,l=a.app,c=a.getCurrentWindow(),d=(a.BrowserWindow,a.dialog),u=e("app/document/StringUtils"),p=e("app/editor/EditHelper"),i=e("app/window/FileHelper"),r=e("app/window/FileInfoPanel"),h=null,f=function(e,i,r,t){g(),h=s("pandoc",e,t);var o=[],a=[];return h.on("close",function(e){var t=Buffer.concat(o),n=Buffer.concat(a).toString();i(r,t,n,e),h=null}),h.stdout.on("data",function(e){o.push(e)}),h.stderr.on("data",function(e){a.push(e)}),h},g=function(){h&&h.kill&&(h.removeAllListeners("close"),h.kill()),h=null},m=function(e){var t=l.setting.isPandocValid();if(e&&void 0!==t)return t;if(t)return!0;t=!0;var n,i=reqnode("child_process").spawnSync("pandoc",["--version"]);if(i.error?t=!1:(n=(i=i.stdout.toString("utf8").split(/\r|\n|\r\n/)[0]).match(/[\d.]+/)[0],t=0<=l.setting.compareVersion(n,"1.16")),!t&&!e){var r=p.getDialog($.localize.getString("Require Pandoc to Continue...","Panel"),$.localize.getString("Import or some export features requires <a href='http://pandoc.org/' target='_blank'>Pandoc</a> (≥ v1.16) to be installed.","Panel"),!0,null,$.localize.getString("Follow Instructions to Install/Update Pandoc","Panel")).modal({backdrop:!1});r.find(".btn-primary").one("click",function(){a.app.openFile(__dirname+"/Docs/Install and Use Pandoc.md",{forceCreateWindow:!0}),r.modal("hide")})}return l.setting.setPandocValid(t),t},v={prepImport:function(){if(m()){var n=File.changeCounter.isDiscardableUntitled(),i=n?a.getCurrentWindow():l.openFile("",{syncAndPrepOnly:!0}).activeWindow,r=n;i.webContents.once("did-finish-load",function(){r=!0}),d.showOpenDialog(c,{title:$.localize.getString("Import","Menu"),properties:["openFile"],filters:[{name:$.localize.getString("All Supported Formats","Panel"),extensions:["docx","latex","tex","ltx","rst","rest","org","wiki","dokuwiki","textile","opml","epub"]},{name:"MS Word",extensions:["docx"]},{name:"TeX/LaTeX",extensions:["latex","tex","ltx"]},{name:"reStructuredText",extensions:["rst","rest"]},{name:"org-mode",extensions:["org"]},{name:"Wiki",extensions:["wiki","dokuwiki"]},{name:"Epub",extensions:["epub"]},{name:"Textile",extensions:["textile"]},{name:"OPML",extensions:["opml"]}]},function(e){if(e&&e.length){var t=e[0];if(n)return void o(t);i.show(),r?o(t):i.webContents.once("did-finish-load",function(){o(t)})}else n||i.close()})}function o(e){i.webContents.executeJavaScript('window.getSelection().removeAllRanges();ClientCommand.doImport("'+u.escapeInQuote(e)+'")')}},import:function(e){File.lock(),File.blockUI=!0,o=$("#import-process-dialog"),h=f([e,"--wrap=none","--atx-headers","-t","markdown"],b,e),r.setFileTitle(null,null,i.getFileNameFromPath(e).replace(/\..+$/,"")),setTimeout(function(){h&&(o.modal({backdrop:"static",keyboard:!1}),o.find(".btn").one("click",function(){g(),c.close()}))},200)},export:function(e){if(m()){File.megaMenu.hide(),File.sync();var t=[e];"latex"==e?t=["tex","latex"]:"wiki"==e?t=["wiki","txt"]:"rst"==e?t=["rst","text","rest","reStructuredText"]:"opml"==e?t=["opml","xml"]:"textile"==e&&(t=["textile"]);var n=(i.getCurrentFileFolderPath()||l.getPath("documents"))+"/"+File.getSuggestedFileName(!0)+(t?"."+t[0]:"");d.showSaveDialog(c,{title:$.localize.getString("Export to...","Panel"),defaultPath:n,filters:[{name:e,extensions:t},{name:$.localize.getString("All Files","Panel"),extensions:[]}]},function(n){if(n){File.blockUI=!0;var i=["-f","native","-s","-o",n,"-t",e];"wiki"==e&&(i.pop(),i.push("mediawiki"));var r=new Date;File.editor.export.exportToNative(e,function(e){(h=f(i,y,n,{stdio:"pipe"})).stdin.end(e,"utf8"),o=$("#export-process-dialog");var t=Math.max(500-new Date+r,0);setTimeout(function(){h&&(o.modal({backdrop:"static",keyboard:!1}),o.find(".btn").one("click",function(){File.blockUI=!1,g(),o.modal("hide")}))},t)},reqnode("path").dirname(n))}})}}},y=function(e,t,n,i){var r;o.modal("hide"),File.blockUI=!1,0!==i?(r=n,p.getDialog($.localize.getString("Export Failed","Panel"),$.localize.getString("Failed to export file to <em>{0}</em>").format(u.escape(e))+"<br />"+u.escape(r.substring(0,500)),!0,"error-dialog").modal({backdrop:"static"}),console.sendError(r)):a.shell.showItemInFolder(e),File.editor.export.cleanUpTempFiles()},b=function(e,t,n,i){o.modal("hide"),File.unlock(),File.blockUI=!1,t&&0!=t.length?File.reloadContent(t.toString(),!0):p.getDialog($.localize.getString("Import Failed","Panel"),$.localize.getString("Failed to import file from <em>{0}</em>","Panel").format(u.escape(e))+"<br />"+u.escape(n),!0,"error-dialog").modal({backdrop:"static"}),File.updateChangeCount(File.ChangeType.NSChangeDone),g()};v.slientQuit=g,v.validatePandocInstall=m,n.exports=v}}),define("app/window/MegaMenu",["list.js-master/dist/list","list.js-master/dist/list.fuzzysearch.min","app/document/StringUtils","app/editor/EditHelper","jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/editor/KeyMaster","app/window/FileHelper","app/window/ClientCommand","app/document/File","app/editor/UndoManager","app/editor/polyfill","app/window/FileHelper","app/window/MenuHelper","app/window/FileInfoPanel","app/window/steno2","app/window/PDFBridge","app/window/PandocBridge","app/window/PandocBridge"],function(e,t,n){"use strict";var o=e("list.js-master/dist/list"),a=e("list.js-master/dist/list.fuzzysearch.min.js"),s=e("app/document/StringUtils"),l=e("app/editor/EditHelper"),c=e("app/window/FileHelper"),i=e("app/editor/KeyMaster").map,d=e("app/window/ClientCommand"),r=e("app/window/PandocBridge"),u=window.reqnode?reqnode("electron").remote:null,p=function(e){File.isNodeHtml&&(this.sessionStr=e,$(document).ready(f.bind(this)))},h=null;p.prototype.hide=function(){document.body.classList.remove("megamenu-opened"),File.editor.lastCursor&&File.editor.undo.exeCommand(File.editor.lastCursor)},p.prototype.show=function(){File.editor.lastCursor=File.editor.selection.buildUndo(),document.body.classList.add("megamenu-opened"),$(".dropdown-menu").removeClass("open").removeClass("show")};var f=function(){function e(){var e=this.getAttribute("id").substr(2);$(".megamenu-section").addClass("hide"),$("#megamenu-section-"+e).removeClass("hide"),$("#megamenu-menu-list a").removeClass("active"),$(this).addClass("active")}if($(document).on("keydown",function(e){"Esc"===i[e.keyCode||e.which]&&File.megaMenu.hide()}),$("#w-menu-btn").click(function(){return File.megaMenu.show(),$("#m-open").trigger("click"),!1}),$(".megamenu-menu-header").click(function(){return File.megaMenu.hide(),!1}).mouseleave(function(){$(this).blur()}),$("#m-open").on("active",function(){e.call(this),function(){$("#recent-document-table");if(File.isNode){u.getCurrentWindow();var e=u.app,t=e.setting.getRecentDocuments(),n=e.setting.getRecentFolders(),i=reqnode("fs-plus");if(t.map(function(e){e["recent-file-dir"]=i.tildify(e.path.substr(0,e.path.length-e.name.length)),e["recent-file-name"]=s.escape(e.name),e["recent-file-path"]=s.escape(e.path)}),n.map(function(e){e["recent-file-dir"]="(folder)",e["recent-file-name"]=s.escape(e.name),e["recent-file-path"]=s.escape(e.path)}),t=(t=t.concat(n)).filter(function(e){return 0<e["recent-file-name"].trim().length}).sort(function(e,t){return-e.date+t.date}),h)h.clear(),h.add(t);else{var r={item:"recent-file-item-pattern",listClass:"list-js-list",valueNames:["name"],plugins:[a()]};h=new o("recent-file-panel",r,t)}}}()}).on("click",function(){$(this).trigger("active"),!$("#megamenu-section-open").removeClass("hide").is(":visible")&&$("#m-open-local").trigger("click")}),$("#m-export, #m-about").click(e),$("#m-theme").click(function(){v(),e.call(this)}),$("#m-preference").click(function(){File.megaMenu.prepPreferencePanel(),e.call(this)}),File.isNode){u.getCurrentWindow();var n=u.app;$("#m-close").click(d.close),$("#m-new").click(d.newFile),$("#recent-file-panel").on("click",".recent-file-item",function(){var e=this.querySelector(".recent-file-path").innerHTML,t=s.unescape(e);File.fs.existsSync(t)?(d.openWithPath(t),File.megaMenu.hide()):(l.getDialog($.localize.getString("Error"),$.localize.getString("File does not exist at <em>{0}</em>","Panel").format(e),!0,"error-dialog").modal({backdrop:"static"}),n.setting.removeRecentDocument(t),h&&h.remove("path",t))}),$("#megamenu-clear-recet-documents").click(function(){n.setting.clearRecentDocuments(),h.clear()}),$("#m-open-local").click(d.open),$("#m-import-local").click(d.import),$("#m-save").click(d.save),$("#m-save-as").click(d.saveAs),$("#export-as-pdf").click(d.exportPDF),$("#export-as-html").click(d.exportHTML),$("#export-as-html-plain").click(d.exportHTMLPlain),$("#export-as-image").click(d.exportImage),$("#export-as-docx").click(d.exportDocx),$("#export-as-odt").click(d.exportOdt),$("#export-as-rtf").click(d.exportRTF),$("#export-as-epub").click(d.exportEpub),$("#export-as-latex").click(d.exportLaTeX),$("#export-as-wiki").click(d.exportWiki),$("#export-as-rst").click(d.exportRST),$("#export-as-opml").click(d.exportOPML),$("#export-as-textile").click(d.exportTextile),$("#m-print").click(d.print),w(),g()}},g=function(){$("#about-page-version-label").text("version "+u.app.getVersion()+"(beta)"),u.app.setting.get("framelessWindow")||$("#about-content-about-section").appendTo("#about-dialog .modal-body"),$("#typora-help-md-table tr").click(function(){this.textContent.trim()==$.localize.getString("Support Documentation","Panel")?u.shell.openExternal("http://support.typora.io"):u.app.openFile(__dirname+"/Docs/"+this.textContent.trim()+".md",{forceCreateWindow:!0})})},m=!1,v=function(){var t=u.app,e=t.setting.getAllThemes(),n="";m||(e.map(function(e){n+='<div class="theme-preview-div" data-theme="$theme$" ><iframe class="theme-preview-content" src="html/preview.html?$src$""></iframe><div style="position:absolute; top:0;left:0;bottom:0;right:0;background:white;opacity:0;padding:0;margin:0;"></div><i class="fa fa-check-circle"></i></div>'.replace("$src$",encodeURI("folder="+t.getPath("userData").replace(/\\/g,"\\\\")+"/themes&&css="+e)).replace("$theme$",e)}),$("#theme-preview-grid").html(n).on("click",".theme-preview-div",function(){$("#theme-preview-grid").find(".active").removeClass("active");var e=$(this).addClass("active").attr("data-theme");d.setTheme(e,e.replace(/\.css$/,"").replace(/(?:^|_|-)(\w)/g,function(e,t,n){return t.toUpperCase()}))}),m=!0),$("#theme-preview-grid [data-theme='"+t.setting.getCurrentTheme()+"']").addClass("active")},y=function(e){e=e||"",$("#pin-folder-val").attr("ty-hint",e).val(reqnode("path").basename(e))},b=function(e,t){e=void 0===e?File.option.indentByTab?-1:File.option.indentSize:e;var n=(t=null==t?File.option.prettyIndent:t)?["> Quote\n- List item\n  1. sub-bullet\n     line2",">  Quote\n-  List item\n   1. sub-bullet\n      line2",">   Quote\n-   List item\n    1.  sub-bullet\n        line2",">    Quote\n-    List item\n     1.   sub-bullet\n          line2"]:["> Quote\n- List item\n  1. sub-bullet\n     line2","> Quote\n- List item\n   1. sub-bullet\n      line2","> Quote\n- List item\n    1. sub-bullet\n        line2","> Quote\n- List item\n     1. sub-bullet\n          line2"];e<0?$("#preference-indent-size-pre").text("> Quote\n- List item\n\t1. sub-bullet\n\t\tline2"):$("#preference-indent-size-pre").text(n[(e||2)-2])},w=function(){var e=u.getCurrentWindow(),i=u.app,t=reqnode("fs-extra"),n=(reqnode("electron").ipcRenderer,function(){}),r=function(e){t.copy(__dirname+"/conf.default.json",i.getPath("userData")+"/conf/conf.default.json",{overwrite:!0},e||n),t.copy(__dirname+"/conf.default.json",i.getPath("userData")+"/conf/conf.user.json",{overwrite:!0},n)};function o(t){u.dialog.showOpenDialog(e,{defaultPath:i.setting.get("pinFolder")||File.mountFolder_,properties:["openDirectory","promptToCreate"]},function(e){0==e.length?t&&t():(i.setting.put("pinFolder",e[0]),y(e[0]))})}$(document).on("change","input[name='windowStyleType']",function(){i.setting.put("framelessWindow","framelessWindow"==$("input[name='windowStyleType']:checked").val())}).on("change","#show-status-bar-btn",function(){var e=0<$("#show-status-bar-btn:checked").length;i.setting.put("showStatusBar",e),d.execForAll('function() {                document.body.classList.toggle("show-footer");            }')}).on("change","input[name='fontSize']",function(){var e=$("#use-custom-font-size-btn").prop("checked");i.setting.put("useCustomFontSize",e),d.execForAll('function() {                var app = reqnode("electron").remote.app,                    useCustomFontSize = app.setting.get("useCustomFontSize");                if (useCustomFontSize) {                    document.body.parentElement.style.fontSize = (app.setting.get("customFontSize") || 14) + "px";                } else {                    document.body.parentElement.style.fontSize = "";                }            }')}).on("keypress","#custom-font-size-input",function(e){if(!/\d/.exec(String.fromCharCode(e.which)))return!1}).on("blur","#custom-font-size-input",function(e){var t=/\d+/.exec(this.value)[0];i.setting.put("customFontSize",t),d.execForAll('function() {                var app = reqnode("electron").remote.app;                document.body.parentElement.style.fontSize = app.setting.get("customFontSize") + "px";            }')}).on("change","#collapsible-outline-btn",function(){var e=0<$("#collapsible-outline-btn:checked").length;i.setting.put("can_collapse_outline_panel",e),d.execForAll("function() {                File.setCanCollapsePinnedOutline("+!!e+");            }")}).on("change","[name='enable_inline_math'], [name='enable_subscript'],[name='enable_superscript'],[name='enable_highlight'],[name='enable_diagram'],[name='copy_markdown_by_default'], [name='show_line_numbers_for_fence'],[name='auto_correct_misspell'], [name='auto_numbering_for_math'], [name='use_relative_path_for_img'], [name='strict_mode']",function(){var e=this.getAttribute("name"),t=$(this).prop("checked");i.setting.put(e,t),"strict_mode"!=e&&d.execForAll("function(){File.option."+s.camelize(e)+" = "+t+";}")}).on("change","#preLinebreakOnExport",function(){var e=$(this).val();i.setting.put("preLinebreakOnExport",1==e||"true"==e),d.execForAll("function() {                File.option.preLinebreakOnExport = $1;            }",e+"")}).on("change","#ignoreLineBreak",function(){var e=$(this).val();File.setIgnoreLineBreak(1==e||"true"==e,!0,!0),d.execForAll("function() {                File.setIgnoreLineBreak($1);            }",e+"")}).on("change","[name='no_line_wrapping']",function(){var e=$(this).prop("checked");i.setting.put("no_line_wrapping",!e)}).on("change","#preference-indent-size-btn",function(){var e=this.value-0;i.setting.put("indentSize",e),b(e),d.execForAll('function() {                File.setIndentSize("$1");            }',e)}).on("change","#preference-pretty-indent-btn",function(){var e=$(this).prop("checked");i.setting.put("prettyIndent",e),b(void 0,e),d.execForAll("function() {                File.option.prettyIndent = $1;            }",e)}).on("change","#preference-code-indent-size-btn",function(){var e=this.value-0;i.setting.put("codeIndentSize",e),d.execForAll("function() {                File.option.codeIndentSize = $1;            }",e)}).on("click","#open-theme-folder-btn",function(){u.shell.openItem(u.app.getPath("userData")+"/themes")}).on("change","#preference-trigger-debug-btn",function(){var e=0<$("#preference-trigger-debug-btn:checked").length;i.setting.put("debug",e),e?d.execForAll("function() {$(\"[data-group='dev-tool']\").show();}"):d.execForAll("function() {$(\"[data-group='dev-tool']\").hide();}")}).on("change","#preference-send-anony-info-btn",function(){i.setting.put("send_usage_info",0<$("#preference-send-anony-info-btn:checked").length)}).on("change","[name='enable_spell_check']",function(){var e=!$(this).prop("checked");i.setting.put("no_spell_check",e),$("[name='auto_correct_misspell']").prop("disabled",!e),d.execForAll("function(){File.option.noSpellCheck = "+e+";}")}).on("change","#preference_auto_pair",function(){var e=!$(this).prop("checked");i.setting.put("no_pairing_match",e),d.execForAll("function(){File.option.noPairingMatch = "+e+";}"),e&&$("#preference_auto_pair_markdown").prop("checked",!1),$("#preference_auto_pair_markdown").prop("disabled",e)}).on("change","#preference_auto_pair_markdown",function(){var e=$(this).prop("checked");i.setting.put("match_pari_markdown",e),d.execForAll("function(){File.option.autoPairExtendSymbol = "+e+";}")}).on("change","[name='defaultLineEnding']",function(){var e=$("#trigger-line-ending-crlf").prop("checked");i.setting.put("line_ending_crlf",e),d.execForAll("function(){File.option.preferCRLF = "+e+";}")}).on("change","#preference_expand_block",function(){var e=$(this).prop("checked");i.setting.put("auto_expand_block",e),d.execForAll("function(){File.option.expandSimpleBlock = "+e+";}")}).on("change","#preference-heading-style",function(){var e=$(this).val()-0;i.setting.put("heading_style",e),d.execForAll("function(){File.option.headingStyle = "+e+";}")}).on("change","#preference-ul-style",function(){var e=$(this).val()-0;i.setting.put("ul_style",e),d.execForAll("function(){File.option.ulStyle = "+e+";}")}).on("change","#preference-ol-style",function(){var e=$(this).val()-0;i.setting.put("ol_style",e),d.execForAll("function(){File.option.olStyle = "+e+";}")}).on("change","[name='autocompleteTrigger']",function(){var e=$("#trigger-emoji-autocomplete-on").prop("checked");i.setting.put("trigger_emoji_autocomplete",e),d.execForAll("function(){File.option.autoToggleEmojiAutoComplete = "+e+";}")}).on("click","#preference-open-draft-folder",function(){u.shell.openItem(c.getUnsavedDraftsPath())}).on("change","#preference-auto-save",function(){var e=$(this).prop("checked");i.setting.put("enableAutoSave",e),File.option.enableAutoSave=e,d.execForAll("function(){File.option.enableAutoSave = "+e+";}"),$("#preference-auto-save-on-switch").prop("checked",File.option.enableAutoSave||File.option.saveFileOnSwitch),$("#preference-auto-save-on-switch").prop("disabled",File.option.enableAutoSave)}).on("change","#preference-auto-save-on-switch",function(){var e=$(this).prop("checked");i.setting.put("save_file_on_switch",e),d.execForAll("function(){File.option.saveFileOnSwitch = "+e+";}")}).on("click","#open-conf-folder-btn",function(){var e=i.getPath("userData")+"/conf/conf.user.json";reqnode("fs-plus").isFileSync(e)?u.shell.showItemInFolder(e):r(function(){u.shell.showItemInFolder(e)})}).on("click","#reset-conf-folder-btn",function(){$(".modal:not(.block-modal)").modal("hide");var e=l.getDialog("Confrim","Revert advanced setting file to default one ?").modal({backdrop:!1});e.find(".btn-primary").one("click",function(){r(),e.modal("hide")})}).on("change","[name='scroll_with_cursor']",function(){var e=!$(this).prop("checked");i.setting.put("no_pairing_match",e),d.execForAll("function(){File.option.scrollWithCursor = !"+e+";}")}).on("change","#preference-lanuage",function(){i.setting.put("userLanguage",$("#preference-lanuage").val())}).on("change","#apply_image_move_for_web",function(){var e=$(this).prop("checked");i.setting.put("apply_image_move_for_web",e),d.execForAll("function(){File.option.applyImageMoveForWeb = "+e+";}")}).on("change","#apply_image_move_for_local",function(){var e=$(this).prop("checked");i.setting.put("no_image_move_for_local",!e),d.execForAll("function(){File.option.applyImageMoveForLocal = "+e+";}")}).on("change","#image_save_location",function(){var e=$(this).val();i.setting.put("image_save_location",e),d.execForAll("function(){File.option.defaultImageStorage = '"+e+"';}")}).on("change","#restoreWhenLaunch",function(){var e=i.setting.get("restoreWhenLaunch")||0,t=(this.value||"0")-0;if(i.setting.put("restoreWhenLaunch",t),3==t){var n=i.setting.get("pinFolder");$("#select-pin-input-group").show(),n?y(n):o(function(){e!=t&&($("#select-pin-input-group").hide(),$("#restoreWhenLaunch").val(e),i.setting.put("restoreWhenLaunch",e))})}else $("#select-pin-input-group").hide()}).on("click","#select-pin-folder",o),function(){try{var e=File.isWin&&reqnode("winsparkle-node");$(document).on("click","#preference-trigger-check-update",function(){File.isWin&&(e.setAppcastUrl("https://www.typora.io/windows/dev_update.xml"),e.checkUpdateWithUI())}).on("change","#preference-enable-auto-update",function(){$("#preference-enable-auto-update:checked").length?(e.setAutomaticCheckForUpdates(!0),i.setting.put("enableAutoUpdate",!0)):(e.setAutomaticCheckForUpdates(!1),i.setting.put("enableAutoUpdate",!1))})}catch(e){console.sendError(e)}}()};p.prototype.prepPreferencePanel=function(){u.getCurrentWindow();var t=u.app;if(r.validatePandocInstall(!0)&&$(".hide-when-pandoc-installed").hide(),$(".open-pandoc-guide").on("click",function(){t.openFile(__dirname+"/Docs/Install and Use Pandoc.md")}),document.body.classList.contains("native-window")&&$("#preference-content").appendTo("#preference-dialog .modal-body"),$("input[name='windowStyleType'][value='framelessWindow']").prop("checked",t.setting.get("framelessWindow")),$("input[name='windowStyleType'][value='nativeWindow']").prop("checked",!t.setting.get("framelessWindow")),$("#show-status-bar-btn").prop("checked",!1!==t.setting.get("showStatusBar")),$("#custom-font-size-input").val(t.setting.get("customFontSize")||14),t.setting.get("useCustomFontSize")?$("#use-custom-font-size-btn").prop("checked",!0):$("#use-auto-font-size-btn").prop("checked",!0),$("#collapsible-outline-btn").prop("checked",t.setting.get("can_collapse_outline_panel")),File.option.autoToggleEmojiAutoComplete?$("#trigger-emoji-autocomplete-on").prop("checked",!0):$("#trigger-emoji-autocomplete-off").prop("checked",!0),$("input[name='copy_markdown_by_default']").prop("checked",File.option.copyMarkdownByDefault),["enable_subscript","enable_superscript","show_line_numbers_for_fence","auto_numbering_for_math","enable_highlight","use_relative_path_for_img","apply_image_move_for_web","strict_mode"].map(function(e){$("input[name='"+e+"']").prop("checked",t.setting.get(e))}),$("#preLinebreakOnExport").val((File.option.preLinebreakOnExport||!1)+""),$("#ignoreLineBreak").val((File.option.ignoreLineBreak||!1)+""),$("#apply_image_move_for_local").prop("checked",!t.setting.get("no_image_move_for_local")),$("input[name='no_line_wrapping']").prop("checked",!t.setting.get("no_line_wrapping")),$("input[name='enable_diagram']").prop("checked",File.option.enableDiagram),$("input[name='enable_inline_math']").prop("checked",File.option.enableInlineMath),$("#preference-auto-save").prop("checked",File.option.enableAutoSave),$("#preference-auto-save-on-switch").prop("checked",File.option.enableAutoSave||File.option.saveFileOnSwitch),$("#preference-auto-save-on-switch").prop("disabled",File.option.enableAutoSave),$("input[name='enable_spell_check']").prop("checked",!t.setting.get("no_spell_check")),$("input[name='auto_correct_misspell']").prop("checked",!t.setting.get("auto_correct_misspell")).prop("disabled",t.setting.get("no_spell_check")),$("input[name='scroll_with_cursor']").prop("checked",!t.setting.get("no_pairing_match")),$("#preference_auto_pair").prop("checked",!t.setting.get("no_pairing_match")),t.setting.get("no_pairing_match")?($("#preference_auto_pair_markdown").prop("checked",!1),$("#preference_auto_pair_markdown").prop("disabled",!0)):($("#preference_auto_pair_markdown").prop("checked",t.setting.get("match_pari_markdown")),$("#preference_auto_pair_markdown").prop("disabled",!1)),$("#preference_expand_block").prop("checked",t.setting.get("auto_expand_block")),$("#preference-indent-size-btn").val((t.setting.get("indentSize")||2)+""),$("#preference-pretty-indent-btn").prop("checked",t.setting.get("prettyIndent")||!1),$("#preference-code-indent-size-btn").val((t.setting.get("codeIndentSize")||4)+""),File.isWin)try{var e=reqnode("winsparkle-node");$("#preference-enable-auto-update").prop("checked",e.getAutomaticCheckForUpdates())}catch(e){console.sendError(e)}else $("#preference-enable-auto-update").parent().hide();$("#preference-trigger-debug-btn").prop("checked",t.setting.get("debug",!1)),$("#preference-send-anony-info-btn").prop("checked",t.setting.get("send_usage_info",!0)),$("#preference-heading-style").val(File.option.headingStyle),$("#preference-ul-style").val(File.option.ulStyle),$("#preference-ol-style").val(File.option.olStyle),$("#trigger-line-ending-crlf").prop("checked",File.option.preferCRLF),$("#trigger-line-ending-lf").prop("checked",!File.option.preferCRLF),$("#preference-lanuage").val(t.setting.get("userLanguage")||"auto");var n=t.setting.get("restoreWhenLaunch")||0;$("#restoreWhenLaunch").val(n+""),y(t.setting.get("pinFolder")),3==n?$("#select-pin-input-group").show():$("#select-pin-input-group").hide(),$("#image_save_location").val(t.setting.get("image_save_location")||""),b()},n.exports=p}),define("list.js-master/dist/list",[],function(e,t,n){"use strict";!function(){function s(e,t,n){var i=s.resolve(e);if(null==i){n=n||e,t=t||"root";var r=new Error('Failed to require "'+n+'" from "'+t+'"');throw r.path=n,r.parent=t,r.require=!0,r}var o=s.modules[i];if(!o._resolving&&!o.exports){var a={exports:{}};a.client=a.component=!0,o._resolving=!0,o.call(this,a.exports,s.relative(i),a),delete o._resolving,o.exports=a.exports}return o.exports}s.modules={},s.aliases={},s.resolve=function(e){"/"===e.charAt(0)&&(e=e.slice(1));for(var t=[e,e+".js",e+".json",e+"/index.js",e+"/index.json"],n=0;n<t.length;n++){e=t[n];if(s.modules.hasOwnProperty(e))return e;if(s.aliases.hasOwnProperty(e))return s.aliases[e]}},s.normalize=function(e,t){var n=[];if("."!=t.charAt(0))return t;e=e.split("/"),t=t.split("/");for(var i=0;i<t.length;++i)".."==t[i]?e.pop():"."!=t[i]&&""!=t[i]&&n.push(t[i]);return e.concat(n).join("/")},s.register=function(e,t){s.modules[e]=t},s.alias=function(e,t){if(!s.modules.hasOwnProperty(e))throw new Error('Failed to alias "'+e+'", it does not exist');s.aliases[t]=e},s.relative=function(r){var o=s.normalize(r,"..");function t(e){return s(t.resolve(e),r,e)}return t.resolve=function(e){var t=e.charAt(0);if("/"==t)return e.slice(1);if("."==t)return s.normalize(o,e);var n=r.split("/"),i=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return n;return-1}(n,"deps")+1;return i||(i=0),e=n.slice(0,i+1).join("/")+"/deps/"+e},t.exists=function(e){return s.modules.hasOwnProperty(t.resolve(e))},t},s.register("component-classes/index.js",function(e,t,n){var i=t("indexof"),r=/\s+/,o=Object.prototype.toString;function a(e){if(!e)throw new Error("A DOM element reference is required");this.el=e,this.list=e.classList}n.exports=function(e){return new a(e)},a.prototype.add=function(e){if(this.list)return this.list.add(e),this;var t=this.array();return~i(t,e)||t.push(e),this.el.className=t.join(" "),this},a.prototype.remove=function(e){if("[object RegExp]"==o.call(e))return this.removeMatching(e);if(this.list)return this.list.remove(e),this;var t=this.array(),n=i(t,e);return~n&&t.splice(n,1),this.el.className=t.join(" "),this},a.prototype.removeMatching=function(e){for(var t=this.array(),n=0;n<t.length;n++)e.test(t[n])&&this.remove(t[n]);return this},a.prototype.toggle=function(e,t){return this.list?void 0!==t?t!==this.list.toggle(e,t)&&this.list.toggle(e):this.list.toggle(e):void 0!==t?t?this.add(e):this.remove(e):this.has(e)?this.remove(e):this.add(e),this},a.prototype.array=function(){var e=this.el.className.replace(/^\s+|\s+$/g,"").split(r);return""===e[0]&&e.shift(),e},a.prototype.has=a.prototype.contains=function(e){return this.list?this.list.contains(e):!!~i(this.array(),e)}}),s.register("segmentio-extend/index.js",function(e,t,n){n.exports=function(e){for(var t,n=Array.prototype.slice.call(arguments,1),i=0;t=n[i];i++)if(t)for(var r in t)e[r]=t[r];return e}}),s.register("component-indexof/index.js",function(e,t,n){n.exports=function(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1}}),s.register("component-event/index.js",function(e,t,n){var r=window.addEventListener?"addEventListener":"attachEvent",o=window.removeEventListener?"removeEventListener":"detachEvent",a="addEventListener"!==r?"on":"";e.bind=function(e,t,n,i){return e[r](a+t,n,i||!1),n},e.unbind=function(e,t,n,i){return e[o](a+t,n,i||!1),n}}),s.register("timoxley-to-array/index.js",function(e,t,n){n.exports=function(e){if(void 0===e)return[];if(null===e)return[null];if(e===window)return[window];if("string"==typeof e)return[e];if(t=e,"[object Array]"===Object.prototype.toString.call(t))return e;var t;if("number"!=typeof e.length)return[e];if("function"==typeof e&&e instanceof Function)return[e];for(var n=[],i=0;i<e.length;i++)(Object.prototype.hasOwnProperty.call(e,i)||i in e)&&n.push(e[i]);return n.length?n:[]}}),s.register("javve-events/index.js",function(e,t,n){var o=t("event"),a=t("to-array");e.bind=function(e,t,n,i){e=a(e);for(var r=0;r<e.length;r++)o.bind(e[r],t,n,i)},e.unbind=function(e,t,n,i){e=a(e);for(var r=0;r<e.length;r++)o.unbind(e[r],t,n,i)}}),s.register("javve-get-by-class/index.js",function(e,t,n){n.exports=document.getElementsByClassName?function(e,t,n){return n?e.getElementsByClassName(t)[0]:e.getElementsByClassName(t)}:document.querySelector?function(e,t,n){return t="."+t,n?e.querySelector(t):e.querySelectorAll(t)}:function(e,t,n){var i=[];null==e&&(e=document);for(var r=e.getElementsByTagName("*"),o=r.length,a=new RegExp("(^|\\s)"+t+"(\\s|$)"),s=0,l=0;s<o;s++)if(a.test(r[s].className)){if(n)return r[s];i[l]=r[s],l++}return i}}),s.register("javve-get-attribute/index.js",function(e,t,n){n.exports=function(e,t){var n=e.getAttribute&&e.getAttribute(t)||null;if(!n)for(var i=e.attributes.length,r=0;r<i;r++)void 0!==t[r]&&t[r].nodeName===t&&(n=t[r].nodeValue);return n}}),s.register("javve-natural-sort/index.js",function(e,t,n){n.exports=function(e,t,n){var i,r,o=/(^-?[0-9]+(\.?[0-9]*)[df]?e?[0-9]?$|^0x[0-9a-f]+$|[0-9]+)/gi,a=/(^[ ]*|[ ]*$)/g,s=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,l=/^0x[0-9a-f]+$/i,c=/^0/,d=(n=n||{},function(e){return n.insensitive&&(""+e).toLowerCase()||""+e}),u=d(e).replace(a,"")||"",p=d(t).replace(a,"")||"",h=u.replace(o,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),f=p.replace(o,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),g=parseInt(u.match(l))||1!=h.length&&u.match(s)&&Date.parse(u),m=parseInt(p.match(l))||g&&p.match(s)&&Date.parse(p)||null,v=n.desc?-1:1;if(m){if(g<m)return-1*v;if(m<g)return 1*v}for(var y=0,b=Math.max(h.length,f.length);y<b;y++){if(i=!(h[y]||"").match(c)&&parseFloat(h[y])||h[y]||0,r=!(f[y]||"").match(c)&&parseFloat(f[y])||f[y]||0,isNaN(i)!==isNaN(r))return isNaN(i)?1:-1;if(typeof i!=typeof r&&(i+="",r+=""),i<r)return-1*v;if(r<i)return 1*v}return 0}}),s.register("javve-to-string/index.js",function(e,t,n){n.exports=function(e){return e=(e=null===(e=void 0===e?"":e)?"":e).toString()}}),s.register("component-type/index.js",function(e,t,n){var i=Object.prototype.toString;n.exports=function(e){switch(i.call(e)){case"[object Date]":return"date";case"[object RegExp]":return"regexp";case"[object Arguments]":return"arguments";case"[object Array]":return"array";case"[object Error]":return"error"}return null===e?"null":void 0===e?"undefined":e!=e?"nan":e&&1===e.nodeType?"element":typeof e.valueOf()}}),s.register("list.js/index.js",function(e,o,t){var a,d,u,p,h;a=window.document,d=o("get-by-class"),u=o("extend"),p=o("indexof"),h=function(e,t,n){var i,s=this,l=o("./src/item")(s),c=o("./src/add-async")(s),r=o("./src/parse")(s);i={start:function(){s.listClass="list",s.searchClass="search",s.sortClass="sort",s.page=200,s.i=1,s.items=[],s.visibleItems=[],s.matchingItems=[],s.searched=!1,s.filtered=!1,s.handlers={updated:[]},s.plugins={},s.helpers={getByClass:d,extend:u,indexOf:p},u(s,t),s.listContainer="string"==typeof e?a.getElementById(e):e,s.listContainer&&(s.list=d(s.listContainer,s.listClass,!0),s.templater=o("./src/templater")(s),s.search=o("./src/search")(s),s.filter=o("./src/filter")(s),s.sort=o("./src/sort")(s),this.items(),s.update(),this.plugins())},items:function(){r(s.list),void 0!==n&&s.add(n)},plugins:function(){for(var e=0;e<s.plugins.length;e++){var t=s.plugins[e];(s[t.name]=t).init(s,h)}}},this.add=function(e,t){if(!t){var n=[],i=!1;void 0===e[0]&&(e=[e]);for(var r=0,o=e.length;r<o;r++){var a=null;e[r]instanceof l?(a=e[r]).reload():(i=s.items.length>s.page,a=new l(e[r],void 0,i)),s.items.push(a),n.push(a)}return s.update(),n}c(e,t)},this.show=function(e,t){return this.i=e,this.page=t,s.update(),s},this.remove=function(e,t,n){for(var i=0,r=0,o=s.items.length;r<o;r++)s.items[r].values()[e]==t&&(s.templater.remove(s.items[r],n),s.items.splice(r,1),o--,r--,i++);return s.update(),i},this.get=function(e,t){for(var n=[],i=0,r=s.items.length;i<r;i++){var o=s.items[i];o.values()[e]==t&&n.push(o)}return n},this.size=function(){return s.items.length},this.clear=function(){return s.templater.clear(),s.items=[],s},this.on=function(e,t){return s.handlers[e].push(t),s},this.off=function(e,t){var n=s.handlers[e],i=p(n,t);return-1<i&&n.splice(i,1),s},this.trigger=function(e){for(var t=s.handlers[e].length;t--;)s.handlers[e][t](s);return s},this.reset={filter:function(){for(var e=s.items,t=e.length;t--;)e[t].filtered=!1;return s},search:function(){for(var e=s.items,t=e.length;t--;)e[t].found=!1;return s}},this.update=function(){var e=s.items,t=e.length;s.visibleItems=[],s.matchingItems=[],s.templater.clear();for(var n=0;n<t;n++)e[n].matching()&&s.matchingItems.length+1>=s.i&&s.visibleItems.length<s.page?(e[n].show(),s.visibleItems.push(e[n]),s.matchingItems.push(e[n])):(e[n].matching()&&s.matchingItems.push(e[n]),e[n].hide());return s.trigger("updated"),s},i.start()},t.exports=h}),s.register("list.js/src/search.js",function(e,t,n){var c=t("events"),d=t("get-by-class"),u=t("to-string");n.exports=function(n){var i,r,o,t,a={resetList:function(){n.i=1,n.templater.clear(),t=void 0},setOptions:function(e){2==e.length&&e[1]instanceof Array?r=e[1]:2==e.length&&"function"==typeof e[1]?t=e[1]:3==e.length&&(r=e[1],t=e[2])},setColumns:function(){r=void 0===r?a.toArray(n.items[0].values()):r},setSearchString:function(e){e=(e=u(e).toLowerCase()).replace(/[-[\]{}()*+?.,\\^$|#]/g,"\\$&"),o=e},toArray:function(e){var t=[];for(var n in e)t.push(n);return t}},s={list:function(){for(var e=0,t=n.items.length;e<t;e++)s.item(n.items[e])},item:function(e){e.found=!1;for(var t=0,n=r.length;t<n;t++)if(s.values(e.values(),r[t]))return void(e.found=!0)},values:function(e,t){return!!(e.hasOwnProperty(t)&&(i=u(e[t]).toLowerCase(),""!==o&&-1<i.search(o)))},reset:function(){n.reset.search(),n.searched=!1}},l=function(e){return n.trigger("searchStart"),a.resetList(),a.setSearchString(e),a.setOptions(arguments),a.setColumns(),""===o?s.reset():(n.searched=!0,t?t(o,r):s.list()),n.update(),n.trigger("searchComplete"),n.visibleItems};return n.handlers.searchStart=n.handlers.searchStart||[],n.handlers.searchComplete=n.handlers.searchComplete||[],c.bind(d(n.listContainer,n.searchClass),"keyup",function(e){var t=e.target||e.srcElement;""===t.value&&!n.searched||l(t.value)}),c.bind(d(n.listContainer,n.searchClass),"input",function(e){""===(e.target||e.srcElement).value&&l("")}),n.helpers.toString=u,l}}),s.register("list.js/src/sort.js",function(e,t,n){var i=t("natural-sort"),a=t("classes"),r=t("events"),s=t("get-by-class"),l=t("get-attribute");n.exports=function(t){t.sortFunction=t.sortFunction||function(e,t,n){return n.desc="desc"==n.order,i(e.values()[n.valueName],t.values()[n.valueName],n)};var o={els:void 0,clear:function(){for(var e=0,t=o.els.length;e<t;e++)a(o.els[e]).remove("asc"),a(o.els[e]).remove("desc")},getOrder:function(e){var t=l(e,"data-order");return"asc"==t||"desc"==t?t:a(e).has("desc")?"asc":a(e).has("asc")?"desc":"asc"},getInSensitive:function(e,t){var n=l(e,"data-insensitive");t.insensitive="true"===n},setOrder:function(e){for(var t=0,n=o.els.length;t<n;t++){var i=o.els[t];if(l(i,"data-sort")===e.valueName){var r=l(i,"data-order");"asc"==r||"desc"==r?r==e.order&&a(i).add(e.order):a(i).add(e.order)}}}},e=function(){t.trigger("sortStart"),options={};var e=arguments[0].currentTarget||arguments[0].srcElement||void 0;e?(options.valueName=l(e,"data-sort"),o.getInSensitive(e,options),options.order=o.getOrder(e)):(options=arguments[1]||options,options.valueName=arguments[0],options.order=options.order||"asc",options.insensitive=void 0===options.insensitive||options.insensitive),o.clear(),o.setOrder(options),options.sortFunction=options.sortFunction||t.sortFunction,t.items.sort(function(e,t){return options.sortFunction(e,t,options)}),t.update(),t.trigger("sortComplete")};return t.handlers.sortStart=t.handlers.sortStart||[],t.handlers.sortComplete=t.handlers.sortComplete||[],o.els=s(t.listContainer,t.sortClass),r.bind(o.els,"click",e),t.on("searchStart",o.clear),t.on("filterStart",o.clear),t.helpers.classes=a,t.helpers.naturalSort=i,t.helpers.events=r,t.helpers.getAttribute=l,e}}),s.register("list.js/src/item.js",function(e,t,n){n.exports=function(o){return function(e,t,n){var r=this;this._values={},this.found=!1,this.filtered=!1;this.values=function(e,t){if(void 0===e)return r._values;for(var n in e)r._values[n]=e[n];!0!==t&&o.templater.set(r,r.values())},this.show=function(){o.templater.show(r)},this.hide=function(){o.templater.hide(r)},this.matching=function(){return o.filtered&&o.searched&&r.found&&r.filtered||o.filtered&&!o.searched&&r.filtered||!o.filtered&&o.searched&&r.found||!o.filtered&&!o.searched},this.visible=function(){return r.elm.parentNode==o.list},function(e,t,n){if(void 0===t)n?r.values(e,n):r.values(e);else{r.elm=t;var i=o.templater.get(r,e);r.values(i)}}(e,t,n)}}}),s.register("list.js/src/templater.js",function(e,t,n){var s=t("get-by-class");n.exports=function(e){return new function(o){var n=function(e){if(void 0===e){for(var t=o.list.childNodes,n=0,i=t.length;n<i;n++)if(void 0===t[n].data)return t[n];return null}if(-1!==e.indexOf("<")){var r=document.createElement("div");return r.innerHTML=e,r.firstChild}return document.getElementById(o.item)}(o.item),a=this;this.get=function(e,t){a.create(e);for(var n={},i=0,r=t.length;i<r;i++){var o=s(e.elm,t[i],!0);n[t[i]]=o?o.innerHTML:""}return n},this.set=function(e,t){if(!a.create(e))for(var n in t)if(t.hasOwnProperty(n)){var i=s(e.elm,n,!0);i&&("IMG"===i.tagName&&""!==t[n]?i.src=t[n]:i.innerHTML=t[n])}},this.create=function(e){if(void 0!==e.elm)return!1;var t=n.cloneNode(!0);return t.removeAttribute("id"),e.elm=t,a.set(e,e.values()),!0},this.remove=function(e){o.list.removeChild(e.elm)},this.show=function(e){a.create(e),o.list.appendChild(e.elm)},this.hide=function(e){void 0!==e.elm&&e.elm.parentNode===o.list&&o.list.removeChild(e.elm)},this.clear=function(){if(o.list.hasChildNodes())for(;1<=o.list.childNodes.length;)o.list.removeChild(o.list.firstChild)}}(e)}}),s.register("list.js/src/filter.js",function(e,t,n){n.exports=function(o){return o.handlers.filterStart=o.handlers.filterStart||[],o.handlers.filterComplete=o.handlers.filterComplete||[],function(e){if(o.trigger("filterStart"),o.i=1,o.reset.filter(),void 0===e)o.filtered=!1;else{o.filtered=!0;for(var t=o.items,n=0,i=t.length;n<i;n++){var r=t[n];e(r)?r.filtered=!0:r.filtered=!1}}return o.update(),o.trigger("filterComplete"),o.visibleItems}}}),s.register("list.js/src/add-async.js",function(e,t,n){n.exports=function(r){return function(e,t,n){var i=e.splice(0,100);n=(n=n||[]).concat(r.add(i)),0<e.length?setTimeout(function(){addAsync(e,t,n)},10):(r.update(),t(n))}}}),s.register("list.js/src/parse.js",function(e,t,n){n.exports=function(o){var r=t("./item")(o),a=function(e,t){for(var n=0,i=e.length;n<i;n++)o.items.push(new r(t,e[n]))};return function(){var e,t,n,i=function(e){for(var t=e.childNodes,n=[],i=0,r=t.length;i<r;i++)void 0===t[i].data&&n.push(t[i]);return n}(o.list),r=o.valueNames;o.indexAsync?(t=r,n=(e=i).splice(0,100),a(n,t),0<e.length?setTimeout(function(){init.items.indexAsync(e,t)},10):o.update()):a(i,r)}}}),s.alias("component-classes/index.js","list.js/deps/classes/index.js"),s.alias("component-classes/index.js","classes/index.js"),s.alias("component-indexof/index.js","component-classes/deps/indexof/index.js"),s.alias("segmentio-extend/index.js","list.js/deps/extend/index.js"),s.alias("segmentio-extend/index.js","extend/index.js"),s.alias("component-indexof/index.js","list.js/deps/indexof/index.js"),s.alias("component-indexof/index.js","indexof/index.js"),s.alias("javve-events/index.js","list.js/deps/events/index.js"),s.alias("javve-events/index.js","events/index.js"),s.alias("component-event/index.js","javve-events/deps/event/index.js"),s.alias("timoxley-to-array/index.js","javve-events/deps/to-array/index.js"),s.alias("javve-get-by-class/index.js","list.js/deps/get-by-class/index.js"),s.alias("javve-get-by-class/index.js","get-by-class/index.js"),s.alias("javve-get-attribute/index.js","list.js/deps/get-attribute/index.js"),s.alias("javve-get-attribute/index.js","get-attribute/index.js"),s.alias("javve-natural-sort/index.js","list.js/deps/natural-sort/index.js"),s.alias("javve-natural-sort/index.js","natural-sort/index.js"),s.alias("javve-to-string/index.js","list.js/deps/to-string/index.js"),s.alias("javve-to-string/index.js","list.js/deps/to-string/index.js"),s.alias("javve-to-string/index.js","to-string/index.js"),s.alias("javve-to-string/index.js","javve-to-string/index.js"),s.alias("component-type/index.js","list.js/deps/type/index.js"),s.alias("component-type/index.js","type/index.js"),"object"==typeof t?n.exports=s("list.js"):"function"==typeof define&&define.amd?define(function(){return s("list.js")}):this.List=s("list.js")}()}),define("list.js-master/dist/list.fuzzysearch.min.js",[],function(e,t,n){"use strict";!function(){function s(e,t,n){var i=s.resolve(e);if(null==i){n=n||e,t=t||"root";var r=new Error('Failed to require "'+n+'" from "'+t+'"');throw r.path=n,r.parent=t,r.require=!0,r}var o=s.modules[i];if(!o._resolving&&!o.exports){var a={exports:{}};a.client=a.component=!0,o._resolving=!0,o.call(this,a.exports,s.relative(i),a),delete o._resolving,o.exports=a.exports}return o.exports}s.modules={},s.aliases={},s.resolve=function(e){"/"===e.charAt(0)&&(e=e.slice(1));for(var t=[e,e+".js",e+".json",e+"/index.js",e+"/index.json"],n=0;n<t.length;n++){e=t[n];if(s.modules.hasOwnProperty(e))return e;if(s.aliases.hasOwnProperty(e))return s.aliases[e]}},s.normalize=function(e,t){var n=[];if("."!=t.charAt(0))return t;e=e.split("/"),t=t.split("/");for(var i=0;i<t.length;++i)".."==t[i]?e.pop():"."!=t[i]&&""!=t[i]&&n.push(t[i]);return e.concat(n).join("/")},s.register=function(e,t){s.modules[e]=t},s.alias=function(e,t){if(!s.modules.hasOwnProperty(e))throw new Error('Failed to alias "'+e+'", it does not exist');s.aliases[t]=e},s.relative=function(r){function t(e){return s(t.resolve(e),r,e)}var o=s.normalize(r,"..");return t.resolve=function(e){var t=e.charAt(0);if("/"==t)return e.slice(1);if("."==t)return s.normalize(o,e);var n=r.split("/"),i=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return n;return-1}(n,"deps")+1;return i||(i=0),n.slice(0,i+1).join("/")+"/deps/"+e},t.exists=function(e){return s.modules.hasOwnProperty(t.resolve(e))},t},s.register("component-indexof/index.js",function(e,t,n){n.exports=function(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1}}),s.register("component-classes/index.js",function(e,t,n){function i(e){if(!e)throw new Error("A DOM element reference is required");this.el=e,this.list=e.classList}var r=t("indexof"),o=/\s+/,a=Object.prototype.toString;n.exports=function(e){return new i(e)},i.prototype.add=function(e){if(this.list)return this.list.add(e),this;var t=this.array();return~r(t,e)||t.push(e),this.el.className=t.join(" "),this},i.prototype.remove=function(e){if("[object RegExp]"==a.call(e))return this.removeMatching(e);if(this.list)return this.list.remove(e),this;var t=this.array(),n=r(t,e);return~n&&t.splice(n,1),this.el.className=t.join(" "),this},i.prototype.removeMatching=function(e){for(var t=this.array(),n=0;n<t.length;n++)e.test(t[n])&&this.remove(t[n]);return this},i.prototype.toggle=function(e){return this.list?this.list.toggle(e):this.has(e)?this.remove(e):this.add(e),this},i.prototype.array=function(){var e=this.el.className.replace(/^\s+|\s+$/g,"").split(o);return""===e[0]&&e.shift(),e},i.prototype.has=i.prototype.contains=function(e){return this.list?this.list.contains(e):!!~r(this.array(),e)}}),s.register("segmentio-extend/index.js",function(e,t,n){n.exports=function(e){for(var t,n=Array.prototype.slice.call(arguments,1),i=0;t=n[i];i++)if(t)for(var r in t)e[r]=t[r];return e}}),s.register("component-event/index.js",function(e){var r=void 0!==window.addEventListener?"addEventListener":"attachEvent",o=void 0!==window.removeEventListener?"removeEventListener":"detachEvent",a="addEventListener"!==r?"on":"";e.bind=function(e,t,n,i){return e[r](a+t,n,i||!1),n},e.unbind=function(e,t,n,i){return e[o](a+t,n,i||!1),n}}),s.register("component-type/index.js",function(e,t,n){var i=Object.prototype.toString;n.exports=function(e){switch(i.call(e)){case"[object Function]":return"function";case"[object Date]":return"date";case"[object RegExp]":return"regexp";case"[object Arguments]":return"arguments";case"[object Array]":return"array";case"[object String]":return"string"}return null===e?"null":void 0===e?"undefined":e&&1===e.nodeType?"element":e===Object(e)?"object":typeof e}}),s.register("timoxley-is-collection/index.js",function(e,t,n){var i=t("type");n.exports=function(e){var t,n=i(e);if("array"===n)return 1;switch(n){case"arguments":return 2;case"object":if("object"==typeof(t=e)&&/^\[object (NodeList)\]$/.test(Object.prototype.toString.call(t))&&t.hasOwnProperty("length")&&(0==t.length||"object"==typeof t[0]&&0<t[0].nodeType))return 2;try{if("length"in e&&!e.tagName&&(!e.scrollTo||!e.document)&&!e.apply)return 2}catch(e){}default:return 0}}}),s.register("javve-events/index.js",function(e,t){var o=t("event"),a=t("is-collection");e.bind=function(e,t,n,i){if(a(e)){if(e&&void 0!==e[0])for(var r=0;r<e.length;r++)o.bind(e[r],t,n,i)}else o.bind(e,t,n,i)},e.unbind=function(e,t,n,i){if(a(e)){if(e&&void 0!==e[0])for(var r=0;r<e.length;r++)o.unbind(e[r],t,n,i)}else o.unbind(e,t,n,i)}}),s.register("javve-get-by-class/index.js",function(e,t,n){n.exports=document.getElementsByClassName?function(e,t,n){return n?e.getElementsByClassName(t)[0]:e.getElementsByClassName(t)}:document.querySelector?function(e,t,n){return n?e.querySelector(t):e.querySelectorAll(t)}:function(e,t,n){var i=[];null==e&&(e=document);for(var r=e.getElementsByTagName("*"),o=r.length,a=new RegExp("(^|\\s)"+t+"(\\s|$)"),s=0,l=0;s<o;s++)if(a.test(r[s].className)){if(n)return r[s];i[l]=r[s],l++}return i}}),s.register("javve-to-string/index.js",function(e,t,n){n.exports=function(e){return(e=null===(e=void 0===e?"":e)?"":e).toString()}}),s.register("list.fuzzysearch.js/index.js",function(e,t,n){var i=(t("classes"),t("events")),s=t("extend"),c=t("to-string"),d=t("get-by-class");n.exports=function(o){s(o=o||{},{location:0,distance:100,threshold:.4,multiSearch:!0,searchClass:"fuzzy-search"});var a,r=t("./src/fuzzy"),l={search:function(e,t){for(var n=o.multiSearch?e.replace(/ +$/,"").split(/ +/):[e],i=0,r=a.items.length;i<r;i++)l.item(a.items[i],t,n)},item:function(e,t,n){for(var i=!0,r=0;r<n.length;r++){for(var o=!1,a=0,s=t.length;a<s;a++)l.values(e.values(),t[a],n[r])&&(o=!0);o||(i=!1)}e.found=i},values:function(e,t,n){if(e.hasOwnProperty(t)){var i=c(e[t]).toLowerCase();if(r(i,n,o))return!0}return!1}};return{init:function(e){a=e,i.bind(d(a.listContainer,o.searchClass),"keyup",function(e){var t=e.target||e.srcElement;a.search(t.value,l.search)})},search:function(e,t){a.search(e,t,l.search)},name:o.name||"fuzzySearch"}}}),s.register("list.fuzzysearch.js/src/fuzzy.js",function(e,t,n){n.exports=function(e,r,t){function n(e,t){var n=e/r.length,i=Math.abs(s-t);return o?n+i/o:i?1:n}var i=t.location||0,o=t.distance||100,a=t.threshold||.4;if(r===e)return!0;if(32<r.length)return!1;var s=i,l=function(){var e,t={};for(e=0;e<r.length;e++)t[r.charAt(e)]=0;for(e=0;e<r.length;e++)t[r.charAt(e)]|=1<<r.length-e-1;return t}(),c=a,d=e.indexOf(r,s);-1!=d&&(c=Math.min(n(0,d),c),-1!=(d=e.lastIndexOf(r,s+r.length))&&(c=Math.min(n(0,d),c)));var u=1<<r.length-1;d=-1;for(var p,h,f,g=r.length+e.length,m=0;m<r.length;m++){for(p=0,h=g;p<h;)n(m,s+h)<=c?p=h:g=h,h=Math.floor((g-p)/2+p);g=h;var v=Math.max(1,s-h+1),y=Math.min(s+h,e.length)+r.length,b=Array(y+2);b[y+1]=(1<<m)-1;for(var w=y;v<=w;w--){var x=l[e.charAt(w-1)];if(b[w]=0===m?(b[w+1]<<1|1)&x:(b[w+1]<<1|1)&x|(f[w+1]|f[w])<<1|1|f[w+1],b[w]&u){var C=n(m,w-1);if(C<=c){if(c=C,!(s<(d=w-1)))break;v=Math.max(1,2*s-d)}}}if(n(m+1,s)>c)break;f=b}return!(d<0)}}),s.alias("component-classes/index.js","list.fuzzysearch.js/deps/classes/index.js"),s.alias("component-classes/index.js","classes/index.js"),s.alias("component-indexof/index.js","component-classes/deps/indexof/index.js"),s.alias("segmentio-extend/index.js","list.fuzzysearch.js/deps/extend/index.js"),s.alias("segmentio-extend/index.js","extend/index.js"),s.alias("javve-events/index.js","list.fuzzysearch.js/deps/events/index.js"),s.alias("javve-events/index.js","events/index.js"),s.alias("component-event/index.js","javve-events/deps/event/index.js"),s.alias("timoxley-is-collection/index.js","javve-events/deps/is-collection/index.js"),s.alias("component-type/index.js","timoxley-is-collection/deps/type/index.js"),s.alias("javve-get-by-class/index.js","list.fuzzysearch.js/deps/get-by-class/index.js"),s.alias("javve-get-by-class/index.js","get-by-class/index.js"),s.alias("javve-to-string/index.js","list.fuzzysearch.js/deps/to-string/index.js"),s.alias("javve-to-string/index.js","list.fuzzysearch.js/deps/to-string/index.js"),s.alias("javve-to-string/index.js","to-string/index.js"),s.alias("javve-to-string/index.js","javve-to-string/index.js"),s.alias("list.fuzzysearch.js/index.js","list.fuzzysearch.js/index.js"),"object"==typeof t?n.exports=s("list.fuzzysearch.js"):"function"==typeof define&&define.amd?define(function(){return s("list.fuzzysearch.js")}):this.ListFuzzySearch=s("list.fuzzysearch.js")}()});